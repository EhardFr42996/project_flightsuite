<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: rayshade.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">rayshade.c</div>  </div>
</div>
<div class="contents">
<a href="../../d6/d95/rayshade_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 1990-1998 NeoGeo BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributors: 2004/2005 Blender Foundation, full recode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/de1/BLI__cpu_8h.html">BLI_cpu.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d49/BLI__jitter_8h.html">BLI_jitter.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dff/render__result_8h.html">render_result.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db3/pixelblending_8h.html">pixelblending.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d05/pixelshading_8h.html">pixelshading.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d25/volumetric_8h.html">volumetric.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d1b/rayintersection_8h.html">rayintersection.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d42/rayobject_8h.html">rayobject.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd4/raycounter_8h.html">raycounter.h</a>&quot;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a2294e9119a21dc5e1eb223a86f6c788d">00072</a> <span class="preprocessor">#define RAY_TRA     1</span>
<a name="l00073"></a><a class="code" href="../../d6/d95/rayshade_8c.html#acb7f0dee6722e234e497a9663239fc2a">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define RAY_INSIDE  2</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a6f9909a5e0e1df772598d89711ccca02">00075</a> <span class="preprocessor">#define DEPTH_SHADOW_TRA  10</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00078"></a>00078 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00079"></a>00079 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00080"></a>00080 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00081"></a>00081 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00082"></a><a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">00082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re = (<a class="code" href="../../d6/d7a/structRender.html">Render</a>*)data;
<a name="l00085"></a>00085     <span class="keywordflow">return</span> re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>);
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="../../d6/d95/rayshade_8c.html#aa642a57260f13109dab59ce174acb6e2">00088</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#aa642a57260f13109dab59ce174acb6e2">RE_rayobject_config_control</a>(<a class="code" href="../../db/df0/structRayObject.html">RayObject</a> *<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (<a class="code" href="../../db/d64/rayobject__internal_8h.html#a185b20d1fd11c64198536a26f14a430f">RE_rayobject_isRayAPI</a>(r))
<a name="l00091"></a>00091     {
<a name="l00092"></a>00092         r = <a class="code" href="../../db/d64/rayobject__internal_8h.html#a10024283812b5959353e98ff104417e4">RE_rayobject_align</a>( r );
<a name="l00093"></a>00093         r-&gt;<a class="code" href="../../db/df0/structRayObject.html#abe96bdb7e2254679024e3d3a05ec5ec9">control</a>.<a class="code" href="../../d0/ded/structRayObjectControl.html#a8e6b78131c66ca4b16590876d8c0f6e6">data</a> = re;
<a name="l00094"></a>00094         r-&gt;<a class="code" href="../../db/df0/structRayObject.html#abe96bdb7e2254679024e3d3a05ec5ec9">control</a>.<a class="code" href="../../d0/ded/structRayObjectControl.html#a944b71caf5800ed423947c07c8ff9e9d">test_break</a> = <a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>;
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a571546d10251d21362d7d4cb95ab8601">00098</a> <span class="keyword">static</span> <a class="code" href="../../db/df0/structRayObject.html">RayObject</a>*  <a class="code" href="../../d6/d95/rayshade_8c.html#a571546d10251d21362d7d4cb95ab8601">RE_rayobject_create</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100     <a class="code" href="../../db/df0/structRayObject.html">RayObject</a> * res = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe25a188ac89851de495723373444abb">R_RAYSTRUCTURE_AUTO</a>)
<a name="l00103"></a>00103     {
<a name="l00104"></a>00104         <span class="comment">//TODO</span>
<a name="l00105"></a>00105         <span class="comment">//if (detect_simd())</span>
<a name="l00106"></a>00106 <span class="preprocessor">#ifdef __SSE__</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>        type = <a class="code" href="../../da/de1/BLI__cpu_8h.html#a5df7024de55de30b4be680c0f43f8b46">BLI_cpu_support_sse2</a>()? <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aefed2607f6c79ff004bd5088d3650044">R_RAYSTRUCTURE_SIMD_SVBVH</a>: <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac7b6a31f9fb3e4848638d8d8b9390f8c">R_RAYSTRUCTURE_VBVH</a>;
<a name="l00108"></a>00108 <span class="preprocessor">#else</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>        type = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac7b6a31f9fb3e4848638d8d8b9390f8c">R_RAYSTRUCTURE_VBVH</a>;
<a name="l00110"></a>00110 <span class="preprocessor">#endif</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>    }
<a name="l00112"></a>00112     
<a name="l00113"></a>00113 <span class="preprocessor">#ifndef __SSE__</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aefed2607f6c79ff004bd5088d3650044">R_RAYSTRUCTURE_SIMD_SVBVH</a> || type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad09ee54345bf0e8076db882529d33cf">R_RAYSTRUCTURE_SIMD_QBVH</a>)
<a name="l00115"></a>00115     {
<a name="l00116"></a>00116         puts(<span class="stringliteral">&quot;Warning: Using VBVH (SSE was disabled at compile time)&quot;</span>);
<a name="l00117"></a>00117         type = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac7b6a31f9fb3e4848638d8d8b9390f8c">R_RAYSTRUCTURE_VBVH</a>;
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 <span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>    
<a name="l00121"></a>00121         
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7849171dbfe2b2409ec821417f585299">R_RAYSTRUCTURE_OCTREE</a>) <span class="comment">//TODO dynamic ocres</span>
<a name="l00123"></a>00123         res = <a class="code" href="../../d8/d42/rayobject_8h.html#a3ea727c9bb18684f94d1f0b128d36bf2">RE_rayobject_octree_create</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a245118fb5febf8875cc7eeef054210f6">ocres</a>, size);
<a name="l00124"></a>00124     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a85030e8a67383829219a53c67ec28411">R_RAYSTRUCTURE_BLIBVH</a>)
<a name="l00125"></a>00125         res = <a class="code" href="../../d8/d42/rayobject_8h.html#a9b3685ddbba12cee5a74dd939da07166">RE_rayobject_blibvh_create</a>(size);
<a name="l00126"></a>00126     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac7b6a31f9fb3e4848638d8d8b9390f8c">R_RAYSTRUCTURE_VBVH</a>)
<a name="l00127"></a>00127         res = <a class="code" href="../../d8/d42/rayobject_8h.html#ab956c04e82c34ec3fd39d41c6074b8c8">RE_rayobject_vbvh_create</a>(size);
<a name="l00128"></a>00128     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aefed2607f6c79ff004bd5088d3650044">R_RAYSTRUCTURE_SIMD_SVBVH</a>)
<a name="l00129"></a>00129         res = <a class="code" href="../../d8/d42/rayobject_8h.html#a0e31a871c88c3e6bd5caf3025d374625">RE_rayobject_svbvh_create</a>(size);
<a name="l00130"></a>00130     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad09ee54345bf0e8076db882529d33cf">R_RAYSTRUCTURE_SIMD_QBVH</a>)
<a name="l00131"></a>00131         res = <a class="code" href="../../d8/d42/rayobject_8h.html#a0d5ecfc2e224fd9cac8401dbe82d7649">RE_rayobject_qbvh_create</a>(size);
<a name="l00132"></a>00132     <span class="keywordflow">else</span>
<a name="l00133"></a>00133         res = <a class="code" href="../../d8/d42/rayobject_8h.html#ab956c04e82c34ec3fd39d41c6074b8c8">RE_rayobject_vbvh_create</a>(size);   <span class="comment">//Fallback</span>
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (res)
<a name="l00137"></a>00137         <a class="code" href="../../d6/d95/rayshade_8c.html#aa642a57260f13109dab59ce174acb6e2">RE_rayobject_config_control</a>(res, re);
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     <span class="keywordflow">return</span> res;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">#ifdef RE_RAYCOUNTER</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>RayCounter re_rc_counter[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l00144"></a>00144 <span class="preprocessor">#endif</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a656d598b93806e92c9723b93472b5bac">00147</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a656d598b93806e92c9723b93472b5bac">freeraytree</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00150"></a>00150     
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>)
<a name="l00152"></a>00152     {
<a name="l00153"></a>00153         <a class="code" href="../../d8/d42/rayobject_8h.html#af4b74982854a6ab7eb993e18064d1838">RE_rayobject_free</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>);
<a name="l00154"></a>00154         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a0b583879cb31e74b03c2ac13a7026ac7">rayfaces</a>)
<a name="l00157"></a>00157     {
<a name="l00158"></a>00158         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a0b583879cb31e74b03c2ac13a7026ac7">rayfaces</a>);
<a name="l00159"></a>00159         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a0b583879cb31e74b03c2ac13a7026ac7">rayfaces</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3661c5cb9b2164d591b1cad17d3992f4">rayprimitives</a>)
<a name="l00162"></a>00162     {
<a name="l00163"></a>00163         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3661c5cb9b2164d591b1cad17d3992f4">rayprimitives</a>);
<a name="l00164"></a>00164         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3661c5cb9b2164d591b1cad17d3992f4">rayprimitives</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>)
<a name="l00168"></a>00168     {
<a name="l00169"></a>00169         <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00170"></a>00170         <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>)
<a name="l00171"></a>00171         {
<a name="l00172"></a>00172             <a class="code" href="../../d8/d42/rayobject_8h.html#af4b74982854a6ab7eb993e18064d1838">RE_rayobject_free</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>);
<a name="l00173"></a>00173             obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ac3d21354366cb1aab4f2be1146948590">rayfaces</a>)
<a name="l00176"></a>00176         {
<a name="l00177"></a>00177             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ac3d21354366cb1aab4f2be1146948590">rayfaces</a>);
<a name="l00178"></a>00178             obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ac3d21354366cb1aab4f2be1146948590">rayfaces</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a>)
<a name="l00181"></a>00181         {
<a name="l00182"></a>00182             <a class="code" href="../../d8/d42/rayobject_8h.html#af4b74982854a6ab7eb993e18064d1838">RE_rayobject_free</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a>);
<a name="l00183"></a>00183             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     
<a name="l00187"></a>00187 <span class="preprocessor">#ifdef RE_RAYCOUNTER</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span>    {
<a name="l00189"></a>00189         RayCounter <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>;
<a name="l00190"></a>00190         memset( &amp;sum, 0, <span class="keyword">sizeof</span>(sum) );
<a name="l00191"></a>00191         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00192"></a>00192         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>; i++)
<a name="l00193"></a>00193             <a class="code" href="../../d9/dd4/raycounter_8h.html#a78a1894a09cfe0cd742dbfd2347a2ff7">RE_RC_MERGE</a>(&amp;sum, re_rc_counter+i);
<a name="l00194"></a>00194         <a class="code" href="../../d9/dd4/raycounter_8h.html#af6d3989c68965c88965171e89a367098">RE_RC_INFO</a>(&amp;sum);
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>}
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">00199</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <span class="comment">/* note: volumetric must be tracable, wire must not */</span>
<a name="l00202"></a>00202     <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#af41ea27f348b5f1a0cd77706f6bfb66e">R_BAKE_TRACE</a>) || (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#ab3bc3d9ccd012df4f5e37d9086c3bc1e">R_TRACEBLE</a>) || (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>))
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> != <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)
<a name="l00204"></a>00204             <span class="keywordflow">return</span> 1;
<a name="l00205"></a>00205     <span class="keywordflow">return</span> 0;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a5c1b67d82c4200f46390ff7f7b0fa5e9">00208</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a5c1b67d82c4200f46390ff7f7b0fa5e9">is_raytraceable</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210     <span class="keywordtype">int</span> v;
<a name="l00211"></a>00211     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#abf7d7087b9c8b6543fbcf7c10bf98b51">excludeob</a> &amp;&amp; obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> == re-&gt;<a class="code" href="../../d6/d7a/structRender.html#abf7d7087b9c8b6543fbcf7c10bf98b51">excludeob</a>)
<a name="l00214"></a>00214         <span class="keywordflow">return</span> 0;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++) {
<a name="l00217"></a>00217         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr))
<a name="l00220"></a>00220             <span class="keywordflow">return</span> 1;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">return</span> 0;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a309bd172850891905cc117327e6d7d61">00227</a> <a class="code" href="../../db/df0/structRayObject.html">RayObject</a>* <a class="code" href="../../d0/d0e/rendercore_8h.html#af599b4381fe2114c1f35923aa4b251bf">makeraytree_object</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229     <span class="comment">//TODO</span>
<a name="l00230"></a>00230     <span class="comment">// out-of-memory safeproof</span>
<a name="l00231"></a>00231     <span class="comment">// break render</span>
<a name="l00232"></a>00232     <span class="comment">// update render stats</span>
<a name="l00233"></a>00233     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00236"></a>00236     {
<a name="l00237"></a>00237         <a class="code" href="../../db/df0/structRayObject.html">RayObject</a> *<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>;
<a name="l00238"></a>00238         <a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a> *face = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00239"></a>00239         <a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a> *vlakprimitive = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00240"></a>00240         <span class="keywordtype">int</span> v;
<a name="l00241"></a>00241         
<a name="l00242"></a>00242         <span class="comment">//Count faces</span>
<a name="l00243"></a>00243         <span class="keywordtype">int</span> faces = 0;
<a name="l00244"></a>00244         <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++)
<a name="l00245"></a>00245         {
<a name="l00246"></a>00246             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00247"></a>00247             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr))
<a name="l00248"></a>00248                 faces++;
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250         
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (faces == 0)
<a name="l00252"></a>00252             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         <span class="comment">//Create Ray cast accelaration structure        </span>
<a name="l00255"></a>00255         raytree = <a class="code" href="../../d6/d95/rayshade_8c.html#a571546d10251d21362d7d4cb95ab8601">RE_rayobject_create</a>( re,  re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6ecc44c20a25824246b04bcae02881ac">raytrace_structure</a>, faces );
<a name="l00256"></a>00256         <span class="keywordflow">if</span> (  (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1103712a19c3d92cc234345d84be77c1">R_RAYTRACE_USE_LOCAL_COORDS</a>) )
<a name="l00257"></a>00257             vlakprimitive = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ab658e51438b2598cbe51c8270a6675f4">rayprimitives</a> = (<a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(faces*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a>), <span class="stringliteral">&quot;ObjectRen primitives&quot;</span>);
<a name="l00258"></a>00258         <span class="keywordflow">else</span>
<a name="l00259"></a>00259             face = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ac3d21354366cb1aab4f2be1146948590">rayfaces</a> = (<a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(faces*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a>), <span class="stringliteral">&quot;ObjectRen faces&quot;</span>);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#accf6364474a06d406c43d03d717bcf80">rayobi</a> = obi;
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++)
<a name="l00264"></a>00264         {
<a name="l00265"></a>00265             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00266"></a>00266             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr))
<a name="l00267"></a>00267             {
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1103712a19c3d92cc234345d84be77c1">R_RAYTRACE_USE_LOCAL_COORDS</a>)) {
<a name="l00269"></a>00269                     <a class="code" href="../../d8/d42/rayobject_8h.html#a2ffbe81f0f537e9d372d0dd39ac10340">RE_rayobject_add</a>( raytree, <a class="code" href="../../d8/d42/rayobject_8h.html#a59d9c6b81824f869794dd5f9f92b265d">RE_vlakprimitive_from_vlak</a>( vlakprimitive, obi, vlr ) );
<a name="l00270"></a>00270                     vlakprimitive++;
<a name="l00271"></a>00271                 }
<a name="l00272"></a>00272                 <span class="keywordflow">else</span> {
<a name="l00273"></a>00273                     <a class="code" href="../../d8/d42/rayobject_8h.html#a747e3ea348c87a83b4579fcd7debfa17">RE_rayface_from_vlak</a>(face, obi, vlr);
<a name="l00274"></a>00274                     <a class="code" href="../../d8/d42/rayobject_8h.html#a2ffbe81f0f537e9d372d0dd39ac10340">RE_rayobject_add</a>( raytree, <a class="code" href="../../db/d64/rayobject__internal_8h.html#a8f512f38b7313b546e4204946dfd59a5">RE_rayobject_unalignRayFace</a>(face) );
<a name="l00275"></a>00275                     face++;
<a name="l00276"></a>00276                 }
<a name="l00277"></a>00277             }
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279         <a class="code" href="../../d8/d42/rayobject_8h.html#a2aa8301ec8095e4b03f67b9358e39ddb">RE_rayobject_done</a>( raytree );
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="comment">/* in case of cancel during build, raytree is not usable */</span>
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re))
<a name="l00283"></a>00283             <a class="code" href="../../d8/d42/rayobject_8h.html#af4b74982854a6ab7eb993e18064d1838">RE_rayobject_free</a>(raytree);
<a name="l00284"></a>00284         <span class="keywordflow">else</span>
<a name="l00285"></a>00285             obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>= <a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>;
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>) {
<a name="l00289"></a>00289         <span class="keywordflow">if</span> ((obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) &amp;&amp; obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00290"></a>00290         {
<a name="l00291"></a>00291             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aae4cdae9afa46b4cd150c490d4bd0081">transform_primitives</a> = 0;
<a name="l00292"></a>00292             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a> = <a class="code" href="../../d8/d42/rayobject_8h.html#a01629951a180d7de7f19d96163508b04">RE_rayobject_instance_create</a>( obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, obi, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#accf6364474a06d406c43d03d717bcf80">rayobi</a> );
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295     
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a>) <span class="keywordflow">return</span> obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#abe76b79b1b980aa4bb83b4745fcf3e4c">raytree</a>;
<a name="l00297"></a>00297     <span class="keywordflow">return</span> obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#adec507b27ac9d1922ffca5c1fd4bbdab">raytree</a>;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a1cfa507c32a28a31b44652ca0c05373a">00300</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a1cfa507c32a28a31b44652ca0c05373a">has_special_rayobject</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302     <span class="keywordflow">if</span> ( (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) &amp;&amp; (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a591eeb8a2b02c3f9a3bdb9cf879060a0">R_RAYTRACE_USE_INSTANCES</a>) )
<a name="l00303"></a>00303     {
<a name="l00304"></a>00304         <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00305"></a>00305         <span class="keywordtype">int</span> v, faces = 0;
<a name="l00306"></a>00306         
<a name="l00307"></a>00307         <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++)
<a name="l00308"></a>00308         {
<a name="l00309"></a>00309             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00310"></a>00310             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr))
<a name="l00311"></a>00311             {
<a name="l00312"></a>00312                 faces++;
<a name="l00313"></a>00313                 <span class="keywordflow">if</span> (faces &gt; 4)
<a name="l00314"></a>00314                     <span class="keywordflow">return</span> 1;
<a name="l00315"></a>00315             }
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     <span class="keywordflow">return</span> 0;
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 <span class="comment">/*</span>
<a name="l00321"></a>00321 <span class="comment"> * create a single raytrace structure with all faces</span>
<a name="l00322"></a>00322 <span class="comment"> */</span>
<a name="l00323"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a3fb935a478882dab7f5bfac761c221cf">00323</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a3fb935a478882dab7f5bfac761c221cf">makeraytree_single</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00326"></a>00326     <a class="code" href="../../db/df0/structRayObject.html">RayObject</a> *<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>;
<a name="l00327"></a>00327     <a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a> *face = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00328"></a>00328     <a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a> *vlakprimitive = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00329"></a>00329     <span class="keywordtype">int</span> faces = 0, obs = 0, special = 0;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>)
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a5c1b67d82c4200f46390ff7f7b0fa5e9">is_raytraceable</a>(re, obi))
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00335"></a>00335         obs++;
<a name="l00336"></a>00336         
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a1cfa507c32a28a31b44652ca0c05373a">has_special_rayobject</a>(re, obi)) {
<a name="l00338"></a>00338             special++;
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340         <span class="keywordflow">else</span> {
<a name="l00341"></a>00341             <span class="keywordtype">int</span> v;
<a name="l00342"></a>00342             <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++)
<a name="l00343"></a>00343             {
<a name="l00344"></a>00344                 <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr))
<a name="l00346"></a>00346                     faces++;
<a name="l00347"></a>00347             }
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (faces + special == 0)
<a name="l00352"></a>00352     {
<a name="l00353"></a>00353         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a> = <a class="code" href="../../d8/d42/rayobject_8h.html#ad11484502f2c295153ea073299bf40e0">RE_rayobject_empty_create</a>();
<a name="l00354"></a>00354         <span class="keywordflow">return</span>;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     
<a name="l00357"></a>00357     <span class="comment">//Create raytree</span>
<a name="l00358"></a>00358     raytree = re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a> = <a class="code" href="../../d6/d95/rayshade_8c.html#a571546d10251d21362d7d4cb95ab8601">RE_rayobject_create</a>( re, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6ecc44c20a25824246b04bcae02881ac">raytrace_structure</a>, faces+special );
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">if</span> ( (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1103712a19c3d92cc234345d84be77c1">R_RAYTRACE_USE_LOCAL_COORDS</a>) )
<a name="l00361"></a>00361     {
<a name="l00362"></a>00362         vlakprimitive = re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3661c5cb9b2164d591b1cad17d3992f4">rayprimitives</a> = (<a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(faces*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4c/structVlakPrimitive.html">VlakPrimitive</a>), <span class="stringliteral">&quot;Raytrace vlak-primitives&quot;</span>);
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364     <span class="keywordflow">else</span> {
<a name="l00365"></a>00365         face = re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a0b583879cb31e74b03c2ac13a7026ac7">rayfaces</a> = (<a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(faces*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7c/structRayFace.html">RayFace</a>), <span class="stringliteral">&quot;Render ray faces&quot;</span>);
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>)
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a5c1b67d82c4200f46390ff7f7b0fa5e9">is_raytraceable</a>(re, obi))
<a name="l00370"></a>00370     {
<a name="l00371"></a>00371         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re))
<a name="l00372"></a>00372             <span class="keywordflow">break</span>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a1cfa507c32a28a31b44652ca0c05373a">has_special_rayobject</a>(re, obi)) {
<a name="l00375"></a>00375             <a class="code" href="../../db/df0/structRayObject.html">RayObject</a> *obj = <a class="code" href="../../d0/d0e/rendercore_8h.html#af599b4381fe2114c1f35923aa4b251bf">makeraytree_object</a>(re, obi);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re))
<a name="l00378"></a>00378                 <span class="keywordflow">break</span>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380             <span class="keywordflow">if</span> (obj)
<a name="l00381"></a>00381                 <a class="code" href="../../d8/d42/rayobject_8h.html#a2ffbe81f0f537e9d372d0dd39ac10340">RE_rayobject_add</a>( re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>, obj );
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         <span class="keywordflow">else</span> {
<a name="l00384"></a>00384             <span class="keywordtype">int</span> v;
<a name="l00385"></a>00385             <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00386"></a>00386             
<a name="l00387"></a>00387             <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l00388"></a>00388             {
<a name="l00389"></a>00389                 obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aae4cdae9afa46b4cd150c490d4bd0081">transform_primitives</a> = 1;
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392             <span class="keywordflow">for</span> (v=0;v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;v++)
<a name="l00393"></a>00393             {
<a name="l00394"></a>00394                 <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a> + (v&amp;255);
<a name="l00395"></a>00395                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a6d413bba661418a9be3cad100145e8cc">is_raytraceable_vlr</a>(re, vlr)) {
<a name="l00396"></a>00396                     <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1103712a19c3d92cc234345d84be77c1">R_RAYTRACE_USE_LOCAL_COORDS</a>)) {
<a name="l00397"></a>00397                         <a class="code" href="../../db/df0/structRayObject.html">RayObject</a> *obj = <a class="code" href="../../d8/d42/rayobject_8h.html#a59d9c6b81824f869794dd5f9f92b265d">RE_vlakprimitive_from_vlak</a>( vlakprimitive, obi, vlr );
<a name="l00398"></a>00398                         <a class="code" href="../../d8/d42/rayobject_8h.html#a2ffbe81f0f537e9d372d0dd39ac10340">RE_rayobject_add</a>( raytree, obj );
<a name="l00399"></a>00399                         vlakprimitive++;
<a name="l00400"></a>00400                     }
<a name="l00401"></a>00401                     <span class="keywordflow">else</span> {
<a name="l00402"></a>00402                         <a class="code" href="../../d8/d42/rayobject_8h.html#a747e3ea348c87a83b4579fcd7debfa17">RE_rayface_from_vlak</a>(face, obi, vlr);
<a name="l00403"></a>00403                         <span class="keywordflow">if</span> ((obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>))
<a name="l00404"></a>00404                         {
<a name="l00405"></a>00405                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, face-&gt;<a class="code" href="../../d3/d7c/structRayFace.html#a5804dd7dcc75ac65c74374be4a6d2ef3">v1</a>);
<a name="l00406"></a>00406                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, face-&gt;<a class="code" href="../../d3/d7c/structRayFace.html#a838c95af23a7378cb471e241322b148c">v2</a>);
<a name="l00407"></a>00407                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, face-&gt;<a class="code" href="../../d3/d7c/structRayFace.html#af2caa05d5b8cd4ce8e945e31312b47cd">v3</a>);
<a name="l00408"></a>00408                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ab83e02191c23c8ec00a34fc79259d547">RE_rayface_isQuad</a>(face))
<a name="l00409"></a>00409                                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, face-&gt;<a class="code" href="../../d3/d7c/structRayFace.html#a2dac7ef9210e8a14baf9f3fe1a614863">v4</a>);
<a name="l00410"></a>00410                         }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412                         <a class="code" href="../../d8/d42/rayobject_8h.html#a2ffbe81f0f537e9d372d0dd39ac10340">RE_rayobject_add</a>( raytree, <a class="code" href="../../db/d64/rayobject__internal_8h.html#a8f512f38b7313b546e4204946dfd59a5">RE_rayobject_unalignRayFace</a>(face) );
<a name="l00413"></a>00413                         face++;
<a name="l00414"></a>00414                     }
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416             }
<a name="l00417"></a>00417         }
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419     
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re))
<a name="l00421"></a>00421     {   
<a name="l00422"></a>00422         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Raytree.. building&quot;</span>;
<a name="l00423"></a>00423         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         <a class="code" href="../../d8/d42/rayobject_8h.html#a2aa8301ec8095e4b03f67b9358e39ddb">RE_rayobject_done</a>( raytree );   
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a97241e0a4a6ebc105bf9130189beac3b">00429</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a97241e0a4a6ebc105bf9130189beac3b">makeraytree</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], sub[3];
<a name="l00432"></a>00432     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00433"></a>00433     
<a name="l00434"></a>00434     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Raytree.. preparing&quot;</span>;
<a name="l00435"></a>00435     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="comment">/* disable options not yet supported by octree,</span>
<a name="l00438"></a>00438 <span class="comment">     * they might actually never be supported (unless people really need it) */</span>
<a name="l00439"></a>00439     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6ecc44c20a25824246b04bcae02881ac">raytrace_structure</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7849171dbfe2b2409ec821417f585299">R_RAYSTRUCTURE_OCTREE</a>)
<a name="l00440"></a>00440         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a2091b40836bdb6bfbf10b93417782895">raytrace_options</a> &amp;= ~( <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a591eeb8a2b02c3f9a3bdb9cf879060a0">R_RAYTRACE_USE_INSTANCES</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1103712a19c3d92cc234345d84be77c1">R_RAYTRACE_USE_LOCAL_COORDS</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <a class="code" href="../../d6/d95/rayshade_8c.html#a3fb935a478882dab7f5bfac761c221cf">makeraytree_single</a>(re);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re)) {
<a name="l00445"></a>00445         <a class="code" href="../../d0/d0e/rendercore_8h.html#a656d598b93806e92c9723b93472b5bac">freeraytree</a>(re);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Raytree building canceled&quot;</span>;
<a name="l00448"></a>00448         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     <span class="keywordflow">else</span> {
<a name="l00451"></a>00451         <span class="comment">//Calculate raytree max_size</span>
<a name="l00452"></a>00452         <span class="comment">//This is ONLY needed to kept a bogus behavior of SUN and HEMI lights</span>
<a name="l00453"></a>00453         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l00454"></a>00454         <a class="code" href="../../d8/d42/rayobject_8h.html#ae08fcc3b995c8afcc537055b862669ac">RE_rayobject_merge_bb</a>( re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>, min, max );
<a name="l00455"></a>00455         <span class="keywordflow">for</span> (i=0; i&lt;3; i++)
<a name="l00456"></a>00456         {
<a name="l00457"></a>00457             min[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += 0.01f;
<a name="l00458"></a>00458             max[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += 0.01f;
<a name="l00459"></a>00459             sub[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = max[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-min[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a95fed64a0fc55e48986b16c358100257">maxdist</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(sub, sub);
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a95fed64a0fc55e48986b16c358100257">maxdist</a> &gt; 0.0f) re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a95fed64a0fc55e48986b16c358100257">maxdist</a>= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a95fed64a0fc55e48986b16c358100257">maxdist</a>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Raytree finished&quot;</span>;
<a name="l00466"></a>00466         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="preprocessor">#ifdef RE_RAYCOUNTER</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span>    memset( re_rc_counter, 0, <span class="keyword">sizeof</span>(re_rc_counter) );
<a name="l00471"></a>00471 <span class="preprocessor">#endif</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span>}
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 <span class="comment">/*  if (shi-&gt;osatex)  */</span>
<a name="l00475"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a245dd3970b4a8bc7a04f4386920f0c56">00475</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a245dd3970b4a8bc7a04f4386920f0c56">shade_ray_set_derivative</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477     <span class="keywordtype">float</span> detsh, t00, t10, t01, t11;
<a name="l00478"></a>00478     <span class="keywordtype">int</span> axis1, axis2;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="comment">/* find most stable axis to project */</span>
<a name="l00481"></a>00481     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(&amp;axis1, &amp;axis2, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="comment">/* compute u,v and derivatives */</span>
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) {
<a name="l00485"></a>00485         <span class="keywordtype">float</span> v1[3], v2[3], v3[3];
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(v1, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00488"></a>00488         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(v2, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00489"></a>00489         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(v3, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="comment">/* same as below */</span>
<a name="l00492"></a>00492         t00= v3[axis1]-v1[axis1]; t01= v3[axis2]-v1[axis2];
<a name="l00493"></a>00493         t10= v3[axis1]-v2[axis1]; t11= v3[axis2]-v2[axis2];
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="keywordflow">else</span> {
<a name="l00496"></a>00496         <span class="keywordtype">float</span> *v1= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00497"></a>00497         <span class="keywordtype">float</span> *v2= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00498"></a>00498         <span class="keywordtype">float</span> *v3= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         <span class="comment">/* same as above */</span>
<a name="l00501"></a>00501         t00= v3[axis1]-v1[axis1]; t01= v3[axis2]-v1[axis2];
<a name="l00502"></a>00502         t10= v3[axis1]-v2[axis1]; t11= v3[axis2]-v2[axis2];
<a name="l00503"></a>00503     }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     detsh= 1.0f/(t00*t11-t10*t01);
<a name="l00506"></a>00506     t00*= detsh; t01*=detsh; 
<a name="l00507"></a>00507     t10*=detsh; t11*=detsh;
<a name="l00508"></a>00508     
<a name="l00509"></a>00509     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9b30b07d25d6fc49d4a8de41be6483fc">dx_u</a>=  shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[axis1]*t11- shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[axis2]*t10;
<a name="l00510"></a>00510     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a236b38170a14ce3ef1cd6886dce9b7ce">dx_v</a>=  shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[axis2]*t00- shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[axis1]*t01;
<a name="l00511"></a>00511     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a53be6a7fcaaf3e4fd1a97d40fc1f98f1">dy_u</a>=  shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[axis1]*t11- shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[axis2]*t10;
<a name="l00512"></a>00512     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab4dc385b9a117874783853290473d0d9">dy_v</a>=  shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[axis2]*t00- shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[axis1]*t01;
<a name="l00513"></a>00513     
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a9f880836c1be6c01eb8c212b513ab7e3">00517</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#ab59a098c8396fbdc601f63c8efa206db">shade_ray</a>(<a class="code" href="../../d8/d95/structIsect.html">Isect</a> *is, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi= (<a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a>*)is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>;
<a name="l00520"></a>00520     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= (<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a>*)is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>;
<a name="l00521"></a>00521     
<a name="l00522"></a>00522     <span class="comment">/* set up view vector */</span>
<a name="l00523"></a>00523     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="comment">/* render co */</span>
<a name="l00526"></a>00526     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]= is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0]+is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]);
<a name="l00527"></a>00527     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]= is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1]+is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]);
<a name="l00528"></a>00528     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]= is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2]+is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]);
<a name="l00529"></a>00529     
<a name="l00530"></a>00530     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>= obi;
<a name="l00533"></a>00533     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00534"></a>00534     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>= vlr;
<a name="l00535"></a>00535     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>= vlr-&gt;mat;
<a name="l00536"></a>00536     <a class="code" href="../../da/d3d/shading_8h.html#aa0c7c5a131fe6e2e4b82f34bea854d4b">shade_input_init_material</a>(shi);
<a name="l00537"></a>00537     
<a name="l00538"></a>00538     <span class="keywordflow">if</span> (is-&gt;<a class="code" href="../../d8/d95/structIsect.html#ac894b12911c645a27bdcacaec05f61fc">isect</a>==2) 
<a name="l00539"></a>00539         <a class="code" href="../../da/d3d/shading_8h.html#a2fbc51b35063837281057ec90573a79c">shade_input_set_triangle_i</a>(shi, obi, vlr, 0, 2, 3);
<a name="l00540"></a>00540     <span class="keywordflow">else</span>
<a name="l00541"></a>00541         <a class="code" href="../../da/d3d/shading_8h.html#a2fbc51b35063837281057ec90573a79c">shade_input_set_triangle_i</a>(shi, obi, vlr, 0, 1, 2);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c69ba091ed77f7eb35827b464f8293c">u</a>= is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a456c1a28d340008560e7f17a47661fa9">u</a>;
<a name="l00544"></a>00544     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a252fb3fb012292cbafd278f216da83b9">v</a>= is-&gt;<a class="code" href="../../d8/d95/structIsect.html#ae538d07a7296ee59175b07f6e4905427">v</a>;
<a name="l00545"></a>00545     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9b30b07d25d6fc49d4a8de41be6483fc">dx_u</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a236b38170a14ce3ef1cd6886dce9b7ce">dx_v</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a53be6a7fcaaf3e4fd1a97d40fc1f98f1">dy_u</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab4dc385b9a117874783853290473d0d9">dy_v</a>=  0.0f;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>)
<a name="l00548"></a>00548         <a class="code" href="../../d6/d95/rayshade_8c.html#a245dd3970b4a8bc7a04f4386920f0c56">shade_ray_set_derivative</a>(shi);
<a name="l00549"></a>00549     <a class="code" href="../../da/d3d/shading_8h.html#a2e7d2d748fbf7f08e521ee0d65c0c692">shade_input_set_normals</a>(shi);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <a class="code" href="../../da/d3d/shading_8h.html#af478c72371d2e749f171cf985baa9dcb">shade_input_set_shade_texco</a>(shi);
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>) {
<a name="l00553"></a>00553         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(is-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>, <a class="code" href="../../d1/d1b/rayintersection_8h.html#acd1dd533a06af58d2e9269daf63f8ac9">RE_RAY_SHADOW</a>, <a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>)) {
<a name="l00554"></a>00554             <a class="code" href="../../df/d25/volumetric_8h.html#adbf3df18c582ff1311b784b5912546a3">shade_volume_shadow</a>(shi, shr, is);
<a name="l00555"></a>00555         }
<a name="l00556"></a>00556         <span class="keywordflow">else</span> {
<a name="l00557"></a>00557             <a class="code" href="../../df/d25/volumetric_8h.html#aea85cc79d9cca983bc4e631c88ed052a">shade_volume_outside</a>(shi, shr);
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l00561"></a>00561         <span class="comment">/* temp hack to prevent recursion */</span>
<a name="l00562"></a>00562         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8f5a9004589299231ca449ba3ba28c8a">nodes</a>==0 &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae5c87659b1f4bd186431d96361ade966">use_nodes</a>) {
<a name="l00563"></a>00563             <a class="code" href="../../d4/d91/BKE__node_8h.html#aafbef737b18290d401e3f33c9d118c6b">ntreeShaderExecTree</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a>, shi, shr);
<a name="l00564"></a>00564             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>= vlr-&gt;mat;     <span class="comment">/* shi-&gt;mat is being set in nodetree */</span>
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566         <span class="keywordflow">else</span>
<a name="l00567"></a>00567             <a class="code" href="../../da/d3d/shading_8h.html#ab1c128f70cd083eeccf16c2b4157e346">shade_color</a>(shi, shr);
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <span class="keywordflow">else</span> {
<a name="l00570"></a>00570         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae5c87659b1f4bd186431d96361ade966">use_nodes</a>) {
<a name="l00571"></a>00571             <a class="code" href="../../d4/d91/BKE__node_8h.html#aafbef737b18290d401e3f33c9d118c6b">ntreeShaderExecTree</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a>, shi, shr);
<a name="l00572"></a>00572             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>= vlr-&gt;mat;     <span class="comment">/* shi-&gt;mat is being set in nodetree */</span>
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574         <span class="keywordflow">else</span> {
<a name="l00575"></a>00575             <a class="code" href="../../da/d3d/shading_8h.html#a1091bd5b76b59935ebd79d3a42e129d4">shade_material_loop</a>(shi, shr);
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577         
<a name="l00578"></a>00578         <span class="comment">/* raytrace likes to separate the spec color */</span>
<a name="l00579"></a>00579         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l00580"></a>00580     }   
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a56cb0750d07b40283ea80e5b8390102e">00584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a56cb0750d07b40283ea80e5b8390102e">refraction</a>(<span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#ab3e5d14000f2e6d76babf9c88a0c3f37">refract</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3], <span class="keywordtype">float</span> index)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>, fac;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(refract, view);
<a name="l00589"></a>00589     
<a name="l00590"></a>00590     dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, n);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (dot&gt;0.0f) {
<a name="l00593"></a>00593         index = 1.0f/index;
<a name="l00594"></a>00594         fac= 1.0f - (1.0f - dot*<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>)*index*index;
<a name="l00595"></a>00595         <span class="keywordflow">if</span> (fac&lt;= 0.0f) <span class="keywordflow">return</span> 0;
<a name="l00596"></a>00596         fac= -dot*index + <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(fac);
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598     <span class="keywordflow">else</span> {
<a name="l00599"></a>00599         fac= 1.0f - (1.0f - dot*<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>)*index*index;
<a name="l00600"></a>00600         <span class="keywordflow">if</span> (fac&lt;= 0.0f) <span class="keywordflow">return</span> 0;
<a name="l00601"></a>00601         fac= -dot*index - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(fac);
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     refract[0]= index*view[0] + fac*n[0];
<a name="l00605"></a>00605     refract[1]= index*view[1] + fac*n[1];
<a name="l00606"></a>00606     refract[2]= index*view[2] + fac*n[2];
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="keywordflow">return</span> 1;
<a name="l00609"></a>00609 }
<a name="l00610"></a>00610 
<a name="l00611"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">00611</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">reflection_simple</a>(<span class="keywordtype">float</span> ref[3], <span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3])
<a name="l00612"></a>00612 {
<a name="l00613"></a>00613     <span class="keyword">const</span> <span class="keywordtype">float</span> f1= -2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, view);
<a name="l00614"></a>00614     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(ref, view, n, f1);
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="comment">/* orn = original face normal */</span>
<a name="l00618"></a><a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">00618</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>(<span class="keywordtype">float</span> ref[3], <span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3], <span class="keyword">const</span> <span class="keywordtype">float</span> orn[3])
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620     <span class="keywordtype">float</span> f1;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">reflection_simple</a>(ref, n, view);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">/* test phong normals, then we should prevent vector going to the back */</span>
<a name="l00625"></a>00625     f1= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ref, orn);
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (f1&gt;0.0f) {
<a name="l00627"></a>00627         f1+= 0.01f;
<a name="l00628"></a>00628         ref[0]-= f1*orn[0];
<a name="l00629"></a>00629         ref[1]-= f1*orn[1];
<a name="l00630"></a>00630         ref[2]-= f1*orn[2];
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="preprocessor">#if 0</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> color_combine(<span class="keywordtype">float</span> *<a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>, <span class="keywordtype">float</span> fac1, <span class="keywordtype">float</span> fac2, <span class="keywordtype">float</span> *col1, <span class="keywordtype">float</span> *col2)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     <span class="keywordtype">float</span> col1t[3], col2t[3];
<a name="l00638"></a>00638     
<a name="l00639"></a>00639     col1t[0]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col1[0]);
<a name="l00640"></a>00640     col1t[1]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col1[1]);
<a name="l00641"></a>00641     col1t[2]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col1[2]);
<a name="l00642"></a>00642     col2t[0]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col2[0]);
<a name="l00643"></a>00643     col2t[1]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col2[1]);
<a name="l00644"></a>00644     col2t[2]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(col2[2]);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     result[0]= (fac1*col1t[0] + fac2*col2t[0]);
<a name="l00647"></a>00647     result[0]*= result[0];
<a name="l00648"></a>00648     result[1]= (fac1*col1t[1] + fac2*col2t[1]);
<a name="l00649"></a>00649     result[1]*= result[1];
<a name="l00650"></a>00650     result[2]= (fac1*col1t[2] + fac2*col2t[2]);
<a name="l00651"></a>00651     result[2]*= result[2];
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 <span class="preprocessor">#endif</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span>
<a name="l00655"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a6e1e020cfc11a89a711681d608c4c296">00655</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a6e1e020cfc11a89a711681d608c4c296">shade_by_transmission</a>(<a class="code" href="../../d8/d95/structIsect.html">Isect</a> *is, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657     <span class="keywordtype">float</span> d;
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (0 == (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>))
<a name="l00659"></a>00659         <span class="keywordflow">return</span> -1;
<a name="l00660"></a>00660        
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a99897d509492300a77ffea0d95535435">tx_limit</a> &lt;= 0.0f) {
<a name="l00662"></a>00662         d= 1.0f;
<a name="l00663"></a>00663     } 
<a name="l00664"></a>00664     <span class="keywordflow">else</span> {
<a name="l00665"></a>00665         <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="comment">/* shi.co[] calculated by shade_ray() */</span>
<a name="l00668"></a>00668         <span class="keyword">const</span> <span class="keywordtype">float</span> dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0] - is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0];
<a name="l00669"></a>00669         <span class="keyword">const</span> <span class="keywordtype">float</span> dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1] - is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1];
<a name="l00670"></a>00670         <span class="keyword">const</span> <span class="keywordtype">float</span> dz= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2] - is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2];
<a name="l00671"></a>00671         d= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dx*dx+dy*dy+dz*dz);
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (d &gt; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a99897d509492300a77ffea0d95535435">tx_limit</a>)
<a name="l00673"></a>00673             d= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a99897d509492300a77ffea0d95535435">tx_limit</a>;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675         p = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a92da5e6b0dcb7aaf12c465b8f40862c6">tx_falloff</a>;
<a name="l00676"></a>00676         <span class="keywordflow">if</span> (p &lt; 0.0f) p= 0.0f;
<a name="l00677"></a>00677         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p &gt; 10.0f) p= 10.0f;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> *= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(d, p);
<a name="l00680"></a>00680         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> &gt; 1.0f)
<a name="l00681"></a>00681             shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= 1.0f;
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">return</span> d;
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a88f266b9f7579d98917547b424ee2ce3">00687</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a88f266b9f7579d98917547b424ee2ce3">ray_fadeout_endcolor</a>(<span class="keywordtype">float</span> col[3], <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *origshi, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *isec, <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3])
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689     <span class="comment">/* un-intersected rays get either rendered material color or sky color */</span>
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a74dcf1951a4433fa5bd5f0b09ef9dd33">fadeto_mir</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a7d2395fb9b802f6a261d9e4607ea72c4">MA_RAYMIR_FADETOMAT</a>) {
<a name="l00691"></a>00691         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a74dcf1951a4433fa5bd5f0b09ef9dd33">fadeto_mir</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab9c6283c99761039bcc19a551ba6233d">MA_RAYMIR_FADETOSKY</a>) {
<a name="l00694"></a>00694         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, vec);
<a name="l00695"></a>00695         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00696"></a>00696         
<a name="l00697"></a>00697         <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(col, isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l00698"></a>00698         <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(col, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a><a class="code" href="../../d6/d95/rayshade_8c.html#aa0ee3c61c95b8ad42ee5d9df1b9f3882">00702</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#aa0ee3c61c95b8ad42ee5d9df1b9f3882">ray_fadeout</a>(<a class="code" href="../../d8/d95/structIsect.html">Isect</a> *is, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> blendcol[3], <span class="keywordtype">float</span> dist_mir)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704     <span class="comment">/* if fading out, linear blend against fade color */</span>
<a name="l00705"></a>00705     <span class="keywordtype">float</span> blendfac;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     blendfac = 1.0f - <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>)/dist_mir;
<a name="l00708"></a>00708     
<a name="l00709"></a>00709     col[0] = col[0]*blendfac + (1.0f - blendfac)*blendcol[0];
<a name="l00710"></a>00710     col[1] = col[1]*blendfac + (1.0f - blendfac)*blendcol[1];
<a name="l00711"></a>00711     col[2] = col[2]*blendfac + (1.0f - blendfac)*blendcol[2];
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/* the main recursive tracer itself</span>
<a name="l00715"></a>00715 <span class="comment"> * note: &#39;col&#39; must be initialized */</span>
<a name="l00716"></a><a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">00716</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *origshi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *origshr, <span class="keywordtype">short</span> depth, <span class="keyword">const</span> <span class="keywordtype">float</span> start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dir[3], <span class="keywordtype">float</span> col[4], <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">int</span> traflag)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi= {0};
<a name="l00719"></a>00719     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l00720"></a>00720     <span class="keywordtype">float</span> dist_mir = origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac542fbfdceb2e05821b4ea9c8f3e9c00">dist_mir</a>;
<a name="l00721"></a>00721     
<a name="l00722"></a>00722     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, start);
<a name="l00723"></a>00723     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, dir );
<a name="l00724"></a>00724     isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = dist_mir &gt; 0 ? dist_mir : <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1c7e702ee03215ce362608ca9032956e">RE_RAYTRACE_MAXDIST</a>;
<a name="l00725"></a>00725     isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#acb514bfd8ddb54e2e79a06ea36f9a5e5">RE_RAY_MIRROR</a>;
<a name="l00726"></a>00726     isec.<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#ae5e08b683b8fa6d16d6ab3b435d7b362">RE_CHECK_VLR_RENDER</a>;
<a name="l00727"></a>00727     isec.<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l00728"></a>00728     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = obi;
<a name="l00731"></a>00731     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = vlr;
<a name="l00732"></a>00732     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, shi);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec)) {
<a name="l00735"></a>00735         <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> shr= {{0}};
<a name="l00736"></a>00736         <span class="keywordtype">float</span> d= 1.0f;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         <span class="comment">/* for as long we don&#39;t have proper dx/dy transform for rays we copy over original */</span>
<a name="l00739"></a>00739         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>, origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>);
<a name="l00740"></a>00740         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>, origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l00741"></a>00741         
<a name="l00742"></a>00742         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>;
<a name="l00743"></a>00743         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>;
<a name="l00744"></a>00744         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> + 1;                  <span class="comment">/* only used to indicate tracing */</span>
<a name="l00745"></a>00745         shi.<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>;
<a name="l00746"></a>00746         <span class="comment">//shi.sample= 0; // memset above, so don&#39;t need this</span>
<a name="l00747"></a>00747         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>;
<a name="l00748"></a>00748         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>;
<a name="l00749"></a>00749         shi.<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>;
<a name="l00750"></a>00750         shi.<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>; <span class="comment">/* result of tracing needs no pass info */</span>
<a name="l00751"></a>00751         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a>= 0xFFFFFF;      <span class="comment">/* ray trace does all options */</span>
<a name="l00752"></a>00752         <span class="comment">//shi.do_preview= 0; // memset above, so don&#39;t need this</span>
<a name="l00753"></a>00753         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>;
<a name="l00754"></a>00754         shi.<a class="code" href="../../d8/db3/structShadeInput.html#af03094325957f5a1521bfb7e7c36ae4e">mat_override</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af03094325957f5a1521bfb7e7c36ae4e">mat_override</a>;
<a name="l00755"></a>00755         
<a name="l00756"></a>00756         <a class="code" href="../../da/d3d/shading_8h.html#ab59a098c8396fbdc601f63c8efa206db">shade_ray</a>(&amp;isec, &amp;shi, &amp;shr);
<a name="l00757"></a>00757         <span class="comment">/* ray has traveled inside the material, so shade by transmission */</span>
<a name="l00758"></a>00758         <span class="keywordflow">if</span> (traflag &amp; <a class="code" href="../../d6/d95/rayshade_8c.html#acb7f0dee6722e234e497a9663239fc2a">RAY_INSIDE</a>)
<a name="l00759"></a>00759             d= <a class="code" href="../../d6/d95/rayshade_8c.html#a6e1e020cfc11a89a711681d608c4c296">shade_by_transmission</a>(&amp;isec, &amp;shi, &amp;shr);
<a name="l00760"></a>00760         
<a name="l00761"></a>00761         <span class="keywordflow">if</span> (depth&gt;0) {
<a name="l00762"></a>00762             <span class="keywordtype">float</span> fr, fg, <a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>, f, f1;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764             <span class="keywordflow">if</span> ((shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> &lt; 1.0f &amp;&amp; (shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a> | <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2f301bfe492802b8461b969fc72b3652">MA_RAYTRANSP</a>))) { 
<a name="l00765"></a>00765                 <span class="keywordtype">float</span> nf, f, <a class="code" href="../../d1/d22/stdosl_8h.html#ab3e5d14000f2e6d76babf9c88a0c3f37">refract</a>[3], tracol[4];
<a name="l00766"></a>00766                 
<a name="l00767"></a>00767                 tracol[0]= shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l00768"></a>00768                 tracol[1]= shi.<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l00769"></a>00769                 tracol[2]= shi.<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l00770"></a>00770                 tracol[3]= col[3];  <span class="comment">// we pass on and accumulate alpha</span>
<a name="l00771"></a>00771                 
<a name="l00772"></a>00772                 <span class="keywordflow">if</span> ((shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2f301bfe492802b8461b969fc72b3652">MA_RAYTRANSP</a>)) {
<a name="l00773"></a>00773                     <span class="comment">/* don&#39;t overwrite traflag, it&#39;s value is used in mirror reflection */</span>
<a name="l00774"></a>00774                     <span class="keywordtype">int</span> new_traflag = traflag;
<a name="l00775"></a>00775                     
<a name="l00776"></a>00776                     <span class="keywordflow">if</span> (new_traflag &amp; RAY_INSIDE) {
<a name="l00777"></a>00777                         <span class="comment">/* inside the material, so use inverse normal */</span>
<a name="l00778"></a>00778                         <span class="keywordtype">float</span> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>[3];
<a name="l00779"></a>00779                         norm[0]= - shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l00780"></a>00780                         norm[1]= - shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l00781"></a>00781                         norm[2]= - shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l00782"></a>00782 
<a name="l00783"></a>00783                         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a56cb0750d07b40283ea80e5b8390102e">refraction</a>(refract, norm, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae4b99d45af79c0bfb6a2fa9ff8c6c479">ang</a>)) {
<a name="l00784"></a>00784                             <span class="comment">/* ray comes out from the material into air */</span>
<a name="l00785"></a>00785                             new_traflag &amp;= ~RAY_INSIDE;
<a name="l00786"></a>00786                         }
<a name="l00787"></a>00787                         <span class="keywordflow">else</span> {
<a name="l00788"></a>00788                             <span class="comment">/* total internal reflection (ray stays inside the material) */</span>
<a name="l00789"></a>00789                             <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>(refract, norm, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l00790"></a>00790                         }
<a name="l00791"></a>00791                     }
<a name="l00792"></a>00792                     <span class="keywordflow">else</span> {
<a name="l00793"></a>00793                         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a56cb0750d07b40283ea80e5b8390102e">refraction</a>(refract, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae4b99d45af79c0bfb6a2fa9ff8c6c479">ang</a>)) {
<a name="l00794"></a>00794                             <span class="comment">/* ray goes in to the material from air */</span>
<a name="l00795"></a>00795                             new_traflag |= <a class="code" href="../../d6/d95/rayshade_8c.html#acb7f0dee6722e234e497a9663239fc2a">RAY_INSIDE</a>;
<a name="l00796"></a>00796                         }
<a name="l00797"></a>00797                         <span class="keywordflow">else</span> {
<a name="l00798"></a>00798                             <span class="comment">/* total external reflection (ray doesn&#39;t enter the material) */</span>
<a name="l00799"></a>00799                             <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>(refract, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l00800"></a>00800                         }
<a name="l00801"></a>00801                     }
<a name="l00802"></a>00802                     <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(origshi, origshr, depth-1, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, refract, tracol, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, new_traflag);
<a name="l00803"></a>00803                 }
<a name="l00804"></a>00804                 <span class="keywordflow">else</span>
<a name="l00805"></a>00805                     <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(origshi, origshr, depth-1, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, tracol, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, 0);
<a name="l00806"></a>00806                 
<a name="l00807"></a>00807                 f= shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>; f1= 1.0f-f;
<a name="l00808"></a>00808                 nf= d * shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>;
<a name="l00809"></a>00809                 fr= 1.0f+ nf*(shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>-1.0f);
<a name="l00810"></a>00810                 fg= 1.0f+ nf*(shi.<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>-1.0f);
<a name="l00811"></a>00811                 fb= 1.0f+ nf*(shi.<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>-1.0f);
<a name="l00812"></a>00812                 shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]= f*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0] + f1*fr*tracol[0];
<a name="l00813"></a>00813                 shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]= f*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1] + f1*fg*tracol[1];
<a name="l00814"></a>00814                 shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]= f*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2] + f1*fb*tracol[2];
<a name="l00815"></a>00815                 
<a name="l00816"></a>00816                 shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0] *=f;
<a name="l00817"></a>00817                 shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1] *=f;
<a name="l00818"></a>00818                 shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2] *=f;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820                 col[3]= f1*tracol[3] + f;
<a name="l00821"></a>00821             }
<a name="l00822"></a>00822             <span class="keywordflow">else</span> 
<a name="l00823"></a>00823                 col[3]= 1.0f;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825             <span class="keywordflow">if</span> (shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a726661eedc26b958c4cbfdef14dbca54">MA_RAYMIRROR</a>) {
<a name="l00826"></a>00826                 f= shi.<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>;
<a name="l00827"></a>00827                 <span class="keywordflow">if</span> (f!=0.0f) f*= <a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8388776b83c1862f3aa946aa7d77b2c1">fresnel_mir_i</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af33839a470d13329493d8a28e68417d8">fresnel_mir</a>);
<a name="l00828"></a>00828             }
<a name="l00829"></a>00829             <span class="keywordflow">else</span> f= 0.0f;
<a name="l00830"></a>00830             
<a name="l00831"></a>00831             <span class="keywordflow">if</span> (f!=0.0f) {
<a name="l00832"></a>00832                 <span class="keywordtype">float</span> mircol[4];
<a name="l00833"></a>00833                 <span class="keywordtype">float</span> ref[3];
<a name="l00834"></a>00834                 
<a name="l00835"></a>00835                 <a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">reflection_simple</a>(ref, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00836"></a>00836                 <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(origshi, origshr, depth-1, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, ref, mircol, shi.<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, traflag);
<a name="l00837"></a>00837             
<a name="l00838"></a>00838                 f1= 1.0f-f;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840                 <span class="comment">/* combine */</span>
<a name="l00841"></a>00841                 <span class="comment">//color_combine(col, f*fr*(1.0f-shr.spec[0]), f1, col, shr.diff);</span>
<a name="l00842"></a>00842                 <span class="comment">//col[0]+= shr.spec[0];</span>
<a name="l00843"></a>00843                 <span class="comment">//col[1]+= shr.spec[1];</span>
<a name="l00844"></a>00844                 <span class="comment">//col[2]+= shr.spec[2];</span>
<a name="l00845"></a>00845                 
<a name="l00846"></a>00846                 fr= shi.<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>;
<a name="l00847"></a>00847                 fg= shi.<a class="code" href="../../d8/db3/structShadeInput.html#a81bee106e6df70a3f16844ce36f84e1d">mirg</a>;
<a name="l00848"></a>00848                 fb= shi.<a class="code" href="../../d8/db3/structShadeInput.html#a8134198d223e10b503401a057c503f2a">mirb</a>;
<a name="l00849"></a>00849         
<a name="l00850"></a>00850                 col[0]= f*fr*(1.0f-shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0])*mircol[0] + f1*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0];
<a name="l00851"></a>00851                 col[1]= f*fg*(1.0f-shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1])*mircol[1] + f1*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1];
<a name="l00852"></a>00852                 col[2]= f*fb*(1.0f-shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2])*mircol[2] + f1*shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2];
<a name="l00853"></a>00853             }
<a name="l00854"></a>00854             <span class="keywordflow">else</span> {
<a name="l00855"></a>00855                 col[0]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0];
<a name="l00856"></a>00856                 col[1]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1];
<a name="l00857"></a>00857                 col[2]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2];
<a name="l00858"></a>00858             }
<a name="l00859"></a>00859             
<a name="l00860"></a>00860             <span class="keywordflow">if</span> (dist_mir &gt; 0.0f) {
<a name="l00861"></a>00861                 <span class="keywordtype">float</span> blendcol[3];
<a name="l00862"></a>00862                 
<a name="l00863"></a>00863                 <span class="comment">/* max ray distance set, but found an intersection, so fade this color</span>
<a name="l00864"></a>00864 <span class="comment">                 * out towards the sky/material color for a smooth transition */</span>
<a name="l00865"></a>00865                 <a class="code" href="../../d6/d95/rayshade_8c.html#a88f266b9f7579d98917547b424ee2ce3">ray_fadeout_endcolor</a>(blendcol, origshi, &amp;shi, origshr, &amp;isec, dir);
<a name="l00866"></a>00866                 <a class="code" href="../../d6/d95/rayshade_8c.html#aa0ee3c61c95b8ad42ee5d9df1b9f3882">ray_fadeout</a>(&amp;isec, &amp;shi, col, blendcol, dist_mir);
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869         <span class="keywordflow">else</span> {
<a name="l00870"></a>00870             col[0]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0];
<a name="l00871"></a>00871             col[1]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1];
<a name="l00872"></a>00872             col[2]= shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2] + shr.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2];
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876     <span class="keywordflow">else</span> {
<a name="l00877"></a>00877         <a class="code" href="../../d6/d95/rayshade_8c.html#a88f266b9f7579d98917547b424ee2ce3">ray_fadeout_endcolor</a>(col, origshi, &amp;shi, origshr, &amp;isec, dir);
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879     <a class="code" href="../../d9/dd4/raycounter_8h.html#a78a1894a09cfe0cd742dbfd2347a2ff7">RE_RC_MERGE</a>(&amp;origshi-&gt;raycounter, &amp;shi.raycounter);
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="comment">/* **************** jitter blocks ********** */</span>
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="comment">/* calc distributed planar energy */</span>
<a name="l00885"></a>00885 
<a name="l00886"></a><a class="code" href="../../d6/d95/rayshade_8c.html#acde1b1a0a0d971b4c3b2fb37da77fcac">00886</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#acde1b1a0a0d971b4c3b2fb37da77fcac">DP_energy</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d7/d35/meshtools_8c.html#ae0806484720dd424e53ea053a3cd1309">table</a>, <span class="keywordtype">float</span> vec[2], <span class="keywordtype">int</span> tot, <span class="keywordtype">float</span> xsize, <span class="keywordtype">float</span> ysize)
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888     <span class="keywordtype">int</span> x, y, a;
<a name="l00889"></a>00889     <span class="keywordtype">float</span> *fp, force[3], <a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>[3];
<a name="l00890"></a>00890     <span class="keywordtype">float</span> dx, dy, dist, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>;
<a name="l00891"></a>00891     
<a name="l00892"></a>00892     min= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(xsize, ysize);
<a name="l00893"></a>00893     min*= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>;
<a name="l00894"></a>00894     result[0]= result[1]= 0.0f;
<a name="l00895"></a>00895     
<a name="l00896"></a>00896     <span class="keywordflow">for</span> (y= -1; y&lt;2; y++) {
<a name="l00897"></a>00897         dy= ysize*y;
<a name="l00898"></a>00898         <span class="keywordflow">for</span> (x= -1; x&lt;2; x++) {
<a name="l00899"></a>00899             dx= xsize*x;
<a name="l00900"></a>00900             fp= <a class="code" href="../../d7/d35/meshtools_8c.html#ae0806484720dd424e53ea053a3cd1309">table</a>;
<a name="l00901"></a>00901             <span class="keywordflow">for</span> (a=0; a&lt;tot; a++, fp+= 2) {
<a name="l00902"></a>00902                 force[0]= vec[0] - fp[0]-dx;
<a name="l00903"></a>00903                 force[1]= vec[1] - fp[1]-dy;
<a name="l00904"></a>00904                 dist= force[0]*force[0] + force[1]*force[1];
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> (dist &lt; min &amp;&amp; dist&gt;0.0f) {
<a name="l00906"></a>00906                     result[0]+= force[0]/dist;
<a name="l00907"></a>00907                     result[1]+= force[1]/dist;
<a name="l00908"></a>00908                 }
<a name="l00909"></a>00909             }
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912     vec[0] += 0.1f*min*result[0]/(float)tot;
<a name="l00913"></a>00913     vec[1] += 0.1f*min*result[1]/(float)tot;
<a name="l00914"></a>00914     <span class="comment">// cyclic clamping</span>
<a name="l00915"></a>00915     vec[0]= vec[0] - xsize*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(vec[0]/xsize + 0.5f);
<a name="l00916"></a>00916     vec[1]= vec[1] - ysize*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(vec[1]/ysize + 0.5f);
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 <span class="comment">// random offset of 1 in 2</span>
<a name="l00920"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">00920</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">jitter_plane_offset</a>(<span class="keywordtype">float</span> *jitter1, <span class="keywordtype">float</span> *jitter2, <span class="keywordtype">int</span> tot, <span class="keywordtype">float</span> sizex, <span class="keywordtype">float</span> sizey, <span class="keywordtype">float</span> ofsx, <span class="keywordtype">float</span> ofsy)
<a name="l00921"></a>00921 {
<a name="l00922"></a>00922     <span class="keywordtype">float</span> dsizex= sizex*ofsx;
<a name="l00923"></a>00923     <span class="keywordtype">float</span> dsizey= sizey*ofsy;
<a name="l00924"></a>00924     <span class="keywordtype">float</span> hsizex= 0.5f*sizex, hsizey= 0.5f*sizey;
<a name="l00925"></a>00925     <span class="keywordtype">int</span> x;
<a name="l00926"></a>00926     
<a name="l00927"></a>00927     <span class="keywordflow">for</span> (x=tot; x&gt;0; x--, jitter1+=2, jitter2+=2) {
<a name="l00928"></a>00928         jitter2[0]= jitter1[0] + dsizex;
<a name="l00929"></a>00929         jitter2[1]= jitter1[1] + dsizey;
<a name="l00930"></a>00930         <span class="keywordflow">if</span> (jitter2[0] &gt; hsizex) jitter2[0]-= sizex;
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (jitter2[1] &gt; hsizey) jitter2[1]-= sizey;
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="comment">/* called from convertBlenderScene.c */</span>
<a name="l00936"></a>00936 <span class="comment">/* we do this in advance to get consistent random, not alter the render seed, and be threadsafe */</span>
<a name="l00937"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a04dff19d6d3dc316e5d70b04df795512">00937</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a04dff19d6d3dc316e5d70b04df795512">init_jitter_plane</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <span class="keywordtype">float</span> *fp;
<a name="l00940"></a>00940     <span class="keywordtype">int</span> x, tot= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l00941"></a>00941     
<a name="l00942"></a>00942     <span class="comment">/* test if already initialized */</span>
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>) <span class="keywordflow">return</span>;
<a name="l00944"></a>00944     
<a name="l00945"></a>00945     <span class="comment">/* at least 4, or max threads+1 tables */</span>
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a> &lt; 4) x= 4;
<a name="l00947"></a>00947     <span class="keywordflow">else</span> x= <a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>+1;
<a name="l00948"></a>00948     fp= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(x*tot*2*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;lamp jitter tab&quot;</span>);
<a name="l00949"></a>00949     
<a name="l00950"></a>00950     <span class="comment">/* if 1 sample, we leave table to be zero&#39;s */</span>
<a name="l00951"></a>00951     <span class="keywordflow">if</span> (tot&gt;1) {
<a name="l00952"></a>00952         <span class="keywordtype">int</span> iter=12;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         <span class="comment">/* set per-lamp fixed seed */</span>
<a name="l00955"></a>00955         <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(tot);
<a name="l00956"></a>00956         
<a name="l00957"></a>00957         <span class="comment">/* fill table with random locations, area_size large */</span>
<a name="l00958"></a>00958         <span class="keywordflow">for</span> (x=0; x&lt;tot; x++, fp+=2) {
<a name="l00959"></a>00959             fp[0]= (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f)*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l00960"></a>00960             fp[1]= (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f)*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>;
<a name="l00961"></a>00961         }
<a name="l00962"></a>00962         
<a name="l00963"></a>00963         <span class="keywordflow">while</span> (iter--) {
<a name="l00964"></a>00964             fp= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>;
<a name="l00965"></a>00965             <span class="keywordflow">for</span> (x=tot; x&gt;0; x--, fp+=2) {
<a name="l00966"></a>00966                 <a class="code" href="../../d6/d95/rayshade_8c.html#acde1b1a0a0d971b4c3b2fb37da77fcac">DP_energy</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, fp, tot, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>);
<a name="l00967"></a>00967             }
<a name="l00968"></a>00968         }
<a name="l00969"></a>00969     }   
<a name="l00970"></a>00970     <span class="comment">/* create the dithered tables (could just check lamp type!) */</span>
<a name="l00971"></a>00971     <a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">jitter_plane_offset</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>+2*tot, tot, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>, 0.5f, 0.0f);
<a name="l00972"></a>00972     <a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">jitter_plane_offset</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>+4*tot, tot, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>, 0.5f, 0.5f);
<a name="l00973"></a>00973     <a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">jitter_plane_offset</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>+6*tot, tot, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>, 0.0f, 0.5f);
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976 <span class="comment">/* table around origin, -0.5*size to 0.5*size */</span>
<a name="l00977"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a3d0987e783ac6d7d2439ec653768742b">00977</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d6/d95/rayshade_8c.html#a3d0987e783ac6d7d2439ec653768742b">give_jitter_plane</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys)
<a name="l00978"></a>00978 {
<a name="l00979"></a>00979     <span class="keywordtype">int</span> tot;
<a name="l00980"></a>00980     
<a name="l00981"></a>00981     tot= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l00982"></a>00982             
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af9d58311395b67c104fbaea5bcaed5bc">ray_samp_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ad833ac65c09700ed4490f705f1267618">LA_SAMP_JITTER</a>) {
<a name="l00984"></a>00984         <span class="comment">/* made it threadsafe */</span>
<a name="l00985"></a>00985         
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abc18e8fc05ded8ddff32b310fb2aa86c">xold</a>[thread]!=xs || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7925283e6161c8ade2d160dfd46d58db">yold</a>[thread]!=ys) {
<a name="l00987"></a>00987             <a class="code" href="../../d6/d95/rayshade_8c.html#a09b250709ca64d9f0cc430c42c026cab">jitter_plane_offset</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>+2*(thread+1)*tot, tot, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>, <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread), <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread));
<a name="l00988"></a>00988             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abc18e8fc05ded8ddff32b310fb2aa86c">xold</a>[thread]= xs; 
<a name="l00989"></a>00989             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7925283e6161c8ade2d160dfd46d58db">yold</a>[thread]= ys;
<a name="l00990"></a>00990         }
<a name="l00991"></a>00991         <span class="keywordflow">return</span> lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>+2*(thread+1)*tot;
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af9d58311395b67c104fbaea5bcaed5bc">ray_samp_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1c3f0e22e7a0aa0446aafb40442752b2">LA_SAMP_DITHER</a>) {
<a name="l00994"></a>00994         <span class="keywordflow">return</span> lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a> + 2*tot*((xs &amp; 1)+2*(ys &amp; 1));
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996     
<a name="l00997"></a>00997     <span class="keywordflow">return</span> lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>;
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="comment">/* **************** QMC sampling *************** */</span>
<a name="l01002"></a>01002 
<a name="l01003"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a90935e5eee2b01db9e1c8a03a5339c78">01003</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a90935e5eee2b01db9e1c8a03a5339c78">halton_sample</a>(<span class="keywordtype">double</span> *ht_invprimes, <span class="keywordtype">double</span> *ht_nums, <span class="keywordtype">double</span> *v)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <span class="comment">// incremental halton sequence generator, from:</span>
<a name="l01006"></a>01006     <span class="comment">// &quot;Instant Radiosity&quot;, Keller A.</span>
<a name="l01007"></a>01007     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01008"></a>01008     
<a name="l01009"></a>01009     <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++)
<a name="l01010"></a>01010     {
<a name="l01011"></a>01011         <span class="keywordtype">double</span> <a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a> = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>((1.0 - ht_nums[i]) - 1e-10);
<a name="l01012"></a>01012         
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (ht_invprimes[i] &gt;= r)
<a name="l01014"></a>01014         {
<a name="l01015"></a>01015             <span class="keywordtype">double</span> lasth;
<a name="l01016"></a>01016             <span class="keywordtype">double</span> h = ht_invprimes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01017"></a>01017             
<a name="l01018"></a>01018             <span class="keywordflow">do</span> {
<a name="l01019"></a>01019                 lasth = h;
<a name="l01020"></a>01020                 h *= ht_invprimes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01021"></a>01021             } <span class="keywordflow">while</span> (h &gt;= r);
<a name="l01022"></a>01022             
<a name="l01023"></a>01023             ht_nums[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += ((lasth + h) - 1.0);
<a name="l01024"></a>01024         }
<a name="l01025"></a>01025         <span class="keywordflow">else</span>
<a name="l01026"></a>01026             ht_nums[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += ht_invprimes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01027"></a>01027         
<a name="l01028"></a>01028         v[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (float)ht_nums[i];
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032 <span class="comment">/* Generate Hammersley points in [0,1)^2</span>
<a name="l01033"></a>01033 <span class="comment"> * From Lucille renderer */</span>
<a name="l01034"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ab68519e72b74e06cdef8d5c187a2b790">01034</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ab68519e72b74e06cdef8d5c187a2b790">hammersley_create</a>(<span class="keywordtype">double</span> *out, <span class="keywordtype">int</span> n)
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036     <span class="keywordtype">double</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, t;
<a name="l01037"></a>01037     <span class="keywordtype">int</span> k, kk;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="keywordflow">for</span> (k = 0; k &lt; n; k++) {
<a name="l01040"></a>01040         t = 0;
<a name="l01041"></a>01041         <span class="keywordflow">for</span> (p = 0.5, kk = k; kk; p *= 0.5, kk &gt;&gt;= 1) {
<a name="l01042"></a>01042             <span class="keywordflow">if</span> (kk &amp; 1) {       <span class="comment">/* kk mod 2 = 1     */</span>
<a name="l01043"></a>01043                 t += <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01044"></a>01044             }
<a name="l01045"></a>01045         }
<a name="l01046"></a>01046     
<a name="l01047"></a>01047         out[2 * k + 0] = (double)k / (<span class="keywordtype">double</span>)n;
<a name="l01048"></a>01048         out[2 * k + 1] = t;
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 
<a name="l01052"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a94272fba09d04b9610097125b9e67339">01052</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *<a class="code" href="../../d6/d95/rayshade_8c.html#a94272fba09d04b9610097125b9e67339">QMC_initSampler</a>(<span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>, <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>)
<a name="l01053"></a>01053 {   
<a name="l01054"></a>01054     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a>), <span class="stringliteral">&quot;qmc sampler&quot;</span>);
<a name="l01055"></a>01055     qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(2*<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>)*tot, <span class="stringliteral">&quot;qmc sample table&quot;</span>);
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a> = <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>;
<a name="l01058"></a>01058     qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a> = <a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>;
<a name="l01059"></a>01059     
<a name="l01060"></a>01060     <span class="keywordflow">if</span> (qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>==<a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>) 
<a name="l01061"></a>01061         <a class="code" href="../../d6/d95/rayshade_8c.html#ab68519e72b74e06cdef8d5c187a2b790">hammersley_create</a>(qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>, qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>);
<a name="l01062"></a>01062         
<a name="l01063"></a>01063     <span class="keywordflow">return</span> qsa;
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 
<a name="l01066"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">01066</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">QMC_initPixel</a>(<a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>==<a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>)
<a name="l01069"></a>01069     {
<a name="l01070"></a>01070         <span class="comment">/* hammersley sequence is fixed, already created in QMCSampler init.</span>
<a name="l01071"></a>01071 <span class="comment">         * per pixel, gets a random offset. We create separate offsets per thread, for write-safety */</span>
<a name="l01072"></a>01072         qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a8b81d6c9d7e6bd5e6ad6016be49f99a2">offs</a>[thread][0] = 0.5f * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01073"></a>01073         qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a8b81d6c9d7e6bd5e6ad6016be49f99a2">offs</a>[thread][1] = 0.5f * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075     <span class="keywordflow">else</span> {  <span class="comment">/* SAMP_TYPE_HALTON */</span>
<a name="l01076"></a>01076         
<a name="l01077"></a>01077         <span class="comment">/* generate a new randomised halton sequence per pixel</span>
<a name="l01078"></a>01078 <span class="comment">         * to alleviate qmc artifacts and make it reproducible </span>
<a name="l01079"></a>01079 <span class="comment">         * between threads/frames */</span>
<a name="l01080"></a>01080         <span class="keywordtype">double</span> ht_invprimes[2], ht_nums[2];
<a name="l01081"></a>01081         <span class="keywordtype">double</span> r[2];
<a name="l01082"></a>01082         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01083"></a>01083     
<a name="l01084"></a>01084         ht_nums[0] = <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01085"></a>01085         ht_nums[1] = <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01086"></a>01086         ht_invprimes[0] = 0.5;
<a name="l01087"></a>01087         ht_invprimes[1] = 1.0/3.0;
<a name="l01088"></a>01088         
<a name="l01089"></a>01089         <span class="keywordflow">for</span> (i=0; i&lt; qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>; i++) {
<a name="l01090"></a>01090             <a class="code" href="../../d6/d95/rayshade_8c.html#a90935e5eee2b01db9e1c8a03a5339c78">halton_sample</a>(ht_invprimes, ht_nums, r);
<a name="l01091"></a>01091             qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*i+0] = r[0];
<a name="l01092"></a>01092             qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*i+1] = r[1];
<a name="l01093"></a>01093         }
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 
<a name="l01097"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ad2be6e7ccaf4f08c54a377d0594c8929">01097</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ad2be6e7ccaf4f08c54a377d0594c8929">QMC_freeSampler</a>(<a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>);
<a name="l01100"></a>01100     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(qsa);
<a name="l01101"></a>01101 }
<a name="l01102"></a>01102 
<a name="l01103"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">01103</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(<span class="keywordtype">double</span> *s, <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105     <span class="keywordflow">if</span> (qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a> == <a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>) {
<a name="l01106"></a>01106         s[0] = fmod(qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*num+0] + qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a8b81d6c9d7e6bd5e6ad6016be49f99a2">offs</a>[thread][0], 1.0f);
<a name="l01107"></a>01107         s[1] = fmod(qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*num+1] + qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a8b81d6c9d7e6bd5e6ad6016be49f99a2">offs</a>[thread][1], 1.0f);
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109     <span class="keywordflow">else</span> { <span class="comment">/* SAMP_TYPE_HALTON */</span>
<a name="l01110"></a>01110         s[0] = qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*num+0];
<a name="l01111"></a>01111         s[1] = qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a024487e9cbf02e2a3a51ee9e80cbd9f4">samp2d</a>[2*num+1];
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="comment">/* phong weighted disc using &#39;blur&#39; for exponent, centred on 0,0 */</span>
<a name="l01116"></a><a class="code" href="../../d6/d95/rayshade_8c.html#aa2be93f8dab434d2f04f72ca93dc8df3">01116</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#aa2be93f8dab434d2f04f72ca93dc8df3">QMC_samplePhong</a>(<span class="keywordtype">float</span> vec[3], <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num, <span class="keywordtype">float</span> blur)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118     <span class="keywordtype">double</span> s[2];
<a name="l01119"></a>01119     <span class="keywordtype">float</span> phi, pz, <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01120"></a>01120     
<a name="l01121"></a>01121     <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(s, qsa, thread, num);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123     phi = s[0]*2*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l01124"></a>01124     pz = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(s[1], blur);
<a name="l01125"></a>01125     sqr = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(1.0f-pz*pz);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     vec[0] = (float)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>);
<a name="l01128"></a>01128     vec[1] = (float)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>);
<a name="l01129"></a>01129     vec[2] = 0.0f;
<a name="l01130"></a>01130 }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="comment">/* rect of edge lengths sizex, sizey, centred on 0.0,0.0 i.e. ranging from -sizex/2 to +sizey/2 */</span>
<a name="l01133"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ab4c25ab86a32968a884792f2c8ff72e2">01133</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ab4c25ab86a32968a884792f2c8ff72e2">QMC_sampleRect</a>(<span class="keywordtype">float</span> vec[3], <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num, <span class="keywordtype">float</span> sizex, <span class="keywordtype">float</span> sizey)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     <span class="keywordtype">double</span> s[2];
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(s, qsa, thread, num);
<a name="l01138"></a>01138         
<a name="l01139"></a>01139     vec[0] = (float)(s[0] - 0.5) * sizex;
<a name="l01140"></a>01140     vec[1] = (float)(s[1] - 0.5) * sizey;
<a name="l01141"></a>01141     vec[2] = 0.0f;
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 <span class="comment">/* disc of radius &#39;radius&#39;, centred on 0,0 */</span>
<a name="l01145"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ad87e79538a6f0ea4cbcbaa3922cb2e02">01145</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ad87e79538a6f0ea4cbcbaa3922cb2e02">QMC_sampleDisc</a>(<span class="keywordtype">float</span> vec[3], <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num, <span class="keywordtype">float</span> radius)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147     <span class="keywordtype">double</span> s[2];
<a name="l01148"></a>01148     <span class="keywordtype">float</span> phi, <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01149"></a>01149     
<a name="l01150"></a>01150     <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(s, qsa, thread, num);
<a name="l01151"></a>01151     
<a name="l01152"></a>01152     phi = s[0]*2*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l01153"></a>01153     sqr = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(s[1]);
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     vec[0] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(phi)*sqr* radius/2.0f;
<a name="l01156"></a>01156     vec[1] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(phi)*sqr* radius/2.0f;
<a name="l01157"></a>01157     vec[2] = 0.0f;
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 <span class="comment">/* uniform hemisphere sampling */</span>
<a name="l01161"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a27d560f0dc4d9f4f6b4c5ff929da46e9">01161</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a27d560f0dc4d9f4f6b4c5ff929da46e9">QMC_sampleHemi</a>(<span class="keywordtype">float</span> vec[3], <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num)
<a name="l01162"></a>01162 {
<a name="l01163"></a>01163     <span class="keywordtype">double</span> s[2];
<a name="l01164"></a>01164     <span class="keywordtype">float</span> phi, <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01165"></a>01165     
<a name="l01166"></a>01166     <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(s, qsa, thread, num);
<a name="l01167"></a>01167     
<a name="l01168"></a>01168     phi = s[0]*2.0*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l01169"></a>01169     sqr = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(s[1]);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171     vec[0] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01172"></a>01172     vec[1] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01173"></a>01173     vec[2] = (float)(1.0 - s[1]*s[1]);
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="preprocessor">#if 0 </span><span class="comment">/* currently not used */</span>
<a name="l01177"></a>01177 <span class="comment">/* cosine weighted hemisphere sampling */</span>
<a name="l01178"></a>01178 <span class="keyword">static</span> <span class="keywordtype">void</span> QMC_sampleHemiCosine(<span class="keywordtype">float</span> vec[3], <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> num)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180     <span class="keywordtype">double</span> s[2];
<a name="l01181"></a>01181     <span class="keywordtype">float</span> phi, <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01182"></a>01182     
<a name="l01183"></a>01183     <a class="code" href="../../d6/d95/rayshade_8c.html#a8dbf5e67da1f3733560603c8241e9950">QMC_getSample</a>(s, qsa, thread, num);
<a name="l01184"></a>01184     
<a name="l01185"></a>01185     phi = s[0]*2.f*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;    
<a name="l01186"></a>01186     sqr = s[1]*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(2-s[1]*s[1]);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     vec[0] = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01189"></a>01189     vec[1] = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi)*<a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>;
<a name="l01190"></a>01190     vec[2] = 1.f - s[1]*s[1];
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 <span class="preprocessor">#endif</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>
<a name="l01195"></a>01195 <span class="comment">/* called from convertBlenderScene.c */</span>
<a name="l01196"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a2cd9717bc841d83c6f45aa6861ead413">01196</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a2cd9717bc841d83c6f45aa6861ead413">init_render_qmcsampler</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l01197"></a>01197 {
<a name="l01198"></a>01198     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>)*<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>, <span class="stringliteral">&quot;QMCListBase&quot;</span>);
<a name="l01199"></a>01199 }
<a name="l01200"></a>01200 
<a name="l01201"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">01201</a> <span class="keyword">static</span> <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *<a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>, <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>)
<a name="l01202"></a>01202 {
<a name="l01203"></a>01203     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa;
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     <span class="comment">/* create qmc samplers as needed, since recursion makes it hard to</span>
<a name="l01206"></a>01206 <span class="comment">     * predict how many are needed */</span>
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="keywordflow">for</span> (qsa=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>[thread].<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; qsa; qsa=qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a517dc65edb359403028e8483026a2bff">next</a>) {
<a name="l01209"></a>01209         <span class="keywordflow">if</span> (qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a> == type &amp;&amp; qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a> == tot &amp;&amp; !qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a61581b0f9bb1efc63a3fe42d35832a77">used</a>) {
<a name="l01210"></a>01210             qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a61581b0f9bb1efc63a3fe42d35832a77">used</a>= 1;
<a name="l01211"></a>01211             <span class="keywordflow">return</span> qsa;
<a name="l01212"></a>01212         }
<a name="l01213"></a>01213     }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     qsa= <a class="code" href="../../d6/d95/rayshade_8c.html#a94272fba09d04b9610097125b9e67339">QMC_initSampler</a>(type, tot);
<a name="l01216"></a>01216     qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a61581b0f9bb1efc63a3fe42d35832a77">used</a>= 1;
<a name="l01217"></a>01217     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>[thread], qsa);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="keywordflow">return</span> qsa;
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">01222</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">release_thread_qmcsampler</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(<a class="code" href="../../df/d68/classthread.html">thread</a>), <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa)
<a name="l01223"></a>01223 {
<a name="l01224"></a>01224     qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a61581b0f9bb1efc63a3fe42d35832a77">used</a>= 0;
<a name="l01225"></a>01225 }
<a name="l01226"></a>01226 
<a name="l01227"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a3446cf8963a286e4e6b0a9a4cdec2c61">01227</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a3446cf8963a286e4e6b0a9a4cdec2c61">free_render_qmcsampler</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l01228"></a>01228 {
<a name="l01229"></a>01229     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>) {
<a name="l01230"></a>01230         <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01231"></a>01231         <span class="keywordtype">int</span> a;
<a name="l01232"></a>01232         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>; a++) {
<a name="l01233"></a>01233             <span class="keywordflow">for</span> (qsa=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>[a].<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; qsa; qsa=next) {
<a name="l01234"></a>01234                 next= qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a517dc65edb359403028e8483026a2bff">next</a>;
<a name="l01235"></a>01235                 <a class="code" href="../../d6/d95/rayshade_8c.html#ad2be6e7ccaf4f08c54a377d0594c8929">QMC_freeSampler</a>(qsa);
<a name="l01236"></a>01236             }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238             re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>[a].<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>[a].<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>);
<a name="l01242"></a>01242         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01243"></a>01243     }
<a name="l01244"></a>01244 }
<a name="l01245"></a>01245 
<a name="l01246"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a88e9acaf390f419894540cd17026824f">01246</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a88e9acaf390f419894540cd17026824f">adaptive_sample_variance</a>(<span class="keywordtype">int</span> samples, <span class="keyword">const</span> <span class="keywordtype">float</span> col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> colsq[3], <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>)
<a name="l01247"></a>01247 {
<a name="l01248"></a>01248     <span class="keywordtype">float</span> var[3], mean[3];
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <span class="comment">/* scale threshold just to give a bit more precision in input rather than dealing with </span>
<a name="l01251"></a>01251 <span class="comment">     * tiny tiny numbers in the UI */</span>
<a name="l01252"></a>01252     thresh /= 2;
<a name="l01253"></a>01253     
<a name="l01254"></a>01254     mean[0] = col[0] / (float)samples;
<a name="l01255"></a>01255     mean[1] = col[1] / (float)samples;
<a name="l01256"></a>01256     mean[2] = col[2] / (float)samples;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258     var[0] = (colsq[0] / (float)samples) - (mean[0]*mean[0]);
<a name="l01259"></a>01259     var[1] = (colsq[1] / (float)samples) - (mean[1]*mean[1]);
<a name="l01260"></a>01260     var[2] = (colsq[2] / (float)samples) - (mean[2]*mean[2]);
<a name="l01261"></a>01261     
<a name="l01262"></a>01262     <span class="keywordflow">if</span> ((var[0] * 0.4f &lt; thresh) &amp;&amp; (var[1] * 0.3f &lt; <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>) &amp;&amp; (var[2] * 0.6f &lt; thresh))
<a name="l01263"></a>01263         <span class="keywordflow">return</span> 1;
<a name="l01264"></a>01264     <span class="keywordflow">else</span>
<a name="l01265"></a>01265         <span class="keywordflow">return</span> 0;
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267 
<a name="l01268"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a02f39d584523743064bcbedba7ac9e14">01268</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a02f39d584523743064bcbedba7ac9e14">adaptive_sample_contrast_val</a>(<span class="keywordtype">int</span> samples, <span class="keywordtype">float</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a1b5f5018818ec6be0f4478d306260ffb">prev</a>, <span class="keywordtype">float</span> val, <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270     <span class="comment">/* if the last sample&#39;s contribution to the total value was below a small threshold</span>
<a name="l01271"></a>01271 <span class="comment">     * (i.e. the samples taken are very similar), then taking more samples that are probably </span>
<a name="l01272"></a>01272 <span class="comment">     * going to be the same is wasting effort */</span>
<a name="l01273"></a>01273     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>( prev/(<span class="keywordtype">float</span>)(samples-1) - val/(<span class="keywordtype">float</span>)samples ) &lt; thresh) {
<a name="l01274"></a>01274         <span class="keywordflow">return</span> 1;
<a name="l01275"></a>01275     }
<a name="l01276"></a>01276     <span class="keywordflow">else</span>
<a name="l01277"></a>01277         <span class="keywordflow">return</span> 0;
<a name="l01278"></a>01278 }
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ae11fc660cb3cbb42aa04593de60cef7d">01280</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ae11fc660cb3cbb42aa04593de60cef7d">get_avg_speed</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l01281"></a>01281 {
<a name="l01282"></a>01282     <span class="keywordtype">float</span> pre_x, pre_y, post_x, post_y, speedavg;
<a name="l01283"></a>01283     
<a name="l01284"></a>01284     pre_x = (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[0] == <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>)?0.0f:shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[0];
<a name="l01285"></a>01285     pre_y = (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[1] == <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>)?0.0f:shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[1];
<a name="l01286"></a>01286     post_x = (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[2] == <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>)?0.0f:shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[2];
<a name="l01287"></a>01287     post_y = (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[3] == <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>)?0.0f:shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afae09e4f460c42be6b3a7edbc0fe4b2d">winspeed</a>[3];
<a name="l01288"></a>01288     
<a name="l01289"></a>01289     speedavg = (<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(pre_x*pre_x + pre_y*pre_y) + <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(post_x*post_x + post_y*post_y)) / 2.0;
<a name="l01290"></a>01290     
<a name="l01291"></a>01291     <span class="keywordflow">return</span> speedavg;
<a name="l01292"></a>01292 }
<a name="l01293"></a>01293 
<a name="l01294"></a>01294 <span class="comment">/* ***************** main calls ************** */</span>
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 
<a name="l01297"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a79e037cae60eb2570eeb6aa5bcb04441">01297</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a79e037cae60eb2570eeb6aa5bcb04441">trace_refract</a>(<span class="keywordtype">float</span> col[4], <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01298"></a>01298 {
<a name="l01299"></a>01299     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01300"></a>01300     <span class="keywordtype">int</span> samp_type;
<a name="l01301"></a>01301     <span class="keywordtype">int</span> traflag=0;
<a name="l01302"></a>01302     
<a name="l01303"></a>01303     <span class="keywordtype">float</span> samp3d[3], orthx[3], orthy[3];
<a name="l01304"></a>01304     <span class="keywordtype">float</span> v_refract[3], v_refract_new[3];
<a name="l01305"></a>01305     <span class="keywordtype">float</span> sampcol[4], colsq[4];
<a name="l01306"></a>01306     
<a name="l01307"></a>01307     <span class="keywordtype">float</span> blur = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a17886fc73bb73e837d2d9e323723aa76">gloss_tra</a>, 3);
<a name="l01308"></a>01308     <span class="keywordtype">short</span> max_samples = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab72aab34f1d2c7f650e136bf63bd024a">samp_gloss_tra</a>;
<a name="l01309"></a>01309     <span class="keywordtype">float</span> adapt_thresh = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a134cebd8c6fa63cd002fb063761dd3b5">adapt_thresh_tra</a>;
<a name="l01310"></a>01310     
<a name="l01311"></a>01311     <span class="keywordtype">int</span> samples=0;
<a name="l01312"></a>01312     
<a name="l01313"></a>01313     colsq[0] = colsq[1] = colsq[2] = 0.0;
<a name="l01314"></a>01314     col[0] = col[1] = col[2] = 0.0;
<a name="l01315"></a>01315     col[3]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="keywordflow">if</span> (blur &gt; 0.0f) {
<a name="l01318"></a>01318         <span class="keywordflow">if</span> (adapt_thresh != 0.0f) samp_type = <a class="code" href="../../db/d00/render__types_8h.html#ab6cd5e11cb2b9f0cc66230c92821d920">SAMP_TYPE_HALTON</a>;
<a name="l01319"></a>01319         <span class="keywordflow">else</span> samp_type = <a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>;
<a name="l01320"></a>01320             
<a name="l01321"></a>01321         <span class="comment">/* all samples are generated per pixel */</span>
<a name="l01322"></a>01322         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samp_type, max_samples);
<a name="l01323"></a>01323         <a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">QMC_initPixel</a>(qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325     <span class="keywordflow">else</span>
<a name="l01326"></a>01326         max_samples = 1;
<a name="l01327"></a>01327     
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="keywordflow">while</span> (samples &lt; max_samples) {     
<a name="l01330"></a>01330         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a56cb0750d07b40283ea80e5b8390102e">refraction</a>(v_refract, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae4b99d45af79c0bfb6a2fa9ff8c6c479">ang</a>)) {
<a name="l01331"></a>01331             traflag |= <a class="code" href="../../d6/d95/rayshade_8c.html#acb7f0dee6722e234e497a9663239fc2a">RAY_INSIDE</a>;
<a name="l01332"></a>01332         }
<a name="l01333"></a>01333         <span class="keywordflow">else</span> {
<a name="l01334"></a>01334             <span class="comment">/* total external reflection can happen for materials with IOR &lt; 1.0 */</span>
<a name="l01335"></a>01335             <span class="keywordflow">if</span> ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>)) 
<a name="l01336"></a>01336                 <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>(v_refract, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>);
<a name="l01337"></a>01337             <span class="keywordflow">else</span>
<a name="l01338"></a>01338                 <a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">reflection_simple</a>(v_refract, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l01339"></a>01339 
<a name="l01340"></a>01340             <span class="comment">/* can&#39;t blur total external reflection */</span>
<a name="l01341"></a>01341             max_samples = 1;
<a name="l01342"></a>01342         }
<a name="l01343"></a>01343         
<a name="l01344"></a>01344         <span class="keywordflow">if</span> (max_samples &gt; 1) {
<a name="l01345"></a>01345             <span class="comment">/* get a quasi-random vector from a phong-weighted disc */</span>
<a name="l01346"></a>01346             <a class="code" href="../../d6/d95/rayshade_8c.html#aa2be93f8dab434d2f04f72ca93dc8df3">QMC_samplePhong</a>(samp3d, qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samples, blur);
<a name="l01347"></a>01347                         
<a name="l01348"></a>01348             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>( orthx, orthy,v_refract);
<a name="l01349"></a>01349             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthx, samp3d[0]);
<a name="l01350"></a>01350             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthy, samp3d[1]);
<a name="l01351"></a>01351                 
<a name="l01352"></a>01352             <span class="comment">/* and perturb the refraction vector in it */</span>
<a name="l01353"></a>01353             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(v_refract_new, v_refract, orthx);
<a name="l01354"></a>01354             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v_refract_new, orthy);
<a name="l01355"></a>01355             
<a name="l01356"></a>01356             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v_refract_new);
<a name="l01357"></a>01357         }
<a name="l01358"></a>01358         <span class="keywordflow">else</span> {
<a name="l01359"></a>01359             <span class="comment">/* no blurriness, use the original normal */</span>
<a name="l01360"></a>01360             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v_refract_new, v_refract);
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362         
<a name="l01363"></a>01363         sampcol[0]= sampcol[1]= sampcol[2]= sampcol[3]= 0.0f;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365         <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(shi, shr, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a27faa604328ed5ef1ff9855f5242a024">ray_depth_tra</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, v_refract_new, sampcol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, traflag);
<a name="l01366"></a>01366     
<a name="l01367"></a>01367         col[0] += sampcol[0];
<a name="l01368"></a>01368         col[1] += sampcol[1];
<a name="l01369"></a>01369         col[2] += sampcol[2];
<a name="l01370"></a>01370         col[3] += sampcol[3];
<a name="l01371"></a>01371         
<a name="l01372"></a>01372         <span class="comment">/* for variance calc */</span>
<a name="l01373"></a>01373         colsq[0] += sampcol[0]*sampcol[0];
<a name="l01374"></a>01374         colsq[1] += sampcol[1]*sampcol[1];
<a name="l01375"></a>01375         colsq[2] += sampcol[2]*sampcol[2];
<a name="l01376"></a>01376         
<a name="l01377"></a>01377         samples++;
<a name="l01378"></a>01378         
<a name="l01379"></a>01379         <span class="comment">/* adaptive sampling */</span>
<a name="l01380"></a>01380         <span class="keywordflow">if</span> (adapt_thresh &lt; 1.0f &amp;&amp; samples &gt; max_samples/2)
<a name="l01381"></a>01381         {
<a name="l01382"></a>01382             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a88e9acaf390f419894540cd17026824f">adaptive_sample_variance</a>(samples, col, colsq, adapt_thresh))
<a name="l01383"></a>01383                 <span class="keywordflow">break</span>;
<a name="l01384"></a>01384             
<a name="l01385"></a>01385             <span class="comment">/* if the pixel so far is very dark, we can get away with less samples */</span>
<a name="l01386"></a>01386             <span class="keywordflow">if</span> ( (col[0] + col[1] + col[2])/3.0f/(<span class="keywordtype">float</span>)samples &lt; 0.01f )
<a name="l01387"></a>01387                 max_samples--;
<a name="l01388"></a>01388         }
<a name="l01389"></a>01389     }
<a name="l01390"></a>01390     
<a name="l01391"></a>01391     col[0] /= (float)samples;
<a name="l01392"></a>01392     col[1] /= (float)samples;
<a name="l01393"></a>01393     col[2] /= (float)samples;
<a name="l01394"></a>01394     col[3] /= (float)samples;
<a name="l01395"></a>01395     
<a name="l01396"></a>01396     <span class="keywordflow">if</span> (qsa)
<a name="l01397"></a>01397         <a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">release_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, qsa);
<a name="l01398"></a>01398 }
<a name="l01399"></a>01399 
<a name="l01400"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a1cd256766da2607dc7c4ada4fab30489">01400</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a1cd256766da2607dc7c4ada4fab30489">trace_reflect</a>(<span class="keywordtype">float</span> col[3], <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">float</span> fresnelfac)
<a name="l01401"></a>01401 {
<a name="l01402"></a>01402     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01403"></a>01403     <span class="keywordtype">int</span> samp_type;
<a name="l01404"></a>01404     
<a name="l01405"></a>01405     <span class="keywordtype">float</span> samp3d[3], orthx[3], orthy[3];
<a name="l01406"></a>01406     <span class="keywordtype">float</span> v_nor_new[3], v_reflect[3];
<a name="l01407"></a>01407     <span class="keywordtype">float</span> sampcol[4], colsq[4];
<a name="l01408"></a>01408         
<a name="l01409"></a>01409     <span class="keywordtype">float</span> blur = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae9c4f4e3b999725bf1e19a4e4c7159b1">gloss_mir</a>, 3);
<a name="l01410"></a>01410     <span class="keywordtype">short</span> max_samples = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab02ae3ebb0377382070fbd81776e995e">samp_gloss_mir</a>;
<a name="l01411"></a>01411     <span class="keywordtype">float</span> adapt_thresh = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a906e8a127e0724e4bf84f4dcbc92cc25">adapt_thresh_mir</a>;
<a name="l01412"></a>01412     <span class="keywordtype">float</span> aniso = 1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1f806b2d92b5ebca2310e54921687e3f">aniso_gloss_mir</a>;
<a name="l01413"></a>01413     
<a name="l01414"></a>01414     <span class="keywordtype">int</span> samples=0;
<a name="l01415"></a>01415     
<a name="l01416"></a>01416     col[0] = col[1] = col[2] = 0.0;
<a name="l01417"></a>01417     colsq[0] = colsq[1] = colsq[2] = 0.0;
<a name="l01418"></a>01418     
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (blur &gt; 0.0f) {
<a name="l01420"></a>01420         <span class="keywordflow">if</span> (adapt_thresh != 0.0f) samp_type = <a class="code" href="../../db/d00/render__types_8h.html#ab6cd5e11cb2b9f0cc66230c92821d920">SAMP_TYPE_HALTON</a>;
<a name="l01421"></a>01421         <span class="keywordflow">else</span> samp_type = <a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>;
<a name="l01422"></a>01422             
<a name="l01423"></a>01423         <span class="comment">/* all samples are generated per pixel */</span>
<a name="l01424"></a>01424         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samp_type, max_samples);
<a name="l01425"></a>01425         <a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">QMC_initPixel</a>(qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l01426"></a>01426     }
<a name="l01427"></a>01427     <span class="keywordflow">else</span>
<a name="l01428"></a>01428         max_samples = 1;
<a name="l01429"></a>01429     
<a name="l01430"></a>01430     <span class="keywordflow">while</span> (samples &lt; max_samples) {
<a name="l01431"></a>01431                 
<a name="l01432"></a>01432         <span class="keywordflow">if</span> (max_samples &gt; 1) {
<a name="l01433"></a>01433             <span class="comment">/* get a quasi-random vector from a phong-weighted disc */</span>
<a name="l01434"></a>01434             <a class="code" href="../../d6/d95/rayshade_8c.html#aa2be93f8dab434d2f04f72ca93dc8df3">QMC_samplePhong</a>(samp3d, qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samples, blur);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436             <span class="comment">/* find the normal&#39;s perpendicular plane, blurring along tangents</span>
<a name="l01437"></a>01437 <span class="comment">             * if tangent shading enabled */</span>
<a name="l01438"></a>01438             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>)) {
<a name="l01439"></a>01439                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(orthx, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);      <span class="comment">// bitangent</span>
<a name="l01440"></a>01440                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(orthy, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);
<a name="l01441"></a>01441                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthx, samp3d[0]);
<a name="l01442"></a>01442                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthy, samp3d[1]*aniso);
<a name="l01443"></a>01443             }
<a name="l01444"></a>01444             <span class="keywordflow">else</span> {
<a name="l01445"></a>01445                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>( orthx, orthy,shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01446"></a>01446                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthx, samp3d[0]);
<a name="l01447"></a>01447                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(orthy, samp3d[1]);
<a name="l01448"></a>01448             }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             <span class="comment">/* and perturb the normal in it */</span>
<a name="l01451"></a>01451             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(v_nor_new, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, orthx);
<a name="l01452"></a>01452             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v_nor_new, orthy);
<a name="l01453"></a>01453             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v_nor_new);
<a name="l01454"></a>01454         }
<a name="l01455"></a>01455         <span class="keywordflow">else</span> {
<a name="l01456"></a>01456             <span class="comment">/* no blurriness, use the original normal */</span>
<a name="l01457"></a>01457             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v_nor_new, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01458"></a>01458         }
<a name="l01459"></a>01459         
<a name="l01460"></a>01460         <span class="keywordflow">if</span> ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>)) 
<a name="l01461"></a>01461             <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>(v_reflect, v_nor_new, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>);
<a name="l01462"></a>01462         <span class="keywordflow">else</span>
<a name="l01463"></a>01463             <a class="code" href="../../d6/d95/rayshade_8c.html#a3b81040fd324c0ff4b109c1be29c04c9">reflection_simple</a>(v_reflect, v_nor_new, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l01464"></a>01464         
<a name="l01465"></a>01465         sampcol[0]= sampcol[1]= sampcol[2]= sampcol[3]= 0.0f;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467         <a class="code" href="../../d6/d95/rayshade_8c.html#add1a2b4d729163fc86d2589fb5f1a1aa">traceray</a>(shi, shr, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4087fa3af66c827a38ad6ed27d7970e8">ray_depth</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, v_reflect, sampcol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, 0);
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         
<a name="l01470"></a>01470         col[0] += sampcol[0];
<a name="l01471"></a>01471         col[1] += sampcol[1];
<a name="l01472"></a>01472         col[2] += sampcol[2];
<a name="l01473"></a>01473     
<a name="l01474"></a>01474         <span class="comment">/* for variance calc */</span>
<a name="l01475"></a>01475         colsq[0] += sampcol[0]*sampcol[0];
<a name="l01476"></a>01476         colsq[1] += sampcol[1]*sampcol[1];
<a name="l01477"></a>01477         colsq[2] += sampcol[2]*sampcol[2];
<a name="l01478"></a>01478         
<a name="l01479"></a>01479         samples++;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481         <span class="comment">/* adaptive sampling */</span>
<a name="l01482"></a>01482         <span class="keywordflow">if</span> (adapt_thresh &gt; 0.0f &amp;&amp; samples &gt; max_samples/3)
<a name="l01483"></a>01483         {
<a name="l01484"></a>01484             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a88e9acaf390f419894540cd17026824f">adaptive_sample_variance</a>(samples, col, colsq, adapt_thresh))
<a name="l01485"></a>01485                 <span class="keywordflow">break</span>;
<a name="l01486"></a>01486             
<a name="l01487"></a>01487             <span class="comment">/* if the pixel so far is very dark, we can get away with less samples */</span>
<a name="l01488"></a>01488             <span class="keywordflow">if</span> ( (col[0] + col[1] + col[2])/3.0f/(<span class="keywordtype">float</span>)samples &lt; 0.01f )
<a name="l01489"></a>01489                 max_samples--;
<a name="l01490"></a>01490         
<a name="l01491"></a>01491             <span class="comment">/* reduce samples when reflection is dim due to low ray mirror blend value or fresnel factor</span>
<a name="l01492"></a>01492 <span class="comment">             * and when reflection is blurry */</span>
<a name="l01493"></a>01493             <span class="keywordflow">if</span> (fresnelfac &lt; 0.1f * (blur+1)) {
<a name="l01494"></a>01494                 max_samples--;
<a name="l01495"></a>01495                 
<a name="l01496"></a>01496                 <span class="comment">/* even more for very dim */</span>
<a name="l01497"></a>01497                 <span class="keywordflow">if</span> (fresnelfac &lt; 0.05f * (blur+1))
<a name="l01498"></a>01498                     max_samples--;
<a name="l01499"></a>01499             }
<a name="l01500"></a>01500         }
<a name="l01501"></a>01501     }
<a name="l01502"></a>01502     
<a name="l01503"></a>01503     col[0] /= (float)samples;
<a name="l01504"></a>01504     col[1] /= (float)samples;
<a name="l01505"></a>01505     col[2] /= (float)samples;
<a name="l01506"></a>01506     
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (qsa)
<a name="l01508"></a>01508         <a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">release_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, qsa);
<a name="l01509"></a>01509 }
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 <span class="comment">/* extern call from render loop */</span>
<a name="l01512"></a><a class="code" href="../../d6/d95/rayshade_8c.html#aa8b6d3e085f7ab4760dccda0acad340f">01512</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#abfb7991797d22c16b5d143d2ee744098">ray_trace</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01513"></a>01513 {
<a name="l01514"></a>01514     <span class="keywordtype">float</span> f1, fr, fg, <a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>;
<a name="l01515"></a>01515     <span class="keywordtype">float</span> mircol[4], tracol[4];
<a name="l01516"></a>01516     <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>[3];
<a name="l01517"></a>01517     <span class="keywordtype">int</span> do_tra, do_mir;
<a name="l01518"></a>01518     
<a name="l01519"></a>01519     do_tra= ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2f301bfe492802b8461b969fc72b3652">MA_RAYTRANSP</a>) &amp;&amp; shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>!=1.0f &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> &lt;= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a27faa604328ed5ef1ff9855f5242a024">ray_depth_tra</a>));
<a name="l01520"></a>01520     do_mir= ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a726661eedc26b958c4cbfdef14dbca54">MA_RAYMIRROR</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>!=0.0f &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> &lt;= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4087fa3af66c827a38ad6ed27d7970e8">ray_depth</a>));
<a name="l01521"></a>01521     
<a name="l01522"></a>01522     <span class="comment">/* raytrace mirror and refract like to separate the spec color */</span>
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)
<a name="l01524"></a>01524         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(diff, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l01525"></a>01525     <span class="keywordflow">else</span>
<a name="l01526"></a>01526         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(diff, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l01527"></a>01527     
<a name="l01528"></a>01528     <span class="keywordflow">if</span> (do_tra) {
<a name="l01529"></a>01529         <span class="keywordtype">float</span> olddiff[3], f;
<a name="l01530"></a>01530         
<a name="l01531"></a>01531         <a class="code" href="../../d6/d95/rayshade_8c.html#a79e037cae60eb2570eeb6aa5bcb04441">trace_refract</a>(tracol, shi, shr);
<a name="l01532"></a>01532         
<a name="l01533"></a>01533         f= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>; f1= 1.0f-f;
<a name="l01534"></a>01534         fr= 1.0f+ shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>-1.0f);
<a name="l01535"></a>01535         fg= 1.0f+ shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>-1.0f);
<a name="l01536"></a>01536         fb= 1.0f+ shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>-1.0f);
<a name="l01537"></a>01537         
<a name="l01538"></a>01538         <span class="comment">/* for refract pass */</span>
<a name="l01539"></a>01539         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(olddiff, diff);
<a name="l01540"></a>01540         
<a name="l01541"></a>01541         diff[0]= f*diff[0] + f1*fr*tracol[0];
<a name="l01542"></a>01542         diff[1]= f*diff[1] + f1*fg*tracol[1];
<a name="l01543"></a>01543         diff[2]= f*diff[2] + f1*fb*tracol[2];
<a name="l01544"></a>01544         
<a name="l01545"></a>01545         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>)
<a name="l01546"></a>01546             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>, diff, olddiff);
<a name="l01547"></a>01547         
<a name="l01548"></a>01548         <span class="keywordflow">if</span> (!(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>))
<a name="l01549"></a>01549             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(diff, diff, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>);
<a name="l01550"></a>01550         
<a name="l01551"></a>01551         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(1.0f, tracol[3]);
<a name="l01552"></a>01552     }
<a name="l01553"></a>01553     
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (do_mir) {
<a name="l01555"></a>01555         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>*<a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8388776b83c1862f3aa946aa7d77b2c1">fresnel_mir_i</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af33839a470d13329493d8a28e68417d8">fresnel_mir</a>);
<a name="l01556"></a>01556         <span class="keywordflow">if</span> (i!=0.0f) {
<a name="l01557"></a>01557         
<a name="l01558"></a>01558             <a class="code" href="../../d6/d95/rayshade_8c.html#a1cd256766da2607dc7c4ada4fab30489">trace_reflect</a>(mircol, shi, shr, i);
<a name="l01559"></a>01559             
<a name="l01560"></a>01560             fr= i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>;
<a name="l01561"></a>01561             fg= i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a81bee106e6df70a3f16844ce36f84e1d">mirg</a>;
<a name="l01562"></a>01562             fb= i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8134198d223e10b503401a057c503f2a">mirb</a>;
<a name="l01563"></a>01563 
<a name="l01564"></a>01564             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>) {
<a name="l01565"></a>01565                 <span class="comment">/* mirror pass is not blocked out with spec */</span>
<a name="l01566"></a>01566                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>[0]= fr*mircol[0] - fr*diff[0];
<a name="l01567"></a>01567                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>[1]= fg*mircol[1] - fg*diff[1];
<a name="l01568"></a>01568                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>[2]= fb*mircol[2] - fb*diff[2];
<a name="l01569"></a>01569             }
<a name="l01570"></a>01570             
<a name="l01571"></a>01571             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>) {
<a name="l01572"></a>01572                 <span class="comment">/* values in shr-&gt;spec can be greater then 1.0.</span>
<a name="l01573"></a>01573 <span class="comment">                 * In this case the mircol uses a zero blending factor, so ignoring it is ok.</span>
<a name="l01574"></a>01574 <span class="comment">                 * Fixes bug #18837 - when the spec is higher then 1.0,</span>
<a name="l01575"></a>01575 <span class="comment">                 * diff can become a negative color - Campbell  */</span>
<a name="l01576"></a>01576                 
<a name="l01577"></a>01577                 f1= 1.0f-<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01578"></a>01578                 
<a name="l01579"></a>01579                 diff[0] *= f1;
<a name="l01580"></a>01580                 diff[1] *= f1;
<a name="l01581"></a>01581                 diff[2] *= f1;
<a name="l01582"></a>01582                 
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]&lt;1.0f)  diff[0] += mircol[0] * (fr*(1.0f-shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]));
<a name="l01584"></a>01584                 <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]&lt;1.0f)  diff[1] += mircol[1] * (fg*(1.0f-shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]));
<a name="l01585"></a>01585                 <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]&lt;1.0f)  diff[2] += mircol[2] * (fb*(1.0f-shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]));
<a name="l01586"></a>01586             }
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589     <span class="comment">/* put back together */</span>
<a name="l01590"></a>01590     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)
<a name="l01591"></a>01591         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, diff, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l01592"></a>01592     <span class="keywordflow">else</span>
<a name="l01593"></a>01593         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, diff);
<a name="l01594"></a>01594 }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 <span class="comment">/* color &#39;shadfac&#39; passes through &#39;col&#39; with alpha and filter */</span>
<a name="l01597"></a>01597 <span class="comment">/* filter is only applied on alpha defined transparent part */</span>
<a name="l01598"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a28319c733f93d8c230235bc712fc176c">01598</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a28319c733f93d8c230235bc712fc176c">addAlphaLight</a>(<span class="keywordtype">float</span> shadfac[4], <span class="keyword">const</span> <span class="keywordtype">float</span> col[3], <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>)
<a name="l01599"></a>01599 {
<a name="l01600"></a>01600     <span class="keywordtype">float</span> fr, fg, <a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>;
<a name="l01601"></a>01601     
<a name="l01602"></a>01602     fr= 1.0f+ filter*(col[0]-1.0f);
<a name="l01603"></a>01603     fg= 1.0f+ filter*(col[1]-1.0f);
<a name="l01604"></a>01604     fb= 1.0f+ filter*(col[2]-1.0f);
<a name="l01605"></a>01605     
<a name="l01606"></a>01606     shadfac[0]= alpha*col[0] + fr*(1.0f-alpha)*shadfac[0];
<a name="l01607"></a>01607     shadfac[1]= alpha*col[1] + fg*(1.0f-alpha)*shadfac[1];
<a name="l01608"></a>01608     shadfac[2]= alpha*col[2] + fb*(1.0f-alpha)*shadfac[2];
<a name="l01609"></a>01609     
<a name="l01610"></a>01610     shadfac[3]= (1.0f-alpha)*shadfac[3];
<a name="l01611"></a>01611 }
<a name="l01612"></a>01612 
<a name="l01613"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">01613</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">ray_trace_shadow_tra</a>(<a class="code" href="../../d8/d95/structIsect.html">Isect</a> *is, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *origshi, <span class="keywordtype">int</span> depth, <span class="keywordtype">int</span> traflag, <span class="keywordtype">float</span> col[4])
<a name="l01614"></a>01614 {
<a name="l01615"></a>01615     <span class="comment">/* ray to lamp, find first face that intersects, check alpha properties,</span>
<a name="l01616"></a>01616 <span class="comment">     * if it has col[3]&gt;0.0f  continue. so exit when alpha is full */</span>
<a name="l01617"></a>01617     <span class="keyword">const</span> <span class="keywordtype">float</span> initial_dist = is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, is)) {
<a name="l01620"></a>01620         <span class="comment">/* Warning regarding initializing to zero&#39;s, This is not that nice,</span>
<a name="l01621"></a>01621 <span class="comment">         * and possibly a bit slow for every ray, however some variables were</span>
<a name="l01622"></a>01622 <span class="comment">         * not initialized properly in, unless using</span>
<a name="l01623"></a>01623 <span class="comment">         * shade_input_initialize(...), we need to zero them. */</span>
<a name="l01624"></a>01624         <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01625"></a>01625         <span class="comment">/* end warning! - Campbell */</span>
<a name="l01626"></a>01626 
<a name="l01627"></a>01627         <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> shr;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629         <span class="comment">/* we got a face */</span>
<a name="l01630"></a>01630 
<a name="l01631"></a>01631         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> + 1;                  <span class="comment">/* only used to indicate tracing */</span>
<a name="l01632"></a>01632         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>;
<a name="l01633"></a>01633         shi.<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>;
<a name="l01634"></a>01634         shi.<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>;
<a name="l01635"></a>01635         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a>= 0xFFFFFF;      <span class="comment">/* ray trace does all options */</span>
<a name="l01636"></a>01636     
<a name="l01637"></a>01637         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>;
<a name="l01638"></a>01638         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>;
<a name="l01639"></a>01639         shi.<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>;
<a name="l01640"></a>01640         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a8f5a9004589299231ca449ba3ba28c8a">nodes</a>= origshi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8f5a9004589299231ca449ba3ba28c8a">nodes</a>;
<a name="l01641"></a>01641         
<a name="l01642"></a>01642         <a class="code" href="../../da/d3d/shading_8h.html#ab59a098c8396fbdc601f63c8efa206db">shade_ray</a>(is, &amp;shi, &amp;shr);
<a name="l01643"></a>01643         <span class="keywordflow">if</span> (shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>) {
<a name="l01644"></a>01644             <span class="keyword">const</span> <span class="keywordtype">float</span> d= (traflag &amp; <a class="code" href="../../d6/d95/rayshade_8c.html#a2294e9119a21dc5e1eb223a86f6c788d">RAY_TRA</a>) ?
<a name="l01645"></a>01645                         <a class="code" href="../../d6/d95/rayshade_8c.html#a6e1e020cfc11a89a711681d608c4c296">shade_by_transmission</a>(is, &amp;shi, &amp;shr) :
<a name="l01646"></a>01646                         1.0f;
<a name="l01647"></a>01647             <span class="comment">/* mix colors based on shadfac (rgb + amount of light factor) */</span>
<a name="l01648"></a>01648             <a class="code" href="../../d6/d95/rayshade_8c.html#a28319c733f93d8c230235bc712fc176c">addAlphaLight</a>(col, shr.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>, d*shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>);
<a name="l01649"></a>01649         }
<a name="l01650"></a>01650         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>) {
<a name="l01651"></a>01651             <span class="keyword">const</span> <span class="keywordtype">float</span> a = col[3];
<a name="l01652"></a>01652             
<a name="l01653"></a>01653             col[0] = a*col[0] + shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>*shr.<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0];
<a name="l01654"></a>01654             col[1] = a*col[1] + shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>*shr.<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1];
<a name="l01655"></a>01655             col[2] = a*col[2] + shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>*shr.<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2];
<a name="l01656"></a>01656             
<a name="l01657"></a>01657             col[3] = (1.0f - shr.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>)*a;
<a name="l01658"></a>01658         }
<a name="l01659"></a>01659         
<a name="l01660"></a>01660         <span class="keywordflow">if</span> (depth&gt;0 &amp;&amp; col[3]&gt;0.0f) {
<a name="l01661"></a>01661             
<a name="l01662"></a>01662             <span class="comment">/* adapt isect struct */</span>
<a name="l01663"></a>01663             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l01664"></a>01664             is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = initial_dist-is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>;
<a name="l01665"></a>01665             is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi.<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l01666"></a>01666             is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi.<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668             <a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">ray_trace_shadow_tra</a>(is, origshi, depth-1, traflag | <a class="code" href="../../d6/d95/rayshade_8c.html#a2294e9119a21dc5e1eb223a86f6c788d">RAY_TRA</a>, col);
<a name="l01669"></a>01669         }
<a name="l01670"></a>01670         
<a name="l01671"></a>01671         <a class="code" href="../../d9/dd4/raycounter_8h.html#a78a1894a09cfe0cd742dbfd2347a2ff7">RE_RC_MERGE</a>(&amp;origshi-&gt;raycounter, &amp;shi.raycounter);
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675 <span class="comment">/* not used, test function for ambient occlusion (yaf: pathlight) */</span>
<a name="l01676"></a>01676 <span class="comment">/* main problem; has to be called within shading loop, giving unwanted recursion */</span>
<a name="l01677"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a783dfde39a5437ba36662dae698085d6">01677</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a26aa3564d15ae9e56cce569a324df5da">UNUSED_FUNCTION</a>(<a class="code" href="../../d6/d95/rayshade_8c.html#a783dfde39a5437ba36662dae698085d6">ray_trace_shadow_rad</a>)(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *ship, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01678"></a>01678 {
<a name="l01679"></a>01679     <span class="keyword">static</span> <span class="keywordtype">int</span> counter=0, only_one= 0;
<a name="l01680"></a>01680     <span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#a5d12acc6336a883bfc361172c3f5752c">hashvectf</a>[];
<a name="l01681"></a>01681     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l01682"></a>01682     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi;
<a name="l01683"></a>01683     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> shr_t;
<a name="l01684"></a>01684     <span class="keywordtype">float</span> vec[3], accum[3], <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>= 0.0f;
<a name="l01685"></a>01685     <span class="keywordtype">int</span> a;
<a name="l01686"></a>01686     
<a name="l01687"></a>01687     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(0);
<a name="l01688"></a>01688     
<a name="l01689"></a>01689     <span class="keywordflow">if</span> (only_one) {
<a name="l01690"></a>01690         <span class="keywordflow">return</span> 0;
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692     only_one= 1;
<a name="l01693"></a>01693     
<a name="l01694"></a>01694     accum[0]= accum[1]= accum[2]= 0.0f;
<a name="l01695"></a>01695     isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#acb514bfd8ddb54e2e79a06ea36f9a5e5">RE_RAY_MIRROR</a>;
<a name="l01696"></a>01696     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = ship-&gt;obi;
<a name="l01697"></a>01697     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = ship-&gt;vlr;
<a name="l01698"></a>01698     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l01699"></a>01699 
<a name="l01700"></a>01700     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, ship-&gt;co);
<a name="l01701"></a>01701     
<a name="l01702"></a>01702     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, shi);
<a name="l01703"></a>01703     
<a name="l01704"></a>01704     <span class="keywordflow">for</span> (a=0; a&lt;8*8; a++) {
<a name="l01705"></a>01705         
<a name="l01706"></a>01706         counter+=3;
<a name="l01707"></a>01707         counter %= 768;
<a name="l01708"></a>01708         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, hashvectf+counter);
<a name="l01709"></a>01709         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ship-&gt;vn, vec) &gt; 0.0f) {
<a name="l01710"></a>01710             vec[0]-= vec[0];
<a name="l01711"></a>01711             vec[1]-= vec[1];
<a name="l01712"></a>01712             vec[2]-= vec[2];
<a name="l01713"></a>01713         }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, vec );
<a name="l01716"></a>01716         isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1c7e702ee03215ce362608ca9032956e">RE_RAYTRACE_MAXDIST</a>;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec)) {
<a name="l01719"></a>01719             <span class="keywordtype">float</span> fac;
<a name="l01720"></a>01720             
<a name="l01721"></a>01721             <span class="comment">/* Warning, This is not that nice, and possibly a bit slow for every ray,</span>
<a name="l01722"></a>01722 <span class="comment">             * however some variables were not initialized properly in, unless using shade_input_initialize(...), we need to do a memset */</span>
<a name="l01723"></a>01723             memset(&amp;shi, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a>)); 
<a name="l01724"></a>01724             <span class="comment">/* end warning! - Campbell */</span>
<a name="l01725"></a>01725             
<a name="l01726"></a>01726             <a class="code" href="../../da/d3d/shading_8h.html#ab59a098c8396fbdc601f63c8efa206db">shade_ray</a>(&amp;isec, &amp;shi, &amp;shr_t);
<a name="l01727"></a>01727             <span class="comment">/* fac= isec.dist*isec.dist; */</span>
<a name="l01728"></a>01728             fac= 1.0f;
<a name="l01729"></a>01729             accum[0]+= fac*(shr_t.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]+shr_t.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]);
<a name="l01730"></a>01730             accum[1]+= fac*(shr_t.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]+shr_t.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]);
<a name="l01731"></a>01731             accum[2]+= fac*(shr_t.<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]+shr_t.<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]);
<a name="l01732"></a>01732             div+= fac;
<a name="l01733"></a>01733         }
<a name="l01734"></a>01734         <span class="keywordflow">else</span> div+= 1.0f;
<a name="l01735"></a>01735     }
<a name="l01736"></a>01736     
<a name="l01737"></a>01737     <span class="keywordflow">if</span> (div!=0.0f) {
<a name="l01738"></a>01738         shr-&gt;diff[0]+= accum[0]/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l01739"></a>01739         shr-&gt;diff[1]+= accum[1]/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l01740"></a>01740         shr-&gt;diff[2]+= accum[2]/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l01741"></a>01741     }
<a name="l01742"></a>01742     shr-&gt;alpha= 1.0f;
<a name="l01743"></a>01743     
<a name="l01744"></a>01744     only_one= 0;
<a name="l01745"></a>01745     <span class="keywordflow">return</span> 1;
<a name="l01746"></a>01746 }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748 <span class="comment">/* aolight: function to create random unit sphere vectors for total random sampling */</span>
<a name="l01749"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a91c5502726a8f643cbd105299a71ded4">01749</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a91c5502726a8f643cbd105299a71ded4">RandomSpherical</a>(<span class="keywordtype">float</span> v[3])
<a name="l01750"></a>01750 {
<a name="l01751"></a>01751     <span class="keywordtype">float</span> r;
<a name="l01752"></a>01752     v[2] = 2.f*<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-1.f;
<a name="l01753"></a>01753     <span class="keywordflow">if</span> ((r = 1.f - v[2]*v[2])&gt;0.f) {
<a name="l01754"></a>01754         <span class="keywordtype">float</span> a = 6.283185307f*<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>();
<a name="l01755"></a>01755         r = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(r);
<a name="l01756"></a>01756         v[0] = r * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(a);
<a name="l01757"></a>01757         v[1] = r * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(a);
<a name="l01758"></a>01758     }
<a name="l01759"></a>01759     <span class="keywordflow">else</span> v[2] = 1.f;
<a name="l01760"></a>01760 }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="comment">/* calc distributed spherical energy */</span>
<a name="l01763"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a9317a2596cd01ca315c806805706c11e">01763</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a9317a2596cd01ca315c806805706c11e">DS_energy</a>(<span class="keywordtype">float</span> *sphere, <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>, <span class="keywordtype">float</span> vec[3])
<a name="l01764"></a>01764 {
<a name="l01765"></a>01765     <span class="keywordtype">float</span> *fp, fac, force[3], res[3];
<a name="l01766"></a>01766     <span class="keywordtype">int</span> a;
<a name="l01767"></a>01767     
<a name="l01768"></a>01768     res[0]= res[1]= res[2]= 0.0f;
<a name="l01769"></a>01769     
<a name="l01770"></a>01770     <span class="keywordflow">for</span> (a=0, fp=sphere; a&lt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>; a++, fp+=3) {
<a name="l01771"></a>01771         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(force, vec, fp);
<a name="l01772"></a>01772         fac = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(force, force);
<a name="l01773"></a>01773         <span class="keywordflow">if</span> (fac!=0.0f) {
<a name="l01774"></a>01774             fac= 1.0f/fac;
<a name="l01775"></a>01775             res[0]+= fac*force[0];
<a name="l01776"></a>01776             res[1]+= fac*force[1];
<a name="l01777"></a>01777             res[2]+= fac*force[2];
<a name="l01778"></a>01778         }
<a name="l01779"></a>01779     }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(res, 0.5);
<a name="l01782"></a>01782     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, res);
<a name="l01783"></a>01783     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l01784"></a>01784     
<a name="l01785"></a>01785 }
<a name="l01786"></a>01786 
<a name="l01787"></a>01787 <span class="comment">/* called from convertBlenderScene.c */</span>
<a name="l01788"></a>01788 <span class="comment">/* creates an equally distributed spherical sample pattern */</span>
<a name="l01789"></a>01789 <span class="comment">/* and allocates threadsafe memory */</span>
<a name="l01790"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a85762026f5be5bbc9a7556c64800b69d">01790</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#addbfc82578dc6fdc226e5941647214a5">init_ao_sphere</a>(<a class="code" href="../../d7/d3f/structWorld.html">World</a> *wrld)
<a name="l01791"></a>01791 {
<a name="l01792"></a>01792     <span class="keywordtype">float</span> *fp;
<a name="l01793"></a>01793     <span class="keywordtype">int</span> a, <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>, iter= 16;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795     <span class="comment">/* we make twice the amount of samples, because only a hemisphere is used */</span>
<a name="l01796"></a>01796     tot= 2*wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a055acb019560e974d4f42928edbbbb3e">aosamp</a>*wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a055acb019560e974d4f42928edbbbb3e">aosamp</a>;
<a name="l01797"></a>01797     
<a name="l01798"></a>01798     wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(3*tot*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;AO sphere&quot;</span>);
<a name="l01799"></a>01799     
<a name="l01800"></a>01800     <span class="comment">/* fixed random */</span>
<a name="l01801"></a>01801     <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(tot);
<a name="l01802"></a>01802     
<a name="l01803"></a>01803     <span class="comment">/* init */</span>
<a name="l01804"></a>01804     fp= wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>;
<a name="l01805"></a>01805     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>; a++, fp+= 3) {
<a name="l01806"></a>01806         <a class="code" href="../../d6/d95/rayshade_8c.html#a91c5502726a8f643cbd105299a71ded4">RandomSpherical</a>(fp);
<a name="l01807"></a>01807     }
<a name="l01808"></a>01808     
<a name="l01809"></a>01809     <span class="keywordflow">while</span> (iter--) {
<a name="l01810"></a>01810         <span class="keywordflow">for</span> (a=0, fp= wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>; a&lt;tot; a++, fp+= 3) {
<a name="l01811"></a>01811             <a class="code" href="../../d6/d95/rayshade_8c.html#a9317a2596cd01ca315c806805706c11e">DS_energy</a>(wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>, tot, fp);
<a name="l01812"></a>01812         }
<a name="l01813"></a>01813     }
<a name="l01814"></a>01814     
<a name="l01815"></a>01815     <span class="comment">/* tables */</span>
<a name="l01816"></a>01816     wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#acedba6a8263913d2e7662b0b430a36f3">aotables</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>*3*tot*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;AO tables&quot;</span>);
<a name="l01817"></a>01817 }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 <span class="comment">/* give per thread a table, we have to compare xs ys because of way OSA works... */</span>
<a name="l01820"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ac8309d9f485899e2b4bfca1babe2f77b">01820</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d6/d95/rayshade_8c.html#ac8309d9f485899e2b4bfca1babe2f77b">threadsafe_table_sphere</a>(<span class="keywordtype">int</span> test, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>)
<a name="l01821"></a>01821 {
<a name="l01822"></a>01822     <span class="keyword">static</span> <span class="keywordtype">int</span> xso[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>], yso[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l01823"></a>01823     <span class="keyword">static</span> <span class="keywordtype">int</span> firsttime= 1;
<a name="l01824"></a>01824     
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (firsttime) {
<a name="l01826"></a>01826         memset(xso, 255, <span class="keyword">sizeof</span>(xso));
<a name="l01827"></a>01827         memset(yso, 255, <span class="keyword">sizeof</span>(yso));
<a name="l01828"></a>01828         firsttime= 0;
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830     
<a name="l01831"></a>01831     <span class="keywordflow">if</span> (xs==xso[thread] &amp;&amp; ys==yso[thread]) <span class="keywordflow">return</span> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aotables+ thread*tot*3;
<a name="l01832"></a>01832     <span class="keywordflow">if</span> (test) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01833"></a>01833     xso[thread]= xs; yso[thread]= ys;
<a name="l01834"></a>01834     <span class="keywordflow">return</span> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aotables+ thread*tot*3;
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ab9ef45ac7884ab632efd9c3ccda0346d">01837</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d6/d95/rayshade_8c.html#ab9ef45ac7884ab632efd9c3ccda0346d">sphere_sampler</a>(<span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a>, <span class="keywordtype">int</span> resol, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> reset)
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839     <span class="keywordtype">int</span> <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>;
<a name="l01840"></a>01840     <span class="keywordtype">float</span> *vec;
<a name="l01841"></a>01841     
<a name="l01842"></a>01842     tot= 2*resol*resol;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844     <span class="keywordflow">if</span> (type &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a214a6061c63aabc0943deef1c5443b45">WO_AORNDSMP</a>) {
<a name="l01845"></a>01845         <span class="keywordtype">float</span> *sphere;
<a name="l01846"></a>01846         <span class="keywordtype">int</span> a;
<a name="l01847"></a>01847         
<a name="l01848"></a>01848         <span class="comment">// always returns table</span>
<a name="l01849"></a>01849         sphere= <a class="code" href="../../d6/d95/rayshade_8c.html#ac8309d9f485899e2b4bfca1babe2f77b">threadsafe_table_sphere</a>(0, thread, xs, ys, tot);
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         <span class="comment">/* total random sampling. NOT THREADSAFE! (should be removed, is not useful) */</span>
<a name="l01852"></a>01852         vec= sphere;
<a name="l01853"></a>01853         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>; a++, vec+=3) {
<a name="l01854"></a>01854             <a class="code" href="../../d6/d95/rayshade_8c.html#a91c5502726a8f643cbd105299a71ded4">RandomSpherical</a>(vec);
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856         
<a name="l01857"></a>01857         <span class="keywordflow">return</span> sphere;
<a name="l01858"></a>01858     } 
<a name="l01859"></a>01859     <span class="keywordflow">else</span> {
<a name="l01860"></a>01860         <span class="keywordtype">float</span> *sphere;
<a name="l01861"></a>01861         <span class="keywordtype">float</span> *vec1;
<a name="l01862"></a>01862         
<a name="l01863"></a>01863         <span class="comment">// returns table if xs and ys were equal to last call, and not resetting</span>
<a name="l01864"></a>01864         sphere= (reset)? <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>: <a class="code" href="../../d6/d95/rayshade_8c.html#ac8309d9f485899e2b4bfca1babe2f77b">threadsafe_table_sphere</a>(1, thread, xs, ys, tot);
<a name="l01865"></a>01865         <span class="keywordflow">if</span> (sphere==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01866"></a>01866             <span class="keywordtype">float</span> cosfi, sinfi, cost, sint;
<a name="l01867"></a>01867             <span class="keywordtype">float</span> ang;
<a name="l01868"></a>01868             <span class="keywordtype">int</span> a;
<a name="l01869"></a>01869 
<a name="l01870"></a>01870             sphere= <a class="code" href="../../d6/d95/rayshade_8c.html#ac8309d9f485899e2b4bfca1babe2f77b">threadsafe_table_sphere</a>(0, thread, xs, ys, tot);
<a name="l01871"></a>01871             
<a name="l01872"></a>01872             <span class="comment">// random rotation</span>
<a name="l01873"></a>01873             ang= <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01874"></a>01874             sinfi= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(ang); cosfi= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(ang);
<a name="l01875"></a>01875             ang= <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(thread);
<a name="l01876"></a>01876             sint= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(ang); cost= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(ang);
<a name="l01877"></a>01877             
<a name="l01878"></a>01878             vec= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosphere;
<a name="l01879"></a>01879             vec1= sphere;
<a name="l01880"></a>01880             <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>; a++, vec+=3, vec1+=3) {
<a name="l01881"></a>01881                 vec1[0]= cost*cosfi*vec[0] - sinfi*vec[1] + sint*cosfi*vec[2];
<a name="l01882"></a>01882                 vec1[1]= cost*sinfi*vec[0] + cosfi*vec[1] + sint*sinfi*vec[2];
<a name="l01883"></a>01883                 vec1[2]= -sint*vec[0] + cost*vec[2];            
<a name="l01884"></a>01884             }
<a name="l01885"></a>01885         }
<a name="l01886"></a>01886         <span class="keywordflow">return</span> sphere;
<a name="l01887"></a>01887     }
<a name="l01888"></a>01888 }
<a name="l01889"></a>01889 
<a name="l01890"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a781edee2274eb901321cae01edbb8b4d">01890</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a781edee2274eb901321cae01edbb8b4d">ray_ao_qmc</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> ao[3], <span class="keywordtype">float</span> env[3])
<a name="l01891"></a>01891 {
<a name="l01892"></a>01892     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l01893"></a>01893     <a class="code" href="../../d0/d57/structRayHint.html">RayHint</a> point_hint;
<a name="l01894"></a>01894     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01895"></a>01895     <span class="keywordtype">float</span> samp3d[3];
<a name="l01896"></a>01896     <span class="keywordtype">float</span> up[3], side[3], dir[3], nrm[3];
<a name="l01897"></a>01897     
<a name="l01898"></a>01898     <span class="keywordtype">float</span> maxdist = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aodist;
<a name="l01899"></a>01899     <span class="keywordtype">float</span> fac=0.0f, <a class="code" href="../../d2/dce/structQMCSampler.html#a1b5f5018818ec6be0f4478d306260ffb">prev</a>=0.0f;
<a name="l01900"></a>01900     <span class="keywordtype">float</span> adapt_thresh = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_adapt_thresh;
<a name="l01901"></a>01901     <span class="keywordtype">float</span> adapt_speed_fac = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_adapt_speed_fac;
<a name="l01902"></a>01902     
<a name="l01903"></a>01903     <span class="keywordtype">int</span> samples=0;
<a name="l01904"></a>01904     <span class="keywordtype">int</span> max_samples = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosamp*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosamp;
<a name="l01905"></a>01905     
<a name="l01906"></a>01906     <span class="keywordtype">float</span> dxyview[3], skyadded=0;
<a name="l01907"></a>01907     <span class="keywordtype">int</span> envcolor;
<a name="l01908"></a>01908     
<a name="l01909"></a>01909     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, *shi);
<a name="l01910"></a>01910     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l01911"></a>01911     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l01912"></a>01912     isec.<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1156926d2730a1018c3bd3cda8d539b6">RE_CHECK_VLR_NON_SOLID_MATERIAL</a>;
<a name="l01913"></a>01913     isec.<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l01914"></a>01914     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916     isec.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = 0;
<a name="l01917"></a>01917     isec.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = 0;
<a name="l01918"></a>01918 
<a name="l01919"></a>01919     isec.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01920"></a>01920     
<a name="l01921"></a>01921     isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#af9df71003fc7bf243ade0852c76fec5b">WO_AODIST</a>)?<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>:<a class="code" href="../../d1/d1b/rayintersection_8h.html#acd1dd533a06af58d2e9269daf63f8ac9">RE_RAY_SHADOW</a>;
<a name="l01922"></a>01922     isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l01923"></a>01923     
<a name="l01924"></a>01924     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l01925"></a>01925     <a class="code" href="../../d8/d42/rayobject_8h.html#a18cbef867f739a79dc773536fea93efe">RE_rayobject_hint_bb</a>( <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;point_hint, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a> );
<a name="l01926"></a>01926     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = &amp;point_hint;
<a name="l01927"></a>01927 
<a name="l01928"></a>01928     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(ao);
<a name="l01929"></a>01929     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(env);
<a name="l01930"></a>01930     
<a name="l01931"></a>01931     <span class="comment">/* prevent sky colors to be added for only shadow (shadow becomes alpha) */</span>
<a name="l01932"></a>01932     envcolor= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aocolor;
<a name="l01933"></a>01933     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acbcd1a76590cdcea3e105151927ec33d">MA_ONLYSHADOW</a>)
<a name="l01934"></a>01934         envcolor= <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a>;
<a name="l01935"></a>01935     
<a name="l01936"></a>01936     <span class="keywordflow">if</span> (envcolor == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a3399876ee52643e8a0b29e174a3d15be">WO_AOSKYTEX</a>) {
<a name="l01937"></a>01937         dxyview[0]= 1.0f/(float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosamp;
<a name="l01938"></a>01938         dxyview[1]= 1.0f/(<span class="keywordtype">float</span>)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosamp;
<a name="l01939"></a>01939         dxyview[2]= 0.0f;
<a name="l01940"></a>01940     }
<a name="l01941"></a>01941     
<a name="l01942"></a>01942     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>) {
<a name="l01943"></a>01943         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nrm, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01944"></a>01944     }
<a name="l01945"></a>01945     <span class="keywordflow">else</span> {
<a name="l01946"></a>01946         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nrm, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>);
<a name="l01947"></a>01947     }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>( up, side,nrm);
<a name="l01950"></a>01950     
<a name="l01951"></a>01951     <span class="comment">/* sampling init */</span>
<a name="l01952"></a>01952     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_samp_method==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a641afffba7f44ecff4222d517b3fa581">WO_AOSAMP_HALTON</a>) {
<a name="l01953"></a>01953         <span class="keywordtype">float</span> speedfac;
<a name="l01954"></a>01954         
<a name="l01955"></a>01955         speedfac = <a class="code" href="../../d6/d95/rayshade_8c.html#ae11fc660cb3cbb42aa04593de60cef7d">get_avg_speed</a>(shi) * adapt_speed_fac;
<a name="l01956"></a>01956         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(speedfac, 1.0f, 1000.0f);
<a name="l01957"></a>01957         max_samples /= speedfac;
<a name="l01958"></a>01958         <span class="keywordflow">if</span> (max_samples &lt; 5) max_samples = 5;
<a name="l01959"></a>01959         
<a name="l01960"></a>01960         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, <a class="code" href="../../db/d00/render__types_8h.html#ab6cd5e11cb2b9f0cc66230c92821d920">SAMP_TYPE_HALTON</a>, max_samples);
<a name="l01961"></a>01961     }
<a name="l01962"></a>01962     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_samp_method==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac09953c22c2936605a365894fcf8ff46">WO_AOSAMP_HAMMERSLEY</a>)
<a name="l01963"></a>01963         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, <a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>, max_samples);
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">QMC_initPixel</a>(qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l01966"></a>01966     
<a name="l01967"></a>01967     <span class="keywordflow">while</span> (samples &lt; max_samples) {
<a name="l01968"></a>01968 
<a name="l01969"></a>01969         <span class="comment">/* sampling, returns quasi-random vector in unit hemisphere */</span>
<a name="l01970"></a>01970         <a class="code" href="../../d6/d95/rayshade_8c.html#a27d560f0dc4d9f4f6b4c5ff929da46e9">QMC_sampleHemi</a>(samp3d, qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samples);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972         dir[0] = (samp3d[0]*up[0] + samp3d[1]*side[0] + samp3d[2]*nrm[0]);
<a name="l01973"></a>01973         dir[1] = (samp3d[0]*up[1] + samp3d[1]*side[1] + samp3d[2]*nrm[1]);
<a name="l01974"></a>01974         dir[2] = (samp3d[0]*up[2] + samp3d[1]*side[2] + samp3d[2]*nrm[2]);
<a name="l01975"></a>01975         
<a name="l01976"></a>01976         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dir);
<a name="l01977"></a>01977             
<a name="l01978"></a>01978         isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0] = -dir[0];
<a name="l01979"></a>01979         isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1] = -dir[1];
<a name="l01980"></a>01980         isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2] = -dir[2];
<a name="l01981"></a>01981         isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = maxdist;
<a name="l01982"></a>01982         
<a name="l01983"></a>01983         <a class="code" href="../../d2/dce/structQMCSampler.html#a1b5f5018818ec6be0f4478d306260ffb">prev</a> = fac;
<a name="l01984"></a>01984         
<a name="l01985"></a>01985         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec)) {
<a name="l01986"></a>01986             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#af9df71003fc7bf243ade0852c76fec5b">WO_AODIST</a>) fac+= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aodistfac);
<a name="l01987"></a>01987             <span class="keywordflow">else</span> fac+= 1.0f;
<a name="l01988"></a>01988         }
<a name="l01989"></a>01989         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (envcolor!=<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a>) {
<a name="l01990"></a>01990             <span class="keywordtype">float</span> skycol[4];
<a name="l01991"></a>01991             <span class="keywordtype">float</span> view[3];
<a name="l01992"></a>01992             
<a name="l01993"></a>01993             view[0]= -dir[0];
<a name="l01994"></a>01994             view[1]= -dir[1];
<a name="l01995"></a>01995             view[2]= -dir[2];
<a name="l01996"></a>01996             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l01997"></a>01997             
<a name="l01998"></a>01998             <span class="keywordflow">if</span> (envcolor==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a028c847b8a3dcf8459e74f92ddc57da7">WO_AOSKYCOL</a>) {
<a name="l01999"></a>01999                 <span class="keyword">const</span> <span class="keywordtype">float</span> skyfac= 0.5f * (1.0f + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.grvec));
<a name="l02000"></a>02000                 env[0]+= (1.0f-skyfac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr + skyfac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenr;
<a name="l02001"></a>02001                 env[1]+= (1.0f-skyfac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horg + skyfac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zeng;
<a name="l02002"></a>02002                 env[2]+= (1.0f-skyfac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horb + skyfac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenb;
<a name="l02003"></a>02003             }
<a name="l02004"></a>02004             <span class="keywordflow">else</span> {  <span class="comment">/* WO_AOSKYTEX */</span>
<a name="l02005"></a>02005                 <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(skycol, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, view, dxyview, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l02006"></a>02006                 <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(skycol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l02007"></a>02007                 env[0]+= skycol[0];
<a name="l02008"></a>02008                 env[1]+= skycol[1];
<a name="l02009"></a>02009                 env[2]+= skycol[2];
<a name="l02010"></a>02010             }
<a name="l02011"></a>02011             skyadded++;
<a name="l02012"></a>02012         }
<a name="l02013"></a>02013         
<a name="l02014"></a>02014         samples++;
<a name="l02015"></a>02015         
<a name="l02016"></a>02016         <span class="keywordflow">if</span> (qsa &amp;&amp; qsa-&gt;<a class="code" href="../../d2/dce/structQMCSampler.html#a45fdd9c90fb2a0d146591a49d1b06baa">type</a> == <a class="code" href="../../db/d00/render__types_8h.html#ab6cd5e11cb2b9f0cc66230c92821d920">SAMP_TYPE_HALTON</a>) {
<a name="l02017"></a>02017             <span class="comment">/* adaptive sampling - consider samples below threshold as in shadow (or vice versa) and exit early */</span>      
<a name="l02018"></a>02018             <span class="keywordflow">if</span> (adapt_thresh &gt; 0.0f &amp;&amp; (samples &gt; max_samples/2) ) {
<a name="l02019"></a>02019                 
<a name="l02020"></a>02020                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a02f39d584523743064bcbedba7ac9e14">adaptive_sample_contrast_val</a>(samples, <a class="code" href="../../d2/dce/structQMCSampler.html#a1b5f5018818ec6be0f4478d306260ffb">prev</a>, fac, adapt_thresh)) {
<a name="l02021"></a>02021                     <span class="keywordflow">break</span>;
<a name="l02022"></a>02022                 }
<a name="l02023"></a>02023             }
<a name="l02024"></a>02024         }
<a name="l02025"></a>02025     }
<a name="l02026"></a>02026     
<a name="l02027"></a>02027     <span class="comment">/* average color times distances/hits formula */</span>
<a name="l02028"></a>02028     ao[0]= ao[1]= ao[2]= 1.0f - fac/(float)samples;
<a name="l02029"></a>02029 
<a name="l02030"></a>02030     <span class="keywordflow">if</span> (envcolor!=<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a> &amp;&amp; skyadded)
<a name="l02031"></a>02031         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(env, (1.0f - fac/(<span class="keywordtype">float</span>)samples)/((<span class="keywordtype">float</span>)skyadded));
<a name="l02032"></a>02032     <span class="keywordflow">else</span>
<a name="l02033"></a>02033         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(env, ao);
<a name="l02034"></a>02034     
<a name="l02035"></a>02035     <span class="keywordflow">if</span> (qsa)
<a name="l02036"></a>02036         <a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">release_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, qsa);
<a name="l02037"></a>02037 }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039 <span class="comment">/* extern call from shade_lamp_loop, ambient occlusion calculus */</span>
<a name="l02040"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a36e7880ee5a1db0e416974aa441f6fac">02040</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a36e7880ee5a1db0e416974aa441f6fac">ray_ao_spheresamp</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> ao[3], <span class="keywordtype">float</span> env[3])
<a name="l02041"></a>02041 {
<a name="l02042"></a>02042     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l02043"></a>02043     <a class="code" href="../../d0/d57/structRayHint.html">RayHint</a> point_hint;
<a name="l02044"></a>02044     <span class="keywordtype">float</span> *vec, *nrm, bias, sh=0.0f;
<a name="l02045"></a>02045     <span class="keywordtype">float</span> maxdist = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aodist;
<a name="l02046"></a>02046     <span class="keywordtype">float</span> dxyview[3];
<a name="l02047"></a>02047     <span class="keywordtype">int</span> j= -1, <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>, actual=0, skyadded=0, envcolor, resol= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aosamp;
<a name="l02048"></a>02048     
<a name="l02049"></a>02049     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, *shi);
<a name="l02050"></a>02050     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l02051"></a>02051     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l02052"></a>02052     isec.<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#ae5e08b683b8fa6d16d6ab3b435d7b362">RE_CHECK_VLR_RENDER</a>;
<a name="l02053"></a>02053     isec.<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l02054"></a>02054     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056     isec.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = 0;
<a name="l02057"></a>02057     isec.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = 0;
<a name="l02058"></a>02058     
<a name="l02059"></a>02059     isec.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02060"></a>02060     
<a name="l02061"></a>02061     isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#af9df71003fc7bf243ade0852c76fec5b">WO_AODIST</a>)?<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>:<a class="code" href="../../d1/d1b/rayintersection_8h.html#acd1dd533a06af58d2e9269daf63f8ac9">RE_RAY_SHADOW</a>;
<a name="l02062"></a>02062     isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02065"></a>02065     <a class="code" href="../../d8/d42/rayobject_8h.html#a18cbef867f739a79dc773536fea93efe">RE_rayobject_hint_bb</a>( <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;point_hint, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a> );
<a name="l02066"></a>02066     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = &amp;point_hint;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(ao);
<a name="l02069"></a>02069     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(env);
<a name="l02070"></a>02070 
<a name="l02071"></a>02071     <span class="comment">/* bias prevents smoothed faces to appear flat */</span>
<a name="l02072"></a>02072     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>) {
<a name="l02073"></a>02073         bias= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aobias;
<a name="l02074"></a>02074         nrm= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>;
<a name="l02075"></a>02075     }
<a name="l02076"></a>02076     <span class="keywordflow">else</span> {
<a name="l02077"></a>02077         bias= 0.0f;
<a name="l02078"></a>02078         nrm= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>;
<a name="l02079"></a>02079     }
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <span class="comment">/* prevent sky colors to be added for only shadow (shadow becomes alpha) */</span>
<a name="l02082"></a>02082     envcolor= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aocolor;
<a name="l02083"></a>02083     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acbcd1a76590cdcea3e105151927ec33d">MA_ONLYSHADOW</a>)
<a name="l02084"></a>02084         envcolor= <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a>;
<a name="l02085"></a>02085     
<a name="l02086"></a>02086     <span class="keywordflow">if</span> (resol&gt;32) resol= 32;
<a name="l02087"></a>02087 
<a name="l02088"></a>02088     <span class="comment">/* get sphere samples. for faces we get the same samples for sample x/y values,</span>
<a name="l02089"></a>02089 <span class="comment">     * for strand render we always require a new sampler because x/y are not set */</span>
<a name="l02090"></a>02090     vec= <a class="code" href="../../d6/d95/rayshade_8c.html#ab9ef45ac7884ab632efd9c3ccda0346d">sphere_sampler</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomode, resol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02091"></a>02091     
<a name="l02092"></a>02092     <span class="comment">// warning: since we use full sphere now, and dotproduct is below, we do twice as much</span>
<a name="l02093"></a>02093     <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>= 2*resol*resol;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095     <span class="keywordflow">if</span> (envcolor == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a3399876ee52643e8a0b29e174a3d15be">WO_AOSKYTEX</a>) {
<a name="l02096"></a>02096         dxyview[0]= 1.0f/(float)resol;
<a name="l02097"></a>02097         dxyview[1]= 1.0f/(float)resol;
<a name="l02098"></a>02098         dxyview[2]= 0.0f;
<a name="l02099"></a>02099     }
<a name="l02100"></a>02100     
<a name="l02101"></a>02101     <span class="keywordflow">while</span> (<a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>--) {
<a name="l02102"></a>02102         
<a name="l02103"></a>02103         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, nrm) &gt; bias) {
<a name="l02104"></a>02104             <span class="comment">/* only ao samples for mask */</span>
<a name="l02105"></a>02105             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2711a7abdf812fa0f1b16da25a7d6343">R_OSA</a>) {
<a name="l02106"></a>02106                 j++;
<a name="l02107"></a>02107                 <span class="keywordflow">if</span> (j==<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) j= 0;
<a name="l02108"></a>02108                 <span class="keywordflow">if</span> (!(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a> &amp; (1&lt;&lt;j))) {
<a name="l02109"></a>02109                     vec+=3;
<a name="l02110"></a>02110                     <span class="keywordflow">continue</span>;
<a name="l02111"></a>02111                 }
<a name="l02112"></a>02112             }
<a name="l02113"></a>02113             
<a name="l02114"></a>02114             actual++;
<a name="l02115"></a>02115             
<a name="l02116"></a>02116             <span class="comment">/* always set start/vec/dist */</span>
<a name="l02117"></a>02117             isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0] = -vec[0];
<a name="l02118"></a>02118             isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1] = -vec[1];
<a name="l02119"></a>02119             isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2] = -vec[2];
<a name="l02120"></a>02120             isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = maxdist;
<a name="l02121"></a>02121             
<a name="l02122"></a>02122             <span class="comment">/* do the trace */</span>
<a name="l02123"></a>02123             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec)) {
<a name="l02124"></a>02124                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#af9df71003fc7bf243ade0852c76fec5b">WO_AODIST</a>) sh+= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aodistfac);
<a name="l02125"></a>02125                 <span class="keywordflow">else</span> sh+= 1.0f;
<a name="l02126"></a>02126             }
<a name="l02127"></a>02127             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (envcolor!=<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a>) {
<a name="l02128"></a>02128                 <span class="keywordtype">float</span> skycol[4];
<a name="l02129"></a>02129                 <span class="keywordtype">float</span> view[3];
<a name="l02130"></a>02130                 
<a name="l02131"></a>02131                 view[0]= -vec[0];
<a name="l02132"></a>02132                 view[1]= -vec[1];
<a name="l02133"></a>02133                 view[2]= -vec[2];
<a name="l02134"></a>02134                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l02135"></a>02135                 
<a name="l02136"></a>02136                 <span class="keywordflow">if</span> (envcolor==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a028c847b8a3dcf8459e74f92ddc57da7">WO_AOSKYCOL</a>) {
<a name="l02137"></a>02137                     <span class="keyword">const</span> <span class="keywordtype">float</span> fac = 0.5f * (1.0f + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.grvec));
<a name="l02138"></a>02138                     env[0]+= (1.0f-fac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr + fac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenr;
<a name="l02139"></a>02139                     env[1]+= (1.0f-fac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horg + fac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zeng;
<a name="l02140"></a>02140                     env[2]+= (1.0f-fac)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horb + fac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenb;
<a name="l02141"></a>02141                 }
<a name="l02142"></a>02142                 <span class="keywordflow">else</span> {  <span class="comment">/* WO_AOSKYTEX */</span>
<a name="l02143"></a>02143                     <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(skycol, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, view, dxyview, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l02144"></a>02144                     <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(skycol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l02145"></a>02145                     env[0]+= skycol[0];
<a name="l02146"></a>02146                     env[1]+= skycol[1];
<a name="l02147"></a>02147                     env[2]+= skycol[2];
<a name="l02148"></a>02148                 }
<a name="l02149"></a>02149                 skyadded++;
<a name="l02150"></a>02150             }
<a name="l02151"></a>02151         }
<a name="l02152"></a>02152         <span class="comment">// samples</span>
<a name="l02153"></a>02153         vec+= 3;
<a name="l02154"></a>02154     }
<a name="l02155"></a>02155     
<a name="l02156"></a>02156     <span class="keywordflow">if</span> (actual==0) sh= 1.0f;
<a name="l02157"></a>02157     <span class="keywordflow">else</span> sh = 1.0f - sh/((float)actual);
<a name="l02158"></a>02158     
<a name="l02159"></a>02159     <span class="comment">/* average color times distances/hits formula */</span>
<a name="l02160"></a>02160     ao[0]= ao[1]= ao[2]= sh;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     <span class="keywordflow">if</span> (envcolor!=<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a> &amp;&amp; skyadded)
<a name="l02163"></a>02163         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(env, sh/((<span class="keywordtype">float</span>)skyadded));
<a name="l02164"></a>02164     <span class="keywordflow">else</span>
<a name="l02165"></a>02165         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(env, ao);
<a name="l02166"></a>02166 }
<a name="l02167"></a>02167 
<a name="l02168"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a6d2a73a5deda9d4e8ec466587ce5ccba">02168</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a6d2a73a5deda9d4e8ec466587ce5ccba">ray_ao</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> ao[3], <span class="keywordtype">float</span> env[3])
<a name="l02169"></a>02169 {
<a name="l02170"></a>02170     <span class="comment">/* Unfortunately, the unusual way that the sphere sampler calculates roughly twice as many</span>
<a name="l02171"></a>02171 <span class="comment">     * samples as are actually traced, and skips them based on bias and OSA settings makes it very difficult</span>
<a name="l02172"></a>02172 <span class="comment">     * to reuse code between these two functions. This is the easiest way I can think of to do it</span>
<a name="l02173"></a>02173 <span class="comment">     * --broken */</span>
<a name="l02174"></a>02174     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_samp_method, <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac09953c22c2936605a365894fcf8ff46">WO_AOSAMP_HAMMERSLEY</a>, <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a641afffba7f44ecff4222d517b3fa581">WO_AOSAMP_HALTON</a>))
<a name="l02175"></a>02175         <a class="code" href="../../d6/d95/rayshade_8c.html#a781edee2274eb901321cae01edbb8b4d">ray_ao_qmc</a>(shi, ao, env);
<a name="l02176"></a>02176     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_samp_method == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a77c9804ffd340b77c103022307fc35f8">WO_AOSAMP_CONSTANT</a>)
<a name="l02177"></a>02177         <a class="code" href="../../d6/d95/rayshade_8c.html#a36e7880ee5a1db0e416974aa441f6fac">ray_ao_spheresamp</a>(shi, ao, env);
<a name="l02178"></a>02178 }
<a name="l02179"></a>02179 
<a name="l02180"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a978516da779276de5f94b35a0433a5e8">02180</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a978516da779276de5f94b35a0433a5e8">ray_shadow_jittered_coords</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">int</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <span class="keywordtype">float</span> jitco[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>][3], <span class="keywordtype">int</span> *totjitco)
<a name="l02181"></a>02181 {
<a name="l02182"></a>02182     <span class="comment">/* magic numbers for reordering sample positions to give better</span>
<a name="l02183"></a>02183 <span class="comment">     * results with adaptive sample, when it usually only takes 4 samples */</span>
<a name="l02184"></a>02184     <span class="keywordtype">int</span> order8[8] = {0, 1, 5, 6, 2, 3, 4, 7};
<a name="l02185"></a>02185     <span class="keywordtype">int</span> order11[11] = {1, 3, 8, 10, 0, 2, 4, 5, 6, 7, 9};
<a name="l02186"></a>02186     <span class="keywordtype">int</span> order16[16] = {1, 3, 9, 12, 0, 6, 7, 8, 13, 2, 4, 5, 10, 11, 14, 15};
<a name="l02187"></a>02187     <span class="keywordtype">int</span> count = <a class="code" href="../../d0/d0e/rendercore_8h.html#a4b7639b6addcc7e447572d581a9fe70c">count_mask</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>);
<a name="l02188"></a>02188 
<a name="l02189"></a>02189     <span class="comment">/* for better antialising shadow samples are distributed over the subpixel</span>
<a name="l02190"></a>02190 <span class="comment">     * sample coordinates, this only works for raytracing depth 0 though */</span>
<a name="l02191"></a>02191     <span class="keywordflow">if</span> (!shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> == 0 &amp;&amp; count &gt; 1 &amp;&amp; count &lt;= max) {
<a name="l02192"></a>02192         <span class="keywordtype">float</span> xs, ys, zs, view[3];
<a name="l02193"></a>02193         <span class="keywordtype">int</span> samp, ordsamp, <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>= 0;
<a name="l02194"></a>02194 
<a name="l02195"></a>02195         <span class="keywordflow">for</span> (samp=0; samp&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; samp++) {
<a name="l02196"></a>02196             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa == 8) ordsamp = order8[samp];
<a name="l02197"></a>02197             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa == 11) ordsamp = order11[samp];
<a name="l02198"></a>02198             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa == 16) ordsamp = order16[samp];
<a name="l02199"></a>02199             <span class="keywordflow">else</span> ordsamp = samp;
<a name="l02200"></a>02200 
<a name="l02201"></a>02201             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a> &amp; (1&lt;&lt;ordsamp)) {
<a name="l02202"></a>02202                 <span class="comment">/* zbuffer has this inverse corrected, ensures xs,ys are inside pixel */</span>
<a name="l02203"></a>02203                 xs= (float)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab25201e9871049abe2502c3327e16ec0">scanco</a>[0] + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[ordsamp][0] + 0.5f;
<a name="l02204"></a>02204                 ys= (<span class="keywordtype">float</span>)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab25201e9871049abe2502c3327e16ec0">scanco</a>[1] + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[ordsamp][1] + 0.5f;
<a name="l02205"></a>02205                 zs= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab25201e9871049abe2502c3327e16ec0">scanco</a>[2];
<a name="l02206"></a>02206 
<a name="l02207"></a>02207                 <a class="code" href="../../da/d3d/shading_8h.html#a58bc1b105a043ca721a2623ddda3044e">shade_input_calc_viewco</a>(shi, xs, ys, zs, view, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, jitco[tot], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02208"></a>02208                 tot++;
<a name="l02209"></a>02209             }
<a name="l02210"></a>02210         }
<a name="l02211"></a>02211 
<a name="l02212"></a>02212         *totjitco= <a class="code" href="../../d2/dce/structQMCSampler.html#a67d025c39d9efb562eeafc957c9a9171">tot</a>;
<a name="l02213"></a>02213     }
<a name="l02214"></a>02214     <span class="keywordflow">else</span> {
<a name="l02215"></a>02215         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(jitco[0], shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02216"></a>02216         *totjitco= 1;
<a name="l02217"></a>02217     }
<a name="l02218"></a>02218 }
<a name="l02219"></a>02219 
<a name="l02220"></a><a class="code" href="../../d6/d95/rayshade_8c.html#ac3737246a0986b2fe99a0c890e12a3cb">02220</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#ac3737246a0986b2fe99a0c890e12a3cb">ray_shadow_qmc</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keyword">const</span> <span class="keywordtype">float</span> lampco[3], <span class="keywordtype">float</span> shadfac[4], <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *isec)
<a name="l02221"></a>02221 {
<a name="l02222"></a>02222     <a class="code" href="../../d2/dce/structQMCSampler.html">QMCSampler</a> *qsa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02223"></a>02223     <span class="keywordtype">int</span> samples=0;
<a name="l02224"></a>02224     <span class="keywordtype">float</span> samp3d[3];
<a name="l02225"></a>02225 
<a name="l02226"></a>02226     <span class="keywordtype">float</span> fac=0.0f, vec[3], end[3];
<a name="l02227"></a>02227     <span class="keywordtype">float</span> colsq[4];
<a name="l02228"></a>02228     <span class="keywordtype">float</span> adapt_thresh = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#acd86400ad3159e196e574fc47141c1cd">adapt_thresh</a>;
<a name="l02229"></a>02229     <span class="keywordtype">int</span> min_adapt_samples=4, max_samples = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l02230"></a>02230     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l02231"></a>02231     <span class="keywordtype">int</span> do_soft=1, full_osa=0, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02232"></a>02232 
<a name="l02233"></a>02233     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3];
<a name="l02234"></a>02234     <a class="code" href="../../d0/d57/structRayHint.html">RayHint</a> bb_hint;
<a name="l02235"></a>02235 
<a name="l02236"></a>02236     <span class="keywordtype">float</span> jitco[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>][3];
<a name="l02237"></a>02237     <span class="keywordtype">int</span> totjitco;
<a name="l02238"></a>02238 
<a name="l02239"></a>02239     colsq[0] = colsq[1] = colsq[2] = 0.0;
<a name="l02240"></a>02240     <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02241"></a>02241         shadfac[0]= shadfac[1]= shadfac[2]= shadfac[3]= 0.0f;
<a name="l02242"></a>02242     }
<a name="l02243"></a>02243     <span class="keywordflow">else</span>
<a name="l02244"></a>02244         shadfac[3]= 1.0f;
<a name="l02245"></a>02245     
<a name="l02246"></a>02246     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a> &lt; 2) do_soft = 0;
<a name="l02247"></a>02247     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2711a7abdf812fa0f1b16da25a7d6343">R_OSA</a>) &amp;&amp; (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa &gt; 0) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#af99e9bbaa81b1dd1c3b8c010da102bbd">R_FULL_OSA</a>)) full_osa = 1;
<a name="l02248"></a>02248     
<a name="l02249"></a>02249     <span class="keywordflow">if</span> (full_osa) {
<a name="l02250"></a>02250         <span class="keywordflow">if</span> (do_soft) max_samples  = max_samples/<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa + 1;
<a name="l02251"></a>02251         <span class="keywordflow">else</span> max_samples = 1;
<a name="l02252"></a>02252     }
<a name="l02253"></a>02253     <span class="keywordflow">else</span> {
<a name="l02254"></a>02254         <span class="keywordflow">if</span> (do_soft) max_samples = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l02255"></a>02255         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> == 0) max_samples = (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa &gt; 4)?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:5;
<a name="l02256"></a>02256         <span class="keywordflow">else</span> max_samples = 1;
<a name="l02257"></a>02257     }
<a name="l02258"></a>02258     
<a name="l02259"></a>02259     <a class="code" href="../../d6/d95/rayshade_8c.html#a978516da779276de5f94b35a0433a5e8">ray_shadow_jittered_coords</a>(shi, max_samples, jitco, &amp;totjitco);
<a name="l02260"></a>02260 
<a name="l02261"></a>02261     <span class="comment">/* sampling init */</span>
<a name="l02262"></a>02262     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2158ca4037c0d0dfdd43cea8e8d4a210">LA_SAMP_HALTON</a>)
<a name="l02263"></a>02263         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, <a class="code" href="../../db/d00/render__types_8h.html#ab6cd5e11cb2b9f0cc66230c92821d920">SAMP_TYPE_HALTON</a>, max_samples);
<a name="l02264"></a>02264     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a75614889dc90e9a6c0dabd1495ef33c9">LA_SAMP_HAMMERSLEY</a>)
<a name="l02265"></a>02265         qsa = <a class="code" href="../../d6/d95/rayshade_8c.html#ad6025e7485be7436cc111c84aa3175c9">get_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, <a class="code" href="../../db/d00/render__types_8h.html#a29d422528ccc05fcd519697c258b2234">SAMP_TYPE_HAMMERSLEY</a>, max_samples);
<a name="l02266"></a>02266     
<a name="l02267"></a>02267     <a class="code" href="../../d6/d95/rayshade_8c.html#a32c7e14290e1f5f208c4536955d4450e">QMC_initPixel</a>(qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l02270"></a>02270     <span class="keywordflow">for</span> (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;totjitco; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l02271"></a>02271     {
<a name="l02272"></a>02272         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(jitco[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>], min, max);
<a name="l02273"></a>02273     }
<a name="l02274"></a>02274     <a class="code" href="../../d8/d42/rayobject_8h.html#a18cbef867f739a79dc773536fea93efe">RE_rayobject_hint_bb</a>( <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;bb_hint, min, max);
<a name="l02275"></a>02275     
<a name="l02276"></a>02276     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = &amp;bb_hint;
<a name="l02277"></a>02277     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#ae5e08b683b8fa6d16d6ab3b435d7b362">RE_CHECK_VLR_RENDER</a>;
<a name="l02278"></a>02278     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l02279"></a>02279     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, lampco);
<a name="l02280"></a>02280     
<a name="l02281"></a>02281     <span class="keywordflow">while</span> (samples &lt; max_samples) {
<a name="l02282"></a>02282 
<a name="l02283"></a>02283         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l02284"></a>02284         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l02285"></a>02285 
<a name="l02286"></a>02286         <span class="comment">/* manually jitter the start shading co-ord per sample</span>
<a name="l02287"></a>02287 <span class="comment">         * based on the pre-generated OSA texture sampling offsets, </span>
<a name="l02288"></a>02288 <span class="comment">         * for anti-aliasing sharp shadow edges. */</span>
<a name="l02289"></a>02289         co = jitco[samples % totjitco];
<a name="l02290"></a>02290 
<a name="l02291"></a>02291         <span class="keywordflow">if</span> (do_soft) {
<a name="l02292"></a>02292             <span class="comment">/* sphere shadow source */</span>
<a name="l02293"></a>02293             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab67de808c369ec7696aff85a24eace8e">LA_LOCAL</a>) {
<a name="l02294"></a>02294                 <span class="keywordtype">float</span> ru[3], rv[3], v[3], s[3];
<a name="l02295"></a>02295                 
<a name="l02296"></a>02296                 <span class="comment">/* calc tangent plane vectors */</span>
<a name="l02297"></a>02297                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, co, lampco);
<a name="l02298"></a>02298                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v);
<a name="l02299"></a>02299                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>( ru, rv,v);
<a name="l02300"></a>02300                 
<a name="l02301"></a>02301                 <span class="comment">/* sampling, returns quasi-random vector in area_size disc */</span>
<a name="l02302"></a>02302                 <a class="code" href="../../d6/d95/rayshade_8c.html#ad87e79538a6f0ea4cbcbaa3922cb2e02">QMC_sampleDisc</a>(samp3d, qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samples,lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>);
<a name="l02303"></a>02303 
<a name="l02304"></a>02304                 <span class="comment">/* distribute disc samples across the tangent plane */</span>
<a name="l02305"></a>02305                 s[0] = samp3d[0]*ru[0] + samp3d[1]*rv[0];
<a name="l02306"></a>02306                 s[1] = samp3d[0]*ru[1] + samp3d[1]*rv[1];
<a name="l02307"></a>02307                 s[2] = samp3d[0]*ru[2] + samp3d[1]*rv[2];
<a name="l02308"></a>02308                 
<a name="l02309"></a>02309                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(samp3d, s);
<a name="l02310"></a>02310             }
<a name="l02311"></a>02311             <span class="keywordflow">else</span> {
<a name="l02312"></a>02312                 <span class="comment">/* sampling, returns quasi-random vector in [sizex,sizey]^2 plane */</span>
<a name="l02313"></a>02313                 <a class="code" href="../../d6/d95/rayshade_8c.html#ab4c25ab86a32968a884792f2c8ff72e2">QMC_sampleRect</a>(samp3d, qsa, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, samples, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>);
<a name="l02314"></a>02314                                 
<a name="l02315"></a>02315                 <span class="comment">/* align samples to lamp vector */</span>
<a name="l02316"></a>02316                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>, samp3d);
<a name="l02317"></a>02317             }
<a name="l02318"></a>02318             end[0] = vec[0]+samp3d[0];
<a name="l02319"></a>02319             end[1] = vec[1]+samp3d[1];
<a name="l02320"></a>02320             end[2] = vec[2]+samp3d[2];
<a name="l02321"></a>02321         }
<a name="l02322"></a>02322         <span class="keywordflow">else</span> {
<a name="l02323"></a>02323             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(end, vec);
<a name="l02324"></a>02324         }
<a name="l02325"></a>02325 
<a name="l02326"></a>02326         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>) {
<a name="l02327"></a>02327             <span class="comment">/* bias away somewhat to avoid self intersection */</span>
<a name="l02328"></a>02328             <span class="keywordtype">float</span> jitbias= 0.5f*(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>) + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>));
<a name="l02329"></a>02329             <span class="keywordtype">float</span> v[3];
<a name="l02330"></a>02330 
<a name="l02331"></a>02331             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, co, end);
<a name="l02332"></a>02332             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v);
<a name="l02333"></a>02333 
<a name="l02334"></a>02334             co[0] -= jitbias*v[0];
<a name="l02335"></a>02335             co[1] -= jitbias*v[1];
<a name="l02336"></a>02336             co[2] -= jitbias*v[2];
<a name="l02337"></a>02337         }
<a name="l02338"></a>02338 
<a name="l02339"></a>02339         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, co);
<a name="l02340"></a>02340         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0] = end[0]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0];
<a name="l02341"></a>02341         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1] = end[1]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1];
<a name="l02342"></a>02342         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2] = end[2]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2];
<a name="l02343"></a>02343         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>);
<a name="l02344"></a>02344         
<a name="l02345"></a>02345         <span class="comment">/* trace the ray */</span>
<a name="l02346"></a>02346         <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02347"></a>02347             <span class="keywordtype">float</span> col[4] = {1.0f, 1.0f, 1.0f, 1.0f};
<a name="l02348"></a>02348             
<a name="l02349"></a>02349             <a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">ray_trace_shadow_tra</a>(isec, shi, <a class="code" href="../../d6/d95/rayshade_8c.html#a6f9909a5e0e1df772598d89711ccca02">DEPTH_SHADOW_TRA</a>, 0, col);
<a name="l02350"></a>02350             shadfac[0] += col[0];
<a name="l02351"></a>02351             shadfac[1] += col[1];
<a name="l02352"></a>02352             shadfac[2] += col[2];
<a name="l02353"></a>02353             shadfac[3] += col[3];
<a name="l02354"></a>02354             
<a name="l02355"></a>02355             <span class="comment">/* for variance calc */</span>
<a name="l02356"></a>02356             colsq[0] += col[0]*col[0];
<a name="l02357"></a>02357             colsq[1] += col[1]*col[1];
<a name="l02358"></a>02358             colsq[2] += col[2]*col[2];
<a name="l02359"></a>02359         }
<a name="l02360"></a>02360         <span class="keywordflow">else</span> {
<a name="l02361"></a>02361             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, isec) ) fac+= 1.0f;
<a name="l02362"></a>02362         }
<a name="l02363"></a>02363         
<a name="l02364"></a>02364         samples++;
<a name="l02365"></a>02365         
<a name="l02366"></a>02366         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2158ca4037c0d0dfdd43cea8e8d4a210">LA_SAMP_HALTON</a>) {
<a name="l02367"></a>02367         
<a name="l02368"></a>02368             <span class="comment">/* adaptive sampling - consider samples below threshold as in shadow (or vice versa) and exit early */</span>
<a name="l02369"></a>02369             <span class="keywordflow">if</span> ((max_samples &gt; min_adapt_samples) &amp;&amp; (adapt_thresh &gt; 0.0f) &amp;&amp; (samples &gt; max_samples / 3)) {
<a name="l02370"></a>02370                 <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02371"></a>02371                     <span class="keywordflow">if</span> ((shadfac[3] / samples &gt; (1.0f-adapt_thresh)) || (shadfac[3] / samples &lt; adapt_thresh))
<a name="l02372"></a>02372                         <span class="keywordflow">break</span>;
<a name="l02373"></a>02373                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d95/rayshade_8c.html#a88e9acaf390f419894540cd17026824f">adaptive_sample_variance</a>(samples, shadfac, colsq, adapt_thresh))
<a name="l02374"></a>02374                         <span class="keywordflow">break</span>;
<a name="l02375"></a>02375                 }
<a name="l02376"></a>02376                 <span class="keywordflow">else</span> {
<a name="l02377"></a>02377                     <span class="keywordflow">if</span> ((fac / samples &gt; (1.0f-adapt_thresh)) || (fac / samples &lt; adapt_thresh))
<a name="l02378"></a>02378                         <span class="keywordflow">break</span>;
<a name="l02379"></a>02379                 }
<a name="l02380"></a>02380             }
<a name="l02381"></a>02381         }
<a name="l02382"></a>02382     }
<a name="l02383"></a>02383     
<a name="l02384"></a>02384     <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02385"></a>02385         shadfac[0] /= samples;
<a name="l02386"></a>02386         shadfac[1] /= samples;
<a name="l02387"></a>02387         shadfac[2] /= samples;
<a name="l02388"></a>02388         shadfac[3] /= samples;
<a name="l02389"></a>02389     }
<a name="l02390"></a>02390     <span class="keywordflow">else</span>
<a name="l02391"></a>02391         shadfac[3]= 1.0f-fac/samples;
<a name="l02392"></a>02392 
<a name="l02393"></a>02393     <span class="keywordflow">if</span> (qsa)
<a name="l02394"></a>02394         <a class="code" href="../../d6/d95/rayshade_8c.html#a71e82a4cd748151fee725058d96b1cee">release_thread_qmcsampler</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, qsa);
<a name="l02395"></a>02395 }
<a name="l02396"></a>02396 
<a name="l02397"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a461c95f79798ebeac154412b4c99f68f">02397</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d95/rayshade_8c.html#a461c95f79798ebeac154412b4c99f68f">ray_shadow_jitter</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keyword">const</span> <span class="keywordtype">float</span> lampco[3], <span class="keywordtype">float</span> shadfac[4], <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *isec)
<a name="l02398"></a>02398 {
<a name="l02399"></a>02399     <span class="comment">/* area soft shadow */</span>
<a name="l02400"></a>02400     <span class="keywordtype">float</span> *jitlamp;
<a name="l02401"></a>02401     <span class="keywordtype">float</span> fac=0.0f, <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>=0.0f, vec[3];
<a name="l02402"></a>02402     <span class="keywordtype">int</span> a, j= -1, mask;
<a name="l02403"></a>02403     <a class="code" href="../../d0/d57/structRayHint.html">RayHint</a> point_hint;
<a name="l02404"></a>02404     
<a name="l02405"></a>02405     <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02406"></a>02406         shadfac[0]= shadfac[1]= shadfac[2]= shadfac[3]= 0.0f;
<a name="l02407"></a>02407     }
<a name="l02408"></a>02408     <span class="keywordflow">else</span> shadfac[3]= 1.0f;
<a name="l02409"></a>02409     
<a name="l02410"></a>02410     fac= 0.0f;
<a name="l02411"></a>02411     jitlamp= <a class="code" href="../../d6/d95/rayshade_8c.html#a3d0987e783ac6d7d2439ec653768742b">give_jitter_plane</a>(lar, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>);
<a name="l02412"></a>02412 
<a name="l02413"></a>02413     a= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l02414"></a>02414     
<a name="l02415"></a>02415     <span class="comment">/* this correction to make sure we always take at least 1 sample */</span>
<a name="l02416"></a>02416     mask= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>;
<a name="l02417"></a>02417     <span class="keywordflow">if</span> (a==4) mask |= (mask&gt;&gt;4)|(mask&gt;&gt;8);
<a name="l02418"></a>02418     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a==9) mask |= (mask&gt;&gt;9);
<a name="l02419"></a>02419     
<a name="l02420"></a>02420     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02421"></a>02421     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l02422"></a>02422     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l02423"></a>02423     <a class="code" href="../../d8/d42/rayobject_8h.html#a18cbef867f739a79dc773536fea93efe">RE_rayobject_hint_bb</a>( <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;point_hint, isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a> );
<a name="l02424"></a>02424     isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = &amp;point_hint;
<a name="l02425"></a>02425     
<a name="l02426"></a>02426     <span class="keywordflow">while</span> (a--) {
<a name="l02427"></a>02427         
<a name="l02428"></a>02428         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2711a7abdf812fa0f1b16da25a7d6343">R_OSA</a>) {
<a name="l02429"></a>02429             j++;
<a name="l02430"></a>02430             <span class="keywordflow">if</span> (j&gt;=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) j= 0;
<a name="l02431"></a>02431             <span class="keywordflow">if</span> (!(mask &amp; (1&lt;&lt;j))) {
<a name="l02432"></a>02432                 jitlamp+= 2;
<a name="l02433"></a>02433                 <span class="keywordflow">continue</span>;
<a name="l02434"></a>02434             }
<a name="l02435"></a>02435         }
<a name="l02436"></a>02436         
<a name="l02437"></a>02437         vec[0]= jitlamp[0];
<a name="l02438"></a>02438         vec[1]= jitlamp[1];
<a name="l02439"></a>02439         vec[2]= 0.0f;
<a name="l02440"></a>02440         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>, vec);
<a name="l02441"></a>02441         
<a name="l02442"></a>02442         <span class="comment">/* set start and vec */</span>
<a name="l02443"></a>02443         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0] = vec[0]+lampco[0]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0];
<a name="l02444"></a>02444         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1] = vec[1]+lampco[1]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1];
<a name="l02445"></a>02445         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2] = vec[2]+lampco[2]-isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2];
<a name="l02446"></a>02446         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = 1.0f;
<a name="l02447"></a>02447         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#ae5e08b683b8fa6d16d6ab3b435d7b362">RE_CHECK_VLR_RENDER</a>;
<a name="l02448"></a>02448         isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l02449"></a>02449         
<a name="l02450"></a>02450         <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02451"></a>02451             <span class="comment">/* isec.col is like shadfac, so defines amount of light (0.0 is full shadow) */</span>
<a name="l02452"></a>02452             <span class="keywordtype">float</span> col[4] = {1.0f, 1.0f, 1.0f, 1.0f};
<a name="l02453"></a>02453             
<a name="l02454"></a>02454             <a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">ray_trace_shadow_tra</a>(isec, shi, <a class="code" href="../../d6/d95/rayshade_8c.html#a6f9909a5e0e1df772598d89711ccca02">DEPTH_SHADOW_TRA</a>, 0, col);
<a name="l02455"></a>02455             shadfac[0] += col[0];
<a name="l02456"></a>02456             shadfac[1] += col[1];
<a name="l02457"></a>02457             shadfac[2] += col[2];
<a name="l02458"></a>02458             shadfac[3] += col[3];
<a name="l02459"></a>02459         }
<a name="l02460"></a>02460         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, isec) ) fac+= 1.0f;
<a name="l02461"></a>02461         
<a name="l02462"></a>02462         <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>+= 1.0f;
<a name="l02463"></a>02463         jitlamp+= 2;
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465     
<a name="l02466"></a>02466     <span class="keywordflow">if</span> (isec-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02467"></a>02467         shadfac[0] /= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02468"></a>02468         shadfac[1] /= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02469"></a>02469         shadfac[2] /= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02470"></a>02470         shadfac[3] /= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02471"></a>02471     }
<a name="l02472"></a>02472     <span class="keywordflow">else</span> {
<a name="l02473"></a>02473         <span class="comment">// sqrt makes nice umbra effect</span>
<a name="l02474"></a>02474         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af9d58311395b67c104fbaea5bcaed5bc">ray_samp_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aec0c1ce6ff7d57999d83aa1de0ca56b7">LA_SAMP_UMBRA</a>)
<a name="l02475"></a>02475             shadfac[3]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(1.0f-fac/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l02476"></a>02476         <span class="keywordflow">else</span>
<a name="l02477"></a>02477             shadfac[3]= 1.0f-fac/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02478"></a>02478     }
<a name="l02479"></a>02479 }
<a name="l02480"></a>02480 <span class="comment">/* extern call from shade_lamp_loop */</span>
<a name="l02481"></a><a class="code" href="../../d6/d95/rayshade_8c.html#a0a2119f1e2bc6448c9c3265dbba615d0">02481</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#a0a2119f1e2bc6448c9c3265dbba615d0">ray_shadow</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> shadfac[4])
<a name="l02482"></a>02482 {
<a name="l02483"></a>02483     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l02484"></a>02484     <span class="keywordtype">float</span> lampco[3];
<a name="l02485"></a>02485 
<a name="l02486"></a>02486     <span class="comment">/* setup isec */</span>
<a name="l02487"></a>02487     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, *shi);
<a name="l02488"></a>02488     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a059921799bee67e88ec82e1409bf4f87">MA_SHADOW_TRA</a>) isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>;
<a name="l02489"></a>02489     <span class="keywordflow">else</span> isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#acd1dd533a06af58d2e9269daf63f8ac9">RE_RAY_SHADOW</a>;
<a name="l02490"></a>02490     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l02491"></a>02491     
<a name="l02492"></a>02492     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1337605158cc594cf324bdbe8b1818ce">LA_LAYER_SHADOW</a>))
<a name="l02493"></a>02493         isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;
<a name="l02494"></a>02494     <span class="keywordflow">else</span>
<a name="l02495"></a>02495         isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l02496"></a>02496 
<a name="l02497"></a>02497     <span class="comment">/* only when not mir tracing, first hit optimm */</span>
<a name="l02498"></a>02498     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>==0) {
<a name="l02499"></a>02499         isec.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7f3f1fcbd851592cb40930eb02b11ec6">last_hit</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>];
<a name="l02500"></a>02500     }
<a name="l02501"></a>02501     <span class="keywordflow">else</span> {
<a name="l02502"></a>02502         isec.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02503"></a>02503     }
<a name="l02504"></a>02504     
<a name="l02505"></a>02505     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l02506"></a>02506         <span class="comment">/* jitter and QMC sampling add a displace vector to the lamp position</span>
<a name="l02507"></a>02507 <span class="comment">         * that&#39;s incorrect because a SUN lamp does not has an exact position</span>
<a name="l02508"></a>02508 <span class="comment">         * and the displace should be done at the ray vector instead of the</span>
<a name="l02509"></a>02509 <span class="comment">         * lamp position.</span>
<a name="l02510"></a>02510 <span class="comment">         * This is easily verified by noticing that shadows of SUN lights change</span>
<a name="l02511"></a>02511 <span class="comment">         * with the scene BB.</span>
<a name="l02512"></a>02512 <span class="comment">         * </span>
<a name="l02513"></a>02513 <span class="comment">         * This was detected during SoC 2009 - Raytrace Optimization, but to keep</span>
<a name="l02514"></a>02514 <span class="comment">         * consistency with older render code it wasn&#39;t removed.</span>
<a name="l02515"></a>02515 <span class="comment">         * </span>
<a name="l02516"></a>02516 <span class="comment">         * If the render code goes through some recode/serious bug-fix then this</span>
<a name="l02517"></a>02517 <span class="comment">         * is something to consider!</span>
<a name="l02518"></a>02518 <span class="comment">         */</span>
<a name="l02519"></a>02519         lampco[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0] - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.maxdist*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0];
<a name="l02520"></a>02520         lampco[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1] - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.maxdist*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1];
<a name="l02521"></a>02521         lampco[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2] - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.maxdist*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2];
<a name="l02522"></a>02522     }
<a name="l02523"></a>02523     <span class="keywordflow">else</span> {
<a name="l02524"></a>02524         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lampco, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l02525"></a>02525     }
<a name="l02526"></a>02526     
<a name="l02527"></a>02527     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2158ca4037c0d0dfdd43cea8e8d4a210">LA_SAMP_HALTON</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a75614889dc90e9a6c0dabd1495ef33c9">LA_SAMP_HAMMERSLEY</a>)) {
<a name="l02528"></a>02528         
<a name="l02529"></a>02529         <a class="code" href="../../d6/d95/rayshade_8c.html#ac3737246a0986b2fe99a0c890e12a3cb">ray_shadow_qmc</a>(shi, lar, lampco, shadfac, &amp;isec);
<a name="l02530"></a>02530         
<a name="l02531"></a>02531     }
<a name="l02532"></a>02532     <span class="keywordflow">else</span> {
<a name="l02533"></a>02533         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>&lt;2) {
<a name="l02534"></a>02534             
<a name="l02535"></a>02535             isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l02536"></a>02536             isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l02537"></a>02537             
<a name="l02538"></a>02538             shadfac[3]= 1.0f; <span class="comment">// 1.0=full light</span>
<a name="l02539"></a>02539             
<a name="l02540"></a>02540             <span class="comment">/* set up isec.dir */</span>
<a name="l02541"></a>02541             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02542"></a>02542             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, lampco, isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>);
<a name="l02543"></a>02543             isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>);
<a name="l02544"></a>02544 
<a name="l02545"></a>02545             <span class="keywordflow">if</span> (isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>==<a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>) {
<a name="l02546"></a>02546                 <span class="comment">/* isec.col is like shadfac, so defines amount of light (0.0 is full shadow) */</span>
<a name="l02547"></a>02547                 <span class="keywordtype">float</span> col[4] = {1.0f, 1.0f, 1.0f, 1.0f};
<a name="l02548"></a>02548 
<a name="l02549"></a>02549                 <a class="code" href="../../d6/d95/rayshade_8c.html#a38b44d4026e0693cffb4043c50dff4f4">ray_trace_shadow_tra</a>(&amp;isec, shi, <a class="code" href="../../d6/d95/rayshade_8c.html#a6f9909a5e0e1df772598d89711ccca02">DEPTH_SHADOW_TRA</a>, 0, col);
<a name="l02550"></a>02550                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(shadfac, col);
<a name="l02551"></a>02551             }
<a name="l02552"></a>02552             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec))
<a name="l02553"></a>02553                 shadfac[3]= 0.0f;
<a name="l02554"></a>02554         }
<a name="l02555"></a>02555         <span class="keywordflow">else</span> {
<a name="l02556"></a>02556             <a class="code" href="../../d6/d95/rayshade_8c.html#a461c95f79798ebeac154412b4c99f68f">ray_shadow_jitter</a>(shi, lar, lampco, shadfac, &amp;isec);
<a name="l02557"></a>02557         }
<a name="l02558"></a>02558     }
<a name="l02559"></a>02559         
<a name="l02560"></a>02560     <span class="comment">/* for first hit optim, set last interesected shadow face */</span>
<a name="l02561"></a>02561     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>==0) {
<a name="l02562"></a>02562         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7f3f1fcbd851592cb40930eb02b11ec6">last_hit</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>] = isec.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a>;
<a name="l02563"></a>02563     }
<a name="l02564"></a>02564 
<a name="l02565"></a>02565 }
<a name="l02566"></a>02566 
<a name="l02567"></a>02567 <span class="preprocessor">#if 0</span>
<a name="l02568"></a>02568 <span class="preprocessor"></span><span class="comment">/* only when face points away from lamp, in direction of lamp, trace ray and find first exit point */</span>
<a name="l02569"></a>02569 <span class="keyword">static</span> <span class="keywordtype">void</span> ray_translucent(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> *distfac, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l02570"></a>02570 {
<a name="l02571"></a>02571     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isec;
<a name="l02572"></a>02572     <span class="keywordtype">float</span> lampco[3];
<a name="l02573"></a>02573     
<a name="l02574"></a>02574     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(0);
<a name="l02575"></a>02575     
<a name="l02576"></a>02576     <span class="comment">/* setup isec */</span>
<a name="l02577"></a>02577     <a class="code" href="../../d9/dd4/raycounter_8h.html#a3628793c0bb6dd4e3c2d2039e45372f5">RE_RC_INIT</a>(isec, *shi);
<a name="l02578"></a>02578     isec.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#a54adec6c2dd004d79301f1114993a348">RE_RAY_SHADOW_TRA</a>;
<a name="l02579"></a>02579     isec.<a class="code" href="../../d8/d95/structIsect.html#abbfb5f8ba9c1fdd3187c2a687207353b">hint</a> = 0;
<a name="l02580"></a>02580     
<a name="l02581"></a>02581     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>; <span class="keywordflow">else</span> isec.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l02582"></a>02582     
<a name="l02583"></a>02583     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l02584"></a>02584         lampco[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0] - <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1c7e702ee03215ce362608ca9032956e">RE_RAYTRACE_MAXDIST</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0];
<a name="l02585"></a>02585         lampco[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1] - <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1c7e702ee03215ce362608ca9032956e">RE_RAYTRACE_MAXDIST</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1];
<a name="l02586"></a>02586         lampco[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2] - <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1c7e702ee03215ce362608ca9032956e">RE_RAYTRACE_MAXDIST</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2];
<a name="l02587"></a>02587     }
<a name="l02588"></a>02588     <span class="keywordflow">else</span> {
<a name="l02589"></a>02589         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lampco, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l02590"></a>02590     }
<a name="l02591"></a>02591     
<a name="l02592"></a>02592     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a>   = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l02593"></a>02593     isec.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l02594"></a>02594     
<a name="l02595"></a>02595     <span class="comment">/* set up isec.dir */</span>
<a name="l02596"></a>02596     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02597"></a>02597     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isec.end, lampco);
<a name="l02598"></a>02598     
<a name="l02599"></a>02599     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isec)) {
<a name="l02600"></a>02600         <span class="comment">/* we got a face */</span>
<a name="l02601"></a>02601         
<a name="l02602"></a>02602         <span class="comment">/* render co */</span>
<a name="l02603"></a>02603         co[0]= isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0]+isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0]);
<a name="l02604"></a>02604         co[1]= isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1]+isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1]);
<a name="l02605"></a>02605         co[2]= isec.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2]+isec.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2]);
<a name="l02606"></a>02606         
<a name="l02607"></a>02607         *distfac= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(isec.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>);
<a name="l02608"></a>02608     }
<a name="l02609"></a>02609     <span class="keywordflow">else</span>
<a name="l02610"></a>02610         *distfac= 0.0f;
<a name="l02611"></a>02611 }
<a name="l02612"></a>02612 
<a name="l02613"></a>02613 <span class="preprocessor">#endif</span>
<a name="l02614"></a>02614 <span class="preprocessor"></span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:46 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
