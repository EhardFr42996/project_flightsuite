<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: iksolver_plugin.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">iksolver_plugin.c</div>  </div>
</div>
<div class="contents">
<a href="../../d6/de8/iksolver__plugin_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Original author: Benoit Bolsee</span>
<a name="l00024"></a>00024 <span class="comment"> * Contributor(s): </span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dd6/BIK__api_8h.html">BIK_api.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d2a/DNA__action__types_8h.html">DNA_action_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d54/IK__solver_8h.html">IK_solver.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dab/iksolver__plugin_8h.html">iksolver_plugin.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;string.h&gt;</span> <span class="comment">/* memcpy */</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">/* ********************** THE IK SOLVER ******************* */</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/* allocates PoseTree, and links that to root bone/channel */</span>
<a name="l00057"></a>00057 <span class="comment">/* Note: detecting the IK chain is duplicate code... in drawarmature.c and in transform_conversions.c */</span>
<a name="l00058"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad5451f6a937651b44d34a3589ded88ee">00058</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad5451f6a937651b44d34a3589ded88ee">initialize_posetree</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob), <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan_tip)
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *curchan, *pchan_root=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *chanlist[256], **oldchan;
<a name="l00061"></a>00061     <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree;
<a name="l00062"></a>00062     <a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a> *target;
<a name="l00063"></a>00063     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l00064"></a>00064     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00065"></a>00065     <span class="keywordtype">int</span> a, t, segcount= 0, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, newsize, *oldparent, parent;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067     <span class="comment">/* find IK constraint, and validate it */</span>
<a name="l00068"></a>00068     <span class="keywordflow">for</span> (con= pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l00069"></a>00069         <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a>==<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a>) {
<a name="l00070"></a>00070             data=(<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00071"></a>00071             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5daa615284f990351c298b824ea793e3b41">CONSTRAINT_IK_AUTO</a>) <span class="keywordflow">break</span>;
<a name="l00072"></a>00072             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a40d06e4dc4d012bd48f578721cffbe5b">tar</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l00073"></a>00073             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a40d06e4dc4d012bd48f578721cffbe5b">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a> &amp;&amp; data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ae1995de4033715d3d3c571f70f92d344">subtarget</a>[0]==0) <span class="keywordflow">continue</span>;
<a name="l00074"></a>00074             <span class="keywordflow">if</span> ((con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; (<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efdac624d1811979843b913fe2a7c3833c53">CONSTRAINT_DISABLE</a>|<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>))==0 &amp;&amp; (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> != 0.0f)) <span class="keywordflow">break</span>;
<a name="l00075"></a>00075         }
<a name="l00076"></a>00076     }
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (con==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00078"></a>00078     
<a name="l00079"></a>00079     <span class="comment">/* exclude tip from chain? */</span>
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (!(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dae3a865a72db654ff3b3a0528179d699a">CONSTRAINT_IK_TIP</a>))
<a name="l00081"></a>00081         pchan_tip= pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l00082"></a>00082     
<a name="l00083"></a>00083     <span class="comment">/* Find the chain&#39;s root &amp; count the segments needed */</span>
<a name="l00084"></a>00084     for (curchan = pchan_tip; curchan; curchan=curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00085"></a>00085         pchan_root = curchan;
<a name="l00086"></a>00086         
<a name="l00087"></a>00087         curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>;    <span class="comment">// don&#39;t forget to clear this</span>
<a name="l00088"></a>00088         chanlist[segcount]=curchan;
<a name="l00089"></a>00089         segcount++;
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (segcount==data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#afb10d502fbc8bf3fce8f2994e355be56">rootbone</a> || segcount&gt;255) <span class="keywordflow">break</span>; <span class="comment">// 255 is weak</span>
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093     <span class="keywordflow">if</span> (!segcount) <span class="keywordflow">return</span>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="comment">/* setup the chain data */</span>
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="comment">/* we make tree-IK, unless all existing targets are in this chain */</span>
<a name="l00098"></a>00098     <span class="keywordflow">for</span> (tree= pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tree; tree= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aad9c465285f8cbc7d972cb3d54a4d152">next</a>) {
<a name="l00099"></a>00099         <span class="keywordflow">for</span> (target= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; target; target= target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#a1f5f82018b1a259fc85d2010a4f8002c">next</a>) {
<a name="l00100"></a>00100             curchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>];
<a name="l00101"></a>00101             <span class="keywordflow">if</span> (curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>)
<a name="l00102"></a>00102                 curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp;= ~<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>;
<a name="l00103"></a>00103             <span class="keywordflow">else</span>
<a name="l00104"></a>00104                 <span class="keywordflow">break</span>;
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106         <span class="keywordflow">if</span> (target) <span class="keywordflow">break</span>;
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="comment">/* create a target */</span>
<a name="l00110"></a>00110     target= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a>), <span class="stringliteral">&quot;posetarget&quot;</span>);
<a name="l00111"></a>00111     target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>= con;
<a name="l00112"></a>00112     pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp;= ~<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <span class="keywordflow">if</span> (tree==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00115"></a>00115         <span class="comment">/* make new tree */</span>
<a name="l00116"></a>00116         tree= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>), <span class="stringliteral">&quot;posetree&quot;</span>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aadad99804657545c6b49e90725b3cdbe">type</a>= <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a>;
<a name="l00119"></a>00119         
<a name="l00120"></a>00120         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>= data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a3d450bd6c2b940c3528daf2cedec7cd3">iterations</a>;
<a name="l00121"></a>00121         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>= segcount;
<a name="l00122"></a>00122         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> = (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dac50fe615c0c820802234e6496ed59435">CONSTRAINT_IK_STRETCH</a>);
<a name="l00123"></a>00123         
<a name="l00124"></a>00124         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(segcount*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*), <span class="stringliteral">&quot;ik tree pchan&quot;</span>);
<a name="l00125"></a>00125         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(segcount*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ik tree parent&quot;</span>);
<a name="l00126"></a>00126         <span class="keywordflow">for</span> (a=0; a&lt;segcount; a++) {
<a name="l00127"></a>00127             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]= chanlist[segcount-a-1];
<a name="l00128"></a>00128             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a]= a-1;
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>= segcount-1;
<a name="l00131"></a>00131         
<a name="l00132"></a>00132         <span class="comment">/* AND! link the tree to the root */</span>
<a name="l00133"></a>00133         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <span class="keywordflow">else</span> {
<a name="l00136"></a>00136         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a3d450bd6c2b940c3528daf2cedec7cd3">iterations</a>, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>);
<a name="l00137"></a>00137         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a>= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; !(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dac50fe615c0c820802234e6496ed59435">CONSTRAINT_IK_STRETCH</a>);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <span class="comment">/* skip common pose channels and add remaining*/</span>
<a name="l00140"></a>00140         <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(segcount, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00141"></a>00141         a = t = 0;
<a name="l00142"></a>00142         <span class="keywordflow">while</span> (a&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> &amp;&amp; t&lt;tree-&gt;totchannel) {
<a name="l00143"></a>00143             <span class="comment">// locate first matching channel</span>
<a name="l00144"></a>00144             <span class="keywordflow">for</span> (;t&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> &amp;&amp; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[t]!=chanlist[segcount-a-1];t++);
<a name="l00145"></a>00145             <span class="keywordflow">if</span> (t&gt;=tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>)
<a name="l00146"></a>00146                 <span class="keywordflow">break</span>;
<a name="l00147"></a>00147             <span class="keywordflow">for</span> (; a&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> &amp;&amp; t&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> &amp;&amp; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[t]==chanlist[segcount-a-1]; a++, t++);
<a name="l00148"></a>00148         }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         segcount= segcount-a;
<a name="l00151"></a>00151         target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> + segcount - 1;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (segcount &gt; 0) {
<a name="l00154"></a>00154             <span class="keywordflow">for</span> (parent = a - 1; parent &lt; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; parent++)
<a name="l00155"></a>00155                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[parent] == chanlist[segcount-1]-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>)
<a name="l00156"></a>00156                     <span class="keywordflow">break</span>;
<a name="l00157"></a>00157             
<a name="l00158"></a>00158             <span class="comment">/* shouldn&#39;t happen, but could with dependency cycles */</span>
<a name="l00159"></a>00159             <span class="keywordflow">if</span> (parent == tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>)
<a name="l00160"></a>00160                 parent = a - 1;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162             <span class="comment">/* resize array */</span>
<a name="l00163"></a>00163             newsize= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> + segcount;
<a name="l00164"></a>00164             oldchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>;
<a name="l00165"></a>00165             oldparent= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(newsize*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*), <span class="stringliteral">&quot;ik tree pchan&quot;</span>);
<a name="l00168"></a>00168             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(newsize*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ik tree parent&quot;</span>);
<a name="l00169"></a>00169             memcpy(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>, oldchan, <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00170"></a>00170             memcpy(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>, oldparent, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00171"></a>00171             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(oldchan);
<a name="l00172"></a>00172             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(oldparent);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174             <span class="comment">/* add new pose channels at the end, in reverse order */</span>
<a name="l00175"></a>00175             <span class="keywordflow">for</span> (a=0; a&lt;segcount; a++) {
<a name="l00176"></a>00176                 tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a]= chanlist[segcount-a-1];
<a name="l00177"></a>00177                 tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a]= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a-1;
<a name="l00178"></a>00178             }
<a name="l00179"></a>00179             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>]= parent;
<a name="l00180"></a>00180             
<a name="l00181"></a>00181             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>= newsize;
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         <span class="comment">/* move tree to end of list, for correct evaluation order */</span>
<a name="l00185"></a>00185         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l00186"></a>00186         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="comment">/* add target to the tree */</span>
<a name="l00190"></a>00190     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>, target);
<a name="l00191"></a>00191     <span class="comment">/* mark root channel having an IK tree */</span>
<a name="l00192"></a>00192     pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a109821706241e25864cface202adbe0c">POSE_IKTREE</a>;
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="comment">/* transform from bone(b) to bone(b+1), store in chan_mat */</span>
<a name="l00197"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad1639801db4b8664d5de746380389bec">00197</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad1639801db4b8664d5de746380389bec">make_dmats</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00200"></a>00200         <span class="keywordtype">float</span> iR_parmat[4][4];
<a name="l00201"></a>00201         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(iR_parmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00202"></a>00202         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, iR_parmat,  pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>); <span class="comment">// delta mat</span>
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">/* applies IK matrix to pchan, IK is done separated */</span>
<a name="l00208"></a>00208 <span class="comment">/* formula: pose_mat(b) = pose_mat(b-1) * diffmat(b-1, b) * ik_mat(b) */</span>
<a name="l00209"></a>00209 <span class="comment">/* to make this work, the diffmats have to be precalculated! Stored in chan_mat */</span>
<a name="l00210"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a511744ce4058667cfa561e01dfd0b028">00210</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a511744ce4058667cfa561e01dfd0b028">where_is_ik_bone</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> ik_mat[][3])   <span class="comment">// nr = to detect if this is first bone</span>
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212     <span class="keywordtype">float</span> vec[3], ikmat[4][4];
<a name="l00213"></a>00213     
<a name="l00214"></a>00214     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(ikmat, ik_mat);
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>)
<a name="l00217"></a>00217         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, ikmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00218"></a>00218     <span class="keywordflow">else</span> 
<a name="l00219"></a>00219         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, ikmat);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">/* calculate head */</span>
<a name="l00222"></a>00222     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l00223"></a>00223     <span class="comment">/* calculate tail */</span>
<a name="l00224"></a>00224     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l00225"></a>00225     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>);
<a name="l00226"></a>00226     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, vec);
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="comment">/* called from within the core where_is_pose loop, all animsystems and constraints</span>
<a name="l00233"></a>00233 <span class="comment"> * were executed &amp; assigned. Now as last we do an IK pass */</span>
<a name="l00234"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a82c63ab371d161ec482d38d628de53e6">00234</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a82c63ab371d161ec482d38d628de53e6">execute_posetree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236     <span class="keywordtype">float</span> R_parmat[3][3], identity[3][3];
<a name="l00237"></a>00237     <span class="keywordtype">float</span> iR_parmat[3][3];
<a name="l00238"></a>00238     <span class="keywordtype">float</span> R_bonemat[3][3];
<a name="l00239"></a>00239     <span class="keywordtype">float</span> goalrot[3][3], goalpos[3];
<a name="l00240"></a>00240     <span class="keywordtype">float</span> rootmat[4][4], imat[4][4];
<a name="l00241"></a>00241     <span class="keywordtype">float</span> goal[4][4], goalinv[4][4];
<a name="l00242"></a>00242     <span class="keywordtype">float</span> irest_basis[3][3], full_basis[3][3];
<a name="l00243"></a>00243     <span class="keywordtype">float</span> end_pose[4][4], world_pose[4][4];
<a name="l00244"></a>00244     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>, basis[3][3], rest_basis[3][3], start[3], *ikstretch=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00245"></a>00245     <span class="keywordtype">float</span> resultinf=0.0f;
<a name="l00246"></a>00246     <span class="keywordtype">int</span> a, flag, hasstretch=0, resultblend=0;
<a name="l00247"></a>00247     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l00248"></a>00248     <a class="code" href="../../db/d54/IK__solver_8h.html#a5546ded22519f776cc8992021f268177">IK_Segment</a> *seg, *parent, **iktree, *iktarget;
<a name="l00249"></a>00249     <a class="code" href="../../db/d54/IK__solver_8h.html#af76f1cebfff40b16161a3ca9536dfb22">IK_Solver</a> *solver;
<a name="l00250"></a>00250     <a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a> *target;
<a name="l00251"></a>00251     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, *poleangledata=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00252"></a>00252     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> == 0)
<a name="l00255"></a>00255         <span class="keywordflow">return</span>;
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     iktree= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>, <span class="stringliteral">&quot;ik tree&quot;</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; a++) {
<a name="l00260"></a>00260         pchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a];
<a name="l00261"></a>00261         bone= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="comment">/* set DoF flag */</span>
<a name="l00264"></a>00264         flag= 0;
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2adc4ecbea32802d8aa298e2ed2b5211ae">BONE_IK_NO_XDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a4e55b43d7180c82640050d2e9b03082f">BONE_IK_NO_XDOF_TEMP</a>))
<a name="l00266"></a>00266             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>;
<a name="l00267"></a>00267         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2ab3f5e5869916e0ca2fb6186eb8041c08">BONE_IK_NO_YDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a2f52ff63ac04beb67f460392d4fce30f">BONE_IK_NO_YDOF_TEMP</a>))
<a name="l00268"></a>00268             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a59809ed69fd1b2cd42584c396d07fc39">BONE_IK_NO_ZDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a9f079be3942201545eb1797efaa56bdf">BONE_IK_NO_ZDOF_TEMP</a>))
<a name="l00270"></a>00270             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>;
<a name="l00271"></a>00271         
<a name="l00272"></a>00272         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a> &gt; 0.0f)) {
<a name="l00273"></a>00273             flag |= <a class="code" href="../../db/d54/IK__solver_8h.html#a7d8ed4938d862f03bc6c8e7b9c18be1bab98cdc99e6edd9e458ac110c5a19a3a8">IK_TRANS_YDOF</a>;
<a name="l00274"></a>00274             hasstretch = 1;
<a name="l00275"></a>00275         }
<a name="l00276"></a>00276         
<a name="l00277"></a>00277         seg= iktree[a]= <a class="code" href="../../db/d54/IK__solver_8h.html#a4531a16f7b93a57f1fdb21385d8ba6a6">IK_CreateSegment</a>(flag);
<a name="l00278"></a>00278         
<a name="l00279"></a>00279         <span class="comment">/* find parent */</span>
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (a == 0)
<a name="l00281"></a>00281             parent= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00282"></a>00282         <span class="keywordflow">else</span>
<a name="l00283"></a>00283             parent= iktree[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a]];
<a name="l00284"></a>00284             
<a name="l00285"></a>00285         <a class="code" href="../../db/d54/IK__solver_8h.html#a5714dad5206c1425c59857c7b06bd672">IK_SetParent</a>(seg, parent);
<a name="l00286"></a>00286             
<a name="l00287"></a>00287         <span class="comment">/* get the matrix that transforms from prevbone into this bone */</span>
<a name="l00288"></a>00288         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(R_bonemat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00289"></a>00289         
<a name="l00290"></a>00290         <span class="comment">/* gather transformations for this IK segment */</span>
<a name="l00291"></a>00291         
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>)
<a name="l00293"></a>00293             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(R_parmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00294"></a>00294         <span class="keywordflow">else</span>
<a name="l00295"></a>00295             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(R_parmat);
<a name="l00296"></a>00296         
<a name="l00297"></a>00297         <span class="comment">/* bone offset */</span>
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a> &amp;&amp; (a &gt; 0))
<a name="l00299"></a>00299             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(start, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00300"></a>00300         <span class="keywordflow">else</span>
<a name="l00301"></a>00301             <span class="comment">/* only root bone (a = 0) has no parent */</span>
<a name="l00302"></a>00302             start[0]= start[1]= start[2]= 0.0f;
<a name="l00303"></a>00303         
<a name="l00304"></a>00304         <span class="comment">/* change length based on bone size */</span>
<a name="l00305"></a>00305         length= bone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>*<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(R_bonemat[1]);
<a name="l00306"></a>00306         
<a name="l00307"></a>00307         <span class="comment">/* compute rest basis and its inverse */</span>
<a name="l00308"></a>00308         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(rest_basis, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l00309"></a>00309         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(irest_basis, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l00310"></a>00310         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(irest_basis);
<a name="l00311"></a>00311         
<a name="l00312"></a>00312         <span class="comment">/* compute basis with rest_basis removed */</span>
<a name="l00313"></a>00313         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(iR_parmat, R_parmat);
<a name="l00314"></a>00314         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(full_basis, iR_parmat, R_bonemat);
<a name="l00315"></a>00315         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(basis, irest_basis, full_basis);
<a name="l00316"></a>00316         
<a name="l00317"></a>00317         <span class="comment">/* basis must be pure rotation */</span>
<a name="l00318"></a>00318         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(basis);
<a name="l00319"></a>00319         
<a name="l00320"></a>00320         <span class="comment">/* transform offset into local bone space */</span>
<a name="l00321"></a>00321         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(iR_parmat);
<a name="l00322"></a>00322         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(iR_parmat, start);
<a name="l00323"></a>00323         
<a name="l00324"></a>00324         <a class="code" href="../../db/d54/IK__solver_8h.html#ab70cdbf36be24acf0173252c4cbf356a">IK_SetTransform</a>(seg, start, rest_basis, basis, length);
<a name="l00325"></a>00325         
<a name="l00326"></a>00326         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>)
<a name="l00327"></a>00327             <a class="code" href="../../db/d54/IK__solver_8h.html#a8d758867a086f0a86248f14d3d4671c0">IK_SetLimit</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da128300e03ded8f1055769a0d439e9ffb">IK_X</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[0], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[0]);
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2aaab5d511784c6381cd75b6f7e4df6118">BONE_IK_YLIMIT</a>)
<a name="l00329"></a>00329             <a class="code" href="../../db/d54/IK__solver_8h.html#a8d758867a086f0a86248f14d3d4671c0">IK_SetLimit</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dac78c8909dbd7e2b76b3e40face98f6a7">IK_Y</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[1], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[1]);
<a name="l00330"></a>00330         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>)
<a name="l00331"></a>00331             <a class="code" href="../../db/d54/IK__solver_8h.html#a8d758867a086f0a86248f14d3d4671c0">IK_SetLimit</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118daf89476f163eaafc9ffd20a1731fb01da">IK_Z</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[2], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[2]);
<a name="l00332"></a>00332         
<a name="l00333"></a>00333         <a class="code" href="../../db/d54/IK__solver_8h.html#ad23996ca64b240db717e699e9e955c20">IK_SetStiffness</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da128300e03ded8f1055769a0d439e9ffb">IK_X</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[0]);
<a name="l00334"></a>00334         <a class="code" href="../../db/d54/IK__solver_8h.html#ad23996ca64b240db717e699e9e955c20">IK_SetStiffness</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dac78c8909dbd7e2b76b3e40face98f6a7">IK_Y</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[1]);
<a name="l00335"></a>00335         <a class="code" href="../../db/d54/IK__solver_8h.html#ad23996ca64b240db717e699e9e955c20">IK_SetStiffness</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118daf89476f163eaafc9ffd20a1731fb01da">IK_Z</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[2]);
<a name="l00336"></a>00336         
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a> &gt; 0.0f)) {
<a name="l00338"></a>00338             <span class="keywordtype">float</span> ikstretch = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a>*pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a>;
<a name="l00339"></a>00339             <a class="code" href="../../db/d54/IK__solver_8h.html#ad23996ca64b240db717e699e9e955c20">IK_SetStiffness</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dadd53fa5ff654b6d4f5f8490ccae7e54f">IK_TRANS_Y</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(1.0f-ikstretch, 0.99f));
<a name="l00340"></a>00340             <a class="code" href="../../db/d54/IK__solver_8h.html#a8d758867a086f0a86248f14d3d4671c0">IK_SetLimit</a>(seg, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dadd53fa5ff654b6d4f5f8490ccae7e54f">IK_TRANS_Y</a>, 0.001, 1e10);
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     solver= <a class="code" href="../../db/d54/IK__solver_8h.html#a11af94d5519c008edcc96ec964a3219e">IK_CreateSolver</a>(iktree[0]);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="comment">/* set solver goals */</span>
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="comment">/* first set the goal inverse transform, assuming the root of tree was done ok! */</span>
<a name="l00349"></a>00349     pchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[0];
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00351"></a>00351         <span class="comment">/* transform goal by parent mat, so this rotation is not part of the</span>
<a name="l00352"></a>00352 <span class="comment">         * segment&#39;s basis. otherwise rotation limits do not work on the</span>
<a name="l00353"></a>00353 <span class="comment">         * local transform of the segment itself. */</span>
<a name="l00354"></a>00354         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rootmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00355"></a>00355         <span class="comment">/* However, we do not want to get (i.e. reverse) parent&#39;s scale, as it generates [#31008]</span>
<a name="l00356"></a>00356 <span class="comment">         * kind of nasty bugs... */</span>
<a name="l00357"></a>00357         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(rootmat);
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359     <span class="keywordflow">else</span>
<a name="l00360"></a>00360         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(rootmat);
<a name="l00361"></a>00361     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rootmat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, rootmat);
<a name="l00364"></a>00364     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(goalinv, imat);
<a name="l00365"></a>00365     
<a name="l00366"></a>00366     <span class="keywordflow">for</span> (target=tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; target; target=target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#a1f5f82018b1a259fc85d2010a4f8002c">next</a>) {
<a name="l00367"></a>00367         <span class="keywordtype">float</span> polepos[3];
<a name="l00368"></a>00368         <span class="keywordtype">int</span> poleconstrain= 0;
<a name="l00369"></a>00369         
<a name="l00370"></a>00370         data= (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00371"></a>00371         
<a name="l00372"></a>00372         <span class="comment">/* 1.0=ctime, we pass on object for auto-ik (owner-type here is object, even though</span>
<a name="l00373"></a>00373 <span class="comment">         * strictly speaking, it is a posechannel)</span>
<a name="l00374"></a>00374 <span class="comment">         */</span>
<a name="l00375"></a>00375         <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#aff661b9b70a11e24803d8f9ccb46bcba">get_constraint_target_matrix</a>(scene, target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>, 0, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#adfb54b57e8687ce7b32072d253bfde5ca80fce2faf62ad6f0acce0e3319b4b6c8">CONSTRAINT_OBTYPE_OBJECT</a>, ob, rootmat, 1.0);
<a name="l00376"></a>00376         
<a name="l00377"></a>00377         <span class="comment">/* and set and transform goal */</span>
<a name="l00378"></a>00378         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(goal, goalinv, rootmat);
<a name="l00379"></a>00379         
<a name="l00380"></a>00380         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(goalpos, goal[3]);
<a name="l00381"></a>00381         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(goalrot, goal);
<a name="l00382"></a>00382         
<a name="l00383"></a>00383         <span class="comment">/* same for pole vector target */</span>
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a4136315d7e8e716a0139e10e3a11e86e">poletar</a>) {
<a name="l00385"></a>00385             <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#aff661b9b70a11e24803d8f9ccb46bcba">get_constraint_target_matrix</a>(scene, target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>, 1, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#adfb54b57e8687ce7b32072d253bfde5ca80fce2faf62ad6f0acce0e3319b4b6c8">CONSTRAINT_OBTYPE_OBJECT</a>, ob, rootmat, 1.0);
<a name="l00386"></a>00386             
<a name="l00387"></a>00387             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da6dfeed784f22617ca65a9f9211ad32f5">CONSTRAINT_IK_SETANGLE</a>) {
<a name="l00388"></a>00388                 <span class="comment">/* don&#39;t solve IK when we are setting the pole angle */</span>
<a name="l00389"></a>00389                 <span class="keywordflow">break</span>;
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391             <span class="keywordflow">else</span> {
<a name="l00392"></a>00392                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(goal, goalinv, rootmat);
<a name="l00393"></a>00393                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(polepos, goal[3]);
<a name="l00394"></a>00394                 poleconstrain= 1;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396                 <span class="comment">/* for pole targets, we blend the result of the ik solver</span>
<a name="l00397"></a>00397 <span class="comment">                 * instead of the target position, otherwise we can&#39;t get</span>
<a name="l00398"></a>00398 <span class="comment">                 * a smooth transition */</span>
<a name="l00399"></a>00399                 resultblend= 1;
<a name="l00400"></a>00400                 resultinf= target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a>;
<a name="l00401"></a>00401                 
<a name="l00402"></a>00402                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da1ec4c67d38e8b4ee522863ddd369af99">CONSTRAINT_IK_GETANGLE</a>) {
<a name="l00403"></a>00403                     poleangledata= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00404"></a>00404                     data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp;= ~<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da1ec4c67d38e8b4ee522863ddd369af99">CONSTRAINT_IK_GETANGLE</a>;
<a name="l00405"></a>00405                 }
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="comment">/* do we need blending? */</span>
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (!resultblend &amp;&amp; target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> != 1.0f) {
<a name="l00411"></a>00411             <span class="keywordtype">float</span> q1[4], q2[4], q[4];
<a name="l00412"></a>00412             <span class="keywordtype">float</span> fac= target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a>;
<a name="l00413"></a>00413             <span class="keywordtype">float</span> mfac= 1.0f-fac;
<a name="l00414"></a>00414             
<a name="l00415"></a>00415             pchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>];
<a name="l00416"></a>00416             
<a name="l00417"></a>00417             <span class="comment">/* end effector in world space */</span>
<a name="l00418"></a>00418             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(end_pose, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00419"></a>00419             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(end_pose[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00420"></a>00420             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(world_pose, goalinv, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, end_pose, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00421"></a>00421             
<a name="l00422"></a>00422             <span class="comment">/* blend position */</span>
<a name="l00423"></a>00423             goalpos[0]= fac*goalpos[0] + mfac*world_pose[3][0];
<a name="l00424"></a>00424             goalpos[1]= fac*goalpos[1] + mfac*world_pose[3][1];
<a name="l00425"></a>00425             goalpos[2]= fac*goalpos[2] + mfac*world_pose[3][2];
<a name="l00426"></a>00426             
<a name="l00427"></a>00427             <span class="comment">/* blend rotation */</span>
<a name="l00428"></a>00428             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a176f538ccb9db7cc95d7699264508b26">mat3_to_quat</a>( q1,goalrot);
<a name="l00429"></a>00429             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad76b90158227d13beb93cf29952f78a9">mat4_to_quat</a>( q2,world_pose);
<a name="l00430"></a>00430             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aabc8b501c8bcfe8a37ecfc39661b07d9">interp_qt_qtqt</a>(q, q1, q2, mfac);
<a name="l00431"></a>00431             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ae0343d0ff2af81f054d3916277409507">quat_to_mat3</a>( goalrot,q);
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         
<a name="l00434"></a>00434         iktarget= iktree[target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>];
<a name="l00435"></a>00435         
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a> != 0.0f) {
<a name="l00437"></a>00437             <span class="keywordflow">if</span> (poleconstrain)
<a name="l00438"></a>00438                 <a class="code" href="../../db/d54/IK__solver_8h.html#a52afc3cbd9b8c8da38a4315526f6613a">IK_SolverSetPoleVectorConstraint</a>(solver, iktarget, goalpos,
<a name="l00439"></a>00439                     polepos, data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ab6b072b23e2bc6baf1be71d99ace2a3d">poleangle</a>, (poleangledata == data));
<a name="l00440"></a>00440             <a class="code" href="../../db/d54/IK__solver_8h.html#a91f09724394966cb9f404a145df0e8f4">IK_SolverAddGoal</a>(solver, iktarget, goalpos, data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a>);
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442         <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da0251808fa77e7c319acdfdfa82960545">CONSTRAINT_IK_ROT</a>) &amp;&amp; (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a9107cfb0638ca19451f437441612ecd9">orientweight</a> != 0.0f))
<a name="l00443"></a>00443             <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5daa615284f990351c298b824ea793e3b41">CONSTRAINT_IK_AUTO</a>)==0)
<a name="l00444"></a>00444                 <a class="code" href="../../db/d54/IK__solver_8h.html#a8a695d8d4b92d6348ca9ee70ccda3d80">IK_SolverAddGoalOrientation</a>(solver, iktarget, goalrot,
<a name="l00445"></a>00445                     data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a9107cfb0638ca19451f437441612ecd9">orientweight</a>);
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="comment">/* solve */</span>
<a name="l00449"></a>00449     <a class="code" href="../../db/d54/IK__solver_8h.html#aaee4a8d1e89b6505a557ff4731a6edd7">IK_Solve</a>(solver, 0.0f, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (poleangledata)
<a name="l00452"></a>00452         poleangledata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ab6b072b23e2bc6baf1be71d99ace2a3d">poleangle</a>= <a class="code" href="../../db/d54/IK__solver_8h.html#a222246f51628b707957a29dc2d9ca9c3">IK_SolverGetPoleAngle</a>(solver);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <a class="code" href="../../db/d54/IK__solver_8h.html#a595236c4c050e7c7bc14e2ce2b4c4574">IK_FreeSolver</a>(solver);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/* gather basis changes */</span>
<a name="l00457"></a>00457     tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>[3][3])*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>, <span class="stringliteral">&quot;ik basis change&quot;</span>);
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (hasstretch)
<a name="l00459"></a>00459         ikstretch= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>, <span class="stringliteral">&quot;ik stretch&quot;</span>);
<a name="l00460"></a>00460     
<a name="l00461"></a>00461     <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; a++) {
<a name="l00462"></a>00462         <a class="code" href="../../db/d54/IK__solver_8h.html#abe7622ec5bebd9722b1c3de3ccbf6ad9">IK_GetBasisChange</a>(iktree[a], tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a]);
<a name="l00463"></a>00463         
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (hasstretch) {
<a name="l00465"></a>00465             <span class="comment">/* have to compensate for scaling received from parent */</span>
<a name="l00466"></a>00466             <span class="keywordtype">float</span> parentstretch, stretch;
<a name="l00467"></a>00467             
<a name="l00468"></a>00468             pchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a];
<a name="l00469"></a>00469             parentstretch= (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a] &gt;= 0)? ikstretch[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a]]: 1.0f;
<a name="l00470"></a>00470             
<a name="l00471"></a>00471             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a> &gt; 0.0f)) {
<a name="l00472"></a>00472                 <span class="keywordtype">float</span> trans[3], <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00473"></a>00473                 
<a name="l00474"></a>00474                 <a class="code" href="../../db/d54/IK__solver_8h.html#ad48cffc3f8d9d52b235b43bde8127ec2">IK_GetTranslationChange</a>(iktree[a], trans);
<a name="l00475"></a>00475                 length= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>*<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l00476"></a>00476                 
<a name="l00477"></a>00477                 ikstretch[a]= (length == 0.0f)? 1.0f: (trans[1]+length)/<a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00478"></a>00478             }
<a name="l00479"></a>00479             <span class="keywordflow">else</span>
<a name="l00480"></a>00480                 ikstretch[a] = 1.0;
<a name="l00481"></a>00481             
<a name="l00482"></a>00482             stretch= (parentstretch == 0.0f)? 1.0f: ikstretch[a]/parentstretch;
<a name="l00483"></a>00483             
<a name="l00484"></a>00484             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a][0], stretch);
<a name="l00485"></a>00485             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a][1], stretch);
<a name="l00486"></a>00486             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a][2], stretch);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="keywordflow">if</span> (resultblend &amp;&amp; resultinf!=1.0f) {
<a name="l00490"></a>00490             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(identity);
<a name="l00491"></a>00491             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8a916135c9e8628915f66d640fdd8905">blend_m3_m3m3</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a], identity,
<a name="l00492"></a>00492                 tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a], resultinf);
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494         
<a name="l00495"></a>00495         <a class="code" href="../../db/d54/IK__solver_8h.html#a7d366fbf54a6a0df7c1d4f6aff3d9b88">IK_FreeSegment</a>(iktree[a]);
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497     
<a name="l00498"></a>00498     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(iktree);
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (ikstretch) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ikstretch);
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a320e07484b1c5125fad33f31f203d748">00502</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a320e07484b1c5125fad33f31f203d748">free_posetree</a>(<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>);
<a name="l00505"></a>00505     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>);
<a name="l00506"></a>00506     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>);
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>);
<a name="l00508"></a>00508     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00513"></a>00513 
<a name="l00514"></a><a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad70c97727763685c451ac9c943b4c6a3">00514</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad70c97727763685c451ac9c943b4c6a3">iksolver_initialize_tree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(scene), <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ctime))
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l00517"></a>00517     
<a name="l00518"></a>00518     <span class="keywordflow">for</span> (pchan= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l00519"></a>00519         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#abf27c9382f3dd90c6a03b2e8fd69d1fc">constflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#aa054ea9cc32895cc3299d8e9331ab3e8a946cee8332ffabf5684e8a57f5ba5a5d">PCHAN_HAS_IK</a>) <span class="comment">// flag is set on editing constraints</span>
<a name="l00520"></a>00520             <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad5451f6a937651b44d34a3589ded88ee">initialize_posetree</a>(ob, pchan); <span class="comment">// will attach it to root!</span>
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp;= ~<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da6a993a8c5630134f94de6f73c56e0882">POSE_WAS_REBUILT</a>;
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 
<a name="l00525"></a><a class="code" href="../../d1/dab/iksolver__plugin_8h.html#af6666f74e82cd7a36b556cd5f848b786">00525</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#af6666f74e82cd7a36b556cd5f848b786">iksolver_execute_tree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,  <span class="keyword">struct</span> <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> ctime)
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527     <span class="keywordflow">while</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00528"></a>00528         <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00529"></a>00529         <span class="keywordtype">int</span> a;
<a name="l00530"></a>00530         
<a name="l00531"></a>00531         <span class="comment">/* stop on the first tree that isn&#39;t a standard IK chain */</span>
<a name="l00532"></a>00532         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aadad99804657545c6b49e90725b3cdbe">type</a> != <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a>)
<a name="l00533"></a>00533             <span class="keywordflow">return</span>;
<a name="l00534"></a>00534         
<a name="l00535"></a>00535         <span class="comment">/* 4. walk over the tree for regular solving */</span>
<a name="l00536"></a>00536         <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; a++) {
<a name="l00537"></a>00537             <span class="keywordflow">if</span> (!(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>))    <span class="comment">// successive trees can set the flag</span>
<a name="l00538"></a>00538                 <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(scene, ob, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a], ctime, 1);
<a name="l00539"></a>00539             <span class="comment">// tell blender that this channel was controlled by IK, it&#39;s cleared on each where_is_pose()</span>
<a name="l00540"></a>00540             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>;
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542         <span class="comment">/* 5. execute the IK solver */</span>
<a name="l00543"></a>00543         <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a82c63ab371d161ec482d38d628de53e6">execute_posetree</a>(scene, ob, tree);
<a name="l00544"></a>00544         
<a name="l00545"></a>00545         <span class="comment">/* 6. apply the differences to the channels, </span>
<a name="l00546"></a>00546 <span class="comment">         *    we need to calculate the original differences first */</span>
<a name="l00547"></a>00547         <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; a++) {
<a name="l00548"></a>00548             <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#ad1639801db4b8664d5de746380389bec">make_dmats</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]);
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         
<a name="l00551"></a>00551         <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; a++) {
<a name="l00552"></a>00552             <span class="comment">/* sets POSE_DONE */</span>
<a name="l00553"></a>00553             <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a511744ce4058667cfa561e01dfd0b028">where_is_ik_bone</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a], tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>[a]);
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555         
<a name="l00556"></a>00556         <span class="comment">/* 7. and free */</span>
<a name="l00557"></a>00557         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l00558"></a>00558         <a class="code" href="../../d6/de8/iksolver__plugin_8c.html#a320e07484b1c5125fad33f31f203d748">free_posetree</a>(tree);
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:24 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
