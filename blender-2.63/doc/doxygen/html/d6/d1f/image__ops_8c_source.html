<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: image_ops.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">image_ops.c</div>  </div>
</div>
<div class="contents">
<a href="../../d6/d1f/image__ops_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Blender Foundation, 2002-2009, Xavier Thomas</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d4d/DNA__packedFile__types_8h.html">DNA_packedFile_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4a/BKE__packedFile_8h.html">BKE_packedFile.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da3/BKE__screen_8h.html">BKE_screen.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dfd/RE__pipeline_8h.html">RE_pipeline.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d68/RNA__enum__types_8h.html">RNA_enum_types.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d53/ED__image_8h.html">ED_image.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d53/ED__render_8h.html">ED_render.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d5f/ED__space__api_8h.html">ED_space_api.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d25/ED__uvedit_8h.html">ED_uvedit.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df1/ED__util_8h.html">ED_util.h</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d1e/UI__interface_8h.html">UI_interface.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/df9/image__intern_8h.html">image_intern.h</a>&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/******************** view navigation utilities *********************/</span>
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">00085</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(<a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> zoom, <span class="keywordtype">float</span> location[2])
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087     <span class="keywordtype">float</span> oldzoom = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00088"></a>00088     <span class="keywordtype">int</span> width, height;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> = zoom;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> &lt; 0.1f || sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> &gt; 4.0f) {
<a name="l00093"></a>00093         <span class="comment">/* check zoom limits */</span>
<a name="l00094"></a>00094         <a class="code" href="../../de/d53/ED__image_8h.html#a72aa9c6d1d329f0fce3b5c65b8698318">ED_space_image_size</a>(sima, &amp;width, &amp;height);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         width *= sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00097"></a>00097         height *= sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         <span class="keywordflow">if</span> ((width &lt; 4) &amp;&amp; (height &lt; 4))
<a name="l00100"></a>00100             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> = oldzoom;
<a name="l00101"></a>00101         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>) &lt;= sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>)
<a name="l00102"></a>00102             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> = oldzoom;
<a name="l00103"></a>00103         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>) &lt;= sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>)
<a name="l00104"></a>00104             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> = oldzoom;
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a9ad0e641c5a80e22dde1508ec99414c3">USER_ZOOM_TO_MOUSEPOS</a>) &amp;&amp; location) {
<a name="l00108"></a>00108         <span class="keywordtype">float</span> aspx, aspy, w, h;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <a class="code" href="../../de/d53/ED__image_8h.html#a72aa9c6d1d329f0fce3b5c65b8698318">ED_space_image_size</a>(sima, &amp;width, &amp;height);
<a name="l00111"></a>00111         <a class="code" href="../../de/d53/ED__image_8h.html#ab50505a62fe0f93b9735c90f41a1cfa7">ED_space_image_aspect</a>(sima, &amp;aspx, &amp;aspy);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         w = width * aspx;
<a name="l00114"></a>00114         h = height * aspy;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> += ((location[0] - 0.5f) * w - sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a>) * (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> - oldzoom) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00117"></a>00117         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> += ((location[1] - 0.5f) * h - sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a>) * (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> - oldzoom) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">00121</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">sima_zoom_set_factor</a>(<a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> zoomfac, <span class="keywordtype">float</span> location[2])
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> * zoomfac, location);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="preprocessor">#if 0 // currently unused</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> image_poll(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129     <span class="keywordflow">return</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 <span class="preprocessor">#endif</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span>
<a name="l00133"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">00133</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">space_image_buffer_exists_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (sima &amp;&amp; sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac89dd3ab24842953c3ec412d6498b231">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>)
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (<a class="code" href="../../de/d53/ED__image_8h.html#a46c45d788cc30a6e36c38cae18ed4f9c">ED_space_image_has_buffer</a>(sima))
<a name="l00138"></a>00138             <span class="keywordflow">return</span> 1;
<a name="l00139"></a>00139     <span class="keywordflow">return</span> 0;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a9d55ad97a968e7a31ddb6b3708c072d8">00142</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a9d55ad97a968e7a31ddb6b3708c072d8">space_image_file_exists_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">space_image_buffer_exists_poll</a>(C)) {
<a name="l00145"></a>00145         <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l00146"></a>00146         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00147"></a>00147         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00148"></a>00148         <span class="keywordtype">void</span> *lock;
<a name="l00149"></a>00149         <span class="keywordtype">int</span> ret = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00150"></a>00150         <span class="keywordtype">char</span> name[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00151"></a>00151 
<a name="l00152"></a>00152         ibuf = <a class="code" href="../../de/d53/ED__image_8h.html#a94a74feeb6fba43a3353a6948a49716c">ED_space_image_acquire_buffer</a>(sima, &amp;lock);
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (ibuf) {
<a name="l00154"></a>00154             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(name, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l00155"></a>00155             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(name, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(name) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00158"></a>00158                 <a class="code" href="../../df/d01/BKE__context_8h.html#adb80273514fd122e9b437f8849ced258">CTX_wm_operator_poll_msg_set</a>(C, <span class="stringliteral">&quot;image file not found&quot;</span>);
<a name="l00159"></a>00159             }
<a name="l00160"></a>00160             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a9a5202293b98474b3a9650b2034672bb">BLI_file_is_writable</a>(name) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00161"></a>00161                 <a class="code" href="../../df/d01/BKE__context_8h.html#adb80273514fd122e9b437f8849ced258">CTX_wm_operator_poll_msg_set</a>(C, <span class="stringliteral">&quot;image path can&#39;t be written to&quot;</span>);
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163             <span class="keywordflow">else</span> {
<a name="l00164"></a>00164                 ret = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00165"></a>00165             }
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167         <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="keywordflow">return</span> ret;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     <span class="keywordflow">return</span> 0;
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a164b38bde0dedd5a7e982434a71dc7f7">00174</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a164b38bde0dedd5a7e982434a71dc7f7">space_image_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (sima &amp;&amp; sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac89dd3ab24842953c3ec412d6498b231">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a> &amp;&amp; sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>)
<a name="l00178"></a>00178         <span class="keywordflow">return</span> 1;
<a name="l00179"></a>00179     <span class="keywordflow">return</span> 0;
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ac902f655a4574a6b6069d6e6ea857410">00182</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00185"></a>00185     <span class="comment">// XXX ARegion *ar= CTX_wm_region(C);</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (sima)
<a name="l00188"></a>00188         <span class="keywordflow">return</span> 1;  <span class="comment">// XXX (ar &amp;&amp; ar-&gt;type-&gt;regionid == RGN_TYPE_WINDOW);</span>
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     <span class="keywordflow">return</span> 0;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">/* For IMAGE_OT_curves_point_set to avoid sampling when in uv smooth mode */</span>
<a name="l00194"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a569e6b873dd54da912532431dfac2e59">00194</a> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a569e6b873dd54da912532431dfac2e59">space_image_main_area_not_uv_brush_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *toolsettings = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C)-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (sima &amp;&amp; !toolsettings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>)
<a name="l00200"></a>00200         <span class="keywordflow">return</span> 1;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">return</span> 0;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aede415ad04ee0ccc1b9fa7bbbe4eb0ab">00205</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aede415ad04ee0ccc1b9fa7bbbe4eb0ab">space_image_image_sample_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00208"></a>00208     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l00209"></a>00209     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *toolsettings = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C)-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (obedit) {
<a name="l00212"></a>00212         <span class="keywordflow">if</span> (<a class="code" href="../../de/d53/ED__image_8h.html#aee525c3a7616c34c0c52b485113b60db">ED_space_image_show_uvedit</a>(sima, obedit) &amp;&amp; (toolsettings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af7ce42dd5fcc7c52535ecc61842a7009">use_uv_sculpt</a>))
<a name="l00213"></a>00213             <span class="keywordflow">return</span> 0;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     <span class="keywordflow">return</span> <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>(C);
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 <span class="comment">/********************** view pan operator *********************/</span>
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/df0/structViewPanData.html">ViewPanData</a> {
<a name="l00220"></a>00220     <span class="keywordtype">float</span> <a class="code" href="../../d1/df0/structViewPanData.html#a9c5db557ca762a396766f1225930b94d">x</a>, <a class="code" href="../../d1/df0/structViewPanData.html#a27a209dc3f3146f4228d672c4effc25d">y</a>;
<a name="l00221"></a>00221     <span class="keywordtype">float</span> <a class="code" href="../../d1/df0/structViewPanData.html#a35a021bcb46781aa4e16d17e71c790d7">xof</a>, <a class="code" href="../../d1/df0/structViewPanData.html#ad6df46badb7f107e85cb332b7b795698">yof</a>;
<a name="l00222"></a>00222     <span class="keywordtype">int</span> <a class="code" href="../../d1/df0/structViewPanData.html#a544e13eac4de2124077c0c51c4cdca99">event_type</a>;
<a name="l00223"></a>00223 } <a class="code" href="../../d1/d43/clip__ops_8c.html#a3f4458ffb414f6e3ef631f5aeb8b3e20">ViewPanData</a>;
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a34ca0e3e8a34419ac3aaf65c6806e985">00225</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a34ca0e3e8a34419ac3aaf65c6806e985">image_view_pan_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00228"></a>00228     <a class="code" href="../../d1/df0/structViewPanData.html">ViewPanData</a> *vpd;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = vpd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/df0/structViewPanData.html">ViewPanData</a>), <span class="stringliteral">&quot;ImageViewPanData&quot;</span>);
<a name="l00231"></a>00231     <a class="code" href="../../de/d3c/wm__cursors_8c.html#a04d16b0d6c38bc563f9d78f47f1ba7ed">WM_cursor_modal</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), <a class="code" href="../../db/da6/wm__cursors_8h.html#a737c1bdca78a4eec48fa026fcca3dd9baaa57a16b408a2323b90a0c1ab099c6ab">BC_NSEW_SCROLLCURSOR</a>);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a9c5db557ca762a396766f1225930b94d">x</a> = <span class="keyword">event</span>-&gt;x;
<a name="l00234"></a>00234     vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a27a209dc3f3146f4228d672c4effc25d">y</a> = <span class="keyword">event</span>-&gt;y;
<a name="l00235"></a>00235     vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a35a021bcb46781aa4e16d17e71c790d7">xof</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a>;
<a name="l00236"></a>00236     vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#ad6df46badb7f107e85cb332b7b795698">yof</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a>;
<a name="l00237"></a>00237     vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a544e13eac4de2124077c0c51c4cdca99">event_type</a> = <span class="keyword">event</span>-&gt;type;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#abc11023bf1d74a0b153e03eabeb9d144">00242</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#abc11023bf1d74a0b153e03eabeb9d144">image_view_pan_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <span class="keywordtype">int</span> cancel)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00245"></a>00245     <a class="code" href="../../d1/df0/structViewPanData.html">ViewPanData</a> *vpd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (cancel) {
<a name="l00248"></a>00248         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> = vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a35a021bcb46781aa4e16d17e71c790d7">xof</a>;
<a name="l00249"></a>00249         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> = vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#ad6df46badb7f107e85cb332b7b795698">yof</a>;
<a name="l00250"></a>00250         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ab8500ccfbffb6b57f4e0645e0f9a4759">WM_cursor_restore</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C));
<a name="l00254"></a>00254     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 
<a name="l00257"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#abae25f6e6951751e2363544a6593b4e1">00257</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#abae25f6e6951751e2363544a6593b4e1">image_view_pan_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00260"></a>00260     <span class="keywordtype">float</span> offset[2];
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;offset&quot;</span>, offset);
<a name="l00263"></a>00263     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> += offset[0];
<a name="l00264"></a>00264     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> += offset[1];
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">/* XXX notifier? */</span>
<a name="l00269"></a>00269 <span class="preprocessor">#if 0</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (image_preview_active(curarea, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00271"></a>00271         <span class="comment">/* recalculates new preview rect */</span>
<a name="l00272"></a>00272         scrarea_do_windraw(curarea);
<a name="l00273"></a>00273         image_preview_event(2);
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275 <span class="preprocessor">#endif</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>    
<a name="l00277"></a>00277     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a63071fe3d3829f1dcc605bf220ea9aba">00280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a63071fe3d3829f1dcc605bf220ea9aba">image_view_pan_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a65f114370656971c14863717d5364176">MOUSEPAN</a>) {
<a name="l00283"></a>00283         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00284"></a>00284         <span class="keywordtype">float</span> offset[2];
<a name="l00285"></a>00285         
<a name="l00286"></a>00286         offset[0] = (<span class="keyword">event</span>-&gt;x - <span class="keyword">event</span>-&gt;prevx) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00287"></a>00287         offset[1] = (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a1f9bfd9ad3dda5768a94bad7a3c3fc1e">y</a> - event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aa3a33c2ca6525fb33d25b67e50bea0eb">prevy</a>) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00288"></a>00288         <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;offset&quot;</span>, offset);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290         <a class="code" href="../../d6/d1f/image__ops_8c.html#abae25f6e6951751e2363544a6593b4e1">image_view_pan_exec</a>(C, op);
<a name="l00291"></a>00291         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     <span class="keywordflow">else</span> {
<a name="l00294"></a>00294         <a class="code" href="../../d6/d1f/image__ops_8c.html#a34ca0e3e8a34419ac3aaf65c6806e985">image_view_pan_init</a>(C, op, event);
<a name="l00295"></a>00295         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a960f0900acedae2e5075b63185605f2e">00299</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a960f0900acedae2e5075b63185605f2e">image_view_pan_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00302"></a>00302     <a class="code" href="../../d1/df0/structViewPanData.html">ViewPanData</a> *vpd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l00303"></a>00303     <span class="keywordtype">float</span> offset[2];
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l00306"></a>00306         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l00307"></a>00307             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> = vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a35a021bcb46781aa4e16d17e71c790d7">xof</a>;
<a name="l00308"></a>00308             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> = vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#ad6df46badb7f107e85cb332b7b795698">yof</a>;
<a name="l00309"></a>00309             offset[0] = (vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a9c5db557ca762a396766f1225930b94d">x</a> - <span class="keyword">event</span>-&gt;x) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00310"></a>00310             offset[1] = (vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a27a209dc3f3146f4228d672c4effc25d">y</a> - event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a1f9bfd9ad3dda5768a94bad7a3c3fc1e">y</a>) / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00311"></a>00311             <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;offset&quot;</span>, offset);
<a name="l00312"></a>00312             <a class="code" href="../../d6/d1f/image__ops_8c.html#abae25f6e6951751e2363544a6593b4e1">image_view_pan_exec</a>(C, op);
<a name="l00313"></a>00313             <span class="keywordflow">break</span>;
<a name="l00314"></a>00314         <span class="keywordflow">default</span>:
<a name="l00315"></a>00315             <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == vpd-&gt;<a class="code" href="../../d1/df0/structViewPanData.html#a544e13eac4de2124077c0c51c4cdca99">event_type</a> &amp;&amp;  event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a4ce6386082cecfa0645ced2216d04172">val</a> == <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>) {
<a name="l00316"></a>00316                 <a class="code" href="../../d6/d1f/image__ops_8c.html#abc11023bf1d74a0b153e03eabeb9d144">image_view_pan_exit</a>(C, op, 0);
<a name="l00317"></a>00317                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00318"></a>00318             }
<a name="l00319"></a>00319             <span class="keywordflow">break</span>;
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a8d9fc0c225bfcac68b939b5bd157dbf0">00325</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a8d9fc0c225bfcac68b939b5bd157dbf0">image_view_pan_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <a class="code" href="../../d6/d1f/image__ops_8c.html#abc11023bf1d74a0b153e03eabeb9d144">image_view_pan_exit</a>(C, op, 1);
<a name="l00328"></a>00328     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a70dd4dbb08b395ac0e848be60f8fd26e">00331</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a495031f9054e913119831910125320ae">IMAGE_OT_view_pan</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <span class="comment">/* identifiers */</span>
<a name="l00334"></a>00334     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Pan&quot;</span>;
<a name="l00335"></a>00335     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_pan&quot;</span>;
<a name="l00336"></a>00336     
<a name="l00337"></a>00337     <span class="comment">/* api callbacks */</span>
<a name="l00338"></a>00338     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#abae25f6e6951751e2363544a6593b4e1">image_view_pan_exec</a>;
<a name="l00339"></a>00339     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a63071fe3d3829f1dcc605bf220ea9aba">image_view_pan_invoke</a>;
<a name="l00340"></a>00340     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a960f0900acedae2e5075b63185605f2e">image_view_pan_modal</a>;
<a name="l00341"></a>00341     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a8d9fc0c225bfcac68b939b5bd157dbf0">image_view_pan_cancel</a>;
<a name="l00342"></a>00342     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="comment">/* flags */</span>
<a name="l00345"></a>00345     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#ac9470de8419174a032e9097a5ec317fd">OPTYPE_GRAB_POINTER</a>;
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     <span class="comment">/* properties */</span>
<a name="l00348"></a>00348     <a class="code" href="../../dc/d7e/rna__define_8c.html#a60e910dcfdccf2a1ede6471837912011">RNA_def_float_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;offset&quot;</span>, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>,
<a name="l00349"></a>00349                          <span class="stringliteral">&quot;Offset&quot;</span>, <span class="stringliteral">&quot;Offset in floating point units, 1.0 is the width and height of the image&quot;</span>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>);
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="comment">/********************** view zoom operator *********************/</span>
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d91/structViewZoomData.html">ViewZoomData</a> {
<a name="l00355"></a>00355     <span class="keywordtype">float</span> <a class="code" href="../../d2/d91/structViewZoomData.html#aad1f814bd24d88c4a3b0b20a7ff65ffd">x</a>, <a class="code" href="../../d2/d91/structViewZoomData.html#a64f4186359ba230fcf9e9e7cdca63342">y</a>;
<a name="l00356"></a>00356     <span class="keywordtype">float</span> <a class="code" href="../../d2/d91/structViewZoomData.html#ae0a9794b741afb38cbed5ac588fe3d26">zoom</a>;
<a name="l00357"></a>00357     <span class="keywordtype">int</span> <a class="code" href="../../d2/d91/structViewZoomData.html#afa2ba91222696bc4ee46a857f98fb134">event_type</a>;
<a name="l00358"></a>00358     <span class="keywordtype">float</span> <a class="code" href="../../d2/d91/structViewZoomData.html#a1e57a57f258a65324c5051c39a7a7329">location</a>[2];
<a name="l00359"></a>00359 } <a class="code" href="../../d1/d43/clip__ops_8c.html#a35e600d7dda2402a8c45afa3c3299ff5">ViewZoomData</a>;
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a903f58cc7e9f896b8dc037ba4395c4ca">00361</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a903f58cc7e9f896b8dc037ba4395c4ca">image_view_zoom_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00364"></a>00364     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00365"></a>00365     <a class="code" href="../../d2/d91/structViewZoomData.html">ViewZoomData</a> *vpd;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = vpd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d91/structViewZoomData.html">ViewZoomData</a>), <span class="stringliteral">&quot;ImageViewZoomData&quot;</span>);
<a name="l00368"></a>00368     <a class="code" href="../../de/d3c/wm__cursors_8c.html#a04d16b0d6c38bc563f9d78f47f1ba7ed">WM_cursor_modal</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), <a class="code" href="../../db/da6/wm__cursors_8h.html#a737c1bdca78a4eec48fa026fcca3dd9baaa57a16b408a2323b90a0c1ab099c6ab">BC_NSEW_SCROLLCURSOR</a>);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#aad1f814bd24d88c4a3b0b20a7ff65ffd">x</a> = <span class="keyword">event</span>-&gt;x;
<a name="l00371"></a>00371     vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#a64f4186359ba230fcf9e9e7cdca63342">y</a> = <span class="keyword">event</span>-&gt;y;
<a name="l00372"></a>00372     vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#ae0a9794b741afb38cbed5ac588fe3d26">zoom</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00373"></a>00373     vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#afa2ba91222696bc4ee46a857f98fb134">event_type</a> = <span class="keyword">event</span>-&gt;type;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1], &amp;vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#a1e57a57f258a65324c5051c39a7a7329">location</a>[0], &amp;vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#a1e57a57f258a65324c5051c39a7a7329">location</a>[1]);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a5e2fbc1fa43622880f1867817ed7b8b1">00380</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a5e2fbc1fa43622880f1867817ed7b8b1">image_view_zoom_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <span class="keywordtype">int</span> cancel)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00383"></a>00383     <a class="code" href="../../d2/d91/structViewZoomData.html">ViewZoomData</a> *vpd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="keywordflow">if</span> (cancel) {
<a name="l00386"></a>00386         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> = vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#ae0a9794b741afb38cbed5ac588fe3d26">zoom</a>;
<a name="l00387"></a>00387         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ab8500ccfbffb6b57f4e0645e0f9a4759">WM_cursor_restore</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C));
<a name="l00391"></a>00391     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4519ac69aabf21d930fe6e422b92ad2b">00394</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a4519ac69aabf21d930fe6e422b92ad2b">image_view_zoom_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00397"></a>00397     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">sima_zoom_set_factor</a>(sima, ar, <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;factor&quot;</span>), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">/* XXX notifier? */</span>
<a name="l00404"></a>00404 <span class="preprocessor">#if 0</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (image_preview_active(curarea, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00406"></a>00406         <span class="comment">/* recalculates new preview rect */</span>
<a name="l00407"></a>00407         scrarea_do_windraw(curarea);
<a name="l00408"></a>00408         image_preview_event(2);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410 <span class="preprocessor">#endif</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>    
<a name="l00412"></a>00412     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a94bec0b65748ff1845bfa5e4e8cb5e4e">00415</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a94bec0b65748ff1845bfa5e4e8cb5e4e">image_view_zoom_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a87d179409a17bb20a1c248c84b170b55">MOUSEZOOM</a>) {
<a name="l00418"></a>00418         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00419"></a>00419         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00420"></a>00420         <span class="keywordtype">float</span> factor, location[2];
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1], &amp;location[0], &amp;location[1]);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         factor = 1.0f + (<span class="keyword">event</span>-&gt;x - <span class="keyword">event</span>-&gt;prevx + <span class="keyword">event</span>-&gt;y - <span class="keyword">event</span>-&gt;prevy) / 300.0f;
<a name="l00425"></a>00425         <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;factor&quot;</span>, factor);
<a name="l00426"></a>00426         <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a> * factor, location);
<a name="l00427"></a>00427         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00428"></a>00428         
<a name="l00429"></a>00429         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     <span class="keywordflow">else</span> {
<a name="l00432"></a>00432         <a class="code" href="../../d6/d1f/image__ops_8c.html#a903f58cc7e9f896b8dc037ba4395c4ca">image_view_zoom_init</a>(C, op, event);
<a name="l00433"></a>00433         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a588b443a7305990cb7ad4dc9e362730d">00437</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a588b443a7305990cb7ad4dc9e362730d">image_view_zoom_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00440"></a>00440     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00441"></a>00441     <a class="code" href="../../d2/d91/structViewZoomData.html">ViewZoomData</a> *vpd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l00442"></a>00442     <span class="keywordtype">float</span> factor;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l00445"></a>00445         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l00446"></a>00446             factor = 1.0f + (vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#aad1f814bd24d88c4a3b0b20a7ff65ffd">x</a> - <span class="keyword">event</span>-&gt;x + vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#a64f4186359ba230fcf9e9e7cdca63342">y</a> - <span class="keyword">event</span>-&gt;y) / 300.0f;
<a name="l00447"></a>00447             <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;factor&quot;</span>, factor);
<a name="l00448"></a>00448             <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#ae0a9794b741afb38cbed5ac588fe3d26">zoom</a> * factor, vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#a1e57a57f258a65324c5051c39a7a7329">location</a>);
<a name="l00449"></a>00449             <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00450"></a>00450             <span class="keywordflow">break</span>;
<a name="l00451"></a>00451         <span class="keywordflow">default</span>:
<a name="l00452"></a>00452             <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == vpd-&gt;<a class="code" href="../../d2/d91/structViewZoomData.html#afa2ba91222696bc4ee46a857f98fb134">event_type</a> &amp;&amp; event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a4ce6386082cecfa0645ced2216d04172">val</a> == <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>) {
<a name="l00453"></a>00453                 <a class="code" href="../../d6/d1f/image__ops_8c.html#a5e2fbc1fa43622880f1867817ed7b8b1">image_view_zoom_exit</a>(C, op, 0);
<a name="l00454"></a>00454                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00455"></a>00455             }
<a name="l00456"></a>00456             <span class="keywordflow">break</span>;
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a5c7781a1cb0ad10e78f2b33d21dc6ed0">00462</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a5c7781a1cb0ad10e78f2b33d21dc6ed0">image_view_zoom_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464     <a class="code" href="../../d6/d1f/image__ops_8c.html#a5e2fbc1fa43622880f1867817ed7b8b1">image_view_zoom_exit</a>(C, op, 1);
<a name="l00465"></a>00465     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a143b1c2c3332c418c1ffa8cb6ecf4ae5">00468</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#ab93132b12fa3f3c83410946b57a0e81d">IMAGE_OT_view_zoom</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00469"></a>00469 {
<a name="l00470"></a>00470     <span class="comment">/* identifiers */</span>
<a name="l00471"></a>00471     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Zoom&quot;</span>;
<a name="l00472"></a>00472     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_zoom&quot;</span>;
<a name="l00473"></a>00473     
<a name="l00474"></a>00474     <span class="comment">/* api callbacks */</span>
<a name="l00475"></a>00475     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a4519ac69aabf21d930fe6e422b92ad2b">image_view_zoom_exec</a>;
<a name="l00476"></a>00476     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a94bec0b65748ff1845bfa5e4e8cb5e4e">image_view_zoom_invoke</a>;
<a name="l00477"></a>00477     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a588b443a7305990cb7ad4dc9e362730d">image_view_zoom_modal</a>;
<a name="l00478"></a>00478     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a5c7781a1cb0ad10e78f2b33d21dc6ed0">image_view_zoom_cancel</a>;
<a name="l00479"></a>00479     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="comment">/* flags */</span>
<a name="l00482"></a>00482     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l00483"></a>00483     
<a name="l00484"></a>00484     <span class="comment">/* properties */</span>
<a name="l00485"></a>00485     <a class="code" href="../../dc/d7e/rna__define_8c.html#a040f4b08fc87a45a90e2291382e27f75">RNA_def_float</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;factor&quot;</span>, 0.0f, 0.0f, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>,
<a name="l00486"></a>00486                   <span class="stringliteral">&quot;Factor&quot;</span>, <span class="stringliteral">&quot;Zoom factor, values higher than 1.0 zoom in, lower values zoom out&quot;</span>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>);
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="comment">/********************** NDOF operator *********************/</span>
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">/* Combined pan/zoom from a 3D mouse device.</span>
<a name="l00492"></a>00492 <span class="comment"> * Z zooms, XY pans</span>
<a name="l00493"></a>00493 <span class="comment"> * &quot;view&quot; (not &quot;paper&quot;) control -- user moves the viewpoint, not the image being viewed</span>
<a name="l00494"></a>00494 <span class="comment"> * that explains the negative signs in the code below</span>
<a name="l00495"></a>00495 <span class="comment"> */</span>
<a name="l00496"></a>00496 
<a name="l00497"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aedecf9c2cbb098155a5cb2224e3376a3">00497</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aedecf9c2cbb098155a5cb2224e3376a3">image_view_ndof_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op), <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> != <a class="code" href="../../d1/d40/wm__event__types_8h.html#a923a119e6e59562806b30dd6a899d19f">NDOF_MOTION</a>)
<a name="l00500"></a>00500         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00501"></a>00501     <span class="keywordflow">else</span> {
<a name="l00502"></a>00502         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00503"></a>00503         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <a class="code" href="../../d8/d66/structwmNDOFMotionData.html">wmNDOFMotionData</a> *ndof = (<a class="code" href="../../d8/d66/structwmNDOFMotionData.html">wmNDOFMotionData</a> *) event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#afe8f2bc4e7e67063e0e2a92b08056c17">customdata</a>;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="keywordtype">float</span> dt = ndof-&gt;<a class="code" href="../../d8/d66/structwmNDOFMotionData.html#aa8200706e79acb437464a7df7d8a6511">dt</a>;
<a name="l00508"></a>00508         <span class="comment">/* tune these until it feels right */</span>
<a name="l00509"></a>00509         <span class="keyword">const</span> <span class="keywordtype">float</span> zoom_sensitivity = 0.5f; <span class="comment">// 50% per second (I think)</span>
<a name="l00510"></a>00510         <span class="keyword">const</span> <span class="keywordtype">float</span> pan_sensitivity = 300.f; <span class="comment">// screen pixels per second</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <span class="keywordtype">float</span> pan_x = pan_sensitivity * dt * ndof-&gt;<a class="code" href="../../d8/d66/structwmNDOFMotionData.html#a1d0d279bbd150c93e85bb57d0fef03a7">tvec</a>[0] / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00513"></a>00513         <span class="keywordtype">float</span> pan_y = pan_sensitivity * dt * ndof-&gt;<a class="code" href="../../d8/d66/structwmNDOFMotionData.html#a1d0d279bbd150c93e85bb57d0fef03a7">tvec</a>[1] / sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a98628e234e7021c524f7ad57306d782f">zoom</a>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         <span class="comment">/* &quot;mouse zoom&quot; factor = 1 + (dx + dy) / 300</span>
<a name="l00516"></a>00516 <span class="comment">         * what about &quot;ndof zoom&quot; factor? should behave like this:</span>
<a name="l00517"></a>00517 <span class="comment">         * at rest -&gt; factor = 1</span>
<a name="l00518"></a>00518 <span class="comment">         * move forward -&gt; factor &gt; 1</span>
<a name="l00519"></a>00519 <span class="comment">         * move backward -&gt; factor &lt; 1</span>
<a name="l00520"></a>00520 <span class="comment">         */</span>
<a name="l00521"></a>00521         <span class="keywordtype">float</span> zoom_factor = 1.f + zoom_sensitivity * dt * -ndof-&gt;<a class="code" href="../../d8/d66/structwmNDOFMotionData.html#a1d0d279bbd150c93e85bb57d0fef03a7">tvec</a>[2];
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.ndof_flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a9cfe1db3e8ce7fdcb78f221ce6bf07fc">NDOF_ZOOM_INVERT</a>)
<a name="l00524"></a>00524             zoom_factor = -zoom_factor;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526         <a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">sima_zoom_set_factor</a>(sima, ar, zoom_factor, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00527"></a>00527         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> += pan_x;
<a name="l00528"></a>00528         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> += pan_y;
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(ar);   
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ab8fbd10316ca36908d97c73fddac3fa8">00536</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a206816746e4b405adfedfd979611a1ad">IMAGE_OT_view_ndof</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538     <span class="comment">/* identifiers */</span>
<a name="l00539"></a>00539     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;NDOF Pan/Zoom&quot;</span>;
<a name="l00540"></a>00540     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_ndof&quot;</span>;
<a name="l00541"></a>00541     
<a name="l00542"></a>00542     <span class="comment">/* api callbacks */</span>
<a name="l00543"></a>00543     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#aedecf9c2cbb098155a5cb2224e3376a3">image_view_ndof_invoke</a>;
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="comment">/********************** view all operator *********************/</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="comment">/* Updates the fields of the View2D member of the SpaceImage struct.</span>
<a name="l00549"></a>00549 <span class="comment"> * Default behavior is to reset the position of the image and set the zoom to 1</span>
<a name="l00550"></a>00550 <span class="comment"> * If the image will not fit within the window rectangle, the zoom is adjusted */</span>
<a name="l00551"></a>00551 
<a name="l00552"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a0ca7f622d2b95c8262da56291e7c047c">00552</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a0ca7f622d2b95c8262da56291e7c047c">image_view_all_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima;
<a name="l00555"></a>00555     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar;
<a name="l00556"></a>00556     <span class="keywordtype">float</span> aspx, aspy, zoomx, zoomy, w, h;
<a name="l00557"></a>00557     <span class="keywordtype">int</span> width, height;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     <span class="comment">/* retrieve state */</span>
<a name="l00560"></a>00560     sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00561"></a>00561     ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <a class="code" href="../../de/d53/ED__image_8h.html#a72aa9c6d1d329f0fce3b5c65b8698318">ED_space_image_size</a>(sima, &amp;width, &amp;height);
<a name="l00564"></a>00564     <a class="code" href="../../de/d53/ED__image_8h.html#ab50505a62fe0f93b9735c90f41a1cfa7">ED_space_image_aspect</a>(sima, &amp;aspx, &amp;aspy);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     w = width * aspx;
<a name="l00567"></a>00567     h = height * aspy;
<a name="l00568"></a>00568     
<a name="l00569"></a>00569     <span class="comment">/* check if the image will fit in the image with zoom==1 */</span>
<a name="l00570"></a>00570     width = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> + 1;
<a name="l00571"></a>00571     height = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> + 1;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="keywordflow">if</span> ((w &gt;= width || h &gt;= height) &amp;&amp; (width &gt; 0 &amp;&amp; height &gt; 0)) {
<a name="l00574"></a>00574         <span class="comment">/* find the zoom value that will fit the image in the image space */</span>
<a name="l00575"></a>00575         zoomx = width / w;
<a name="l00576"></a>00576         zoomy = height / h;
<a name="l00577"></a>00577         <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, 1.0f / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aabd145f96ccab2e9e3675d7883b0acb2">power_of_2</a>(1 / <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(zoomx, zoomy)), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579     <span class="keywordflow">else</span>
<a name="l00580"></a>00580         <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, 1.0f, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> = 0.0f;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00585"></a>00585     
<a name="l00586"></a>00586     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a69fc95743bb19626a635bc6349da1f77">00589</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#aaa7d9c90db710afd82bb05728b38c8f5">IMAGE_OT_view_all</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591     <span class="comment">/* identifiers */</span>
<a name="l00592"></a>00592     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View All&quot;</span>;
<a name="l00593"></a>00593     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_all&quot;</span>;
<a name="l00594"></a>00594     
<a name="l00595"></a>00595     <span class="comment">/* api callbacks */</span>
<a name="l00596"></a>00596     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a0ca7f622d2b95c8262da56291e7c047c">image_view_all_exec</a>;
<a name="l00597"></a>00597     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00598"></a>00598 }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="comment">/********************** view selected operator *********************/</span>
<a name="l00601"></a>00601 
<a name="l00602"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a7cd33e1ce617a7c8fb0a75f84d3da8cf">00602</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a7cd33e1ce617a7c8fb0a75f84d3da8cf">image_view_selected_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima;
<a name="l00605"></a>00605     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar;
<a name="l00606"></a>00606     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l00607"></a>00607     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit;
<a name="l00608"></a>00608     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00609"></a>00609     <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[2], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[2], d[2], aspx, aspy;
<a name="l00610"></a>00610     <span class="keywordtype">int</span> width, height;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="comment">/* retrieve state */</span>
<a name="l00613"></a>00613     sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00614"></a>00614     ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00615"></a>00615     scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00616"></a>00616     obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     ima = <a class="code" href="../../de/d53/ED__image_8h.html#a8ad18e26f8f83222010f6781a1f51a7c">ED_space_image</a>(sima);
<a name="l00619"></a>00619     <a class="code" href="../../de/d53/ED__image_8h.html#a72aa9c6d1d329f0fce3b5c65b8698318">ED_space_image_size</a>(sima, &amp;width, &amp;height);
<a name="l00620"></a>00620     <a class="code" href="../../de/d53/ED__image_8h.html#a6feef99a8c1c5ceab60f5565875ac950">ED_image_aspect</a>(ima, &amp;aspx, &amp;aspy);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     width = width * aspx;
<a name="l00623"></a>00623     height = height * aspy;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="comment">/* get bounds */</span>
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d25/ED__uvedit_8h.html#ac4155a041454def318319fb2c3cbbf72">ED_uvedit_minmax</a>(scene, ima, obedit, min, max))
<a name="l00627"></a>00627         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     <span class="comment">/* adjust offset and zoom */</span>
<a name="l00630"></a>00630     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> = (int)(((min[0] + max[0]) * 0.5f - 0.5f) * width);
<a name="l00631"></a>00631     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> = (int)(((min[1] + max[1]) * 0.5f - 0.5f) * height);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     d[0] = max[0] - min[0];
<a name="l00634"></a>00634     d[1] = max[1] - min[1];
<a name="l00635"></a>00635     size = 0.5f * <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(d[0], d[1]) * <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(width, height) / 256.0f;
<a name="l00636"></a>00636     
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (size &lt;= 0.01f) size = 0.01f;
<a name="l00638"></a>00638     <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, 0.7f / size, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00641"></a>00641     
<a name="l00642"></a>00642     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a37b15df9daf0fd62796e6fd2e20e43d9">00645</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a37b15df9daf0fd62796e6fd2e20e43d9">image_view_selected_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647     <span class="keywordflow">return</span> (<a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>(C) &amp;&amp; <a class="code" href="../../d1/d12/ED__screen_8h.html#a93d6c73a0c87af45aaa6d41e2b3cba34">ED_operator_uvedit</a>(C));
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a549c4f75476f84f54d1b0cb4fe581547">00650</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a5d696abfc1e2d1083024454964e18067">IMAGE_OT_view_selected</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="comment">/* identifiers */</span>
<a name="l00653"></a>00653     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Center&quot;</span>;
<a name="l00654"></a>00654     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_selected&quot;</span>;
<a name="l00655"></a>00655     
<a name="l00656"></a>00656     <span class="comment">/* api callbacks */</span>
<a name="l00657"></a>00657     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a7cd33e1ce617a7c8fb0a75f84d3da8cf">image_view_selected_exec</a>;
<a name="l00658"></a>00658     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a37b15df9daf0fd62796e6fd2e20e43d9">image_view_selected_poll</a>;
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 <span class="comment">/********************** view zoom in/out operator *********************/</span>
<a name="l00662"></a>00662 
<a name="l00663"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a46d0b3e4b103fdc6e24d78ed1e2b78bb">00663</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a46d0b3e4b103fdc6e24d78ed1e2b78bb">image_view_zoom_in_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00666"></a>00666     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00667"></a>00667     <span class="keywordtype">float</span> location[2];
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     <a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">sima_zoom_set_factor</a>(sima, ar, 1.25f, location);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00674"></a>00674     
<a name="l00675"></a>00675     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a7daa6083a7dc69e4d3163dea07876cb9">00678</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a7daa6083a7dc69e4d3163dea07876cb9">image_view_zoom_in_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00681"></a>00681     <span class="keywordtype">float</span> location[2];
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1], &amp;location[0], &amp;location[1]);
<a name="l00684"></a>00684     <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a46d0b3e4b103fdc6e24d78ed1e2b78bb">image_view_zoom_in_exec</a>(C, op);
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a63cafb9499d9da74f1ccba27bc671807">00689</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#aeabc79685253b673818a3cb421764f3d">IMAGE_OT_view_zoom_in</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00690"></a>00690 {
<a name="l00691"></a>00691     <span class="comment">/* identifiers */</span>
<a name="l00692"></a>00692     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Zoom In&quot;</span>;
<a name="l00693"></a>00693     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_zoom_in&quot;</span>;
<a name="l00694"></a>00694     
<a name="l00695"></a>00695     <span class="comment">/* api callbacks */</span>
<a name="l00696"></a>00696     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a7daa6083a7dc69e4d3163dea07876cb9">image_view_zoom_in_invoke</a>;
<a name="l00697"></a>00697     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a46d0b3e4b103fdc6e24d78ed1e2b78bb">image_view_zoom_in_exec</a>;
<a name="l00698"></a>00698     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">/* properties */</span>
<a name="l00701"></a>00701     <a class="code" href="../../dc/d7e/rna__define_8c.html#a60e910dcfdccf2a1ede6471837912011">RNA_def_float_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;location&quot;</span>, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <span class="stringliteral">&quot;Location&quot;</span>, <span class="stringliteral">&quot;Cursor location in screen coordinates&quot;</span>, -10.0f, 10.0f);
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a38674a6e27247e93b52a1e692b05c9a1">00704</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a38674a6e27247e93b52a1e692b05c9a1">image_view_zoom_out_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00705"></a>00705 {
<a name="l00706"></a>00706     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00707"></a>00707     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00708"></a>00708     <span class="keywordtype">float</span> location[2];
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <a class="code" href="../../d6/d1f/image__ops_8c.html#a8f8e0dbc0726bb7d82032c6034a8679e">sima_zoom_set_factor</a>(sima, ar, 0.8f, location);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00715"></a>00715     
<a name="l00716"></a>00716     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ad32b0a378ad67fd6e27b50d63e645568">00719</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ad32b0a378ad67fd6e27b50d63e645568">image_view_zoom_out_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00722"></a>00722     <span class="keywordtype">float</span> location[2];
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1], &amp;location[0], &amp;location[1]);
<a name="l00725"></a>00725     <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a38674a6e27247e93b52a1e692b05c9a1">image_view_zoom_out_exec</a>(C, op);
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a645f94598d00af2b09b36fc5c3e00beb">00730</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#afd90f5d4c889cdf54e0a791deb8fe28d">IMAGE_OT_view_zoom_out</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732     <span class="comment">/* identifiers */</span>
<a name="l00733"></a>00733     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Zoom Out&quot;</span>;
<a name="l00734"></a>00734     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_zoom_out&quot;</span>;
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     <span class="comment">/* api callbacks */</span>
<a name="l00737"></a>00737     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ad32b0a378ad67fd6e27b50d63e645568">image_view_zoom_out_invoke</a>;
<a name="l00738"></a>00738     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a38674a6e27247e93b52a1e692b05c9a1">image_view_zoom_out_exec</a>;
<a name="l00739"></a>00739     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="comment">/* properties */</span>
<a name="l00742"></a>00742     <a class="code" href="../../dc/d7e/rna__define_8c.html#a60e910dcfdccf2a1ede6471837912011">RNA_def_float_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;location&quot;</span>, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <span class="stringliteral">&quot;Location&quot;</span>, <span class="stringliteral">&quot;Cursor location in screen coordinates&quot;</span>, -10.0f, 10.0f);
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 <span class="comment">/********************** view zoom ratio operator *********************/</span>
<a name="l00746"></a>00746 
<a name="l00747"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a637e50ea880007dfc2f16347f83b5f05">00747</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a637e50ea880007dfc2f16347f83b5f05">image_view_zoom_ratio_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00750"></a>00750     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <a class="code" href="../../d6/d1f/image__ops_8c.html#aff45915b0a5ef84fc93882c6a84877b6">sima_zoom_set</a>(sima, ar, <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;ratio&quot;</span>), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00753"></a>00753     
<a name="l00754"></a>00754     <span class="comment">/* ensure pixel exact locations for draw */</span>
<a name="l00755"></a>00755     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a> = (int)sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ae9bd3321b8c75e8ed349cf28f80d851f">xof</a>;
<a name="l00756"></a>00756     sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a> = (<span class="keywordtype">int</span>)sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#af5ec072d703c1dd1fe0656e573b1ebfc">yof</a>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="comment">/* XXX notifier? */</span>
<a name="l00759"></a>00759 <span class="preprocessor">#if 0</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (image_preview_active(curarea, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00761"></a>00761         <span class="comment">/* recalculates new preview rect */</span>
<a name="l00762"></a>00762         scrarea_do_windraw(curarea);
<a name="l00763"></a>00763         image_preview_event(2);
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765 <span class="preprocessor">#endif</span>
<a name="l00766"></a>00766 <span class="preprocessor"></span>
<a name="l00767"></a>00767     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l00768"></a>00768     
<a name="l00769"></a>00769     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ae63953d3f053864ba686958e0707dac9">00772</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a0a5b2d1f08a99b82e895362f43b2e1e2">IMAGE_OT_view_zoom_ratio</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <span class="comment">/* identifiers */</span>
<a name="l00775"></a>00775     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;View Zoom Ratio&quot;</span>;
<a name="l00776"></a>00776     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_view_zoom_ratio&quot;</span>;
<a name="l00777"></a>00777     
<a name="l00778"></a>00778     <span class="comment">/* api callbacks */</span>
<a name="l00779"></a>00779     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a637e50ea880007dfc2f16347f83b5f05">image_view_zoom_ratio_exec</a>;
<a name="l00780"></a>00780     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l00781"></a>00781     
<a name="l00782"></a>00782     <span class="comment">/* properties */</span>
<a name="l00783"></a>00783     <a class="code" href="../../dc/d7e/rna__define_8c.html#a040f4b08fc87a45a90e2291382e27f75">RNA_def_float</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;ratio&quot;</span>, 0.0f, 0.0f, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>,
<a name="l00784"></a>00784                   <span class="stringliteral">&quot;Ratio&quot;</span>, <span class="stringliteral">&quot;Zoom ratio, 1.0 is 1:1, higher is zoomed in, lower is zoomed out&quot;</span>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>);
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="comment">/**************** load/replace/save callbacks ******************/</span>
<a name="l00788"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a06a17cbff582a2b5a54ad384179c6c7a">00788</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a06a17cbff582a2b5a54ad384179c6c7a">image_filesel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790     <a class="code" href="../../d3/d10/rna__access_8c.html#a229b9421e0a1d2e5fd079ec933a2d6f5">RNA_string_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, path);
<a name="l00791"></a>00791     <a class="code" href="../../df/db0/wm__event__system_8c.html#a2e41929a4b0d2175609f19e7a3626a42">WM_event_add_fileselect</a>(C, op); 
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 <span class="comment">/******************** open image operator ********************/</span>
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ab842271c012b7439e4c8675e803eddd6">00796</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ab842271c012b7439e4c8675e803eddd6">image_open_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798     <a class="code" href="../../d3/d37/structPropertyPointerRNA.html">PropertyPointerRNA</a> *pprop;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = pprop = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d37/structPropertyPointerRNA.html">PropertyPointerRNA</a>), <span class="stringliteral">&quot;OpenPropertyPointerRNA&quot;</span>);
<a name="l00801"></a>00801     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a6bfd6ea66a2b01a45cc660c37585a58f">uiIDContextProperty</a>(C, &amp;pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a93d07b9a6bb29759563ebcefa16fad41">ptr</a>, &amp;pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a34af6db11b3b21dc3917c6f3b7ac871c">prop</a>);
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a0b411f4933c9c3140264af8977e75271">00804</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a0b411f4933c9c3140264af8977e75271">image_open_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l00807"></a>00807     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00808"></a>00808     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a48b1714cfdb9f8fe5e723fc977ec9d20">00811</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a48b1714cfdb9f8fe5e723fc977ec9d20">image_open_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C); <span class="comment">/* XXX other space types can call */</span>
<a name="l00814"></a>00814     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00815"></a>00815     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l00816"></a>00816     <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00817"></a>00817     <a class="code" href="../../d3/d37/structPropertyPointerRNA.html">PropertyPointerRNA</a> *pprop;
<a name="l00818"></a>00818     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> idptr;
<a name="l00819"></a>00819     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00820"></a>00820     <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, str);
<a name="l00823"></a>00823     <span class="comment">/* default to frame 1 if there&#39;s no scene in context */</span>
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     errno = 0;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     ima = <a class="code" href="../../d2/d77/BKE__image_8h.html#ada7c3f7a7be3638972a7635a304420a4">BKE_add_image_file</a>(str);
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (!ima) {
<a name="l00830"></a>00830         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l00831"></a>00831         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t read: \&quot;%s\&quot;, %s&quot;</span>, str, errno ? strerror(errno) : <span class="stringliteral">&quot;Unsupported image format&quot;</span>);
<a name="l00832"></a>00832         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834     
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (!op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>)
<a name="l00836"></a>00836         <a class="code" href="../../d6/d1f/image__ops_8c.html#ab842271c012b7439e4c8675e803eddd6">image_open_init</a>(C, op);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">/* hook into UI */</span>
<a name="l00839"></a>00839     pprop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a34af6db11b3b21dc3917c6f3b7ac871c">prop</a>) {
<a name="l00842"></a>00842         <span class="comment">/* when creating new ID blocks, use is already 1, but RNA</span>
<a name="l00843"></a>00843 <span class="comment">         * pointer se also increases user, so this compensates it */</span>
<a name="l00844"></a>00844         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, &amp;idptr);
<a name="l00847"></a>00847         <a class="code" href="../../d3/d10/rna__access_8c.html#adafe00269e3f01d8a6182040597fd020">RNA_property_pointer_set</a>(&amp;pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a93d07b9a6bb29759563ebcefa16fad41">ptr</a>, pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a34af6db11b3b21dc3917c6f3b7ac871c">prop</a>, idptr);
<a name="l00848"></a>00848         <a class="code" href="../../d3/d10/rna__access_8c.html#a5fa7d69c3a73312275e1e6d20baf3bc6">RNA_property_update</a>(C, &amp;pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a93d07b9a6bb29759563ebcefa16fad41">ptr</a>, pprop-&gt;<a class="code" href="../../d3/d37/structPropertyPointerRNA.html#a34af6db11b3b21dc3917c6f3b7ac871c">prop</a>);
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sima) {
<a name="l00851"></a>00851         <a class="code" href="../../de/d53/ED__image_8h.html#aa267d3469a21ccfd7fd9afc77424f726">ED_space_image_set</a>(sima, scene, obedit, ima);
<a name="l00852"></a>00852         iuser = &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854     <span class="keywordflow">else</span> {
<a name="l00855"></a>00855         <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex = <a class="code" href="../../df/d01/BKE__context_8h.html#a67398d15e34f7a4b3c0b5eec1bf5fb94">CTX_data_pointer_get_type</a>(C, <span class="stringliteral">&quot;texture&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#ae59cf2103f62b2f5de697c81a33c30af">RNA_Texture</a>).<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00856"></a>00856         <span class="keywordflow">if</span> (tex &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>)
<a name="l00857"></a>00857             iuser = &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>;
<a name="l00858"></a>00858         
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     
<a name="l00861"></a>00861     <span class="comment">/* initialize because of new image */</span>
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (iuser) {
<a name="l00863"></a>00863         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a69e7d2b76006d695daeaae9832df2c83">sfra</a> = 1;
<a name="l00864"></a>00864         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a576cb0077af7401c73e8634dee46a7f6">offset</a> = 0;
<a name="l00865"></a>00865         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ac4e828b08400ad8bc231081b1ba7969e">fie_ima</a> = 2;
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">/* XXX unpackImage frees image buffers */</span>
<a name="l00869"></a>00869     <a class="code" href="../../d6/d53/ED__render_8h.html#a5bd64056444412c65b860fc03acbe00a">ED_preview_kill_jobs</a>(C);
<a name="l00870"></a>00870     
<a name="l00871"></a>00871     <a class="code" href="../../d2/d77/BKE__image_8h.html#a620aff00ed883501ed144c0c7752b40f">BKE_image_signal</a>(ima, iuser, <a class="code" href="../../d2/d77/BKE__image_8h.html#aa619ce3aeb222fab77d1566c1798b1c1">IMA_SIGNAL_RELOAD</a>);
<a name="l00872"></a>00872     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ima);
<a name="l00873"></a>00873     
<a name="l00874"></a>00874     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a95238d2a1f1fd1bfbf75c41b1c96fbd7">00879</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a95238d2a1f1fd1bfbf75c41b1c96fbd7">image_open_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l00880"></a>00880 {
<a name="l00881"></a>00881     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C); <span class="comment">/* XXX other space types can call */</span>
<a name="l00882"></a>00882     <span class="keywordtype">char</span> *path = <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.textudir;
<a name="l00883"></a>00883     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (sima) {
<a name="l00886"></a>00886         ima = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>;
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (ima == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00890"></a>00890         <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex = <a class="code" href="../../df/d01/BKE__context_8h.html#a67398d15e34f7a4b3c0b5eec1bf5fb94">CTX_data_pointer_get_type</a>(C, <span class="stringliteral">&quot;texture&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#ae59cf2103f62b2f5de697c81a33c30af">RNA_Texture</a>).<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00891"></a>00891         <span class="keywordflow">if</span> (tex &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>)
<a name="l00892"></a>00892             ima = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l00893"></a>00893     }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     <span class="keywordflow">if</span> (ima)
<a name="l00896"></a>00896         path = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>))
<a name="l00899"></a>00899         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a48b1714cfdb9f8fe5e723fc977ec9d20">image_open_exec</a>(C, op);
<a name="l00900"></a>00900     
<a name="l00901"></a>00901     <a class="code" href="../../d6/d1f/image__ops_8c.html#ab842271c012b7439e4c8675e803eddd6">image_open_init</a>(C, op);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <a class="code" href="../../d6/d1f/image__ops_8c.html#a06a17cbff582a2b5a54ad384179c6c7a">image_filesel</a>(C, op, path);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="comment">/* called by other space types too */</span>
<a name="l00909"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a5949633326b44bef0cafa03173a19e74">00909</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#ad9d1cd4399f2279b39da5a7e8edbb2b3">IMAGE_OT_open</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911     <span class="comment">/* identifiers */</span>
<a name="l00912"></a>00912     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Open Image&quot;</span>;
<a name="l00913"></a>00913     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Open image&quot;</span>;
<a name="l00914"></a>00914     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_open&quot;</span>;
<a name="l00915"></a>00915     
<a name="l00916"></a>00916     <span class="comment">/* api callbacks */</span>
<a name="l00917"></a>00917     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a48b1714cfdb9f8fe5e723fc977ec9d20">image_open_exec</a>;
<a name="l00918"></a>00918     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a95238d2a1f1fd1bfbf75c41b1c96fbd7">image_open_invoke</a>;
<a name="l00919"></a>00919     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a0b411f4933c9c3140264af8977e75271">image_open_cancel</a>;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="comment">/* flags */</span>
<a name="l00922"></a>00922     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <span class="comment">/* properties */</span>
<a name="l00925"></a>00925     <a class="code" href="../../d6/dae/wm__operators_8c.html#a5fa435f05172819dfaae1f6acf79bab8">WM_operator_properties_filesel</a>(ot, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aaac3f2bc8c44aafb973f3b1cf5b1c9b1">FOLDERFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aa1c7480dc3bd39628bc5c3531e2a4d1f">IMAGEFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a3081c1c0f7825de961687ac50208e980">MOVIEFILE</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ada7c3cc863dd57483b348dcdf9569b4c">FILE_SPECIAL</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a95da76b164841451e8aef4b21d3f38a2">FILE_OPENFILE</a>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a615ddace8bd4db6f6afb8e59f5366d97">WM_FILESEL_FILEPATH</a> | <a class="code" href="../../d4/d7f/WM__api_8h.html#a37e372cb74a17fb7d0c39d96f0c1ea52">WM_FILESEL_RELPATH</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a21d31fc4a7d23f7ebc977203f7e63571ac853e68e87258d362a5539682d68af18">FILE_DEFAULTDISPLAY</a>);
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 <span class="comment">/******************** replace image operator ********************/</span>
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ae1b734933a0ddcc6429a86421b6e5794">00930</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ae1b734933a0ddcc6429a86421b6e5794">image_replace_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00933"></a>00933     <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (!sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>)
<a name="l00936"></a>00936         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00937"></a>00937     
<a name="l00938"></a>00938     <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, str);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     <span class="comment">/* we cant do much if the str is longer then FILE_MAX :/ */</span>
<a name="l00941"></a>00941     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, str, <span class="keyword">sizeof</span>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#aeeedac7b0ad04a708eb449dc6b7373c0">BLI_testextensie_array</a>(str, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a7c222800805dd4afcbc1691f38c66918">imb_ext_movie</a>))
<a name="l00944"></a>00944         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>;
<a name="l00945"></a>00945     <span class="keywordflow">else</span>
<a name="l00946"></a>00946         sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="comment">/* XXX unpackImage frees image buffers */</span>
<a name="l00949"></a>00949     <a class="code" href="../../d6/d53/ED__render_8h.html#a5bd64056444412c65b860fc03acbe00a">ED_preview_kill_jobs</a>(C);
<a name="l00950"></a>00950     
<a name="l00951"></a>00951     <a class="code" href="../../d2/d77/BKE__image_8h.html#a620aff00ed883501ed144c0c7752b40f">BKE_image_signal</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>, &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aa619ce3aeb222fab77d1566c1798b1c1">IMA_SIGNAL_RELOAD</a>);
<a name="l00952"></a>00952     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00955"></a>00955 }
<a name="l00956"></a>00956 
<a name="l00957"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a10f6f28f36e35c620dd7365edfdfb679">00957</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a10f6f28f36e35c620dd7365edfdfb679">image_replace_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l00958"></a>00958 {
<a name="l00959"></a>00959     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961     <span class="keywordflow">if</span> (!sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>)
<a name="l00962"></a>00962         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>))
<a name="l00965"></a>00965         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ae1b734933a0ddcc6429a86421b6e5794">image_replace_exec</a>(C, op);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;relative_path&quot;</span>))
<a name="l00968"></a>00968         <a class="code" href="../../d3/d10/rna__access_8c.html#a1741c6fd78b5d828bb7b83517e2766db">RNA_boolean_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;relative_path&quot;</span>, (strncmp(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="stringliteral">&quot;//&quot;</span>, 2)) == 0);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <a class="code" href="../../d6/d1f/image__ops_8c.html#a06a17cbff582a2b5a54ad384179c6c7a">image_filesel</a>(C, op, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ad19eacb1fccf16d5e441bda5c2fc06fc">00975</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#af412603c0201dcfbdfe72ca5c1605bd6">IMAGE_OT_replace</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977     <span class="comment">/* identifiers */</span>
<a name="l00978"></a>00978     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Replace Image&quot;</span>;
<a name="l00979"></a>00979     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_replace&quot;</span>;
<a name="l00980"></a>00980     
<a name="l00981"></a>00981     <span class="comment">/* api callbacks */</span>
<a name="l00982"></a>00982     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ae1b734933a0ddcc6429a86421b6e5794">image_replace_exec</a>;
<a name="l00983"></a>00983     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a10f6f28f36e35c620dd7365edfdfb679">image_replace_invoke</a>;
<a name="l00984"></a>00984     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a164b38bde0dedd5a7e982434a71dc7f7">space_image_poll</a>;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986     <span class="comment">/* flags */</span>
<a name="l00987"></a>00987     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     <span class="comment">/* properties */</span>
<a name="l00990"></a>00990     <a class="code" href="../../d6/dae/wm__operators_8c.html#a5fa435f05172819dfaae1f6acf79bab8">WM_operator_properties_filesel</a>(ot, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aaac3f2bc8c44aafb973f3b1cf5b1c9b1">FOLDERFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aa1c7480dc3bd39628bc5c3531e2a4d1f">IMAGEFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a3081c1c0f7825de961687ac50208e980">MOVIEFILE</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ada7c3cc863dd57483b348dcdf9569b4c">FILE_SPECIAL</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a95da76b164841451e8aef4b21d3f38a2">FILE_OPENFILE</a>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a615ddace8bd4db6f6afb8e59f5366d97">WM_FILESEL_FILEPATH</a> | <a class="code" href="../../d4/d7f/WM__api_8h.html#a37e372cb74a17fb7d0c39d96f0c1ea52">WM_FILESEL_RELPATH</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a21d31fc4a7d23f7ebc977203f7e63571ac853e68e87258d362a5539682d68af18">FILE_DEFAULTDISPLAY</a>);
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993 <span class="comment">/******************** save image as operator ********************/</span>
<a name="l00994"></a>00994 
<a name="l00995"></a><a class="code" href="../../dd/dc2/structSaveImageOptions.html">00995</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00996"></a>00996     <span class="comment">/* matching scene-&gt;r settings */</span>
<a name="l00997"></a>00997     <span class="comment">//short planes, imtype, subimtype, quality;</span>
<a name="l00998"></a><a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">00998</a>     <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> <a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>;
<a name="l00999"></a><a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">00999</a>     <span class="keywordtype">char</span> filepath[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>]; <span class="comment">/* keep absolute */</span>
<a name="l01000"></a>01000 } <a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a>;
<a name="l01001"></a>01001 
<a name="l01002"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4bb83f9c74d531d700dccb1a5150b059">01002</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a4bb83f9c74d531d700dccb1a5150b059">save_image_options_defaults</a>(<a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> *simopts)
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004     <a class="code" href="../../d2/d77/BKE__image_8h.html#a19bc7535e834b368d09303b2f0896c2d">BKE_imformat_defaults</a>(&amp;simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>);
<a name="l01005"></a>01005     simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a57f2fcffc5c2c3cffa78991ef2898178">01008</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a57f2fcffc5c2c3cffa78991ef2898178">imtype_best_depth</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l01009"></a>01009 {
<a name="l01010"></a>01010     <span class="keyword">const</span> <span class="keywordtype">char</span> depth_ok = <a class="code" href="../../d2/d77/BKE__image_8h.html#a3ed096edc853c137d4afb7e3b5cc80a0">BKE_imtype_valid_depths</a>(imtype);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>;
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe2a88093f1b4965f062ea41ee324284">R_IMF_CHAN_DEPTH_24</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe2a88093f1b4965f062ea41ee324284">R_IMF_CHAN_DEPTH_24</a>;
<a name="l01015"></a>01015         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>;
<a name="l01016"></a>01016         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>;
<a name="l01017"></a>01017         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a>;
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019     <span class="keywordflow">else</span> {
<a name="l01020"></a>01020         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a>;
<a name="l01021"></a>01021         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>;
<a name="l01022"></a>01022         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>;
<a name="l01023"></a>01023         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe2a88093f1b4965f062ea41ee324284">R_IMF_CHAN_DEPTH_24</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe2a88093f1b4965f062ea41ee324284">R_IMF_CHAN_DEPTH_24</a>;
<a name="l01024"></a>01024         <span class="keywordflow">if</span> (depth_ok &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>;
<a name="l01025"></a>01025         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a>; <span class="comment">/* fallback, should not get here */</span>
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027 }
<a name="l01028"></a>01028 
<a name="l01029"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a353bb5a4f050b2ae84430bfbd704fa67">01029</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a353bb5a4f050b2ae84430bfbd704fa67">save_image_options_init</a>(<a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> *simopts, <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">const</span> <span class="keywordtype">short</span> guess_path)
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031     <span class="keywordtype">void</span> *lock;
<a name="l01032"></a>01032     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../de/d53/ED__image_8h.html#a94a74feeb6fba43a3353a6948a49716c">ED_space_image_acquire_buffer</a>(sima, &amp;lock);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (ibuf) {
<a name="l01035"></a>01035         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>;
<a name="l01036"></a>01036         <span class="keywordtype">short</span> is_depth_set = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038         simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a922dc453e6b157a2da1dc7ffb5fb19f6">IMA_TYPE_COMPOSITE</a>)) {
<a name="l01041"></a>01041             <span class="comment">/* imtype */</span>
<a name="l01042"></a>01042             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a53cdd260f397aa4d2bead55f90780180">im_format</a>;
<a name="l01043"></a>01043             is_depth_set = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l01046"></a>01046             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>;
<a name="l01047"></a>01047         }
<a name="l01048"></a>01048         <span class="keywordflow">else</span> {
<a name="l01049"></a>01049             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a38444fcc115605ba30b80b730adc6f93">BKE_ftype_to_imtype</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>);
<a name="l01050"></a>01050         }
<a name="l01051"></a>01051         <span class="comment">//simopts-&gt;subimtype= scene-&gt;r.subimtype; /* XXX - this is lame, we need to make these available too! */</span>
<a name="l01052"></a>01052         simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> &amp; 0xff;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keyword">sizeof</span>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>));
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="comment">/* sanitize all settings */</span>
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         <span class="comment">/* unlikely but just in case */</span>
<a name="l01059"></a>01059         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a287d5c3977c63b08defd82725b085d47">R_IMF_PLANES_BW</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>) == 0) {
<a name="l01060"></a>01060             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>;
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="comment">/* depth, account for float buffer and format support */</span>
<a name="l01064"></a>01064         <span class="keywordflow">if</span> (is_depth_set == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l01065"></a>01065             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#ada08bec60e3ea645cefb195d125e978b">depth</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a57f2fcffc5c2c3cffa78991ef2898178">imtype_best_depth</a>(ibuf, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>);
<a name="l01066"></a>01066         }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068         <span class="comment">/* some formats don&#39;t use quality so fallback to scenes quality */</span>
<a name="l01069"></a>01069         <span class="keywordflow">if</span> (simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a> == 0) {
<a name="l01070"></a>01070             simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a53cdd260f397aa4d2bead55f90780180">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a>;
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         <span class="comment">/* check for empty path */</span>
<a name="l01074"></a>01074         <span class="keywordflow">if</span> (guess_path &amp;&amp; simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>[0] == 0) {
<a name="l01075"></a>01075             <span class="keywordflow">if</span> ( (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima[0] == <span class="charliteral">&#39;/&#39;</span>) &amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima[1] == <span class="charliteral">&#39;/&#39;</span>) &amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima[2] == <span class="charliteral">&#39;\0&#39;</span>) ) {
<a name="l01076"></a>01076                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <span class="stringliteral">&quot;//untitled&quot;</span>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l01077"></a>01077             }
<a name="l01078"></a>01078             <span class="keywordflow">else</span> {
<a name="l01079"></a>01079                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l01080"></a>01080             }
<a name="l01081"></a>01081             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name);
<a name="l01082"></a>01082         }
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <span class="keywordflow">return</span> (ibuf != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01088"></a>01088 }
<a name="l01089"></a>01089 
<a name="l01090"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a9a4d3ff049124ee81b96ce634dbb6ae2">01090</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a9a4d3ff049124ee81b96ce634dbb6ae2">save_image_options_from_op</a>(<a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> *simopts, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) {
<a name="l01093"></a>01093         simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a> = *(<a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *)op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>)) {
<a name="l01097"></a>01097         <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>);
<a name="l01098"></a>01098         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name);
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01102"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a35145d96dff93b9c51e55c5b9d19f9ef">01102</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a35145d96dff93b9c51e55c5b9d19f9ef">save_image_options_to_op</a>(<a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> *simopts, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) {
<a name="l01105"></a>01105         *(<a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *)op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>;
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <a class="code" href="../../d3/d10/rna__access_8c.html#a229b9421e0a1d2e5fd079ec933a2d6f5">RNA_string_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>);
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment">/* assumes name is FILE_MAX */</span>
<a name="l01112"></a>01112 <span class="comment">/* ima-&gt;name and ibuf-&gt;name should end up the same */</span>
<a name="l01113"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a05c2179fd138e7fec87e06fdbd805254">01113</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a05c2179fd138e7fec87e06fdbd805254">save_image_doit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> *simopts, <span class="keywordtype">int</span> do_newpath)
<a name="l01114"></a>01114 {
<a name="l01115"></a>01115     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../de/d53/ED__image_8h.html#a8ad18e26f8f83222010f6781a1f51a7c">ED_space_image</a>(sima);
<a name="l01116"></a>01116     <span class="keywordtype">void</span> *lock;
<a name="l01117"></a>01117     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../de/d53/ED__image_8h.html#a94a74feeb6fba43a3353a6948a49716c">ED_space_image_acquire_buffer</a>(sima, &amp;lock);
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     <span class="keywordflow">if</span> (ibuf) {
<a name="l01120"></a>01120         <span class="keyword">const</span> <span class="keywordtype">char</span> *relbase = <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l01121"></a>01121         <span class="keyword">const</span> <span class="keywordtype">short</span> relative = (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;relative_path&quot;</span>) &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;relative_path&quot;</span>));
<a name="l01122"></a>01122         <span class="keyword">const</span> <span class="keywordtype">short</span> save_copy = (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;copy&quot;</span>) &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;copy&quot;</span>));
<a name="l01123"></a>01123         <span class="keywordtype">short</span> ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125         <span class="comment">/* old global to ensure a 2nd save goes to same dir */</span>
<a name="l01126"></a>01126         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.ima));
<a name="l01127"></a>01127 
<a name="l01128"></a>01128         <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(1);
<a name="l01129"></a>01129 
<a name="l01130"></a>01130         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>) {
<a name="l01131"></a>01131             <span class="comment">/* enforce user setting for RGB or RGBA, but skip BW */</span>
<a name="l01132"></a>01132             <span class="keywordflow">if</span> (simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>) {
<a name="l01133"></a>01133                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>;
<a name="l01134"></a>01134             }
<a name="l01135"></a>01135             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>) {
<a name="l01136"></a>01136                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>;
<a name="l01137"></a>01137             }
<a name="l01138"></a>01138         }
<a name="l01139"></a>01139         <span class="keywordflow">else</span> {
<a name="l01140"></a>01140             <span class="comment">/* TODO, better solution, if a 24bit image is painted onto it may contain alpha */</span>
<a name="l01141"></a>01141             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>) { <span class="comment">/* it has been painted onto */</span>
<a name="l01142"></a>01142                 <span class="comment">/* checks each pixel, not ideal */</span>
<a name="l01143"></a>01143                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a4642b2ecfc68056c7e6085b9c24c5ae9">BKE_alphatest_ibuf</a>(ibuf) ? 32 : 24;
<a name="l01144"></a>01144             }
<a name="l01145"></a>01145         }
<a name="l01146"></a>01146         
<a name="l01147"></a>01147         <span class="keywordflow">if</span> (simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>) {
<a name="l01148"></a>01148             <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01149"></a>01149             <a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> *rr = <a class="code" href="../../d2/d77/BKE__image_8h.html#a171026b95d3a957947f5d797727e91d9">BKE_image_acquire_renderresult</a>(scene, ima);
<a name="l01150"></a>01150             <span class="keywordflow">if</span> (rr) {
<a name="l01151"></a>01151                 <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2384a89737ec12704b932edf0e7e74e9">RE_WriteRenderResult</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, rr, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a>);
<a name="l01152"></a>01152                 ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01153"></a>01153             }
<a name="l01154"></a>01154             <span class="keywordflow">else</span> {
<a name="l01155"></a>01155                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Did not write, no Multilayer Image&quot;</span>);
<a name="l01156"></a>01156             }
<a name="l01157"></a>01157             <a class="code" href="../../d2/d77/BKE__image_8h.html#ab8d0892c3d178db229ae5a10938906dd">BKE_image_release_renderresult</a>(scene, ima);
<a name="l01158"></a>01158         }
<a name="l01159"></a>01159         <span class="keywordflow">else</span> {
<a name="l01160"></a>01160             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d77/BKE__image_8h.html#a0f46d70ffa7da929470128807934b974">BKE_write_ibuf_as</a>(ibuf, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, &amp;simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>, save_copy)) {
<a name="l01161"></a>01161                 ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01162"></a>01162             }
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         <span class="keywordflow">if</span> (ok) {
<a name="l01166"></a>01166             <span class="keywordflow">if</span> (!save_copy) {
<a name="l01167"></a>01167                 <span class="keywordflow">if</span> (do_newpath) {
<a name="l01168"></a>01168                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <span class="keyword">sizeof</span>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>));
<a name="l01169"></a>01169                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>, <span class="keyword">sizeof</span>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));
<a name="l01170"></a>01170                 }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                 <span class="comment">/* change type? */</span>
<a name="l01175"></a>01175                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>) {
<a name="l01176"></a>01176                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178                     <span class="comment">/* workaround to ensure the render result buffer is no longer used</span>
<a name="l01179"></a>01179 <span class="comment">                     * by this image, otherwise can crash when a new render result is</span>
<a name="l01180"></a>01180 <span class="comment">                     * created. */</span>
<a name="l01181"></a>01181                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad147239b291e76fa3a1b21b9b773e942">mall</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>))
<a name="l01182"></a>01182                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4660d436da5d4c67faacaf2fa2b9989e">imb_freerectImBuf</a>(ibuf);
<a name="l01183"></a>01183                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad147239b291e76fa3a1b21b9b773e942">mall</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>))
<a name="l01184"></a>01184                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0d2ec7ce9e9b8e094f31e6a4535ce8d3">imb_freerectfloatImBuf</a>(ibuf);
<a name="l01185"></a>01185                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad9ce21fd6e42e77267839eb56d1c60f6">zbuf</a> &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad147239b291e76fa3a1b21b9b773e942">mall</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a608c787ed430e12abfb59fda71486191" title="Flag defining the components of the ImBuf struct.">IB_zbuf</a>))
<a name="l01186"></a>01186                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a5729d32561fe474e6f0fca415a8d47f2">IMB_freezbufImBuf</a>(ibuf);
<a name="l01187"></a>01187                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a> &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad147239b291e76fa3a1b21b9b773e942">mall</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad0b0d2d177773cca2507492d0a2bc5a4" title="Flag defining the components of the ImBuf struct.">IB_zbuffloat</a>))
<a name="l01188"></a>01188                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a1aa45dfd85dc05265be1b36a811bf782">IMB_freezbuffloatImBuf</a>(ibuf);
<a name="l01189"></a>01189                 }
<a name="l01190"></a>01190                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>)) {
<a name="l01191"></a>01191                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>;
<a name="l01192"></a>01192                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l01193"></a>01193                 }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195                 <span class="comment">/* only image path, never ibuf */</span>
<a name="l01196"></a>01196                 <span class="keywordflow">if</span> (relative) {
<a name="l01197"></a>01197                     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a885e6044163b103a6c8e811d17286bb6">BLI_path_rel</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, relbase); <span class="comment">/* only after saving */</span>
<a name="l01198"></a>01198                 }
<a name="l01199"></a>01199             }
<a name="l01200"></a>01200         }
<a name="l01201"></a>01201         <span class="keywordflow">else</span> {
<a name="l01202"></a>01202             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Couldn&#39;t write image: %s&quot;</span>, simopts-&gt;<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>);
<a name="l01203"></a>01203         }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205 
<a name="l01206"></a>01206         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a8771dd8b70a5ea0e816c4317ed871549">01214</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a8771dd8b70a5ea0e816c4317ed871549">image_save_as_free</a>(<a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216     <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) {
<a name="l01217"></a>01217         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l01218"></a>01218         op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01219"></a>01219     }
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a50bf838fb35ea668319f62a3ca503359">01222</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a50bf838fb35ea668319f62a3ca503359">image_save_as_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01223"></a>01223 {
<a name="l01224"></a>01224     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01225"></a>01225     <a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> simopts;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     <a class="code" href="../../d6/d1f/image__ops_8c.html#a4bb83f9c74d531d700dccb1a5150b059">save_image_options_defaults</a>(&amp;simopts);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     <span class="comment">/* just in case to initialize values,</span>
<a name="l01230"></a>01230 <span class="comment">     * these should be set on invoke or by the caller. */</span>
<a name="l01231"></a>01231     <a class="code" href="../../d6/d1f/image__ops_8c.html#a353bb5a4f050b2ae84430bfbd704fa67">save_image_options_init</a>(&amp;simopts, sima, <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C), 0);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233     <a class="code" href="../../d6/d1f/image__ops_8c.html#a9a4d3ff049124ee81b96ce634dbb6ae2">save_image_options_from_op</a>(&amp;simopts, op);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <a class="code" href="../../d6/d1f/image__ops_8c.html#a05c2179fd138e7fec87e06fdbd805254">save_image_doit</a>(C, sima, op, &amp;simopts, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <a class="code" href="../../d6/d1f/image__ops_8c.html#a8771dd8b70a5ea0e816c4317ed871549">image_save_as_free</a>(op);
<a name="l01238"></a>01238     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01239"></a>01239 }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241 
<a name="l01242"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a48d9f05a5f361f9c2cc4f6ba623fe979">01242</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a48d9f05a5f361f9c2cc4f6ba623fe979">image_save_as_check</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01243"></a>01243 {
<a name="l01244"></a>01244     <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *imf = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01245"></a>01245     <span class="keywordflow">return</span> <a class="code" href="../../d6/dae/wm__operators_8c.html#aad72cad3d39046e4164d46cff5433fd0">WM_operator_filesel_ensure_ext_imtype</a>(op, imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>);
<a name="l01246"></a>01246 }
<a name="l01247"></a>01247 
<a name="l01248"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a87e240e558375f40eb1f3c3f47a98fe4">01248</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a87e240e558375f40eb1f3c3f47a98fe4">image_save_as_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01249"></a>01249 {
<a name="l01250"></a>01250     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01251"></a>01251     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../de/d53/ED__image_8h.html#a8ad18e26f8f83222010f6781a1f51a7c">ED_space_image</a>(sima);
<a name="l01252"></a>01252     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01253"></a>01253     <a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> simopts;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>))
<a name="l01256"></a>01256         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a50bf838fb35ea668319f62a3ca503359">image_save_as_exec</a>(C, op);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258     <a class="code" href="../../d6/d1f/image__ops_8c.html#a4bb83f9c74d531d700dccb1a5150b059">save_image_options_defaults</a>(&amp;simopts);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1f/image__ops_8c.html#a353bb5a4f050b2ae84430bfbd704fa67">save_image_options_init</a>(&amp;simopts, sima, scene, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == 0)
<a name="l01261"></a>01261         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01262"></a>01262     <a class="code" href="../../d6/d1f/image__ops_8c.html#a35145d96dff93b9c51e55c5b9d19f9ef">save_image_options_to_op</a>(&amp;simopts, op);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     <span class="comment">/* enable save_copy by default for render results */</span>
<a name="l01265"></a>01265     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a922dc453e6b157a2da1dc7ffb5fb19f6">IMA_TYPE_COMPOSITE</a>) &amp;&amp; !<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;copy&quot;</span>)) {
<a name="l01266"></a>01266         <a class="code" href="../../d3/d10/rna__access_8c.html#a1741c6fd78b5d828bb7b83517e2766db">RNA_boolean_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;copy&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01267"></a>01267     }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>), __func__);
<a name="l01270"></a>01270     memcpy(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>, &amp;simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>, <span class="keyword">sizeof</span>(simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a395a1b805670d871ad909214d7ec32f6">im_format</a>));
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     <a class="code" href="../../d6/d1f/image__ops_8c.html#a06a17cbff582a2b5a54ad384179c6c7a">image_filesel</a>(C, op, simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#afad5a76355ca2e05b3574dbb12b053f0">01277</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#afad5a76355ca2e05b3574dbb12b053f0">image_save_as_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279     <a class="code" href="../../d6/d1f/image__ops_8c.html#a8771dd8b70a5ea0e816c4317ed871549">image_save_as_free</a>(op);
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a29129643d823011ab183b59a1a6a4166">01284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a29129643d823011ab183b59a1a6a4166">image_save_as_draw_check_prop</a>(<a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286     <span class="keyword">const</span> <span class="keywordtype">char</span> *prop_id = <a class="code" href="../../d3/d10/rna__access_8c.html#ad6f3c9684a8786587872fc6baf17dfc9">RNA_property_identifier</a>(prop);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     <span class="keywordflow">return</span> !(strcmp(prop_id, <span class="stringliteral">&quot;filepath&quot;</span>) == 0 ||
<a name="l01289"></a>01289              strcmp(prop_id, <span class="stringliteral">&quot;directory&quot;</span>) == 0 ||
<a name="l01290"></a>01290              strcmp(prop_id, <span class="stringliteral">&quot;filename&quot;</span>) == 0 ||
<a name="l01291"></a>01291              <span class="comment">/* when saving a copy, relative path has no effect */</span>
<a name="l01292"></a>01292              ((strcmp(prop_id, <span class="stringliteral">&quot;relative_path&quot;</span>) == 0) &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(ptr, <span class="stringliteral">&quot;copy&quot;</span>))
<a name="l01293"></a>01293              );
<a name="l01294"></a>01294 }
<a name="l01295"></a>01295 
<a name="l01296"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a3bf65d3a401036f4c3950b1872441b51">01296</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a3bf65d3a401036f4c3950b1872441b51">image_save_as_draw</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01297"></a>01297 {
<a name="l01298"></a>01298     <a class="code" href="../../d4/d94/structuiLayout.html">uiLayout</a> *layout = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a24a6278e4ab9606e4d996c8114eff2d3">layout</a>;
<a name="l01299"></a>01299     <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *imf = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01300"></a>01300     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     <span class="comment">/* image template */</span>
<a name="l01303"></a>01303     <a class="code" href="../../d3/d10/rna__access_8c.html#a1f8fb80da9a6450a51ab2e9b97264f01">RNA_pointer_create</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a73c118bf2e8f77248e5a4a82b3004997">RNA_ImageFormatSettings</a>, imf, &amp;ptr);
<a name="l01304"></a>01304     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a65858c7ab9086391d030fa5c0e3507ca">uiTemplateImageSettings</a>(layout, &amp;ptr);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306     <span class="comment">/* main draw call */</span>
<a name="l01307"></a>01307     <a class="code" href="../../d3/d10/rna__access_8c.html#a1f8fb80da9a6450a51ab2e9b97264f01">RNA_pointer_create</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a0e68a5b267788bac6caa07cad1c05b2c">properties</a>, &amp;ptr);
<a name="l01308"></a>01308     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a3a2df3af530614f0b6bbccbbffa9abb5">uiDefAutoButsRNA</a>(layout, &amp;ptr, <a class="code" href="../../d6/d1f/image__ops_8c.html#a29129643d823011ab183b59a1a6a4166">image_save_as_draw_check_prop</a>, <span class="charliteral">&#39;\0&#39;</span>);
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a1bfbd9ad0e82ecceb4dcab6d5cab5fcb">01311</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a5182248c6c6f256138d276becf51e755">IMAGE_OT_save_as</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01312"></a>01312 {
<a name="l01313"></a>01313 <span class="comment">//  PropertyRNA *prop;</span>
<a name="l01314"></a>01314 
<a name="l01315"></a>01315     <span class="comment">/* identifiers */</span>
<a name="l01316"></a>01316     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Save As Image&quot;</span>;
<a name="l01317"></a>01317     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_save_as&quot;</span>;
<a name="l01318"></a>01318     
<a name="l01319"></a>01319     <span class="comment">/* api callbacks */</span>
<a name="l01320"></a>01320     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a50bf838fb35ea668319f62a3ca503359">image_save_as_exec</a>;
<a name="l01321"></a>01321     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a6f75ff0089a22e585a90313decbda6cb">check</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a48d9f05a5f361f9c2cc4f6ba623fe979">image_save_as_check</a>;
<a name="l01322"></a>01322     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a87e240e558375f40eb1f3c3f47a98fe4">image_save_as_invoke</a>;
<a name="l01323"></a>01323     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#afad5a76355ca2e05b3574dbb12b053f0">image_save_as_cancel</a>;
<a name="l01324"></a>01324     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ab455fa7fe921ed1019b8a7b888ad8da5">ui</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a3bf65d3a401036f4c3950b1872441b51">image_save_as_draw</a>;
<a name="l01325"></a>01325     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">space_image_buffer_exists_poll</a>;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     <span class="comment">/* flags */</span>
<a name="l01328"></a>01328     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="comment">/* properties */</span>
<a name="l01331"></a>01331     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;copy&quot;</span>, 0, <span class="stringliteral">&quot;Copy&quot;</span>, <span class="stringliteral">&quot;Create a new image file without modifying the current image in blender&quot;</span>);
<a name="l01332"></a>01332 
<a name="l01333"></a>01333     <a class="code" href="../../d6/dae/wm__operators_8c.html#a5fa435f05172819dfaae1f6acf79bab8">WM_operator_properties_filesel</a>(ot, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aaac3f2bc8c44aafb973f3b1cf5b1c9b1">FOLDERFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#aa1c7480dc3bd39628bc5c3531e2a4d1f">IMAGEFILE</a> | <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a3081c1c0f7825de961687ac50208e980">MOVIEFILE</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ada7c3cc863dd57483b348dcdf9569b4c">FILE_SPECIAL</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a26e6586f9dfafd65f254285b1a1cc883">FILE_SAVE</a>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a615ddace8bd4db6f6afb8e59f5366d97">WM_FILESEL_FILEPATH</a> | <a class="code" href="../../d4/d7f/WM__api_8h.html#a37e372cb74a17fb7d0c39d96f0c1ea52">WM_FILESEL_RELPATH</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a21d31fc4a7d23f7ebc977203f7e63571ac853e68e87258d362a5539682d68af18">FILE_DEFAULTDISPLAY</a>);
<a name="l01334"></a>01334 }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336 <span class="comment">/******************** save image operator ********************/</span>
<a name="l01337"></a>01337 
<a name="l01338"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#abd853be3231c0ba1f8d511c504e9a2d3">01338</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#abd853be3231c0ba1f8d511c504e9a2d3">image_save_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01341"></a>01341     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01342"></a>01342     <a class="code" href="../../dd/dc2/structSaveImageOptions.html">SaveImageOptions</a> simopts;
<a name="l01343"></a>01343 
<a name="l01344"></a>01344     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1f/image__ops_8c.html#a353bb5a4f050b2ae84430bfbd704fa67">save_image_options_init</a>(&amp;simopts, sima, scene, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) == 0)
<a name="l01345"></a>01345         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01346"></a>01346     <a class="code" href="../../d6/d1f/image__ops_8c.html#a9a4d3ff049124ee81b96ce634dbb6ae2">save_image_options_from_op</a>(&amp;simopts, op);
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>) &amp;&amp; <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a9a5202293b98474b3a9650b2034672bb">BLI_file_is_writable</a>(simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>)) {
<a name="l01349"></a>01349         <a class="code" href="../../d6/d1f/image__ops_8c.html#a05c2179fd138e7fec87e06fdbd805254">save_image_doit</a>(C, sima, op, &amp;simopts, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01350"></a>01350     }
<a name="l01351"></a>01351     <span class="keywordflow">else</span> {
<a name="l01352"></a>01352         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can not save image, path &#39;%s&#39; is not writable&quot;</span>, simopts.<a class="code" href="../../dd/dc2/structSaveImageOptions.html#a37e4b72702d455ccaed2f075ac3370df">filepath</a>);
<a name="l01353"></a>01353         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01354"></a>01354     }
<a name="l01355"></a>01355 
<a name="l01356"></a>01356     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01357"></a>01357 }
<a name="l01358"></a>01358 
<a name="l01359"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a8fbee6d271f5b2455060422a186cbacf">01359</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#ae43467eb659abbba4c58957b74ba3493">IMAGE_OT_save</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01360"></a>01360 {
<a name="l01361"></a>01361     <span class="comment">/* identifiers */</span>
<a name="l01362"></a>01362     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Save Image&quot;</span>;
<a name="l01363"></a>01363     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_save&quot;</span>;
<a name="l01364"></a>01364     
<a name="l01365"></a>01365     <span class="comment">/* api callbacks */</span>
<a name="l01366"></a>01366     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#abd853be3231c0ba1f8d511c504e9a2d3">image_save_exec</a>;
<a name="l01367"></a>01367     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a9d55ad97a968e7a31ddb6b3708c072d8">space_image_file_exists_poll</a>;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <span class="comment">/* flags */</span>
<a name="l01370"></a>01370     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 <span class="comment">/******************* save sequence operator ********************/</span>
<a name="l01374"></a>01374 
<a name="l01375"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a21a8a19c0b072d6462a2650f883f0ad8">01375</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a21a8a19c0b072d6462a2650f883f0ad8">image_save_sequence_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01378"></a>01378     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01379"></a>01379     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l01380"></a>01380     <span class="keywordtype">int</span> tot = 0;
<a name="l01381"></a>01381     <span class="keywordtype">char</span> di[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], fi[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l01382"></a>01382     
<a name="l01383"></a>01383     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01384"></a>01384         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> != <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>) {
<a name="l01387"></a>01387         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can only save sequence on image sequences&quot;</span>);
<a name="l01388"></a>01388         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01389"></a>01389     }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>) {
<a name="l01392"></a>01392         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t save multilayer sequences&quot;</span>);
<a name="l01393"></a>01393         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01394"></a>01394     }
<a name="l01395"></a>01395     
<a name="l01396"></a>01396     <span class="comment">/* get total */</span>
<a name="l01397"></a>01397     <span class="keywordflow">for</span> (ibuf = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>)
<a name="l01398"></a>01398         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>)
<a name="l01399"></a>01399             tot++;
<a name="l01400"></a>01400     
<a name="l01401"></a>01401     <span class="keywordflow">if</span> (tot == 0) {
<a name="l01402"></a>01402         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;No images have been changed&quot;</span>);
<a name="l01403"></a>01403         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <span class="comment">/* get a filename for menu */</span>
<a name="l01407"></a>01407     <span class="keywordflow">for</span> (ibuf = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>)
<a name="l01408"></a>01408         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>)
<a name="l01409"></a>01409             <span class="keywordflow">break</span>;
<a name="l01410"></a>01410     
<a name="l01411"></a>01411     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(di, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l01412"></a>01412     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a9587680f8895016dd21016fcecb476b0">BLI_splitdirstring</a>(di, fi);
<a name="l01413"></a>01413     
<a name="l01414"></a>01414     <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;%d Image(s) will be saved in %s&quot;</span>, tot, di);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     <span class="keywordflow">for</span> (ibuf = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>) {
<a name="l01417"></a>01417         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>) {
<a name="l01418"></a>01418             <span class="keywordtype">char</span> name[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l01419"></a>01419             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(name, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keyword">sizeof</span>(name));
<a name="l01420"></a>01420             
<a name="l01421"></a>01421             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(name, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>);
<a name="l01422"></a>01422 
<a name="l01423"></a>01423             <span class="keywordflow">if</span> (0 == <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a59c3289b30d140a0032c85110496dbbc">IMB_saveiff</a>(ibuf, name, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a608c787ed430e12abfb59fda71486191" title="Flag defining the components of the ImBuf struct.">IB_zbuf</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad0b0d2d177773cca2507492d0a2bc5a4" title="Flag defining the components of the ImBuf struct.">IB_zbuffloat</a>)) {
<a name="l01424"></a>01424                 <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Could not write image %s&quot;</span>, name);
<a name="l01425"></a>01425                 <span class="keywordflow">break</span>;
<a name="l01426"></a>01426             }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;Saved: %s\n&quot;</span>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>);
<a name="l01429"></a>01429             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l01430"></a>01430         }
<a name="l01431"></a>01431     }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01434"></a>01434 }
<a name="l01435"></a>01435 
<a name="l01436"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a07829b110e0099b32c6760533f05e617">01436</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a226cd906c45ea4fb248db7bfed330d6c">IMAGE_OT_save_sequence</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01437"></a>01437 {
<a name="l01438"></a>01438     <span class="comment">/* identifiers */</span>
<a name="l01439"></a>01439     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Save Sequence&quot;</span>;
<a name="l01440"></a>01440     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_save_sequence&quot;</span>;
<a name="l01441"></a>01441     
<a name="l01442"></a>01442     <span class="comment">/* api callbacks */</span>
<a name="l01443"></a>01443     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a21a8a19c0b072d6462a2650f883f0ad8">image_save_sequence_exec</a>;
<a name="l01444"></a>01444     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">space_image_buffer_exists_poll</a>;
<a name="l01445"></a>01445 
<a name="l01446"></a>01446     <span class="comment">/* flags */</span>
<a name="l01447"></a>01447     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 <span class="comment">/******************** reload image operator ********************/</span>
<a name="l01451"></a>01451 
<a name="l01452"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a7c4c7d702e3fff26f81c28803148ccd7">01452</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a7c4c7d702e3fff26f81c28803148ccd7">image_reload_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01455"></a>01455     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     <span class="keywordflow">if</span> (!ima)
<a name="l01458"></a>01458         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="comment">/* XXX unpackImage frees image buffers */</span>
<a name="l01461"></a>01461     <a class="code" href="../../d6/d53/ED__render_8h.html#a5bd64056444412c65b860fc03acbe00a">ED_preview_kill_jobs</a>(C);
<a name="l01462"></a>01462     
<a name="l01463"></a>01463     <span class="comment">// XXX other users?</span>
<a name="l01464"></a>01464     <a class="code" href="../../d2/d77/BKE__image_8h.html#a620aff00ed883501ed144c0c7752b40f">BKE_image_signal</a>(ima, (sima) ? &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aa619ce3aeb222fab77d1566c1798b1c1">IMA_SIGNAL_RELOAD</a>);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ima);
<a name="l01467"></a>01467     
<a name="l01468"></a>01468     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01469"></a>01469 }
<a name="l01470"></a>01470 
<a name="l01471"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4ffa80cc854dc4e9b7556fe2dcc62648">01471</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a380eb6c311606f21243d7470221c22cb">IMAGE_OT_reload</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01472"></a>01472 {
<a name="l01473"></a>01473     <span class="comment">/* identifiers */</span>
<a name="l01474"></a>01474     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Reload Image&quot;</span>;
<a name="l01475"></a>01475     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_reload&quot;</span>;
<a name="l01476"></a>01476     
<a name="l01477"></a>01477     <span class="comment">/* api callbacks */</span>
<a name="l01478"></a>01478     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a7c4c7d702e3fff26f81c28803148ccd7">image_reload_exec</a>;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     <span class="comment">/* flags */</span>
<a name="l01481"></a>01481     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>; <span class="comment">/* no undo, image buffer is not handled by undo */</span>
<a name="l01482"></a>01482 }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 <span class="comment">/********************** new image operator *********************/</span>
<a name="l01485"></a>01485 
<a name="l01486"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ad49909c0ad319db1aa6c5ce8792e6a96">01486</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ad49909c0ad319db1aa6c5ce8792e6a96">image_new_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01487"></a>01487 {
<a name="l01488"></a>01488     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima;
<a name="l01489"></a>01489     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l01490"></a>01490     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit;
<a name="l01491"></a>01491     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l01492"></a>01492     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr, idptr;
<a name="l01493"></a>01493     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01494"></a>01494     <span class="keywordtype">char</span> name[<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a6d7bce2e9ad79af316c9690a5b84b75c">MAX_ID_NAME</a> - 2];
<a name="l01495"></a>01495     <span class="keywordtype">float</span> color[4];
<a name="l01496"></a>01496     <span class="keywordtype">int</span> width, height, floatbuf, uvtestgrid, alpha;
<a name="l01497"></a>01497 
<a name="l01498"></a>01498     <span class="comment">/* retrieve state */</span>
<a name="l01499"></a>01499     sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01500"></a>01500     scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01501"></a>01501     obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;name&quot;</span>, name);
<a name="l01504"></a>01504     width = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;width&quot;</span>);
<a name="l01505"></a>01505     height = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;height&quot;</span>);
<a name="l01506"></a>01506     floatbuf = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;float&quot;</span>);
<a name="l01507"></a>01507     uvtestgrid = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;uv_test_grid&quot;</span>);
<a name="l01508"></a>01508     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;color&quot;</span>, color);
<a name="l01509"></a>01509     alpha = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;alpha&quot;</span>);
<a name="l01510"></a>01510     
<a name="l01511"></a>01511     <span class="keywordflow">if</span> (!floatbuf &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l01512"></a>01512         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ac0586614af7cf4cfa2c1718015b85383">linearrgb_to_srgb_v3_v3</a>(color, color);
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (!alpha)
<a name="l01515"></a>01515         color[3] = 1.0f;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     ima = <a class="code" href="../../d2/d77/BKE__image_8h.html#ac9183d7df20f4236ce149fcfaebe535e">BKE_add_image_size</a>(width, height, name, alpha ? 32 : 24, floatbuf, uvtestgrid, color);
<a name="l01518"></a>01518 
<a name="l01519"></a>01519     <span class="keywordflow">if</span> (!ima)
<a name="l01520"></a>01520         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     <span class="comment">/* hook into UI */</span>
<a name="l01523"></a>01523     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a6bfd6ea66a2b01a45cc660c37585a58f">uiIDContextProperty</a>(C, &amp;ptr, &amp;prop);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="keywordflow">if</span> (prop) {
<a name="l01526"></a>01526         <span class="comment">/* when creating new ID blocks, use is already 1, but RNA</span>
<a name="l01527"></a>01527 <span class="comment">         * pointer se also increases user, so this compensates it */</span>
<a name="l01528"></a>01528         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530         <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, &amp;idptr);
<a name="l01531"></a>01531         <a class="code" href="../../d3/d10/rna__access_8c.html#adafe00269e3f01d8a6182040597fd020">RNA_property_pointer_set</a>(&amp;ptr, prop, idptr);
<a name="l01532"></a>01532         <a class="code" href="../../d3/d10/rna__access_8c.html#a5fa7d69c3a73312275e1e6d20baf3bc6">RNA_property_update</a>(C, &amp;ptr, prop);
<a name="l01533"></a>01533     }
<a name="l01534"></a>01534     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sima)
<a name="l01535"></a>01535         <a class="code" href="../../de/d53/ED__image_8h.html#aa267d3469a21ccfd7fd9afc77424f726">ED_space_image_set</a>(sima, scene, obedit, ima);
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="comment">// XXX other users?</span>
<a name="l01538"></a>01538     <a class="code" href="../../d2/d77/BKE__image_8h.html#a620aff00ed883501ed144c0c7752b40f">BKE_image_signal</a>(ima, (sima) ? &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a9d7a62afa600e926af85c2afce656475">IMA_SIGNAL_USER_NEW_IMAGE</a>);
<a name="l01539"></a>01539     
<a name="l01540"></a>01540     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01541"></a>01541 }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543 <span class="comment">/* XXX, Ton is not a fan of OK buttons but using this function to avoid undo/redo bug while in mesh-editmode, - campbell */</span>
<a name="l01544"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aa3916a66515246a308f88525e52e1558">01544</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aa3916a66515246a308f88525e52e1558">image_new_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01545"></a>01545 {
<a name="l01546"></a>01546     <span class="keywordflow">return</span> <a class="code" href="../../d6/dae/wm__operators_8c.html#aa4214a98740189df2958d8ab0b797079">WM_operator_props_dialog_popup</a>(C, op, 300, 100);
<a name="l01547"></a>01547 
<a name="l01548"></a>01548 }
<a name="l01549"></a>01549 
<a name="l01550"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aef05b3be90189763975f77d963d46bfa">01550</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a1f056bd02e004cf906aad42a7cc5a516">IMAGE_OT_new</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01551"></a>01551 {
<a name="l01552"></a>01552     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01553"></a>01553     <span class="keyword">static</span> <span class="keywordtype">float</span> default_color[4] = {0.0f, 0.0f, 0.0f, 1.0f};
<a name="l01554"></a>01554     
<a name="l01555"></a>01555     <span class="comment">/* identifiers */</span>
<a name="l01556"></a>01556     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;New Image&quot;</span>;
<a name="l01557"></a>01557     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Create a new image&quot;</span>;
<a name="l01558"></a>01558     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_new&quot;</span>;
<a name="l01559"></a>01559     
<a name="l01560"></a>01560     <span class="comment">/* api callbacks */</span>
<a name="l01561"></a>01561     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ad49909c0ad319db1aa6c5ce8792e6a96">image_new_exec</a>;
<a name="l01562"></a>01562     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#aa3916a66515246a308f88525e52e1558">image_new_invoke</a>;
<a name="l01563"></a>01563     
<a name="l01564"></a>01564     <span class="comment">/* flags */</span>
<a name="l01565"></a>01565     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     <span class="comment">/* properties */</span>
<a name="l01568"></a>01568     <a class="code" href="../../dc/d7e/rna__define_8c.html#ac53a3ed18da454971065d5b4e4cb4d62">RNA_def_string</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;untitled&quot;</span>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a6d7bce2e9ad79af316c9690a5b84b75c">MAX_ID_NAME</a> - 2, <span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;Image datablock name&quot;</span>);
<a name="l01569"></a>01569     <a class="code" href="../../dc/d7e/rna__define_8c.html#ad9b0c75a6330ff1837409c5d1767af62">RNA_def_int</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;width&quot;</span>, 1024, 1, INT_MAX, <span class="stringliteral">&quot;Width&quot;</span>, <span class="stringliteral">&quot;Image width&quot;</span>, 1, 16384);
<a name="l01570"></a>01570     <a class="code" href="../../dc/d7e/rna__define_8c.html#ad9b0c75a6330ff1837409c5d1767af62">RNA_def_int</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;height&quot;</span>, 1024, 1, INT_MAX, <span class="stringliteral">&quot;Height&quot;</span>, <span class="stringliteral">&quot;Image height&quot;</span>, 1, 16384);
<a name="l01571"></a>01571     prop = <a class="code" href="../../dc/d7e/rna__define_8c.html#ac54c82a237bd7a97c0bd3c980e80a9e6">RNA_def_float_color</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;color&quot;</span>, 4, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.0f, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <span class="stringliteral">&quot;Color&quot;</span>, <span class="stringliteral">&quot;Default fill color&quot;</span>, 0.0f, 1.0f);
<a name="l01572"></a>01572     <a class="code" href="../../dc/d7e/rna__define_8c.html#af5ab2a43e0a9bd9ee7ee69171e461538">RNA_def_property_float_array_default</a>(prop, default_color);
<a name="l01573"></a>01573     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;alpha&quot;</span>, 1, <span class="stringliteral">&quot;Alpha&quot;</span>, <span class="stringliteral">&quot;Create an image with an alpha channel&quot;</span>);
<a name="l01574"></a>01574     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;uv_test_grid&quot;</span>, 0, <span class="stringliteral">&quot;UV Test Grid&quot;</span>, <span class="stringliteral">&quot;Fill the image with a grid for UV map testing&quot;</span>);
<a name="l01575"></a>01575     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;float&quot;</span>, 0, <span class="stringliteral">&quot;32 bit Float&quot;</span>, <span class="stringliteral">&quot;Create image with 32 bit floating point bit depth&quot;</span>);
<a name="l01576"></a>01576 }
<a name="l01577"></a>01577 
<a name="l01578"></a>01578 <span class="comment">/********************* invert operators *********************/</span>
<a name="l01579"></a>01579 
<a name="l01580"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4990da3b94e87def2ad74cf7a653d52a">01580</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a4990da3b94e87def2ad74cf7a653d52a">image_invert_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l01581"></a>01581 {
<a name="l01582"></a>01582     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01583"></a>01583     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01584"></a>01584     
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (ibuf != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01586"></a>01586         <span class="keywordflow">return</span> 1;
<a name="l01587"></a>01587     <span class="keywordflow">return</span> 0;
<a name="l01588"></a>01588 }
<a name="l01589"></a>01589 
<a name="l01590"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a74215f818f02b59d3eedff6d5241db21">01590</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a74215f818f02b59d3eedff6d5241db21">image_invert_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01591"></a>01591 {
<a name="l01592"></a>01592     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01593"></a>01593     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="comment">// flags indicate if this channel should be inverted</span>
<a name="l01596"></a>01596     <span class="keyword">const</span> <span class="keywordtype">short</span> r = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;invert_r&quot;</span>);
<a name="l01597"></a>01597     <span class="keyword">const</span> <span class="keywordtype">short</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;invert_g&quot;</span>);
<a name="l01598"></a>01598     <span class="keyword">const</span> <span class="keywordtype">short</span> b = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;invert_b&quot;</span>);
<a name="l01599"></a>01599     <span class="keyword">const</span> <span class="keywordtype">short</span> a = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;invert_a&quot;</span>);
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01602"></a>01602 
<a name="l01603"></a>01603     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)  <span class="comment">// TODO: this should actually never happen, but does for render-results -&gt; cleanup</span>
<a name="l01604"></a>01604         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01605"></a>01605 
<a name="l01606"></a>01606     <span class="comment">/* TODO: make this into an IMB_invert_channels(ibuf,r,g,b,a) method!? */</span>
<a name="l01607"></a>01607     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01608"></a>01608         
<a name="l01609"></a>01609         <span class="keywordtype">float</span> *fp = (<span class="keywordtype">float</span> *) ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>;
<a name="l01610"></a>01610         for (i = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; i &gt; 0; i--, fp += 4) {
<a name="l01611"></a>01611             <span class="keywordflow">if</span> (r) fp[0] = 1.0f - fp[0];
<a name="l01612"></a>01612             <span class="keywordflow">if</span> (g) fp[1] = 1.0f - fp[1];
<a name="l01613"></a>01613             <span class="keywordflow">if</span> (b) fp[2] = 1.0f - fp[2];
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (a) fp[3] = 1.0f - fp[3];
<a name="l01615"></a>01615         }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l01618"></a>01618             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a3af34b4b5c6b91ddf5b872fcb9e2d66c">IMB_rect_from_float</a>(ibuf);
<a name="l01619"></a>01619         }
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l01622"></a>01622         
<a name="l01623"></a>01623         <span class="keywordtype">char</span> *cp = (<span class="keywordtype">char</span> *) ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l01624"></a>01624         for (i = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; i &gt; 0; i--, cp += 4) {
<a name="l01625"></a>01625             <span class="keywordflow">if</span> (r) cp[0] = 255 - cp[0];
<a name="l01626"></a>01626             <span class="keywordflow">if</span> (g) cp[1] = 255 - cp[1];
<a name="l01627"></a>01627             <span class="keywordflow">if</span> (b) cp[2] = 255 - cp[2];
<a name="l01628"></a>01628             <span class="keywordflow">if</span> (a) cp[3] = 255 - cp[3];
<a name="l01629"></a>01629         }
<a name="l01630"></a>01630     }
<a name="l01631"></a>01631     <span class="keywordflow">else</span> {
<a name="l01632"></a>01632         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l01636"></a>01636     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0])
<a name="l01637"></a>01637         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ima);
<a name="l01640"></a>01640     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01641"></a>01641 }
<a name="l01642"></a>01642 
<a name="l01643"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a5f8c83b3e944edf6086b12f99478e1e3">01643</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#add5c1a04b2d37023294aa2bdf476568a">IMAGE_OT_invert</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01644"></a>01644 {
<a name="l01645"></a>01645     <span class="comment">/* identifiers */</span>
<a name="l01646"></a>01646     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Invert Channels&quot;</span>;
<a name="l01647"></a>01647     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_invert&quot;</span>;
<a name="l01648"></a>01648     
<a name="l01649"></a>01649     <span class="comment">/* api callbacks */</span>
<a name="l01650"></a>01650     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a74215f818f02b59d3eedff6d5241db21">image_invert_exec</a>;
<a name="l01651"></a>01651     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a4990da3b94e87def2ad74cf7a653d52a">image_invert_poll</a>;
<a name="l01652"></a>01652     
<a name="l01653"></a>01653     <span class="comment">/* properties */</span>
<a name="l01654"></a>01654     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;invert_r&quot;</span>, 0, <span class="stringliteral">&quot;Red&quot;</span>, <span class="stringliteral">&quot;Invert Red Channel&quot;</span>);
<a name="l01655"></a>01655     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;invert_g&quot;</span>, 0, <span class="stringliteral">&quot;Green&quot;</span>, <span class="stringliteral">&quot;Invert Green Channel&quot;</span>);
<a name="l01656"></a>01656     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;invert_b&quot;</span>, 0, <span class="stringliteral">&quot;Blue&quot;</span>, <span class="stringliteral">&quot;Invert Blue Channel&quot;</span>);
<a name="l01657"></a>01657     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;invert_a&quot;</span>, 0, <span class="stringliteral">&quot;Alpha&quot;</span>, <span class="stringliteral">&quot;Invert Alpha Channel&quot;</span>);
<a name="l01658"></a>01658     
<a name="l01659"></a>01659     <span class="comment">/* flags */</span>
<a name="l01660"></a>01660     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01661"></a>01661 }
<a name="l01662"></a>01662 
<a name="l01663"></a>01663 <span class="comment">/********************* pack operator *********************/</span>
<a name="l01664"></a>01664 
<a name="l01665"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a2cd94a33d2954da1026e04c0e9532c84">01665</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a2cd94a33d2954da1026e04c0e9532c84">image_pack_test</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01666"></a>01666 {
<a name="l01667"></a>01667     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01668"></a>01668     <span class="keywordtype">int</span> as_png = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;as_png&quot;</span>);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670     <span class="keywordflow">if</span> (!ima)
<a name="l01671"></a>01671         <span class="keywordflow">return</span> 0;
<a name="l01672"></a>01672     <span class="keywordflow">if</span> (!as_png &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>)
<a name="l01673"></a>01673         <span class="keywordflow">return</span> 0;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>) {
<a name="l01676"></a>01676         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Packing movies or image sequences not supported&quot;</span>);
<a name="l01677"></a>01677         <span class="keywordflow">return</span> 0;
<a name="l01678"></a>01678     }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     <span class="keywordflow">return</span> 1;
<a name="l01681"></a>01681 }
<a name="l01682"></a>01682 
<a name="l01683"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aea34591315733adef1ec583e2deefc2d">01683</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aea34591315733adef1ec583e2deefc2d">image_pack_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01684"></a>01684 {
<a name="l01685"></a>01685     <span class="keyword">struct </span><a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01686"></a>01686     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01687"></a>01687     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01688"></a>01688     <span class="keywordtype">int</span> as_png = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;as_png&quot;</span>);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#a2cd94a33d2954da1026e04c0e9532c84">image_pack_test</a>(C, op))
<a name="l01691"></a>01691         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01692"></a>01692     
<a name="l01693"></a>01693     <span class="keywordflow">if</span> (!as_png &amp;&amp; (ibuf &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>))) {
<a name="l01694"></a>01694         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t pack edited image from disk, only as internal PNG&quot;</span>);
<a name="l01695"></a>01695         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01696"></a>01696     }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     <span class="keywordflow">if</span> (as_png)
<a name="l01699"></a>01699         <a class="code" href="../../d2/d77/BKE__image_8h.html#adb62e041f06321d417df6a6dd21adde2">BKE_image_memorypack</a>(ima);
<a name="l01700"></a>01700     <span class="keywordflow">else</span>
<a name="l01701"></a>01701         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> = <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(bmain, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ima);
<a name="l01704"></a>01704     
<a name="l01705"></a>01705     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01706"></a>01706 }
<a name="l01707"></a>01707 
<a name="l01708"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ab2544895aa8ca8ae17b7b3e5c58af519">01708</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ab2544895aa8ca8ae17b7b3e5c58af519">image_pack_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01709"></a>01709 {
<a name="l01710"></a>01710     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01711"></a>01711     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01712"></a>01712     <a class="code" href="../../d9/d4b/structuiPopupMenu.html">uiPopupMenu</a> *pup;
<a name="l01713"></a>01713     <a class="code" href="../../d4/d94/structuiLayout.html">uiLayout</a> *layout;
<a name="l01714"></a>01714     <span class="keywordtype">int</span> as_png = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;as_png&quot;</span>);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#a2cd94a33d2954da1026e04c0e9532c84">image_pack_test</a>(C, op))
<a name="l01717"></a>01717         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01718"></a>01718     
<a name="l01719"></a>01719     <span class="keywordflow">if</span> (!as_png &amp;&amp; (ibuf &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>))) {
<a name="l01720"></a>01720         pup = <a class="code" href="../../d8/d1e/UI__interface_8h.html#a402c012d9cde0ff0f0808c25c4213d43">uiPupMenuBegin</a>(C, <span class="stringliteral">&quot;OK&quot;</span>, ICON_QUESTION);
<a name="l01721"></a>01721         layout = <a class="code" href="../../d8/d1e/UI__interface_8h.html#a8c1b07b81987cdc2168a7417f9104cca">uiPupMenuLayout</a>(pup);
<a name="l01722"></a>01722         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a00e34a25f52f438d44b1514bb8e6e975">uiItemBooleanO</a>(layout, <span class="stringliteral">&quot;Can&#39;t pack edited image from disk. Pack as internal PNG?&quot;</span>, ICON_NONE, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a42b15acb4df45b846c38202a208c0c32">idname</a>, <span class="stringliteral">&quot;as_png&quot;</span>, 1);
<a name="l01723"></a>01723         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a3ab0b4d9de253d473a16d4f329d8b50f">uiPupMenuEnd</a>(C, pup);
<a name="l01724"></a>01724 
<a name="l01725"></a>01725         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728     <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aea34591315733adef1ec583e2deefc2d">image_pack_exec</a>(C, op);
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 
<a name="l01731"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a588f9f94088e57fd837cb019d4a61e6e">01731</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a65c8790e60dcabf25f652dc9a30d9b25">IMAGE_OT_pack</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01732"></a>01732 {
<a name="l01733"></a>01733     <span class="comment">/* identifiers */</span>
<a name="l01734"></a>01734     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Pack Image&quot;</span>;
<a name="l01735"></a>01735     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Pack an image as embedded data into the .blend file&quot;</span>; 
<a name="l01736"></a>01736     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_pack&quot;</span>;
<a name="l01737"></a>01737     
<a name="l01738"></a>01738     <span class="comment">/* api callbacks */</span>
<a name="l01739"></a>01739     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#aea34591315733adef1ec583e2deefc2d">image_pack_exec</a>;
<a name="l01740"></a>01740     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ab2544895aa8ca8ae17b7b3e5c58af519">image_pack_invoke</a>;
<a name="l01741"></a>01741 
<a name="l01742"></a>01742     <span class="comment">/* flags */</span>
<a name="l01743"></a>01743     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745     <span class="comment">/* properties */</span>
<a name="l01746"></a>01746     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;as_png&quot;</span>, 0, <span class="stringliteral">&quot;Pack As PNG&quot;</span>, <span class="stringliteral">&quot;Pack image as lossless PNG&quot;</span>);
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 <span class="comment">/********************* unpack operator *********************/</span>
<a name="l01750"></a>01750 
<a name="l01751"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#add93e89d5829f69a57f557db1903547a">01751</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#add93e89d5829f69a57f557db1903547a">image_unpack_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01752"></a>01752 {
<a name="l01753"></a>01753     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01754"></a>01754     <span class="keywordtype">int</span> method = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;method&quot;</span>);
<a name="l01755"></a>01755 
<a name="l01756"></a>01756     <span class="comment">/* find the suppplied image by name */</span>
<a name="l01757"></a>01757     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;id&quot;</span>)) {
<a name="l01758"></a>01758         <span class="keywordtype">char</span> imaname[<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a6d7bce2e9ad79af316c9690a5b84b75c">MAX_ID_NAME</a> - 2];
<a name="l01759"></a>01759         <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;id&quot;</span>, imaname);
<a name="l01760"></a>01760         ima = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(&amp;<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C)-&gt;<a class="code" href="../../d0/dc0/structMain.html#a683bfdfa3f231a8a2cd1f88552a685dd">image</a>, imaname, offsetof(<a class="code" href="../../d8/d7e/structID.html">ID</a>, <a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>) + 2);
<a name="l01761"></a>01761         <span class="keywordflow">if</span> (!ima) ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01762"></a>01762     }
<a name="l01763"></a>01763     
<a name="l01764"></a>01764     <span class="keywordflow">if</span> (!ima || !ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>)
<a name="l01765"></a>01765         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>) {
<a name="l01768"></a>01768         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Unpacking movies or image sequences not supported&quot;</span>);
<a name="l01769"></a>01769         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.fileflags &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a7238d448ec1e56e3b370fc5345a30ab8">G_AUTOPACK</a>)
<a name="l01773"></a>01773         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;AutoPack is enabled, so image will be packed again on file save&quot;</span>);
<a name="l01774"></a>01774     
<a name="l01775"></a>01775     <span class="comment">/* XXX unpackImage frees image buffers */</span>
<a name="l01776"></a>01776     <a class="code" href="../../d6/d53/ED__render_8h.html#a5bd64056444412c65b860fc03acbe00a">ED_preview_kill_jobs</a>(C);
<a name="l01777"></a>01777     
<a name="l01778"></a>01778     <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a58206ff4671d9c0cb2d345c0a60be4a6">unpackImage</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, ima, method);
<a name="l01779"></a>01779     
<a name="l01780"></a>01780     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ima);
<a name="l01781"></a>01781 
<a name="l01782"></a>01782     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01783"></a>01783 }
<a name="l01784"></a>01784 
<a name="l01785"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a2f574198dc4f743bc5bf855650ab3be0">01785</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a2f574198dc4f743bc5bf855650ab3be0">image_unpack_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01786"></a>01786 {
<a name="l01787"></a>01787     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;id&quot;</span>))
<a name="l01790"></a>01790         <span class="keywordflow">return</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#add93e89d5829f69a57f557db1903547a">image_unpack_exec</a>(C, op);
<a name="l01791"></a>01791         
<a name="l01792"></a>01792     <span class="keywordflow">if</span> (!ima || !ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>)
<a name="l01793"></a>01793         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>) {
<a name="l01796"></a>01796         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Unpacking movies or image sequences not supported&quot;</span>);
<a name="l01797"></a>01797         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01798"></a>01798     }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.fileflags &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a7238d448ec1e56e3b370fc5345a30ab8">G_AUTOPACK</a>)
<a name="l01801"></a>01801         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;AutoPack is enabled, so image will be packed again on file save&quot;</span>);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803     <a class="code" href="../../d6/df1/ED__util_8h.html#ae1e29e09d0e1c200975acc112b4b7ac8">unpack_menu</a>(C, <span class="stringliteral">&quot;IMAGE_OT_unpack&quot;</span>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="stringliteral">&quot;textures&quot;</span>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>);
<a name="l01804"></a>01804 
<a name="l01805"></a>01805     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01806"></a>01806 }
<a name="l01807"></a>01807 
<a name="l01808"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a539354b9ea7329fdec7d9c8f9839ca81">01808</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a4db2d868b0e81db6aa8bceb8fb0c1752">IMAGE_OT_unpack</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01809"></a>01809 {
<a name="l01810"></a>01810     <span class="comment">/* identifiers */</span>
<a name="l01811"></a>01811     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Unpack Image&quot;</span>;
<a name="l01812"></a>01812     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Save an image packed in the .blend file to disk&quot;</span>; 
<a name="l01813"></a>01813     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_unpack&quot;</span>;
<a name="l01814"></a>01814     
<a name="l01815"></a>01815     <span class="comment">/* api callbacks */</span>
<a name="l01816"></a>01816     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#add93e89d5829f69a57f557db1903547a">image_unpack_exec</a>;
<a name="l01817"></a>01817     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a2f574198dc4f743bc5bf855650ab3be0">image_unpack_invoke</a>;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819     <span class="comment">/* flags */</span>
<a name="l01820"></a>01820     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01821"></a>01821     
<a name="l01822"></a>01822     <span class="comment">/* properties */</span>
<a name="l01823"></a>01823     <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;method&quot;</span>, <a class="code" href="../../d3/d29/rna__packedfile_8c.html#ae86f218a9aadbc0b60c208d6abd49013">unpack_method_items</a>, <a class="code" href="../../dc/d4d/DNA__packedFile__types_8h.html#a4a7d03c9908f51e4ad80be8c3eed30d3a147d00e91c5dd75ab03f6660668ba985">PF_USE_LOCAL</a>, <span class="stringliteral">&quot;Method&quot;</span>, <span class="stringliteral">&quot;How to unpack&quot;</span>);
<a name="l01824"></a>01824     <a class="code" href="../../dc/d7e/rna__define_8c.html#ac53a3ed18da454971065d5b4e4cb4d62">RNA_def_string</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a6d7bce2e9ad79af316c9690a5b84b75c">MAX_ID_NAME</a> - 2, <span class="stringliteral">&quot;Image Name&quot;</span>, <span class="stringliteral">&quot;Image datablock name to unpack&quot;</span>); <span class="comment">/* XXX, weark!, will fail with library, name collisions */</span>
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827 <span class="comment">/******************** sample image operator ********************/</span>
<a name="l01828"></a>01828 
<a name="l01829"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html">01829</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a> {
<a name="l01830"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a26e1be1e663e4b986c76f140e5901c93">01830</a>     <a class="code" href="../../d7/da9/structARegionType.html">ARegionType</a> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#a26e1be1e663e4b986c76f140e5901c93">art</a>;
<a name="l01831"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a0f6533be826f1998c9be6121f80fd555">01831</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#a0f6533be826f1998c9be6121f80fd555">draw_handle</a>;
<a name="l01832"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#ae509c7aff6dd6a6574a9d3b97e8d67e7">01832</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#aa61d0608e6ca5be1399278b5188b78ca">x</a>, <a class="code" href="../../d9/d11/structImageSampleInfo.html#ae509c7aff6dd6a6574a9d3b97e8d67e7">y</a>;
<a name="l01833"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a4297cd8461cde7e44cadbc39e305cf41">01833</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#a4297cd8461cde7e44cadbc39e305cf41">channels</a>;
<a name="l01834"></a>01834 
<a name="l01835"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">01835</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>[4];
<a name="l01836"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">01836</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[4];
<a name="l01837"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#ab6dc801e693b82ef2e39c2fffd5f229d">01837</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#ab6dc801e693b82ef2e39c2fffd5f229d">z</a>;
<a name="l01838"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a039a9dfddb7f52043fa47a4e9e508b86">01838</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#a039a9dfddb7f52043fa47a4e9e508b86">zf</a>;
<a name="l01839"></a>01839 
<a name="l01840"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#acc9e40dc26918f282a17f5a7adaa677c">01840</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#acc9e40dc26918f282a17f5a7adaa677c">colp</a>;
<a name="l01841"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">01841</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a>;
<a name="l01842"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#af751fdd65bd257b59b94f3be382d497b">01842</a>     <span class="keywordtype">int</span> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#af751fdd65bd257b59b94f3be382d497b">zp</a>;
<a name="l01843"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#a6e62f4d266cfa3bce609aa39a849b5b5">01843</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d9/d11/structImageSampleInfo.html#a6e62f4d266cfa3bce609aa39a849b5b5">zfp</a>;
<a name="l01844"></a>01844 
<a name="l01845"></a><a class="code" href="../../d9/d11/structImageSampleInfo.html#ab7ccbe3ba05d8bbdc3087b343f2f9586">01845</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d11/structImageSampleInfo.html#ab7ccbe3ba05d8bbdc3087b343f2f9586">draw</a>;
<a name="l01846"></a>01846 } <a class="code" href="../../d6/d1f/image__ops_8c.html#af80f994fefa12f870b3bd4500343db27">ImageSampleInfo</a>;
<a name="l01847"></a>01847 
<a name="l01848"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aa246e1f039fc88be754bcc278397bb6d">01848</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aa246e1f039fc88be754bcc278397bb6d">image_sample_draw</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">void</span> *arg_info)
<a name="l01849"></a>01849 {
<a name="l01850"></a>01850     <a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a> *info = arg_info;
<a name="l01851"></a>01851     <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ab7ccbe3ba05d8bbdc3087b343f2f9586">draw</a>) {
<a name="l01852"></a>01852         <span class="comment">/* no color management needed for images (color_manage=0) */</span>
<a name="l01853"></a>01853         <a class="code" href="../../de/d53/ED__image_8h.html#a7139dbf7af29cfb54d48d4204e9737c0">ED_image_draw_info</a>(ar, 0, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a4297cd8461cde7e44cadbc39e305cf41">channels</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aa61d0608e6ca5be1399278b5188b78ca">x</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae509c7aff6dd6a6574a9d3b97e8d67e7">y</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#acc9e40dc26918f282a17f5a7adaa677c">colp</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#af751fdd65bd257b59b94f3be382d497b">zp</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a6e62f4d266cfa3bce609aa39a849b5b5">zfp</a>);
<a name="l01854"></a>01854     }
<a name="l01855"></a>01855 }
<a name="l01856"></a>01856 
<a name="l01857"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aed2e2c3aac2767e10410a1f1da89a8e9">01857</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#aed2e2c3aac2767e10410a1f1da89a8e9">image_sample_apply</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01858"></a>01858 {
<a name="l01859"></a>01859     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01860"></a>01860     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l01861"></a>01861     <span class="keywordtype">void</span> *lock;
<a name="l01862"></a>01862     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../de/d53/ED__image_8h.html#a94a74feeb6fba43a3353a6948a49716c">ED_space_image_acquire_buffer</a>(sima, &amp;lock);
<a name="l01863"></a>01863     <a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a> *info = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01864"></a>01864     <span class="keywordtype">float</span> fx, fy;
<a name="l01865"></a>01865     
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01867"></a>01867         <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l01868"></a>01868         <span class="keywordflow">return</span>;
<a name="l01869"></a>01869     }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1], &amp;fx, &amp;fy);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="keywordflow">if</span> (fx &gt;= 0.0f &amp;&amp; fy &gt;= 0.0f &amp;&amp; fx &lt; 1.0f &amp;&amp; fy &lt; 1.0f) {
<a name="l01874"></a>01874         <span class="keywordtype">float</span> *fp;
<a name="l01875"></a>01875         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp;
<a name="l01876"></a>01876         <span class="keywordtype">int</span> x = (int)(fx * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>), y = (int)(fy * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(x, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> - 1);
<a name="l01879"></a>01879         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(y, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - 1);
<a name="l01880"></a>01880 
<a name="l01881"></a>01881         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aa61d0608e6ca5be1399278b5188b78ca">x</a> = x;
<a name="l01882"></a>01882         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae509c7aff6dd6a6574a9d3b97e8d67e7">y</a> = y;
<a name="l01883"></a>01883         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ab7ccbe3ba05d8bbdc3087b343f2f9586">draw</a> = 1;
<a name="l01884"></a>01884         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a4297cd8461cde7e44cadbc39e305cf41">channels</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#acc9e40dc26918f282a17f5a7adaa677c">colp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01887"></a>01887         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01888"></a>01888         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#af751fdd65bd257b59b94f3be382d497b">zp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01889"></a>01889         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a6e62f4d266cfa3bce609aa39a849b5b5">zfp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01890"></a>01890         
<a name="l01891"></a>01891         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l01892"></a>01892             cp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>[0] = cp[0];
<a name="l01895"></a>01895             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>[1] = cp[1];
<a name="l01896"></a>01896             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>[2] = cp[2];
<a name="l01897"></a>01897             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>[3] = cp[3];
<a name="l01898"></a>01898             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#acc9e40dc26918f282a17f5a7adaa677c">colp</a> = info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ae5640f3b30574d56be157e71f930dfe2">col</a>;
<a name="l01899"></a>01899 
<a name="l01900"></a>01900             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[0] = (float)cp[0] / 255.0f;
<a name="l01901"></a>01901             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[1] = (float)cp[1] / 255.0f;
<a name="l01902"></a>01902             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[2] = (float)cp[2] / 255.0f;
<a name="l01903"></a>01903             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[3] = (float)cp[3] / 255.0f;
<a name="l01904"></a>01904             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a> = info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>;
<a name="l01905"></a>01905         }
<a name="l01906"></a>01906         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01907"></a>01907             fp = (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>) * (y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x));
<a name="l01908"></a>01908 
<a name="l01909"></a>01909             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[0] = fp[0];
<a name="l01910"></a>01910             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[1] = fp[1];
<a name="l01911"></a>01911             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[2] = fp[2];
<a name="l01912"></a>01912             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>[3] = fp[3];
<a name="l01913"></a>01913             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a> = info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#aba39a3509f65986578e10ec9e199f6a1">colf</a>;
<a name="l01914"></a>01914         }
<a name="l01915"></a>01915 
<a name="l01916"></a>01916         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad9ce21fd6e42e77267839eb56d1c60f6">zbuf</a>) {
<a name="l01917"></a>01917             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ab6dc801e693b82ef2e39c2fffd5f229d">z</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad9ce21fd6e42e77267839eb56d1c60f6">zbuf</a>[y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x];
<a name="l01918"></a>01918             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#af751fdd65bd257b59b94f3be382d497b">zp</a> = &amp;info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ab6dc801e693b82ef2e39c2fffd5f229d">z</a>;
<a name="l01919"></a>01919         }
<a name="l01920"></a>01920         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a>) {
<a name="l01921"></a>01921             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a039a9dfddb7f52043fa47a4e9e508b86">zf</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a>[y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x];
<a name="l01922"></a>01922             info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a6e62f4d266cfa3bce609aa39a849b5b5">zfp</a> = &amp;info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a039a9dfddb7f52043fa47a4e9e508b86">zf</a>;
<a name="l01923"></a>01923         }
<a name="l01924"></a>01924         
<a name="l01925"></a>01925         <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac77779485c1d025f8eabb5686d58ac5a">cumap</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> == 4) {
<a name="l01926"></a>01926             <span class="comment">/* we reuse this callback for set curves point operators */</span>
<a name="l01927"></a>01927             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;point&quot;</span>)) {
<a name="l01928"></a>01928                 <span class="keywordtype">int</span> <a class="code" href="../../d8/dae/structpoint.html">point</a> = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;point&quot;</span>);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930                 <span class="keywordflow">if</span> (point == 1) {
<a name="l01931"></a>01931                     <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ada939d01e9436006abd067b30fab2e28">curvemapping_set_black_white</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac77779485c1d025f8eabb5686d58ac5a">cumap</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a>);
<a name="l01932"></a>01932                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l01933"></a>01933                         <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ae3fb9641167ce7ffd372d731605f4348">curvemapping_do_ibuf</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac77779485c1d025f8eabb5686d58ac5a">cumap</a>, ibuf);
<a name="l01934"></a>01934                 }
<a name="l01935"></a>01935                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (point == 0) {
<a name="l01936"></a>01936                     <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ada939d01e9436006abd067b30fab2e28">curvemapping_set_black_white</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac77779485c1d025f8eabb5686d58ac5a">cumap</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a9d4ae5d73ece94869df7a55364100fba">colfp</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01937"></a>01937                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l01938"></a>01938                         <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ae3fb9641167ce7ffd372d731605f4348">curvemapping_do_ibuf</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#ac77779485c1d025f8eabb5686d58ac5a">cumap</a>, ibuf);
<a name="l01939"></a>01939                 }
<a name="l01940"></a>01940             }
<a name="l01941"></a>01941         }
<a name="l01942"></a>01942                 
<a name="l01943"></a>01943         <span class="comment">// XXX node curve integration ..</span>
<a name="l01944"></a>01944 <span class="preprocessor">#if 0</span>
<a name="l01945"></a>01945 <span class="preprocessor"></span>        {
<a name="l01946"></a>01946             <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa, *cur = curarea;
<a name="l01947"></a>01947             
<a name="l01948"></a>01948             node_curvemap_sample(fp);   <span class="comment">/* sends global to node editor */</span>
<a name="l01949"></a>01949             <span class="keywordflow">for</span> (sa = <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.curscreen-&gt;areabase.first; sa; sa = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a884b59339f5c0d55408f8727bfc799b7">next</a>) {
<a name="l01950"></a>01950                 <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca2ef41082c072d92dbf2d57e20442751d">SPACE_NODE</a>) {
<a name="l01951"></a>01951                     areawinset(sa-&gt;win);
<a name="l01952"></a>01952                     scrarea_do_windraw(sa);
<a name="l01953"></a>01953                 }
<a name="l01954"></a>01954             }
<a name="l01955"></a>01955             node_curvemap_sample(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);     <span class="comment">/* clears global in node editor */</span>
<a name="l01956"></a>01956             curarea = cur;
<a name="l01957"></a>01957         }
<a name="l01958"></a>01958 <span class="preprocessor">#endif</span>
<a name="l01959"></a>01959 <span class="preprocessor"></span>    }
<a name="l01960"></a>01960     <span class="keywordflow">else</span>
<a name="l01961"></a>01961         info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#ab7ccbe3ba05d8bbdc3087b343f2f9586">draw</a> = 0;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963     <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l01964"></a>01964     <a class="code" href="../../d1/d12/ED__screen_8h.html#a0982c011d985308b08320d5f9604418b">ED_area_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C));
<a name="l01965"></a>01965 }
<a name="l01966"></a>01966 
<a name="l01967"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a623fe63fe7615034c781ea2624bd701e">01967</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a623fe63fe7615034c781ea2624bd701e">image_sample_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01968"></a>01968 {
<a name="l01969"></a>01969     <a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a> *info = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01970"></a>01970 
<a name="l01971"></a>01971     <a class="code" href="../../d0/d5f/ED__space__api_8h.html#af2341642ec2a46070cd7b0be6a6e716a">ED_region_draw_cb_exit</a>(info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a26e1be1e663e4b986c76f140e5901c93">art</a>, info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a0f6533be826f1998c9be6121f80fd555">draw_handle</a>);
<a name="l01972"></a>01972     <a class="code" href="../../d1/d12/ED__screen_8h.html#a0982c011d985308b08320d5f9604418b">ED_area_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C));
<a name="l01973"></a>01973     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(info);
<a name="l01974"></a>01974 }
<a name="l01975"></a>01975 
<a name="l01976"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ab937c935ddefe886a175ded411b0c392">01976</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ab937c935ddefe886a175ded411b0c392">image_sample_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01977"></a>01977 {
<a name="l01978"></a>01978     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l01979"></a>01979     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l01980"></a>01980     <a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a> *info;
<a name="l01981"></a>01981 
<a name="l01982"></a>01982     <span class="keywordflow">if</span> (!<a class="code" href="../../de/d53/ED__image_8h.html#a46c45d788cc30a6e36c38cae18ed4f9c">ED_space_image_has_buffer</a>(sima))
<a name="l01983"></a>01983         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01984"></a>01984     
<a name="l01985"></a>01985     info = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d11/structImageSampleInfo.html">ImageSampleInfo</a>), <span class="stringliteral">&quot;ImageSampleInfo&quot;</span>);
<a name="l01986"></a>01986     info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a26e1be1e663e4b986c76f140e5901c93">art</a> = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ae957cd551d82034b24008cfb99bbc4c7">type</a>;
<a name="l01987"></a>01987     info-&gt;<a class="code" href="../../d9/d11/structImageSampleInfo.html#a0f6533be826f1998c9be6121f80fd555">draw_handle</a> = <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a48864a13f19218cbd1ff98b7fe9eb958">ED_region_draw_cb_activate</a>(ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ae957cd551d82034b24008cfb99bbc4c7">type</a>, <a class="code" href="../../d6/d1f/image__ops_8c.html#aa246e1f039fc88be754bcc278397bb6d">image_sample_draw</a>, info, <a class="code" href="../../d0/d5f/ED__space__api_8h.html#aabcb5bd755a601a5c2d662858b74505b">REGION_DRAW_POST_PIXEL</a>);
<a name="l01988"></a>01988     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = info;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <a class="code" href="../../d6/d1f/image__ops_8c.html#aed2e2c3aac2767e10410a1f1da89a8e9">image_sample_apply</a>(C, op, event);
<a name="l01991"></a>01991 
<a name="l01992"></a>01992     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l01993"></a>01993 
<a name="l01994"></a>01994     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01995"></a>01995 }
<a name="l01996"></a>01996 
<a name="l01997"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4ff5249e9b37dca7ec224d199cc226b0">01997</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a4ff5249e9b37dca7ec224d199cc226b0">image_sample_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01998"></a>01998 {
<a name="l01999"></a>01999     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l02000"></a>02000         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>:
<a name="l02001"></a>02001         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>: <span class="comment">// XXX hardcoded</span>
<a name="l02002"></a>02002             <a class="code" href="../../d6/d1f/image__ops_8c.html#a623fe63fe7615034c781ea2624bd701e">image_sample_exit</a>(C, op);
<a name="l02003"></a>02003             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02004"></a>02004         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l02005"></a>02005             <a class="code" href="../../d6/d1f/image__ops_8c.html#aed2e2c3aac2767e10410a1f1da89a8e9">image_sample_apply</a>(C, op, event);
<a name="l02006"></a>02006             <span class="keywordflow">break</span>;
<a name="l02007"></a>02007     }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02010"></a>02010 }
<a name="l02011"></a>02011 
<a name="l02012"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a175ffa27a8f5612816e5bc999008f8f8">02012</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a175ffa27a8f5612816e5bc999008f8f8">image_sample_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02013"></a>02013 {
<a name="l02014"></a>02014     <a class="code" href="../../d6/d1f/image__ops_8c.html#a623fe63fe7615034c781ea2624bd701e">image_sample_exit</a>(C, op);
<a name="l02015"></a>02015     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02016"></a>02016 }
<a name="l02017"></a>02017 
<a name="l02018"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a1ec4f1d652e6ea352e9c8cbdf492396b">02018</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a4a819af0acadc383ae41dc37aa58d2b1">IMAGE_OT_sample</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02019"></a>02019 {
<a name="l02020"></a>02020     <span class="comment">/* identifiers */</span>
<a name="l02021"></a>02021     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Sample Color&quot;</span>;
<a name="l02022"></a>02022     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_sample&quot;</span>;
<a name="l02023"></a>02023     
<a name="l02024"></a>02024     <span class="comment">/* api callbacks */</span>
<a name="l02025"></a>02025     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ab937c935ddefe886a175ded411b0c392">image_sample_invoke</a>;
<a name="l02026"></a>02026     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a4ff5249e9b37dca7ec224d199cc226b0">image_sample_modal</a>;
<a name="l02027"></a>02027     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a175ffa27a8f5612816e5bc999008f8f8">image_sample_cancel</a>;
<a name="l02028"></a>02028     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#aede415ad04ee0ccc1b9fa7bbbe4eb0ab">space_image_image_sample_poll</a>;
<a name="l02029"></a>02029 
<a name="l02030"></a>02030     <span class="comment">/* flags */</span>
<a name="l02031"></a>02031     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l02032"></a>02032 }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034 <span class="comment">/******************** sample line operator ********************/</span>
<a name="l02035"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a45fb28a0c2bc69d8bc16972dd8b80362">02035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a45fb28a0c2bc69d8bc16972dd8b80362">image_sample_line_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02036"></a>02036 {
<a name="l02037"></a>02037     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l02038"></a>02038     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l02039"></a>02039     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02040"></a>02040 
<a name="l02041"></a>02041     <span class="keywordtype">int</span> x_start = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;xstart&quot;</span>);
<a name="l02042"></a>02042     <span class="keywordtype">int</span> y_start = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;ystart&quot;</span>);
<a name="l02043"></a>02043     <span class="keywordtype">int</span> x_end = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;xend&quot;</span>);
<a name="l02044"></a>02044     <span class="keywordtype">int</span> y_end = <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;yend&quot;</span>);
<a name="l02045"></a>02045     
<a name="l02046"></a>02046     <span class="keywordtype">void</span> *lock;
<a name="l02047"></a>02047     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../de/d53/ED__image_8h.html#a94a74feeb6fba43a3353a6948a49716c">ED_space_image_acquire_buffer</a>(sima, &amp;lock);
<a name="l02048"></a>02048     <a class="code" href="../../d4/d8b/structHistogram.html">Histogram</a> *hist = &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a940c07c5bd6e2e40e1476edd3b648bd2">sample_line_hist</a>;
<a name="l02049"></a>02049     
<a name="l02050"></a>02050     <span class="keywordtype">float</span> x1f, y1f, x2f, y2f;
<a name="l02051"></a>02051     <span class="keywordtype">int</span> x1, y1, x2, y2;
<a name="l02052"></a>02052     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, x, y;
<a name="l02053"></a>02053     <span class="keywordtype">float</span> *fp;
<a name="l02054"></a>02054     <span class="keywordtype">float</span> rgb[3];
<a name="l02055"></a>02055     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp;
<a name="l02056"></a>02056     
<a name="l02057"></a>02057     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02058"></a>02058         <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l02059"></a>02059         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02060"></a>02060     }
<a name="l02061"></a>02061     <span class="comment">/* hmmmm */</span>
<a name="l02062"></a>02062     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> &lt; 3) {
<a name="l02063"></a>02063         <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l02064"></a>02064         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02065"></a>02065     }
<a name="l02066"></a>02066     
<a name="l02067"></a>02067     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, x_start, y_start, &amp;x1f, &amp;y1f);
<a name="l02068"></a>02068     <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, x_end, y_end, &amp;x2f, &amp;y2f);
<a name="l02069"></a>02069     x1 = 0.5f + x1f * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l02070"></a>02070     x2 = 0.5f + x2f * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l02071"></a>02071     y1 = 0.5f + y1f * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l02072"></a>02072     y2 = 0.5f + y2f * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l02073"></a>02073     
<a name="l02074"></a>02074     hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a0050c38c1ea977412ac24f4618317677">channels</a> = 3;
<a name="l02075"></a>02075     hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a5fafc7f45c5204b858bb072494f6ccf7">x_resolution</a> = 256;
<a name="l02076"></a>02076     hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a4498cca9b8c591670c8014f69c187062">xmax</a> = 1.0f;
<a name="l02077"></a>02077     hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#aa36a62911184433ef4d0395a1e04bfff">ymax</a> = 1.0f;
<a name="l02078"></a>02078     
<a name="l02079"></a>02079     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++) {
<a name="l02080"></a>02080         x = (int)(0.5f + x1 + (<span class="keywordtype">float</span>)i * (x2 - x1) / 255.0f);
<a name="l02081"></a>02081         y = (int)(0.5f + y1 + (<span class="keywordtype">float</span>)i * (y2 - y1) / 255.0f);
<a name="l02082"></a>02082         
<a name="l02083"></a>02083         <span class="keywordflow">if</span> (x &lt; 0 || y &lt; 0 || x &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> || y &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) {
<a name="l02084"></a>02084             hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a797e8fe830f9d465340118495bda5316">data_luma</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a98fe942996e6e97046475e3c8c26abf5">data_r</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#aef06ab5d471910d1656df2cf933422fb">data_g</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#ad6b3dd51a648ab15f1e2de154f1310db">data_b</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l02085"></a>02085         }
<a name="l02086"></a>02086         <span class="keywordflow">else</span> {
<a name="l02087"></a>02087             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l02088"></a>02088                 fp = (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>) * (y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x));
<a name="l02089"></a>02089 
<a name="l02090"></a>02090                 <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l02091"></a>02091                     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ac0586614af7cf4cfa2c1718015b85383">linearrgb_to_srgb_v3_v3</a>(rgb, fp);
<a name="l02092"></a>02092                 <span class="keywordflow">else</span>
<a name="l02093"></a>02093                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rgb, fp);
<a name="l02094"></a>02094 
<a name="l02095"></a>02095                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a98fe942996e6e97046475e3c8c26abf5">data_r</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = rgb[0];
<a name="l02096"></a>02096                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#aef06ab5d471910d1656df2cf933422fb">data_g</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = rgb[1];
<a name="l02097"></a>02097                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#ad6b3dd51a648ab15f1e2de154f1310db">data_b</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = rgb[2];
<a name="l02098"></a>02098                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a797e8fe830f9d465340118495bda5316">data_luma</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ae01a5d537c3a638ab0c898b81981a27e">rgb_to_luma</a>(rgb);
<a name="l02099"></a>02099             }
<a name="l02100"></a>02100             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l02101"></a>02101                 cp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x);
<a name="l02102"></a>02102                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a98fe942996e6e97046475e3c8c26abf5">data_r</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (float)cp[0] / 255.0f;
<a name="l02103"></a>02103                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#aef06ab5d471910d1656df2cf933422fb">data_g</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (float)cp[1] / 255.0f;
<a name="l02104"></a>02104                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#ad6b3dd51a648ab15f1e2de154f1310db">data_b</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (float)cp[2] / 255.0f;
<a name="l02105"></a>02105                 hist-&gt;<a class="code" href="../../d4/d8b/structHistogram.html#a797e8fe830f9d465340118495bda5316">data_luma</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (float)<a class="code" href="../../d8/de1/BLI__math__color_8h.html#af7f8b68e0162ef6a72a0781367b71154">rgb_to_luma_byte</a>(cp) / 255.0f;
<a name="l02106"></a>02106             }
<a name="l02107"></a>02107         }
<a name="l02108"></a>02108     }
<a name="l02109"></a>02109     
<a name="l02110"></a>02110     <a class="code" href="../../de/d53/ED__image_8h.html#a4f95011fe2bda4cd37aac76ef46d6e36">ED_space_image_release_buffer</a>(sima, lock);
<a name="l02111"></a>02111     
<a name="l02112"></a>02112     <a class="code" href="../../d1/d12/ED__screen_8h.html#a0982c011d985308b08320d5f9604418b">ED_area_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C));
<a name="l02113"></a>02113     
<a name="l02114"></a>02114     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02115"></a>02115 }
<a name="l02116"></a>02116 
<a name="l02117"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a18d8f6ded91194be99030e9a3ee81beb">02117</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a18d8f6ded91194be99030e9a3ee81beb">image_sample_line_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02118"></a>02118 {
<a name="l02119"></a>02119     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l02120"></a>02120     
<a name="l02121"></a>02121     <span class="keywordflow">if</span> (!<a class="code" href="../../de/d53/ED__image_8h.html#a46c45d788cc30a6e36c38cae18ed4f9c">ED_space_image_has_buffer</a>(sima))
<a name="l02122"></a>02122         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02123"></a>02123     
<a name="l02124"></a>02124     <span class="keywordflow">return</span> <a class="code" href="../../d6/dae/wm__operators_8c.html#a48c9fb2a38a7a7c09734895f18caab31">WM_gesture_straightline_invoke</a>(C, op, event);
<a name="l02125"></a>02125 }
<a name="l02126"></a>02126 
<a name="l02127"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ad0b90cfaed341542f78f165ba012af03">02127</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#ac41eca326a6e223c2bfdbff21a6e3561">IMAGE_OT_sample_line</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02128"></a>02128 {
<a name="l02129"></a>02129     <span class="comment">/* identifiers */</span>
<a name="l02130"></a>02130     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Sample Line&quot;</span>;
<a name="l02131"></a>02131     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_sample_line&quot;</span>;
<a name="l02132"></a>02132     
<a name="l02133"></a>02133     <span class="comment">/* api callbacks */</span>
<a name="l02134"></a>02134     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a18d8f6ded91194be99030e9a3ee81beb">image_sample_line_invoke</a>;
<a name="l02135"></a>02135     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#ae116173f85b2588dc769d0114e735d07">WM_gesture_straightline_modal</a>;
<a name="l02136"></a>02136     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a45fb28a0c2bc69d8bc16972dd8b80362">image_sample_line_exec</a>;
<a name="l02137"></a>02137     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d7/df9/image__intern_8h.html#afc3333321e9090006c9b2985e8185dcd">space_image_main_area_poll</a>;
<a name="l02138"></a>02138     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#aadbae8750cb8c162647edb64d67b4b50">WM_gesture_straightline_cancel</a>;
<a name="l02139"></a>02139     
<a name="l02140"></a>02140     <span class="comment">/* flags */</span>
<a name="l02141"></a>02141     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = 0; <span class="comment">/* no undo/register since this operates on the space */</span>
<a name="l02142"></a>02142     
<a name="l02143"></a>02143     <a class="code" href="../../d6/dae/wm__operators_8c.html#a71e9ab2726fd38fcb4e63326aa5fcf11">WM_operator_properties_gesture_straightline</a>(ot, <a class="code" href="../../db/da6/wm__cursors_8h.html#aeb8d583a31cccbb8cf9b452a8e298063a003cebaaa983d870cd4463a804a21f9d">CURSOR_EDIT</a>);
<a name="l02144"></a>02144 }
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 <span class="comment">/******************** set curve point operator ********************/</span>
<a name="l02147"></a>02147 
<a name="l02148"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#afa8de5698f102c91dba8cae96abd9d86">02148</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a117af47c5a685a9e55ea114dd156b21c">IMAGE_OT_curves_point_set</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02149"></a>02149 {
<a name="l02150"></a>02150     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> point_items[] = {
<a name="l02151"></a>02151         {0, <span class="stringliteral">&quot;BLACK_POINT&quot;</span>, 0, <span class="stringliteral">&quot;Black Point&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02152"></a>02152         {1, <span class="stringliteral">&quot;WHITE_POINT&quot;</span>, 0, <span class="stringliteral">&quot;White Point&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02153"></a>02153         {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l02154"></a>02154     };
<a name="l02155"></a>02155 
<a name="l02156"></a>02156     <span class="comment">/* identifiers */</span>
<a name="l02157"></a>02157     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Set Curves Point&quot;</span>;
<a name="l02158"></a>02158     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_curves_point_set&quot;</span>;
<a name="l02159"></a>02159 
<a name="l02160"></a>02160     <span class="comment">/* flags */</span>
<a name="l02161"></a>02161     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02162"></a>02162     
<a name="l02163"></a>02163     <span class="comment">/* api callbacks */</span>
<a name="l02164"></a>02164     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#ab937c935ddefe886a175ded411b0c392">image_sample_invoke</a>;
<a name="l02165"></a>02165     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a4ff5249e9b37dca7ec224d199cc226b0">image_sample_modal</a>;
<a name="l02166"></a>02166     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a175ffa27a8f5612816e5bc999008f8f8">image_sample_cancel</a>;
<a name="l02167"></a>02167     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a569e6b873dd54da912532431dfac2e59">space_image_main_area_not_uv_brush_poll</a>;
<a name="l02168"></a>02168 
<a name="l02169"></a>02169     <span class="comment">/* properties */</span>
<a name="l02170"></a>02170     <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;point&quot;</span>, point_items, 0, <span class="stringliteral">&quot;Point&quot;</span>, <span class="stringliteral">&quot;Set black point or white point for curves&quot;</span>);
<a name="l02171"></a>02171 }
<a name="l02172"></a>02172 
<a name="l02173"></a>02173 <span class="comment">/******************** record composite operator *********************/</span>
<a name="l02174"></a>02174 
<a name="l02175"></a><a class="code" href="../../d3/d14/structRecordCompositeData.html">02175</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> {
<a name="l02176"></a><a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">02176</a>     <a class="code" href="../../d9/d33/structwmTimer.html">wmTimer</a> *<a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">timer</a>;
<a name="l02177"></a><a class="code" href="../../d3/d14/structRecordCompositeData.html#a6c278b7e81fa6954f7ce728e67408cad">02177</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d14/structRecordCompositeData.html#a6c278b7e81fa6954f7ce728e67408cad">old_cfra</a>;
<a name="l02178"></a><a class="code" href="../../d3/d14/structRecordCompositeData.html#a631d35e024b9e37b3a75088683f19637">02178</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d14/structRecordCompositeData.html#a631d35e024b9e37b3a75088683f19637">sfra</a>, <a class="code" href="../../d3/d14/structRecordCompositeData.html#a6b427fbe8245a3de6f075299994d1f71">efra</a>;
<a name="l02179"></a>02179 } <a class="code" href="../../d6/d1f/image__ops_8c.html#a1bb0ab8eb9b20de56a8a0d83dd4a90e0">RecordCompositeData</a>;
<a name="l02180"></a>02180 
<a name="l02181"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#ab5fc7c897a7e08c623faa78d98902e53">02181</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#ab5fc7c897a7e08c623faa78d98902e53">image_record_composite_apply</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02182"></a>02182 {
<a name="l02183"></a>02183     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l02184"></a>02184     <a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> *rcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02185"></a>02185     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02186"></a>02186     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l02187"></a>02187     
<a name="l02188"></a>02188     <a class="code" href="../../de/d3c/wm__cursors_8c.html#a588fff5b53e20daf307076ba71b85d22">WM_timecursor</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>);
<a name="l02189"></a>02189 
<a name="l02190"></a>02190     <span class="comment">// XXX scene-&gt;nodetree-&gt;test_break= blender_test_break;</span>
<a name="l02191"></a>02191     <span class="comment">// XXX scene-&gt;nodetree-&gt;test_break= NULL;</span>
<a name="l02192"></a>02192     
<a name="l02193"></a>02193     <a class="code" href="../../d2/d77/BKE__image_8h.html#a3d29cee878a4de9eaca8e10ed37473a3">BKE_image_all_free_anim_ibufs</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>);
<a name="l02194"></a>02194     <a class="code" href="../../d4/d91/BKE__node_8h.html#adb0283118cf57b71b767e17fc1f5a29f">ntreeCompositTagAnimated</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a09a194ec2fd08925c48b3d0a692bd14d">nodetree</a>);
<a name="l02195"></a>02195     <a class="code" href="../../d4/d91/BKE__node_8h.html#a7a9f8c512b1d325d4c3b06486591d362">ntreeCompositExecTree</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a09a194ec2fd08925c48b3d0a692bd14d">nodetree</a>, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> != rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a6c278b7e81fa6954f7ce728e67408cad">old_cfra</a>);  <span class="comment">/* 1 is no previews */</span>
<a name="l02196"></a>02196 
<a name="l02197"></a>02197     <a class="code" href="../../d1/d12/ED__screen_8h.html#a0982c011d985308b08320d5f9604418b">ED_area_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C));
<a name="l02198"></a>02198     
<a name="l02199"></a>02199     ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>, &amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>);
<a name="l02200"></a>02200     <span class="comment">/* save memory in flipbooks */</span>
<a name="l02201"></a>02201     <span class="keywordflow">if</span> (ibuf)
<a name="l02202"></a>02202         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0d2ec7ce9e9b8e094f31e6a4535ce8d3">imb_freerectfloatImBuf</a>(ibuf);
<a name="l02203"></a>02203     
<a name="l02204"></a>02204     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>++;
<a name="l02205"></a>02205 
<a name="l02206"></a>02206     <span class="keywordflow">return</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> &lt;= rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a6b427fbe8245a3de6f075299994d1f71">efra</a>);
<a name="l02207"></a>02207 }
<a name="l02208"></a>02208 
<a name="l02209"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a1c45df67307ad2c0290fd474eb1672c0">02209</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a1c45df67307ad2c0290fd474eb1672c0">image_record_composite_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02210"></a>02210 {
<a name="l02211"></a>02211     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l02212"></a>02212     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02213"></a>02213     <a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> *rcd;
<a name="l02214"></a>02214 
<a name="l02215"></a>02215     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a> &lt; 2)
<a name="l02216"></a>02216         <span class="keywordflow">return</span> 0;
<a name="l02217"></a>02217     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a09a194ec2fd08925c48b3d0a692bd14d">nodetree</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02218"></a>02218         <span class="keywordflow">return</span> 0;
<a name="l02219"></a>02219     
<a name="l02220"></a>02220     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = rcd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a>), <span class="stringliteral">&quot;ImageRecordCompositeData&quot;</span>);
<a name="l02221"></a>02221 
<a name="l02222"></a>02222     rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a6c278b7e81fa6954f7ce728e67408cad">old_cfra</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l02223"></a>02223     rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a631d35e024b9e37b3a75088683f19637">sfra</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#a69e7d2b76006d695daeaae9832df2c83">sfra</a>;
<a name="l02224"></a>02224     rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a6b427fbe8245a3de6f075299994d1f71">efra</a> = sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#a69e7d2b76006d695daeaae9832df2c83">sfra</a> + sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a> - 1;
<a name="l02225"></a>02225     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> = rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a631d35e024b9e37b3a75088683f19637">sfra</a>;
<a name="l02226"></a>02226 
<a name="l02227"></a>02227     <span class="keywordflow">return</span> 1;
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 
<a name="l02230"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">02230</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">image_record_composite_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02231"></a>02231 {
<a name="l02232"></a>02232     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02233"></a>02233     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l02234"></a>02234     <a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> *rcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02235"></a>02235 
<a name="l02236"></a>02236     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> = rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#a6c278b7e81fa6954f7ce728e67408cad">old_cfra</a>;
<a name="l02237"></a>02237 
<a name="l02238"></a>02238     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ab8500ccfbffb6b57f4e0645e0f9a4759">WM_cursor_restore</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C));
<a name="l02239"></a>02239 
<a name="l02240"></a>02240     <span class="keywordflow">if</span> (rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">timer</a>)
<a name="l02241"></a>02241         <a class="code" href="../../d7/d6e/wm__window_8c.html#a1a9f31ba88dd1dd3982b3d8f02de2e75">WM_event_remove_timer</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">timer</a>);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>);
<a name="l02244"></a>02244 
<a name="l02245"></a>02245     <span class="comment">// XXX play_anim(0);</span>
<a name="l02246"></a>02246     <span class="comment">// XXX allqueue(REDRAWNODE, 1);</span>
<a name="l02247"></a>02247 
<a name="l02248"></a>02248     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rcd);
<a name="l02249"></a>02249 }
<a name="l02250"></a>02250 
<a name="l02251"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a51dcce48d9746a3fa289628ad8ee32a4">02251</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a51dcce48d9746a3fa289628ad8ee32a4">image_record_composite_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02252"></a>02252 {
<a name="l02253"></a>02253     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#a1c45df67307ad2c0290fd474eb1672c0">image_record_composite_init</a>(C, op))
<a name="l02254"></a>02254         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02255"></a>02255     
<a name="l02256"></a>02256     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d1f/image__ops_8c.html#ab5fc7c897a7e08c623faa78d98902e53">image_record_composite_apply</a>(C, op))
<a name="l02257"></a>02257         ;
<a name="l02258"></a>02258     
<a name="l02259"></a>02259     <a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">image_record_composite_exit</a>(C, op);
<a name="l02260"></a>02260     
<a name="l02261"></a>02261     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02262"></a>02262 }
<a name="l02263"></a>02263 
<a name="l02264"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a8853ee8d7369cc62ea6567c1c48e23b5">02264</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a8853ee8d7369cc62ea6567c1c48e23b5">image_record_composite_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l02265"></a>02265 {
<a name="l02266"></a>02266     <a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> *rcd;
<a name="l02267"></a>02267     
<a name="l02268"></a>02268     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#a1c45df67307ad2c0290fd474eb1672c0">image_record_composite_init</a>(C, op))
<a name="l02269"></a>02269         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02270"></a>02270 
<a name="l02271"></a>02271     rcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02272"></a>02272     rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">timer</a> = <a class="code" href="../../d7/d6e/wm__window_8c.html#af5bdd7109c7ea81c77a89d9f41585f3a">WM_event_add_timer</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), <a class="code" href="../../d1/d40/wm__event__types_8h.html#a599217205dc3092c26567a2bd868ef3a">TIMER</a>, 0.0f);
<a name="l02273"></a>02273     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l02274"></a>02274 
<a name="l02275"></a>02275     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#ab5fc7c897a7e08c623faa78d98902e53">image_record_composite_apply</a>(C, op))
<a name="l02276"></a>02276         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02277"></a>02277 
<a name="l02278"></a>02278     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02279"></a>02279 }
<a name="l02280"></a>02280 
<a name="l02281"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a0c01708492f787819c38dfa4ff95323b">02281</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a0c01708492f787819c38dfa4ff95323b">image_record_composite_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02282"></a>02282 {
<a name="l02283"></a>02283     <a class="code" href="../../d3/d14/structRecordCompositeData.html">RecordCompositeData</a> *rcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02284"></a>02284 
<a name="l02285"></a>02285     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l02286"></a>02286         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a599217205dc3092c26567a2bd868ef3a">TIMER</a>:
<a name="l02287"></a>02287             <span class="keywordflow">if</span> (rcd-&gt;<a class="code" href="../../d3/d14/structRecordCompositeData.html#af907b60e4ece92617a0c935125ffe9b6">timer</a> == event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#afe8f2bc4e7e67063e0e2a92b08056c17">customdata</a>) {
<a name="l02288"></a>02288                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d1f/image__ops_8c.html#ab5fc7c897a7e08c623faa78d98902e53">image_record_composite_apply</a>(C, op)) {
<a name="l02289"></a>02289                     <a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">image_record_composite_exit</a>(C, op);
<a name="l02290"></a>02290                     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02291"></a>02291                 }
<a name="l02292"></a>02292             }
<a name="l02293"></a>02293             <span class="keywordflow">break</span>;
<a name="l02294"></a>02294         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#abe3de76b73fb856d283d4da41ad109e8">ESCKEY</a>:
<a name="l02295"></a>02295             <a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">image_record_composite_exit</a>(C, op);
<a name="l02296"></a>02296             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02297"></a>02297     }
<a name="l02298"></a>02298 
<a name="l02299"></a>02299     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02300"></a>02300 }
<a name="l02301"></a>02301 
<a name="l02302"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a30e968665a9492e53a24c4fbba521881">02302</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a30e968665a9492e53a24c4fbba521881">image_record_composite_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02303"></a>02303 {
<a name="l02304"></a>02304     <a class="code" href="../../d6/d1f/image__ops_8c.html#a811a3462f7f42f5310b0c19789233fef">image_record_composite_exit</a>(C, op);
<a name="l02305"></a>02305     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02306"></a>02306 }
<a name="l02307"></a>02307 
<a name="l02308"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a0a75c7c65530b2f522ea30a56831b9c2">02308</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a88ee993a1fac56ad3202a4270e1eeb34">IMAGE_OT_record_composite</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02309"></a>02309 {
<a name="l02310"></a>02310     <span class="comment">/* identifiers */</span>
<a name="l02311"></a>02311     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Record Composite&quot;</span>;
<a name="l02312"></a>02312     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_record_composite&quot;</span>;
<a name="l02313"></a>02313     
<a name="l02314"></a>02314     <span class="comment">/* api callbacks */</span>
<a name="l02315"></a>02315     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a51dcce48d9746a3fa289628ad8ee32a4">image_record_composite_exec</a>;
<a name="l02316"></a>02316     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a8853ee8d7369cc62ea6567c1c48e23b5">image_record_composite_invoke</a>;
<a name="l02317"></a>02317     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a0c01708492f787819c38dfa4ff95323b">image_record_composite_modal</a>;
<a name="l02318"></a>02318     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a30e968665a9492e53a24c4fbba521881">image_record_composite_cancel</a>;
<a name="l02319"></a>02319     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a1b57cd2f0b597d53da212dea4ce73b40">space_image_buffer_exists_poll</a>;
<a name="l02320"></a>02320 }
<a name="l02321"></a>02321 
<a name="l02322"></a>02322 <span class="comment">/********************* cycle render slot operator *********************/</span>
<a name="l02323"></a>02323 
<a name="l02324"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a4c6d1d10c9ac12dbb602f8721453cdcb">02324</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a4c6d1d10c9ac12dbb602f8721453cdcb">image_cycle_render_slot_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l02325"></a>02325 {
<a name="l02326"></a>02326     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l02327"></a>02327 
<a name="l02328"></a>02328     <span class="keywordflow">return</span> (ima &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>);
<a name="l02329"></a>02329 }
<a name="l02330"></a>02330 
<a name="l02331"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a678ed1e7692795495b7d21da432a004d">02331</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d1f/image__ops_8c.html#a678ed1e7692795495b7d21da432a004d">image_cycle_render_slot_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02332"></a>02332 {
<a name="l02333"></a>02333     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/d01/BKE__context_8h.html#aa4730d536a7c5b2bb40d3dd4f0048807">CTX_data_edit_image</a>(C);
<a name="l02334"></a>02334     <span class="keywordtype">int</span> a, slot, cur = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>;
<a name="l02335"></a>02335     <span class="keyword">const</span> <span class="keywordtype">short</span> use_reverse = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;reverse&quot;</span>);
<a name="l02336"></a>02336 
<a name="l02337"></a>02337     <span class="keywordflow">for</span> (a = 1; a &lt; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad925558a1ce78f2ac54939303d72f771">IMA_MAX_RENDER_SLOT</a>; a++) {
<a name="l02338"></a>02338         slot = (cur + (use_reverse ? -a : a)) % <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad925558a1ce78f2ac54939303d72f771">IMA_MAX_RENDER_SLOT</a>;
<a name="l02339"></a>02339         <span class="keywordflow">if</span> (slot &lt; 0) slot += <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad925558a1ce78f2ac54939303d72f771">IMA_MAX_RENDER_SLOT</a>;
<a name="l02340"></a>02340 
<a name="l02341"></a>02341         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[slot] || slot == ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>) {
<a name="l02342"></a>02342             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> = slot;
<a name="l02343"></a>02343             <span class="keywordflow">break</span>;
<a name="l02344"></a>02344         }
<a name="l02345"></a>02345     }
<a name="l02346"></a>02346 
<a name="l02347"></a>02347     <span class="keywordflow">if</span> (a == IMA_MAX_RENDER_SLOT)
<a name="l02348"></a>02348         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> = ((cur == 1) ? 0 : 1);
<a name="l02349"></a>02349     
<a name="l02350"></a>02350     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a1f2c5ee380a0a55abaf43b7bceeb7688">ND_DRAW</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02351"></a>02351 
<a name="l02352"></a>02352     <span class="comment">/* no undo push for browsing existing */</span>
<a name="l02353"></a>02353     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>] || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> == ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>)
<a name="l02354"></a>02354         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02355"></a>02355     
<a name="l02356"></a>02356     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02357"></a>02357 }
<a name="l02358"></a>02358 
<a name="l02359"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#a175dc5795548a720a8dd087a383f3123">02359</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/df9/image__intern_8h.html#a9c2a0ea39e2c35cb9d9c3d7222c57333">IMAGE_OT_cycle_render_slot</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02360"></a>02360 {
<a name="l02361"></a>02361     <span class="comment">/* identifiers */</span>
<a name="l02362"></a>02362     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Cycle Render Slot&quot;</span>;
<a name="l02363"></a>02363     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;IMAGE_OT_cycle_render_slot&quot;</span>;
<a name="l02364"></a>02364     
<a name="l02365"></a>02365     <span class="comment">/* api callbacks */</span>
<a name="l02366"></a>02366     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a678ed1e7692795495b7d21da432a004d">image_cycle_render_slot_exec</a>;
<a name="l02367"></a>02367     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d6/d1f/image__ops_8c.html#a4c6d1d10c9ac12dbb602f8721453cdcb">image_cycle_render_slot_poll</a>;
<a name="l02368"></a>02368 
<a name="l02369"></a>02369     <span class="comment">/* flags */</span>
<a name="l02370"></a>02370     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;reverse&quot;</span>, 0, <span class="stringliteral">&quot;Cycle in Reverse&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02373"></a>02373 }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375 <span class="comment">/******************** TODO ********************/</span>
<a name="l02376"></a>02376 
<a name="l02377"></a>02377 <span class="comment">/* XXX notifier? */</span>
<a name="l02378"></a>02378 
<a name="l02379"></a>02379 <span class="comment">/* goes over all ImageUsers, and sets frame numbers if auto-refresh is set */</span>
<a name="l02380"></a>02380 
<a name="l02381"></a><a class="code" href="../../d6/d1f/image__ops_8c.html#aeea93a7c79ead6b2ecb5bf40056ec9e6">02381</a> <span class="keywordtype">void</span> <a class="code" href="../../de/d53/ED__image_8h.html#ae9d0bf675b32f5d6f26b55a0e5fa1038">ED_image_update_frame</a>(<span class="keyword">const</span> <a class="code" href="../../d0/dc0/structMain.html">Main</a> *mainp, <span class="keywordtype">int</span> cfra)
<a name="l02382"></a>02382 {
<a name="l02383"></a>02383     <a class="code" href="../../d4/dc3/structwmWindowManager.html">wmWindowManager</a> *wm;
<a name="l02384"></a>02384     <a class="code" href="../../dc/da4/structwmWindow.html">wmWindow</a> *win;
<a name="l02385"></a>02385     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l02386"></a>02386     
<a name="l02387"></a>02387     <span class="comment">/* texture users */</span>
<a name="l02388"></a>02388     <span class="keywordflow">for</span> (tex = mainp-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tex; tex = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l02389"></a>02389         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>) {
<a name="l02390"></a>02390             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>)) {
<a name="l02391"></a>02391                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l02392"></a>02392                     <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>, cfra, 0);
<a name="l02393"></a>02393             }
<a name="l02394"></a>02394         }
<a name="l02395"></a>02395     }
<a name="l02396"></a>02396     
<a name="l02397"></a>02397     <span class="comment">/* image window, compo node users */</span>
<a name="l02398"></a>02398     <span class="keywordflow">for</span> (wm = mainp-&gt;<a class="code" href="../../d0/dc0/structMain.html#a1c415972a9fb2c7ce05e14d83affa0d8">wm</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; wm; wm = wm-&gt;<a class="code" href="../../d4/dc3/structwmWindowManager.html#a12a2dca17b6339529f24d0a850b35f41">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) { <span class="comment">/* only 1 wm */</span>
<a name="l02399"></a>02399         <span class="keywordflow">for</span> (win = wm-&gt;<a class="code" href="../../d4/dc3/structwmWindowManager.html#a2b7d1cc89812b5104dc05ecfd46bce6b">windows</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; win; win = win-&gt;<a class="code" href="../../dc/da4/structwmWindow.html#accffa1b62f114b1781206c921fc92be1">next</a>) {
<a name="l02400"></a>02400             <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa;
<a name="l02401"></a>02401             <span class="keywordflow">for</span> (sa = win-&gt;<a class="code" href="../../dc/da4/structwmWindow.html#a5ec98a9e430fdc21a8d0f0b8dcc6ed05">screen</a>-&gt;<a class="code" href="../../de/de7/structbScreen.html#ae2f4a800c4c58fe953d91fe8136a0d0f">areabase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sa; sa = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a884b59339f5c0d55408f8727bfc799b7">next</a>) {
<a name="l02402"></a>02402                 <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l02403"></a>02403                     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02404"></a>02404                     <a class="code" href="../../df/da6/structBGpic.html">BGpic</a> *bgpic;
<a name="l02405"></a>02405                     <span class="keywordflow">for</span> (bgpic = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a3246c1cbdd50c393126180ae4446992e">bgpicbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bgpic; bgpic = bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a81c485660f1feac2cfa5c5813153c2f0">next</a>)
<a name="l02406"></a>02406                         <span class="keywordflow">if</span> (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a16f3925559495b9236d5e8160bc8f842">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l02407"></a>02407                             <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a16f3925559495b9236d5e8160bc8f842">iuser</a>, cfra, 0);
<a name="l02408"></a>02408                 }
<a name="l02409"></a>02409                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>) {
<a name="l02410"></a>02410                     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02411"></a>02411                     <span class="keywordflow">if</span> (sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l02412"></a>02412                         <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a>, cfra, 0);
<a name="l02413"></a>02413                 }
<a name="l02414"></a>02414                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca2ef41082c072d92dbf2d57e20442751d">SPACE_NODE</a>) {
<a name="l02415"></a>02415                     <a class="code" href="../../db/dc9/structSpaceNode.html">SpaceNode</a> *snode = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02416"></a>02416                     <span class="keywordflow">if</span> ((snode-&gt;<a class="code" href="../../db/dc9/structSpaceNode.html#acc2e52658693034e5b1f8ea667163749">treetype</a> == <a class="code" href="../../d3/d27/DNA__node__types_8h.html#a6613848c5cc3fa45f3f9a0a4a95bd6d0">NTREE_COMPOSIT</a>) &amp;&amp; (snode-&gt;<a class="code" href="../../db/dc9/structSpaceNode.html#ad1209aeb8590fee7f9eff379d5a375ef">nodetree</a>)) {
<a name="l02417"></a>02417                         <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node;
<a name="l02418"></a>02418                         <span class="keywordflow">for</span> (node = snode-&gt;<a class="code" href="../../db/dc9/structSpaceNode.html#ad1209aeb8590fee7f9eff379d5a375ef">nodetree</a>-&gt;<a class="code" href="../../d9/da9/structbNodeTree.html#ac928f4eb3314d2b9ce2d9c6a49c1f233">nodes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; node; node = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a978093ed3cb2529e1f932bc8c5081968">next</a>) {
<a name="l02419"></a>02419                             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a> &amp;&amp; node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a95416f774e5a5a27105522a1b74e5989">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a3b39f18a88ab67e0d7065d992f6ea1b0">CMP_NODE_IMAGE</a>) {
<a name="l02420"></a>02420                                 <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = (<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *)node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>;
<a name="l02421"></a>02421                                 <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l02422"></a>02422                                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>))
<a name="l02423"></a>02423                                     <span class="keywordflow">if</span> (iuser-&gt;flag &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l02424"></a>02424                                         <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(iuser, cfra, 0);
<a name="l02425"></a>02425                             }
<a name="l02426"></a>02426                         }
<a name="l02427"></a>02427                     }
<a name="l02428"></a>02428                 }
<a name="l02429"></a>02429             }
<a name="l02430"></a>02430         }
<a name="l02431"></a>02431     }
<a name="l02432"></a>02432 }
<a name="l02433"></a>02433 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:24 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
