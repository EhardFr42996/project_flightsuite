<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: softbody.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">softbody.c</div>  </div>
</div>
<div class="contents">
<a href="../../de/d32/softbody_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) Blender Foundation</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="comment">/*</span>
<a name="l00034"></a>00034 <span class="comment">******</span>
<a name="l00035"></a>00035 <span class="comment">variables on the UI for now</span>
<a name="l00036"></a>00036 <span class="comment"></span>
<a name="l00037"></a>00037 <span class="comment">    float mediafrict;  friction to env</span>
<a name="l00038"></a>00038 <span class="comment">    float nodemass;   softbody mass of *vertex*</span>
<a name="l00039"></a>00039 <span class="comment">    float grav;        softbody amount of gravitaion to apply</span>
<a name="l00040"></a>00040 <span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">    float goalspring;  softbody goal springs</span>
<a name="l00042"></a>00042 <span class="comment">    float goalfrict;   softbody goal springs friction</span>
<a name="l00043"></a>00043 <span class="comment">    float mingoal;     quick limits for goal</span>
<a name="l00044"></a>00044 <span class="comment">    float maxgoal;</span>
<a name="l00045"></a>00045 <span class="comment"></span>
<a name="l00046"></a>00046 <span class="comment">    float inspring;   softbody inner springs</span>
<a name="l00047"></a>00047 <span class="comment">    float infrict;     softbody inner springs friction</span>
<a name="l00048"></a>00048 <span class="comment"></span>
<a name="l00049"></a>00049 <span class="comment">*****</span>
<a name="l00050"></a>00050 <span class="comment">*/</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* types */</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d88/DNA__curve__types_8h.html">DNA_curve_types.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d3e/BLI__listbase_8h.html">BLI_listbase.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d65/BKE__effect_8h.html">BKE_effect.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df9/BKE__softbody_8h.html">BKE_softbody.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d45/BKE__pointcache_8h.html">BKE_pointcache.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="comment">//XXX #include  &quot;BIF_editdeform.h&quot;</span>
<a name="l00082"></a>00082 <span class="comment">//XXX #include  &quot;BIF_graphics.h&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include  &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="comment">// #include  &quot;ONL_opennl.h&quot; remove linking to ONL for now</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">/* callbacks for errors and interrupts and some goo */</span>
<a name="l00087"></a><a class="code" href="../../de/d32/softbody_8c.html#a1c4f502d7dcd9d7d80abdfb487c520e4">00087</a> <span class="keyword">static</span> int (*<a class="code" href="../../de/d32/softbody_8c.html#a1c4f502d7dcd9d7d80abdfb487c520e4">SB_localInterruptCallBack</a>)(void) = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">/* ********** soft body engine ******* */</span>
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898">00092</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>=1,<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>=2,<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a2bcf6736b19c6a32ea5f7426f75286f0">SB_STIFFQUAD</a>=3,<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a8c9816ecf0483be51e19f5c4d91fae89">SB_HANDLE</a>=4} <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898">type_spring</a>;
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="../../d0/d23/structBodySpring.html">00094</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> {
<a name="l00095"></a><a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">00095</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>, <a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l00096"></a><a class="code" href="../../d0/d23/structBodySpring.html#a4c8c1ad81ea5f879866355ea7c49e12d">00096</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>,<a class="code" href="../../d0/d23/structBodySpring.html#a6e00cc327e19fb753f11295d576c744f">cf</a>,<a class="code" href="../../d0/d23/structBodySpring.html#a4c8c1ad81ea5f879866355ea7c49e12d">load</a>;
<a name="l00097"></a><a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">00097</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>[3]; <span class="comment">/* edges colliding and sailing */</span>
<a name="l00098"></a><a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">00098</a>     <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898">type_spring</a> <a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>;
<a name="l00099"></a><a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">00099</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">flag</a>;
<a name="l00100"></a>00100 } <a class="code" href="../../de/d32/softbody_8c.html#ab9b2a3591ffb9e1d94e8d2fae978b7cd">BodySpring</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="../../dc/dc3/structBodyFace.html">00102</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/dc3/structBodyFace.html">BodyFace</a> {
<a name="l00103"></a><a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">00103</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>, <a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>, <a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a> ,<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>;
<a name="l00104"></a><a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">00104</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[3]; <span class="comment">/* faces colliding */</span>
<a name="l00105"></a><a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">00105</a>     <span class="keywordtype">short</span> <a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a>;
<a name="l00106"></a>00106 } <a class="code" href="../../de/d32/softbody_8c.html#ae67107b739814db75a7d94e067833c3e">BodyFace</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="../../dc/dce/structReferenceVert.html">00108</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/dce/structReferenceVert.html">ReferenceVert</a> {
<a name="l00109"></a><a class="code" href="../../dc/dce/structReferenceVert.html#aba0757fcab89a165f45ef6c4c247bf8e">00109</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/dce/structReferenceVert.html#aba0757fcab89a165f45ef6c4c247bf8e">pos</a>[3]; <span class="comment">/* position relative to com */</span>
<a name="l00110"></a><a class="code" href="../../dc/dce/structReferenceVert.html#af40b774fcc4f011ecdfb09874ab5a066">00110</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/dce/structReferenceVert.html#af40b774fcc4f011ecdfb09874ab5a066">mass</a>;   <span class="comment">/* node mass */</span>
<a name="l00111"></a>00111 } <a class="code" href="../../de/d32/softbody_8c.html#a5e52b77a2a4caa62499d3cfaa994e679">ReferenceVert</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d6/d8b/structReferenceState.html">00113</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d8b/structReferenceState.html">ReferenceState</a> {
<a name="l00114"></a><a class="code" href="../../d6/d8b/structReferenceState.html#a7407884b376a24e61e834483dc30963c">00114</a>     <span class="keywordtype">float</span> <a class="code" href="../../d6/d8b/structReferenceState.html#a7407884b376a24e61e834483dc30963c">com</a>[3]; <span class="comment">/* center of mass*/</span>
<a name="l00115"></a><a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">00115</a>     <a class="code" href="../../dc/dce/structReferenceVert.html">ReferenceVert</a> *<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a>; <span class="comment">/* list of intial values */</span>
<a name="l00116"></a>00116 } <a class="code" href="../../de/d32/softbody_8c.html#a5e763e6fce99ad672177eb3e806a4e2d">ReferenceState</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">/*private scratch pad for caching and other data only needed when alive*/</span>
<a name="l00120"></a><a class="code" href="../../de/dbb/structSBScratch.html">00120</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../de/dbb/structSBScratch.html">SBScratch</a> {
<a name="l00121"></a><a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">00121</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l00122"></a><a class="code" href="../../de/dbb/structSBScratch.html#a691ee971e5b36ebfcf65e099f59aef72">00122</a>     <span class="keywordtype">short</span> <a class="code" href="../../de/dbb/structSBScratch.html#a691ee971e5b36ebfcf65e099f59aef72">needstobuildcollider</a>;
<a name="l00123"></a><a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">00123</a>     <span class="keywordtype">short</span> <a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">flag</a>;
<a name="l00124"></a><a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">00124</a>     <a class="code" href="../../dc/dc3/structBodyFace.html">BodyFace</a> *<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a>;
<a name="l00125"></a><a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">00125</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a>;
<a name="l00126"></a><a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">00126</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>[3],<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>[3];
<a name="l00127"></a><a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">00127</a>     <a class="code" href="../../d6/d8b/structReferenceState.html">ReferenceState</a> <a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>;
<a name="l00128"></a>00128 } <a class="code" href="../../de/d32/softbody_8c.html#a2d661b2082b0007f2a3e8e489c605852">SBScratch</a>;
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="../../d2/d85/structSB__thread__context.html">00130</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span><a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a> {
<a name="l00131"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">00131</a>         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">scene</a>;
<a name="l00132"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">00132</a>         <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">ob</a>;
<a name="l00133"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a17a1d6b3ef4b50bb3174157a1933a3cd">00133</a>         <span class="keywordtype">float</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a17a1d6b3ef4b50bb3174157a1933a3cd">forcetime</a>;
<a name="l00134"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">00134</a>         <span class="keywordtype">float</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">timenow</a>;
<a name="l00135"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">00135</a>         <span class="keywordtype">int</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>;
<a name="l00136"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">00136</a>         <span class="keywordtype">int</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">ilast</a>;
<a name="l00137"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">00137</a>         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">do_effector</a>;
<a name="l00138"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a62cb58e1b1d56c21261e8fa27e7c9562">00138</a>         <span class="keywordtype">int</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a62cb58e1b1d56c21261e8fa27e7c9562">do_deflector</a>;
<a name="l00139"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a2d8cd1147a0f93844a3fc5593e13cbb2">00139</a>         <span class="keywordtype">float</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a2d8cd1147a0f93844a3fc5593e13cbb2">fieldfactor</a>;
<a name="l00140"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a905f534b5a15deaeff3ab60110d81de3">00140</a>         <span class="keywordtype">float</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a905f534b5a15deaeff3ab60110d81de3">windfactor</a>;
<a name="l00141"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a9a65848ac770a3f7c26abbb8291811a4">00141</a>         <span class="keywordtype">int</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a9a65848ac770a3f7c26abbb8291811a4">nr</a>;
<a name="l00142"></a><a class="code" href="../../d2/d85/structSB__thread__context.html#a269a397d04b7b6497fe5338dd14634b3">00142</a>         <span class="keywordtype">int</span> <a class="code" href="../../d2/d85/structSB__thread__context.html#a269a397d04b7b6497fe5338dd14634b3">tot</a>;
<a name="l00143"></a>00143 } <a class="code" href="../../de/d32/softbody_8c.html#ac4a69c888c48c0c3320f98bc901a55c3">SB_thread_context</a>;
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="../../de/d32/softbody_8c.html#ad4582ccf791498af49000ca8c0fd0a48">00145</a> <span class="preprocessor">#define NLF_BUILD  1</span>
<a name="l00146"></a><a class="code" href="../../de/d32/softbody_8c.html#a8e7ce91878042a7f8d8a295e87dbe3be">00146</a> <span class="preprocessor"></span><span class="preprocessor">#define NLF_SOLVE  2</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>
<a name="l00148"></a><a class="code" href="../../de/d32/softbody_8c.html#abe8a65968f3259f17cd3bd2b5be5dec5">00148</a> <span class="preprocessor">#define MID_PRESERVE 1</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>
<a name="l00150"></a><a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">00150</a> <span class="preprocessor">#define SOFTGOALSNAP  0.999f</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span><span class="comment">/* if bp-&gt; goal is above make it a *forced follow original* and skip all ODE stuff for this bp</span>
<a name="l00152"></a>00152 <span class="comment">   removes *unnecessary* stiffnes from ODE system</span>
<a name="l00153"></a>00153 <span class="comment">*/</span>
<a name="l00154"></a><a class="code" href="../../de/d32/softbody_8c.html#ab49ad7746b2cedbe49e514139fb19a12">00154</a> <span class="preprocessor">#define HEUNWARNLIMIT 1 </span><span class="comment">/* 500 would be fine i think for detecting severe *stiff* stuff */</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="../../de/d32/softbody_8c.html#ad2d659487f12252dbd9dae8a17f114b4">00157</a> <span class="preprocessor">#define BSF_INTERSECT   1 </span><span class="comment">/* edge intersects collider face */</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/* private definitions for bodypoint states */</span>
<a name="l00160"></a><a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">00160</a> <span class="preprocessor">#define SBF_DOFUZZY          1 </span><span class="comment">/* Bodypoint do fuzzy */</span>
<a name="l00161"></a><a class="code" href="../../de/d32/softbody_8c.html#a19a9fdce0834aa221dc2323dde0cdef2">00161</a> <span class="preprocessor">#define SBF_OUTOFCOLLISION   2 </span><span class="comment">/* Bodypoint does not collide  */</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">00164</a> <span class="preprocessor">#define BFF_INTERSECT   1 </span><span class="comment">/* collider edge   intrudes face */</span>
<a name="l00165"></a><a class="code" href="../../de/d32/softbody_8c.html#accd7e511114904f75bd623c7a239e70a">00165</a> <span class="preprocessor">#define BFF_CLOSEVERT   2 </span><span class="comment">/* collider vertex repulses face */</span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="../../de/d32/softbody_8c.html#adc5045929d97b109025e24819a3c329d">00168</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#adc5045929d97b109025e24819a3c329d">SoftHeunTol</a> = 1.0f; <span class="comment">/* humm .. this should be calculated from sb parameters and sizes */</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">/* local prototypes */</span>
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb);
<a name="l00172"></a>00172 <span class="comment">/* aye this belongs to arith.c */</span>
<a name="l00173"></a>00173 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(<span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> s, <span class="keywordtype">float</span> *v1);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/*+++ frame based timing +++*/</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">/*physical unit of force is [kg * m / sec^2]*/</span>
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="../../de/d32/softbody_8c.html#a5b7790b417ca324d8a35b24ebcb5dcd2">00179</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#a5b7790b417ca324d8a35b24ebcb5dcd2">sb_grav_force_scale</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob))
<a name="l00180"></a>00180 <span class="comment">/* since unit of g is [m/sec^2] and F = mass * g we rescale unit mass of node to 1 gramm</span>
<a name="l00181"></a>00181 <span class="comment">  put it to a function here, so we can add user options later without touching simulation code</span>
<a name="l00182"></a>00182 <span class="comment">*/</span>
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <span class="keywordflow">return</span> (0.001f);
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">00187</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob))
<a name="l00188"></a>00188 <span class="comment">/* rescaling unit of drag [1 / sec] to somehow reasonable</span>
<a name="l00189"></a>00189 <span class="comment">  put it to a function here, so we can add user options later without touching simulation code</span>
<a name="l00190"></a>00190 <span class="comment">*/</span>
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192     <span class="keywordflow">return</span> (0.01f);
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a><a class="code" href="../../de/d32/softbody_8c.html#aca1b4f32ecb028305ce6885532a5411a">00195</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#aca1b4f32ecb028305ce6885532a5411a">sb_time_scale</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00196"></a>00196 <span class="comment">/* defining the frames to *real* time relation */</span>
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (sb) {
<a name="l00200"></a>00200         <span class="keywordflow">return</span>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a51a881ede8746efc91ae434a7cab9343">physics_speed</a>);
<a name="l00201"></a>00201         <span class="comment">/*hrms .. this could be IPO as well :)</span>
<a name="l00202"></a>00202 <span class="comment">         estimated range [0.001 sluggish slug - 100.0 very fast (i hope ODE solver can handle that)]</span>
<a name="l00203"></a>00203 <span class="comment">         1 approx = a unit 1 pendulum at g = 9.8 [earth conditions]  has period 65 frames</span>
<a name="l00204"></a>00204 <span class="comment">         theory would give a 50 frames period .. so there must be something inaccurate .. looking for that (BM)</span>
<a name="l00205"></a>00205 <span class="comment">         */</span>
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207     <span class="keywordflow">return</span> (1.0f);
<a name="l00208"></a>00208     <span class="comment">/*</span>
<a name="l00209"></a>00209 <span class="comment">    this would be frames/sec independent timing assuming 25 fps is default</span>
<a name="l00210"></a>00210 <span class="comment">    but does not work very well with NLA</span>
<a name="l00211"></a>00211 <span class="comment">        return (25.0f/scene-&gt;r.frs_sec)</span>
<a name="l00212"></a>00212 <span class="comment">    */</span>
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 <span class="comment">/*--- frame based timing ---*/</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="comment">/* helper functions for everything is animatable jow_go_for2_5 +++++++*/</span>
<a name="l00217"></a>00217 <span class="comment">/* introducing them here, because i know: steps in properties  ( at frame timing )</span>
<a name="l00218"></a>00218 <span class="comment">   will cause unwanted responses of the softbody system (which does inter frame calculations )</span>
<a name="l00219"></a>00219 <span class="comment">   so first &#39;cure&#39; would be: interpolate linear in time ..</span>
<a name="l00220"></a>00220 <span class="comment">   Q: why do i write this?</span>
<a name="l00221"></a>00221 <span class="comment">   A: because it happend once, that some eger coder &#39;streamlined&#39; code to fail.</span>
<a name="l00222"></a>00222 <span class="comment">   We DO linear interpolation for goals .. and i think we should do on animated properties as well</span>
<a name="l00223"></a>00223 <span class="comment">*/</span>
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">/* animate sb-&gt;maxgoal,sb-&gt;mingoal */</span>
<a name="l00226"></a><a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">00226</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp)<span class="comment">/*jow_go_for2_5 */</span>
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228     <span class="keywordtype">float</span> f = -1999.99f;
<a name="l00229"></a>00229     <span class="keywordflow">if</span> (ob) {
<a name="l00230"></a>00230         <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>)) <span class="keywordflow">return</span> (0.0f);
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (sb&amp;&amp;bp) {
<a name="l00233"></a>00233             <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a> &lt; 0.0f) <span class="keywordflow">return</span> (0.0f);
<a name="l00234"></a>00234             f = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a18b016b42ae8a7671f3fbfe29c22be62">mingoal</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>*<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac0f3579baac5264494f71fb725540433">maxgoal</a> - sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a18b016b42ae8a7671f3fbfe29c22be62">mingoal</a>);
<a name="l00235"></a>00235             f = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(f, 4.0f);
<a name="l00236"></a>00236             <span class="keywordflow">return</span> (f);
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     printf(<span class="stringliteral">&quot;_final_goal failed! sb or bp ==NULL\n&quot;</span> );
<a name="l00240"></a>00240     <span class="keywordflow">return</span> f; <span class="comment">/*using crude but spot able values some times helps debuggin */</span>
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">00243</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (ob) {
<a name="l00246"></a>00246         <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (sb&amp;&amp;bp) {
<a name="l00248"></a>00248             <span class="keywordflow">return</span>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a644f745a1260624d90b4ae4c0f6eb0f7">mass</a>*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac71d20275479b402b8fe5e65a372a693">nodemass</a>);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     printf(<span class="stringliteral">&quot;_final_mass failed! sb or bp ==NULL\n&quot;</span> );
<a name="l00252"></a>00252     <span class="keywordflow">return</span> 1.0f;
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 <span class="comment">/* helper functions for everything is animateble jow_go_for2_5 ------*/</span>
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">/*+++ collider caching and dicing +++*/</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="comment">/********************</span>
<a name="l00259"></a>00259 <span class="comment">for each target object/face the axis aligned bounding box (AABB) is stored</span>
<a name="l00260"></a>00260 <span class="comment">faces parallel to global axes</span>
<a name="l00261"></a>00261 <span class="comment">so only simple &quot;value&quot; in [min,max] ckecks are used</span>
<a name="l00262"></a>00262 <span class="comment">float operations still</span>
<a name="l00263"></a>00263 <span class="comment">*/</span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="comment">/* just an ID here to reduce the prob for killing objects</span>
<a name="l00266"></a>00266 <span class="comment">** ob-&gt;sumohandle points to we should not kill :)</span>
<a name="l00267"></a>00267 <span class="comment">*/</span>
<a name="l00268"></a><a class="code" href="../../de/d32/softbody_8c.html#ad5e671c6b1049744cd4f595f3ad6f985">00268</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#ad5e671c6b1049744cd4f595f3ad6f985">CCD_SAVETY</a> = 190561;
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="../../d2/dc3/structccdf__minmax.html">00270</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> {
<a name="l00271"></a><a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">00271</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>, <a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>, <a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>, <a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>, <a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>, <a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>;
<a name="l00272"></a>00272 } <a class="code" href="../../de/d32/softbody_8c.html#a89cd0815cfc194a057fba141b3601164">ccdf_minmax</a>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html">00276</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> {
<a name="l00277"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">00277</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a>, <a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>;
<a name="l00278"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">00278</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l00279"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">00279</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l00280"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">00280</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l00281"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a73999411f287ebc6047360e30ae1d0bf">00281</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dc9/structccd__Mesh.html#a73999411f287ebc6047360e30ae1d0bf">savety</a>;
<a name="l00282"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">00282</a>     <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l00283"></a>00283     <span class="comment">/* Axis Aligned Bounding Box AABB */</span>
<a name="l00284"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">00284</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[3];
<a name="l00285"></a><a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">00285</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[3];
<a name="l00286"></a>00286 } <a class="code" href="../../de/d32/softbody_8c.html#a105f9d4f0783d8e0247f85987b0de47c">ccd_Mesh</a>;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="../../de/d32/softbody_8c.html#a1d7923dcb078a6c27c27dbca47e43e6a">00291</a> <span class="keyword">static</span> <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *<a class="code" href="../../de/d32/softbody_8c.html#a1d7923dcb078a6c27c27dbca47e43e6a">ccd_mesh_make</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293     <a class="code" href="../../d7/d2f/structCollisionModifierData.html">CollisionModifierData</a> *cmd;
<a name="l00294"></a>00294     <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *pccd_M = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00295"></a>00295     <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00296"></a>00296     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00297"></a>00297     <span class="keywordtype">float</span> v[3],hull;
<a name="l00298"></a>00298     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     cmd =(<a class="code" href="../../d7/d2f/structCollisionModifierData.html">CollisionModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435abc95e623f4353951954effc91fe021e2">eModifierType_Collision</a>);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">/* first some paranoia checks */</span>
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (!cmd) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00304"></a>00304     <span class="keywordflow">if</span> (!cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#ac817a899607599b212178bcd8beeaa5e">numverts</a> || !cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a1bdc238e275942538d88c3927a751d6a">numfaces</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     pccd_M = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a>),<span class="stringliteral">&quot;ccd_Mesh&quot;</span>);
<a name="l00307"></a>00307     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a> = cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#ac817a899607599b212178bcd8beeaa5e">numverts</a>;
<a name="l00308"></a>00308     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a> = cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a1bdc238e275942538d88c3927a751d6a">numfaces</a>;
<a name="l00309"></a>00309     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a73999411f287ebc6047360e30ae1d0bf">savety</a>  = <a class="code" href="../../de/d32/softbody_8c.html#ad5e671c6b1049744cd4f595f3ad6f985">CCD_SAVETY</a>;
<a name="l00310"></a>00310     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]=1e30f;
<a name="l00311"></a>00311     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]=-1e30f;
<a name="l00312"></a>00312     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">/* blow it up with forcefield ranges */</span>
<a name="l00316"></a>00316     hull = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a92a4c8053ace57341092d9bba00f9f2e">pdef_sbift</a>,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a0ba43582aa767541372924054d9a000e">pdef_sboft</a>);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="comment">/* alloc and copy verts*/</span>
<a name="l00319"></a>00319     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#aadacf061d6f364d64f7546a7aaf1bba6">xnew</a>);
<a name="l00320"></a>00320     <span class="comment">/* note that xnew coords are already in global space, */</span>
<a name="l00321"></a>00321     <span class="comment">/* determine the ortho BB */</span>
<a name="l00322"></a>00322     <span class="keywordflow">for</span> (i=0; i &lt; pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a>; i++) {
<a name="l00323"></a>00323         <span class="comment">/* evaluate limits */</span>
<a name="l00324"></a>00324         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00325"></a>00325         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0],v[0]-hull);
<a name="l00326"></a>00326         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1],v[1]-hull);
<a name="l00327"></a>00327         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2],v[2]-hull);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0],v[0]+hull);
<a name="l00330"></a>00330         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1],v[1]+hull);
<a name="l00331"></a>00331         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2],v[2]+hull);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334     <span class="comment">/* alloc and copy faces*/</span>
<a name="l00335"></a>00335     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#aa4d0e546bf8ad244b27c5336856a12fa">mfaces</a>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">/* OBBs for idea1 */</span>
<a name="l00338"></a>00338     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a>)*pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>,<span class="stringliteral">&quot;ccd_Mesh_Faces_mima&quot;</span>);
<a name="l00339"></a>00339     mima  = pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l00340"></a>00340     mface = pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="comment">/* anyhoo we need to walk the list of faces and find OBB they live in */</span>
<a name="l00344"></a>00344     <span class="keywordflow">for</span> (i=0; i &lt; pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>; i++) {
<a name="l00345"></a>00345         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>=1e30f;
<a name="l00346"></a>00346         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>=-1e30f;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00349"></a>00349         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00350"></a>00350         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00351"></a>00351         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00352"></a>00352         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00353"></a>00353         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00354"></a>00354         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00357"></a>00357         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00358"></a>00358         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00359"></a>00359         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00360"></a>00360         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00361"></a>00361         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00362"></a>00362         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00365"></a>00365         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00366"></a>00366         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00367"></a>00367         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00368"></a>00368         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00369"></a>00369         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00370"></a>00370         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00373"></a>00373             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00374"></a>00374         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00375"></a>00375         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00376"></a>00376         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00377"></a>00377         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00378"></a>00378         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00379"></a>00379         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     mima++;
<a name="l00384"></a>00384     mface++;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">return</span> pccd_M;
<a name="l00388"></a>00388 }
<a name="l00389"></a><a class="code" href="../../de/d32/softbody_8c.html#afb3a0e4e18d7929d5619fc01550a7cc3">00389</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#afb3a0e4e18d7929d5619fc01550a7cc3">ccd_mesh_update</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *pccd_M)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     <a class="code" href="../../d7/d2f/structCollisionModifierData.html">CollisionModifierData</a> *cmd;
<a name="l00392"></a>00392     <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00393"></a>00393     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00394"></a>00394     <span class="keywordtype">float</span> v[3],hull;
<a name="l00395"></a>00395     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     cmd =(<a class="code" href="../../d7/d2f/structCollisionModifierData.html">CollisionModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435abc95e623f4353951954effc91fe021e2">eModifierType_Collision</a>);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">/* first some paranoia checks */</span>
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (!cmd) <span class="keywordflow">return</span>;
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (!cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#ac817a899607599b212178bcd8beeaa5e">numverts</a> || !cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a1bdc238e275942538d88c3927a751d6a">numfaces</a>) <span class="keywordflow">return</span>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="keywordflow">if</span> ((pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a> != cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#ac817a899607599b212178bcd8beeaa5e">numverts</a>) ||
<a name="l00404"></a>00404         (pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a> != cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a1bdc238e275942538d88c3927a751d6a">numfaces</a>)) <span class="keywordflow">return</span>;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]=1e30f;
<a name="l00407"></a>00407     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]=pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]=-1e30f;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="comment">/* blow it up with forcefield ranges */</span>
<a name="l00411"></a>00411     hull = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a92a4c8053ace57341092d9bba00f9f2e">pdef_sbift</a>,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a0ba43582aa767541372924054d9a000e">pdef_sboft</a>);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="comment">/* rotate current to previous */</span>
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>);
<a name="l00415"></a>00415     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a> = pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l00416"></a>00416     <span class="comment">/* alloc and copy verts*/</span>
<a name="l00417"></a>00417     pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(cmd-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#aadacf061d6f364d64f7546a7aaf1bba6">xnew</a>);
<a name="l00418"></a>00418     <span class="comment">/* note that xnew coords are already in global space, */</span>
<a name="l00419"></a>00419     <span class="comment">/* determine the ortho BB */</span>
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (i=0; i &lt; pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a>; i++) {
<a name="l00421"></a>00421         <span class="comment">/* evaluate limits */</span>
<a name="l00422"></a>00422         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00423"></a>00423         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0],v[0]-hull);
<a name="l00424"></a>00424         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1],v[1]-hull);
<a name="l00425"></a>00425         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2],v[2]-hull);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0],v[0]+hull);
<a name="l00428"></a>00428         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1],v[1]+hull);
<a name="l00429"></a>00429         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2],v[2]+hull);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <span class="comment">/* evaluate limits */</span>
<a name="l00432"></a>00432         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00433"></a>00433         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0],v[0]-hull);
<a name="l00434"></a>00434         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1],v[1]-hull);
<a name="l00435"></a>00435         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2],v[2]-hull);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0],v[0]+hull);
<a name="l00438"></a>00438         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1],v[1]+hull);
<a name="l00439"></a>00439         pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2],v[2]+hull);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     mima  = pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l00444"></a>00444     mface = pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="comment">/* anyhoo we need to walk the list of faces and find OBB they live in */</span>
<a name="l00448"></a>00448     <span class="keywordflow">for</span> (i=0; i &lt; pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>; i++) {
<a name="l00449"></a>00449         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>=1e30f;
<a name="l00450"></a>00450         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>=mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>=-1e30f;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00453"></a>00453         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00454"></a>00454         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00455"></a>00455         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00456"></a>00456         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00457"></a>00457         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00458"></a>00458         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00461"></a>00461         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00462"></a>00462         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00463"></a>00463         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00464"></a>00464         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00465"></a>00465         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00466"></a>00466         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00469"></a>00469         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00470"></a>00470         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00471"></a>00471         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00472"></a>00472         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00473"></a>00473         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00474"></a>00474         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00477"></a>00477             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00478"></a>00478         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00479"></a>00479         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00480"></a>00480         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00481"></a>00481         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00482"></a>00482         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00483"></a>00483         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00488"></a>00488         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00489"></a>00489         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00490"></a>00490         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00491"></a>00491         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00492"></a>00492         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00493"></a>00493         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00496"></a>00496         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00497"></a>00497         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00498"></a>00498         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00499"></a>00499         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00500"></a>00500         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00501"></a>00501         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00504"></a>00504         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00505"></a>00505         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00506"></a>00506         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00507"></a>00507         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00508"></a>00508         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00509"></a>00509         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00512"></a>00512             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v,pccd_M-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00513"></a>00513         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>,v[0]-hull);
<a name="l00514"></a>00514         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>,v[1]-hull);
<a name="l00515"></a>00515         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>,v[2]-hull);
<a name="l00516"></a>00516         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>,v[0]+hull);
<a name="l00517"></a>00517         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>,v[1]+hull);
<a name="l00518"></a>00518         mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>,v[2]+hull);
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     mima++;
<a name="l00523"></a>00523     mface++;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">return</span>;
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="../../de/d32/softbody_8c.html#a30290bae87eb29edccff6bc14bdbca7e">00529</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a30290bae87eb29edccff6bc14bdbca7e">ccd_mesh_free</a>(<a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     <span class="keywordflow">if</span> (ccdm &amp;&amp; (ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a73999411f287ebc6047360e30ae1d0bf">savety</a> == CCD_SAVETY )) { <span class="comment">/*make sure we&#39;re not nuking objects we don&#39;t know*/</span>
<a name="l00532"></a>00532         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>);
<a name="l00533"></a>00533         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>);
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>);
<a name="l00535"></a>00535         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>);
<a name="l00536"></a>00536         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ccdm);
<a name="l00537"></a>00537         ccdm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a><a class="code" href="../../de/d32/softbody_8c.html#ad385759d494e53894626ab553727931c">00541</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ad385759d494e53894626ab553727931c">ccd_build_deflector_hash</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner, <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>)
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00544"></a>00544     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (!hash) <span class="keywordflow">return</span>;
<a name="l00547"></a>00547     <span class="keywordflow">while</span> (base) {
<a name="l00548"></a>00548         <span class="comment">/*Only proceed for mesh object in same layer */</span>
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a> &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>)) {
<a name="l00550"></a>00550             ob= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l00551"></a>00551             <span class="keywordflow">if</span> ((vertexowner) &amp;&amp; (ob == vertexowner)) {
<a name="l00552"></a>00552                 <span class="comment">/* if vertexowner is given  we don&#39;t want to check collision with owner object */</span>
<a name="l00553"></a>00553                 base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>;
<a name="l00554"></a>00554                 <span class="keywordflow">continue</span>;
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557             <span class="comment">/*+++ only with deflecting set */</span>
<a name="l00558"></a>00558             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a> &amp;&amp; <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(hash, ob) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00559"></a>00559                 <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdmesh = <a class="code" href="../../de/d32/softbody_8c.html#a1d7923dcb078a6c27c27dbca47e43e6a">ccd_mesh_make</a>(ob);
<a name="l00560"></a>00560                 <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(hash, ob, ccdmesh);
<a name="l00561"></a>00561             }<span class="comment">/*--- only with deflecting set */</span>
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         }<span class="comment">/* mesh &amp;&amp; layer*/</span>
<a name="l00564"></a>00564         base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>;
<a name="l00565"></a>00565     } <span class="comment">/* while (base) */</span>
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="../../de/d32/softbody_8c.html#ac58014d00bf604edfa56bc5f04a64cab">00568</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ac58014d00bf604edfa56bc5f04a64cab">ccd_update_deflector_hash</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner, <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>)
<a name="l00569"></a>00569 {
<a name="l00570"></a>00570     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00571"></a>00571     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="keywordflow">if</span> ((!hash) || (!vertexowner)) <span class="keywordflow">return</span>;
<a name="l00574"></a>00574     <span class="keywordflow">while</span> (base) {
<a name="l00575"></a>00575         <span class="comment">/*Only proceed for mesh object in same layer */</span>
<a name="l00576"></a>00576         <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a> &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>)) {
<a name="l00577"></a>00577             ob= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l00578"></a>00578             <span class="keywordflow">if</span> (ob == vertexowner) {
<a name="l00579"></a>00579                 <span class="comment">/* if vertexowner is given  we don&#39;t want to check collision with owner object */</span>
<a name="l00580"></a>00580                 base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>;
<a name="l00581"></a>00581                 <span class="keywordflow">continue</span>;
<a name="l00582"></a>00582             }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584             <span class="comment">/*+++ only with deflecting set */</span>
<a name="l00585"></a>00585             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l00586"></a>00586                 <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdmesh = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(hash,ob);
<a name="l00587"></a>00587                 <span class="keywordflow">if</span> (ccdmesh)
<a name="l00588"></a>00588                     <a class="code" href="../../de/d32/softbody_8c.html#afb3a0e4e18d7929d5619fc01550a7cc3">ccd_mesh_update</a>(ob,ccdmesh);
<a name="l00589"></a>00589             }<span class="comment">/*--- only with deflecting set */</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         }<span class="comment">/* mesh &amp;&amp; layer*/</span>
<a name="l00592"></a>00592         base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>;
<a name="l00593"></a>00593     } <span class="comment">/* while (base) */</span>
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="comment">/*--- collider caching and dicing ---*/</span>
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 
<a name="l00602"></a><a class="code" href="../../de/d32/softbody_8c.html#a0c6433607b236f6268898c53cd0d4dc4">00602</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a0c6433607b236f6268898c53cd0d4dc4">count_mesh_quads</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     <span class="keywordtype">int</span> a,result = 0;
<a name="l00605"></a>00605     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">if</span> (mface) {
<a name="l00608"></a>00608         <span class="keywordflow">for</span> (a=me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a&gt;0; a--, mface++) {
<a name="l00609"></a>00609             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) result++;
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612     <span class="keywordflow">return</span> result;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a><a class="code" href="../../de/d32/softbody_8c.html#a097fab750007df02f8f315c7daa6ebac">00615</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a097fab750007df02f8f315c7daa6ebac">add_mesh_quad_diag_springs</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00616"></a>00616 {
<a name="l00617"></a>00617     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00618"></a>00618     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l00619"></a>00619     <span class="comment">/*BodyPoint *bp;*/</span> <span class="comment">/*UNUSED*/</span>
<a name="l00620"></a>00620     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs, *bs_new;
<a name="l00621"></a>00621     <span class="keywordtype">int</span> a;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>) {
<a name="l00624"></a>00624         <span class="keywordtype">int</span> nofquads;
<a name="l00625"></a>00625         <span class="comment">//float s_shear = ob-&gt;soft-&gt;shearstiff*ob-&gt;soft-&gt;shearstiff;</span>
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         nofquads = <a class="code" href="../../de/d32/softbody_8c.html#a0c6433607b236f6268898c53cd0d4dc4">count_mesh_quads</a>(me);
<a name="l00628"></a>00628         <span class="keywordflow">if</span> (nofquads) {
<a name="l00629"></a>00629             <span class="comment">/* resize spring-array to hold additional quad springs */</span>
<a name="l00630"></a>00630             bs_new= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> + nofquads *2 )*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a>), <span class="stringliteral">&quot;bodyspring&quot;</span>);
<a name="l00631"></a>00631             memcpy(bs_new,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>,(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> )*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a>));
<a name="l00632"></a>00632 
<a name="l00633"></a>00633             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>)
<a name="l00634"></a>00634                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>); <span class="comment">/* do this before reassigning the pointer  or have a 1st class memory leak */</span>
<a name="l00635"></a>00635             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> = bs_new;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637             <span class="comment">/* fill the tail */</span>
<a name="l00638"></a>00638             a = 0;
<a name="l00639"></a>00639             bs = bs_new+ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>;
<a name="l00640"></a>00640             <span class="comment">/*bp= ob-&gt;soft-&gt;bpoint; */</span> <span class="comment">/*UNUSED*/</span>
<a name="l00641"></a>00641             <span class="keywordflow">if</span> (mface ) {
<a name="l00642"></a>00642                 <span class="keywordflow">for</span> (a=me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a&gt;0; a--, mface++) {
<a name="l00643"></a>00643                     <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00644"></a>00644                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l00645"></a>00645                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l00646"></a>00646                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>   = <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a2bcf6736b19c6a32ea5f7426f75286f0">SB_STIFFQUAD</a>;
<a name="l00647"></a>00647                         bs++;
<a name="l00648"></a>00648                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l00649"></a>00649                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l00650"></a>00650                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>   = <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a2bcf6736b19c6a32ea5f7426f75286f0">SB_STIFFQUAD</a>;
<a name="l00651"></a>00651                         bs++;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                     }
<a name="l00654"></a>00654                 }
<a name="l00655"></a>00655             }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657             <span class="comment">/* now we can announce new springs */</span>
<a name="l00658"></a>00658             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> += nofquads *2;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 
<a name="l00663"></a><a class="code" href="../../de/d32/softbody_8c.html#a61ab8265f6cb3e0106bdbcb37670926f">00663</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a61ab8265f6cb3e0106bdbcb37670926f">add_2nd_order_roller</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(stiffness), <span class="keywordtype">int</span> *counter, <span class="keywordtype">int</span> addsprings)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665     <span class="comment">/*assume we have a softbody*/</span>
<a name="l00666"></a>00666     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00667"></a>00667     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp,*bpo;
<a name="l00668"></a>00668     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs,*bs2,*bs3= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00669"></a>00669     <span class="keywordtype">int</span> a,b,c,notthis= 0,v0;
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (!sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>) {<span class="keywordflow">return</span>;} <span class="comment">/* we are 2nd order here so 1rst should have been build :) */</span>
<a name="l00671"></a>00671     <span class="comment">/* first run counting  second run adding */</span>
<a name="l00672"></a>00672     *counter = 0;
<a name="l00673"></a>00673     <span class="keywordflow">if</span> (addsprings) bs3 = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>+ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>;
<a name="l00674"></a>00674     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l00675"></a>00675         <span class="comment">/*scan for neighborhood*/</span>
<a name="l00676"></a>00676         bpo = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00677"></a>00677         v0  = (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a);
<a name="l00678"></a>00678         <span class="keywordflow">for</span> (b=bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l00679"></a>00679             bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l00680"></a>00680             <span class="comment">/*nasty thing here that springs have two ends</span>
<a name="l00681"></a>00681 <span class="comment">            so here we have to make sure we examine the other */</span>
<a name="l00682"></a>00682             <span class="keywordflow">if</span> (v0 == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>) {
<a name="l00683"></a>00683                 bpo = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>+bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l00684"></a>00684                 notthis = bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l00685"></a>00685             }
<a name="l00686"></a>00686             <span class="keywordflow">else</span> {
<a name="l00687"></a>00687             <span class="keywordflow">if</span> (v0 == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>) {
<a name="l00688"></a>00688                 bpo = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>+bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>;
<a name="l00689"></a>00689                 notthis = bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>;
<a name="l00690"></a>00690             }
<a name="l00691"></a>00691             <span class="keywordflow">else</span> {printf(<span class="stringliteral">&quot;oops we should not get here -  add_2nd_order_springs&quot;</span>);}
<a name="l00692"></a>00692             }
<a name="l00693"></a>00693             <span class="keywordflow">if</span> (bpo) {<span class="comment">/* so now we have a 2nd order humpdidump */</span>
<a name="l00694"></a>00694                 <span class="keywordflow">for</span> (c=bpo-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;c&gt;0;c--) {
<a name="l00695"></a>00695                     bs2 = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + bpo-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[c-1];
<a name="l00696"></a>00696                     <span class="keywordflow">if</span> ((bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> != notthis)  &amp;&amp; (bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> &gt; v0)) {
<a name="l00697"></a>00697                         (*counter)++;<span class="comment">/*hit */</span>
<a name="l00698"></a>00698                         <span class="keywordflow">if</span> (addsprings) {
<a name="l00699"></a>00699                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= v0;
<a name="l00700"></a>00700                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>;
<a name="l00701"></a>00701                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>   = <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l00702"></a>00702                             bs3++;
<a name="l00703"></a>00703                         }
<a name="l00704"></a>00704                     }
<a name="l00705"></a>00705                     <span class="keywordflow">if</span> ((bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> !=notthis)&amp;&amp;(bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> &gt; v0)) {
<a name="l00706"></a>00706                     (*counter)++;<span class="comment">/*hit */</span>
<a name="l00707"></a>00707                         <span class="keywordflow">if</span> (addsprings) {
<a name="l00708"></a>00708                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= v0;
<a name="l00709"></a>00709                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= bs2-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l00710"></a>00710                             bs3-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>   = <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l00711"></a>00711                             bs3++;
<a name="l00712"></a>00712                         }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714                     }
<a name="l00715"></a>00715                 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717             }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720         <span class="comment">/*scan for neighborhood done*/</span>
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724 
<a name="l00725"></a><a class="code" href="../../de/d32/softbody_8c.html#aa1a669a9a2993da0f566e9beff3d85d1">00725</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#aa1a669a9a2993da0f566e9beff3d85d1">add_2nd_order_springs</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> stiffness)
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727     <span class="keywordtype">int</span> counter = 0;
<a name="l00728"></a>00728     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs_new;
<a name="l00729"></a>00729     stiffness *=stiffness;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <a class="code" href="../../de/d32/softbody_8c.html#a61ab8265f6cb3e0106bdbcb37670926f">add_2nd_order_roller</a>(ob,stiffness,&amp;counter,0); <span class="comment">/* counting */</span>
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (counter) {
<a name="l00733"></a>00733         <span class="comment">/* resize spring-array to hold additional springs */</span>
<a name="l00734"></a>00734         bs_new= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> + counter )*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a>), <span class="stringliteral">&quot;bodyspring&quot;</span>);
<a name="l00735"></a>00735         memcpy(bs_new,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>,(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> )*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a>));
<a name="l00736"></a>00736 
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>)
<a name="l00738"></a>00738             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>);
<a name="l00739"></a>00739         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> = bs_new;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <a class="code" href="../../de/d32/softbody_8c.html#a61ab8265f6cb3e0106bdbcb37670926f">add_2nd_order_roller</a>(ob,stiffness,&amp;counter,1); <span class="comment">/* adding */</span>
<a name="l00742"></a>00742         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> += counter;
<a name="l00743"></a>00743     }
<a name="l00744"></a>00744 }
<a name="l00745"></a>00745 
<a name="l00746"></a><a class="code" href="../../de/d32/softbody_8c.html#a85222355c940d287234ded98e3c24f00">00746</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a85222355c940d287234ded98e3c24f00">add_bp_springlist</a>(<a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp,<span class="keywordtype">int</span> springID)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748     <span class="keywordtype">int</span> *newlist;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00751"></a>00751         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;bpsprings&quot;</span>);
<a name="l00752"></a>00752         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[0] = springID;
<a name="l00753"></a>00753         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a> = 1;
<a name="l00754"></a>00754     }
<a name="l00755"></a>00755     <span class="keywordflow">else</span> {
<a name="l00756"></a>00756         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>++;
<a name="l00757"></a>00757         newlist = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;bpsprings&quot;</span>);
<a name="l00758"></a>00758         memcpy(newlist,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>,(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>-1)* <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00759"></a>00759         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>);
<a name="l00760"></a>00760         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a> = newlist;
<a name="l00761"></a>00761         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>-1] = springID;
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 <span class="comment">/* do this once when sb is build</span>
<a name="l00766"></a>00766 <span class="comment">it is O(N^2) so scanning for springs every iteration is too expensive</span>
<a name="l00767"></a>00767 <span class="comment">*/</span>
<a name="l00768"></a><a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">00768</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">build_bps_springlist</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00771"></a>00771     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l00772"></a>00772     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l00773"></a>00773     <span class="keywordtype">int</span> a,b;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="keywordflow">if</span> (sb==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>; <span class="comment">/* paranoya check */</span>
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l00778"></a>00778         <span class="comment">/* throw away old list */</span>
<a name="l00779"></a>00779         <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>) {
<a name="l00780"></a>00780             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>);
<a name="l00781"></a>00781             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00782"></a>00782         }
<a name="l00783"></a>00783         <span class="comment">/* scan for attached inner springs */</span>
<a name="l00784"></a>00784         <span class="keywordflow">for</span> (b=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>, bs= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>; b&gt;0; b--, bs++) {
<a name="l00785"></a>00785             <span class="keywordflow">if</span> (( (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a) == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>) ) {
<a name="l00786"></a>00786                 <a class="code" href="../../de/d32/softbody_8c.html#a85222355c940d287234ded98e3c24f00">add_bp_springlist</a>(bp,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> -b);
<a name="l00787"></a>00787             }
<a name="l00788"></a>00788             <span class="keywordflow">if</span> (( (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a) == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>) ) {
<a name="l00789"></a>00789                 <a class="code" href="../../de/d32/softbody_8c.html#a85222355c940d287234ded98e3c24f00">add_bp_springlist</a>(bp,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a> -b);
<a name="l00790"></a>00790             }
<a name="l00791"></a>00791         }<span class="comment">/*for springs*/</span>
<a name="l00792"></a>00792     }<span class="comment">/*for bp*/</span>
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a><a class="code" href="../../de/d32/softbody_8c.html#a84abf9f72632506982228b9544e0aa00">00795</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a84abf9f72632506982228b9544e0aa00">calculate_collision_balls</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l00798"></a>00798     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l00799"></a>00799     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l00800"></a>00800     <span class="keywordtype">int</span> a,b,akku_count;
<a name="l00801"></a>00801     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>,<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>,akku;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <span class="keywordflow">if</span> (sb==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>; <span class="comment">/* paranoya check */</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l00806"></a>00806         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>=0;
<a name="l00807"></a>00807         akku =0.0f;
<a name="l00808"></a>00808         akku_count=0;
<a name="l00809"></a>00809         min = 1e22f;
<a name="l00810"></a>00810         max = -1e22f;
<a name="l00811"></a>00811         <span class="comment">/* first estimation based on attached */</span>
<a name="l00812"></a>00812         <span class="keywordflow">for</span> (b=bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l00813"></a>00813             bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l00814"></a>00814             <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a> == <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>) {
<a name="l00815"></a>00815             akku += bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>;
<a name="l00816"></a>00816             akku_count++,
<a name="l00817"></a>00817             min = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>,min);
<a name="l00818"></a>00818             max = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>,max);
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822         <span class="keywordflow">if</span> (akku_count &gt; 0) {
<a name="l00823"></a>00823             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> == <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a21eae0068d252b3db83bc193b81bf20b">SBC_MODE_MANUAL</a>) {
<a name="l00824"></a>00824                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>;
<a name="l00825"></a>00825             }
<a name="l00826"></a>00826             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> == <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4ac2b13bf734be7f0e81bcb35a8b60c2">SBC_MODE_AVG</a>) {
<a name="l00827"></a>00827                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a> = akku/(float)akku_count*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>;
<a name="l00828"></a>00828             }
<a name="l00829"></a>00829             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> == <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a13c6d135824736ae96456d9da2cc1670">SBC_MODE_MIN</a>) {
<a name="l00830"></a>00830                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>=min*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>;
<a name="l00831"></a>00831             }
<a name="l00832"></a>00832             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> == <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a81e6736da25f74fe1516ba3f7c872a94">SBC_MODE_MAX</a>) {
<a name="l00833"></a>00833                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>=max*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>;
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> == <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a7af1003c9367587b47bfdb3f94a86565">SBC_MODE_AVGMINMAX</a>) {
<a name="l00836"></a>00836                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a> = (min + <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>)/2.0f*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>;
<a name="l00837"></a>00837             }
<a name="l00838"></a>00838         }
<a name="l00839"></a>00839         <span class="keywordflow">else</span> bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>=0;
<a name="l00840"></a>00840     }<span class="comment">/*for bp*/</span>
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 <span class="comment">/* creates new softbody if didn&#39;t exist yet, makes new points and springs arrays */</span>
<a name="l00845"></a><a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">00845</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">renew_softbody</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> totpoint, <span class="keywordtype">int</span> totspring)
<a name="l00846"></a>00846 {
<a name="l00847"></a>00847     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l00848"></a>00848     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00849"></a>00849     <span class="keywordtype">short</span> softflag;
<a name="l00850"></a>00850     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>= <a class="code" href="../../d6/df9/BKE__softbody_8h.html#a0610f8307bacb60965232adcaa958462">sbNew</a>(scene);
<a name="l00851"></a>00851     <span class="keywordflow">else</span> <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>);
<a name="l00852"></a>00852     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l00853"></a>00853     softflag=ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="keywordflow">if</span> (totpoint) {
<a name="l00856"></a>00856         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>= totpoint;
<a name="l00857"></a>00857         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>= totspring;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( totpoint*<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>), <span class="stringliteral">&quot;bodypoint&quot;</span>);
<a name="l00860"></a>00860         <span class="keywordflow">if</span> (totspring)
<a name="l00861"></a>00861             sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( totspring*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a>), <span class="stringliteral">&quot;bodyspring&quot;</span>);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863             <span class="comment">/* initialize BodyPoint array */</span>
<a name="l00864"></a>00864         <span class="keywordflow">for</span> (i=0; i&lt;totpoint; i++) {
<a name="l00865"></a>00865             <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 
<a name="l00868"></a>00868             <span class="comment">/* hum as far as i see this is overridden by _final_goal() now jow_go_for2_5 */</span>
<a name="l00869"></a>00869             <span class="comment">/* sadly breaks compatibility with older versions */</span>
<a name="l00870"></a>00870             <span class="comment">/* but makes goals behave the same for meshes, lattices and curves */</span>
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (softflag &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) {
<a name="l00872"></a>00872                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a8c589742e3c220bc85a6c9b657138f5f">defgoal</a>;
<a name="l00873"></a>00873             }
<a name="l00874"></a>00874             <span class="keywordflow">else</span> {
<a name="l00875"></a>00875                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>= 0.0f;
<a name="l00876"></a>00876                 <span class="comment">/* so this will definily be below SOFTGOALSNAP */</span>
<a name="l00877"></a>00877             }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>= 0;
<a name="l00880"></a>00880             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00881"></a>00881             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = 0.0f;
<a name="l00882"></a>00882             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a> = 0.0f;
<a name="l00883"></a>00883             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#aeb4fe956c061a5ef7ad43454be71cab1">frozen</a> = 1.0f;
<a name="l00884"></a>00884             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a> = 0.0f;
<a name="l00885"></a>00885             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> = 0;
<a name="l00886"></a>00886             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#afc21a074bcc7d58b2553d79dd260a7ac">springweight</a> = 1.0f;
<a name="l00887"></a>00887             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a644f745a1260624d90b4ae4c0f6eb0f7">mass</a> = 1.0f;
<a name="l00888"></a>00888         }
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="../../de/d32/softbody_8c.html#ae2cd1604a10042cdb64791377fd4c266">00892</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ae2cd1604a10042cdb64791377fd4c266">free_softbody_baked</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894     <a class="code" href="../../de/dac/structSBVertex.html">SBVertex</a> *key;
<a name="l00895"></a>00895     <span class="keywordtype">int</span> k;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="keywordflow">for</span> (k=0; k&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a185adbc18adce47a43552cb4e25f4e11">totkey</a>; k++) {
<a name="l00898"></a>00898         key= *(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3bbc389dca349d10f8a3d59268eed7ed">keys</a> + k);
<a name="l00899"></a>00899         <span class="keywordflow">if</span> (key) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(key);
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3bbc389dca349d10f8a3d59268eed7ed">keys</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3bbc389dca349d10f8a3d59268eed7ed">keys</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3bbc389dca349d10f8a3d59268eed7ed">keys</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00904"></a>00904     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a185adbc18adce47a43552cb4e25f4e11">totkey</a>= 0;
<a name="l00905"></a>00905 }
<a name="l00906"></a><a class="code" href="../../de/d32/softbody_8c.html#aca77c4c49c17ef94fa62810ca1d9dbbf">00906</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#aca77c4c49c17ef94fa62810ca1d9dbbf">free_scratch</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>) {
<a name="l00909"></a>00909         <span class="comment">/* todo make sure everything is cleaned up nicly */</span>
<a name="l00910"></a>00910         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>) {
<a name="l00911"></a>00911             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00912"></a>00912                     (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a53210a0b5c7bd4568f50f16dd85f04a6">GHashValFreeFP</a>) <a class="code" href="../../de/d32/softbody_8c.html#a30290bae87eb29edccff6bc14bdbca7e">ccd_mesh_free</a>); <span class="comment">/*this hoepfully will free all caches*/</span>
<a name="l00913"></a>00913             sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00914"></a>00914         }
<a name="l00915"></a>00915         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a>) {
<a name="l00916"></a>00916             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a>);
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a>) {
<a name="l00919"></a>00919             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a>);
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>);
<a name="l00922"></a>00922         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927 <span class="comment">/* only frees internal data */</span>
<a name="l00928"></a><a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">00928</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (sb) {
<a name="l00931"></a>00931         <span class="keywordtype">int</span> a;
<a name="l00932"></a>00932         <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>) {
<a name="l00935"></a>00935             <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l00936"></a>00936                 <span class="comment">/* free spring list */</span>
<a name="l00937"></a>00937                 <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00938"></a>00938                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>);
<a name="l00939"></a>00939                 }
<a name="l00940"></a>00940             }
<a name="l00941"></a>00941             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>);
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>= 0;
<a name="l00947"></a>00947         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00948"></a>00948         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <a class="code" href="../../de/d32/softbody_8c.html#aca77c4c49c17ef94fa62810ca1d9dbbf">free_scratch</a>(sb);
<a name="l00951"></a>00951         <a class="code" href="../../de/d32/softbody_8c.html#ae2cd1604a10042cdb64791377fd4c266">free_softbody_baked</a>(sb);
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment">/* ************ dynamics ********** */</span>
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="comment">/* the most general (micro physics correct) way to do collision</span>
<a name="l00959"></a>00959 <span class="comment">** (only needs the current particle position)</span>
<a name="l00960"></a>00960 <span class="comment">**</span>
<a name="l00961"></a>00961 <span class="comment">** it actually checks if the particle intrudes a short range force field generated</span>
<a name="l00962"></a>00962 <span class="comment">** by the faces of the target object and returns a force to drive the particel out</span>
<a name="l00963"></a>00963 <span class="comment">** the strenght of the field grows exponetially if the particle is on the &#39;wrong&#39; side of the face</span>
<a name="l00964"></a>00964 <span class="comment">** &#39;wrong&#39; side : projection to the face normal is negative (all referred to a vertex in the face)</span>
<a name="l00965"></a>00965 <span class="comment">**</span>
<a name="l00966"></a>00966 <span class="comment">** flaw of this: &#39;fast&#39; particles as well as &#39;fast&#39; colliding faces</span>
<a name="l00967"></a>00967 <span class="comment">** give a &#39;tunnel&#39; effect such that the particle passes through the force field</span>
<a name="l00968"></a>00968 <span class="comment">** without ever &#39;seeing&#39; it</span>
<a name="l00969"></a>00969 <span class="comment">** this is fully compliant to heisenberg: h &gt;= fuzzy(location) * fuzzy(time)</span>
<a name="l00970"></a>00970 <span class="comment">** besides our h is way larger than in QM because forces propagate way slower here</span>
<a name="l00971"></a>00971 <span class="comment">** we have to deal with fuzzy(time) in the range of 1/25 seconds (typical frame rate)</span>
<a name="l00972"></a>00972 <span class="comment">** yup collision targets are not known here any better</span>
<a name="l00973"></a>00973 <span class="comment">** and 1/25 second is looong compared to real collision events</span>
<a name="l00974"></a>00974 <span class="comment">** Q: why not use &#39;simple&#39; collision here like bouncing back a particle</span>
<a name="l00975"></a>00975 <span class="comment">**   --&gt; reverting is velocity on the face normal</span>
<a name="l00976"></a>00976 <span class="comment">** A: because our particles are not alone here</span>
<a name="l00977"></a>00977 <span class="comment">**    and need to tell their neighbors exactly what happens via spring forces</span>
<a name="l00978"></a>00978 <span class="comment">** unless sbObjectStep( .. ) is called on sub frame timing level</span>
<a name="l00979"></a>00979 <span class="comment">** BTW that also questions the use of a &#39;implicit&#39; solvers on softbodies</span>
<a name="l00980"></a>00980 <span class="comment">** since that would only valid for &#39;slow&#39; moving collision targets and dito particles</span>
<a name="l00981"></a>00981 <span class="comment">*/</span>
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="comment">/* aye this belongs to arith.c */</span>
<a name="l00984"></a><a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">00984</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(<span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> s, <span class="keywordtype">float</span> *v1)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     v[0] += s*v1[0];
<a name="l00987"></a>00987     v[1] += s*v1[1];
<a name="l00988"></a>00988     v[2] += s*v1[2];
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="comment">/* +++ dependency information functions*/</span>
<a name="l00992"></a>00992 
<a name="l00993"></a><a class="code" href="../../de/d32/softbody_8c.html#adb797873158aae93ea1dca0a0a14045b">00993</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#adb797873158aae93ea1dca0a0a14045b">are_there_deflectors</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> layer)
<a name="l00994"></a>00994 {
<a name="l00995"></a>00995     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l00998"></a>00998         <span class="keywordflow">if</span> ( (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; layer) &amp;&amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>) {
<a name="l00999"></a>00999             <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>)
<a name="l01000"></a>01000                 <span class="keywordflow">return</span> 1;
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003     <span class="keywordflow">return</span> 0;
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 
<a name="l01006"></a><a class="code" href="../../de/d32/softbody_8c.html#a7739955b3f3596cdbc889c13ffb686f2">01006</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a7739955b3f3596cdbc889c13ffb686f2">query_external_colliders</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *me)
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008     <span class="keywordflow">return</span>(<a class="code" href="../../de/d32/softbody_8c.html#adb797873158aae93ea1dca0a0a14045b">are_there_deflectors</a>(scene, me-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>));
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 <span class="comment">/* --- dependency information functions*/</span>
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="comment">/* +++ the aabb &quot;force&quot; section*/</span>
<a name="l01014"></a><a class="code" href="../../de/d32/softbody_8c.html#a9d3730e34c845944c63c5ddca08c2d30">01014</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a9d3730e34c845944c63c5ddca08c2d30">sb_detect_aabb_collisionCached</a>(  <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(force[3]), <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(par_layer),<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner,<span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(time))
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01017"></a>01017     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb=vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l01018"></a>01018     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01019"></a>01019     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *ihash;
<a name="l01020"></a>01020     <span class="keywordtype">float</span>  aabbmin[3],aabbmax[3];
<a name="l01021"></a>01021     <span class="keywordtype">int</span> deflected=0;
<a name="l01022"></a>01022 <span class="preprocessor">#if 0</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span>    <span class="keywordtype">int</span> a;
<a name="l01024"></a>01024 <span class="preprocessor">#endif</span>
<a name="l01025"></a>01025 <span class="preprocessor"></span>
<a name="l01026"></a>01026     <span class="keywordflow">if</span> ((sb == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a> ==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) <span class="keywordflow">return</span> 0;
<a name="l01027"></a>01027     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(aabbmin,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>);
<a name="l01028"></a>01028     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(aabbmax,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     hash  = vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l01031"></a>01031     ihash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(hash);
<a name="l01032"></a>01032     <span class="keywordflow">while</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(ihash) ) {
<a name="l01033"></a>01033 
<a name="l01034"></a>01034         <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a> (ihash);
<a name="l01035"></a>01035         ob             = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>   (ihash);
<a name="l01036"></a>01036             <span class="comment">/* only with deflecting set */</span>
<a name="l01037"></a>01037             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l01038"></a>01038 <span class="preprocessor">#if 0           </span><span class="comment">/* UNUSED */</span>
<a name="l01039"></a>01039                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01040"></a>01040                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01041"></a>01041                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mprevvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01042"></a>01042                 <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01043"></a>01043 <span class="preprocessor">#endif</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ccdm) {
<a name="l01045"></a>01045 <span class="preprocessor">#if 0               </span><span class="comment">/* UNUSED */</span>
<a name="l01046"></a>01046                     mface= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l01047"></a>01047                     mvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l01048"></a>01048                     mprevvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l01049"></a>01049                     mima= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l01050"></a>01050                     a = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>;
<a name="l01051"></a>01051 <span class="preprocessor">#endif</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ((aabbmax[0] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]) ||
<a name="l01053"></a>01053                         (aabbmax[1] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]) ||
<a name="l01054"></a>01054                         (aabbmax[2] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]) ||
<a name="l01055"></a>01055                         (aabbmin[0] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]) ||
<a name="l01056"></a>01056                         (aabbmin[1] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]) ||
<a name="l01057"></a>01057                         (aabbmin[2] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]) ) {
<a name="l01058"></a>01058                         <span class="comment">/* boxes don&#39;t intersect */</span>
<a name="l01059"></a>01059                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01060"></a>01060                         <span class="keywordflow">continue</span>;
<a name="l01061"></a>01061                     }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063                     <span class="comment">/* so now we have the 2 boxes overlapping */</span>
<a name="l01064"></a>01064                     <span class="comment">/* forces actually not used */</span>
<a name="l01065"></a>01065                     deflected = 2;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067                 }
<a name="l01068"></a>01068                 <span class="keywordflow">else</span> {
<a name="l01069"></a>01069                     <span class="comment">/*aye that should be cached*/</span>
<a name="l01070"></a>01070                     printf(<span class="stringliteral">&quot;missing cache error\n&quot;</span>);
<a name="l01071"></a>01071                     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01072"></a>01072                     <span class="keywordflow">continue</span>;
<a name="l01073"></a>01073                 }
<a name="l01074"></a>01074             } <span class="comment">/* if (ob-&gt;pd &amp;&amp; ob-&gt;pd-&gt;deflect) */</span>
<a name="l01075"></a>01075             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01076"></a>01076     } <span class="comment">/* while () */</span>
<a name="l01077"></a>01077     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(ihash);
<a name="l01078"></a>01078     <span class="keywordflow">return</span> deflected;
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 <span class="comment">/* --- the aabb section*/</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="comment">/* +++ the face external section*/</span>
<a name="l01084"></a><a class="code" href="../../de/d32/softbody_8c.html#a1493771b239c8a008c8c779905d54815">01084</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a1493771b239c8a008c8c779905d54815">sb_detect_face_pointCached</a>(<span class="keywordtype">float</span> face_v1[3],<span class="keywordtype">float</span> face_v2[3],<span class="keywordtype">float</span> face_v3[3],<span class="keywordtype">float</span> *damp,
<a name="l01085"></a>01085                                    <span class="keywordtype">float</span> force[3], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(par_layer),<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner,<span class="keywordtype">float</span> time)
<a name="l01086"></a>01086                                    {
<a name="l01087"></a>01087     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01088"></a>01088     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01089"></a>01089     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *ihash;
<a name="l01090"></a>01090     <span class="keywordtype">float</span> nv1[3], edge1[3], edge2[3], d_nvect[3], aabbmin[3],aabbmax[3];
<a name="l01091"></a>01091     <span class="keywordtype">float</span> facedist,outerfacethickness,tune = 10.f;
<a name="l01092"></a>01092     <span class="keywordtype">int</span> a, deflected=0;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     aabbmin[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[0],face_v2[0],face_v3[0]);
<a name="l01095"></a>01095     aabbmin[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[1],face_v2[1],face_v3[1]);
<a name="l01096"></a>01096     aabbmin[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[2],face_v2[2],face_v3[2]);
<a name="l01097"></a>01097     aabbmax[0] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[0],face_v2[0],face_v3[0]);
<a name="l01098"></a>01098     aabbmax[1] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[1],face_v2[1],face_v3[1]);
<a name="l01099"></a>01099     aabbmax[2] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[2],face_v2[2],face_v3[2]);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <span class="comment">/* calculate face normal once again SIGH */</span>
<a name="l01102"></a>01102     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, face_v1, face_v2);
<a name="l01103"></a>01103     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, face_v3, face_v2);
<a name="l01104"></a>01104     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01105"></a>01105     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     hash  = vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l01109"></a>01109     ihash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(hash);
<a name="l01110"></a>01110     <span class="keywordflow">while</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(ihash) ) {
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a> (ihash);
<a name="l01113"></a>01113         ob             = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>   (ihash);
<a name="l01114"></a>01114             <span class="comment">/* only with deflecting set */</span>
<a name="l01115"></a>01115             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l01116"></a>01116                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01117"></a>01117                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mprevvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01118"></a>01118                 <span class="keywordflow">if</span> (ccdm) {
<a name="l01119"></a>01119                     mvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l01120"></a>01120                     a    = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a95b5ec8bad2716b6b478214d84da0a39">totvert</a>;
<a name="l01121"></a>01121                     mprevvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l01122"></a>01122                     outerfacethickness = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a0ba43582aa767541372924054d9a000e">pdef_sboft</a>;
<a name="l01123"></a>01123                     <span class="keywordflow">if</span> ((aabbmax[0] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]) ||
<a name="l01124"></a>01124                         (aabbmax[1] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]) ||
<a name="l01125"></a>01125                         (aabbmax[2] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]) ||
<a name="l01126"></a>01126                         (aabbmin[0] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]) ||
<a name="l01127"></a>01127                         (aabbmin[1] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]) ||
<a name="l01128"></a>01128                         (aabbmin[2] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]) ) {
<a name="l01129"></a>01129                         <span class="comment">/* boxes don&#39;t intersect */</span>
<a name="l01130"></a>01130                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01131"></a>01131                         <span class="keywordflow">continue</span>;
<a name="l01132"></a>01132                     }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134                 }
<a name="l01135"></a>01135                 <span class="keywordflow">else</span> {
<a name="l01136"></a>01136                     <span class="comment">/*aye that should be cached*/</span>
<a name="l01137"></a>01137                     printf(<span class="stringliteral">&quot;missing cache error\n&quot;</span>);
<a name="l01138"></a>01138                     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01139"></a>01139                     <span class="keywordflow">continue</span>;
<a name="l01140"></a>01140                 }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 
<a name="l01143"></a>01143                 <span class="comment">/* use mesh*/</span>
<a name="l01144"></a>01144                 <span class="keywordflow">if</span> (mvert) {
<a name="l01145"></a>01145                     <span class="keywordflow">while</span> (a) {
<a name="l01146"></a>01146                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv1,mvert[a-1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l01147"></a>01147                         <span class="keywordflow">if</span> (mprevvert) {
<a name="l01148"></a>01148                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv1,time);
<a name="l01149"></a>01149                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv1,(1.0f-time),mprevvert[a-1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l01150"></a>01150                         }
<a name="l01151"></a>01151                         <span class="comment">/* origin to face_v2*/</span>
<a name="l01152"></a>01152                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(nv1, face_v2);
<a name="l01153"></a>01153                         facedist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nv1,d_nvect);
<a name="l01154"></a>01154                         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(facedist)&lt;outerfacethickness) {
<a name="l01155"></a>01155                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7a6709a387dc493d4446feab3e554930">isect_point_tri_prism_v3</a>(nv1, face_v1,face_v2,face_v3) ) {
<a name="l01156"></a>01156                                 <span class="keywordtype">float</span> df;
<a name="l01157"></a>01157                                 <span class="keywordflow">if</span> (facedist &gt; 0) {
<a name="l01158"></a>01158                                     df = (outerfacethickness-facedist)/outerfacethickness;
<a name="l01159"></a>01159                                 }
<a name="l01160"></a>01160                                 <span class="keywordflow">else</span> {
<a name="l01161"></a>01161                                     df = (outerfacethickness+facedist)/outerfacethickness;
<a name="l01162"></a>01162                                 }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164                                 *damp=df*tune*ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166                                 df = 0.01f*<a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(- 100.0f*df);
<a name="l01167"></a>01167                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,-df,d_nvect);
<a name="l01168"></a>01168                                 deflected = 3;
<a name="l01169"></a>01169                             }
<a name="l01170"></a>01170                         }
<a name="l01171"></a>01171                         a--;
<a name="l01172"></a>01172                     }<span class="comment">/* while (a)*/</span>
<a name="l01173"></a>01173                 } <span class="comment">/* if (mvert) */</span>
<a name="l01174"></a>01174             } <span class="comment">/* if (ob-&gt;pd &amp;&amp; ob-&gt;pd-&gt;deflect) */</span>
<a name="l01175"></a>01175             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01176"></a>01176     } <span class="comment">/* while () */</span>
<a name="l01177"></a>01177     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(ihash);
<a name="l01178"></a>01178     <span class="keywordflow">return</span> deflected;
<a name="l01179"></a>01179 }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181 
<a name="l01182"></a><a class="code" href="../../de/d32/softbody_8c.html#af71c3723bde13a0661982e21b8b0c8e7">01182</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#af71c3723bde13a0661982e21b8b0c8e7">sb_detect_face_collisionCached</a>(<span class="keywordtype">float</span> face_v1[3],<span class="keywordtype">float</span> face_v2[3],<span class="keywordtype">float</span> face_v3[3],<span class="keywordtype">float</span> *damp,
<a name="l01183"></a>01183                                    <span class="keywordtype">float</span> force[3], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(par_layer),<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner,<span class="keywordtype">float</span> time)
<a name="l01184"></a>01184 {
<a name="l01185"></a>01185     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01186"></a>01186     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01187"></a>01187     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *ihash;
<a name="l01188"></a>01188     <span class="keywordtype">float</span> nv1[3], nv2[3], nv3[3], nv4[3], edge1[3], edge2[3], d_nvect[3], aabbmin[3],aabbmax[3];
<a name="l01189"></a>01189     <span class="keywordtype">float</span> t,tune = 10.0f;
<a name="l01190"></a>01190     <span class="keywordtype">int</span> a, deflected=0;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     aabbmin[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[0],face_v2[0],face_v3[0]);
<a name="l01193"></a>01193     aabbmin[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[1],face_v2[1],face_v3[1]);
<a name="l01194"></a>01194     aabbmin[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(face_v1[2],face_v2[2],face_v3[2]);
<a name="l01195"></a>01195     aabbmax[0] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[0],face_v2[0],face_v3[0]);
<a name="l01196"></a>01196     aabbmax[1] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[1],face_v2[1],face_v3[1]);
<a name="l01197"></a>01197     aabbmax[2] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(face_v1[2],face_v2[2],face_v3[2]);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     hash  = vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l01200"></a>01200     ihash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(hash);
<a name="l01201"></a>01201     <span class="keywordflow">while</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(ihash) ) {
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a> (ihash);
<a name="l01204"></a>01204         ob             = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>   (ihash);
<a name="l01205"></a>01205             <span class="comment">/* only with deflecting set */</span>
<a name="l01206"></a>01206             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l01207"></a>01207                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01208"></a>01208                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01209"></a>01209                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mprevvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01210"></a>01210                 <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01211"></a>01211                 <span class="keywordflow">if</span> (ccdm) {
<a name="l01212"></a>01212                     mface= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l01213"></a>01213                     mvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l01214"></a>01214                     mprevvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l01215"></a>01215                     mima= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l01216"></a>01216                     a = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218                     <span class="keywordflow">if</span> ((aabbmax[0] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]) ||
<a name="l01219"></a>01219                         (aabbmax[1] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]) ||
<a name="l01220"></a>01220                         (aabbmax[2] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]) ||
<a name="l01221"></a>01221                         (aabbmin[0] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]) ||
<a name="l01222"></a>01222                         (aabbmin[1] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]) ||
<a name="l01223"></a>01223                         (aabbmin[2] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]) ) {
<a name="l01224"></a>01224                         <span class="comment">/* boxes don&#39;t intersect */</span>
<a name="l01225"></a>01225                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01226"></a>01226                         <span class="keywordflow">continue</span>;
<a name="l01227"></a>01227                     }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 }
<a name="l01230"></a>01230                 <span class="keywordflow">else</span> {
<a name="l01231"></a>01231                     <span class="comment">/*aye that should be cached*/</span>
<a name="l01232"></a>01232                     printf(<span class="stringliteral">&quot;missing cache error\n&quot;</span>);
<a name="l01233"></a>01233                     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01234"></a>01234                     <span class="keywordflow">continue</span>;
<a name="l01235"></a>01235                 }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237 
<a name="l01238"></a>01238                 <span class="comment">/* use mesh*/</span>
<a name="l01239"></a>01239                 <span class="keywordflow">while</span> (a--) {
<a name="l01240"></a>01240                     <span class="keywordflow">if</span> (
<a name="l01241"></a>01241                         (aabbmax[0] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>) ||
<a name="l01242"></a>01242                         (aabbmin[0] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>) ||
<a name="l01243"></a>01243                         (aabbmax[1] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>) ||
<a name="l01244"></a>01244                         (aabbmin[1] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>) ||
<a name="l01245"></a>01245                         (aabbmax[2] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>) ||
<a name="l01246"></a>01246                         (aabbmin[2] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>)
<a name="l01247"></a>01247                         ) {
<a name="l01248"></a>01248                         mface++;
<a name="l01249"></a>01249                         mima++;
<a name="l01250"></a>01250                         <span class="keywordflow">continue</span>;
<a name="l01251"></a>01251                     }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 
<a name="l01254"></a>01254                     <span class="keywordflow">if</span> (mvert) {
<a name="l01255"></a>01255 
<a name="l01256"></a>01256                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv1,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01257"></a>01257                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv2,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01258"></a>01258                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv3,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01259"></a>01259                         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01260"></a>01260                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv4,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01261"></a>01261                         }
<a name="l01262"></a>01262                         <span class="keywordflow">if</span> (mprevvert) {
<a name="l01263"></a>01263                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv1,time);
<a name="l01264"></a>01264                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv1,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01265"></a>01265 
<a name="l01266"></a>01266                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv2,time);
<a name="l01267"></a>01267                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv2,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv3,time);
<a name="l01270"></a>01270                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv3,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01271"></a>01271 
<a name="l01272"></a>01272                             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01273"></a>01273                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv4,time);
<a name="l01274"></a>01274                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv4,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01275"></a>01275                             }
<a name="l01276"></a>01276                         }
<a name="l01277"></a>01277                     }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279                     <span class="comment">/* switch origin to be nv2*/</span>
<a name="l01280"></a>01280                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv1, nv2);
<a name="l01281"></a>01281                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv3, nv2);
<a name="l01282"></a>01282                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01283"></a>01283                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01284"></a>01284                     <span class="keywordflow">if</span> (
<a name="l01285"></a>01285                         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(nv1, nv2, face_v1, face_v2, face_v3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ||
<a name="l01286"></a>01286                         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(nv2, nv3, face_v1, face_v2, face_v3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ||
<a name="l01287"></a>01287                         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(nv3, nv1, face_v1, face_v2, face_v3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ) {
<a name="l01288"></a>01288                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,-0.5f,d_nvect);
<a name="l01289"></a>01289                         *damp=tune*ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01290"></a>01290                         deflected = 2;
<a name="l01291"></a>01291                     }
<a name="l01292"></a>01292                     <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) { <span class="comment">/* quad */</span>
<a name="l01293"></a>01293                         <span class="comment">/* switch origin to be nv4 */</span>
<a name="l01294"></a>01294                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv3, nv4);
<a name="l01295"></a>01295                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv1, nv4);
<a name="l01296"></a>01296                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01297"></a>01297                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01298"></a>01298                         <span class="keywordflow">if</span> (
<a name="l01299"></a>01299                             <span class="comment">/* isect_line_tri_v3(nv1, nv3, face_v1, face_v2, face_v3, &amp;t, NULL) ||</span>
<a name="l01300"></a>01300 <span class="comment">                             we did that edge already */</span>
<a name="l01301"></a>01301                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(nv3, nv4, face_v1, face_v2, face_v3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ||
<a name="l01302"></a>01302                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(nv4, nv1, face_v1, face_v2, face_v3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ) {
<a name="l01303"></a>01303                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,-0.5f,d_nvect);
<a name="l01304"></a>01304                             *damp=tune*ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01305"></a>01305                             deflected = 2;
<a name="l01306"></a>01306                         }
<a name="l01307"></a>01307                     }
<a name="l01308"></a>01308                     mface++;
<a name="l01309"></a>01309                     mima++;
<a name="l01310"></a>01310                 }<span class="comment">/* while a */</span>
<a name="l01311"></a>01311             } <span class="comment">/* if (ob-&gt;pd &amp;&amp; ob-&gt;pd-&gt;deflect) */</span>
<a name="l01312"></a>01312             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01313"></a>01313     } <span class="comment">/* while () */</span>
<a name="l01314"></a>01314     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(ihash);
<a name="l01315"></a>01315     <span class="keywordflow">return</span> deflected;
<a name="l01316"></a>01316 }
<a name="l01317"></a>01317 
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 
<a name="l01320"></a><a class="code" href="../../de/d32/softbody_8c.html#af52ae9b7ac75ad64586b0b06d7f8e342">01320</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#af52ae9b7ac75ad64586b0b06d7f8e342">scan_for_ext_face_forces</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> timenow)
<a name="l01321"></a>01321 {
<a name="l01322"></a>01322     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l01323"></a>01323     <a class="code" href="../../dc/dc3/structBodyFace.html">BodyFace</a> *bf;
<a name="l01324"></a>01324     <span class="keywordtype">int</span> a;
<a name="l01325"></a>01325     <span class="keywordtype">float</span> damp=0.0f,choke=1.0f;
<a name="l01326"></a>01326     <span class="keywordtype">float</span> tune = -10.0f;
<a name="l01327"></a>01327     <span class="keywordtype">float</span> feedback[3];
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="keywordflow">if</span> (sb &amp;&amp; sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a>) {
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 
<a name="l01332"></a>01332         bf = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a>;
<a name="l01333"></a>01333         <span class="keywordflow">for</span> (a=0; a&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a>; a++, bf++) {
<a name="l01334"></a>01334             bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[0]=bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[1]=bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[2]=0.0f;
<a name="l01335"></a>01335 <span class="comment">/*+++edges intruding*/</span>
<a name="l01336"></a>01336             bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">BFF_INTERSECT</a>;
<a name="l01337"></a>01337             feedback[0]=feedback[1]=feedback[2]=0.0f;
<a name="l01338"></a>01338             <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#af71c3723bde13a0661982e21b8b0c8e7">sb_detect_face_collisionCached</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,
<a name="l01339"></a>01339                 &amp;damp,  feedback, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> ,ob , timenow)) {
<a name="l01340"></a>01340                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01341"></a>01341                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01342"></a>01342                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01343"></a>01343 <span class="comment">//              Vec3PlusStVec(bf-&gt;ext_force,tune,feedback);</span>
<a name="l01344"></a>01344                 bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">BFF_INTERSECT</a>;
<a name="l01345"></a>01345                 choke = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(damp,choke),1.0f);
<a name="l01346"></a>01346             }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348             feedback[0]=feedback[1]=feedback[2]=0.0f;
<a name="l01349"></a>01349             <span class="keywordflow">if</span> ((bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>) &amp;&amp; (<a class="code" href="../../de/d32/softbody_8c.html#af71c3723bde13a0661982e21b8b0c8e7">sb_detect_face_collisionCached</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,
<a name="l01350"></a>01350                 &amp;damp,  feedback, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> ,ob , timenow))) {
<a name="l01351"></a>01351                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01352"></a>01352                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01353"></a>01353                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01354"></a>01354 <span class="comment">//              Vec3PlusStVec(bf-&gt;ext_force,tune,feedback);</span>
<a name="l01355"></a>01355                 bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">BFF_INTERSECT</a>;
<a name="l01356"></a>01356                 choke = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(damp,choke),1.0f);
<a name="l01357"></a>01357             }
<a name="l01358"></a>01358 <span class="comment">/*---edges intruding*/</span>
<a name="l01359"></a>01359 
<a name="l01360"></a>01360 <span class="comment">/*+++ close vertices*/</span>
<a name="l01361"></a>01361             <span class="keywordflow">if</span> (( bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">BFF_INTERSECT</a>)==0) {
<a name="l01362"></a>01362                 bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#accd7e511114904f75bd623c7a239e70a">BFF_CLOSEVERT</a>;
<a name="l01363"></a>01363                 tune = -1.0f;
<a name="l01364"></a>01364                 feedback[0]=feedback[1]=feedback[2]=0.0f;
<a name="l01365"></a>01365                 <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a1493771b239c8a008c8c779905d54815">sb_detect_face_pointCached</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,
<a name="l01366"></a>01366                     &amp;damp,  feedback, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> ,ob , timenow)) {
<a name="l01367"></a>01367                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01368"></a>01368                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01369"></a>01369                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01370"></a>01370 <span class="comment">//                      Vec3PlusStVec(bf-&gt;ext_force,tune,feedback);</span>
<a name="l01371"></a>01371                         bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#accd7e511114904f75bd623c7a239e70a">BFF_CLOSEVERT</a>;
<a name="l01372"></a>01372                         choke = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(damp,choke),1.0f);
<a name="l01373"></a>01373                 }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375                 feedback[0]=feedback[1]=feedback[2]=0.0f;
<a name="l01376"></a>01376                 <span class="keywordflow">if</span> ((bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>) &amp;&amp; (<a class="code" href="../../de/d32/softbody_8c.html#a1493771b239c8a008c8c779905d54815">sb_detect_face_pointCached</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,
<a name="l01377"></a>01377                     &amp;damp,  feedback, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> ,ob , timenow))) {
<a name="l01378"></a>01378                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01379"></a>01379                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01380"></a>01380                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,tune,feedback);
<a name="l01381"></a>01381 <span class="comment">//                      Vec3PlusStVec(bf-&gt;ext_force,tune,feedback);</span>
<a name="l01382"></a>01382                         bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#accd7e511114904f75bd623c7a239e70a">BFF_CLOSEVERT</a>;
<a name="l01383"></a>01383                         choke = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(damp,choke),1.0f);
<a name="l01384"></a>01384                 }
<a name="l01385"></a>01385             }
<a name="l01386"></a>01386 <span class="comment">/*--- close vertices*/</span>
<a name="l01387"></a>01387         }
<a name="l01388"></a>01388         bf = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a>;
<a name="l01389"></a>01389         <span class="keywordflow">for</span> (a=0; a&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a>; a++, bf++) {
<a name="l01390"></a>01390             <span class="keywordflow">if</span> (( bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#a05583961e23d2203362588cbbc574403">BFF_INTERSECT</a>) || ( bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#accd7e511114904f75bd623c7a239e70a">BFF_CLOSEVERT</a>))
<a name="l01391"></a>01391             {
<a name="l01392"></a>01392                 sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>,choke);
<a name="l01393"></a>01393                 sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>,choke);
<a name="l01394"></a>01394                 sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>,choke);
<a name="l01395"></a>01395                 <span class="keywordflow">if</span> (bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a>) {
<a name="l01396"></a>01396                 sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bf-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>,choke);
<a name="l01397"></a>01397                 }
<a name="l01398"></a>01398             }
<a name="l01399"></a>01399         }
<a name="l01400"></a>01400     }
<a name="l01401"></a>01401 }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403 <span class="comment">/*  --- the face external section*/</span>
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 
<a name="l01406"></a>01406 <span class="comment">/* +++ the spring external section*/</span>
<a name="l01407"></a>01407 
<a name="l01408"></a><a class="code" href="../../de/d32/softbody_8c.html#a5024fe915c4ae81797cfde6f3fdfaa0a">01408</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a5024fe915c4ae81797cfde6f3fdfaa0a">sb_detect_edge_collisionCached</a>(<span class="keywordtype">float</span> edge_v1[3],<span class="keywordtype">float</span> edge_v2[3],<span class="keywordtype">float</span> *damp,
<a name="l01409"></a>01409                                    <span class="keywordtype">float</span> force[3], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(par_layer),<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner,<span class="keywordtype">float</span> time)
<a name="l01410"></a>01410 {
<a name="l01411"></a>01411     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01412"></a>01412     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01413"></a>01413     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *ihash;
<a name="l01414"></a>01414     <span class="keywordtype">float</span> nv1[3], nv2[3], nv3[3], nv4[3], edge1[3], edge2[3], d_nvect[3], aabbmin[3],aabbmax[3];
<a name="l01415"></a>01415     <span class="keywordtype">float</span> t,el;
<a name="l01416"></a>01416     <span class="keywordtype">int</span> a, deflected=0;
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     aabbmin[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(edge_v1[0],edge_v2[0]);
<a name="l01419"></a>01419     aabbmin[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(edge_v1[1],edge_v2[1]);
<a name="l01420"></a>01420     aabbmin[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(edge_v1[2],edge_v2[2]);
<a name="l01421"></a>01421     aabbmax[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(edge_v1[0],edge_v2[0]);
<a name="l01422"></a>01422     aabbmax[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(edge_v1[1],edge_v2[1]);
<a name="l01423"></a>01423     aabbmax[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(edge_v1[2],edge_v2[2]);
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     el = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(edge_v1,edge_v2);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     hash  = vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l01428"></a>01428     ihash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(hash);
<a name="l01429"></a>01429     <span class="keywordflow">while</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(ihash) ) {
<a name="l01430"></a>01430 
<a name="l01431"></a>01431         <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a> (ihash);
<a name="l01432"></a>01432         ob             = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>   (ihash);
<a name="l01433"></a>01433             <span class="comment">/* only with deflecting set */</span>
<a name="l01434"></a>01434             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l01435"></a>01435                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01436"></a>01436                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01437"></a>01437                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mprevvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01438"></a>01438                 <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01439"></a>01439                 <span class="keywordflow">if</span> (ccdm) {
<a name="l01440"></a>01440                     mface= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l01441"></a>01441                     mvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l01442"></a>01442                     mprevvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l01443"></a>01443                     mima= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l01444"></a>01444                     a = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>;
<a name="l01445"></a>01445 
<a name="l01446"></a>01446                     <span class="keywordflow">if</span> ((aabbmax[0] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0]) ||
<a name="l01447"></a>01447                         (aabbmax[1] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1]) ||
<a name="l01448"></a>01448                         (aabbmax[2] &lt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2]) ||
<a name="l01449"></a>01449                         (aabbmin[0] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0]) ||
<a name="l01450"></a>01450                         (aabbmin[1] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1]) ||
<a name="l01451"></a>01451                         (aabbmin[2] &gt; ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2]) ) {
<a name="l01452"></a>01452                         <span class="comment">/* boxes don&#39;t intersect */</span>
<a name="l01453"></a>01453                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01454"></a>01454                         <span class="keywordflow">continue</span>;
<a name="l01455"></a>01455                     }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457                 }
<a name="l01458"></a>01458                 <span class="keywordflow">else</span> {
<a name="l01459"></a>01459                     <span class="comment">/*aye that should be cached*/</span>
<a name="l01460"></a>01460                     printf(<span class="stringliteral">&quot;missing cache error\n&quot;</span>);
<a name="l01461"></a>01461                     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01462"></a>01462                     <span class="keywordflow">continue</span>;
<a name="l01463"></a>01463                 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 
<a name="l01466"></a>01466                 <span class="comment">/* use mesh*/</span>
<a name="l01467"></a>01467                 <span class="keywordflow">while</span> (a--) {
<a name="l01468"></a>01468                     <span class="keywordflow">if</span> (
<a name="l01469"></a>01469                         (aabbmax[0] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>) ||
<a name="l01470"></a>01470                         (aabbmin[0] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>) ||
<a name="l01471"></a>01471                         (aabbmax[1] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>) ||
<a name="l01472"></a>01472                         (aabbmin[1] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>) ||
<a name="l01473"></a>01473                         (aabbmax[2] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>) ||
<a name="l01474"></a>01474                         (aabbmin[2] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>)
<a name="l01475"></a>01475                         ) {
<a name="l01476"></a>01476                         mface++;
<a name="l01477"></a>01477                         mima++;
<a name="l01478"></a>01478                         <span class="keywordflow">continue</span>;
<a name="l01479"></a>01479                     }
<a name="l01480"></a>01480 
<a name="l01481"></a>01481 
<a name="l01482"></a>01482                     <span class="keywordflow">if</span> (mvert) {
<a name="l01483"></a>01483 
<a name="l01484"></a>01484                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv1,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01485"></a>01485                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv2,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01486"></a>01486                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv3,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01487"></a>01487                         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01488"></a>01488                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv4,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01489"></a>01489                         }
<a name="l01490"></a>01490                         <span class="keywordflow">if</span> (mprevvert) {
<a name="l01491"></a>01491                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv1,time);
<a name="l01492"></a>01492                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv1,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01493"></a>01493 
<a name="l01494"></a>01494                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv2,time);
<a name="l01495"></a>01495                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv2,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv3,time);
<a name="l01498"></a>01498                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv3,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500                             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01501"></a>01501                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv4,time);
<a name="l01502"></a>01502                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv4,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01503"></a>01503                             }
<a name="l01504"></a>01504                         }
<a name="l01505"></a>01505                     }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507                     <span class="comment">/* switch origin to be nv2*/</span>
<a name="l01508"></a>01508                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv1, nv2);
<a name="l01509"></a>01509                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv3, nv2);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01512"></a>01512                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01513"></a>01513                     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(edge_v1, edge_v2, nv1, nv2, nv3, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01514"></a>01514                         <span class="keywordtype">float</span> v1[3],v2[3];
<a name="l01515"></a>01515                         <span class="keywordtype">float</span> intrusiondepth,i1,i2;
<a name="l01516"></a>01516                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1, edge_v1, nv2);
<a name="l01517"></a>01517                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v2, edge_v2, nv2);
<a name="l01518"></a>01518                         i1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v1,d_nvect);
<a name="l01519"></a>01519                         i2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v2,d_nvect);
<a name="l01520"></a>01520                         intrusiondepth = -<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(i1,i2)/el;
<a name="l01521"></a>01521                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,intrusiondepth,d_nvect);
<a name="l01522"></a>01522                         *damp=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01523"></a>01523                         deflected = 2;
<a name="l01524"></a>01524                     }
<a name="l01525"></a>01525                     <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) { <span class="comment">/* quad */</span>
<a name="l01526"></a>01526                         <span class="comment">/* switch origin to be nv4 */</span>
<a name="l01527"></a>01527                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv3, nv4);
<a name="l01528"></a>01528                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv1, nv4);
<a name="l01529"></a>01529 
<a name="l01530"></a>01530                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01531"></a>01531                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01532"></a>01532                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>( edge_v1, edge_v2,nv1, nv3, nv4, &amp;t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01533"></a>01533                             <span class="keywordtype">float</span> v1[3],v2[3];
<a name="l01534"></a>01534                             <span class="keywordtype">float</span> intrusiondepth,i1,i2;
<a name="l01535"></a>01535                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1, edge_v1, nv4);
<a name="l01536"></a>01536                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v2, edge_v2, nv4);
<a name="l01537"></a>01537                         i1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v1,d_nvect);
<a name="l01538"></a>01538                         i2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v2,d_nvect);
<a name="l01539"></a>01539                         intrusiondepth = -<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(i1,i2)/el;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 
<a name="l01542"></a>01542                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,intrusiondepth,d_nvect);
<a name="l01543"></a>01543                             *damp=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01544"></a>01544                             deflected = 2;
<a name="l01545"></a>01545                         }
<a name="l01546"></a>01546                     }
<a name="l01547"></a>01547                     mface++;
<a name="l01548"></a>01548                     mima++;
<a name="l01549"></a>01549                 }<span class="comment">/* while a */</span>
<a name="l01550"></a>01550             } <span class="comment">/* if (ob-&gt;pd &amp;&amp; ob-&gt;pd-&gt;deflect) */</span>
<a name="l01551"></a>01551             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01552"></a>01552     } <span class="comment">/* while () */</span>
<a name="l01553"></a>01553     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(ihash);
<a name="l01554"></a>01554     <span class="keywordflow">return</span> deflected;
<a name="l01555"></a>01555 }
<a name="l01556"></a>01556 
<a name="l01557"></a><a class="code" href="../../de/d32/softbody_8c.html#ac97f2e757376098769a2e0bad078ef8c">01557</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ac97f2e757376098769a2e0bad078ef8c">_scan_for_ext_spring_forces</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> timenow, <span class="keywordtype">int</span> ifirst, <span class="keywordtype">int</span> ilast, <span class="keyword">struct</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector)
<a name="l01558"></a>01558 {
<a name="l01559"></a>01559     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l01560"></a>01560     <span class="keywordtype">int</span> a;
<a name="l01561"></a>01561     <span class="keywordtype">float</span> damp;
<a name="l01562"></a>01562     <span class="keywordtype">float</span> feedback[3];
<a name="l01563"></a>01563 
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (sb &amp;&amp; sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>) {
<a name="l01565"></a>01565         <span class="keywordflow">for</span> (a=ifirst; a&lt;ilast; a++) {
<a name="l01566"></a>01566             <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>[a];
<a name="l01567"></a>01567             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>[0]=bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>[1]=bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>[2]=0.0f;
<a name="l01568"></a>01568             feedback[0]=feedback[1]=feedback[2]=0.0f;
<a name="l01569"></a>01569             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#ad2d659487f12252dbd9dae8a17f114b4">BSF_INTERSECT</a>;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571             <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a> == <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>) {
<a name="l01572"></a>01572                 <span class="comment">/* +++ springs colliding */</span>
<a name="l01573"></a>01573                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1387441f39df11260f33291584a312f8">OB_SB_EDGECOLL</a>) {
<a name="l01574"></a>01574                     <span class="keywordflow">if</span> ( <a class="code" href="../../de/d32/softbody_8c.html#a5024fe915c4ae81797cfde6f3fdfaa0a">sb_detect_edge_collisionCached</a> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a> , sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,
<a name="l01575"></a>01575                         &amp;damp,feedback,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>,ob,timenow)) {
<a name="l01576"></a>01576                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>, feedback);
<a name="l01577"></a>01577                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#ad2d659487f12252dbd9dae8a17f114b4">BSF_INTERSECT</a>;
<a name="l01578"></a>01578                             <span class="comment">//bs-&gt;cf=damp;</span>
<a name="l01579"></a>01579                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a6e00cc327e19fb753f11295d576c744f">cf</a>=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab8b0036c0478a99fa960a3f8b0a579ce">choke</a>*0.01f;
<a name="l01580"></a>01580 
<a name="l01581"></a>01581                     }
<a name="l01582"></a>01582                 }
<a name="l01583"></a>01583                 <span class="comment">/* ---- springs colliding */</span>
<a name="l01584"></a>01584 
<a name="l01585"></a>01585                 <span class="comment">/* +++ springs seeing wind ... n stuff depending on their orientation*/</span>
<a name="l01586"></a>01586                 <span class="comment">/* note we don&#39;t use sb-&gt;mediafrict but use sb-&gt;aeroedge for magnitude of effect*/</span>
<a name="l01587"></a>01587                 <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a653a97f3e54db2412f9e67b37d662500">aeroedge</a>) {
<a name="l01588"></a>01588                     <span class="keywordtype">float</span> vel[3],sp[3],pr[3],force[3];
<a name="l01589"></a>01589                     <span class="keywordtype">float</span> f,windfactor  = 0.25f;
<a name="l01590"></a>01590                     <span class="comment">/*see if we have wind*/</span>
<a name="l01591"></a>01591                     <span class="keywordflow">if</span> (do_effector) {
<a name="l01592"></a>01592                         <a class="code" href="../../db/d29/structEffectedPoint.html">EffectedPoint</a> epoint;
<a name="l01593"></a>01593                         <span class="keywordtype">float</span> speed[3]={0.0f,0.0f,0.0f};
<a name="l01594"></a>01594                         <span class="keywordtype">float</span> pos[3];
<a name="l01595"></a>01595                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(pos, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a> , sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l01596"></a>01596                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(vel, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a> , sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l01597"></a>01597                         <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7ed88ae8138e32a6549a8ce984275137">pd_point_from_soft</a>(scene, pos, vel, -1, &amp;epoint);
<a name="l01598"></a>01598                         <a class="code" href="../../dc/d65/BKE__effect_8h.html#a4099ac2ecd7e48764e8e741bf2aade72">pdDoEffectors</a>(do_effector, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>, &amp;epoint, force, speed);
<a name="l01599"></a>01599 
<a name="l01600"></a>01600                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(speed,windfactor);
<a name="l01601"></a>01601                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vel, speed);
<a name="l01602"></a>01602                     }
<a name="l01603"></a>01603                     <span class="comment">/* media in rest */</span>
<a name="l01604"></a>01604                     <span class="keywordflow">else</span> {
<a name="l01605"></a>01605                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(vel, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a> , sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l01606"></a>01606                     }
<a name="l01607"></a>01607                     f = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vel);
<a name="l01608"></a>01608                     f = -0.0001f*f*f*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a653a97f3e54db2412f9e67b37d662500">aeroedge</a>;
<a name="l01609"></a>01609                     <span class="comment">/* (todo) add a nice angle dependent function done for now BUT */</span>
<a name="l01610"></a>01610                     <span class="comment">/* still there could be some nice drag/lift function, but who needs it */</span>
<a name="l01611"></a>01611 
<a name="l01612"></a>01612                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(sp, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a> , sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l01613"></a>01613                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(pr,vel,sp);
<a name="l01614"></a>01614                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vel, pr);
<a name="l01615"></a>01615                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vel);
<a name="l01616"></a>01616                     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae79d91475c586e386bc1fa3cba1707bd">OB_SB_AERO_ANGLE</a>) {
<a name="l01617"></a>01617                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(sp);
<a name="l01618"></a>01618                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>,f*(1.0f-<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel,sp))),vel);
<a name="l01619"></a>01619                     }
<a name="l01620"></a>01620                     <span class="keywordflow">else</span> {
<a name="l01621"></a>01621                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>,f,vel); <span class="comment">// to keep compatible with 2.45 release files</span>
<a name="l01622"></a>01622                     }
<a name="l01623"></a>01623                 }
<a name="l01624"></a>01624                 <span class="comment">/* --- springs seeing wind */</span>
<a name="l01625"></a>01625             }
<a name="l01626"></a>01626         }
<a name="l01627"></a>01627     }
<a name="l01628"></a>01628 }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630 
<a name="l01631"></a><a class="code" href="../../de/d32/softbody_8c.html#a5e1eae6e502972702212e3bc87dd3dc0">01631</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a5e1eae6e502972702212e3bc87dd3dc0">scan_for_ext_spring_forces</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> timenow)
<a name="l01632"></a>01632 {
<a name="l01633"></a>01633     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l01634"></a>01634     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     do_effector = <a class="code" href="../../dc/d65/BKE__effect_8h.html#a6ebcd51628cbb20d3556d779e0b506fe">pdInitEffectors</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>);
<a name="l01637"></a>01637     <a class="code" href="../../de/d32/softbody_8c.html#ac97f2e757376098769a2e0bad078ef8c">_scan_for_ext_spring_forces</a>(scene, ob, timenow, 0, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>, do_effector);
<a name="l01638"></a>01638     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7da5e7ad353e025440f05a9adbd7032d">pdEndEffectors</a>(&amp;do_effector);
<a name="l01639"></a>01639 }
<a name="l01640"></a>01640 
<a name="l01641"></a><a class="code" href="../../de/d32/softbody_8c.html#a98fcefc0b9234159ae5a8ad1c0848211">01641</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/d32/softbody_8c.html#a98fcefc0b9234159ae5a8ad1c0848211">exec_scan_for_ext_spring_forces</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l01642"></a>01642 {
<a name="l01643"></a>01643     <a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a> *pctx = (<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>*)data;
<a name="l01644"></a>01644     <a class="code" href="../../de/d32/softbody_8c.html#ac97f2e757376098769a2e0bad078ef8c">_scan_for_ext_spring_forces</a>(pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">scene</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">ob</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">timenow</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">ilast</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">do_effector</a>);
<a name="l01645"></a>01645     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01646"></a>01646 }
<a name="l01647"></a>01647 
<a name="l01648"></a><a class="code" href="../../de/d32/softbody_8c.html#a442de4cf51c3c7aa59845d578b2ee76b">01648</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a442de4cf51c3c7aa59845d578b2ee76b">sb_sfesf_threads_run</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> timenow,<span class="keywordtype">int</span> totsprings,<span class="keywordtype">int</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr_to_break_func(<span class="keywordtype">void</span>)))
<a name="l01649"></a>01649 {
<a name="l01650"></a>01650     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01651"></a>01651     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01652"></a>01652     <a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a> *sb_threads;
<a name="l01653"></a>01653     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totthread,<a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>,dec;
<a name="l01654"></a>01654     <span class="keywordtype">int</span> lowsprings =100; <span class="comment">/* wild guess .. may increase with better thread management &#39;above&#39; or even be UI option sb-&gt;spawn_cf_threads_nopts */</span>
<a name="l01655"></a>01655 
<a name="l01656"></a>01656     do_effector= <a class="code" href="../../dc/d65/BKE__effect_8h.html#a6ebcd51628cbb20d3556d779e0b506fe">pdInitEffectors</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>);
<a name="l01657"></a>01657 
<a name="l01658"></a>01658     <span class="comment">/* figure the number of threads while preventing pretty pointless threading overhead */</span>
<a name="l01659"></a>01659     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a821a3940a952444838528ee450075408">R_FIXED_THREADS</a>)
<a name="l01660"></a>01660         totthread= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>;
<a name="l01661"></a>01661     <span class="keywordflow">else</span>
<a name="l01662"></a>01662         totthread= <a class="code" href="../../df/dbb/BLI__threads_8h.html#a7c7ea80a0fb6cafac205997f51079745">BLI_system_thread_count</a>();
<a name="l01663"></a>01663     <span class="comment">/* what if we got zillions of CPUs running but less to spread*/</span>
<a name="l01664"></a>01664     <span class="keywordflow">while</span> ((totsprings/totthread &lt; lowsprings) &amp;&amp; (totthread &gt; 1)) {
<a name="l01665"></a>01665         totthread--;
<a name="l01666"></a>01666     }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     sb_threads= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>)*totthread, <span class="stringliteral">&quot;SBSpringsThread&quot;</span>);
<a name="l01669"></a>01669     memset(sb_threads, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>)*totthread);
<a name="l01670"></a>01670     left = totsprings;
<a name="l01671"></a>01671     dec = totsprings/totthread +1;
<a name="l01672"></a>01672     <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++) {
<a name="l01673"></a>01673         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">scene</a> = scene;
<a name="l01674"></a>01674         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">ob</a> = ob;
<a name="l01675"></a>01675         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a17a1d6b3ef4b50bb3174157a1933a3cd">forcetime</a> = 0.0; <span class="comment">// not used here</span>
<a name="l01676"></a>01676         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">timenow</a> = timenow;
<a name="l01677"></a>01677         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">ilast</a>   = <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l01678"></a>01678         left = left - dec;
<a name="l01679"></a>01679         <span class="keywordflow">if</span> (left &gt;0) {
<a name="l01680"></a>01680             sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>  = <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l01681"></a>01681         }
<a name="l01682"></a>01682         <span class="keywordflow">else</span>
<a name="l01683"></a>01683             sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>  = 0;
<a name="l01684"></a>01684         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">do_effector</a> = do_effector;
<a name="l01685"></a>01685         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a62cb58e1b1d56c21261e8fa27e7c9562">do_deflector</a> = 0;<span class="comment">// not used here</span>
<a name="l01686"></a>01686         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a2d8cd1147a0f93844a3fc5593e13cbb2">fieldfactor</a> = 0.0f;<span class="comment">// not used here</span>
<a name="l01687"></a>01687         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a905f534b5a15deaeff3ab60110d81de3">windfactor</a>  = 0.0f;<span class="comment">// not used here</span>
<a name="l01688"></a>01688         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a9a65848ac770a3f7c26abbb8291811a4">nr</a>= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01689"></a>01689         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a269a397d04b7b6497fe5338dd14634b3">tot</a>= totthread;
<a name="l01690"></a>01690     }
<a name="l01691"></a>01691     <span class="keywordflow">if</span> (totthread &gt; 1) {
<a name="l01692"></a>01692         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../de/d32/softbody_8c.html#a98fcefc0b9234159ae5a8ad1c0848211">exec_scan_for_ext_spring_forces</a>, totthread);
<a name="l01693"></a>01693 
<a name="l01694"></a>01694         <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++)
<a name="l01695"></a>01695             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;sb_threads[i]);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l01698"></a>01698     }
<a name="l01699"></a>01699     <span class="keywordflow">else</span>
<a name="l01700"></a>01700         <a class="code" href="../../de/d32/softbody_8c.html#a98fcefc0b9234159ae5a8ad1c0848211">exec_scan_for_ext_spring_forces</a>(&amp;sb_threads[0]);
<a name="l01701"></a>01701     <span class="comment">/* clean up */</span>
<a name="l01702"></a>01702     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb_threads);
<a name="l01703"></a>01703 
<a name="l01704"></a>01704     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7da5e7ad353e025440f05a9adbd7032d">pdEndEffectors</a>(&amp;do_effector);
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 <span class="comment">/* --- the spring external section*/</span>
<a name="l01709"></a>01709 
<a name="l01710"></a><a class="code" href="../../de/d32/softbody_8c.html#ad39fcca36c78c93d3461379a13036931">01710</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#ad39fcca36c78c93d3461379a13036931">choose_winner</a>(<span class="keywordtype">float</span>*w, <span class="keywordtype">float</span>* pos,<span class="keywordtype">float</span>*a,<span class="keywordtype">float</span>*b,<span class="keywordtype">float</span>*c,<span class="keywordtype">float</span>*ca,<span class="keywordtype">float</span>*cb,<span class="keywordtype">float</span>*cc)
<a name="l01711"></a>01711 {
<a name="l01712"></a>01712     <span class="keywordtype">float</span> mindist,cp;
<a name="l01713"></a>01713     <span class="keywordtype">int</span> winner =1;
<a name="l01714"></a>01714     mindist = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pos,a));
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     cp = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pos,b));
<a name="l01717"></a>01717     <span class="keywordflow">if</span> ( mindist &lt; cp ) {
<a name="l01718"></a>01718         mindist = cp;
<a name="l01719"></a>01719         winner =2;
<a name="l01720"></a>01720     }
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     cp = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pos,c));
<a name="l01723"></a>01723     <span class="keywordflow">if</span> (mindist &lt; cp ) {
<a name="l01724"></a>01724         mindist = cp;
<a name="l01725"></a>01725         winner =3;
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727     <span class="keywordflow">switch</span> (winner) {
<a name="l01728"></a>01728         <span class="keywordflow">case</span> 1: <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(w,ca); <span class="keywordflow">break</span>;
<a name="l01729"></a>01729         <span class="keywordflow">case</span> 2: <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(w,cb); <span class="keywordflow">break</span>;
<a name="l01730"></a>01730         <span class="keywordflow">case</span> 3: <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(w,cc);
<a name="l01731"></a>01731     }
<a name="l01732"></a>01732     <span class="keywordflow">return</span>(winner);
<a name="l01733"></a>01733 }
<a name="l01734"></a>01734 
<a name="l01735"></a>01735 
<a name="l01736"></a>01736 
<a name="l01737"></a><a class="code" href="../../de/d32/softbody_8c.html#aa30a38fbd874c613090bd6bc1df54d86">01737</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#aa30a38fbd874c613090bd6bc1df54d86">sb_detect_vertex_collisionCached</a>(<span class="keywordtype">float</span> opco[3], <span class="keywordtype">float</span> facenormal[3], <span class="keywordtype">float</span> *damp,
<a name="l01738"></a>01738                                      <span class="keywordtype">float</span> force[3], <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(par_layer), <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *vertexowner,
<a name="l01739"></a>01739                                      <span class="keywordtype">float</span> time,<span class="keywordtype">float</span> vel[3], <span class="keywordtype">float</span> *intrusion)
<a name="l01740"></a>01740 {
<a name="l01741"></a>01741     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01742"></a>01742     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01743"></a>01743     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *ihash;
<a name="l01744"></a>01744     <span class="keywordtype">float</span> nv1[3], nv2[3], nv3[3], nv4[3], edge1[3], edge2[3],d_nvect[3], dv1[3],ve[3],avel[3]={0.0,0.0,0.0},
<a name="l01745"></a>01745           vv1[3], vv2[3], vv3[3], vv4[3], coledge[3]={0.0f, 0.0f, 0.0f}, mindistedge = 1000.0f,
<a name="l01746"></a>01746           outerforceaccu[3], innerforceaccu[3],
<a name="l01747"></a>01747           facedist, <span class="comment">/* n_mag, */</span> <span class="comment">/* UNUSED */</span> force_mag_norm, minx, miny, minz, maxx, maxy, maxz,
<a name="l01748"></a>01748           innerfacethickness = -0.5f, outerfacethickness = 0.2f,
<a name="l01749"></a>01749           ee = 5.0f, ff = 0.1f, fa=1;
<a name="l01750"></a>01750     <span class="keywordtype">int</span> a, deflected=0, cavel=0, ci=0;
<a name="l01751"></a>01751 <span class="comment">/* init */</span>
<a name="l01752"></a>01752     *intrusion = 0.0f;
<a name="l01753"></a>01753     hash  = vertexowner-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>;
<a name="l01754"></a>01754     ihash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(hash);
<a name="l01755"></a>01755     outerforceaccu[0]=outerforceaccu[1]=outerforceaccu[2]=0.0f;
<a name="l01756"></a>01756     innerforceaccu[0]=innerforceaccu[1]=innerforceaccu[2]=0.0f;
<a name="l01757"></a>01757 <span class="comment">/* go */</span>
<a name="l01758"></a>01758     <span class="keywordflow">while</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(ihash) ) {
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         <a class="code" href="../../d5/dc9/structccd__Mesh.html">ccd_Mesh</a> *ccdm = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a> (ihash);
<a name="l01761"></a>01761         ob             = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>   (ihash);
<a name="l01762"></a>01762             <span class="comment">/* only with deflecting set */</span>
<a name="l01763"></a>01763             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a95751b10530e32549805265908842fa5">deflect</a>) {
<a name="l01764"></a>01764                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01765"></a>01765                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01766"></a>01766                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mprevvert= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01767"></a>01767                 <a class="code" href="../../d2/dc3/structccdf__minmax.html">ccdf_minmax</a> *mima= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01768"></a>01768 
<a name="l01769"></a>01769                 <span class="keywordflow">if</span> (ccdm) {
<a name="l01770"></a>01770                     mface= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#af2ff22cbfd15b0e66dfc2b3feb6f1c58">mface</a>;
<a name="l01771"></a>01771                     mvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a10d0583c5fe94a38ec3b207280f1f402">mvert</a>;
<a name="l01772"></a>01772                     mprevvert= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a52b5859f61d4d25a7250a7cc493ed4ef">mprevvert</a>;
<a name="l01773"></a>01773                     mima= ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7e9be69612e6e60e50aa06dc34a13d29">mima</a>;
<a name="l01774"></a>01774                     a = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aac5b5bd8607ba85edf6f7ceb604fe763">totface</a>;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776                     minx = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[0];
<a name="l01777"></a>01777                     miny = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[1];
<a name="l01778"></a>01778                     minz = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#a7fd2b0e9345847e4f42a504d8931038d">bbmin</a>[2];
<a name="l01779"></a>01779 
<a name="l01780"></a>01780                     maxx = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[0];
<a name="l01781"></a>01781                     maxy = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[1];
<a name="l01782"></a>01782                     maxz = ccdm-&gt;<a class="code" href="../../d5/dc9/structccd__Mesh.html#aec95a2d52e05e0e12cbe272dce362166">bbmax</a>[2];
<a name="l01783"></a>01783 
<a name="l01784"></a>01784                     <span class="keywordflow">if</span> ((opco[0] &lt; minx) ||
<a name="l01785"></a>01785                         (opco[1] &lt; miny) ||
<a name="l01786"></a>01786                         (opco[2] &lt; minz) ||
<a name="l01787"></a>01787                         (opco[0] &gt; maxx) ||
<a name="l01788"></a>01788                         (opco[1] &gt; maxy) ||
<a name="l01789"></a>01789                         (opco[2] &gt; maxz) ) {
<a name="l01790"></a>01790                             <span class="comment">/* outside the padded boundbox --&gt; collision object is too far away */</span>
<a name="l01791"></a>01791                                                 <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01792"></a>01792                             <span class="keywordflow">continue</span>;
<a name="l01793"></a>01793                     }
<a name="l01794"></a>01794                 }
<a name="l01795"></a>01795                 <span class="keywordflow">else</span> {
<a name="l01796"></a>01796                     <span class="comment">/*aye that should be cached*/</span>
<a name="l01797"></a>01797                     printf(<span class="stringliteral">&quot;missing cache error\n&quot;</span>);
<a name="l01798"></a>01798                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01799"></a>01799                     <span class="keywordflow">continue</span>;
<a name="l01800"></a>01800                 }
<a name="l01801"></a>01801 
<a name="l01802"></a>01802                 <span class="comment">/* do object level stuff */</span>
<a name="l01803"></a>01803                 <span class="comment">/* need to have user control for that since it depends on model scale */</span>
<a name="l01804"></a>01804                 innerfacethickness = -ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a92a4c8053ace57341092d9bba00f9f2e">pdef_sbift</a>;
<a name="l01805"></a>01805                 outerfacethickness =  ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a0ba43582aa767541372924054d9a000e">pdef_sboft</a>;
<a name="l01806"></a>01806                 fa = (ff*outerfacethickness-outerfacethickness);
<a name="l01807"></a>01807                 fa *= fa;
<a name="l01808"></a>01808                 fa = 1.0f/fa;
<a name="l01809"></a>01809                 avel[0]=avel[1]=avel[2]=0.0f;
<a name="l01810"></a>01810                 <span class="comment">/* use mesh*/</span>
<a name="l01811"></a>01811                 <span class="keywordflow">while</span> (a--) {
<a name="l01812"></a>01812                     <span class="keywordflow">if</span> (
<a name="l01813"></a>01813                         (opco[0] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a151c29dc2007426f6627a959cc348972">minx</a>) ||
<a name="l01814"></a>01814                         (opco[0] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a0bae6ec8f40c368344f425192b455404">maxx</a>) ||
<a name="l01815"></a>01815                         (opco[1] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a3f59bbbf7c50ab29cd9e5810fda094d6">miny</a>) ||
<a name="l01816"></a>01816                         (opco[1] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a256991f284eceeaa2769e107026a83bc">maxy</a>) ||
<a name="l01817"></a>01817                         (opco[2] &lt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a5537964583688041744a898f5cdf521b">minz</a>) ||
<a name="l01818"></a>01818                         (opco[2] &gt; mima-&gt;<a class="code" href="../../d2/dc3/structccdf__minmax.html#a696eae5b16de7069b2fb0370291e70aa">maxz</a>)
<a name="l01819"></a>01819                         ) {
<a name="l01820"></a>01820                             mface++;
<a name="l01821"></a>01821                             mima++;
<a name="l01822"></a>01822                             <span class="keywordflow">continue</span>;
<a name="l01823"></a>01823                     }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825                     <span class="keywordflow">if</span> (mvert) {
<a name="l01826"></a>01826 
<a name="l01827"></a>01827                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv1,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01828"></a>01828                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv2,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01829"></a>01829                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv3,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01830"></a>01830                         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01831"></a>01831                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nv4,mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01832"></a>01832                         }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834                         <span class="keywordflow">if</span> (mprevvert) {
<a name="l01835"></a>01835                             <span class="comment">/* grab the average speed of the collider vertices</span>
<a name="l01836"></a>01836 <span class="comment">                            before we spoil nvX</span>
<a name="l01837"></a>01837 <span class="comment">                            humm could be done once a SB steps but then we&#39; need to store that too</span>
<a name="l01838"></a>01838 <span class="comment">                            since the AABB reduced propabitlty to get here drasticallly</span>
<a name="l01839"></a>01839 <span class="comment">                            it might be a nice tradeof CPU &lt;--&gt; memory</span>
<a name="l01840"></a>01840 <span class="comment">                            */</span>
<a name="l01841"></a>01841                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vv1,nv1,mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01842"></a>01842                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vv2,nv2,mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01843"></a>01843                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vv3,nv3,mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01844"></a>01844                             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01845"></a>01845                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vv4,nv4,mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01846"></a>01846                             }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv1,time);
<a name="l01849"></a>01849                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv1,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01850"></a>01850 
<a name="l01851"></a>01851                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv2,time);
<a name="l01852"></a>01852                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv2,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01853"></a>01853 
<a name="l01854"></a>01854                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv3,time);
<a name="l01855"></a>01855                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv3,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01858"></a>01858                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nv4,time);
<a name="l01859"></a>01859                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(nv4,(1.0f-time),mprevvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01860"></a>01860                             }
<a name="l01861"></a>01861                         }
<a name="l01862"></a>01862                     }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                     <span class="comment">/* switch origin to be nv2*/</span>
<a name="l01865"></a>01865                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv1, nv2);
<a name="l01866"></a>01866                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv3, nv2);
<a name="l01867"></a>01867                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dv1,opco,nv2); <span class="comment">/* abuse dv1 to have vertex in question at *origin* of triangle */</span>
<a name="l01868"></a>01868 
<a name="l01869"></a>01869                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01870"></a>01870                     <span class="comment">/* n_mag = */</span> <span class="comment">/* UNUSED */</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01871"></a>01871                     facedist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dv1,d_nvect);
<a name="l01872"></a>01872                     <span class="comment">// so rules are</span>
<a name="l01873"></a>01873                     <span class="comment">//</span>
<a name="l01874"></a>01874 
<a name="l01875"></a>01875                     <span class="keywordflow">if</span> ((facedist &gt; innerfacethickness) &amp;&amp; (facedist &lt; outerfacethickness)) {
<a name="l01876"></a>01876                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7a6709a387dc493d4446feab3e554930">isect_point_tri_prism_v3</a>(opco, nv1, nv2, nv3) ) {
<a name="l01877"></a>01877                             force_mag_norm =(float)<a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(-ee*facedist);
<a name="l01878"></a>01878                             <span class="keywordflow">if</span> (facedist &gt; outerfacethickness*ff)
<a name="l01879"></a>01879                                 force_mag_norm =(float)force_mag_norm*fa*(facedist - outerfacethickness)*(facedist - outerfacethickness);
<a name="l01880"></a>01880                             *damp=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01881"></a>01881                             <span class="keywordflow">if</span> (facedist &gt; 0.0f) {
<a name="l01882"></a>01882                                 *damp *= (1.0f - facedist/outerfacethickness);
<a name="l01883"></a>01883                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(outerforceaccu,force_mag_norm,d_nvect);
<a name="l01884"></a>01884                                 deflected = 3;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886                             }
<a name="l01887"></a>01887                             <span class="keywordflow">else</span> {
<a name="l01888"></a>01888                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(innerforceaccu,force_mag_norm,d_nvect);
<a name="l01889"></a>01889                                 <span class="keywordflow">if</span> (deflected &lt; 2) deflected = 2;
<a name="l01890"></a>01890                             }
<a name="l01891"></a>01891                             <span class="keywordflow">if</span> ((mprevvert) &amp;&amp; (*damp &gt; 0.0f)) {
<a name="l01892"></a>01892                                 <a class="code" href="../../de/d32/softbody_8c.html#ad39fcca36c78c93d3461379a13036931">choose_winner</a>(ve,opco,nv1,nv2,nv3,vv1,vv2,vv3);
<a name="l01893"></a>01893                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(avel, ve);
<a name="l01894"></a>01894                                 cavel ++;
<a name="l01895"></a>01895                             }
<a name="l01896"></a>01896                             *intrusion += facedist;
<a name="l01897"></a>01897                             ci++;
<a name="l01898"></a>01898                         }
<a name="l01899"></a>01899                     }
<a name="l01900"></a>01900                     <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) { <span class="comment">/* quad */</span>
<a name="l01901"></a>01901                         <span class="comment">/* switch origin to be nv4 */</span>
<a name="l01902"></a>01902                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, nv3, nv4);
<a name="l01903"></a>01903                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, nv1, nv4);
<a name="l01904"></a>01904                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dv1,opco,nv4); <span class="comment">/* abuse dv1 to have vertex in question at *origin* of triangle */</span>
<a name="l01905"></a>01905 
<a name="l01906"></a>01906                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(d_nvect, edge2, edge1);
<a name="l01907"></a>01907                         <span class="comment">/* n_mag = */</span> <span class="comment">/* UNUSED */</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d_nvect);
<a name="l01908"></a>01908                         facedist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dv1,d_nvect);
<a name="l01909"></a>01909 
<a name="l01910"></a>01910                         <span class="keywordflow">if</span> ((facedist &gt; innerfacethickness) &amp;&amp; (facedist &lt; outerfacethickness)) {
<a name="l01911"></a>01911                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7a6709a387dc493d4446feab3e554930">isect_point_tri_prism_v3</a>(opco, nv1, nv3, nv4) ) {
<a name="l01912"></a>01912                                 force_mag_norm =(float)<a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(-ee*facedist);
<a name="l01913"></a>01913                                 <span class="keywordflow">if</span> (facedist &gt; outerfacethickness*ff)
<a name="l01914"></a>01914                                     force_mag_norm =(float)force_mag_norm*fa*(facedist - outerfacethickness)*(facedist - outerfacethickness);
<a name="l01915"></a>01915                                 *damp=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l01916"></a>01916                             <span class="keywordflow">if</span> (facedist &gt; 0.0f) {
<a name="l01917"></a>01917                                 *damp *= (1.0f - facedist/outerfacethickness);
<a name="l01918"></a>01918                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(outerforceaccu,force_mag_norm,d_nvect);
<a name="l01919"></a>01919                                 deflected = 3;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921                             }
<a name="l01922"></a>01922                             <span class="keywordflow">else</span> {
<a name="l01923"></a>01923                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(innerforceaccu,force_mag_norm,d_nvect);
<a name="l01924"></a>01924                                 <span class="keywordflow">if</span> (deflected &lt; 2) deflected = 2;
<a name="l01925"></a>01925                             }
<a name="l01926"></a>01926 
<a name="l01927"></a>01927                                 <span class="keywordflow">if</span> ((mprevvert) &amp;&amp; (*damp &gt; 0.0f)) {
<a name="l01928"></a>01928                                     <a class="code" href="../../de/d32/softbody_8c.html#ad39fcca36c78c93d3461379a13036931">choose_winner</a>(ve,opco,nv1,nv3,nv4,vv1,vv3,vv4);
<a name="l01929"></a>01929                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(avel, ve);
<a name="l01930"></a>01930                                     cavel ++;
<a name="l01931"></a>01931                                 }
<a name="l01932"></a>01932                                 *intrusion += facedist;
<a name="l01933"></a>01933                                 ci++;
<a name="l01934"></a>01934                             }
<a name="l01935"></a>01935 
<a name="l01936"></a>01936                         }
<a name="l01937"></a>01937                         <span class="keywordflow">if</span> ((deflected &lt; 2)&amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rt != 444)) <span class="comment">// we did not hit a face until now</span>
<a name="l01938"></a>01938                         { <span class="comment">// see if &#39;outer&#39; hits an edge</span>
<a name="l01939"></a>01939                             <span class="keywordtype">float</span> dist;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(ve, opco, nv1, nv2);
<a name="l01942"></a>01942                              <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ve,opco,ve);
<a name="l01943"></a>01943                             dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ve);
<a name="l01944"></a>01944                             <span class="keywordflow">if</span> ((dist &lt; outerfacethickness)&amp;&amp;(dist &lt; mindistedge )) {
<a name="l01945"></a>01945                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(coledge,ve);
<a name="l01946"></a>01946                                 mindistedge = dist,
<a name="l01947"></a>01947                                 deflected=1;
<a name="l01948"></a>01948                             }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(ve, opco, nv2, nv3);
<a name="l01951"></a>01951                              <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ve,opco,ve);
<a name="l01952"></a>01952                             dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ve);
<a name="l01953"></a>01953                             <span class="keywordflow">if</span> ((dist &lt; outerfacethickness)&amp;&amp;(dist &lt; mindistedge )) {
<a name="l01954"></a>01954                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(coledge,ve);
<a name="l01955"></a>01955                                 mindistedge = dist,
<a name="l01956"></a>01956                                 deflected=1;
<a name="l01957"></a>01957                             }
<a name="l01958"></a>01958 
<a name="l01959"></a>01959                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(ve, opco, nv3, nv1);
<a name="l01960"></a>01960                              <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ve,opco,ve);
<a name="l01961"></a>01961                             dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ve);
<a name="l01962"></a>01962                             <span class="keywordflow">if</span> ((dist &lt; outerfacethickness)&amp;&amp;(dist &lt; mindistedge )) {
<a name="l01963"></a>01963                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(coledge,ve);
<a name="l01964"></a>01964                                 mindistedge = dist,
<a name="l01965"></a>01965                                 deflected=1;
<a name="l01966"></a>01966                             }
<a name="l01967"></a>01967                             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) { <span class="comment">/* quad */</span>
<a name="l01968"></a>01968                                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(ve, opco, nv3, nv4);
<a name="l01969"></a>01969                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ve,opco,ve);
<a name="l01970"></a>01970                                 dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ve);
<a name="l01971"></a>01971                                 <span class="keywordflow">if</span> ((dist &lt; outerfacethickness)&amp;&amp;(dist &lt; mindistedge )) {
<a name="l01972"></a>01972                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(coledge,ve);
<a name="l01973"></a>01973                                     mindistedge = dist,
<a name="l01974"></a>01974                                         deflected=1;
<a name="l01975"></a>01975                                 }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977                                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(ve, opco, nv1, nv4);
<a name="l01978"></a>01978                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ve,opco,ve);
<a name="l01979"></a>01979                                 dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ve);
<a name="l01980"></a>01980                                 <span class="keywordflow">if</span> ((dist &lt; outerfacethickness)&amp;&amp;(dist &lt; mindistedge )) {
<a name="l01981"></a>01981                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(coledge,ve);
<a name="l01982"></a>01982                                     mindistedge = dist,
<a name="l01983"></a>01983                                         deflected=1;
<a name="l01984"></a>01984                                 }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986                             }
<a name="l01987"></a>01987 
<a name="l01988"></a>01988 
<a name="l01989"></a>01989                         }
<a name="l01990"></a>01990                     }
<a name="l01991"></a>01991                     mface++;
<a name="l01992"></a>01992                     mima++;
<a name="l01993"></a>01993                 }<span class="comment">/* while a */</span>
<a name="l01994"></a>01994             } <span class="comment">/* if (ob-&gt;pd &amp;&amp; ob-&gt;pd-&gt;deflect) */</span>
<a name="l01995"></a>01995             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(ihash);
<a name="l01996"></a>01996     } <span class="comment">/* while () */</span>
<a name="l01997"></a>01997 
<a name="l01998"></a>01998     <span class="keywordflow">if</span> (deflected == 1) { <span class="comment">// no face but &#39;outer&#39; edge cylinder sees vert</span>
<a name="l01999"></a>01999         force_mag_norm =(float)<a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(-ee*mindistedge);
<a name="l02000"></a>02000         <span class="keywordflow">if</span> (mindistedge &gt; outerfacethickness*ff)
<a name="l02001"></a>02001             force_mag_norm =(float)force_mag_norm*fa*(mindistedge - outerfacethickness)*(mindistedge - outerfacethickness);
<a name="l02002"></a>02002         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(force,force_mag_norm,coledge);
<a name="l02003"></a>02003         *damp=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#afce13d76e7256686a62205f0b63a9a1d">pdef_sbdamp</a>;
<a name="l02004"></a>02004         <span class="keywordflow">if</span> (mindistedge &gt; 0.0f) {
<a name="l02005"></a>02005             *damp *= (1.0f - mindistedge/outerfacethickness);
<a name="l02006"></a>02006         }
<a name="l02007"></a>02007 
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009     <span class="keywordflow">if</span> (deflected == 2) { <span class="comment">//  face inner detected</span>
<a name="l02010"></a>02010         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(force, innerforceaccu);
<a name="l02011"></a>02011     }
<a name="l02012"></a>02012     <span class="keywordflow">if</span> (deflected == 3) { <span class="comment">//  face outer detected</span>
<a name="l02013"></a>02013         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(force, outerforceaccu);
<a name="l02014"></a>02014     }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(ihash);
<a name="l02017"></a>02017     <span class="keywordflow">if</span> (cavel) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(avel,1.0f/(<span class="keywordtype">float</span>)cavel);
<a name="l02018"></a>02018     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vel,avel);
<a name="l02019"></a>02019     <span class="keywordflow">if</span> (ci) *intrusion /= ci;
<a name="l02020"></a>02020     <span class="keywordflow">if</span> (deflected) {
<a name="l02021"></a>02021         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(facenormal, force);
<a name="l02022"></a>02022     }
<a name="l02023"></a>02023     <span class="keywordflow">return</span> deflected;
<a name="l02024"></a>02024 }
<a name="l02025"></a>02025 
<a name="l02026"></a>02026 
<a name="l02027"></a>02027 <span class="comment">/* sandbox to plug in various deflection algos */</span>
<a name="l02028"></a><a class="code" href="../../de/d32/softbody_8c.html#a1f4b1fcc3571b047d1ca2c1067325faa">02028</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a1f4b1fcc3571b047d1ca2c1067325faa">sb_deflect_face</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> *actpos,<span class="keywordtype">float</span> *facenormal,<span class="keywordtype">float</span> *force,<span class="keywordtype">float</span> *cf,<span class="keywordtype">float</span> time,<span class="keywordtype">float</span> *vel,<span class="keywordtype">float</span> *intrusion)
<a name="l02029"></a>02029 {
<a name="l02030"></a>02030     <span class="keywordtype">float</span> s_actpos[3];
<a name="l02031"></a>02031     <span class="keywordtype">int</span> deflected;
<a name="l02032"></a>02032     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(s_actpos,actpos);
<a name="l02033"></a>02033     deflected= <a class="code" href="../../de/d32/softbody_8c.html#aa30a38fbd874c613090bd6bc1df54d86">sb_detect_vertex_collisionCached</a>(s_actpos, facenormal, cf, force , ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>, ob,time,vel,intrusion);
<a name="l02034"></a>02034     <span class="comment">//deflected= sb_detect_vertex_collisionCachedEx(s_actpos, facenormal, cf, force , ob-&gt;lay, ob,time,vel,intrusion);</span>
<a name="l02035"></a>02035     <span class="keywordflow">return</span>(deflected);
<a name="l02036"></a>02036 }
<a name="l02037"></a>02037 
<a name="l02038"></a>02038 <span class="comment">/* hiding this for now .. but the jacobian may pop up on other tasks .. so i&#39;d like to keep it</span>
<a name="l02039"></a>02039 <span class="comment">static void dfdx_spring(int ia, int ic, int op, float dir[3],float L,float len,float factor)</span>
<a name="l02040"></a>02040 <span class="comment">{</span>
<a name="l02041"></a>02041 <span class="comment">    float m,delta_ij;</span>
<a name="l02042"></a>02042 <span class="comment">    int i ,j;</span>
<a name="l02043"></a>02043 <span class="comment">    if (L &lt; len) {</span>
<a name="l02044"></a>02044 <span class="comment">        for (i=0;i&lt;3;i++)</span>
<a name="l02045"></a>02045 <span class="comment">            for (j=0;j&lt;3;j++) {</span>
<a name="l02046"></a>02046 <span class="comment">                delta_ij = (i==j ? (1.0f): (0.0f));</span>
<a name="l02047"></a>02047 <span class="comment">                m=factor*(dir[i]*dir[j] + (1-L/len)*(delta_ij - dir[i]*dir[j]));</span>
<a name="l02048"></a>02048 <span class="comment">                nlMatrixAdd(ia+i,op+ic+j,m);</span>
<a name="l02049"></a>02049 <span class="comment">            }</span>
<a name="l02050"></a>02050 <span class="comment">    }</span>
<a name="l02051"></a>02051 <span class="comment">    else {</span>
<a name="l02052"></a>02052 <span class="comment">        for (i=0;i&lt;3;i++)</span>
<a name="l02053"></a>02053 <span class="comment">            for (j=0;j&lt;3;j++) {</span>
<a name="l02054"></a>02054 <span class="comment">                m=factor*dir[i]*dir[j];</span>
<a name="l02055"></a>02055 <span class="comment">                nlMatrixAdd(ia+i,op+ic+j,m);</span>
<a name="l02056"></a>02056 <span class="comment">            }</span>
<a name="l02057"></a>02057 <span class="comment">    }</span>
<a name="l02058"></a>02058 <span class="comment">}</span>
<a name="l02059"></a>02059 <span class="comment"></span>
<a name="l02060"></a>02060 <span class="comment"></span>
<a name="l02061"></a>02061 <span class="comment">static void dfdx_goal(int ia, int ic, int op, float factor)</span>
<a name="l02062"></a>02062 <span class="comment">{</span>
<a name="l02063"></a>02063 <span class="comment">    int i;</span>
<a name="l02064"></a>02064 <span class="comment">    for (i=0;i&lt;3;i++) nlMatrixAdd(ia+i,op+ic+i,factor);</span>
<a name="l02065"></a>02065 <span class="comment">}</span>
<a name="l02066"></a>02066 <span class="comment"></span>
<a name="l02067"></a>02067 <span class="comment">static void dfdv_goal(int ia, int ic,float factor)</span>
<a name="l02068"></a>02068 <span class="comment">{</span>
<a name="l02069"></a>02069 <span class="comment">    int i;</span>
<a name="l02070"></a>02070 <span class="comment">    for (i=0;i&lt;3;i++) nlMatrixAdd(ia+i,ic+i,factor);</span>
<a name="l02071"></a>02071 <span class="comment">}</span>
<a name="l02072"></a>02072 <span class="comment">*/</span>
<a name="l02073"></a><a class="code" href="../../de/d32/softbody_8c.html#af2bc841c7dbd64a2af2ad0b9cd6eefb5">02073</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#af2bc841c7dbd64a2af2ad0b9cd6eefb5">sb_spring_force</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">int</span> bpi,<a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs,<span class="keywordtype">float</span> iks,<span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(forcetime), <span class="keywordtype">int</span> nl_flags)
<a name="l02074"></a>02074 {
<a name="l02075"></a>02075     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l02076"></a>02076     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>  *bp1,*bp2;
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     <span class="keywordtype">float</span> dir[3],dvel[3];
<a name="l02079"></a>02079     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>,forcefactor,kd,absvel,projvel,kw;
<a name="l02080"></a>02080 <span class="preprocessor">#if 0   </span><span class="comment">/* UNUSED */</span>
<a name="l02081"></a>02081     <span class="keywordtype">int</span> ia,ic;
<a name="l02082"></a>02082 <span class="preprocessor">#endif</span>
<a name="l02083"></a>02083 <span class="preprocessor"></span>    <span class="comment">/* prepare depending on which side of the spring we are on */</span>
<a name="l02084"></a>02084     <span class="keywordflow">if</span> (bpi == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>) {
<a name="l02085"></a>02085         bp1 = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>];
<a name="l02086"></a>02086         bp2 = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>];
<a name="l02087"></a>02087 <span class="preprocessor">#if 0   </span><span class="comment">/* UNUSED */</span>
<a name="l02088"></a>02088         ia =3*bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>;
<a name="l02089"></a>02089         ic =3*bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l02090"></a>02090 <span class="preprocessor">#endif</span>
<a name="l02091"></a>02091 <span class="preprocessor"></span>    }
<a name="l02092"></a>02092     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bpi == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>) {
<a name="l02093"></a>02093         bp1 = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>];
<a name="l02094"></a>02094         bp2 = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>];
<a name="l02095"></a>02095 <span class="preprocessor">#if 0   </span><span class="comment">/* UNUSED */</span>
<a name="l02096"></a>02096         ia =3*bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>;
<a name="l02097"></a>02097         ic =3*bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>;
<a name="l02098"></a>02098 <span class="preprocessor">#endif</span>
<a name="l02099"></a>02099 <span class="preprocessor"></span>    }
<a name="l02100"></a>02100     <span class="keywordflow">else</span> {
<a name="l02101"></a>02101         <span class="comment">/* TODO make this debug option */</span>
<a name="l02102"></a>02102         
<a name="l02103"></a>02103         printf(<span class="stringliteral">&quot;bodypoint &lt;bpi&gt; is not attached to spring  &lt;*bs&gt; --&gt; sb_spring_force()\n&quot;</span>);
<a name="l02104"></a>02104         <span class="keywordflow">return</span>;
<a name="l02105"></a>02105     }
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <span class="comment">/* do bp1 &lt;--&gt; bp2 elastic */</span>
<a name="l02108"></a>02108     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dir,bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,bp2-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l02109"></a>02109     distance = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dir);
<a name="l02110"></a>02110     <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a> &lt; distance)
<a name="l02111"></a>02111         iks  = 1.0f/(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a612832359b1890ea4cc58fd8fd6c9d2e">inspring</a>)-1.0f ;<span class="comment">/* inner spring constants function */</span>
<a name="l02112"></a>02112     <span class="keywordflow">else</span>
<a name="l02113"></a>02113         iks  = 1.0f/(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a57a14bd65c23078ed83859a5d0d33b3f">inpush</a>)-1.0f ;<span class="comment">/* inner spring constants function */</span>
<a name="l02114"></a>02114 
<a name="l02115"></a>02115     <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a> &gt; 0.0f) <span class="comment">/* check for degenerated springs */</span>
<a name="l02116"></a>02116         forcefactor = iks/bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>;
<a name="l02117"></a>02117     <span class="keywordflow">else</span>
<a name="l02118"></a>02118         forcefactor = iks;
<a name="l02119"></a>02119     kw = (bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#afc21a074bcc7d58b2553d79dd260a7ac">springweight</a>+bp2-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#afc21a074bcc7d58b2553d79dd260a7ac">springweight</a>)/2.0f;
<a name="l02120"></a>02120     kw = kw * kw;
<a name="l02121"></a>02121     kw = kw * kw;
<a name="l02122"></a>02122     <span class="keywordflow">switch</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>) {
<a name="l02123"></a>02123         <span class="keywordflow">case</span> <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>:
<a name="l02124"></a>02124         <span class="keywordflow">case</span> <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a8c9816ecf0483be51e19f5c4d91fae89">SB_HANDLE</a>:
<a name="l02125"></a>02125             forcefactor *=  kw;
<a name="l02126"></a>02126             <span class="keywordflow">break</span>;
<a name="l02127"></a>02127         <span class="keywordflow">case</span> <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>:
<a name="l02128"></a>02128             forcefactor *=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac79f442230e8c4cd283d0a89c7d6143c">secondspring</a>*kw;
<a name="l02129"></a>02129             <span class="keywordflow">break</span>;
<a name="l02130"></a>02130         <span class="keywordflow">case</span> <a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a2bcf6736b19c6a32ea5f7426f75286f0">SB_STIFFQUAD</a>:
<a name="l02131"></a>02131             forcefactor *=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a9fdde7ead243fec0004fc4847a3358e6">shearstiff</a>*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a9fdde7ead243fec0004fc4847a3358e6">shearstiff</a>* kw;
<a name="l02132"></a>02132             <span class="keywordflow">break</span>;
<a name="l02133"></a>02133         <span class="keywordflow">default</span>:
<a name="l02134"></a>02134             <span class="keywordflow">break</span>;
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136 
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,(bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a> - distance)*forcefactor,dir);
<a name="l02139"></a>02139 
<a name="l02140"></a>02140     <span class="comment">/* do bp1 &lt;--&gt; bp2 viscous */</span>
<a name="l02141"></a>02141     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvel,bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,bp2-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02142"></a>02142     kd = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab1f6ada4f012c3a90fdddfc0ca12c57a">infrict</a> * <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob);
<a name="l02143"></a>02143     absvel  = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dvel);
<a name="l02144"></a>02144     projvel = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir,dvel);
<a name="l02145"></a>02145     kd     *= absvel * projvel;
<a name="l02146"></a>02146     <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-kd,dir);
<a name="l02147"></a>02147 
<a name="l02148"></a>02148     <span class="comment">/* do jacobian stuff if needed */</span>
<a name="l02149"></a>02149     <span class="keywordflow">if</span> (nl_flags &amp; <a class="code" href="../../de/d32/softbody_8c.html#ad4582ccf791498af49000ca8c0fd0a48">NLF_BUILD</a>) {
<a name="l02150"></a>02150         <span class="comment">//int op =3*sb-&gt;totpoint;</span>
<a name="l02151"></a>02151         <span class="comment">//float mvel = -forcetime*kd;</span>
<a name="l02152"></a>02152         <span class="comment">//float mpos = -forcetime*forcefactor;</span>
<a name="l02153"></a>02153         <span class="comment">/* depending on my pos */</span>
<a name="l02154"></a>02154         <span class="comment">// dfdx_spring(ia,ia,op,dir,bs-&gt;len,distance,-mpos);</span>
<a name="l02155"></a>02155         <span class="comment">/* depending on my vel */</span>
<a name="l02156"></a>02156         <span class="comment">// dfdv_goal(ia,ia,mvel); // well that ignores geometie</span>
<a name="l02157"></a>02157         <span class="keywordflow">if</span> (bp2-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a> &lt; <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) { <span class="comment">/* ommit this bp when it snaps */</span>
<a name="l02158"></a>02158             <span class="comment">/* depending on other pos */</span>
<a name="l02159"></a>02159             <span class="comment">// dfdx_spring(ia,ic,op,dir,bs-&gt;len,distance,mpos);</span>
<a name="l02160"></a>02160             <span class="comment">/* depending on other vel */</span>
<a name="l02161"></a>02161             <span class="comment">// dfdv_goal(ia,ia,-mvel); // well that ignores geometie</span>
<a name="l02162"></a>02162         }
<a name="l02163"></a>02163     }
<a name="l02164"></a>02164 }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 <span class="comment">/* since this is definitely the most CPU consuming task here .. try to spread it */</span>
<a name="l02168"></a>02168 <span class="comment">/* core function _softbody_calc_forces_slice_in_a_thread */</span>
<a name="l02169"></a>02169 <span class="comment">/* result is int to be able to flag user break */</span>
<a name="l02170"></a><a class="code" href="../../de/d32/softbody_8c.html#a7e6b1266e6072c8d076ec16b71b6e6f3">02170</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a7e6b1266e6072c8d076ec16b71b6e6f3">_softbody_calc_forces_slice_in_a_thread</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> forcetime, <span class="keywordtype">float</span> timenow,<span class="keywordtype">int</span> ifirst,<span class="keywordtype">int</span> ilast,<span class="keywordtype">int</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr_to_break_func(<span class="keywordtype">void</span>)),<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector,<span class="keywordtype">int</span> do_deflector,<span class="keywordtype">float</span> fieldfactor, <span class="keywordtype">float</span> windfactor)
<a name="l02171"></a>02171 {
<a name="l02172"></a>02172     <span class="keywordtype">float</span> iks;
<a name="l02173"></a>02173     <span class="keywordtype">int</span> bb,do_selfcollision,do_springcollision,do_aero;
<a name="l02174"></a>02174     <span class="keywordtype">int</span> number_of_points_here = ilast - ifirst;
<a name="l02175"></a>02175     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l02176"></a>02176     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>  *bp;
<a name="l02177"></a>02177 
<a name="l02178"></a>02178     <span class="comment">/* intitialize */</span>
<a name="l02179"></a>02179     <span class="keywordflow">if</span> (sb) {
<a name="l02180"></a>02180     <span class="comment">/* check conditions for various options */</span>
<a name="l02181"></a>02181     <span class="comment">/* +++ could be done on object level to squeeze out the last bits of it */</span>
<a name="l02182"></a>02182     do_selfcollision=((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp; (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>)&amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a34a60fd5c27a9f91d08d73ee08e7cf6f">OB_SB_SELF</a>));
<a name="l02183"></a>02183     do_springcollision=do_deflector &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp;(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1387441f39df11260f33291584a312f8">OB_SB_EDGECOLL</a>);
<a name="l02184"></a>02184     do_aero=((sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a653a97f3e54db2412f9e67b37d662500">aeroedge</a>)&amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>));
<a name="l02185"></a>02185     <span class="comment">/* --- could be done on object level to squeeze out the last bits of it */</span>
<a name="l02186"></a>02186     }
<a name="l02187"></a>02187     <span class="keywordflow">else</span> {
<a name="l02188"></a>02188         printf(<span class="stringliteral">&quot;Error expected a SB here\n&quot;</span>);
<a name="l02189"></a>02189         <span class="keywordflow">return</span> (999);
<a name="l02190"></a>02190     }
<a name="l02191"></a>02191 
<a name="l02192"></a>02192 <span class="comment">/* debugerin */</span>
<a name="l02193"></a>02193     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a> &lt; ifirst) {
<a name="l02194"></a>02194         printf(<span class="stringliteral">&quot;Aye 998&quot;</span>);
<a name="l02195"></a>02195         <span class="keywordflow">return</span> (998);
<a name="l02196"></a>02196     }
<a name="l02197"></a>02197 <span class="comment">/* debugerin */</span>
<a name="l02198"></a>02198 
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     bp = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[ifirst];
<a name="l02201"></a>02201     <span class="keywordflow">for</span> (bb=number_of_points_here; bb&gt;0; bb--, bp++) {
<a name="l02202"></a>02202         <span class="comment">/* clear forces  accumulator */</span>
<a name="l02203"></a>02203         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]= 0.0;
<a name="l02204"></a>02204         <span class="comment">/* naive ball self collision */</span>
<a name="l02205"></a>02205         <span class="comment">/* needs to be done if goal snaps or not */</span>
<a name="l02206"></a>02206         <span class="keywordflow">if</span> (do_selfcollision) {
<a name="l02207"></a>02207             <span class="keywordtype">int</span> attached;
<a name="l02208"></a>02208             <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>   *obp;
<a name="l02209"></a>02209             <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l02210"></a>02210             <span class="keywordtype">int</span> c,b;
<a name="l02211"></a>02211             <span class="keywordtype">float</span> velcenter[3],dvel[3],def[3];
<a name="l02212"></a>02212             <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>;
<a name="l02213"></a>02213             <span class="keywordtype">float</span> <a class="code" href="../../dd/de9/mesh__navmesh_8c.html#a5ca4cf7d126d1b70e95de936dbf5079d">compare</a>;
<a name="l02214"></a>02214             <span class="keywordtype">float</span> bstune = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ad506fe70b16ff5b653cb8d9ee7ce6486">ballstiff</a>;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216             <span class="keywordflow">for</span> (c=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, obp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; c&gt;=ifirst+bb; c--, obp++) {
<a name="l02217"></a>02217                 compare = (obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>);
<a name="l02218"></a>02218                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(def, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l02219"></a>02219                 <span class="comment">/* rather check the AABBoxes before ever calulating the real distance */</span>
<a name="l02220"></a>02220                 <span class="comment">/* mathematically it is completly nuts, but performance is pretty much (3) times faster */</span>
<a name="l02221"></a>02221                 <span class="keywordflow">if</span> ((<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[0]) &gt; compare) || (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[1]) &gt; compare) || (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[2]) &gt; compare)) <span class="keywordflow">continue</span>;
<a name="l02222"></a>02222                 distance = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(def);
<a name="l02223"></a>02223                 <span class="keywordflow">if</span> (distance &lt; compare ) {
<a name="l02224"></a>02224                     <span class="comment">/* exclude body points attached with a spring */</span>
<a name="l02225"></a>02225                     attached = 0;
<a name="l02226"></a>02226                     <span class="keywordflow">for</span> (b=obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l02227"></a>02227                         bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l02228"></a>02228                         <span class="keywordflow">if</span> (( ilast-bb == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>)  || ( ilast-bb == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>)) {
<a name="l02229"></a>02229                             attached=1;
<a name="l02230"></a>02230                             <span class="keywordflow">continue</span>;}
<a name="l02231"></a>02231                     }
<a name="l02232"></a>02232                     <span class="keywordflow">if</span> (!attached) {
<a name="l02233"></a>02233                         <span class="keywordtype">float</span> f = bstune / (<a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>) + bstune / (compare * compare) * distance - 2.0f * bstune / <a class="code" href="../../dd/de9/mesh__navmesh_8c.html#a5ca4cf7d126d1b70e95de936dbf5079d">compare</a>;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(velcenter, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02236"></a>02236                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvel,velcenter,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02237"></a>02237                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvel,<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp));
<a name="l02238"></a>02238 
<a name="l02239"></a>02239                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,f*(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>),def);
<a name="l02240"></a>02240                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>,dvel);
<a name="l02241"></a>02241 
<a name="l02242"></a>02242                         <span class="comment">/* exploit force(a,b) == -force(b,a) part2/2 */</span>
<a name="l02243"></a>02243                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvel,velcenter,obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02244"></a>02244                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvel,<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp));
<a name="l02245"></a>02245 
<a name="l02246"></a>02246                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>,dvel);
<a name="l02247"></a>02247                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-f*(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>),def);
<a name="l02248"></a>02248                     }
<a name="l02249"></a>02249                 }
<a name="l02250"></a>02250             }
<a name="l02251"></a>02251         }
<a name="l02252"></a>02252         <span class="comment">/* naive ball self collision done */</span>
<a name="l02253"></a>02253 
<a name="l02254"></a>02254         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob,bp) &lt; <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) { <span class="comment">/* ommit this bp when it snaps */</span>
<a name="l02255"></a>02255             <span class="keywordtype">float</span> auxvect[3];
<a name="l02256"></a>02256             <span class="keywordtype">float</span> velgoal[3];
<a name="l02257"></a>02257 
<a name="l02258"></a>02258             <span class="comment">/* do goal stuff */</span>
<a name="l02259"></a>02259             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) {
<a name="l02260"></a>02260                 <span class="comment">/* true elastic goal */</span>
<a name="l02261"></a>02261                 <span class="keywordtype">float</span> ks,kd;
<a name="l02262"></a>02262                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(auxvect,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>);
<a name="l02263"></a>02263                 ks  = 1.0f / (1.0f - <a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob, bp) * sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac2f901181797d07793216521c4a14372">goalspring</a>) - 1.0f;
<a name="l02264"></a>02264                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]+= -ks*(auxvect[0]);
<a name="l02265"></a>02265                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]+= -ks*(auxvect[1]);
<a name="l02266"></a>02266                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]+= -ks*(auxvect[2]);
<a name="l02267"></a>02267 
<a name="l02268"></a>02268                 <span class="comment">/* calulate damping forces generated by goals*/</span>
<a name="l02269"></a>02269                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(velgoal,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>);
<a name="l02270"></a>02270                 kd =  sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a552f85542071602e7bf8b074a0f58e01">goalfrict</a> * <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob);
<a name="l02271"></a>02271                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(auxvect,velgoal,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02272"></a>02272 
<a name="l02273"></a>02273                 <span class="keywordflow">if</span> (forcetime &gt; 0.0f) { <span class="comment">/* make sure friction does not become rocket motor on time reversal */</span>
<a name="l02274"></a>02274                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= kd * (auxvect[0]);
<a name="l02275"></a>02275                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= kd * (auxvect[1]);
<a name="l02276"></a>02276                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= kd * (auxvect[2]);
<a name="l02277"></a>02277                 }
<a name="l02278"></a>02278                 <span class="keywordflow">else</span> {
<a name="l02279"></a>02279                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= kd * (velgoal[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0]);
<a name="l02280"></a>02280                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= kd * (velgoal[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1]);
<a name="l02281"></a>02281                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= kd * (velgoal[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2]);
<a name="l02282"></a>02282                 }
<a name="l02283"></a>02283             }
<a name="l02284"></a>02284             <span class="comment">/* done goal stuff */</span>
<a name="l02285"></a>02285 
<a name="l02286"></a>02286             <span class="comment">/* gravitation */</span>
<a name="l02287"></a>02287             <span class="keywordflow">if</span> (sb &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#ae4c1524b30f9e72a87543f428be1549c">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a508bb80abc11d94db2661ef7f6d0cc00">PHYS_GLOBAL_GRAVITY</a>) {
<a name="l02288"></a>02288                 <span class="keywordtype">float</span> gravity[3];
<a name="l02289"></a>02289                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gravity, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>);
<a name="l02290"></a>02290                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(gravity, <a class="code" href="../../de/d32/softbody_8c.html#a5b7790b417ca324d8a35b24ebcb5dcd2">sb_grav_force_scale</a>(ob)*<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp)*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>-&gt;<a class="code" href="../../db/d19/structEffectorWeights.html#af1e527b00a665e3ac926d0aa7c54b9d0">global_gravity</a>); <span class="comment">/* individual mass of node here */</span>
<a name="l02291"></a>02291                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, gravity);
<a name="l02292"></a>02292             }
<a name="l02293"></a>02293 
<a name="l02294"></a>02294             <span class="comment">/* particle field &amp; vortex */</span>
<a name="l02295"></a>02295             <span class="keywordflow">if</span> (do_effector) {
<a name="l02296"></a>02296                 <a class="code" href="../../db/d29/structEffectedPoint.html">EffectedPoint</a> epoint;
<a name="l02297"></a>02297                 <span class="keywordtype">float</span> kd;
<a name="l02298"></a>02298                 <span class="keywordtype">float</span> force[3]= {0.0f, 0.0f, 0.0f};
<a name="l02299"></a>02299                 <span class="keywordtype">float</span> speed[3]= {0.0f, 0.0f, 0.0f};
<a name="l02300"></a>02300                 <span class="keywordtype">float</span> eval_sb_fric_force_scale = <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob); <span class="comment">/* just for calling function once */</span>
<a name="l02301"></a>02301                 <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7ed88ae8138e32a6549a8ce984275137">pd_point_from_soft</a>(scene, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>-bp, &amp;epoint);
<a name="l02302"></a>02302                 <a class="code" href="../../dc/d65/BKE__effect_8h.html#a4099ac2ecd7e48764e8e741bf2aade72">pdDoEffectors</a>(do_effector, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>, &amp;epoint, force, speed);
<a name="l02303"></a>02303 
<a name="l02304"></a>02304                 <span class="comment">/* apply forcefield*/</span>
<a name="l02305"></a>02305                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(force,fieldfactor* eval_sb_fric_force_scale);
<a name="l02306"></a>02306                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, force);
<a name="l02307"></a>02307 
<a name="l02308"></a>02308                 <span class="comment">/* BP friction in moving media */</span>
<a name="l02309"></a>02309                 kd= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ae1c8eb710553fda9e0d8b72b998d39b8">mediafrict</a>* eval_sb_fric_force_scale;
<a name="l02310"></a>02310                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0] + windfactor*speed[0]/eval_sb_fric_force_scale);
<a name="l02311"></a>02311                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1] + windfactor*speed[1]/eval_sb_fric_force_scale);
<a name="l02312"></a>02312                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2] + windfactor*speed[2]/eval_sb_fric_force_scale);
<a name="l02313"></a>02313                 <span class="comment">/* now we&#39;ll have nice centrifugal effect for vortex */</span>
<a name="l02314"></a>02314 
<a name="l02315"></a>02315             }
<a name="l02316"></a>02316             <span class="keywordflow">else</span> {
<a name="l02317"></a>02317                 <span class="comment">/* BP friction in media (not) moving*/</span>
<a name="l02318"></a>02318                 <span class="keywordtype">float</span> kd = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ae1c8eb710553fda9e0d8b72b998d39b8">mediafrict</a>* <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob);
<a name="l02319"></a>02319                 <span class="comment">/* assume it to be proportional to actual velocity */</span>
<a name="l02320"></a>02320                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0]*kd;
<a name="l02321"></a>02321                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1]*kd;
<a name="l02322"></a>02322                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2]*kd;
<a name="l02323"></a>02323                 <span class="comment">/* friction in media done */</span>
<a name="l02324"></a>02324             }
<a name="l02325"></a>02325             <span class="comment">/* +++cached collision targets */</span>
<a name="l02326"></a>02326             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = 0.0f;
<a name="l02327"></a>02327             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a> = 0.0f;
<a name="l02328"></a>02328             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02329"></a>02329             <span class="keywordflow">if</span> (do_deflector &amp;&amp; !(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#a19a9fdce0834aa221dc2323dde0cdef2">SBF_OUTOFCOLLISION</a>) ) {
<a name="l02330"></a>02330                 <span class="keywordtype">float</span> cfforce[3],defforce[3] ={0.0f,0.0f,0.0f}, vel[3] = {0.0f,0.0f,0.0f}, facenormal[3], cf = 1.0f,intrusion;
<a name="l02331"></a>02331                 <span class="keywordtype">float</span> kd = 1.0f;
<a name="l02332"></a>02332 
<a name="l02333"></a>02333                 <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a1f4b1fcc3571b047d1ca2c1067325faa">sb_deflect_face</a>(ob,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,facenormal,defforce,&amp;cf,timenow,vel,&amp;intrusion)) {
<a name="l02334"></a>02334                         <span class="keywordflow">if</span> (intrusion &lt; 0.0f) {
<a name="l02335"></a>02335                             sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02336"></a>02336                             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02337"></a>02337                             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab8b0036c0478a99fa960a3f8b0a579ce">choke</a>*0.01f;
<a name="l02338"></a>02338                         }
<a name="l02339"></a>02339 
<a name="l02340"></a>02340                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(cfforce,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,vel);
<a name="l02341"></a>02341                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-cf*50.0f,cfforce);
<a name="l02342"></a>02342 
<a name="l02343"></a>02343                     <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,kd,defforce);
<a name="l02344"></a>02344                 }
<a name="l02345"></a>02345 
<a name="l02346"></a>02346             }
<a name="l02347"></a>02347             <span class="comment">/* ---cached collision targets */</span>
<a name="l02348"></a>02348 
<a name="l02349"></a>02349             <span class="comment">/* +++springs */</span>
<a name="l02350"></a>02350             iks  = 1.0f/(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a612832359b1890ea4cc58fd8fd6c9d2e">inspring</a>)-1.0f ;<span class="comment">/* inner spring constants function */</span>
<a name="l02351"></a>02351             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l02352"></a>02352                 <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>) { <span class="comment">/* spring list exists at all ? */</span>
<a name="l02353"></a>02353                     <span class="keywordtype">int</span> b;
<a name="l02354"></a>02354                     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l02355"></a>02355                     <span class="keywordflow">for</span> (b=bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l02356"></a>02356                         bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l02357"></a>02357                         <span class="keywordflow">if</span> (do_springcollision || do_aero) {
<a name="l02358"></a>02358                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>);
<a name="l02359"></a>02359                             <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#ad2d659487f12252dbd9dae8a17f114b4">BSF_INTERSECT</a>)
<a name="l02360"></a>02360                                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a6e00cc327e19fb753f11295d576c744f">cf</a>;
<a name="l02361"></a>02361 
<a name="l02362"></a>02362                         }
<a name="l02363"></a>02363                         <span class="comment">// sb_spring_force(Object *ob,int bpi,BodySpring *bs,float iks,float forcetime,int nl_flags)</span>
<a name="l02364"></a>02364                         <a class="code" href="../../de/d32/softbody_8c.html#af2bc841c7dbd64a2af2ad0b9cd6eefb5">sb_spring_force</a>(ob,ilast-bb,bs,iks,forcetime,0);
<a name="l02365"></a>02365                     }<span class="comment">/* loop springs */</span>
<a name="l02366"></a>02366                 }<span class="comment">/* existing spring list */</span>
<a name="l02367"></a>02367             }<span class="comment">/*any edges*/</span>
<a name="l02368"></a>02368             <span class="comment">/* ---springs */</span>
<a name="l02369"></a>02369         }<span class="comment">/*omit on snap */</span>
<a name="l02370"></a>02370     }<span class="comment">/*loop all bp&#39;s*/</span>
<a name="l02371"></a>02371     <span class="keywordflow">return</span> 0; <span class="comment">/*done fine*/</span>
<a name="l02372"></a>02372 }
<a name="l02373"></a>02373 
<a name="l02374"></a><a class="code" href="../../de/d32/softbody_8c.html#ad20377b72e9512c57a7caa9ff6bc8971">02374</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/d32/softbody_8c.html#ad20377b72e9512c57a7caa9ff6bc8971">exec_softbody_calc_forces</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l02375"></a>02375 {
<a name="l02376"></a>02376     <a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a> *pctx = (<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>*)data;
<a name="l02377"></a>02377     <a class="code" href="../../de/d32/softbody_8c.html#a7e6b1266e6072c8d076ec16b71b6e6f3">_softbody_calc_forces_slice_in_a_thread</a>(pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">scene</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">ob</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a17a1d6b3ef4b50bb3174157a1933a3cd">forcetime</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">timenow</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">ilast</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">do_effector</a>,pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a62cb58e1b1d56c21261e8fa27e7c9562">do_deflector</a>,pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a2d8cd1147a0f93844a3fc5593e13cbb2">fieldfactor</a>,pctx-&gt;<a class="code" href="../../d2/d85/structSB__thread__context.html#a905f534b5a15deaeff3ab60110d81de3">windfactor</a>);
<a name="l02378"></a>02378     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02379"></a>02379 }
<a name="l02380"></a>02380 
<a name="l02381"></a><a class="code" href="../../de/d32/softbody_8c.html#a06138d8e80be65667518be7489a684b0">02381</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a06138d8e80be65667518be7489a684b0">sb_cf_threads_run</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> forcetime, <span class="keywordtype">float</span> timenow,<span class="keywordtype">int</span> totpoint,<span class="keywordtype">int</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr_to_break_func(<span class="keywordtype">void</span>)),<span class="keyword">struct</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector,<span class="keywordtype">int</span> do_deflector,<span class="keywordtype">float</span> fieldfactor, <span class="keywordtype">float</span> windfactor)
<a name="l02382"></a>02382 {
<a name="l02383"></a>02383     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l02384"></a>02384     <a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a> *sb_threads;
<a name="l02385"></a>02385     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totthread,<a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>,dec;
<a name="l02386"></a>02386     <span class="keywordtype">int</span> lowpoints =100; <span class="comment">/* wild guess .. may increase with better thread management &#39;above&#39; or even be UI option sb-&gt;spawn_cf_threads_nopts */</span>
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="comment">/* figure the number of threads while preventing pretty pointless threading overhead */</span>
<a name="l02389"></a>02389     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a821a3940a952444838528ee450075408">R_FIXED_THREADS</a>)
<a name="l02390"></a>02390         totthread= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>;
<a name="l02391"></a>02391     <span class="keywordflow">else</span>
<a name="l02392"></a>02392         totthread= <a class="code" href="../../df/dbb/BLI__threads_8h.html#a7c7ea80a0fb6cafac205997f51079745">BLI_system_thread_count</a>();
<a name="l02393"></a>02393     <span class="comment">/* what if we got zillions of CPUs running but less to spread*/</span>
<a name="l02394"></a>02394     <span class="keywordflow">while</span> ((totpoint/totthread &lt; lowpoints) &amp;&amp; (totthread &gt; 1)) {
<a name="l02395"></a>02395         totthread--;
<a name="l02396"></a>02396     }
<a name="l02397"></a>02397 
<a name="l02398"></a>02398     <span class="comment">/* printf(&quot;sb_cf_threads_run spawning %d threads\n&quot;,totthread); */</span>
<a name="l02399"></a>02399 
<a name="l02400"></a>02400     sb_threads= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>)*totthread, <span class="stringliteral">&quot;SBThread&quot;</span>);
<a name="l02401"></a>02401     memset(sb_threads, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d85/structSB__thread__context.html">SB_thread_context</a>)*totthread);
<a name="l02402"></a>02402     left = totpoint;
<a name="l02403"></a>02403     dec = totpoint/totthread +1;
<a name="l02404"></a>02404     <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++) {
<a name="l02405"></a>02405         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a9783c0afb03ca192be0287feaa6cbba8">scene</a> = scene;
<a name="l02406"></a>02406         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a91d1e4a2ee846d3c531f98ab9d32b7ef">ob</a> = ob;
<a name="l02407"></a>02407         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a17a1d6b3ef4b50bb3174157a1933a3cd">forcetime</a> = forcetime;
<a name="l02408"></a>02408         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#aa5d05db4f46c55669280faa3e2bf19a1">timenow</a> = timenow;
<a name="l02409"></a>02409         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a7a1ee86efc66f91504f0ad3fe1bcd3b5">ilast</a>   = <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l02410"></a>02410         left = left - dec;
<a name="l02411"></a>02411         <span class="keywordflow">if</span> (left &gt;0) {
<a name="l02412"></a>02412             sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>  = <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l02413"></a>02413         }
<a name="l02414"></a>02414         <span class="keywordflow">else</span>
<a name="l02415"></a>02415             sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a715614dfde62274517bd570cd38c961d">ifirst</a>  = 0;
<a name="l02416"></a>02416         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a533f54de2ca4aed2d984bcc89a119e2b">do_effector</a> = do_effector;
<a name="l02417"></a>02417         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a62cb58e1b1d56c21261e8fa27e7c9562">do_deflector</a> = do_deflector;
<a name="l02418"></a>02418         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a2d8cd1147a0f93844a3fc5593e13cbb2">fieldfactor</a> = fieldfactor;
<a name="l02419"></a>02419         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a905f534b5a15deaeff3ab60110d81de3">windfactor</a>  = windfactor;
<a name="l02420"></a>02420         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a9a65848ac770a3f7c26abbb8291811a4">nr</a>= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02421"></a>02421         sb_threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/d85/structSB__thread__context.html#a269a397d04b7b6497fe5338dd14634b3">tot</a>= totthread;
<a name="l02422"></a>02422     }
<a name="l02423"></a>02423 
<a name="l02424"></a>02424 
<a name="l02425"></a>02425     <span class="keywordflow">if</span> (totthread &gt; 1) {
<a name="l02426"></a>02426         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../de/d32/softbody_8c.html#ad20377b72e9512c57a7caa9ff6bc8971">exec_softbody_calc_forces</a>, totthread);
<a name="l02427"></a>02427 
<a name="l02428"></a>02428         <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++)
<a name="l02429"></a>02429             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;sb_threads[i]);
<a name="l02430"></a>02430 
<a name="l02431"></a>02431         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l02432"></a>02432     }
<a name="l02433"></a>02433     <span class="keywordflow">else</span>
<a name="l02434"></a>02434         <a class="code" href="../../de/d32/softbody_8c.html#ad20377b72e9512c57a7caa9ff6bc8971">exec_softbody_calc_forces</a>(&amp;sb_threads[0]);
<a name="l02435"></a>02435     <span class="comment">/* clean up */</span>
<a name="l02436"></a>02436     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb_threads);
<a name="l02437"></a>02437 }
<a name="l02438"></a>02438 
<a name="l02439"></a><a class="code" href="../../de/d32/softbody_8c.html#a0a14edd28ab8bf909116eb31dc85ac61">02439</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a0a14edd28ab8bf909116eb31dc85ac61">softbody_calc_forcesEx</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> forcetime, <span class="keywordtype">float</span> timenow, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(nl_flags))
<a name="l02440"></a>02440 {
<a name="l02441"></a>02441 <span class="comment">/* rule we never alter free variables :bp-&gt;vec bp-&gt;pos in here !</span>
<a name="l02442"></a>02442 <span class="comment"> * this will ruin adaptive stepsize AKA heun! (BM)</span>
<a name="l02443"></a>02443 <span class="comment"> */</span>
<a name="l02444"></a>02444     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l02445"></a>02445     <span class="comment">/*BodyPoint *bproot;*/</span> <span class="comment">/* UNUSED */</span>
<a name="l02446"></a>02446     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02447"></a>02447     <span class="comment">/* float gravity; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02448"></a>02448     <span class="comment">/* float iks; */</span>
<a name="l02449"></a>02449     <span class="keywordtype">float</span> fieldfactor = -1.0f, windfactor  = 0.25;
<a name="l02450"></a>02450     <span class="keywordtype">int</span>   do_deflector <span class="comment">/*,do_selfcollision*/</span> ,do_springcollision,do_aero;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     <span class="comment">/* gravity = sb-&gt;grav * sb_grav_force_scale(ob); */</span> <span class="comment">/* UNUSED */</span>
<a name="l02453"></a>02453 
<a name="l02454"></a>02454     <span class="comment">/* check conditions for various options */</span>
<a name="l02455"></a>02455     do_deflector= <a class="code" href="../../de/d32/softbody_8c.html#a7739955b3f3596cdbc889c13ffb686f2">query_external_colliders</a>(scene, ob);
<a name="l02456"></a>02456     <span class="comment">/* do_selfcollision=((ob-&gt;softflag &amp; OB_SB_EDGES) &amp;&amp; (sb-&gt;bspring)&amp;&amp; (ob-&gt;softflag &amp; OB_SB_SELF)); */</span> <span class="comment">/* UNUSED */</span>
<a name="l02457"></a>02457     do_springcollision=do_deflector &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp;(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1387441f39df11260f33291584a312f8">OB_SB_EDGECOLL</a>);
<a name="l02458"></a>02458     do_aero=((sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a653a97f3e54db2412f9e67b37d662500">aeroedge</a>)&amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>));
<a name="l02459"></a>02459 
<a name="l02460"></a>02460     <span class="comment">/* iks  = 1.0f/(1.0f-sb-&gt;inspring)-1.0f; */</span> <span class="comment">/* inner spring constants function */</span> <span class="comment">/* UNUSED */</span>
<a name="l02461"></a>02461     <span class="comment">/* bproot= sb-&gt;bpoint; */</span> <span class="comment">/* need this for proper spring addressing */</span> <span class="comment">/* UNUSED */</span>
<a name="l02462"></a>02462 
<a name="l02463"></a>02463     <span class="keywordflow">if</span> (do_springcollision || do_aero)
<a name="l02464"></a>02464     <a class="code" href="../../de/d32/softbody_8c.html#a442de4cf51c3c7aa59845d578b2ee76b">sb_sfesf_threads_run</a>(scene, ob, timenow,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <span class="comment">/* after spring scan because it uses Effoctors too */</span>
<a name="l02467"></a>02467     do_effector= <a class="code" href="../../dc/d65/BKE__effect_8h.html#a6ebcd51628cbb20d3556d779e0b506fe">pdInitEffectors</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>);
<a name="l02468"></a>02468 
<a name="l02469"></a>02469     <span class="keywordflow">if</span> (do_deflector) {
<a name="l02470"></a>02470         <span class="keywordtype">float</span> defforce[3];
<a name="l02471"></a>02471         do_deflector = <a class="code" href="../../de/d32/softbody_8c.html#a9d3730e34c845944c63c5ddca08c2d30">sb_detect_aabb_collisionCached</a>(defforce,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>,ob,timenow);
<a name="l02472"></a>02472     }
<a name="l02473"></a>02473 
<a name="l02474"></a>02474     <a class="code" href="../../de/d32/softbody_8c.html#a06138d8e80be65667518be7489a684b0">sb_cf_threads_run</a>(scene, ob, forcetime, timenow, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, do_effector, do_deflector, fieldfactor, windfactor);
<a name="l02475"></a>02475 
<a name="l02476"></a>02476     <span class="comment">/* finally add forces caused by face collision */</span>
<a name="l02477"></a>02477     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a133f582250dd8a392e24954871920cf2">OB_SB_FACECOLL</a>) <a class="code" href="../../de/d32/softbody_8c.html#af52ae9b7ac75ad64586b0b06d7f8e342">scan_for_ext_face_forces</a>(ob,timenow);
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     <span class="comment">/* finish matrix and solve */</span>
<a name="l02480"></a>02480     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7da5e7ad353e025440f05a9adbd7032d">pdEndEffectors</a>(&amp;do_effector);
<a name="l02481"></a>02481 }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483 
<a name="l02484"></a>02484 
<a name="l02485"></a>02485 
<a name="l02486"></a><a class="code" href="../../de/d32/softbody_8c.html#a4661f7e1d676a6b8bbffd7246c2389d1">02486</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a4661f7e1d676a6b8bbffd7246c2389d1">softbody_calc_forces</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> forcetime, <span class="keywordtype">float</span> timenow, <span class="keywordtype">int</span> nl_flags)
<a name="l02487"></a>02487 {
<a name="l02488"></a>02488     <span class="comment">/* redirection to the new threaded Version */</span>
<a name="l02489"></a>02489     <span class="keywordflow">if</span> (!(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rt &amp; 0x10)) { <span class="comment">// 16</span>
<a name="l02490"></a>02490         <a class="code" href="../../de/d32/softbody_8c.html#a0a14edd28ab8bf909116eb31dc85ac61">softbody_calc_forcesEx</a>(scene, ob, forcetime, timenow, nl_flags);
<a name="l02491"></a>02491         <span class="keywordflow">return</span>;
<a name="l02492"></a>02492     }
<a name="l02493"></a>02493     <span class="keywordflow">else</span> {
<a name="l02494"></a>02494         <span class="comment">/* so the following will die  */</span>
<a name="l02495"></a>02495         <span class="comment">/* |||||||||||||||||||||||||| */</span>
<a name="l02496"></a>02496         <span class="comment">/* VVVVVVVVVVVVVVVVVVVVVVVVVV */</span>
<a name="l02497"></a>02497         <span class="comment">/*backward compatibility note:</span>
<a name="l02498"></a>02498 <span class="comment">        fixing bug [17428] which forces adaptive step size to tiny steps</span>
<a name="l02499"></a>02499 <span class="comment">        in some situations</span>
<a name="l02500"></a>02500 <span class="comment">        .. keeping G.rt==17 0x11 option for old files &#39;needing&#39; the bug*/</span>
<a name="l02501"></a>02501 
<a name="l02502"></a>02502         <span class="comment">/* rule we never alter free variables :bp-&gt;vec bp-&gt;pos in here !</span>
<a name="l02503"></a>02503 <span class="comment">        * this will ruin adaptive stepsize AKA heun! (BM)</span>
<a name="l02504"></a>02504 <span class="comment">        */</span>
<a name="l02505"></a>02505         <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l02506"></a>02506         <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>  *bp;
<a name="l02507"></a>02507         <span class="comment">/* BodyPoint *bproot; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02508"></a>02508         <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l02509"></a>02509         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *do_effector = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02510"></a>02510         <span class="keywordtype">float</span> iks, ks, kd, gravity[3] = {0.0f,0.0f,0.0f};
<a name="l02511"></a>02511         <span class="keywordtype">float</span> fieldfactor = -1.0f, windfactor  = 0.25f;
<a name="l02512"></a>02512         <span class="keywordtype">float</span> tune = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ad506fe70b16ff5b653cb8d9ee7ce6486">ballstiff</a>;
<a name="l02513"></a>02513         <span class="keywordtype">int</span> a, b,  do_deflector,do_selfcollision,do_springcollision,do_aero;
<a name="l02514"></a>02514 
<a name="l02515"></a>02515 
<a name="l02516"></a>02516         <span class="comment">/* jacobian</span>
<a name="l02517"></a>02517 <span class="comment">        NLboolean success;</span>
<a name="l02518"></a>02518 <span class="comment"></span>
<a name="l02519"></a>02519 <span class="comment">        if (nl_flags) {</span>
<a name="l02520"></a>02520 <span class="comment">        nlBegin(NL_SYSTEM);</span>
<a name="l02521"></a>02521 <span class="comment">        nlBegin(NL_MATRIX);</span>
<a name="l02522"></a>02522 <span class="comment">        }</span>
<a name="l02523"></a>02523 <span class="comment">        */</span>
<a name="l02524"></a>02524 
<a name="l02525"></a>02525 
<a name="l02526"></a>02526         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#ae4c1524b30f9e72a87543f428be1549c">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a508bb80abc11d94db2661ef7f6d0cc00">PHYS_GLOBAL_GRAVITY</a>) {
<a name="l02527"></a>02527             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gravity, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>);
<a name="l02528"></a>02528             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(gravity, <a class="code" href="../../de/d32/softbody_8c.html#a5b7790b417ca324d8a35b24ebcb5dcd2">sb_grav_force_scale</a>(ob)*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>-&gt;<a class="code" href="../../db/d19/structEffectorWeights.html#af1e527b00a665e3ac926d0aa7c54b9d0">global_gravity</a>);
<a name="l02529"></a>02529         }
<a name="l02530"></a>02530 
<a name="l02531"></a>02531         <span class="comment">/* check conditions for various options */</span>
<a name="l02532"></a>02532         do_deflector= <a class="code" href="../../de/d32/softbody_8c.html#a7739955b3f3596cdbc889c13ffb686f2">query_external_colliders</a>(scene, ob);
<a name="l02533"></a>02533         do_selfcollision=((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp; (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>)&amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a34a60fd5c27a9f91d08d73ee08e7cf6f">OB_SB_SELF</a>));
<a name="l02534"></a>02534         do_springcollision=do_deflector &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp;(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1387441f39df11260f33291584a312f8">OB_SB_EDGECOLL</a>);
<a name="l02535"></a>02535         do_aero=((sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a653a97f3e54db2412f9e67b37d662500">aeroedge</a>)&amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>));
<a name="l02536"></a>02536 
<a name="l02537"></a>02537         iks  = 1.0f/(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a612832359b1890ea4cc58fd8fd6c9d2e">inspring</a>)-1.0f ;<span class="comment">/* inner spring constants function */</span>
<a name="l02538"></a>02538         <span class="comment">/* bproot= sb-&gt;bpoint; */</span> <span class="comment">/* need this for proper spring addressing */</span> <span class="comment">/* UNUSED */</span>
<a name="l02539"></a>02539 
<a name="l02540"></a>02540         <span class="keywordflow">if</span> (do_springcollision || do_aero)  <a class="code" href="../../de/d32/softbody_8c.html#a5e1eae6e502972702212e3bc87dd3dc0">scan_for_ext_spring_forces</a>(scene, ob, timenow);
<a name="l02541"></a>02541         <span class="comment">/* after spring scan because it uses Effoctors too */</span>
<a name="l02542"></a>02542         do_effector= <a class="code" href="../../dc/d65/BKE__effect_8h.html#a6ebcd51628cbb20d3556d779e0b506fe">pdInitEffectors</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>);
<a name="l02543"></a>02543 
<a name="l02544"></a>02544         <span class="keywordflow">if</span> (do_deflector) {
<a name="l02545"></a>02545             <span class="keywordtype">float</span> defforce[3];
<a name="l02546"></a>02546             do_deflector = <a class="code" href="../../de/d32/softbody_8c.html#a9d3730e34c845944c63c5ddca08c2d30">sb_detect_aabb_collisionCached</a>(defforce,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>,ob,timenow);
<a name="l02547"></a>02547         }
<a name="l02548"></a>02548 
<a name="l02549"></a>02549         <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02550"></a>02550             <span class="comment">/* clear forces  accumulator */</span>
<a name="l02551"></a>02551             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]= 0.0;
<a name="l02552"></a>02552             <span class="keywordflow">if</span> (nl_flags &amp; <a class="code" href="../../de/d32/softbody_8c.html#ad4582ccf791498af49000ca8c0fd0a48">NLF_BUILD</a>) {
<a name="l02553"></a>02553                 <span class="comment">//int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02554"></a>02554                 <span class="comment">//int op =3*sb-&gt;totpoint;</span>
<a name="l02555"></a>02555                 <span class="comment">/* dF/dV = v */</span>
<a name="l02556"></a>02556                 <span class="comment">/* jacobioan</span>
<a name="l02557"></a>02557 <span class="comment">                nlMatrixAdd(op+ia,ia,-forcetime);</span>
<a name="l02558"></a>02558 <span class="comment">                nlMatrixAdd(op+ia+1,ia+1,-forcetime);</span>
<a name="l02559"></a>02559 <span class="comment">                nlMatrixAdd(op+ia+2,ia+2,-forcetime);</span>
<a name="l02560"></a>02560 <span class="comment"></span>
<a name="l02561"></a>02561 <span class="comment">                nlMatrixAdd(ia,ia,1);</span>
<a name="l02562"></a>02562 <span class="comment">                nlMatrixAdd(ia+1,ia+1,1);</span>
<a name="l02563"></a>02563 <span class="comment">                nlMatrixAdd(ia+2,ia+2,1);</span>
<a name="l02564"></a>02564 <span class="comment"></span>
<a name="l02565"></a>02565 <span class="comment">                nlMatrixAdd(op+ia,op+ia,1);</span>
<a name="l02566"></a>02566 <span class="comment">                nlMatrixAdd(op+ia+1,op+ia+1,1);</span>
<a name="l02567"></a>02567 <span class="comment">                nlMatrixAdd(op+ia+2,op+ia+2,1);</span>
<a name="l02568"></a>02568 <span class="comment">                */</span>
<a name="l02569"></a>02569 
<a name="l02570"></a>02570 
<a name="l02571"></a>02571             }
<a name="l02572"></a>02572 
<a name="l02573"></a>02573             <span class="comment">/* naive ball self collision */</span>
<a name="l02574"></a>02574             <span class="comment">/* needs to be done if goal snaps or not */</span>
<a name="l02575"></a>02575             <span class="keywordflow">if</span> (do_selfcollision) {
<a name="l02576"></a>02576                 <span class="keywordtype">int</span> attached;
<a name="l02577"></a>02577                 <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>   *obp;
<a name="l02578"></a>02578                 <span class="keywordtype">int</span> c,b;
<a name="l02579"></a>02579                 <span class="keywordtype">float</span> velcenter[3],dvel[3],def[3];
<a name="l02580"></a>02580                 <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>;
<a name="l02581"></a>02581                 <span class="keywordtype">float</span> <a class="code" href="../../dd/de9/mesh__navmesh_8c.html#a5ca4cf7d126d1b70e95de936dbf5079d">compare</a>;
<a name="l02582"></a>02582 
<a name="l02583"></a>02583                 <span class="keywordflow">for</span> (c=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, obp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; c&gt;=a; c--, obp++) {
<a name="l02584"></a>02584 
<a name="l02585"></a>02585                     <span class="comment">//if ((bp-&gt;octantflag &amp; obp-&gt;octantflag) == 0) continue;</span>
<a name="l02586"></a>02586 
<a name="l02587"></a>02587                     compare = (obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a836b36a20c7d2f9450c857b47c755511">colball</a>);
<a name="l02588"></a>02588                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(def, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590                     <span class="comment">/* rather check the AABBoxes before ever calulating the real distance */</span>
<a name="l02591"></a>02591                     <span class="comment">/* mathematically it is completly nuts, but performance is pretty much (3) times faster */</span>
<a name="l02592"></a>02592                     <span class="keywordflow">if</span> ((<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[0]) &gt; compare) || (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[1]) &gt; compare) || (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(def[2]) &gt; compare)) <span class="keywordflow">continue</span>;
<a name="l02593"></a>02593 
<a name="l02594"></a>02594                     distance = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(def);
<a name="l02595"></a>02595                     <span class="keywordflow">if</span> (distance &lt; compare ) {
<a name="l02596"></a>02596                         <span class="comment">/* exclude body points attached with a spring */</span>
<a name="l02597"></a>02597                         attached = 0;
<a name="l02598"></a>02598                         <span class="keywordflow">for</span> (b=obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l02599"></a>02599                             bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l02600"></a>02600                             <span class="keywordflow">if</span> (( sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>)  || ( sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a == bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>)) {
<a name="l02601"></a>02601                                 attached=1;
<a name="l02602"></a>02602                                 <span class="keywordflow">continue</span>;}
<a name="l02603"></a>02603                         }
<a name="l02604"></a>02604                         <span class="keywordflow">if</span> (!attached) {
<a name="l02605"></a>02605                             <span class="keywordtype">float</span> f = tune / (<a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>) + tune / (compare * compare) * distance - 2.0f * tune/<a class="code" href="../../dd/de9/mesh__navmesh_8c.html#a5ca4cf7d126d1b70e95de936dbf5079d">compare</a>;
<a name="l02606"></a>02606 
<a name="l02607"></a>02607                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(velcenter, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02608"></a>02608                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvel,velcenter,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02609"></a>02609                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvel,<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp));
<a name="l02610"></a>02610 
<a name="l02611"></a>02611                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,f*(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>),def);
<a name="l02612"></a>02612                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>,dvel);
<a name="l02613"></a>02613 
<a name="l02614"></a>02614                             <span class="keywordflow">if</span> (nl_flags &amp; NLF_BUILD) {
<a name="l02615"></a>02615                                 <span class="comment">//int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02616"></a>02616                                 <span class="comment">//int ic =3*(sb-&gt;totpoint-c);</span>
<a name="l02617"></a>02617                                 <span class="comment">//int op =3*sb-&gt;totpoint;</span>
<a name="l02618"></a>02618                                 <span class="comment">//float mvel = forcetime*sb-&gt;nodemass*sb-&gt;balldamp;</span>
<a name="l02619"></a>02619                                 <span class="comment">//float mpos = forcetime*tune*(1.0f-sb-&gt;balldamp);</span>
<a name="l02620"></a>02620                                 <span class="comment">/*some quick and dirty entries to the jacobian*/</span>
<a name="l02621"></a>02621                                 <span class="comment">//dfdx_goal(ia,ia,op,mpos);</span>
<a name="l02622"></a>02622                                 <span class="comment">//dfdv_goal(ia,ia,mvel);</span>
<a name="l02623"></a>02623                                 <span class="comment">/* exploit force(a,b) == -force(b,a) part1/2 */</span>
<a name="l02624"></a>02624                                 <span class="comment">//dfdx_goal(ic,ic,op,mpos);</span>
<a name="l02625"></a>02625                                 <span class="comment">//dfdv_goal(ic,ic,mvel);</span>
<a name="l02626"></a>02626 
<a name="l02627"></a>02627 
<a name="l02628"></a>02628                                 <span class="comment">/*TODO sit down an X-out the true jacobian entries*/</span>
<a name="l02629"></a>02629                                 <span class="comment">/*well does not make to much sense because the eigenvalues</span>
<a name="l02630"></a>02630 <span class="comment">                                of the jacobian go negative; and negative eigenvalues</span>
<a name="l02631"></a>02631 <span class="comment">                                on a complex iterative system z(n+1)=A * z(n)</span>
<a name="l02632"></a>02632 <span class="comment">                                give imaginary roots in the charcateristic polynom</span>
<a name="l02633"></a>02633 <span class="comment">                                --&gt; solutions that to z(t)=u(t)* exp ( i omega t) --&gt; oscilations we don&#39;t want here</span>
<a name="l02634"></a>02634 <span class="comment">                                where u(t) is a unknown amplitude function (worst case rising fast)</span>
<a name="l02635"></a>02635 <span class="comment">                                */</span>
<a name="l02636"></a>02636                             }
<a name="l02637"></a>02637 
<a name="l02638"></a>02638                             <span class="comment">/* exploit force(a,b) == -force(b,a) part2/2 */</span>
<a name="l02639"></a>02639                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvel,velcenter,obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02640"></a>02640                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvel,(<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp)+<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,obp))/2.0f);
<a name="l02641"></a>02641 
<a name="l02642"></a>02642                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>,dvel);
<a name="l02643"></a>02643                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(obp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-f*(1.0f-sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a>),def);
<a name="l02644"></a>02644 
<a name="l02645"></a>02645 
<a name="l02646"></a>02646                         }
<a name="l02647"></a>02647                     }
<a name="l02648"></a>02648                 }
<a name="l02649"></a>02649             }
<a name="l02650"></a>02650             <span class="comment">/* naive ball self collision done */</span>
<a name="l02651"></a>02651 
<a name="l02652"></a>02652             <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob,bp) &lt; <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) { <span class="comment">/* ommit this bp when it snaps */</span>
<a name="l02653"></a>02653                 <span class="keywordtype">float</span> auxvect[3];
<a name="l02654"></a>02654                 <span class="keywordtype">float</span> velgoal[3];
<a name="l02655"></a>02655 
<a name="l02656"></a>02656                 <span class="comment">/* do goal stuff */</span>
<a name="l02657"></a>02657                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) {
<a name="l02658"></a>02658                     <span class="comment">/* true elastic goal */</span>
<a name="l02659"></a>02659                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(auxvect,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>);
<a name="l02660"></a>02660                     ks  = 1.0f / (1.0f- <a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob, bp) * sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac2f901181797d07793216521c4a14372">goalspring</a>) - 1.0f;
<a name="l02661"></a>02661                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]+= -ks*(auxvect[0]);
<a name="l02662"></a>02662                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]+= -ks*(auxvect[1]);
<a name="l02663"></a>02663                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]+= -ks*(auxvect[2]);
<a name="l02664"></a>02664 
<a name="l02665"></a>02665                     <span class="keywordflow">if</span> (nl_flags &amp; NLF_BUILD) {
<a name="l02666"></a>02666                         <span class="comment">//int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02667"></a>02667                         <span class="comment">//int op =3*(sb-&gt;totpoint);</span>
<a name="l02668"></a>02668                         <span class="comment">/* depending on my pos */</span>
<a name="l02669"></a>02669                         <span class="comment">//dfdx_goal(ia,ia,op,ks*forcetime);</span>
<a name="l02670"></a>02670                     }
<a name="l02671"></a>02671 
<a name="l02672"></a>02672 
<a name="l02673"></a>02673                     <span class="comment">/* calulate damping forces generated by goals*/</span>
<a name="l02674"></a>02674                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(velgoal,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>);
<a name="l02675"></a>02675                     kd = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a552f85542071602e7bf8b074a0f58e01">goalfrict</a> * <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob);
<a name="l02676"></a>02676                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(auxvect,velgoal,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02677"></a>02677 
<a name="l02678"></a>02678                     <span class="keywordflow">if</span> (forcetime &gt; 0.0f) { <span class="comment">/* make sure friction does not become rocket motor on time reversal */</span>
<a name="l02679"></a>02679                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= kd * (auxvect[0]);
<a name="l02680"></a>02680                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= kd * (auxvect[1]);
<a name="l02681"></a>02681                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= kd * (auxvect[2]);
<a name="l02682"></a>02682                         <span class="keywordflow">if</span> (nl_flags &amp; NLF_BUILD) {
<a name="l02683"></a>02683                             <span class="comment">//int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02684"></a>02684                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(auxvect);
<a name="l02685"></a>02685                             <span class="comment">/* depending on my vel */</span>
<a name="l02686"></a>02686                             <span class="comment">//dfdv_goal(ia,ia,kd*forcetime);</span>
<a name="l02687"></a>02687                         }
<a name="l02688"></a>02688 
<a name="l02689"></a>02689                     }
<a name="l02690"></a>02690                     <span class="keywordflow">else</span> {
<a name="l02691"></a>02691                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= kd * (velgoal[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0]);
<a name="l02692"></a>02692                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= kd * (velgoal[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1]);
<a name="l02693"></a>02693                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= kd * (velgoal[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2]);
<a name="l02694"></a>02694                     }
<a name="l02695"></a>02695                 }
<a name="l02696"></a>02696                 <span class="comment">/* done goal stuff */</span>
<a name="l02697"></a>02697 
<a name="l02698"></a>02698 
<a name="l02699"></a>02699                 <span class="comment">/* gravitation */</span>
<a name="l02700"></a>02700                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, gravity, <a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp)); <span class="comment">/* individual mass of node here */</span>
<a name="l02701"></a>02701 
<a name="l02702"></a>02702 
<a name="l02703"></a>02703                 <span class="comment">/* particle field &amp; vortex */</span>
<a name="l02704"></a>02704                 <span class="keywordflow">if</span> (do_effector) {
<a name="l02705"></a>02705                     <a class="code" href="../../db/d29/structEffectedPoint.html">EffectedPoint</a> epoint;
<a name="l02706"></a>02706                     <span class="keywordtype">float</span> force[3]= {0.0f, 0.0f, 0.0f};
<a name="l02707"></a>02707                     <span class="keywordtype">float</span> speed[3]= {0.0f, 0.0f, 0.0f};
<a name="l02708"></a>02708                     <span class="keywordtype">float</span> eval_sb_fric_force_scale = <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob); <span class="comment">/* just for calling function once */</span>
<a name="l02709"></a>02709                     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7ed88ae8138e32a6549a8ce984275137">pd_point_from_soft</a>(scene, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>-bp, &amp;epoint);
<a name="l02710"></a>02710                     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a4099ac2ecd7e48764e8e741bf2aade72">pdDoEffectors</a>(do_effector, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>, &amp;epoint, force, speed);
<a name="l02711"></a>02711 
<a name="l02712"></a>02712                     <span class="comment">/* apply forcefield*/</span>
<a name="l02713"></a>02713                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(force,fieldfactor* eval_sb_fric_force_scale);
<a name="l02714"></a>02714                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, force);
<a name="l02715"></a>02715 
<a name="l02716"></a>02716                     <span class="comment">/* BP friction in moving media */</span>
<a name="l02717"></a>02717                     kd= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ae1c8eb710553fda9e0d8b72b998d39b8">mediafrict</a>* eval_sb_fric_force_scale;
<a name="l02718"></a>02718                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0] + windfactor*speed[0]/eval_sb_fric_force_scale);
<a name="l02719"></a>02719                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1] + windfactor*speed[1]/eval_sb_fric_force_scale);
<a name="l02720"></a>02720                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2] -= kd * (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2] + windfactor*speed[2]/eval_sb_fric_force_scale);
<a name="l02721"></a>02721                     <span class="comment">/* now we&#39;ll have nice centrifugal effect for vortex */</span>
<a name="l02722"></a>02722 
<a name="l02723"></a>02723                 }
<a name="l02724"></a>02724                 <span class="keywordflow">else</span> {
<a name="l02725"></a>02725                     <span class="comment">/* BP friction in media (not) moving*/</span>
<a name="l02726"></a>02726                     kd= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ae1c8eb710553fda9e0d8b72b998d39b8">mediafrict</a>* <a class="code" href="../../de/d32/softbody_8c.html#ac698869c3fd81a9b4fed2df9762c9683">sb_fric_force_scale</a>(ob);
<a name="l02727"></a>02727                     <span class="comment">/* assume it to be proportional to actual velocity */</span>
<a name="l02728"></a>02728                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0]*kd;
<a name="l02729"></a>02729                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[1]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1]*kd;
<a name="l02730"></a>02730                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[2]-= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2]*kd;
<a name="l02731"></a>02731                     <span class="comment">/* friction in media done */</span>
<a name="l02732"></a>02732                     <span class="keywordflow">if</span> (nl_flags &amp; NLF_BUILD) {
<a name="l02733"></a>02733                         <span class="comment">//int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02734"></a>02734                         <span class="comment">/* da/dv =  */</span>
<a name="l02735"></a>02735 
<a name="l02736"></a>02736                         <span class="comment">//                  nlMatrixAdd(ia,ia,forcetime*kd);</span>
<a name="l02737"></a>02737                         <span class="comment">//                  nlMatrixAdd(ia+1,ia+1,forcetime*kd);</span>
<a name="l02738"></a>02738                         <span class="comment">//                  nlMatrixAdd(ia+2,ia+2,forcetime*kd);</span>
<a name="l02739"></a>02739                     }
<a name="l02740"></a>02740 
<a name="l02741"></a>02741                 }
<a name="l02742"></a>02742                 <span class="comment">/* +++cached collision targets */</span>
<a name="l02743"></a>02743                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = 0.0f;
<a name="l02744"></a>02744                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a> = 0.0f;
<a name="l02745"></a>02745                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02746"></a>02746                 <span class="keywordflow">if</span> (do_deflector) {
<a name="l02747"></a>02747                     <span class="keywordtype">float</span> cfforce[3],defforce[3] ={0.0f,0.0f,0.0f}, vel[3] = {0.0f,0.0f,0.0f}, facenormal[3], cf = 1.0f,intrusion;
<a name="l02748"></a>02748                     kd = 1.0f;
<a name="l02749"></a>02749 
<a name="l02750"></a>02750                     <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a1f4b1fcc3571b047d1ca2c1067325faa">sb_deflect_face</a>(ob,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,facenormal,defforce,&amp;cf,timenow,vel,&amp;intrusion)) {
<a name="l02751"></a>02751                         <span class="keywordflow">if</span> ((!nl_flags)&amp;&amp;(intrusion &lt; 0.0f)) {
<a name="l02752"></a>02752                             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rt &amp; 0x01) { <span class="comment">// 17 we did check for bit 0x10 before</span>
<a name="l02753"></a>02753                                 <span class="comment">/*fixing bug [17428] this forces adaptive step size to tiny steps</span>
<a name="l02754"></a>02754 <span class="comment">                                in some situations .. keeping G.rt==17 option for old files &#39;needing&#39; the bug</span>
<a name="l02755"></a>02755 <span class="comment">                                */</span>
<a name="l02756"></a>02756                                 <span class="comment">/*bjornmose:  uugh.. what an evil hack</span>
<a name="l02757"></a>02757 <span class="comment">                                violation of the &#39;don&#39;t touch bp-&gt;pos in here&#39; rule</span>
<a name="l02758"></a>02758 <span class="comment">                                but works nice, like this--&gt;</span>
<a name="l02759"></a>02759 <span class="comment">                                we predict the solution being out of the collider</span>
<a name="l02760"></a>02760 <span class="comment">                                in heun step No1 and leave the heun step No2 adapt to it</span>
<a name="l02761"></a>02761 <span class="comment">                                so we kind of introduced a implicit solver for this case</span>
<a name="l02762"></a>02762 <span class="comment">                                */</span>
<a name="l02763"></a>02763                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,-intrusion,facenormal);
<a name="l02764"></a>02764                             }
<a name="l02765"></a>02765                             <span class="keywordflow">else</span> {
<a name="l02766"></a>02766 
<a name="l02767"></a>02767                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(cfforce,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,vel);
<a name="l02768"></a>02768                                 <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-cf*50.0f,cfforce);
<a name="l02769"></a>02769                             }
<a name="l02770"></a>02770 
<a name="l02771"></a>02771 
<a name="l02772"></a>02772                             sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02773"></a>02773                             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> |= <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l02774"></a>02774                             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab8b0036c0478a99fa960a3f8b0a579ce">choke</a>*0.01f;
<a name="l02775"></a>02775                         }
<a name="l02776"></a>02776                         <span class="keywordflow">else</span> {
<a name="l02777"></a>02777                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(cfforce,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,vel);
<a name="l02778"></a>02778                             <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,-cf*50.0f,cfforce);
<a name="l02779"></a>02779                         }
<a name="l02780"></a>02780                         <a class="code" href="../../de/d32/softbody_8c.html#a66b0c0cd8f70fee1cd606bcd2464ecc2">Vec3PlusStVec</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,kd,defforce);
<a name="l02781"></a>02781                         <span class="keywordflow">if</span> (nl_flags &amp; NLF_BUILD) {
<a name="l02782"></a>02782                             <span class="comment">// int ia =3*(sb-&gt;totpoint-a);</span>
<a name="l02783"></a>02783                             <span class="comment">// int op =3*sb-&gt;totpoint;</span>
<a name="l02784"></a>02784                             <span class="comment">//dfdx_goal(ia,ia,op,mpos); // don&#39;t do unless you know</span>
<a name="l02785"></a>02785                             <span class="comment">//dfdv_goal(ia,ia,-cf);</span>
<a name="l02786"></a>02786 
<a name="l02787"></a>02787                         }
<a name="l02788"></a>02788 
<a name="l02789"></a>02789                     }
<a name="l02790"></a>02790 
<a name="l02791"></a>02791                 }
<a name="l02792"></a>02792                 <span class="comment">/* ---cached collision targets */</span>
<a name="l02793"></a>02793 
<a name="l02794"></a>02794                 <span class="comment">/* +++springs */</span>
<a name="l02795"></a>02795                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l02796"></a>02796                     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>) { <span class="comment">/* spring list exists at all ? */</span>
<a name="l02797"></a>02797                         <span class="keywordflow">for</span> (b=bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a62cefe0d6e1574499987bf2e49a28e4c">nofsprings</a>;b&gt;0;b--) {
<a name="l02798"></a>02798                             bs = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abced91f2869f83e2929f07f6f4fe830b">springs</a>[b-1];
<a name="l02799"></a>02799                             <span class="keywordflow">if</span> (do_springcollision || do_aero) {
<a name="l02800"></a>02800                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>, bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a1971ecea742006241fd43dd1502c46dd">ext_force</a>);
<a name="l02801"></a>02801                                 <span class="keywordflow">if</span> (bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a667d9a5345c9c00a1137b5f229978192">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#ad2d659487f12252dbd9dae8a17f114b4">BSF_INTERSECT</a>)
<a name="l02802"></a>02802                                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> = bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a6e00cc327e19fb753f11295d576c744f">cf</a>;
<a name="l02803"></a>02803 
<a name="l02804"></a>02804                             }
<a name="l02805"></a>02805                             <span class="comment">// sb_spring_force(Object *ob,int bpi,BodySpring *bs,float iks,float forcetime,int nl_flags)</span>
<a name="l02806"></a>02806                             <span class="comment">// rather remove nl_falgs from code .. will make things a lot cleaner</span>
<a name="l02807"></a>02807                             <a class="code" href="../../de/d32/softbody_8c.html#af2bc841c7dbd64a2af2ad0b9cd6eefb5">sb_spring_force</a>(ob,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a,bs,iks,forcetime,0);
<a name="l02808"></a>02808                         }<span class="comment">/* loop springs */</span>
<a name="l02809"></a>02809                     }<span class="comment">/* existing spring list */</span>
<a name="l02810"></a>02810                 }<span class="comment">/*any edges*/</span>
<a name="l02811"></a>02811                 <span class="comment">/* ---springs */</span>
<a name="l02812"></a>02812             }<span class="comment">/*omit on snap */</span>
<a name="l02813"></a>02813         }<span class="comment">/*loop all bp&#39;s*/</span>
<a name="l02814"></a>02814 
<a name="l02815"></a>02815 
<a name="l02816"></a>02816         <span class="comment">/* finally add forces caused by face collision */</span>
<a name="l02817"></a>02817         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a133f582250dd8a392e24954871920cf2">OB_SB_FACECOLL</a>) <a class="code" href="../../de/d32/softbody_8c.html#af52ae9b7ac75ad64586b0b06d7f8e342">scan_for_ext_face_forces</a>(ob,timenow);
<a name="l02818"></a>02818 
<a name="l02819"></a>02819         <span class="comment">/* finish matrix and solve */</span>
<a name="l02820"></a>02820 <span class="preprocessor">#if (0) // remove onl linking for now .. still i am not sure .. the jacobian can be useful .. so keep that BM</span>
<a name="l02821"></a>02821 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (nl_flags &amp; <a class="code" href="../../de/d32/softbody_8c.html#a8e7ce91878042a7f8d8a295e87dbe3be">NLF_SOLVE</a>) {
<a name="l02822"></a>02822             <span class="comment">//double sct,sst=PIL_check_seconds_timer();</span>
<a name="l02823"></a>02823             <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02824"></a>02824                 <span class="keywordtype">int</span> iv =3*(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a);
<a name="l02825"></a>02825                 <span class="keywordtype">int</span> ip =3*(2*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>-a);
<a name="l02826"></a>02826                 <span class="keywordtype">int</span> n;
<a name="l02827"></a>02827                 <span class="keywordflow">for</span> (n=0;n&lt;3;n++) {<a class="code" href="../../db/dde/ONL__opennl_8h.html#af4f675423df8373a06ac7db7cd20703d">nlRightHandSideSet</a>(0, iv+n, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>[0+n]);}
<a name="l02828"></a>02828                 <span class="keywordflow">for</span> (n=0;n&lt;3;n++) {<a class="code" href="../../db/dde/ONL__opennl_8h.html#af4f675423df8373a06ac7db7cd20703d">nlRightHandSideSet</a>(0, ip+n, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0+n]);}
<a name="l02829"></a>02829             }
<a name="l02830"></a>02830             <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l02831"></a>02831             <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l02832"></a>02832 
<a name="l02833"></a>02833             <span class="keywordflow">if</span> ((<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rt == 32) &amp;&amp; (nl_flags &amp; <a class="code" href="../../de/d32/softbody_8c.html#ad4582ccf791498af49000ca8c0fd0a48">NLF_BUILD</a>))
<a name="l02834"></a>02834             {
<a name="l02835"></a>02835                 printf(<span class="stringliteral">&quot;####MEE#####\n&quot;</span>);
<a name="l02836"></a>02836                 <a class="code" href="../../db/dde/ONL__opennl_8h.html#a02ef63e101f56a596217bbdab889f351">nlPrintMatrix</a>();
<a name="l02837"></a>02837             }
<a name="l02838"></a>02838 
<a name="l02839"></a>02839             success= <a class="code" href="../../db/dde/ONL__opennl_8h.html#afae449d3ffbd41c2fdabaf7602e6bbb9">nlSolveAdvanced</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l02840"></a>02840 
<a name="l02841"></a>02841             <span class="comment">// nlPrintMatrix(); /* for debug purpose .. anyhow cropping B vector looks like working */</span>
<a name="l02842"></a>02842             <span class="keywordflow">if</span> (success) {
<a name="l02843"></a>02843                 <span class="keywordtype">float</span> f;
<a name="l02844"></a>02844                 <span class="keywordtype">int</span> index =0;
<a name="l02845"></a>02845                 <span class="comment">/* for debug purpose .. anyhow cropping B vector looks like working */</span>
<a name="l02846"></a>02846                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rt ==32)
<a name="l02847"></a>02847                     <span class="keywordflow">for</span> (a=2*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02848"></a>02848                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02849"></a>02849                         printf(<span class="stringliteral">&quot;(%f &quot;</span>,f);index++;
<a name="l02850"></a>02850                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02851"></a>02851                         printf(<span class="stringliteral">&quot;%f &quot;</span>,f);index++;
<a name="l02852"></a>02852                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02853"></a>02853                         printf(<span class="stringliteral">&quot;%f)&quot;</span>,f);index++;
<a name="l02854"></a>02854                     }
<a name="l02855"></a>02855 
<a name="l02856"></a>02856                     index =0;
<a name="l02857"></a>02857                     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02858"></a>02858                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02859"></a>02859                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#aa82a80b9c7685aa9f97d14fe3adc27d1">impdv</a>[0] = f; index++;
<a name="l02860"></a>02860                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02861"></a>02861                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#aa82a80b9c7685aa9f97d14fe3adc27d1">impdv</a>[1] = f; index++;
<a name="l02862"></a>02862                         f=<a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0,index);
<a name="l02863"></a>02863                         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#aa82a80b9c7685aa9f97d14fe3adc27d1">impdv</a>[2] = f; index++;
<a name="l02864"></a>02864                     }
<a name="l02865"></a>02865                     <span class="comment">/*</span>
<a name="l02866"></a>02866 <span class="comment">                    for (a=sb-&gt;totpoint, bp= sb-&gt;bpoint; a&gt;0; a--, bp++) {</span>
<a name="l02867"></a>02867 <span class="comment">                    f=nlGetVariable(0,index);</span>
<a name="l02868"></a>02868 <span class="comment">                    bp-&gt;impdx[0] = f; index++;</span>
<a name="l02869"></a>02869 <span class="comment">                    f=nlGetVariable(0,index);</span>
<a name="l02870"></a>02870 <span class="comment">                    bp-&gt;impdx[1] = f; index++;</span>
<a name="l02871"></a>02871 <span class="comment">                    f=nlGetVariable(0,index);</span>
<a name="l02872"></a>02872 <span class="comment">                    bp-&gt;impdx[2] = f; index++;</span>
<a name="l02873"></a>02873 <span class="comment">                    }</span>
<a name="l02874"></a>02874 <span class="comment">                    */</span>
<a name="l02875"></a>02875             }
<a name="l02876"></a>02876             <span class="keywordflow">else</span> {
<a name="l02877"></a>02877                 printf(<span class="stringliteral">&quot;Matrix inversion failed\n&quot;</span>);
<a name="l02878"></a>02878                 <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02879"></a>02879                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#aa82a80b9c7685aa9f97d14fe3adc27d1">impdv</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>);
<a name="l02880"></a>02880                 }
<a name="l02881"></a>02881 
<a name="l02882"></a>02882             }
<a name="l02883"></a>02883 
<a name="l02884"></a>02884             <span class="comment">//sct=PIL_check_seconds_timer();</span>
<a name="l02885"></a>02885             <span class="comment">//if (sct-sst &gt; 0.01f) printf(&quot; implicit solver time %f %s \r&quot;,sct-sst,ob-&gt;id.name);</span>
<a name="l02886"></a>02886         }
<a name="l02887"></a>02887         <span class="comment">/* cleanup */</span>
<a name="l02888"></a>02888 <span class="preprocessor">#endif</span>
<a name="l02889"></a>02889 <span class="preprocessor"></span>        <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7da5e7ad353e025440f05a9adbd7032d">pdEndEffectors</a>(&amp;do_effector);
<a name="l02890"></a>02890     }
<a name="l02891"></a>02891 }
<a name="l02892"></a>02892 
<a name="l02893"></a><a class="code" href="../../de/d32/softbody_8c.html#a7230cb2671dff526904c5ffb07a2e20a">02893</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a7230cb2671dff526904c5ffb07a2e20a">softbody_apply_forces</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> forcetime, <span class="keywordtype">int</span> mode, <span class="keywordtype">float</span> *<a class="code" href="../../df/db3/freetypefont_8c.html#ab596967142db56aa5fbafe7c234eedda">err</a>, <span class="keywordtype">int</span> mid_flags)
<a name="l02894"></a>02894 {
<a name="l02895"></a>02895     <span class="comment">/* time evolution */</span>
<a name="l02896"></a>02896     <span class="comment">/* actually does an explicit euler step mode == 0 */</span>
<a name="l02897"></a>02897     <span class="comment">/* or heun ~ 2nd order runge-kutta steps, mode 1,2 */</span>
<a name="l02898"></a>02898     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l02899"></a>02899     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l02900"></a>02900     <span class="keywordtype">float</span> dx[3]={0},dv[3],aabbmin[3],aabbmax[3],cm[3]={0.0f,0.0f,0.0f};
<a name="l02901"></a>02901     <span class="keywordtype">float</span> timeovermass<span class="comment">/*,freezeloc=0.00001f,freezeforce=0.00000000001f*/</span>;
<a name="l02902"></a>02902     <span class="keywordtype">float</span> maxerrpos= 0.0f,maxerrvel = 0.0f;
<a name="l02903"></a>02903     <span class="keywordtype">int</span> a,fuzzy=0;
<a name="l02904"></a>02904 
<a name="l02905"></a>02905     forcetime *= <a class="code" href="../../de/d32/softbody_8c.html#aca1b4f32ecb028305ce6885532a5411a">sb_time_scale</a>(ob);
<a name="l02906"></a>02906 
<a name="l02907"></a>02907     aabbmin[0]=aabbmin[1]=aabbmin[2] = 1e20f;
<a name="l02908"></a>02908     aabbmax[0]=aabbmax[1]=aabbmax[2] = -1e20f;
<a name="l02909"></a>02909 
<a name="l02910"></a>02910     <span class="comment">/* old one with homogenous masses  */</span>
<a name="l02911"></a>02911     <span class="comment">/* claim a minimum mass for vertex */</span>
<a name="l02912"></a>02912     <span class="comment">/*</span>
<a name="l02913"></a>02913 <span class="comment">    if (sb-&gt;nodemass &gt; 0.009999f) timeovermass = forcetime/sb-&gt;nodemass;</span>
<a name="l02914"></a>02914 <span class="comment">    else timeovermass = forcetime/0.009999f;</span>
<a name="l02915"></a>02915 <span class="comment">    */</span>
<a name="l02916"></a>02916 
<a name="l02917"></a>02917     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l02918"></a>02918 <span class="comment">/* now we have individual masses   */</span>
<a name="l02919"></a>02919 <span class="comment">/* claim a minimum mass for vertex */</span>
<a name="l02920"></a>02920         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp) &gt; 0.009999f) timeovermass = forcetime/<a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp);
<a name="l02921"></a>02921         <span class="keywordflow">else</span> timeovermass = forcetime/0.009999f;
<a name="l02922"></a>02922 
<a name="l02923"></a>02923 
<a name="l02924"></a>02924         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob,bp) &lt; <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) {
<a name="l02925"></a>02925             <span class="comment">/* this makes t~ = t */</span>
<a name="l02926"></a>02926             <span class="keywordflow">if</span> (mid_flags &amp; <a class="code" href="../../de/d32/softbody_8c.html#abe8a65968f3259f17cd3bd2b5be5dec5">MID_PRESERVE</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dx,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02927"></a>02927 
<a name="l02928"></a>02928             <span class="comment">/* so here is (v)&#39; = a(cceleration) = sum(F_springs)/m + gravitation + some friction forces  + more forces*/</span>
<a name="l02929"></a>02929             <span class="comment">/* the ( ... )&#39; operator denotes derivate respective time */</span>
<a name="l02930"></a>02930             <span class="comment">/* the euler step for velocity then becomes */</span>
<a name="l02931"></a>02931             <span class="comment">/* v(t + dt) = v(t) + a(t) * dt */</span>
<a name="l02932"></a>02932             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>,timeovermass);<span class="comment">/* individual mass of node here */</span>
<a name="l02933"></a>02933             <span class="comment">/* some nasty if&#39;s to have heun in here too */</span>
<a name="l02934"></a>02934             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dv,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>);
<a name="l02935"></a>02935 
<a name="l02936"></a>02936             <span class="keywordflow">if</span> (mode == 1) {
<a name="l02937"></a>02937                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02938"></a>02938                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>, dv);
<a name="l02939"></a>02939             }
<a name="l02940"></a>02940 
<a name="l02941"></a>02941             <span class="keywordflow">if</span> (mode ==2) {
<a name="l02942"></a>02942                 <span class="comment">/* be optimistic and execute step */</span>
<a name="l02943"></a>02943                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>[0] + 0.5f * (dv[0] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[0]);
<a name="l02944"></a>02944                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>[1] + 0.5f * (dv[1] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[1]);
<a name="l02945"></a>02945                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>[2] + 0.5f * (dv[2] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[2]);
<a name="l02946"></a>02946                 <span class="comment">/* compare euler to heun to estimate error for step sizing */</span>
<a name="l02947"></a>02947                 maxerrvel = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrvel,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dv[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[0]));
<a name="l02948"></a>02948                 maxerrvel = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrvel,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dv[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[1]));
<a name="l02949"></a>02949                 maxerrvel = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrvel,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dv[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>[2]));
<a name="l02950"></a>02950             }
<a name="l02951"></a>02951             <span class="keywordflow">else</span> { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1b0726d5dbec495f825d744f3f90cc18">force</a>); }
<a name="l02952"></a>02952 
<a name="l02953"></a>02953             <span class="comment">/* this makes t~ = t+dt */</span>
<a name="l02954"></a>02954             <span class="keywordflow">if</span> (!(mid_flags &amp; MID_PRESERVE)) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dx,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l02955"></a>02955 
<a name="l02956"></a>02956             <span class="comment">/* so here is (x)&#39;= v(elocity) */</span>
<a name="l02957"></a>02957             <span class="comment">/* the euler step for location then becomes */</span>
<a name="l02958"></a>02958             <span class="comment">/* x(t + dt) = x(t) + v(t~) * dt */</span>
<a name="l02959"></a>02959             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dx,forcetime);
<a name="l02960"></a>02960 
<a name="l02961"></a>02961             <span class="comment">/* the freezer coming sooner or later */</span>
<a name="l02962"></a>02962             <span class="comment">/*</span>
<a name="l02963"></a>02963 <span class="comment">            if ((dot_v3v3(dx,dx)&lt;freezeloc )&amp;&amp;(dot_v3v3(bp-&gt;force,bp-&gt;force)&lt;freezeforce )) {</span>
<a name="l02964"></a>02964 <span class="comment">                bp-&gt;frozen /=2;</span>
<a name="l02965"></a>02965 <span class="comment">            }</span>
<a name="l02966"></a>02966 <span class="comment">            else {</span>
<a name="l02967"></a>02967 <span class="comment">                bp-&gt;frozen = MIN2(bp-&gt;frozen*1.05f,1.0f);</span>
<a name="l02968"></a>02968 <span class="comment">            }</span>
<a name="l02969"></a>02969 <span class="comment">            mul_v3_fl(dx,bp-&gt;frozen);</span>
<a name="l02970"></a>02970 <span class="comment">            */</span>
<a name="l02971"></a>02971             <span class="comment">/* again some nasty if&#39;s to have heun in here too */</span>
<a name="l02972"></a>02972             <span class="keywordflow">if</span> (mode ==1) {
<a name="l02973"></a>02973                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l02974"></a>02974                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a> ,dx);
<a name="l02975"></a>02975             }
<a name="l02976"></a>02976 
<a name="l02977"></a>02977             <span class="keywordflow">if</span> (mode ==2) {
<a name="l02978"></a>02978                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[0] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>[0] + 0.5f * ( dx[0] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[0]);
<a name="l02979"></a>02979                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[1] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>[1] + 0.5f * ( dx[1] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[1]);
<a name="l02980"></a>02980                 bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[2] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>[2] + 0.5f * ( dx[2] + bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[2]);
<a name="l02981"></a>02981                 maxerrpos = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrpos,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dx[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[0]));
<a name="l02982"></a>02982                 maxerrpos = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrpos,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dx[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[1]));
<a name="l02983"></a>02983                 maxerrpos = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrpos,<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dx[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>[2]));
<a name="l02984"></a>02984 
<a name="l02985"></a>02985 <span class="comment">/* bp-&gt;choke is set when we need to pull a vertex or edge out of the collider.</span>
<a name="l02986"></a>02986 <span class="comment">   the collider object signals to get out by pushing hard. on the other hand</span>
<a name="l02987"></a>02987 <span class="comment">   we don&#39;t want to end up in deep space so we add some &lt;viscosity&gt;</span>
<a name="l02988"></a>02988 <span class="comment">   to balance that out */</span>
<a name="l02989"></a>02989                 <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a> &gt; 0.0f) {
<a name="l02990"></a>02990                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,(1.0f - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a4a9dae7e53c67599ca1de179980ee038">choke2</a>));
<a name="l02991"></a>02991                 }
<a name="l02992"></a>02992                 <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a> &gt; 0.0f) {
<a name="l02993"></a>02993                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,(1.0f - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a8043a67d266784a6a0f8db339a94e84a">choke</a>));
<a name="l02994"></a>02994                 }
<a name="l02995"></a>02995 
<a name="l02996"></a>02996             }
<a name="l02997"></a>02997             <span class="keywordflow">else</span> { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, dx);}
<a name="l02998"></a>02998         }<span class="comment">/*snap*/</span>
<a name="l02999"></a>02999         <span class="comment">/* so while we are looping BPs anyway do statistics on the fly */</span>
<a name="l03000"></a>03000         aabbmin[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(aabbmin[0],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[0]);
<a name="l03001"></a>03001         aabbmin[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(aabbmin[1],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[1]);
<a name="l03002"></a>03002         aabbmin[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(aabbmin[2],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[2]);
<a name="l03003"></a>03003         aabbmax[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(aabbmax[0],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[0]);
<a name="l03004"></a>03004         aabbmax[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(aabbmax[1],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[1]);
<a name="l03005"></a>03005         aabbmax[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(aabbmax[2],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>[2]);
<a name="l03006"></a>03006         <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb38ab7aea7a787bab2f8ce8570ef429">loc_flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>) fuzzy =1;
<a name="l03007"></a>03007     } <span class="comment">/*for*/</span>
<a name="l03008"></a>03008 
<a name="l03009"></a>03009     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cm,1.0f/sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>);
<a name="l03010"></a>03010     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>) {
<a name="l03011"></a>03011         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>,aabbmin);
<a name="l03012"></a>03012         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>,aabbmax);
<a name="l03013"></a>03013     }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015     <span class="keywordflow">if</span> (err) { <span class="comment">/* so step size will be controlled by biggest difference in slope */</span>
<a name="l03016"></a>03016         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#aeedfb02f05eea7aae50dd4512f0f8912">SBSO_OLDERR</a>)
<a name="l03017"></a>03017         *err = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxerrpos,maxerrvel);
<a name="l03018"></a>03018         <span class="keywordflow">else</span>
<a name="l03019"></a>03019         *err = maxerrpos;
<a name="l03020"></a>03020         <span class="comment">//printf(&quot;EP %f EV %f\n&quot;,maxerrpos,maxerrvel);</span>
<a name="l03021"></a>03021         <span class="keywordflow">if</span> (fuzzy) {
<a name="l03022"></a>03022             *err /= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a997b26f5bef1b3c5401040388edbad8d">fuzzyness</a>;
<a name="l03023"></a>03023         }
<a name="l03024"></a>03024     }
<a name="l03025"></a>03025 }
<a name="l03026"></a>03026 
<a name="l03027"></a>03027 <span class="comment">/* used by heun when it overshoots */</span>
<a name="l03028"></a><a class="code" href="../../de/d32/softbody_8c.html#a556f9c70558aeea73aaf411fe527c787">03028</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a556f9c70558aeea73aaf411fe527c787">softbody_restore_prev_step</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03029"></a>03029 {
<a name="l03030"></a>03030     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there*/</span>
<a name="l03031"></a>03031     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03032"></a>03032     <span class="keywordtype">int</span> a;
<a name="l03033"></a>03033 
<a name="l03034"></a>03034     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03035"></a>03035         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>);
<a name="l03036"></a>03036         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>);
<a name="l03037"></a>03037     }
<a name="l03038"></a>03038 }
<a name="l03039"></a>03039 
<a name="l03040"></a>03040 <span class="preprocessor">#if 0</span>
<a name="l03041"></a>03041 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> softbody_store_step(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03042"></a>03042 {
<a name="l03043"></a>03043     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there*/</span>
<a name="l03044"></a>03044     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03045"></a>03045     <span class="keywordtype">int</span> a;
<a name="l03046"></a>03046 
<a name="l03047"></a>03047     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03048"></a>03048         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03049"></a>03049         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03050"></a>03050     }
<a name="l03051"></a>03051 }
<a name="l03052"></a>03052 
<a name="l03053"></a>03053 
<a name="l03054"></a>03054 <span class="comment">/* used by predictors and correctors */</span>
<a name="l03055"></a>03055 <span class="keyword">static</span> <span class="keywordtype">void</span> softbody_store_state(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> *ppos,<span class="keywordtype">float</span> *pvel)
<a name="l03056"></a>03056 {
<a name="l03057"></a>03057     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there*/</span>
<a name="l03058"></a>03058     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03059"></a>03059     <span class="keywordtype">int</span> a;
<a name="l03060"></a>03060     <span class="keywordtype">float</span> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#ac25299c567fdbf4895a991a0df73bf9c">pp</a>=ppos,*pv=pvel;
<a name="l03061"></a>03061 
<a name="l03062"></a>03062     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03063"></a>03063 
<a name="l03064"></a>03064         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pv, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03065"></a>03065         pv+=3;
<a name="l03066"></a>03066 
<a name="l03067"></a>03067         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pp, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03068"></a>03068         pp+=3;
<a name="l03069"></a>03069     }
<a name="l03070"></a>03070 }
<a name="l03071"></a>03071 
<a name="l03072"></a>03072 <span class="comment">/* used by predictors and correctors */</span>
<a name="l03073"></a>03073 <span class="keyword">static</span> <span class="keywordtype">void</span> softbody_retrieve_state(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> *ppos,<span class="keywordtype">float</span> *pvel)
<a name="l03074"></a>03074 {
<a name="l03075"></a>03075     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there*/</span>
<a name="l03076"></a>03076     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03077"></a>03077     <span class="keywordtype">int</span> a;
<a name="l03078"></a>03078     <span class="keywordtype">float</span> *pp=ppos,*pv=pvel;
<a name="l03079"></a>03079 
<a name="l03080"></a>03080     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03081"></a>03081 
<a name="l03082"></a>03082         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,pv);
<a name="l03083"></a>03083         pv+=3;
<a name="l03084"></a>03084 
<a name="l03085"></a>03085         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,pp);
<a name="l03086"></a>03086         pp+=3;
<a name="l03087"></a>03087     }
<a name="l03088"></a>03088 }
<a name="l03089"></a>03089 
<a name="l03090"></a>03090 <span class="comment">/* used by predictors and correctors */</span>
<a name="l03091"></a>03091 <span class="keyword">static</span> <span class="keywordtype">void</span> softbody_swap_state(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> *ppos,<span class="keywordtype">float</span> *pvel)
<a name="l03092"></a>03092 {
<a name="l03093"></a>03093     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there*/</span>
<a name="l03094"></a>03094     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03095"></a>03095     <span class="keywordtype">int</span> a;
<a name="l03096"></a>03096     <span class="keywordtype">float</span> *pp=ppos,*pv=pvel;
<a name="l03097"></a>03097     <span class="keywordtype">float</span> temp[3];
<a name="l03098"></a>03098 
<a name="l03099"></a>03099     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03100"></a>03100 
<a name="l03101"></a>03101         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(temp, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03102"></a>03102         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>,pv);
<a name="l03103"></a>03103         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pv,temp);
<a name="l03104"></a>03104         pv+=3;
<a name="l03105"></a>03105 
<a name="l03106"></a>03106         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(temp, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03107"></a>03107         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,pp);
<a name="l03108"></a>03108         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pp,temp);
<a name="l03109"></a>03109         pp+=3;
<a name="l03110"></a>03110     }
<a name="l03111"></a>03111 }
<a name="l03112"></a>03112 <span class="preprocessor">#endif</span>
<a name="l03113"></a>03113 <span class="preprocessor"></span>
<a name="l03114"></a>03114 
<a name="l03115"></a>03115 <span class="comment">/* care for bodypoints taken out of the &#39;ordinary&#39; solver step</span>
<a name="l03116"></a>03116 <span class="comment">** because they are screwed to goal by bolts</span>
<a name="l03117"></a>03117 <span class="comment">** they just need to move along with the goal in time</span>
<a name="l03118"></a>03118 <span class="comment">** we need to adjust them on sub frame timing in solver</span>
<a name="l03119"></a>03119 <span class="comment">** so now when frame is done .. put &#39;em to the position at the end of frame</span>
<a name="l03120"></a>03120 <span class="comment">*/</span>
<a name="l03121"></a><a class="code" href="../../de/d32/softbody_8c.html#a6be8d5628c067cfa1d2ea967ba518c94">03121</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a6be8d5628c067cfa1d2ea967ba518c94">softbody_apply_goalsnap</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03122"></a>03122 {
<a name="l03123"></a>03123     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>; <span class="comment">/* is supposed to be there */</span>
<a name="l03124"></a>03124     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03125"></a>03125     <span class="keywordtype">int</span> a;
<a name="l03126"></a>03126 
<a name="l03127"></a>03127     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03128"></a>03128         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob,bp) &gt;= <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) {
<a name="l03129"></a>03129             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03130"></a>03130             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>);
<a name="l03131"></a>03131         }
<a name="l03132"></a>03132     }
<a name="l03133"></a>03133 }
<a name="l03134"></a>03134 
<a name="l03135"></a>03135 
<a name="l03136"></a><a class="code" href="../../de/d32/softbody_8c.html#afa9f79f284a2a7e665833e3c90f1c533">03136</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#afa9f79f284a2a7e665833e3c90f1c533">apply_spring_memory</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03137"></a>03137 {
<a name="l03138"></a>03138     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03139"></a>03139     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l03140"></a>03140     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp1, *bp2;
<a name="l03141"></a>03141     <span class="keywordtype">int</span> a;
<a name="l03142"></a>03142     <span class="keywordtype">float</span> b,l,r;
<a name="l03143"></a>03143 
<a name="l03144"></a>03144     <span class="keywordflow">if</span> (sb &amp;&amp; sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>) {
<a name="l03145"></a>03145         b = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afe680232f8fa4c56f5c5a6221b485d57">plastic</a>;
<a name="l03146"></a>03146         <span class="keywordflow">for</span> (a=0; a&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>; a++) {
<a name="l03147"></a>03147             bs  = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>[a];
<a name="l03148"></a>03148             bp1 =&amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>];
<a name="l03149"></a>03149             bp2 =&amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>];
<a name="l03150"></a>03150             l = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(bp1-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>,bp2-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03151"></a>03151             r = bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>/l;
<a name="l03152"></a>03152             <span class="keywordflow">if</span> (( r &gt; 1.05f) || (r &lt; 0.95f)) {
<a name="l03153"></a>03153             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a> = ((100.0f - b) * bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>  + b*l)/100.0f;
<a name="l03154"></a>03154             }
<a name="l03155"></a>03155         }
<a name="l03156"></a>03156     }
<a name="l03157"></a>03157 }
<a name="l03158"></a>03158 
<a name="l03159"></a>03159 <span class="comment">/* expects full initialized softbody */</span>
<a name="l03160"></a><a class="code" href="../../de/d32/softbody_8c.html#ace3987b38c1b3988ba9878b76bbb35c2">03160</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ace3987b38c1b3988ba9878b76bbb35c2">interpolate_exciter</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> timescale, <span class="keywordtype">int</span> time)
<a name="l03161"></a>03161 {
<a name="l03162"></a>03162     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03163"></a>03163     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03164"></a>03164     <span class="keywordtype">float</span> f;
<a name="l03165"></a>03165     <span class="keywordtype">int</span> a;
<a name="l03166"></a>03166 
<a name="l03167"></a>03167     f = (float)time/(<span class="keywordtype">float</span>)timescale;
<a name="l03168"></a>03168 
<a name="l03169"></a>03169     <span class="keywordflow">for</span> (a=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&gt;0; a--, bp++) {
<a name="l03170"></a>03170         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>[0] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[0] + f*(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[0]);
<a name="l03171"></a>03171         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>[1] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[1] + f*(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[1]);
<a name="l03172"></a>03172         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>[2] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[2] + f*(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[2]);
<a name="l03173"></a>03173         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a50228ae6b7517fc79e9994d61c918bd9">_final_goal</a>(ob,bp) &gt;= <a class="code" href="../../de/d32/softbody_8c.html#ac9b6990a3c0e57a2a62b4e1581db8844">SOFTGOALSNAP</a>) {
<a name="l03174"></a>03174             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[0] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[0];
<a name="l03175"></a>03175             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[1] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[1];
<a name="l03176"></a>03176             bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2] = bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>[2] - bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>[2];
<a name="l03177"></a>03177         }
<a name="l03178"></a>03178     }
<a name="l03179"></a>03179 
<a name="l03180"></a>03180 }
<a name="l03181"></a>03181 
<a name="l03182"></a>03182 
<a name="l03183"></a>03183 <span class="comment">/* ************ convertors ********** */</span>
<a name="l03184"></a>03184 
<a name="l03185"></a>03185 <span class="comment">/*  for each object type we need;</span>
<a name="l03186"></a>03186 <span class="comment">    - xxxx_to_softbody(Object *ob)      : a full (new) copy, creates SB geometry</span>
<a name="l03187"></a>03187 <span class="comment">*/</span>
<a name="l03188"></a>03188 
<a name="l03189"></a><a class="code" href="../../de/d32/softbody_8c.html#ac1ac925bf34ca5767d5335f5d508a066">03189</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ac1ac925bf34ca5767d5335f5d508a066">get_scalar_from_vertexgroup</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> vertID, <span class="keywordtype">short</span> groupindex, <span class="keywordtype">float</span> *target)
<a name="l03190"></a>03190 <span class="comment">/* result 0 on success, else indicates error number</span>
<a name="l03191"></a>03191 <span class="comment">-- kind of *inverse* result defintion,</span>
<a name="l03192"></a>03192 <span class="comment">-- but this way we can signal error condition to caller</span>
<a name="l03193"></a>03193 <span class="comment">-- and yes this function must not be here but in a *vertex group module*</span>
<a name="l03194"></a>03194 <span class="comment">*/</span>
<a name="l03195"></a>03195 {
<a name="l03196"></a>03196     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03197"></a>03197     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03198"></a>03198 
<a name="l03199"></a>03199     <span class="comment">/* spot the vert in deform vert list at mesh */</span>
<a name="l03200"></a>03200     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l03201"></a>03201         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03202"></a>03202         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>)
<a name="l03203"></a>03203             dv = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> + vertID;
<a name="l03204"></a>03204     }
<a name="l03205"></a>03205     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {    <span class="comment">/* not yet supported in softbody btw */</span>
<a name="l03206"></a>03206         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03207"></a>03207         <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>)
<a name="l03208"></a>03208             dv = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a> + vertID;
<a name="l03209"></a>03209     }
<a name="l03210"></a>03210     <span class="keywordflow">if</span> (dv) {
<a name="l03211"></a>03211         <span class="comment">/* Lets see if this vert is in the weight group */</span>
<a name="l03212"></a>03212         <span class="keywordflow">for</span> (i=0; i&lt;dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i++) {
<a name="l03213"></a>03213             <span class="keywordflow">if</span> (dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[i].<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> == groupindex) {
<a name="l03214"></a>03214                 *target= dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>; <span class="comment">/* got it ! */</span>
<a name="l03215"></a>03215                 <span class="keywordflow">break</span>;
<a name="l03216"></a>03216             }
<a name="l03217"></a>03217         }
<a name="l03218"></a>03218     }
<a name="l03219"></a>03219 }
<a name="l03220"></a>03220 
<a name="l03221"></a>03221 <span class="comment">/* Resetting a Mesh SB object&#39;s springs */</span>
<a name="l03222"></a>03222 <span class="comment">/* Spring length are caculted from&#39;raw&#39; mesh vertices that are NOT altered by modifier stack. */</span>
<a name="l03223"></a><a class="code" href="../../de/d32/softbody_8c.html#a4f6f86e5a2a3e529899e1d17fc1993e9">03223</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a4f6f86e5a2a3e529899e1d17fc1993e9">springs_from_mesh</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03224"></a>03224 {
<a name="l03225"></a>03225     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l03226"></a>03226     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03227"></a>03227     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03228"></a>03228     <span class="keywordtype">int</span> a;
<a name="l03229"></a>03229     <span class="keywordtype">float</span> scale =1.0f;
<a name="l03230"></a>03230 
<a name="l03231"></a>03231     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03232"></a>03232     <span class="keywordflow">if</span> (me &amp;&amp; sb)
<a name="l03233"></a>03233     {
<a name="l03234"></a>03234     <span class="comment">/* using bp-&gt;origS as a container for spring calcualtions here</span>
<a name="l03235"></a>03235 <span class="comment">    ** will be overwritten sbObjectStep() to receive</span>
<a name="l03236"></a>03236 <span class="comment">    ** actual modifier stack positions</span>
<a name="l03237"></a>03237 <span class="comment">    */</span>
<a name="l03238"></a>03238         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>) {
<a name="l03239"></a>03239             bp= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03240"></a>03240             <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, bp++) {
<a name="l03241"></a>03241                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[a].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03242"></a>03242                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>);
<a name="l03243"></a>03243             }
<a name="l03244"></a>03244 
<a name="l03245"></a>03245         }
<a name="l03246"></a>03246         <span class="comment">/* recalculate spring length for meshes here */</span>
<a name="l03247"></a>03247         <span class="comment">/* public version shrink to fit */</span>
<a name="l03248"></a>03248         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a891f7c3bd3a20e66428c562c5a9dafdb">springpreload</a> != 0 ) {
<a name="l03249"></a>03249             scale = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a891f7c3bd3a20e66428c562c5a9dafdb">springpreload</a> / 100.0f;
<a name="l03250"></a>03250         }
<a name="l03251"></a>03251         <span class="keywordflow">for</span> (a=0; a&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3afc54af4c0c108c132ca5fb347e2ab1">totspring</a>; a++) {
<a name="l03252"></a>03252             <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs = &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>[a];
<a name="l03253"></a>03253             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= scale*<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>[bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>].<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>);
<a name="l03254"></a>03254         }
<a name="l03255"></a>03255     }
<a name="l03256"></a>03256 }
<a name="l03257"></a>03257 
<a name="l03258"></a>03258 
<a name="l03259"></a>03259 
<a name="l03260"></a>03260 
<a name="l03261"></a>03261 <span class="comment">/* makes totally fresh start situation */</span>
<a name="l03262"></a><a class="code" href="../../de/d32/softbody_8c.html#a38ed19e7e140b96aa01fdfcfbcac1652">03262</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a38ed19e7e140b96aa01fdfcfbcac1652">mesh_to_softbody</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03263"></a>03263 {
<a name="l03264"></a>03264     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l03265"></a>03265     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03266"></a>03266     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a06722494d8fa0bf3af4b2d2b490da8dc">medge</a>;
<a name="l03267"></a>03267     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03268"></a>03268     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l03269"></a>03269     <span class="keywordtype">int</span> a, totedge;
<a name="l03270"></a>03270     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) totedge= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>;
<a name="l03271"></a>03271     <span class="keywordflow">else</span> totedge= 0;
<a name="l03272"></a>03272 
<a name="l03273"></a>03273     <span class="comment">/* renew ends with ob-&gt;soft with points and edges, also checks &amp; makes ob-&gt;soft */</span>
<a name="l03274"></a>03274     <a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">renew_softbody</a>(scene, ob, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, totedge);
<a name="l03275"></a>03275 
<a name="l03276"></a>03276     <span class="comment">/* we always make body points */</span>
<a name="l03277"></a>03277     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03278"></a>03278     bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03279"></a>03279 
<a name="l03280"></a>03280     <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, bp++) {
<a name="l03281"></a>03281         <span class="comment">/* get scalar values needed  *per vertex* from vertex group functions,</span>
<a name="l03282"></a>03282 <span class="comment">        so we can *paint* them nicly ..</span>
<a name="l03283"></a>03283 <span class="comment">        they are normalized [0.0..1.0] so may be we need amplitude for scale</span>
<a name="l03284"></a>03284 <span class="comment">        which can be done by caller but still .. i&#39;d like it to go this way</span>
<a name="l03285"></a>03285 <span class="comment">        */</span>
<a name="l03286"></a>03286 
<a name="l03287"></a>03287         <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) &amp;&amp; sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#acee97df579f1c5a83f10bee47df9ea93">vertgroup</a>) { <span class="comment">/* even this is a deprecated evil hack */</span>
<a name="l03288"></a>03288            <span class="comment">/* I&#39;d like to have it  .. if (sb-&gt;namedVG_Goal[0]) */</span>
<a name="l03289"></a>03289 
<a name="l03290"></a>03290             <a class="code" href="../../de/d32/softbody_8c.html#ac1ac925bf34ca5767d5335f5d508a066">get_scalar_from_vertexgroup</a>(ob, a,(<span class="keywordtype">short</span>) (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#acee97df579f1c5a83f10bee47df9ea93">vertgroup</a>-1), &amp;bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>);
<a name="l03291"></a>03291             <span class="comment">/* do this always, regardless successfull read from vertex group */</span>
<a name="l03292"></a>03292             <span class="comment">/* this is where &#39;2.5 every thing is animatable&#39; goes wrong in the first place jow_go_for2_5 */</span>
<a name="l03293"></a>03293             <span class="comment">/* 1st coding action to take : move this to frame level */</span>
<a name="l03294"></a>03294             <span class="comment">/* reads: leave the bp-&gt;goal as it was read from vertex group / or default .. we will need it at per frame call */</span>
<a name="l03295"></a>03295             <span class="comment">/* should be fixed for meshes */</span>
<a name="l03296"></a>03296             <span class="comment">// bp-&gt;goal= sb-&gt;mingoal + bp-&gt;goal*goalfac; /* do not do here jow_go_for2_5 */</span>
<a name="l03297"></a>03297         }
<a name="l03298"></a>03298         <span class="keywordflow">else</span> {
<a name="l03299"></a>03299             <span class="comment">/* in consequence if no group was set .. but we want to animate it laters */</span>
<a name="l03300"></a>03300             <span class="comment">/* logically attach to goal with default first */</span>
<a name="l03301"></a>03301             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) {bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a> = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a8c589742e3c220bc85a6c9b657138f5f">defgoal</a>;}
<a name="l03302"></a>03302         }
<a name="l03303"></a>03303 
<a name="l03304"></a>03304         <span class="comment">/* to proove the concept</span>
<a name="l03305"></a>03305 <span class="comment">        this enables per vertex *mass painting*</span>
<a name="l03306"></a>03306 <span class="comment">        */</span>
<a name="l03307"></a>03307 
<a name="l03308"></a>03308         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a6165e97190b9a84fa8c5390787e28d9d">namedVG_Mass</a>[0])
<a name="l03309"></a>03309         {
<a name="l03310"></a>03310             <span class="keywordtype">int</span> grp= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a> (ob,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a6165e97190b9a84fa8c5390787e28d9d">namedVG_Mass</a>);
<a name="l03311"></a>03311             <span class="comment">/* printf(&quot;VGN  %s %d\n&quot;,sb-&gt;namedVG_Mass,grp); */</span>
<a name="l03312"></a>03312             <span class="keywordflow">if</span> (grp &gt; -1) {
<a name="l03313"></a>03313                 <a class="code" href="../../de/d32/softbody_8c.html#ac1ac925bf34ca5767d5335f5d508a066">get_scalar_from_vertexgroup</a>(ob, a,(<span class="keywordtype">short</span>) (grp), &amp;bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a644f745a1260624d90b4ae4c0f6eb0f7">mass</a>);
<a name="l03314"></a>03314                 <span class="comment">/* 2.5  bp-&gt;mass = bp-&gt;mass * sb-&gt;nodemass; */</span>
<a name="l03315"></a>03315                 <span class="comment">/* printf(&quot;bp-&gt;mass  %f\n&quot;,bp-&gt;mass); */</span>
<a name="l03316"></a>03316 
<a name="l03317"></a>03317             }
<a name="l03318"></a>03318         }
<a name="l03319"></a>03319         <span class="comment">/* first set the default */</span>
<a name="l03320"></a>03320         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#afc21a074bcc7d58b2553d79dd260a7ac">springweight</a> = 1.0f;
<a name="l03321"></a>03321 
<a name="l03322"></a>03322         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a87622da515930ec874583abd09e9de87">namedVG_Spring_K</a>[0])
<a name="l03323"></a>03323         {
<a name="l03324"></a>03324             <span class="keywordtype">int</span> grp= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a> (ob,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a87622da515930ec874583abd09e9de87">namedVG_Spring_K</a>);
<a name="l03325"></a>03325             <span class="comment">//printf(&quot;VGN  %s %d\n&quot;,sb-&gt;namedVG_Spring_K,grp);</span>
<a name="l03326"></a>03326             <span class="keywordflow">if</span> (grp &gt; -1) {
<a name="l03327"></a>03327                 <a class="code" href="../../de/d32/softbody_8c.html#ac1ac925bf34ca5767d5335f5d508a066">get_scalar_from_vertexgroup</a>(ob, a,(<span class="keywordtype">short</span>) (grp), &amp;bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#afc21a074bcc7d58b2553d79dd260a7ac">springweight</a>);
<a name="l03328"></a>03328                 <span class="comment">//printf(&quot;bp-&gt;springweight  %f\n&quot;,bp-&gt;springweight);</span>
<a name="l03329"></a>03329 
<a name="l03330"></a>03330             }
<a name="l03331"></a>03331         }
<a name="l03332"></a>03332 
<a name="l03333"></a>03333 
<a name="l03334"></a>03334     }
<a name="l03335"></a>03335 
<a name="l03336"></a>03336     <span class="comment">/* but we only optionally add body edge springs */</span>
<a name="l03337"></a>03337     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l03338"></a>03338         <span class="keywordflow">if</span> (medge) {
<a name="l03339"></a>03339             bs= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>;
<a name="l03340"></a>03340             <span class="keywordflow">for</span> (a=me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>; a&gt;0; a--, medge++, bs++) {
<a name="l03341"></a>03341                 bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>;
<a name="l03342"></a>03342                 bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>;
<a name="l03343"></a>03343                 bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>;
<a name="l03344"></a>03344             }
<a name="l03345"></a>03345 
<a name="l03346"></a>03346 
<a name="l03347"></a>03347             <span class="comment">/* insert *diagonal* springs in quads if desired */</span>
<a name="l03348"></a>03348             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ab969ac232947bc1fdf1e34bb45b980d6">OB_SB_QUADS</a>) {
<a name="l03349"></a>03349                 <a class="code" href="../../de/d32/softbody_8c.html#a097fab750007df02f8f315c7daa6ebac">add_mesh_quad_diag_springs</a>(ob);
<a name="l03350"></a>03350             }
<a name="l03351"></a>03351 
<a name="l03352"></a>03352             <a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">build_bps_springlist</a>(ob); <span class="comment">/* scan for springs attached to bodypoints ONCE */</span>
<a name="l03353"></a>03353             <span class="comment">/* insert *other second order* springs if desired */</span>
<a name="l03354"></a>03354             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac79f442230e8c4cd283d0a89c7d6143c">secondspring</a> &gt; 0.0000001f) {
<a name="l03355"></a>03355                 <a class="code" href="../../de/d32/softbody_8c.html#aa1a669a9a2993da0f566e9beff3d85d1">add_2nd_order_springs</a>(ob,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac79f442230e8c4cd283d0a89c7d6143c">secondspring</a>); <span class="comment">/* exploits the the first run of build_bps_springlist(ob);*/</span>
<a name="l03356"></a>03356                 <a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">build_bps_springlist</a>(ob); <span class="comment">/* yes we need to do it again*/</span>
<a name="l03357"></a>03357             }
<a name="l03358"></a>03358             <a class="code" href="../../de/d32/softbody_8c.html#a4f6f86e5a2a3e529899e1d17fc1993e9">springs_from_mesh</a>(ob); <span class="comment">/* write the &#39;rest&#39;-length of the springs */</span>
<a name="l03359"></a>03359             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a34a60fd5c27a9f91d08d73ee08e7cf6f">OB_SB_SELF</a>) {<a class="code" href="../../de/d32/softbody_8c.html#a84abf9f72632506982228b9544e0aa00">calculate_collision_balls</a>(ob);}
<a name="l03360"></a>03360 
<a name="l03361"></a>03361         }
<a name="l03362"></a>03362 
<a name="l03363"></a>03363     }
<a name="l03364"></a>03364 
<a name="l03365"></a>03365 }
<a name="l03366"></a>03366 
<a name="l03367"></a><a class="code" href="../../de/d32/softbody_8c.html#a4793f56001fbdfd01ec8ef21dc865b3b">03367</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a4793f56001fbdfd01ec8ef21dc865b3b">mesh_faces_to_scratch</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03368"></a>03368 {
<a name="l03369"></a>03369     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03370"></a>03370     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03371"></a>03371     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l03372"></a>03372     <a class="code" href="../../dc/dc3/structBodyFace.html">BodyFace</a> *bodyface;
<a name="l03373"></a>03373     <span class="keywordtype">int</span> a;
<a name="l03374"></a>03374     <span class="comment">/* alloc and copy faces*/</span>
<a name="l03375"></a>03375 
<a name="l03376"></a>03376     bodyface = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/dc3/structBodyFace.html">BodyFace</a>)*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>,<span class="stringliteral">&quot;SB_body_Faces&quot;</span>);
<a name="l03377"></a>03377     <span class="comment">//memcpy(sb-&gt;scratch-&gt;mface,me-&gt;mface,sizeof(MFace)*me-&gt;totface);</span>
<a name="l03378"></a>03378     mface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l03379"></a>03379     <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a++, mface++, bodyface++) {
<a name="l03380"></a>03380         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a079b7774be9d3f80c95911d275c4cb80">v1</a> = mface-&gt;v1;
<a name="l03381"></a>03381         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a8381bc7d09f34b70bca4f4dc431244a9">v2</a> = mface-&gt;v2;
<a name="l03382"></a>03382         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a543d333ad9030c5b9288a38c78e12fee">v3</a> = mface-&gt;v3;
<a name="l03383"></a>03383         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a535f3222bcf694bab02af63ff4753df6">v4</a> = mface-&gt;v4;
<a name="l03384"></a>03384         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[0] = bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[1] = bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a9624d98e29dc8fcd75fa2b83b338f2fe">ext_force</a>[2] = 0.0f;
<a name="l03385"></a>03385         bodyface-&gt;<a class="code" href="../../dc/dc3/structBodyFace.html#a4331575e662087c4443415535ef900a7">flag</a> =0;
<a name="l03386"></a>03386     }
<a name="l03387"></a>03387     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a> = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>;
<a name="l03388"></a>03388 }
<a name="l03389"></a><a class="code" href="../../de/d32/softbody_8c.html#adfc59743e346b737a4353915753a67b8">03389</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#adfc59743e346b737a4353915753a67b8">reference_to_scratch</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03390"></a>03390 {
<a name="l03391"></a>03391     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03392"></a>03392     <a class="code" href="../../dc/dce/structReferenceVert.html">ReferenceVert</a> *rp;
<a name="l03393"></a>03393     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a>     *bp;
<a name="l03394"></a>03394     <span class="keywordtype">float</span> accu_pos[3] ={0.f,0.f,0.f};
<a name="l03395"></a>03395     <span class="keywordtype">float</span> accu_mass = 0.f;
<a name="l03396"></a>03396     <span class="keywordtype">int</span> a;
<a name="l03397"></a>03397 
<a name="l03398"></a>03398     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/dce/structReferenceVert.html">ReferenceVert</a>)*sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>,<span class="stringliteral">&quot;SB_Reference&quot;</span>);
<a name="l03399"></a>03399     bp= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03400"></a>03400     rp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a>;
<a name="l03401"></a>03401     <span class="keywordflow">for</span> (a=0; a&lt;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>; a++, rp++, bp++) {
<a name="l03402"></a>03402         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rp-&gt;pos,bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03403"></a>03403         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(accu_pos, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03404"></a>03404         accu_mass += <a class="code" href="../../de/d32/softbody_8c.html#a46c717128d703b90d7f71ddd26367f0a">_final_mass</a>(ob,bp);
<a name="l03405"></a>03405     }
<a name="l03406"></a>03406     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(accu_pos,1.0f/accu_mass);
<a name="l03407"></a>03407     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#a7407884b376a24e61e834483dc30963c">com</a>,accu_pos);
<a name="l03408"></a>03408     <span class="comment">/* printf(&quot;reference_to_scratch\n&quot;); */</span>
<a name="l03409"></a>03409 }
<a name="l03410"></a>03410 
<a name="l03411"></a>03411 <span class="comment">/*</span>
<a name="l03412"></a>03412 <span class="comment">helper function to get proper spring length</span>
<a name="l03413"></a>03413 <span class="comment">when object is rescaled</span>
<a name="l03414"></a>03414 <span class="comment">*/</span>
<a name="l03415"></a><a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">03415</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>(<span class="keywordtype">float</span> *v1,<span class="keywordtype">float</span> *v2,<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03416"></a>03416 {
<a name="l03417"></a>03417     <span class="keywordtype">float</span> p1[3],p2[3];
<a name="l03418"></a>03418     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p1,v1);
<a name="l03419"></a>03419     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, p1);
<a name="l03420"></a>03420     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p2,v2);
<a name="l03421"></a>03421     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, p2);
<a name="l03422"></a>03422     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(p1,p2);
<a name="l03423"></a>03423 }
<a name="l03424"></a>03424 
<a name="l03425"></a><a class="code" href="../../de/d32/softbody_8c.html#ada5fa2886a3e189d250ebf6e177774bf">03425</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ada5fa2886a3e189d250ebf6e177774bf">makelatticesprings</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt, <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs, <span class="keywordtype">int</span> dostiff,<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03426"></a>03426 {
<a name="l03427"></a>03427     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>, *bpu;
<a name="l03428"></a>03428     <span class="keywordtype">int</span> u, v, w, dv, dw, bpc=0, bpuc;
<a name="l03429"></a>03429 
<a name="l03430"></a>03430     dv= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>;
<a name="l03431"></a>03431     dw= dv*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>;
<a name="l03432"></a>03432 
<a name="l03433"></a>03433     <span class="keywordflow">for</span> (w=0; w&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>; w++) {
<a name="l03434"></a>03434 
<a name="l03435"></a>03435         <span class="keywordflow">for</span> (v=0; v&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>; v++) {
<a name="l03436"></a>03436 
<a name="l03437"></a>03437             <span class="keywordflow">for</span> (u=0, bpuc=0, bpu=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; u&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>; u++, bp++, bpc++) {
<a name="l03438"></a>03438 
<a name="l03439"></a>03439                 <span class="keywordflow">if</span> (w) {
<a name="l03440"></a>03440                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03441"></a>03441                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc-dw;
<a name="l03442"></a>03442                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>;
<a name="l03443"></a>03443                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp-dw)-&gt;vec, bp-&gt;vec,ob);
<a name="l03444"></a>03444                     bs++;
<a name="l03445"></a>03445                 }
<a name="l03446"></a>03446                 <span class="keywordflow">if</span> (v) {
<a name="l03447"></a>03447                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03448"></a>03448                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc-dv;
<a name="l03449"></a>03449                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>;
<a name="l03450"></a>03450                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp-dv)-&gt;vec, bp-&gt;vec,ob);
<a name="l03451"></a>03451                     bs++;
<a name="l03452"></a>03452                 }
<a name="l03453"></a>03453                 <span class="keywordflow">if</span> (u) {
<a name="l03454"></a>03454                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpuc;
<a name="l03455"></a>03455                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc;
<a name="l03456"></a>03456                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>;
<a name="l03457"></a>03457                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bpu)-&gt;vec, bp-&gt;vec,ob);
<a name="l03458"></a>03458                     bs++;
<a name="l03459"></a>03459                 }
<a name="l03460"></a>03460 
<a name="l03461"></a>03461                 <span class="keywordflow">if</span> (dostiff) {
<a name="l03462"></a>03462 
<a name="l03463"></a>03463                     <span class="keywordflow">if</span> (w) {
<a name="l03464"></a>03464                         <span class="keywordflow">if</span> ( v &amp;&amp; u ) {
<a name="l03465"></a>03465                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03466"></a>03466                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc-dw-dv-1;
<a name="l03467"></a>03467                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l03468"></a>03468                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp-dw-dv-1)-&gt;vec, bp-&gt;vec,ob);
<a name="l03469"></a>03469                             bs++;
<a name="l03470"></a>03470                         }
<a name="l03471"></a>03471                         <span class="keywordflow">if</span> ( (v &lt; lt-&gt;pntsv-1) &amp;&amp; (u != 0) ) {
<a name="l03472"></a>03472                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03473"></a>03473                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc-dw+dv-1;
<a name="l03474"></a>03474                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l03475"></a>03475                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp-dw+dv-1)-&gt;vec, bp-&gt;vec,ob);
<a name="l03476"></a>03476                             bs++;
<a name="l03477"></a>03477                         }
<a name="l03478"></a>03478                     }
<a name="l03479"></a>03479 
<a name="l03480"></a>03480                     <span class="keywordflow">if</span> (w &lt; lt-&gt;pntsw -1) {
<a name="l03481"></a>03481                         <span class="keywordflow">if</span> ( v &amp;&amp; u ) {
<a name="l03482"></a>03482                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03483"></a>03483                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc+dw-dv-1;
<a name="l03484"></a>03484                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l03485"></a>03485                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp+dw-dv-1)-&gt;vec, bp-&gt;vec,ob);
<a name="l03486"></a>03486                             bs++;
<a name="l03487"></a>03487                         }
<a name="l03488"></a>03488                         <span class="keywordflow">if</span> ( (v &lt; lt-&gt;pntsv-1) &amp;&amp; (u != 0) ) {
<a name="l03489"></a>03489                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a> = bpc;
<a name="l03490"></a>03490                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a> = bpc+dw+dv-1;
<a name="l03491"></a>03491                             bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a3303861a73f8adc836955c3e2a8ced66">SB_BEND</a>;
<a name="l03492"></a>03492                              bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>((bp+dw+dv-1)-&gt;vec, bp-&gt;vec,ob);
<a name="l03493"></a>03493                             bs++;
<a name="l03494"></a>03494                         }
<a name="l03495"></a>03495                     }
<a name="l03496"></a>03496                 }
<a name="l03497"></a>03497                 bpu = bp;
<a name="l03498"></a>03498                 bpuc = bpc;
<a name="l03499"></a>03499             }
<a name="l03500"></a>03500         }
<a name="l03501"></a>03501     }
<a name="l03502"></a>03502 }
<a name="l03503"></a>03503 
<a name="l03504"></a>03504 
<a name="l03505"></a>03505 <span class="comment">/* makes totally fresh start situation */</span>
<a name="l03506"></a><a class="code" href="../../de/d32/softbody_8c.html#add8b956e51b0849906f5c360675db825">03506</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#add8b956e51b0849906f5c360675db825">lattice_to_softbody</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03507"></a>03507 {
<a name="l03508"></a>03508     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03509"></a>03509     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l03510"></a>03510     <span class="keywordtype">int</span> totvert, totspring = 0;
<a name="l03511"></a>03511 
<a name="l03512"></a>03512     totvert= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l03513"></a>03513 
<a name="l03514"></a>03514     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l03515"></a>03515         totspring = ((lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> -1) * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>
<a name="l03516"></a>03516                   + (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> -1) * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>) * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>
<a name="l03517"></a>03517                   +lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a> -1);
<a name="l03518"></a>03518         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ab969ac232947bc1fdf1e34bb45b980d6">OB_SB_QUADS</a>) {
<a name="l03519"></a>03519             totspring += 4*(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> -1) *  (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> -1)  * (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1);
<a name="l03520"></a>03520         }
<a name="l03521"></a>03521     }
<a name="l03522"></a>03522 
<a name="l03523"></a>03523 
<a name="l03524"></a>03524     <span class="comment">/* renew ends with ob-&gt;soft with points and edges, also checks &amp; makes ob-&gt;soft */</span>
<a name="l03525"></a>03525     <a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">renew_softbody</a>(scene, ob, totvert, totspring);
<a name="l03526"></a>03526     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;   <span class="comment">/* can be created in renew_softbody() */</span>
<a name="l03527"></a>03527 
<a name="l03528"></a>03528     <span class="comment">/* weights from bpoints, same code used as for mesh vertices */</span>
<a name="l03529"></a>03529     <span class="comment">/* if ((ob-&gt;softflag &amp; OB_SB_GOAL) &amp;&amp; sb-&gt;vertgroup) { 2.4x one*/</span>
<a name="l03530"></a>03530     <span class="comment">/* new! take the weights from lattice vertex anyhow */</span>
<a name="l03531"></a>03531     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>) {
<a name="l03532"></a>03532         <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03533"></a>03533         <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bpnt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l03534"></a>03534         <span class="comment">/* jow_go_for2_5 */</span>
<a name="l03535"></a>03535         <span class="keywordtype">int</span> a;
<a name="l03536"></a>03536 
<a name="l03537"></a>03537         <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++, bp++, bpnt++) {
<a name="l03538"></a>03538             bp-&gt;goal= bpnt-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a35879465825fbbab506bf4ccf2bbd8c2">weight</a>;
<a name="l03539"></a>03539         }
<a name="l03540"></a>03540     }
<a name="l03541"></a>03541 
<a name="l03542"></a>03542     <span class="comment">/* create some helper edges to enable SB lattice to be useful at all */</span>
<a name="l03543"></a>03543     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l03544"></a>03544         <a class="code" href="../../de/d32/softbody_8c.html#ada5fa2886a3e189d250ebf6e177774bf">makelatticesprings</a>(lt,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ab969ac232947bc1fdf1e34bb45b980d6">OB_SB_QUADS</a>,ob);
<a name="l03545"></a>03545         <a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">build_bps_springlist</a>(ob); <span class="comment">/* link bps to springs */</span>
<a name="l03546"></a>03546     }
<a name="l03547"></a>03547 }
<a name="l03548"></a>03548 
<a name="l03549"></a>03549 <span class="comment">/* makes totally fresh start situation */</span>
<a name="l03550"></a><a class="code" href="../../de/d32/softbody_8c.html#a5abdfb4d5a6225b96d6aea4d8fdf5bc2">03550</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a5abdfb4d5a6225b96d6aea4d8fdf5bc2">curve_surf_to_softbody</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03551"></a>03551 {
<a name="l03552"></a>03552     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03553"></a>03553     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l03554"></a>03554     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03555"></a>03555     <a class="code" href="../../d0/d23/structBodySpring.html">BodySpring</a> *bs;
<a name="l03556"></a>03556     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l03557"></a>03557     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l03558"></a>03558     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bpnt;
<a name="l03559"></a>03559     <span class="keywordtype">int</span> a, <a class="code" href="../../d2/d6c/mball_8c.html#aa0aed51016f3947bd4956c5742df8f20">curindex</a>=0;
<a name="l03560"></a>03560     <span class="keywordtype">int</span> totvert, totspring = 0, setgoal=0;
<a name="l03561"></a>03561 
<a name="l03562"></a>03562     totvert= <a class="code" href="../../d7/dfc/BKE__curve_8h.html#acbc43d8687324817662e3f0e713b514a">count_curveverts</a>(&amp;cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>);
<a name="l03563"></a>03563 
<a name="l03564"></a>03564     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) {
<a name="l03565"></a>03565         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>) {
<a name="l03566"></a>03566             totspring= totvert - <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>);
<a name="l03567"></a>03567         }
<a name="l03568"></a>03568     }
<a name="l03569"></a>03569 
<a name="l03570"></a>03570     <span class="comment">/* renew ends with ob-&gt;soft with points and edges, also checks &amp; makes ob-&gt;soft */</span>
<a name="l03571"></a>03571     <a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">renew_softbody</a>(scene, ob, totvert, totspring);
<a name="l03572"></a>03572     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;   <span class="comment">/* can be created in renew_softbody() */</span>
<a name="l03573"></a>03573 
<a name="l03574"></a>03574     <span class="comment">/* set vars now */</span>
<a name="l03575"></a>03575     bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03576"></a>03576     bs= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a>;
<a name="l03577"></a>03577 
<a name="l03578"></a>03578     <span class="comment">/* weights from bpoints, same code used as for mesh vertices */</span>
<a name="l03579"></a>03579     <span class="comment">/* if ((ob-&gt;softflag &amp; OB_SB_GOAL) &amp;&amp; sb-&gt;vertgroup) 2.4x hack*/</span>
<a name="l03580"></a>03580     <span class="comment">/* new! take the weights from curve vertex anyhow */</span>
<a name="l03581"></a>03581     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a465b6849fc4ae03345b964618cdae9ac">OB_SB_GOAL</a>)
<a name="l03582"></a>03582         setgoal= 1;
<a name="l03583"></a>03583 
<a name="l03584"></a>03584     <span class="keywordflow">for</span> (nu= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu= nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>) {
<a name="l03585"></a>03585         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l03586"></a>03586             <span class="comment">/* bezier case ; this is nicly said naive; who ever wrote this part, it was not me (JOW) :) */</span>
<a name="l03587"></a>03587             <span class="comment">/* a: never ever make tangent handles (sub) and or (ob)ject to collision */</span>
<a name="l03588"></a>03588             <span class="comment">/* b: rather calculate them using some C2 (C2= continuous in second derivate -&gt; no jump in bending ) condition */</span>
<a name="l03589"></a>03589             <span class="comment">/* not too hard to do, but needs some more code to care for;  some one may want look at it  JOW 2010/06/12*/</span>
<a name="l03590"></a>03590             <span class="keywordflow">for</span> (bezt=nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>, a=0; a&lt;nu-&gt;pntsu; a++, bezt++, bp+=3, curindex+=3) {
<a name="l03591"></a>03591                 <span class="keywordflow">if</span> (setgoal) {
<a name="l03592"></a>03592                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad23314941e5bb9f62166fb79d623d2c3">weight</a>;
<a name="l03593"></a>03593 
<a name="l03594"></a>03594                     <span class="comment">/* all three triples */</span>
<a name="l03595"></a>03595                     (bp+1)-&gt;goal= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>;
<a name="l03596"></a>03596                     (bp+2)-&gt;goal= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>;
<a name="l03597"></a>03597                     <span class="comment">/*do not collide handles */</span>
<a name="l03598"></a>03598                     (bp+1)-&gt;loc_flag |= <a class="code" href="../../de/d32/softbody_8c.html#a19a9fdce0834aa221dc2323dde0cdef2">SBF_OUTOFCOLLISION</a>;
<a name="l03599"></a>03599                     (bp+2)-&gt;loc_flag |= <a class="code" href="../../de/d32/softbody_8c.html#a19a9fdce0834aa221dc2323dde0cdef2">SBF_OUTOFCOLLISION</a>;
<a name="l03600"></a>03600                 }
<a name="l03601"></a>03601 
<a name="l03602"></a>03602                 <span class="keywordflow">if</span> (totspring) {
<a name="l03603"></a>03603                     <span class="keywordflow">if</span> (a&gt;0) {
<a name="l03604"></a>03604                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= curindex-3;
<a name="l03605"></a>03605                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= <a class="code" href="../../d2/d6c/mball_8c.html#aa0aed51016f3947bd4956c5742df8f20">curindex</a>;
<a name="l03606"></a>03606                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a8c9816ecf0483be51e19f5c4d91fae89">SB_HANDLE</a>;
<a name="l03607"></a>03607                         bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>( (bezt-1)-&gt;vec[0], bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0], ob );
<a name="l03608"></a>03608                         bs++;
<a name="l03609"></a>03609                     }
<a name="l03610"></a>03610                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= <a class="code" href="../../d2/d6c/mball_8c.html#aa0aed51016f3947bd4956c5742df8f20">curindex</a>;
<a name="l03611"></a>03611                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= curindex+1;
<a name="l03612"></a>03612                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a8c9816ecf0483be51e19f5c4d91fae89">SB_HANDLE</a>;
<a name="l03613"></a>03613                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0], bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1], ob);
<a name="l03614"></a>03614                     bs++;
<a name="l03615"></a>03615 
<a name="l03616"></a>03616                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= curindex+1;
<a name="l03617"></a>03617                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= curindex+2;
<a name="l03618"></a>03618                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898a8c9816ecf0483be51e19f5c4d91fae89">SB_HANDLE</a>;
<a name="l03619"></a>03619                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1], bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2], ob);
<a name="l03620"></a>03620                     bs++;
<a name="l03621"></a>03621                 }
<a name="l03622"></a>03622             }
<a name="l03623"></a>03623         }
<a name="l03624"></a>03624         <span class="keywordflow">else</span> {
<a name="l03625"></a>03625             <span class="keywordflow">for</span> (bpnt=nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>, a=0; a&lt;nu-&gt;pntsu*nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>; a++, bpnt++, bp++, curindex++) {
<a name="l03626"></a>03626                 <span class="keywordflow">if</span> (setgoal) {
<a name="l03627"></a>03627                     bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a52035f4cf70afdd87f8c8075bb22cb8a">goal</a>= bpnt-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a35879465825fbbab506bf4ccf2bbd8c2">weight</a>;
<a name="l03628"></a>03628                 }
<a name="l03629"></a>03629                 <span class="keywordflow">if</span> (totspring &amp;&amp; a&gt;0) {
<a name="l03630"></a>03630                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a89bdc41b5b98888f6706743846893138">v1</a>= curindex-1;
<a name="l03631"></a>03631                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#aff15cb1f731b006e64f81e7847dd2a9f">v2</a>= <a class="code" href="../../d2/d6c/mball_8c.html#aa0aed51016f3947bd4956c5742df8f20">curindex</a>;
<a name="l03632"></a>03632                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a01f1d62b8e7cc00122b3faad3418225a">springtype</a>=<a class="code" href="../../de/d32/softbody_8c.html#a746404039e875e1d7dc70be846a9d898aa87b016187b1fa5a30abc310827bbc66">SB_EDGE</a>;
<a name="l03633"></a>03633                     bs-&gt;<a class="code" href="../../d0/d23/structBodySpring.html#a23bce8d5da5d1492ebfff5b63d578d5d">len</a>= <a class="code" href="../../de/d32/softbody_8c.html#aa01fceaa0ad71e1675fa16fb13333161">globallen</a>( (bpnt-1)-&gt;vec, bpnt-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a> , ob );
<a name="l03634"></a>03634                     bs++;
<a name="l03635"></a>03635                 }
<a name="l03636"></a>03636             }
<a name="l03637"></a>03637         }
<a name="l03638"></a>03638     }
<a name="l03639"></a>03639 
<a name="l03640"></a>03640     <span class="keywordflow">if</span> (totspring)
<a name="l03641"></a>03641     {
<a name="l03642"></a>03642         <a class="code" href="../../de/d32/softbody_8c.html#a84dd7dac0bd4d7e592e0b6f5af7fa798">build_bps_springlist</a>(ob); <span class="comment">/* link bps to springs */</span>
<a name="l03643"></a>03643         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a34a60fd5c27a9f91d08d73ee08e7cf6f">OB_SB_SELF</a>) {<a class="code" href="../../de/d32/softbody_8c.html#a84abf9f72632506982228b9544e0aa00">calculate_collision_balls</a>(ob);}
<a name="l03644"></a>03644     }
<a name="l03645"></a>03645 }
<a name="l03646"></a>03646 
<a name="l03647"></a>03647 <span class="comment">/* copies softbody result back in object */</span>
<a name="l03648"></a><a class="code" href="../../de/d32/softbody_8c.html#aa033db58d2bccf1d1b4d9ceaf324c2b8">03648</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#aa033db58d2bccf1d1b4d9ceaf324c2b8">softbody_to_object</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts, <span class="keywordtype">int</span> local)
<a name="l03649"></a>03649 {
<a name="l03650"></a>03650     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03651"></a>03651     <span class="keywordflow">if</span> (sb) {
<a name="l03652"></a>03652         <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>;
<a name="l03653"></a>03653         <span class="keywordtype">int</span> a;
<a name="l03654"></a>03654         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a791f3e0c8e047b862fb7e9d6128b827e">SBSO_ESTIMATEIPO</a>) {<a class="code" href="../../d6/df9/BKE__softbody_8h.html#acf285f6022a156a0e2aa8d4946afa354">SB_estimate_transform</a>(ob,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac92f71d4bd70e214d43b836420243fe5">lcom</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a23a432fb40494aed3960b89ecbedd956">lrot</a>,sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a212f6d8277fdf733a09e9a38b51a67cb">lscale</a>);}
<a name="l03655"></a>03655         <span class="comment">/* inverse matrix is not uptodate... */</span>
<a name="l03656"></a>03656         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03657"></a>03657 
<a name="l03658"></a>03658         <span class="keywordflow">for</span> (a=0; a&lt;numVerts; a++, bp++) {
<a name="l03659"></a>03659             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[a], bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03660"></a>03660             <span class="keywordflow">if</span> (local==0)
<a name="l03661"></a>03661                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, vertexCos[a]);  <span class="comment">/* softbody is in global coords, baked optionally not */</span>
<a name="l03662"></a>03662         }
<a name="l03663"></a>03663     }
<a name="l03664"></a>03664 }
<a name="l03665"></a>03665 
<a name="l03666"></a>03666 <span class="comment">/* +++ ************ maintaining scratch *************** */</span>
<a name="l03667"></a><a class="code" href="../../de/d32/softbody_8c.html#ac81622a96f31b5b8e1aae3314016af41">03667</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#ac81622a96f31b5b8e1aae3314016af41">sb_new_scratch</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l03668"></a>03668 {
<a name="l03669"></a>03669     <span class="keywordflow">if</span> (!sb) <span class="keywordflow">return</span>;
<a name="l03670"></a>03670     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/dbb/structSBScratch.html">SBScratch</a>), <span class="stringliteral">&quot;SBScratch&quot;</span>);
<a name="l03671"></a>03671     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>,<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;sb_new_scratch gh&quot;</span>);
<a name="l03672"></a>03672     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#ad4125e284b698f0e37e8edcdbe156d10">bodyface</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03673"></a>03673     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a69fc37db4a3a704f13936113973c3823">totface</a> = 0;
<a name="l03674"></a>03674     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>[0]=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>[1]=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#acd1c939e4f653f7160a24c6d3f518b8f">aabbmax</a>[2] = 1.0e30f;
<a name="l03675"></a>03675     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>[0]=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>[1]=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a1734b7d6fa326b19a107d2a57577df63">aabbmin</a>[2] = -1.0e30f;
<a name="l03676"></a>03676     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03677"></a>03677 
<a name="l03678"></a>03678 }
<a name="l03679"></a>03679 <span class="comment">/* --- ************ maintaining scratch *************** */</span>
<a name="l03680"></a>03680 
<a name="l03681"></a>03681 <span class="comment">/* ************ Object level, exported functions *************** */</span>
<a name="l03682"></a>03682 
<a name="l03683"></a>03683 <span class="comment">/* allocates and initializes general main data */</span>
<a name="l03684"></a><a class="code" href="../../de/d32/softbody_8c.html#a5683665b3b6d0ccd532cc53b69e6f876">03684</a> <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *<a class="code" href="../../d6/df9/BKE__softbody_8h.html#a0610f8307bacb60965232adcaa958462">sbNew</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l03685"></a>03685 {
<a name="l03686"></a>03686     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb;
<a name="l03687"></a>03687 
<a name="l03688"></a>03688     sb= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a>), <span class="stringliteral">&quot;softbody&quot;</span>);
<a name="l03689"></a>03689 
<a name="l03690"></a>03690     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ae1c8eb710553fda9e0d8b72b998d39b8">mediafrict</a>= 0.5f;
<a name="l03691"></a>03691     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac71d20275479b402b8fe5e65a372a693">nodemass</a>= 1.0f;
<a name="l03692"></a>03692     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aa6e2e4f44e92c16170dedf74885fbf65">grav</a>= 9.8f;
<a name="l03693"></a>03693     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a51a881ede8746efc91ae434a7cab9343">physics_speed</a>= 1.0f;
<a name="l03694"></a>03694     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a25dfcdfbaff3161bd18d996e930bd16c">rklimit</a>= 0.1f;
<a name="l03695"></a>03695 
<a name="l03696"></a>03696     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac2f901181797d07793216521c4a14372">goalspring</a>= 0.5f;
<a name="l03697"></a>03697     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a552f85542071602e7bf8b074a0f58e01">goalfrict</a>= 0.0f;
<a name="l03698"></a>03698     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a18b016b42ae8a7671f3fbfe29c22be62">mingoal</a>= 0.0f;
<a name="l03699"></a>03699     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac0f3579baac5264494f71fb725540433">maxgoal</a>= 1.0f;
<a name="l03700"></a>03700     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a8c589742e3c220bc85a6c9b657138f5f">defgoal</a>= 0.7f;
<a name="l03701"></a>03701 
<a name="l03702"></a>03702     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a612832359b1890ea4cc58fd8fd6c9d2e">inspring</a>= 0.5f;
<a name="l03703"></a>03703     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab1f6ada4f012c3a90fdddfc0ca12c57a">infrict</a>= 0.5f;
<a name="l03704"></a>03704     <span class="comment">/*todo backward file compat should copy inspring to inpush while reading old files*/</span>
<a name="l03705"></a>03705     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a57a14bd65c23078ed83859a5d0d33b3f">inpush</a> = 0.5f;
<a name="l03706"></a>03706 
<a name="l03707"></a>03707     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a351d7a4918827ed45e707a70f6eeeac5">interval</a>= 10;
<a name="l03708"></a>03708     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a6f391b1b8c35dffcf8bfabeedcd6cf72">sfra</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a97f52582406befb3dba13b121d886526">sfra</a>;
<a name="l03709"></a>03709     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aeab54dd692cac376d1341193b3f2a12f">efra</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>;
<a name="l03710"></a>03710 
<a name="l03711"></a>03711     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#aed30ecec61126c294c8d7460de70963c">colball</a>  = 0.49f;
<a name="l03712"></a>03712     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#add3729cf46d13a2e4725d265d0d97852">balldamp</a> = 0.50f;
<a name="l03713"></a>03713     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ad506fe70b16ff5b653cb8d9ee7ce6486">ballstiff</a>= 1.0f;
<a name="l03714"></a>03714     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a420e61301b19e68f92c555bc534cff4b">sbc_mode</a> = 1;
<a name="l03715"></a>03715 
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a19ea9822587f3c9557bf846cdd7030aa">minloops</a> = 10;
<a name="l03718"></a>03718     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ada85676c1dfdd5d54d3e37074926eb67">maxloops</a> = 300;
<a name="l03719"></a>03719 
<a name="l03720"></a>03720     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ab8b0036c0478a99fa960a3f8b0a579ce">choke</a> = 3;
<a name="l03721"></a>03721     <a class="code" href="../../de/d32/softbody_8c.html#ac81622a96f31b5b8e1aae3314016af41">sb_new_scratch</a>(sb);
<a name="l03722"></a>03722     <span class="comment">/*todo backward file compat should set sb-&gt;shearstiff = 1.0f while reading old files*/</span>
<a name="l03723"></a>03723     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a9fdde7ead243fec0004fc4847a3358e6">shearstiff</a> = 1.0f;
<a name="l03724"></a>03724     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#aeedfb02f05eea7aae50dd4512f0f8912">SBSO_OLDERR</a>;
<a name="l03725"></a>03725 
<a name="l03726"></a>03726     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3cbaa712cbb0289db746f8dbfb34f1bb">pointcache</a> = <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaa30cc8980cfa020b23b61066cda11e1">BKE_ptcache_add</a>(&amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2b4fe2801e797119094ffa33d7a92d59">ptcaches</a>);
<a name="l03727"></a>03727 
<a name="l03728"></a>03728     <span class="keywordflow">if</span> (!sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>)
<a name="l03729"></a>03729         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a> = <a class="code" href="../../dc/d65/BKE__effect_8h.html#ad0116e11e09f0615cc817f48a9557e85">BKE_add_effector_weights</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03730"></a>03730 
<a name="l03731"></a>03731     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0fa3b0edbc7324d597db8410a5f0b097">MINFRAME</a>-1;
<a name="l03732"></a>03732 
<a name="l03733"></a>03733     <span class="keywordflow">return</span> sb;
<a name="l03734"></a>03734 }
<a name="l03735"></a>03735 
<a name="l03736"></a>03736 <span class="comment">/* frees all */</span>
<a name="l03737"></a><a class="code" href="../../de/d32/softbody_8c.html#a34a838b9f72767a813c6ac2c298ea60e">03737</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#ac796cb7991daed1fc65d8c59c38cd085">sbFree</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l03738"></a>03738 {
<a name="l03739"></a>03739     <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(sb);
<a name="l03740"></a>03740     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acd668a903f7dc38eabb18e0c44677c0d">BKE_ptcache_free_list</a>(&amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2b4fe2801e797119094ffa33d7a92d59">ptcaches</a>);
<a name="l03741"></a>03741     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3cbaa712cbb0289db746f8dbfb34f1bb">pointcache</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03742"></a>03742     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>)
<a name="l03743"></a>03743         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a75f48a73a6ed8226e7942be5cbf15c65">effector_weights</a>);
<a name="l03744"></a>03744     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sb);
<a name="l03745"></a>03745 }
<a name="l03746"></a>03746 
<a name="l03747"></a><a class="code" href="../../de/d32/softbody_8c.html#ab7788aa02051cc93298c035e140784e9">03747</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#aa5b390987e39edfd5bd9269e9a1e5dd1">sbFreeSimulation</a>(<a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l03748"></a>03748 {
<a name="l03749"></a>03749     <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(sb);
<a name="l03750"></a>03750 }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752 <span class="comment">/* makes totally fresh start situation */</span>
<a name="l03753"></a><a class="code" href="../../de/d32/softbody_8c.html#a532ade435b519fd3bc354d73d604166d">03753</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#a2b23330c332ae6decb6c732815649bcf">sbObjectToSoftbody</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03754"></a>03754 {
<a name="l03755"></a>03755     <span class="comment">//ob-&gt;softflag |= OB_SB_REDO;</span>
<a name="l03756"></a>03756 
<a name="l03757"></a>03757     <a class="code" href="../../de/d32/softbody_8c.html#aab1b16ac9e51737412941ed5d3677f8e">free_softbody_intern</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>);
<a name="l03758"></a>03758 }
<a name="l03759"></a>03759 
<a name="l03760"></a><a class="code" href="../../de/d32/softbody_8c.html#a8e4bec60810728db4134d3c9d70f2d94">03760</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d32/softbody_8c.html#a8e4bec60810728db4134d3c9d70f2d94">object_has_edges</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03761"></a>03761 {
<a name="l03762"></a>03762     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l03763"></a>03763         <span class="keywordflow">return</span> ((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*) ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;totedge;
<a name="l03764"></a>03764     }
<a name="l03765"></a>03765     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l03766"></a>03766         <span class="keywordflow">return</span> 1;
<a name="l03767"></a>03767     }
<a name="l03768"></a>03768     <span class="keywordflow">else</span> {
<a name="l03769"></a>03769         <span class="keywordflow">return</span> 0;
<a name="l03770"></a>03770     }
<a name="l03771"></a>03771 }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773 <span class="comment">/* SB global visible functions */</span>
<a name="l03774"></a><a class="code" href="../../de/d32/softbody_8c.html#acff8bdce585af771bcb2ce584ac8e916">03774</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#acff8bdce585af771bcb2ce584ac8e916">sbSetInterruptCallBack</a>(<span class="keywordtype">int</span> (*f)(<span class="keywordtype">void</span>))
<a name="l03775"></a>03775 {
<a name="l03776"></a>03776     <a class="code" href="../../de/d32/softbody_8c.html#a1c4f502d7dcd9d7d80abdfb487c520e4">SB_localInterruptCallBack</a> = f;
<a name="l03777"></a>03777 }
<a name="l03778"></a>03778 
<a name="l03779"></a><a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">03779</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">softbody_update_positions</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb, <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l03780"></a>03780 {
<a name="l03781"></a>03781     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03782"></a>03782     <span class="keywordtype">int</span> a;
<a name="l03783"></a>03783 
<a name="l03784"></a>03784     <span class="keywordflow">if</span> (!sb || !sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>)
<a name="l03785"></a>03785         <span class="keywordflow">return</span>;
<a name="l03786"></a>03786 
<a name="l03787"></a>03787     <span class="keywordflow">for</span> (a=0,bp=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&lt;numVerts; a++, bp++) {
<a name="l03788"></a>03788         <span class="comment">/* store where goals are now */</span>
<a name="l03789"></a>03789         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>);
<a name="l03790"></a>03790         <span class="comment">/* copy the position of the goals at desired end time */</span>
<a name="l03791"></a>03791         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>, vertexCos[a]);
<a name="l03792"></a>03792         <span class="comment">/* vertexCos came from local world, go global */</span>
<a name="l03793"></a>03793         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>);
<a name="l03794"></a>03794         <span class="comment">/* just to be save give bp-&gt;origT a defined value</span>
<a name="l03795"></a>03795 <span class="comment">        will be calulated in interpolate_exciter()*/</span>
<a name="l03796"></a>03796         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>);
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798 }
<a name="l03799"></a>03799 
<a name="l03800"></a>03800 
<a name="l03801"></a>03801 <span class="comment">/* void SB_estimate_transform */</span>
<a name="l03802"></a>03802 <span class="comment">/* input   Object *ob out (says any object that can do SB like mesh,lattice,curve )</span>
<a name="l03803"></a>03803 <span class="comment"> * output  float lloc[3],float lrot[3][3],float lscale[3][3]</span>
<a name="l03804"></a>03804 <span class="comment"> * that is:</span>
<a name="l03805"></a>03805 <span class="comment"> * a precise position vector denoting the motion of the center of mass</span>
<a name="l03806"></a>03806 <span class="comment"> * give a rotation/scale matrix using averaging method, that&#39;s why estimate and not calculate</span>
<a name="l03807"></a>03807 <span class="comment"> * see: this is kind of reverse engeneering: having to states of a point cloud and recover what happend</span>
<a name="l03808"></a>03808 <span class="comment"> * our advantage here we know the identity of the vertex</span>
<a name="l03809"></a>03809 <span class="comment"> * there are others methods giving other results.</span>
<a name="l03810"></a>03810 <span class="comment"> * lloc,lrot,lscale are allowed to be NULL, just in case you don&#39;t need it.</span>
<a name="l03811"></a>03811 <span class="comment"> * should be pretty useful for pythoneers :)</span>
<a name="l03812"></a>03812 <span class="comment"> * not! velocity .. 2nd order stuff</span>
<a name="l03813"></a>03813 <span class="comment"> * vcloud_estimate_transform see</span>
<a name="l03814"></a>03814 <span class="comment"> */</span>
<a name="l03815"></a>03815 
<a name="l03816"></a><a class="code" href="../../de/d32/softbody_8c.html#acf285f6022a156a0e2aa8d4946afa354">03816</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#acf285f6022a156a0e2aa8d4946afa354">SB_estimate_transform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob,<span class="keywordtype">float</span> lloc[3],<span class="keywordtype">float</span> lrot[3][3],<span class="keywordtype">float</span> lscale[3][3])
<a name="l03817"></a>03817 {
<a name="l03818"></a>03818     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03819"></a>03819     <a class="code" href="../../dc/dce/structReferenceVert.html">ReferenceVert</a> *rp;
<a name="l03820"></a>03820     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03821"></a>03821     float (*opos)[3];
<a name="l03822"></a>03822     float (*rpos)[3];
<a name="l03823"></a>03823     <span class="keywordtype">float</span> com[3],rcom[3];
<a name="l03824"></a>03824     <span class="keywordtype">int</span> a;
<a name="l03825"></a>03825 
<a name="l03826"></a>03826     <span class="keywordflow">if</span> (!ob ||!ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>) <span class="keywordflow">return</span>; <span class="comment">/* why did we get here ? */</span>
<a name="l03827"></a>03827     sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l03828"></a>03828     <span class="keywordflow">if</span> (!sb || !sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>) <span class="keywordflow">return</span>;
<a name="l03829"></a>03829     opos= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>)*3*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;SB_OPOS&quot;</span>);
<a name="l03830"></a>03830     rpos= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>)*3*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;SB_RPOS&quot;</span>);
<a name="l03831"></a>03831     <span class="comment">/* might filter vertex selection with a vertex group */</span>
<a name="l03832"></a>03832     <span class="keywordflow">for</span> (a=0, bp=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>, rp=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a746dc0ee54055c88dcdb71e5b63d5c39">Ref</a>.<a class="code" href="../../d6/d8b/structReferenceState.html#aefca94424242a2ae63fcf0400d2f1e0e">ivert</a>; a&lt;sb-&gt;totpoint; a++, bp++, rp++) {
<a name="l03833"></a>03833         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rpos[a],rp-&gt;<a class="code" href="../../dc/dce/structReferenceVert.html#aba0757fcab89a165f45ef6c4c247bf8e">pos</a>);
<a name="l03834"></a>03834         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(opos[a],bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03835"></a>03835     }
<a name="l03836"></a>03836 
<a name="l03837"></a>03837     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6410c46c949466388fe2e7e87fbbe000">vcloud_estimate_transform</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>, opos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rpos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, com, rcom,lrot,lscale);
<a name="l03838"></a>03838     <span class="comment">//sub_v3_v3(com,rcom);</span>
<a name="l03839"></a>03839     <span class="keywordflow">if</span> (lloc) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lloc,com);
<a name="l03840"></a>03840     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac92f71d4bd70e214d43b836420243fe5">lcom</a>,com);
<a name="l03841"></a>03841     <span class="keywordflow">if</span> (lscale) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a212f6d8277fdf733a09e9a38b51a67cb">lscale</a>,lscale);
<a name="l03842"></a>03842     <span class="keywordflow">if</span> (lrot)   <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a23a432fb40494aed3960b89ecbedd956">lrot</a>,lrot);
<a name="l03843"></a>03843 
<a name="l03844"></a>03844 
<a name="l03845"></a>03845     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(opos);
<a name="l03846"></a>03846     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rpos);
<a name="l03847"></a>03847 }
<a name="l03848"></a>03848 
<a name="l03849"></a><a class="code" href="../../de/d32/softbody_8c.html#a9985cd3c17f722d2b5955c7a112727a5">03849</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a9985cd3c17f722d2b5955c7a112727a5">softbody_reset</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb, <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l03850"></a>03850 {
<a name="l03851"></a>03851     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp;
<a name="l03852"></a>03852     <span class="keywordtype">int</span> a;
<a name="l03853"></a>03853 
<a name="l03854"></a>03854     <span class="keywordflow">for</span> (a=0,bp=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a>; a&lt;numVerts; a++, bp++) {
<a name="l03855"></a>03855         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, vertexCos[a]);
<a name="l03856"></a>03856         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);  <span class="comment">/* yep, sofbody is global coords*/</span>
<a name="l03857"></a>03857         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ae212fcbddf419e4a4ac67734e743056f">origS</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03858"></a>03858         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a249a7f6ea7bf756f49545c6943f94bdd">origE</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03859"></a>03859         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#ac0e61eda603084af27a328098de04131">origT</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03860"></a>03860         bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[0]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[1]= bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>[2]= 0.0f;
<a name="l03861"></a>03861 
<a name="l03862"></a>03862         <span class="comment">/* the bp-&gt;prev*&#39;s are for rolling back from a canceled try to propagate in time</span>
<a name="l03863"></a>03863 <span class="comment">         * adaptive step size algo in a nutshell:</span>
<a name="l03864"></a>03864 <span class="comment">         * 1.  set scheduled time step to new dtime</span>
<a name="l03865"></a>03865 <span class="comment">         * 2.  try to advance the scheduled time step, being optimistic execute it</span>
<a name="l03866"></a>03866 <span class="comment">         * 3.  check for success</span>
<a name="l03867"></a>03867 <span class="comment">         * 3.a we &#39;re fine continue, may be we can increase scheduled time again ?? if so, do so!</span>
<a name="l03868"></a>03868 <span class="comment">         * 3.b we did exceed error limit --&gt; roll back, shorten the scheduled time and try again at 2.</span>
<a name="l03869"></a>03869 <span class="comment">         * 4.  check if we did reach dtime</span>
<a name="l03870"></a>03870 <span class="comment">         * 4.a nope we need to do some more at 2.</span>
<a name="l03871"></a>03871 <span class="comment">         * 4.b yup we&#39;re done</span>
<a name="l03872"></a>03872 <span class="comment">         */</span>
<a name="l03873"></a>03873 
<a name="l03874"></a>03874         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#abb71a3ab568231fddb6448b82c4881d7">prevpos</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l03875"></a>03875         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a6f45384fc65f69df8c30486320d9ed45">prevvec</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03876"></a>03876         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a59e41ea9c9dc4449673fa306922ef3f1">prevdx</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03877"></a>03877         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a2b9029706e88bb16d00c94bc5aa4baad">prevdv</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l03878"></a>03878     }
<a name="l03879"></a>03879 
<a name="l03880"></a>03880     <span class="comment">/* make a nice clean scratch struc */</span>
<a name="l03881"></a>03881     <a class="code" href="../../de/d32/softbody_8c.html#aca77c4c49c17ef94fa62810ca1d9dbbf">free_scratch</a>(sb); <span class="comment">/* clear if any */</span>
<a name="l03882"></a>03882     <a class="code" href="../../de/d32/softbody_8c.html#ac81622a96f31b5b8e1aae3314016af41">sb_new_scratch</a>(sb); <span class="comment">/* make a new */</span>
<a name="l03883"></a>03883     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a691ee971e5b36ebfcf65e099f59aef72">needstobuildcollider</a>=1;
<a name="l03884"></a>03884     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ac92f71d4bd70e214d43b836420243fe5">lcom</a>);
<a name="l03885"></a>03885     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a23a432fb40494aed3960b89ecbedd956">lrot</a>);
<a name="l03886"></a>03886     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a212f6d8277fdf733a09e9a38b51a67cb">lscale</a>);
<a name="l03887"></a>03887 
<a name="l03888"></a>03888 
<a name="l03889"></a>03889 
<a name="l03890"></a>03890     <span class="comment">/* copy some info to scratch */</span>
<a name="l03891"></a>03891             <span class="comment">/* we only need that if we want to reconstruct IPO */</span>
<a name="l03892"></a>03892     <span class="keywordflow">if</span> (1) {
<a name="l03893"></a>03893         <a class="code" href="../../de/d32/softbody_8c.html#adfc59743e346b737a4353915753a67b8">reference_to_scratch</a>(ob);
<a name="l03894"></a>03894         <a class="code" href="../../d6/df9/BKE__softbody_8h.html#acf285f6022a156a0e2aa8d4946afa354">SB_estimate_transform</a>(ob,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03895"></a>03895         <a class="code" href="../../d6/df9/BKE__softbody_8h.html#acf285f6022a156a0e2aa8d4946afa354">SB_estimate_transform</a>(ob,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03896"></a>03896     }
<a name="l03897"></a>03897     <span class="keywordflow">switch</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>) {
<a name="l03898"></a>03898     <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>:
<a name="l03899"></a>03899         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a133f582250dd8a392e24954871920cf2">OB_SB_FACECOLL</a>) <a class="code" href="../../de/d32/softbody_8c.html#a4793f56001fbdfd01ec8ef21dc865b3b">mesh_faces_to_scratch</a>(ob);
<a name="l03900"></a>03900         <span class="keywordflow">break</span>;
<a name="l03901"></a>03901     <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>:
<a name="l03902"></a>03902         <span class="keywordflow">break</span>;
<a name="l03903"></a>03903     <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>:
<a name="l03904"></a>03904     <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>:
<a name="l03905"></a>03905         <span class="keywordflow">break</span>;
<a name="l03906"></a>03906     <span class="keywordflow">default</span>:
<a name="l03907"></a>03907         <span class="keywordflow">break</span>;
<a name="l03908"></a>03908     }
<a name="l03909"></a>03909 }
<a name="l03910"></a>03910 
<a name="l03911"></a><a class="code" href="../../de/d32/softbody_8c.html#a1f40f7de7068abbde11906f23c124d0c">03911</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/d32/softbody_8c.html#a1f40f7de7068abbde11906f23c124d0c">softbody_step</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb, <span class="keywordtype">float</span> dtime)
<a name="l03912"></a>03912 {
<a name="l03913"></a>03913     <span class="comment">/* the simulator */</span>
<a name="l03914"></a>03914     <span class="keywordtype">float</span> forcetime;
<a name="l03915"></a>03915     <span class="keywordtype">double</span> sct,sst;
<a name="l03916"></a>03916 
<a name="l03917"></a>03917 
<a name="l03918"></a>03918     sst=<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l03919"></a>03919     <span class="comment">/* Integration back in time is possible in theory, but pretty useless here.</span>
<a name="l03920"></a>03920 <span class="comment">     * So we refuse to do so. Since we do not know anything about &#39;outside&#39; canges</span>
<a name="l03921"></a>03921 <span class="comment">     * especially colliders we refuse to go more than 10 frames.</span>
<a name="l03922"></a>03922 <span class="comment">     */</span>
<a name="l03923"></a>03923     <span class="keywordflow">if</span> (dtime &lt; 0 || dtime &gt; 10.5f) <span class="keywordflow">return</span>;
<a name="l03924"></a>03924 
<a name="l03925"></a>03925     <a class="code" href="../../de/d32/softbody_8c.html#ac58014d00bf604edfa56bc5f04a64cab">ccd_update_deflector_hash</a>(scene, ob, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>);
<a name="l03926"></a>03926 
<a name="l03927"></a>03927     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a691ee971e5b36ebfcf65e099f59aef72">needstobuildcollider</a>) {
<a name="l03928"></a>03928         <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a7739955b3f3596cdbc889c13ffb686f2">query_external_colliders</a>(scene, ob)) {
<a name="l03929"></a>03929             <a class="code" href="../../de/d32/softbody_8c.html#ad385759d494e53894626ab553727931c">ccd_build_deflector_hash</a>(scene, ob, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#abcb998e8418119dde8d93780fc3137ed">colliderhash</a>);
<a name="l03930"></a>03930         }
<a name="l03931"></a>03931         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a691ee971e5b36ebfcf65e099f59aef72">needstobuildcollider</a>=0;
<a name="l03932"></a>03932     }
<a name="l03933"></a>03933 
<a name="l03934"></a>03934     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a206ad7c022ed00513b5b5d8860e7be27">solver_ID</a> &lt; 2) {
<a name="l03935"></a>03935         <span class="comment">/* special case of 2nd order Runge-Kutta type AKA Heun */</span>
<a name="l03936"></a>03936         <span class="keywordtype">int</span> mid_flags=0;
<a name="l03937"></a>03937         <span class="keywordtype">float</span> <a class="code" href="../../df/db3/freetypefont_8c.html#ab596967142db56aa5fbafe7c234eedda">err</a> = 0;
<a name="l03938"></a>03938         <span class="keywordtype">float</span> forcetimemax = 1.0f; <span class="comment">/* set defaults guess we shall do one frame */</span>
<a name="l03939"></a>03939         <span class="keywordtype">float</span> forcetimemin = 0.01f; <span class="comment">/* set defaults guess 1/100 is tight enough */</span>
<a name="l03940"></a>03940         <span class="keywordtype">float</span> timedone =0.0; <span class="comment">/* how far did we get without violating error condition */</span>
<a name="l03941"></a>03941                              <span class="comment">/* loops = counter for emergency brake</span>
<a name="l03942"></a>03942 <span class="comment">                              * we don&#39;t want to lock up the system if physics fail */</span>
<a name="l03943"></a>03943         <span class="keywordtype">int</span> loops = 0;
<a name="l03944"></a>03944 
<a name="l03945"></a>03945         <a class="code" href="../../de/d32/softbody_8c.html#adc5045929d97b109025e24819a3c329d">SoftHeunTol</a> = sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a25dfcdfbaff3161bd18d996e930bd16c">rklimit</a>; <span class="comment">/* humm .. this should be calculated from sb parameters and sizes */</span>
<a name="l03946"></a>03946         <span class="comment">/* adjust loop limits */</span>
<a name="l03947"></a>03947         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a19ea9822587f3c9557bf846cdd7030aa">minloops</a> &gt; 0) forcetimemax = dtime / sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a19ea9822587f3c9557bf846cdd7030aa">minloops</a>;
<a name="l03948"></a>03948         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ada85676c1dfdd5d54d3e37074926eb67">maxloops</a> &gt; 0) forcetimemin = dtime / sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#ada85676c1dfdd5d54d3e37074926eb67">maxloops</a>;
<a name="l03949"></a>03949 
<a name="l03950"></a>03950         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a206ad7c022ed00513b5b5d8860e7be27">solver_ID</a>&gt;0) mid_flags |= <a class="code" href="../../de/d32/softbody_8c.html#abe8a65968f3259f17cd3bd2b5be5dec5">MID_PRESERVE</a>;
<a name="l03951"></a>03951 
<a name="l03952"></a>03952         forcetime = forcetimemax; <span class="comment">/* hope for integrating in one step */</span>
<a name="l03953"></a>03953         <span class="keywordflow">while</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(timedone) &lt; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dtime)) &amp;&amp; (loops &lt; 2000) )
<a name="l03954"></a>03954         {
<a name="l03955"></a>03955             <span class="comment">/* set goals in time */</span>
<a name="l03956"></a>03956             <a class="code" href="../../de/d32/softbody_8c.html#ace3987b38c1b3988ba9878b76bbb35c2">interpolate_exciter</a>(ob,200,(<span class="keywordtype">int</span>)(200.0f*(timedone/dtime)));
<a name="l03957"></a>03957 
<a name="l03958"></a>03958             sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">flag</a> &amp;= ~<a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>;
<a name="l03959"></a>03959             <span class="comment">/* do predictive euler step */</span>
<a name="l03960"></a>03960             <a class="code" href="../../de/d32/softbody_8c.html#a4661f7e1d676a6b8bbffd7246c2389d1">softbody_calc_forces</a>(scene, ob, forcetime,timedone/dtime,0);
<a name="l03961"></a>03961 
<a name="l03962"></a>03962             <a class="code" href="../../de/d32/softbody_8c.html#a7230cb2671dff526904c5ffb07a2e20a">softbody_apply_forces</a>(ob, forcetime, 1, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,mid_flags);
<a name="l03963"></a>03963 
<a name="l03964"></a>03964             <span class="comment">/* crop new slope values to do averaged slope step */</span>
<a name="l03965"></a>03965             <a class="code" href="../../de/d32/softbody_8c.html#a4661f7e1d676a6b8bbffd7246c2389d1">softbody_calc_forces</a>(scene, ob, forcetime,timedone/dtime,0);
<a name="l03966"></a>03966 
<a name="l03967"></a>03967             <a class="code" href="../../de/d32/softbody_8c.html#a7230cb2671dff526904c5ffb07a2e20a">softbody_apply_forces</a>(ob, forcetime, 2, &amp;err,mid_flags);
<a name="l03968"></a>03968             <a class="code" href="../../de/d32/softbody_8c.html#a6be8d5628c067cfa1d2ea967ba518c94">softbody_apply_goalsnap</a>(ob);
<a name="l03969"></a>03969 
<a name="l03970"></a>03970             <span class="keywordflow">if</span> (err &gt; <a class="code" href="../../de/d32/softbody_8c.html#adc5045929d97b109025e24819a3c329d">SoftHeunTol</a>) { <span class="comment">/* error needs to be scaled to some quantity */</span>
<a name="l03971"></a>03971 
<a name="l03972"></a>03972                 <span class="keywordflow">if</span> (forcetime &gt; forcetimemin) {
<a name="l03973"></a>03973                     forcetime = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(forcetime / 2.0f,forcetimemin);
<a name="l03974"></a>03974                     <a class="code" href="../../de/d32/softbody_8c.html#a556f9c70558aeea73aaf411fe527c787">softbody_restore_prev_step</a>(ob);
<a name="l03975"></a>03975                     <span class="comment">//printf(&quot;down,&quot;);</span>
<a name="l03976"></a>03976                 }
<a name="l03977"></a>03977                 <span class="keywordflow">else</span> {
<a name="l03978"></a>03978                     timedone += forcetime;
<a name="l03979"></a>03979                 }
<a name="l03980"></a>03980             }
<a name="l03981"></a>03981             <span class="keywordflow">else</span> {
<a name="l03982"></a>03982                 <span class="keywordtype">float</span> newtime = forcetime * 1.1f; <span class="comment">/* hope for 1.1 times better conditions in next step */</span>
<a name="l03983"></a>03983 
<a name="l03984"></a>03984                 <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#abdd51735258f1805c3ccd91ccee22429">scratch</a>-&gt;<a class="code" href="../../de/dbb/structSBScratch.html#a2572803a8362ca4434dc31a50e9418cf">flag</a> &amp; <a class="code" href="../../de/d32/softbody_8c.html#aa6b0512307a64067d200c4ba7d4550ab">SBF_DOFUZZY</a>) {
<a name="l03985"></a>03985                     <span class="comment">//if (err &gt; SoftHeunTol/(2.0f*sb-&gt;fuzzyness)) { /* stay with this stepsize unless err really small */</span>
<a name="l03986"></a>03986                     newtime = forcetime;
<a name="l03987"></a>03987                     <span class="comment">//}</span>
<a name="l03988"></a>03988                 }
<a name="l03989"></a>03989                 <span class="keywordflow">else</span> {
<a name="l03990"></a>03990                     <span class="keywordflow">if</span> (err &gt; <a class="code" href="../../de/d32/softbody_8c.html#adc5045929d97b109025e24819a3c329d">SoftHeunTol</a>/2.0f) { <span class="comment">/* stay with this stepsize unless err really small */</span>
<a name="l03991"></a>03991                         newtime = forcetime;
<a name="l03992"></a>03992                     }
<a name="l03993"></a>03993                 }
<a name="l03994"></a>03994                 timedone += forcetime;
<a name="l03995"></a>03995                 newtime=<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(forcetimemax,<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(newtime,forcetimemin));
<a name="l03996"></a>03996                 <span class="comment">//if (newtime &gt; forcetime) printf(&quot;up,&quot;);</span>
<a name="l03997"></a>03997                 <span class="keywordflow">if</span> (forcetime &gt; 0.0f)
<a name="l03998"></a>03998                     forcetime = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(dtime - timedone,newtime);
<a name="l03999"></a>03999                 <span class="keywordflow">else</span>
<a name="l04000"></a>04000                     forcetime = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(dtime - timedone,newtime);
<a name="l04001"></a>04001             }
<a name="l04002"></a>04002             loops++;
<a name="l04003"></a>04003             <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#adfea1c34d8d639fd6daacbf329e45369">SBSO_MONITOR</a> ) {
<a name="l04004"></a>04004                 sct=<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l04005"></a>04005                 <span class="keywordflow">if</span> (sct-sst &gt; 0.5f) printf(<span class="stringliteral">&quot;%3.0f%% \r&quot;</span>,100.0f*timedone/dtime);
<a name="l04006"></a>04006             }
<a name="l04007"></a>04007             <span class="comment">/* ask for user break */</span>
<a name="l04008"></a>04008             <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/softbody_8c.html#a1c4f502d7dcd9d7d80abdfb487c520e4">SB_localInterruptCallBack</a> &amp;&amp; <a class="code" href="../../de/d32/softbody_8c.html#a1c4f502d7dcd9d7d80abdfb487c520e4">SB_localInterruptCallBack</a>()) <span class="keywordflow">break</span>;
<a name="l04009"></a>04009 
<a name="l04010"></a>04010         }
<a name="l04011"></a>04011         <span class="comment">/* move snapped to final position */</span>
<a name="l04012"></a>04012         <a class="code" href="../../de/d32/softbody_8c.html#ace3987b38c1b3988ba9878b76bbb35c2">interpolate_exciter</a>(ob, 2, 2);
<a name="l04013"></a>04013         <a class="code" href="../../de/d32/softbody_8c.html#a6be8d5628c067cfa1d2ea967ba518c94">softbody_apply_goalsnap</a>(ob);
<a name="l04014"></a>04014 
<a name="l04015"></a>04015         <span class="comment">//              if (G.debug &amp; G_DEBUG) {</span>
<a name="l04016"></a>04016         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#adfea1c34d8d639fd6daacbf329e45369">SBSO_MONITOR</a> ) {
<a name="l04017"></a>04017             <span class="keywordflow">if</span> (loops &gt; <a class="code" href="../../de/d32/softbody_8c.html#ab49ad7746b2cedbe49e514139fb19a12">HEUNWARNLIMIT</a>) <span class="comment">/* monitor high loop counts */</span>
<a name="l04018"></a>04018                 printf(<span class="stringliteral">&quot;\r needed %d steps/frame&quot;</span>,loops);
<a name="l04019"></a>04019         }
<a name="l04020"></a>04020 
<a name="l04021"></a>04021     }
<a name="l04022"></a>04022     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a206ad7c022ed00513b5b5d8860e7be27">solver_ID</a> == 2)
<a name="l04023"></a>04023     {<span class="comment">/* do semi &quot;fake&quot; implicit euler */</span>
<a name="l04024"></a>04024         <span class="comment">//removed</span>
<a name="l04025"></a>04025     }<span class="comment">/*SOLVER SELECT*/</span>
<a name="l04026"></a>04026     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a206ad7c022ed00513b5b5d8860e7be27">solver_ID</a> == 4)
<a name="l04027"></a>04027     {
<a name="l04028"></a>04028         <span class="comment">/* do semi &quot;fake&quot; implicit euler */</span>
<a name="l04029"></a>04029     }<span class="comment">/*SOLVER SELECT*/</span>
<a name="l04030"></a>04030     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a206ad7c022ed00513b5b5d8860e7be27">solver_ID</a> == 3) {
<a name="l04031"></a>04031         <span class="comment">/* do &quot;stupid&quot; semi &quot;fake&quot; implicit euler */</span>
<a name="l04032"></a>04032         <span class="comment">//removed</span>
<a name="l04033"></a>04033 
<a name="l04034"></a>04034     }<span class="comment">/*SOLVER SELECT*/</span>
<a name="l04035"></a>04035     <span class="keywordflow">else</span> {
<a name="l04036"></a>04036         printf(<span class="stringliteral">&quot;softbody no valid solver ID!&quot;</span>);
<a name="l04037"></a>04037     }<span class="comment">/*SOLVER SELECT*/</span>
<a name="l04038"></a>04038     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afe680232f8fa4c56f5c5a6221b485d57">plastic</a>) { <a class="code" href="../../de/d32/softbody_8c.html#afa9f79f284a2a7e665833e3c90f1c533">apply_spring_memory</a>(ob);}
<a name="l04039"></a>04039 
<a name="l04040"></a>04040     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2af705a72f050fb8a85e6a58b01d2dfe">solverflags</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#adfea1c34d8d639fd6daacbf329e45369">SBSO_MONITOR</a> ) {
<a name="l04041"></a>04041         sct=<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l04042"></a>04042         <span class="keywordflow">if</span> ((sct-sst &gt; 0.5f) || (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)) printf(<span class="stringliteral">&quot; solver time %f sec %s\n&quot;</span>,sct-sst,ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l04043"></a>04043     }
<a name="l04044"></a>04044 }
<a name="l04045"></a>04045 
<a name="l04046"></a>04046 <span class="comment">/* simulates one step. framenr is in frames */</span>
<a name="l04047"></a><a class="code" href="../../de/d32/softbody_8c.html#a8837bae70ce7c61594e100ddd3fd305a">04047</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/df9/BKE__softbody_8h.html#a124240393a8d29aab404b7bca589e18f">sbObjectStep</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> cfra, <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l04048"></a>04048 {
<a name="l04049"></a>04049     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>;
<a name="l04050"></a>04050     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache;
<a name="l04051"></a>04051     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> pid;
<a name="l04052"></a>04052     <span class="keywordtype">float</span> dtime, timescale;
<a name="l04053"></a>04053     <span class="keywordtype">int</span> framedelta, framenr, startframe, endframe;
<a name="l04054"></a>04054     <span class="keywordtype">int</span> cache_result;
<a name="l04055"></a>04055 
<a name="l04056"></a>04056     cache= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3cbaa712cbb0289db746f8dbfb34f1bb">pointcache</a>;
<a name="l04057"></a>04057 
<a name="l04058"></a>04058     framenr= (int)cfra;
<a name="l04059"></a>04059     framedelta= framenr - cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a>;
<a name="l04060"></a>04060 
<a name="l04061"></a>04061     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a77c23b980ef3e6c4f755966321bbe2e4">BKE_ptcache_id_from_softbody</a>(&amp;pid, ob, sb);
<a name="l04062"></a>04062     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a3b3321b3ad61b23a9c227a438281ad14">BKE_ptcache_id_time</a>(&amp;pid, scene, framenr, &amp;startframe, &amp;endframe, &amp;timescale);
<a name="l04063"></a>04063 
<a name="l04064"></a>04064     <span class="comment">/* check for changes in mesh, should only happen in case the mesh</span>
<a name="l04065"></a>04065 <span class="comment">     * structure changes during an animation */</span>
<a name="l04066"></a>04066     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a> &amp;&amp; numVerts != sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>) {
<a name="l04067"></a>04067         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l04068"></a>04068         <span class="keywordflow">return</span>;
<a name="l04069"></a>04069     }
<a name="l04070"></a>04070 
<a name="l04071"></a>04071     <span class="comment">/* clamp frame ranges */</span>
<a name="l04072"></a>04072     <span class="keywordflow">if</span> (framenr &lt; startframe) {
<a name="l04073"></a>04073         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l04074"></a>04074         <span class="keywordflow">return</span>;
<a name="l04075"></a>04075     }
<a name="l04076"></a>04076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (framenr &gt; endframe) {
<a name="l04077"></a>04077         framenr = endframe;
<a name="l04078"></a>04078     }
<a name="l04079"></a>04079 
<a name="l04080"></a>04080     <span class="comment">/* verify if we need to create the softbody data */</span>
<a name="l04081"></a>04081     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l04082"></a>04082        ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa4ef225512c8db13e0072175a82e5438">softflag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1c94b8f26b12397163a22bff6a340d24">OB_SB_EDGES</a>) &amp;&amp; !ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a99bff20b16a6db04352ecaa5bc07ee34">bspring</a> &amp;&amp; <a class="code" href="../../de/d32/softbody_8c.html#a8e4bec60810728db4134d3c9d70f2d94">object_has_edges</a>(ob))) {
<a name="l04083"></a>04083 
<a name="l04084"></a>04084         <span class="keywordflow">switch</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>) {
<a name="l04085"></a>04085             <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>:
<a name="l04086"></a>04086                 <a class="code" href="../../de/d32/softbody_8c.html#a38ed19e7e140b96aa01fdfcfbcac1652">mesh_to_softbody</a>(scene, ob);
<a name="l04087"></a>04087                 <span class="keywordflow">break</span>;
<a name="l04088"></a>04088             <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>:
<a name="l04089"></a>04089                 <a class="code" href="../../de/d32/softbody_8c.html#add8b956e51b0849906f5c360675db825">lattice_to_softbody</a>(scene, ob);
<a name="l04090"></a>04090                 <span class="keywordflow">break</span>;
<a name="l04091"></a>04091             <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>:
<a name="l04092"></a>04092             <span class="keywordflow">case</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>:
<a name="l04093"></a>04093                 <a class="code" href="../../de/d32/softbody_8c.html#a5abdfb4d5a6225b96d6aea4d8fdf5bc2">curve_surf_to_softbody</a>(scene, ob);
<a name="l04094"></a>04094                 <span class="keywordflow">break</span>;
<a name="l04095"></a>04095             <span class="keywordflow">default</span>:
<a name="l04096"></a>04096                 <a class="code" href="../../de/d32/softbody_8c.html#a64cf0ce8542348aaa4d4ca5073abd87c">renew_softbody</a>(scene, ob, numVerts, 0);
<a name="l04097"></a>04097                 <span class="keywordflow">break</span>;
<a name="l04098"></a>04098         }
<a name="l04099"></a>04099 
<a name="l04100"></a>04100         <a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">softbody_update_positions</a>(ob, sb, vertexCos, numVerts);
<a name="l04101"></a>04101         <a class="code" href="../../de/d32/softbody_8c.html#a9985cd3c17f722d2b5955c7a112727a5">softbody_reset</a>(ob, sb, vertexCos, numVerts);
<a name="l04102"></a>04102     }
<a name="l04103"></a>04103 
<a name="l04104"></a>04104     <span class="comment">/* continue physics special case */</span>
<a name="l04105"></a>04105     <span class="keywordflow">if</span> (<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a34764119fdcd6197dceb78b4181e6e3b">BKE_ptcache_get_continue_physics</a>()) {
<a name="l04106"></a>04106         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l04107"></a>04107         <span class="comment">/* do simulation */</span>
<a name="l04108"></a>04108         dtime = timescale;
<a name="l04109"></a>04109         <a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">softbody_update_positions</a>(ob, sb, vertexCos, numVerts);
<a name="l04110"></a>04110         <a class="code" href="../../de/d32/softbody_8c.html#a1f40f7de7068abbde11906f23c124d0c">softbody_step</a>(scene, ob, sb, dtime);
<a name="l04111"></a>04111         <a class="code" href="../../de/d32/softbody_8c.html#aa033db58d2bccf1d1b4d9ceaf324c2b8">softbody_to_object</a>(ob, vertexCos, numVerts, 0);
<a name="l04112"></a>04112         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a> = framenr;
<a name="l04113"></a>04113         <span class="keywordflow">return</span>;
<a name="l04114"></a>04114     }
<a name="l04115"></a>04115 
<a name="l04116"></a>04116     <span class="comment">/* still no points? go away */</span>
<a name="l04117"></a>04117     <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>==0) {
<a name="l04118"></a>04118         <span class="keywordflow">return</span>;
<a name="l04119"></a>04119     }
<a name="l04120"></a>04120     <span class="keywordflow">if</span> (framenr == startframe) {
<a name="l04121"></a>04121         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0da786e671a578f5467e04bcfdb99e4">PTCACHE_RESET_OUTDATED</a>);
<a name="l04122"></a>04122 
<a name="l04123"></a>04123         <span class="comment">/* first frame, no simulation to do, just set the positions */</span>
<a name="l04124"></a>04124         <a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">softbody_update_positions</a>(ob, sb, vertexCos, numVerts);
<a name="l04125"></a>04125 
<a name="l04126"></a>04126         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, framenr);
<a name="l04127"></a>04127         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>;
<a name="l04128"></a>04128 
<a name="l04129"></a>04129         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a> = framenr;
<a name="l04130"></a>04130 
<a name="l04131"></a>04131         <span class="keywordflow">return</span>;
<a name="l04132"></a>04132     }
<a name="l04133"></a>04133 
<a name="l04134"></a>04134     <span class="comment">/* try to read from cache */</span>
<a name="l04135"></a>04135     cache_result = <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a707b45e87667b28ce4c28d7af981d015">BKE_ptcache_read</a>(&amp;pid, (<span class="keywordtype">float</span>)framenr+scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1b2f8b32641bb4d043a3c8c820a6755d">subframe</a>);
<a name="l04136"></a>04136 
<a name="l04137"></a>04137     <span class="keywordflow">if</span> (cache_result == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af66510109c41fe8841cfef13e1548950">PTCACHE_READ_EXACT</a> || cache_result == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a87c0cf2703ad8da6444507a50f1f31b3">PTCACHE_READ_INTERPOLATED</a>) {
<a name="l04138"></a>04138         <a class="code" href="../../de/d32/softbody_8c.html#aa033db58d2bccf1d1b4d9ceaf324c2b8">softbody_to_object</a>(ob, vertexCos, numVerts, sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a67b49ac78c028053b12a9b7091323d57">local</a>);
<a name="l04139"></a>04139 
<a name="l04140"></a>04140         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, framenr);
<a name="l04141"></a>04141 
<a name="l04142"></a>04142         <span class="keywordflow">if</span> (cache_result == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a87c0cf2703ad8da6444507a50f1f31b3">PTCACHE_READ_INTERPOLATED</a> &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>)
<a name="l04143"></a>04143             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(&amp;pid, framenr);
<a name="l04144"></a>04144 
<a name="l04145"></a>04145         sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a> = framenr;
<a name="l04146"></a>04146 
<a name="l04147"></a>04147         <span class="keywordflow">return</span>;
<a name="l04148"></a>04148     }
<a name="l04149"></a>04149     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cache_result==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#aa462ff2d6af45758c0d40956a93c1e37">PTCACHE_READ_OLD</a>) {
<a name="l04150"></a>04150         ; <span class="comment">/* do nothing */</span>
<a name="l04151"></a>04151     }
<a name="l04152"></a>04152     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="comment">/*ob-&gt;id.lib || */</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)) { <span class="comment">/* &quot;library linking &amp; pointcaches&quot; has to be solved properly at some point */</span>
<a name="l04153"></a>04153         <span class="comment">/* if baked and nothing in cache, do nothing */</span>
<a name="l04154"></a>04154         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l04155"></a>04155         <span class="keywordflow">return</span>;
<a name="l04156"></a>04156     }
<a name="l04157"></a>04157 
<a name="l04158"></a>04158     <span class="keywordflow">if</span> (framenr!=sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a>+1)
<a name="l04159"></a>04159         <span class="keywordflow">return</span>;
<a name="l04160"></a>04160 
<a name="l04161"></a>04161     <span class="comment">/* if on second frame, write cache for first frame */</span>
<a name="l04162"></a>04162     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a> == startframe &amp;&amp; (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a> || cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>==0))
<a name="l04163"></a>04163         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(&amp;pid, startframe);
<a name="l04164"></a>04164 
<a name="l04165"></a>04165     <a class="code" href="../../de/d32/softbody_8c.html#afb6b801039c63f2fb4d7ca4620cf747b">softbody_update_positions</a>(ob, sb, vertexCos, numVerts);
<a name="l04166"></a>04166 
<a name="l04167"></a>04167     <span class="comment">/* checking time: */</span>
<a name="l04168"></a>04168     dtime = framedelta*timescale;
<a name="l04169"></a>04169 
<a name="l04170"></a>04170     <span class="comment">/* do simulation */</span>
<a name="l04171"></a>04171     <a class="code" href="../../de/d32/softbody_8c.html#a1f40f7de7068abbde11906f23c124d0c">softbody_step</a>(scene, ob, sb, dtime);
<a name="l04172"></a>04172 
<a name="l04173"></a>04173     <a class="code" href="../../de/d32/softbody_8c.html#aa033db58d2bccf1d1b4d9ceaf324c2b8">softbody_to_object</a>(ob, vertexCos, numVerts, 0);
<a name="l04174"></a>04174 
<a name="l04175"></a>04175     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, framenr);
<a name="l04176"></a>04176     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(&amp;pid, framenr);
<a name="l04177"></a>04177 
<a name="l04178"></a>04178     sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a4fb6089c6900885a8c85f68d8871d2ed">last_frame</a> = framenr;
<a name="l04179"></a>04179 }
<a name="l04180"></a>04180 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:55 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
