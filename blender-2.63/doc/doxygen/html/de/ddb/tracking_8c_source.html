<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: tracking.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">tracking.c</div>  </div>
</div>
<div class="contents">
<a href="../../de/ddb/tracking_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2011 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Blender Foundation,</span>
<a name="l00022"></a>00022 <span class="comment"> *                 Sergey Sharybin</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;memory.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html">DNA_gpencil_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dfb/DNA__movieclip__types_8h.html">DNA_movieclip_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>   <span class="comment">/* SELECT */</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d06/BLI__math__base_8h.html">BLI_math_base.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d3e/BLI__listbase_8h.html">BLI_listbase.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dd9/BLI__path__util_8h.html">BLI_path_util.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db3/BLI__string_8h.html">BLI_string.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d72/BKE__tracking_8h.html">BKE_tracking.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd4/BKE__movieclip_8h.html">BKE_movieclip.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">#  include &quot;libmv-capi.h&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#else</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="keyword">struct </span>libmv_Features;
<a name="l00066"></a>00066 <span class="preprocessor">#endif</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>
<a name="l00068"></a><a class="code" href="../../d6/da4/structMovieDistortion.html">00068</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> {
<a name="l00069"></a><a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">00069</a>     <span class="keyword">struct </span>libmv_CameraIntrinsics *<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>;
<a name="l00070"></a>00070 } <a class="code" href="../../de/ddb/tracking_8c.html#a84ddd3313a6fe2a1fbd95a8b39f8102a">MovieDistortion</a>;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00073"></a><a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">00073</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>;
<a name="l00074"></a>00074 } <a class="code" href="../../de/ddb/tracking_8c.html#afc1ca0b79c156183fe8b82a217e79f26">tracking_clipboard</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/*********************** common functions *************************/</span>
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="../../de/ddb/tracking_8c.html#a6bc99251aeb5197d4b603a24f9f2d14b">00078</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ae91b779bb4cf677956978ee8f5280751">BKE_tracking_init_settings</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a65ba33a89879f2c22a2876610d393d69">sensor_width</a> = 35.0f;
<a name="l00081"></a>00081     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a> = 1.0f;
<a name="l00082"></a>00082     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa48436cf3a1204d428ab1a9f33dae0ca">units</a> = <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ade4ace78b27f5ceccade6e2e29404c48a541c3375ae0d97d2682cfabd74f1560a">CAMERA_UNITS_MM</a>;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ad798c871b88d151b983fe028536118f7">default_tracker</a> = <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a1d5e94d8587edec89d13615c23c74a06">TRACKER_HYBRID</a>;
<a name="l00085"></a>00085     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a6aee59cdcaef29f803e6fcd8dac76af7">default_minimum_correlation</a> = 0.75;
<a name="l00086"></a>00086     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a7004be3b02da2b819c9aab2c93ed9c47">default_pattern_size</a> = 11;
<a name="l00087"></a>00087     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ae0d9d6de3b92c0e28200fe384043760a">default_search_size</a> = 61;
<a name="l00088"></a>00088     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ac321bfb4a73f930617dd5c7bcb521400">default_pyramid_levels</a> = 2;
<a name="l00089"></a>00089     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ab320cbb600cc2d019a30ce3029f033a1">keyframe1</a> = 1;
<a name="l00090"></a>00090     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a4270d8ac653dcb0238856bb31d6827ca">keyframe2</a> = 30;
<a name="l00091"></a>00091     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#aa10d5cd6484a6b8a3b38d40ede61a946">dist</a> = 1;
<a name="l00092"></a>00092     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a5f58d8985917757d7104c82f546ee27f">object_distance</a> = 1;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a70a926f4fcaacd2310d34e46a4290abf">scaleinf</a> = 1.0f;
<a name="l00095"></a>00095     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a51483e98af0b28fd0e3505b3436dbfce">locinf</a> = 1.0f;
<a name="l00096"></a>00096     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a66851bed9131dbabc35af2922fd5cc75">rotinf</a> = 1.0f;
<a name="l00097"></a>00097     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a34b69461632b44a5e4c2b191382a485a">maxscale</a> = 2.0f;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <a class="code" href="../../da/d72/BKE__tracking_8h.html#aaa24525c80d4ace1d53606d850992e76">BKE_tracking_new_object</a>(tracking, <span class="stringliteral">&quot;Camera&quot;</span>);
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="../../de/ddb/tracking_8c.html#af84900683ebbc00beac900e54d65673b">00102</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1dc460bb3ddf079500d4d03cf2bfae08">BKE_tracking_clamp_track</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> event)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104     <span class="keywordtype">int</span> a;
<a name="l00105"></a>00105     <span class="keywordtype">float</span> pat_min[2];
<a name="l00106"></a>00106     <span class="keywordtype">float</span> pat_max[2];
<a name="l00107"></a>00107     <span class="keywordtype">float</span> max_pyramid_level_factor = 1.0;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ab5f0286aa6aad0ba36259383ce88e01a">TRACKER_KLT</a>) {
<a name="l00110"></a>00110         max_pyramid_level_factor= 1 &lt;&lt; (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a3b2201f25d4e0cda7faef59a6d5730e5">pyramid_levels</a> - 1);
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="comment">/* sort */</span>
<a name="l00114"></a>00114     <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a] &gt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a])
<a name="l00116"></a>00116             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a]);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] &gt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a])
<a name="l00119"></a>00119             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a]);
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">/* compute the effective pattern size, which differs from the fine resolution</span>
<a name="l00123"></a>00123 <span class="comment">     * pattern size for the pyramid KLT tracker */</span>
<a name="l00124"></a>00124     <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00125"></a>00125         pat_min[a] = max_pyramid_level_factor * track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a];
<a name="l00126"></a>00126         pat_max[a] = max_pyramid_level_factor * track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a];
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#af76a577d4347d1e0835290749f1a9474">CLAMP_PAT_DIM</a>) {
<a name="l00130"></a>00130         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00131"></a>00131             <span class="comment">/* search shouldn&#39;t be resized smaller than pattern */</span>
<a name="l00132"></a>00132             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pat_min[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a]);
<a name="l00133"></a>00133             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pat_max[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a]);
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#abc6cba542edf287db173c2da8b81527e">CLAMP_PAT_POS</a>) {
<a name="l00137"></a>00137         <span class="keywordtype">float</span> dim[2];
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dim, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00142"></a>00142             <span class="comment">/* pattern shouldn&#39;t be moved outside of search */</span>
<a name="l00143"></a>00143             <span class="keywordflow">if</span> (pat_min[a] &lt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a]) {
<a name="l00144"></a>00144                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] - (pat_min[a] - track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a]);
<a name="l00145"></a>00145                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a] + dim[a];
<a name="l00146"></a>00146             }
<a name="l00147"></a>00147             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a] &gt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a]) {
<a name="l00148"></a>00148                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] - (pat_max[a] - track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a]);
<a name="l00149"></a>00149                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a] - dim[a];
<a name="l00150"></a>00150             }
<a name="l00151"></a>00151         }
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#a54c3bb711b72d16445f177a3a989f16c">CLAMP_SEARCH_DIM</a>) {
<a name="l00154"></a>00154         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00155"></a>00155             <span class="comment">/* search shouldn&#39;t be resized smaller than pattern */</span>
<a name="l00156"></a>00156             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pat_min[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a]);
<a name="l00157"></a>00157             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pat_max[a], track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a]);
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1d931d835e9a1e57168e1b0ce304808b">CLAMP_SEARCH_POS</a>) {
<a name="l00161"></a>00161         <span class="keywordtype">float</span> dim[2];
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dim, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00166"></a>00166             <span class="comment">/* search shouldn&#39;t be moved inside pattern */</span>
<a name="l00167"></a>00167             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] &gt; pat_min[a]) {
<a name="l00168"></a>00168                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] = pat_min[a];
<a name="l00169"></a>00169                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a]+dim[a];
<a name="l00170"></a>00170             }
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] &lt; pat_max[a]) {
<a name="l00172"></a>00172                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] = pat_max[a];
<a name="l00173"></a>00173                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a]-dim[a];
<a name="l00174"></a>00174             }
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#ace9d1ceb9f5f14ee9b46c500bde5e417">CLAMP_PYRAMID_LEVELS</a> || (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#a54c3bb711b72d16445f177a3a989f16c">CLAMP_SEARCH_DIM</a> &amp;&amp; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ab5f0286aa6aad0ba36259383ce88e01a">TRACKER_KLT</a>)) {
<a name="l00178"></a>00178         <span class="keywordtype">float</span> dim[2];
<a name="l00179"></a>00179         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dim, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>);
<a name="l00180"></a>00180         {
<a name="l00181"></a>00181             <span class="keywordtype">float</span> search_ratio = 2.3f * max_pyramid_level_factor;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183             <span class="comment">/* resize the search area to something sensible based</span>
<a name="l00184"></a>00184 <span class="comment">             * on the number of pyramid levels */</span>
<a name="l00185"></a>00185             <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00186"></a>00186                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[a] = search_ratio * track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a];
<a name="l00187"></a>00187                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[a] = search_ratio * track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a];
<a name="l00188"></a>00188             }
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">/* marker&#39;s center should be in center of pattern */</span>
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#af76a577d4347d1e0835290749f1a9474">CLAMP_PAT_DIM</a> || event == <a class="code" href="../../da/d72/BKE__tracking_8h.html#abc6cba542edf287db173c2da8b81527e">CLAMP_PAT_POS</a>) {
<a name="l00194"></a>00194         <span class="keywordtype">float</span> dim[2];
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dim, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l00199"></a>00199             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[a] = -dim[a]/2.0f;
<a name="l00200"></a>00200             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[a] = dim[a]/2.0f;
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="../../de/ddb/tracking_8c.html#a2e0f573018a2838700bf120b7459f0a3">00205</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> area, <span class="keywordtype">int</span> flag, <span class="keywordtype">int</span> <a class="code" href="../../d1/d79/btDbvtBroadphase_8cpp.html#a19b1dda96df6332570b535a0683d8076">clear</a>)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <span class="keywordflow">if</span> (area == <a class="code" href="../../da/d72/BKE__tracking_8h.html#aaab508f94a46bfc9cdfaf9fcd42e68cc">TRACK_AREA_NONE</a>)
<a name="l00208"></a>00208         <span class="keywordflow">return</span>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (clear) {
<a name="l00211"></a>00211         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#ab4192d16b894052764012d800617a817">TRACK_AREA_POINT</a>)
<a name="l00212"></a>00212             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp;= ~flag;
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#a9b47be689b38ead8e0bf5bffa886f415">TRACK_AREA_PAT</a>)
<a name="l00214"></a>00214             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec9e4b85457888f46e115bd7eecd8147">pat_flag</a> &amp;= ~flag;
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#a9a05cf93706881475a49ba08d4dd6e74">TRACK_AREA_SEARCH</a>)
<a name="l00216"></a>00216             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a0c81dbd39eaf96130d20074eceb8f73d">search_flag</a> &amp;= ~flag;
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218     <span class="keywordflow">else</span> {
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#ab4192d16b894052764012d800617a817">TRACK_AREA_POINT</a>)
<a name="l00220"></a>00220             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> |= flag;
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#a9b47be689b38ead8e0bf5bffa886f415">TRACK_AREA_PAT</a>)
<a name="l00222"></a>00222             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec9e4b85457888f46e115bd7eecd8147">pat_flag</a> |= flag;
<a name="l00223"></a>00223         <span class="keywordflow">if</span> (area &amp; <a class="code" href="../../da/d72/BKE__tracking_8h.html#a9a05cf93706881475a49ba08d4dd6e74">TRACK_AREA_SEARCH</a>)
<a name="l00224"></a>00224             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a0c81dbd39eaf96130d20074eceb8f73d">search_flag</a> |= flag;
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad896e28688ac05468d43f3c63b62464c">00228</a> <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a45af13c41af118eb40b58e5c688285c7">BKE_tracking_add_track</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y,
<a name="l00229"></a>00229                                            <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l00232"></a>00232     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> marker;
<a name="l00233"></a>00233     <a class="code" href="../../da/ddb/structMovieTrackingSettings.html">MovieTrackingSettings</a> *settings = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keywordtype">float</span> half_pattern = (float)settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a7004be3b02da2b819c9aab2c93ed9c47">default_pattern_size</a> / 2.0f;
<a name="l00236"></a>00236     <span class="keywordtype">float</span> half_search = (<span class="keywordtype">float</span>)settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ae0d9d6de3b92c0e28200fe384043760a">default_search_size</a> / 2.0f;
<a name="l00237"></a>00237     <span class="keywordtype">float</span> pat[2], search[2];
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     pat[0] = half_pattern / (float)width;
<a name="l00240"></a>00240     pat[1] = half_pattern / (float)height;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     search[0] = half_search / (float)width;
<a name="l00243"></a>00243     search[1] = half_search / (float)height;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     track = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a>), <span class="stringliteral">&quot;add_marker_exec track&quot;</span>);
<a name="l00246"></a>00246     strcpy(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a5ede2cebd7d3af52ad94c60a496c8781">name</a>, <span class="stringliteral">&quot;Track&quot;</span>);
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ad798c871b88d151b983fe028536118f7">default_tracker</a>;
<a name="l00249"></a>00249     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a3b2201f25d4e0cda7faef59a6d5730e5">pyramid_levels</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ac321bfb4a73f930617dd5c7bcb521400">default_pyramid_levels</a>;
<a name="l00250"></a>00250     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a23bc9b573f87bc80922ae41904e02b50">minimum_correlation</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a6aee59cdcaef29f803e6fcd8dac76af7">default_minimum_correlation</a>;
<a name="l00251"></a>00251     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ab9ac14b1c80dd6baab8b1b4e0ae7da97">margin</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ac2e578224b8947d1d97137fbd810ff33">default_margin</a>;
<a name="l00252"></a>00252     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aed2913a03a0fbc50ea3c4e623c8474a1">pattern_match</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#aa882c1a2cbdc22f276b17bc99ce915c2">default_pattern_match</a>;
<a name="l00253"></a>00253     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ae63d4668585cf20c43177c34fa76b2e8">frames_limit</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a0d850f32d7470c3cb4e2a4a68aac4737">default_frames_limit</a>;
<a name="l00254"></a>00254     track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> = settings-&gt;<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a71030fbb93309b2736b1308af4c560b2">default_flag</a>;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256     memset(&amp;marker, 0, <span class="keyword">sizeof</span>(marker));
<a name="l00257"></a>00257     marker.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[0] = x;
<a name="l00258"></a>00258     marker.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[1] = y;
<a name="l00259"></a>00259     marker.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> = framenr;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, pat);
<a name="l00262"></a>00262     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a847b296f38c5fb25588f3610e8674326">negate_v2_v2</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>, pat);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>, search);
<a name="l00265"></a>00265     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a847b296f38c5fb25588f3610e8674326">negate_v2_v2</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>, search);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ab5f0286aa6aad0ba36259383ce88e01a">TRACKER_KLT</a>)
<a name="l00270"></a>00270         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1dc460bb3ddf079500d4d03cf2bfae08">BKE_tracking_clamp_track</a>(track, <a class="code" href="../../da/d72/BKE__tracking_8h.html#ace9d1ceb9f5f14ee9b46c500bde5e417">CLAMP_PYRAMID_LEVELS</a>);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(tracksbase, track);
<a name="l00273"></a>00273     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a0b939ff1b691932a853cb3f978761993">BKE_track_unique_name</a>(tracksbase, track);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">return</span> track;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="../../de/ddb/tracking_8c.html#a60229fa5c94b4d27aa6ec5eda0afadca">00278</a> <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *old_marker= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>)
<a name="l00283"></a>00283         old_marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a56697c83fb3ce5f0db748213a3262f60">BKE_tracking_exact_marker</a>(track, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (old_marker) {
<a name="l00286"></a>00286         *old_marker = *marker;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="keywordflow">return</span> old_marker;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290     <span class="keywordflow">else</span> {
<a name="l00291"></a>00291         <span class="keywordtype">int</span> a = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="keywordflow">while</span> (a--) {
<a name="l00294"></a>00294             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &lt; marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>)
<a name="l00295"></a>00295                 <span class="keywordflow">break</span>;
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>++;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>)
<a name="l00301"></a>00301             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>)*track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>);
<a name="l00302"></a>00302         <span class="keywordflow">else</span>
<a name="l00303"></a>00303             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>), <span class="stringliteral">&quot;MovieTracking markers&quot;</span>);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         memmove(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>+a+2, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>+a+1, (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-a-2)*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>));
<a name="l00306"></a>00306         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a+1] = *marker;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2b2735036e73b8a60af1950f3471c876">last_marker</a> = a + 1;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a + 1];
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a><a class="code" href="../../de/ddb/tracking_8c.html#a4a5f1df774d13ac666004d68df6aec8e">00314</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a120f271cb93120631738abf00b473dd5">BKE_tracking_delete_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00315"></a>00315 {
<a name="l00316"></a>00316     <span class="keywordtype">int</span> a= 0;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">while</span> (a&lt;track-&gt;markersnr) {
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> == framenr) {
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> &gt; 1) {
<a name="l00321"></a>00321                 memmove(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>+a, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>+a+1, (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-a-1)*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>));
<a name="l00322"></a>00322                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>--;
<a name="l00323"></a>00323                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>)*track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>);
<a name="l00324"></a>00324             }
<a name="l00325"></a>00325             <span class="keywordflow">else</span> {
<a name="l00326"></a>00326                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00327"></a>00327                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00328"></a>00328                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> = 0;
<a name="l00329"></a>00329             }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331             <span class="keywordflow">break</span>;
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         a++;
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="../../de/ddb/tracking_8c.html#a03ddfefcd6a2db001cbf9c6d81418ab0">00338</a> <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <span class="keywordtype">int</span> a = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-1;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (!track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>)
<a name="l00343"></a>00343         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">/* approximate pre-first framenr marker with first marker */</span>
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (framenr &lt; track-&gt;markers[0].framenr)
<a name="l00347"></a>00347         <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[0];
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2b2735036e73b8a60af1950f3471c876">last_marker</a> &lt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>)
<a name="l00350"></a>00350         a = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2b2735036e73b8a60af1950f3471c876">last_marker</a>;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &lt;= framenr) {
<a name="l00353"></a>00353         <span class="keywordflow">while</span> (a &lt; track-&gt;markersnr &amp;&amp; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &lt;= framenr) {
<a name="l00354"></a>00354             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> == framenr) {
<a name="l00355"></a>00355                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2b2735036e73b8a60af1950f3471c876">last_marker</a> = a;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357                 <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359             a++;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362         <span class="comment">/* if there&#39;s no marker for exact position, use nearest marker from left side */</span>
<a name="l00363"></a>00363         <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a-1];
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365     <span class="keywordflow">else</span> {
<a name="l00366"></a>00366         <span class="keywordflow">while</span> (a &gt;= 0 &amp;&amp; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &gt;= framenr) {
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> == framenr) {
<a name="l00368"></a>00368                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2b2735036e73b8a60af1950f3471c876">last_marker</a> = a;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                 <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373             a--;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         <span class="comment">/* if there&#39;s no marker for exact position, use nearest marker from left side */</span>
<a name="l00377"></a>00377         <span class="keywordflow">return</span> &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a><a class="code" href="../../de/ddb/tracking_8c.html#a72248463f1959aaa99ddb40c9af4d5ea">00383</a> <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#adf9aae43031b0cc4bcf7e7416cecdc9e">BKE_tracking_ensure_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, framenr);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> != framenr) {
<a name="l00388"></a>00388         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> marker_new;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         marker_new = *marker;
<a name="l00391"></a>00391         marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> = framenr;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker_new);
<a name="l00394"></a>00394         marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, framenr);
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="keywordflow">return</span> marker;
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a><a class="code" href="../../de/ddb/tracking_8c.html#a68e6e1690f22b5442f335ebf19cdec56">00400</a> <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a56697c83fb3ce5f0db748213a3262f60">BKE_tracking_exact_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, framenr);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">if</span> (marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> != framenr)
<a name="l00405"></a>00405         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="keywordflow">return</span> marker;
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a><a class="code" href="../../de/ddb/tracking_8c.html#a4db08132503c927b9a0b28802a2d5716">00410</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ac3727512fef6dac2b9bd9638ff108e8c">BKE_tracking_has_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412     <span class="keywordflow">return</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a56697c83fb3ce5f0db748213a3262f60">BKE_tracking_exact_marker</a>(track, framenr) != 0;
<a name="l00413"></a>00413 }
<a name="l00414"></a>00414 
<a name="l00415"></a><a class="code" href="../../de/ddb/tracking_8c.html#add4727512da6b301f9e2c5d863e5c252">00415</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a2a514c295070bfb8630bf8195a0f6752">BKE_tracking_has_enabled_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> framenr)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a56697c83fb3ce5f0db748213a3262f60">BKE_tracking_exact_marker</a>(track, framenr);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="keywordflow">return</span> marker &amp;&amp; (marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) == 0;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="../../de/ddb/tracking_8c.html#a414c4cad6c3b2fb0ddcb4814b52f9d6a">00422</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a523bbe05203b6ff11958f8adf8e6a770">BKE_tracking_free_track</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>)
<a name="l00425"></a>00425         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">00428</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *ref_marker, <span class="keywordtype">int</span> before, <span class="keywordtype">int</span> overwrite)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> marker_new;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     marker_new = *ref_marker;
<a name="l00433"></a>00433     marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp;= ~<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ae82a1c87be95f416b45c5a0c25270a83">MARKER_TRACKED</a>;
<a name="l00434"></a>00434     marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (before)
<a name="l00437"></a>00437         marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>--;
<a name="l00438"></a>00438     <span class="keywordflow">else</span>
<a name="l00439"></a>00439         marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>++;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (!<a class="code" href="../../da/d72/BKE__tracking_8h.html#ac3727512fef6dac2b9bd9638ff108e8c">BKE_tracking_has_marker</a>(track, marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>) || overwrite)
<a name="l00442"></a>00442         <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker_new);
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="../../de/ddb/tracking_8c.html#aad18aa521329e8712f4f34f264f90537">00445</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6686836b8945f4c1c710cbc40af1ab8d">BKE_tracking_clear_path</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> ref_frame, <span class="keywordtype">int</span> action)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447     <span class="keywordtype">int</span> a;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (action == <a class="code" href="../../da/d72/BKE__tracking_8h.html#ab15a6fa2c7e37b7da7ba7f7783e7610a">TRACK_CLEAR_REMAINED</a>) {
<a name="l00450"></a>00450         a = 1;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <span class="keywordflow">while</span> (a &lt; track-&gt;markersnr) {
<a name="l00453"></a>00453             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &gt; ref_frame) {
<a name="l00454"></a>00454                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> = a;
<a name="l00455"></a>00455                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>)*track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457                 <span class="keywordflow">break</span>;
<a name="l00458"></a>00458             }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460             a++;
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>)
<a name="l00464"></a>00464             <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-1], 0, 1);
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="../../da/d72/BKE__tracking_8h.html#a86dc3fd48cbff992e2b3115a15b3cfbb">TRACK_CLEAR_UPTO</a>) {
<a name="l00467"></a>00467         a= track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-1;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="keywordflow">while</span> (a &gt;= 0) {
<a name="l00470"></a>00470             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &lt;= ref_frame) {
<a name="l00471"></a>00471                 memmove(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>+a, (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-a)*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>));
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-a;
<a name="l00474"></a>00474                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>)*track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476                 <span class="keywordflow">break</span>;
<a name="l00477"></a>00477             }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479             a--;
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>)
<a name="l00483"></a>00483             <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[0], 1, 1);
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (action == <a class="code" href="../../da/d72/BKE__tracking_8h.html#a76a916ff01cf58665f01b1d3cf6c8657">TRACK_CLEAR_ALL</a>) {
<a name="l00486"></a>00486         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker, marker_new;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, ref_frame);
<a name="l00489"></a>00489         marker_new = *marker;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00492"></a>00492         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00493"></a>00493         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> = 0;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker_new);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, &amp;marker_new, 1, 1);
<a name="l00498"></a>00498         <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, &amp;marker_new, 0, 1);
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="../../de/ddb/tracking_8c.html#a0552ea509b3eca211db6fbb30e0728f3">00502</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ac4f61ffd0466ca78fb877bbced37226c">BKE_tracking_join_tracks</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *dst_track, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *src_track)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, a = 0, b = 0, tot;
<a name="l00505"></a>00505     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *markers;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     tot = dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> + src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>;
<a name="l00508"></a>00508     markers = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(tot * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>), <span class="stringliteral">&quot;tmp tracking joined tracks&quot;</span>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="keywordflow">while</span> (a &lt; src_track-&gt;markersnr || b &lt; dst_track-&gt;markersnr) {
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (b &gt;= dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>) {
<a name="l00512"></a>00512             markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a++];
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a &gt;= src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>) {
<a name="l00515"></a>00515             markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b++];
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &lt; dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>) {
<a name="l00518"></a>00518             markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a++];
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> &gt; dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>) {
<a name="l00521"></a>00521             markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b++];
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523         <span class="keywordflow">else</span> {
<a name="l00524"></a>00524             <span class="keywordflow">if</span> ((src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>)==0) {
<a name="l00525"></a>00525                 <span class="keywordflow">if</span> ((dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; MARKER_DISABLED)==0) {
<a name="l00526"></a>00526                     <span class="comment">/* both tracks are enabled on this frame, so find the whole segment</span>
<a name="l00527"></a>00527 <span class="comment">                     * on which tracks are intersecting and blend tracks using linear</span>
<a name="l00528"></a>00528 <span class="comment">                     * interpolation to prevent jumps */</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530                     <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker_a, *marker_b;
<a name="l00531"></a>00531                     <span class="keywordtype">int</span> start_a = a, start_b = b, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a> = 0, frame = src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>;
<a name="l00532"></a>00532                     <span class="keywordtype">int</span> j, <a class="code" href="../../d9/d42/btQuaternion_8h.html#ae51e49cc6a687e7b1534a6a03fafe2c8" title="Return the inverse of a quaternion.">inverse</a> = 0;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534                     inverse = (b == 0) ||
<a name="l00535"></a>00535                               (dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b-1].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; MARKER_DISABLED) ||
<a name="l00536"></a>00536                               (dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b-1].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> != frame - 1);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538                     <span class="comment">/* find length of intersection */</span>
<a name="l00539"></a>00539                     <span class="keywordflow">while</span> (a &lt; src_track-&gt;markersnr &amp;&amp; b &lt; dst_track-&gt;markersnr) {
<a name="l00540"></a>00540                         marker_a = &amp;src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00541"></a>00541                         marker_b = &amp;dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b];
<a name="l00542"></a>00542 
<a name="l00543"></a>00543                         <span class="keywordflow">if</span> (marker_a-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; MARKER_DISABLED || marker_b-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; MARKER_DISABLED)
<a name="l00544"></a>00544                             <span class="keywordflow">break</span>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546                         <span class="keywordflow">if</span> (marker_a-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> != frame || marker_b-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> != frame)
<a name="l00547"></a>00547                             <span class="keywordflow">break</span>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549                         frame++;
<a name="l00550"></a>00550                         len++;
<a name="l00551"></a>00551                         a++;
<a name="l00552"></a>00552                         b++;
<a name="l00553"></a>00553                     }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555                     a = start_a;
<a name="l00556"></a>00556                     b = start_b;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558                     <span class="comment">/* linear interpolation for intersecting frames */</span>
<a name="l00559"></a>00559                     <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; j++) {
<a name="l00560"></a>00560                         <span class="keywordtype">float</span> fac = 0.5f;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                         <span class="keywordflow">if</span> (len &gt; 1)
<a name="l00563"></a>00563                             fac = 1.0f / (len - 1) * j;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                         <span class="keywordflow">if</span> (inverse)
<a name="l00566"></a>00566                             fac = 1.0f - fac;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                         marker_a = &amp;src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00569"></a>00569                         marker_b = &amp;dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b];
<a name="l00570"></a>00570 
<a name="l00571"></a>00571                         markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b];
<a name="l00572"></a>00572                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(markers[i].pos, marker_b-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, marker_a-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, fac);
<a name="l00573"></a>00573                         a++;
<a name="l00574"></a>00574                         b++;
<a name="l00575"></a>00575                         i++;
<a name="l00576"></a>00576                     }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578                     <span class="comment">/* this values will be incremented at the end of the loop cycle */</span>
<a name="l00579"></a>00579                     a--; b--; i--;
<a name="l00580"></a>00580                 }
<a name="l00581"></a>00581                 <span class="keywordflow">else</span> markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = src_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l00582"></a>00582             }
<a name="l00583"></a>00583             <span class="keywordflow">else</span> markers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[b];
<a name="l00584"></a>00584 
<a name="l00585"></a>00585             a++;
<a name="l00586"></a>00586             b++;
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         i++;
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(i*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>), <span class="stringliteral">&quot;tracking joined tracks&quot;</span>);
<a name="l00595"></a>00595     memcpy(dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>, markers, i*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a>));
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     dst_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(markers);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a><a class="code" href="../../de/ddb/tracking_8c.html#a04889d03f3d3eaf1d4cba20fec4e7634">00602</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a04889d03f3d3eaf1d4cba20fec4e7634">tracking_tracks_free</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>)
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="keywordflow">for</span> (track = tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; track; track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>) {
<a name="l00607"></a>00607         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a523bbe05203b6ff11958f8adf8e6a770">BKE_tracking_free_track</a>(track);
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(tracks);
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="../../de/ddb/tracking_8c.html#a90e48c212e1a97d9c61d86af7584a78f">00613</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a90e48c212e1a97d9c61d86af7584a78f">tracking_reconstruction_free</a>(<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>)
<a name="l00616"></a>00616         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>);
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="../../de/ddb/tracking_8c.html#a0b7378a1c422f76e846446735aed3b25">00619</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a0b7378a1c422f76e846446735aed3b25">tracking_object_free</a>(<a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621     <a class="code" href="../../de/ddb/tracking_8c.html#a04889d03f3d3eaf1d4cba20fec4e7634">tracking_tracks_free</a>(&amp;object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a6b02c7f7e4eb6807acefb344d36fc07c">tracks</a>);
<a name="l00622"></a>00622     <a class="code" href="../../de/ddb/tracking_8c.html#a90e48c212e1a97d9c61d86af7584a78f">tracking_reconstruction_free</a>(&amp;object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a94d8bb0ba214e1dfd431530a6fb17af3">reconstruction</a>);
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a><a class="code" href="../../de/ddb/tracking_8c.html#a3a61fe694c8c01bc9f4a7874c35df7c3">00625</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a3a61fe694c8c01bc9f4a7874c35df7c3">tracking_objects_free</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *objects)
<a name="l00626"></a>00626 {
<a name="l00627"></a>00627     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *object;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     <span class="keywordflow">for</span> (<span class="keywordtype">object</span> = objects-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; <span class="keywordtype">object</span>; <span class="keywordtype">object</span> = object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a9c25b559861625fafa9281d308689f46">next</a>)
<a name="l00630"></a>00630         <a class="code" href="../../de/ddb/tracking_8c.html#a0b7378a1c422f76e846446735aed3b25">tracking_object_free</a>(<span class="keywordtype">object</span>);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(objects);
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="../../de/ddb/tracking_8c.html#a64c4e6693c24e09efa4fec35f06cef9a">00635</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6d68140a96c26445ba29c802be59e0a5">BKE_tracking_free</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     <a class="code" href="../../de/ddb/tracking_8c.html#a04889d03f3d3eaf1d4cba20fec4e7634">tracking_tracks_free</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>);
<a name="l00638"></a>00638     <a class="code" href="../../de/ddb/tracking_8c.html#a90e48c212e1a97d9c61d86af7584a78f">tracking_reconstruction_free</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a08fa44e235d5e8555098950eca818076">reconstruction</a>);
<a name="l00639"></a>00639     <a class="code" href="../../de/ddb/tracking_8c.html#a3a61fe694c8c01bc9f4a7874c35df7c3">tracking_objects_free</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#aa31124cc2c83761d5a93ac50679ae9f3">scaleibuf</a>)
<a name="l00642"></a>00642         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#aa31124cc2c83761d5a93ac50679ae9f3">scaleibuf</a>);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="keywordflow">if</span> (tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a>)
<a name="l00645"></a>00645         <a class="code" href="../../da/d72/BKE__tracking_8h.html#aa7c948cbe0d344d925709216b6fb8132">BKE_tracking_distortion_destroy</a>(tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a>);
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a><a class="code" href="../../de/ddb/tracking_8c.html#a796cf9ff7ea7370a10941877397347b5">00648</a> <span class="keyword">static</span> <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../de/ddb/tracking_8c.html#a796cf9ff7ea7370a10941877397347b5">duplicate_track</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *new_track;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     new_track = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a>), <span class="stringliteral">&quot;tracksMapMerge new_track&quot;</span>);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     *new_track = *track;
<a name="l00655"></a>00655     new_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a> = new_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#af323eaf3ab4ff06de60af9353ef1e59f">prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     new_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(new_track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="keywordflow">return</span> new_track;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 <span class="comment">/*********************** clipboard *************************/</span>
<a name="l00663"></a>00663 
<a name="l00664"></a><a class="code" href="../../de/ddb/tracking_8c.html#aa2e72d0a9ae5dfb064ee61d8825dbc34">00664</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#aa2e72d0a9ae5dfb064ee61d8825dbc34">BKE_tracking_free_clipboard</a>(<span class="keywordtype">void</span>)
<a name="l00665"></a>00665 {
<a name="l00666"></a>00666     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track = <a class="code" href="../../de/ddb/tracking_8c.html#afc1ca0b79c156183fe8b82a217e79f26">tracking_clipboard</a>.tracks.first, *next_track;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">while</span> (track) {
<a name="l00669"></a>00669         next_track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a523bbe05203b6ff11958f8adf8e6a770">BKE_tracking_free_track</a>(track);
<a name="l00672"></a>00672         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         track = next_track;
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../de/ddb/tracking_8c.html#af6532f72194db53c271965a7024ba8a3">00678</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#aa5283b2e25617cffd5f2f95136e91833">BKE_tracking_clipboard_copy_tracks</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l00681"></a>00681     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">while</span> (track) {
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (<a class="code" href="../../da/d72/BKE__tracking_8h.html#a51e36c49c74337e823a5d095389cf158">TRACK_SELECTED</a>(track) &amp;&amp; (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aa1baad05f9de7e624727dcdab9f9d64e">TRACK_HIDDEN</a>) == 0) {
<a name="l00685"></a>00685             <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *new_track = <a class="code" href="../../de/ddb/tracking_8c.html#a796cf9ff7ea7370a10941877397347b5">duplicate_track</a>(track);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;<a class="code" href="../../de/ddb/tracking_8c.html#afc1ca0b79c156183fe8b82a217e79f26">tracking_clipboard</a>.tracks, new_track);
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a><a class="code" href="../../de/ddb/tracking_8c.html#a91908d309a94eb92e6e22151954552b1">00694</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a91908d309a94eb92e6e22151954552b1">BKE_tracking_clipboard_has_tracks</a>(<span class="keywordtype">void</span>)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696     <span class="keywordflow">return</span> <a class="code" href="../../de/ddb/tracking_8c.html#afc1ca0b79c156183fe8b82a217e79f26">tracking_clipboard</a>.tracks.first != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a><a class="code" href="../../de/ddb/tracking_8c.html#ae8340829864e65fedf9b93d631742113">00699</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a284b9795c4ba0cb98229f4b2f6420b7e">BKE_tracking_clipboard_paste_tracks</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l00702"></a>00702     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track = <a class="code" href="../../de/ddb/tracking_8c.html#afc1ca0b79c156183fe8b82a217e79f26">tracking_clipboard</a>.tracks.first;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="keywordflow">while</span> (track) {
<a name="l00705"></a>00705         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *new_track = <a class="code" href="../../de/ddb/tracking_8c.html#a796cf9ff7ea7370a10941877397347b5">duplicate_track</a>(track);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(tracksbase, new_track);
<a name="l00708"></a>00708         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a0b939ff1b691932a853cb3f978761993">BKE_track_unique_name</a>(tracksbase, new_track);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/*********************** tracks map *************************/</span>
<a name="l00715"></a>00715 
<a name="l00716"></a><a class="code" href="../../d3/dea/structTracksMap.html">00716</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> {
<a name="l00717"></a><a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">00717</a>     <span class="keywordtype">char</span> <a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">object_name</a>[<a class="code" href="../../d1/db4/DNA__defs_8h.html#ac7c0207aa5a0e10d378be03b68041350">MAX_NAME</a>];
<a name="l00718"></a><a class="code" href="../../d3/dea/structTracksMap.html#a8bd8ff06b65f193cf5a41fa73a7a7543">00718</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dea/structTracksMap.html#a8bd8ff06b65f193cf5a41fa73a7a7543">is_camera</a>;
<a name="l00719"></a>00719 
<a name="l00720"></a><a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">00720</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">num_tracks</a>;
<a name="l00721"></a><a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">00721</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a>;
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">00723</a>     <span class="keywordtype">char</span> *<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>;
<a name="l00724"></a><a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">00724</a>     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>;
<a name="l00725"></a>00725 
<a name="l00726"></a><a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">00726</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>;
<a name="l00727"></a>00727 
<a name="l00728"></a><a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">00728</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">ptr</a>;
<a name="l00729"></a>00729 } <a class="code" href="../../de/ddb/tracking_8c.html#a86d76fd8a30f96dfad95c6a3858a37b5">TracksMap</a>;
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="../../de/ddb/tracking_8c.html#a07e55f35f153281ccf9d80a33fafb3a8">00731</a> <span class="keyword">static</span> <a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *<a class="code" href="../../de/ddb/tracking_8c.html#a07e55f35f153281ccf9d80a33fafb3a8">tracks_map_new</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *object_name, <span class="keywordtype">int</span> is_camera, <span class="keywordtype">int</span> num_tracks, <span class="keywordtype">int</span> customdata_size)
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733     <a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a>), <span class="stringliteral">&quot;TrackingsMap&quot;</span>);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">object_name</a>, object_name, <span class="keyword">sizeof</span>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">object_name</a>));
<a name="l00736"></a>00736     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a8bd8ff06b65f193cf5a41fa73a7a7543">is_camera</a> = is_camera;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">num_tracks</a> = num_tracks;
<a name="l00739"></a>00739     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a> = customdata_size;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a>)*num_tracks, <span class="stringliteral">&quot;TrackingsMap tracks&quot;</span>);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (customdata_size)
<a name="l00744"></a>00744         map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(customdata_size*num_tracks, <span class="stringliteral">&quot;TracksMap customdata&quot;</span>);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;TracksMap hash&quot;</span>);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keywordflow">return</span> map;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a><a class="code" href="../../de/ddb/tracking_8c.html#ab64b20238c2d09ea371392e4b4952c75">00751</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/ddb/tracking_8c.html#ab64b20238c2d09ea371392e4b4952c75">tracks_map_size</a>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map)
<a name="l00752"></a>00752 {
<a name="l00753"></a>00753     <span class="keywordflow">return</span> map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">num_tracks</a>;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a><a class="code" href="../../de/ddb/tracking_8c.html#a6f91863f90e0e77f8aefc759295d036b">00756</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a6f91863f90e0e77f8aefc759295d036b">tracks_map_get</a>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map, <span class="keywordtype">int</span> index, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> **track, <span class="keywordtype">void</span> **customdata)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     *track = &amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>[index];
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>)
<a name="l00761"></a>00761         *customdata = &amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>[index*map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a>];
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="../../de/ddb/tracking_8c.html#ab4ac4f5c164480f3b4ec5d2573d7132f">00764</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#ab4ac4f5c164480f3b4ec5d2573d7132f">tracks_map_insert</a>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">void</span> *customdata)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> new_track= *track;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     new_track.<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(new_track.<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>[map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">ptr</a>] = new_track;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     <span class="keywordflow">if</span> (customdata)
<a name="l00773"></a>00773         memcpy(&amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>[map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">ptr</a>*map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a>], customdata, map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a>);
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>, &amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>[map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">ptr</a>], track);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a84e08247696df3b0ae27fc8a238d5069">ptr</a>++;
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a><a class="code" href="../../de/ddb/tracking_8c.html#a278e8f6edc4d4bf240cfc411a28b457a">00780</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a278e8f6edc4d4bf240cfc411a28b457a">tracks_map_merge</a>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l00783"></a>00783     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *act_track = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a8f9e672798114ca61c2b66776bf4a6c8">BKE_tracking_active_track</a>(tracking);
<a name="l00784"></a>00784     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *rot_track = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a>;
<a name="l00785"></a>00785     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a> = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}, new_tracks = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00786"></a>00786     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *old_tracks;
<a name="l00787"></a>00787     <span class="keywordtype">int</span> a;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="keywordflow">if</span> (map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a8bd8ff06b65f193cf5a41fa73a7a7543">is_camera</a>) {
<a name="l00790"></a>00790         old_tracks = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>;
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792     <span class="keywordflow">else</span> {
<a name="l00793"></a>00793         <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a44872d3e133985f2608b4a5b3465417e">BKE_tracking_named_object</a>(tracking, map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">object_name</a>);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (!<span class="keywordtype">object</span>) {
<a name="l00796"></a>00796             <span class="comment">/* object was deleted by user, create new one */</span>
<a name="l00797"></a>00797             <span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#aaa24525c80d4ace1d53606d850992e76">BKE_tracking_new_object</a>(tracking, map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a0e31ce5212db084c6973fb915ea8d160">object_name</a>);
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         old_tracks = &amp;<span class="keywordtype">object</span>-&gt;tracks;
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <span class="comment">/* duplicate currently operating tracks to temporary list.</span>
<a name="l00804"></a>00804 <span class="comment">     * this is needed to keep names in unique state and it&#39;s faster to change names</span>
<a name="l00805"></a>00805 <span class="comment">     * of currently operating tracks (if needed) */</span>
<a name="l00806"></a>00806     <span class="keywordflow">for</span> (a = 0; a &lt; map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">num_tracks</a>; a++) {
<a name="l00807"></a>00807         <span class="keywordtype">int</span> replace_sel = 0, replace_rot = 0;
<a name="l00808"></a>00808         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *new_track, *old;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         track = &amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>[a];
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="comment">/* find original of operating track in list of previously displayed tracks */</span>
<a name="l00813"></a>00813         old = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>, track);
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (old) {
<a name="l00815"></a>00815             <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *cur = old_tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817             <span class="keywordflow">while</span> (cur) {
<a name="l00818"></a>00818                 <span class="keywordflow">if</span> (cur == old)
<a name="l00819"></a>00819                     <span class="keywordflow">break</span>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821                 cur = cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824             <span class="comment">/* original track was found, re-use flags and remove this track */</span>
<a name="l00825"></a>00825             <span class="keywordflow">if</span> (cur) {
<a name="l00826"></a>00826                 <span class="keywordflow">if</span> (cur == act_track)
<a name="l00827"></a>00827                     replace_sel = 1;
<a name="l00828"></a>00828                 <span class="keywordflow">if</span> (cur == rot_track)
<a name="l00829"></a>00829                     replace_rot = 1;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> = cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a>;
<a name="l00832"></a>00832                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec9e4b85457888f46e115bd7eecd8147">pat_flag</a> = cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec9e4b85457888f46e115bd7eecd8147">pat_flag</a>;
<a name="l00833"></a>00833                 track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a0c81dbd39eaf96130d20074eceb8f73d">search_flag</a> = cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a0c81dbd39eaf96130d20074eceb8f73d">search_flag</a>;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835                 <a class="code" href="../../da/d72/BKE__tracking_8h.html#a523bbe05203b6ff11958f8adf8e6a770">BKE_tracking_free_track</a>(cur);
<a name="l00836"></a>00836                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(old_tracks, cur);
<a name="l00837"></a>00837             }
<a name="l00838"></a>00838         }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840         new_track = <a class="code" href="../../de/ddb/tracking_8c.html#a796cf9ff7ea7370a10941877397347b5">duplicate_track</a>(track);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>, track, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); <span class="comment">/* XXX: are we actually need this */</span>
<a name="l00843"></a>00843         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>, track, new_track);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         <span class="keywordflow">if</span> (replace_sel)        <span class="comment">/* update current selection in clip */</span>
<a name="l00846"></a>00846             tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a>= new_track;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (replace_rot)        <span class="comment">/* update track used for rotation stabilization */</span>
<a name="l00849"></a>00849             tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a>= new_track;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;tracks, new_track);
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     <span class="comment">/* move all tracks, which aren&#39;t operating */</span>
<a name="l00855"></a>00855     track = old_tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00856"></a>00856     <span class="keywordflow">while</span> (track) {
<a name="l00857"></a>00857         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a> = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a> = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#af323eaf3ab4ff06de60af9353ef1e59f">prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00860"></a>00860         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;new_tracks, track);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         track= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">/* now move all tracks which are currently operating and keep their names unique */</span>
<a name="l00866"></a>00866     track = tracks.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00867"></a>00867     <span class="keywordflow">while</span> (track) {
<a name="l00868"></a>00868         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a> = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;tracks, track);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872         track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a> = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#af323eaf3ab4ff06de60af9353ef1e59f">prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00873"></a>00873         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;new_tracks, track);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(&amp;new_tracks, track, <span class="stringliteral">&quot;Track&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, offsetof(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a>, name), <span class="keyword">sizeof</span>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a5ede2cebd7d3af52ad94c60a496c8781">name</a>));
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         track= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     *old_tracks= new_tracks;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="../../de/ddb/tracking_8c.html#a8cd6b3257043dd18f5c33f2c350c2455">00883</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a8cd6b3257043dd18f5c33f2c350c2455">tracks_map_free</a>(<a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *map, <span class="keywordtype">void</span> (*customdata_free) (<span class="keywordtype">void</span> *customdata))
<a name="l00884"></a>00884 {
<a name="l00885"></a>00885     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>= 0;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#aa7866676dcff724d00be9ebafc78805a">hash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">for</span> (i = 0; i &lt; map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a3bed965995d52d5f9466d41b7a1e6f7f">num_tracks</a>; i++) {
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a> &amp;&amp; customdata_free)
<a name="l00891"></a>00891             customdata_free(&amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>[i*map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#ad087daee106e8a85ce3047fbb8165f73">customdata_size</a>]);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a523bbe05203b6ff11958f8adf8e6a770">BKE_tracking_free_track</a>(&amp;map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>[i]);
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="keywordflow">if</span> (map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>)
<a name="l00897"></a>00897         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#afcc731f089361bc3435dd9ef600311e0">customdata</a>);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(map-&gt;<a class="code" href="../../d3/dea/structTracksMap.html#a9ec1274817525a1f10cbd95f233cbac2">tracks</a>);
<a name="l00900"></a>00900     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(map);
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="comment">/*********************** tracking *************************/</span>
<a name="l00904"></a>00904 
<a name="l00905"></a><a class="code" href="../../d2/d28/structTrackContext.html">00905</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a> {
<a name="l00906"></a>00906 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span>    <span class="keywordtype">float</span> keyframed_pos[2];
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="keyword">struct </span>libmv_RegionTracker *region_tracker;
<a name="l00910"></a>00910     <span class="keywordtype">float</span> *patch;           <span class="comment">/* keyframed patch */</span>
<a name="l00911"></a>00911 <span class="preprocessor">#else</span>
<a name="l00912"></a><a class="code" href="../../d2/d28/structTrackContext.html#a58e0794fff565a6aeaced10695d1b994">00912</a> <span class="preprocessor"></span>    <span class="keywordtype">int</span> <a class="code" href="../../d2/d28/structTrackContext.html#a58e0794fff565a6aeaced10695d1b994">pad</a>;
<a name="l00913"></a>00913 <span class="preprocessor">#endif</span>
<a name="l00914"></a>00914 <span class="preprocessor"></span>} <a class="code" href="../../de/ddb/tracking_8c.html#acf77eeec9748d6d7d73d2c562b37cae0">TrackContext</a>;
<a name="l00915"></a>00915 
<a name="l00916"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html">00916</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> {
<a name="l00917"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">00917</a>     <a class="code" href="../../d8/dac/structMovieClipUser.html">MovieClipUser</a> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>;
<a name="l00918"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">00918</a>     <a class="code" href="../../d0/d44/structMovieClip.html">MovieClip</a> *<a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">clip</a>;
<a name="l00919"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#a4f001075c9aec69334ab7005ce5b6e21">00919</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a4f001075c9aec69334ab7005ce5b6e21">clip_flag</a>;
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#a765cd9dd9897be3a399fb39127eae23e">00921</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a132fb1986fe3a24643a5622841065e21">first_time</a>, <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a765cd9dd9897be3a399fb39127eae23e">frames</a>;
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#aa2192cb826adc223dafc07d638d40c34">00923</a>     <a class="code" href="../../da/ddb/structMovieTrackingSettings.html">MovieTrackingSettings</a> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#aa2192cb826adc223dafc07d638d40c34">settings</a>;
<a name="l00924"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">00924</a>     <a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>;
<a name="l00925"></a>00925 
<a name="l00926"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#ad1e45a51dd3f63eb19e6935082056af4">00926</a>     <span class="keywordtype">short</span> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>, <a class="code" href="../../da/d2a/structMovieTrackingContext.html#ad1e45a51dd3f63eb19e6935082056af4">sequence</a>;
<a name="l00927"></a><a class="code" href="../../da/d2a/structMovieTrackingContext.html#a532176d73f2a52edb3eb963ad9772e4f">00927</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d2a/structMovieTrackingContext.html#a532176d73f2a52edb3eb963ad9772e4f">sync_frame</a>;
<a name="l00928"></a>00928 } <a class="code" href="../../de/ddb/tracking_8c.html#a0fae43dacdee1124fd06d77eafe18e3c">MovieTrackingContext</a>;
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="../../de/ddb/tracking_8c.html#a1acd25a46dd14ba92fa156ae6bc419ba">00930</a> <a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a01cd6679d40f2d588c85b503ddedad9c">BKE_tracking_context_new</a>(<a class="code" href="../../d0/d44/structMovieClip.html">MovieClip</a> *clip, <a class="code" href="../../d8/dac/structMovieClipUser.html">MovieClipUser</a> *user, <span class="keywordtype">short</span> backwards, <span class="keywordtype">short</span> sequence)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a>), <span class="stringliteral">&quot;trackingContext&quot;</span>);
<a name="l00933"></a>00933     <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking = &amp;clip-&gt;<a class="code" href="../../d0/d44/structMovieClip.html#ad152541b1860f6ba2761a16270df8159">tracking</a>;
<a name="l00934"></a>00934     <a class="code" href="../../da/ddb/structMovieTrackingSettings.html">MovieTrackingSettings</a> *settings = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>;
<a name="l00935"></a>00935     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a306f9d42cfc651d8620b0d31bfbebd98">BKE_tracking_get_tracks</a>(tracking);
<a name="l00936"></a>00936     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l00937"></a>00937     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a80f28d9682b0ac7ef0330d8ba9ce06f3">BKE_tracking_active_object</a>(tracking);
<a name="l00938"></a>00938     <span class="keywordtype">int</span> num_tracks = 0;
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#aa2192cb826adc223dafc07d638d40c34">settings</a> = *settings;
<a name="l00941"></a>00941     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a> = backwards;
<a name="l00942"></a>00942     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a532176d73f2a52edb3eb963ad9772e4f">sync_frame</a> = user-&gt;<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>;
<a name="l00943"></a>00943     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a132fb1986fe3a24643a5622841065e21">first_time</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00944"></a>00944     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#ad1e45a51dd3f63eb19e6935082056af4">sequence</a> = sequence;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     <span class="comment">/* count */</span>
<a name="l00947"></a>00947     track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00948"></a>00948     <span class="keywordflow">while</span> (track) {
<a name="l00949"></a>00949         <span class="keywordflow">if</span> (<a class="code" href="../../da/d72/BKE__tracking_8h.html#a51e36c49c74337e823a5d095389cf158">TRACK_SELECTED</a>(track) &amp;&amp; (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; (<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a49f735da8b3ad3c977403a791df82088">TRACK_LOCKED</a> | <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aa1baad05f9de7e624727dcdab9f9d64e">TRACK_HIDDEN</a>))==0) {
<a name="l00950"></a>00950             <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, user-&gt;<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952             <span class="keywordflow">if</span> ((marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) == 0)
<a name="l00953"></a>00953                 num_tracks++;
<a name="l00954"></a>00954         }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">if</span> (num_tracks) {
<a name="l00960"></a>00960         <span class="keywordtype">int</span> width, height;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a> = <a class="code" href="../../de/ddb/tracking_8c.html#a07e55f35f153281ccf9d80a33fafb3a8">tracks_map_new</a>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>, object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>,
<a name="l00963"></a>00963                                              num_tracks, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a>));
<a name="l00964"></a>00964 
<a name="l00965"></a>00965         <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a8a4175f34b2cac47fd4b35d530220a01">BKE_movieclip_get_size</a>(clip, user, &amp;width, &amp;height);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967         <span class="comment">/* create tracking data */</span>
<a name="l00968"></a>00968         track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00969"></a>00969         <span class="keywordflow">while</span> (track) {
<a name="l00970"></a>00970             <span class="keywordflow">if</span> (<a class="code" href="../../da/d72/BKE__tracking_8h.html#a51e36c49c74337e823a5d095389cf158">TRACK_SELECTED</a>(track) &amp;&amp; (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; (<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aa1baad05f9de7e624727dcdab9f9d64e">TRACK_HIDDEN</a> | <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a49f735da8b3ad3c977403a791df82088">TRACK_LOCKED</a>)) == 0) {
<a name="l00971"></a>00971                 <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, user-&gt;<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973                 <span class="keywordflow">if</span> ((marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) == 0) {
<a name="l00974"></a>00974                     <a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a> track_context;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976                     memset(&amp;track_context, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a>));
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span>                    {
<a name="l00980"></a>00980                         <span class="keywordtype">float</span> patx = (int)((track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[0]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[0])*width),
<a name="l00981"></a>00981                               paty = (<span class="keywordtype">int</span>)((track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[1]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[1])*height);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983                         <span class="keywordtype">float</span> search_size_x = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[0]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[0])*width;
<a name="l00984"></a>00984                         <span class="keywordtype">float</span> search_size_y = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[1]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[1])*height;
<a name="l00985"></a>00985                         <span class="keywordtype">float</span> pattern_size_x = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[0]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[0])*width;
<a name="l00986"></a>00986                         <span class="keywordtype">float</span> pattern_size_y = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>[1]-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>[1])*height;
<a name="l00987"></a>00987                         <span class="keywordtype">int</span> wndx = (int)patx / 2, wndy = (<span class="keywordtype">int</span>)paty / 2;
<a name="l00988"></a>00988                         <span class="keywordtype">int</span> half_wnd = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(wndx, wndy);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                             <span class="comment">/* compute the maximum pyramid size */</span>
<a name="l00991"></a>00991                         <span class="keywordtype">float</span> search_to_pattern_ratio = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(search_size_x,  search_size_y)
<a name="l00992"></a>00992                             / <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pattern_size_x, pattern_size_y);
<a name="l00993"></a>00993                         <span class="keywordtype">float</span> log2_search_to_pattern_ratio = <a class="code" href="../../d1/d22/stdosl_8h.html#a652ed6fadc80671ca500c85d11bce898">log</a>(floor(search_to_pattern_ratio)) / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a92428112a5d24721208748774a4f23e6">M_LN2</a>;
<a name="l00994"></a>00994                         <span class="keywordtype">int</span> max_pyramid_levels = floor(log2_search_to_pattern_ratio + 1);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996                         <span class="comment">/* try to accommodate the user&#39;s choice of pyramid level in a way</span>
<a name="l00997"></a>00997 <span class="comment">                         * that doesn&#39;t cause the coarsest pyramid pattern to be larger</span>
<a name="l00998"></a>00998 <span class="comment">                         * than the search size */</span>
<a name="l00999"></a>00999                         <span class="keywordtype">int</span> level = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a3b2201f25d4e0cda7faef59a6d5730e5">pyramid_levels</a>, max_pyramid_levels);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001                         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a>==<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ab5f0286aa6aad0ba36259383ce88e01a">TRACKER_KLT</a>) {
<a name="l01002"></a>01002                             track_context.region_tracker =
<a name="l01003"></a>01003                                 libmv_pyramidRegionTrackerNew(100, level, half_wnd, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a23bc9b573f87bc80922ae41904e02b50">minimum_correlation</a>);
<a name="l01004"></a>01004                         }
<a name="l01005"></a>01005                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a1d5e94d8587edec89d13615c23c74a06">TRACKER_HYBRID</a>) {
<a name="l01006"></a>01006                             track_context.region_tracker =
<a name="l01007"></a>01007                                 libmv_hybridRegionTrackerNew(100, half_wnd, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a23bc9b573f87bc80922ae41904e02b50">minimum_correlation</a>);
<a name="l01008"></a>01008                         }
<a name="l01009"></a>01009                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac9095c92394ff4e7984c14eb95ec948f">tracker</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a08ce506dd6763afbb65395184811df10">TRACKER_SAD</a>) {
<a name="l01010"></a>01010                             track_context.region_tracker= libmv_bruteRegionTrackerNew(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(wndx, wndy), track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a23bc9b573f87bc80922ae41904e02b50">minimum_correlation</a>);
<a name="l01011"></a>01011                         }
<a name="l01012"></a>01012                     }
<a name="l01013"></a>01013 <span class="preprocessor">#endif</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>
<a name="l01015"></a>01015                     <a class="code" href="../../de/ddb/tracking_8c.html#ab4ac4f5c164480f3b4ec5d2573d7132f">tracks_map_insert</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>, track, &amp;track_context);
<a name="l01016"></a>01016                 }
<a name="l01017"></a>01017             }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019             track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01020"></a>01020         }
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022 
<a name="l01023"></a>01023     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">clip</a> = clip;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="comment">/* store needed clip flags passing to get_buffer functions</span>
<a name="l01026"></a>01026 <span class="comment">     * - MCLIP_USE_PROXY is needed to because timecode affects on movie clip</span>
<a name="l01027"></a>01027 <span class="comment">     *   only in case Proxy/Timecode flag is set, so store this flag to use</span>
<a name="l01028"></a>01028 <span class="comment">     *   timecodes properly but reset render size to SIZE_FULL so correct resolution</span>
<a name="l01029"></a>01029 <span class="comment">     *   would be used for images</span>
<a name="l01030"></a>01030 <span class="comment">     * - MCLIP_USE_PROXY_CUSTOM_DIR is needed because proxy/timecode files might</span>
<a name="l01031"></a>01031 <span class="comment">     *   be stored in a different location</span>
<a name="l01032"></a>01032 <span class="comment">     * ignore all the rest possible flags for now */</span>
<a name="l01033"></a>01033     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a4f001075c9aec69334ab7005ce5b6e21">clip_flag</a> = clip-&gt;<a class="code" href="../../d0/d44/structMovieClip.html#ac4b1eba68ec74a5715d7d15d57357190">flag</a>&amp;<a class="code" href="../../d3/dfb/DNA__movieclip__types_8h.html#a7ae83ab1646303b155af11dc2c87c79c">MCLIP_TIMECODE_FLAGS</a>;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a> = *user;
<a name="l01036"></a>01036     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#ae9aa9cc593facc98db4d5759e46cb754">render_size</a> = <a class="code" href="../../d3/dfb/DNA__movieclip__types_8h.html#a7aa419b2dcb03674e1546ff88882e320">MCLIP_PROXY_RENDER_SIZE_FULL</a>;
<a name="l01037"></a>01037     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a55a5c7cefa1d8e69de06bca5b9dc8ed2">render_flag</a> = 0;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="keywordflow">if</span> (!sequence)
<a name="l01040"></a>01040         <a class="code" href="../../df/dbb/BLI__threads_8h.html#ac3249fa0d9b7858ba2c9eb096476efde">BLI_begin_threaded_malloc</a>();
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keywordflow">return</span> context;
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 
<a name="l01045"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad50e2f1d7fd773d49b02aa21a54f318d">01045</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#ad50e2f1d7fd773d49b02aa21a54f318d">track_context_free</a>(<span class="keywordtype">void</span> *customdata)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047     <a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a> *track_context = (<a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a> *)customdata;
<a name="l01048"></a>01048 
<a name="l01049"></a>01049 <span class="preprocessor">#if WITH_LIBMV</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (track_context-&gt;region_tracker)
<a name="l01051"></a>01051         libmv_regionTrackerDestroy(track_context-&gt;region_tracker);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="keywordflow">if</span> (track_context-&gt;patch)
<a name="l01054"></a>01054         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track_context-&gt;patch);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 <span class="preprocessor">#else</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>        (void) track_context;
<a name="l01058"></a>01058 <span class="preprocessor">#endif</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span>}
<a name="l01060"></a>01060 
<a name="l01061"></a><a class="code" href="../../de/ddb/tracking_8c.html#aac861c401f0443c20a240f01a9db4388">01061</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#af3fbca66b21d6e9423589c2bf75c3f08">BKE_tracking_context_free</a>(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context)
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063     <span class="keywordflow">if</span> (!context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#ad1e45a51dd3f63eb19e6935082056af4">sequence</a>)
<a name="l01064"></a>01064         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a04534a83a07e4ed87dc75d46b24cdcb1">BLI_end_threaded_malloc</a>();
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <a class="code" href="../../de/ddb/tracking_8c.html#a8cd6b3257043dd18f5c33f2c350c2455">tracks_map_free</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>, <a class="code" href="../../de/ddb/tracking_8c.html#ad50e2f1d7fd773d49b02aa21a54f318d">track_context_free</a>);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(context);
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071 <span class="comment">/* zap channels from the imbuf that are disabled by the user. this can lead to</span>
<a name="l01072"></a>01072 <span class="comment"> * better tracks sometimes. however, instead of simply zeroing the channels</span>
<a name="l01073"></a>01073 <span class="comment"> * out, do a partial grayscale conversion so the display is better. */</span>
<a name="l01074"></a><a class="code" href="../../de/ddb/tracking_8c.html#afcdbfc12c833566fc249e2b03cf1c6e5">01074</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#aadb1304303ff7e5cc5485c6167eb6c6e">BKE_tracking_disable_imbuf_channels</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> disable_red, <span class="keywordtype">int</span> disable_green, <span class="keywordtype">int</span> disable_blue, <span class="keywordtype">int</span> grayscale)
<a name="l01075"></a>01075 {
<a name="l01076"></a>01076     <span class="keywordtype">int</span> x, y;
<a name="l01077"></a>01077     <span class="keywordtype">float</span> scale;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (!disable_red &amp;&amp; !disable_green &amp;&amp; !disable_blue &amp;&amp; !grayscale)
<a name="l01080"></a>01080         <span class="keywordflow">return</span>;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082     <span class="comment">/* If only some components are selected, it&#39;s important to rescale the result</span>
<a name="l01083"></a>01083 <span class="comment">     * appropriately so that e.g. if only blue is selected, it&#39;s not zeroed out. */</span>
<a name="l01084"></a>01084     scale = (disable_red   ? 0.0f : 0.2126f) +
<a name="l01085"></a>01085             (disable_green ? 0.0f : 0.7152f) +
<a name="l01086"></a>01086             (disable_blue  ? 0.0f : 0.0722f);
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="keywordflow">for</span> (y = 0; y &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; y++) {
<a name="l01089"></a>01089         <span class="keywordflow">for</span> (x = 0; x &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>; x++) {
<a name="l01090"></a>01090             <span class="keywordtype">int</span> pixel = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*y + x;
<a name="l01091"></a>01091 
<a name="l01092"></a>01092             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01093"></a>01093                 <span class="keywordtype">float</span> *rrgbf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + pixel*4;
<a name="l01094"></a>01094                 <span class="keywordtype">float</span> r = disable_red   ? 0.0f : rrgbf[0];
<a name="l01095"></a>01095                 <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> = disable_green ? 0.0f : rrgbf[1];
<a name="l01096"></a>01096                 <span class="keywordtype">float</span> b = disable_blue  ? 0.0f : rrgbf[2];
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                 <span class="keywordflow">if</span> (grayscale) {
<a name="l01099"></a>01099                     <span class="keywordtype">float</span> gray = (0.2126f*r + 0.7152f*g + 0.0722f*b) / scale;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101                     rrgbf[0] = rrgbf[1] = rrgbf[2] = gray;
<a name="l01102"></a>01102                 }
<a name="l01103"></a>01103                 <span class="keywordflow">else</span> {
<a name="l01104"></a>01104                     rrgbf[0] = r;
<a name="l01105"></a>01105                     rrgbf[1] = <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>;
<a name="l01106"></a>01106                     rrgbf[2] = b;
<a name="l01107"></a>01107                 }
<a name="l01108"></a>01108             }
<a name="l01109"></a>01109             <span class="keywordflow">else</span> {
<a name="l01110"></a>01110                 <span class="keywordtype">char</span> *rrgb = (<span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + pixel*4;
<a name="l01111"></a>01111                 <span class="keywordtype">char</span> r = disable_red   ? 0 : rrgb[0];
<a name="l01112"></a>01112                 <span class="keywordtype">char</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> = disable_green ? 0 : rrgb[1];
<a name="l01113"></a>01113                 <span class="keywordtype">char</span> b = disable_blue  ? 0 : rrgb[2];
<a name="l01114"></a>01114 
<a name="l01115"></a>01115                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (grayscale) {
<a name="l01116"></a>01116                     <span class="keywordtype">float</span> gray = (0.2126f*r + 0.7152f*<a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> + 0.0722f*b) / scale;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118                     rrgb[0] = rrgb[1] = rrgb[2] = gray;
<a name="l01119"></a>01119                 }
<a name="l01120"></a>01120                 <span class="keywordflow">else</span> {
<a name="l01121"></a>01121                     rrgb[0] = r;
<a name="l01122"></a>01122                     rrgb[1] = <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>;
<a name="l01123"></a>01123                     rrgb[2] = b;
<a name="l01124"></a>01124                 }
<a name="l01125"></a>01125             }
<a name="l01126"></a>01126         }
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l01130"></a>01130         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a><a class="code" href="../../de/ddb/tracking_8c.html#a0256ab2057d4df6b2a1e38bf4381383b">01133</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a0256ab2057d4df6b2a1e38bf4381383b">disable_imbuf_channels</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> grayscale)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     <a class="code" href="../../da/d72/BKE__tracking_8h.html#aadb1304303ff7e5cc5485c6167eb6c6e">BKE_tracking_disable_imbuf_channels</a>(ibuf, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a7919f6a0e4abf59b96319cbe26133b27">TRACK_DISABLE_RED</a>,
<a name="l01136"></a>01136             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aad0f87447cdc098476bed385acd72b0e">TRACK_DISABLE_GREEN</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a189efce6e2dc01174496ff9343b1c81f">TRACK_DISABLE_BLUE</a>, grayscale);
<a name="l01137"></a>01137 }
<a name="l01138"></a>01138 
<a name="l01139"></a><a class="code" href="../../de/ddb/tracking_8c.html#aa485ab75d07aff10e82238465b3ea634">01139</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../de/ddb/tracking_8c.html#aa485ab75d07aff10e82238465b3ea634">get_area_imbuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker,
<a name="l01140"></a>01140                              <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[2], <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[2], <span class="keywordtype">int</span> margin, <span class="keywordtype">int</span> anchored, <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> origin[2])
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf;
<a name="l01143"></a>01143     <span class="keywordtype">int</span> x, y;
<a name="l01144"></a>01144     <span class="keywordtype">int</span> x1, y1, w, h;
<a name="l01145"></a>01145     <span class="keywordtype">float</span> mpos[2];
<a name="l01146"></a>01146 
<a name="l01147"></a>01147     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(mpos, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>);
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (anchored)
<a name="l01149"></a>01149         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a7f222b1bc110fa45434894fc9a919dec">add_v2_v2</a>(mpos, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aed82b12511be629223876d21ce0d84a4">offset</a>);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151     <span class="keywordflow">if</span> (pos)
<a name="l01152"></a>01152         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(pos);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     x = mpos[0]*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01155"></a>01155     y = mpos[1]*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     w = (max[0] - min[0]) * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01158"></a>01158     h = (max[1] - min[1]) * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="comment">/* dimensions should be odd */</span>
<a name="l01161"></a>01161     w = w|1;
<a name="l01162"></a>01162     h = h|1;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     x1 = x-(int)(w * (-min[0] / (max[0] - min[0])));
<a name="l01165"></a>01165     y1 = y-(int)(h * (-min[1] / (max[1] - min[1])));
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     tmpibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(w+margin*2, h+margin*2, 32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l01168"></a>01168     <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tmpibuf, ibuf, 0, 0, x1 - margin, y1 - margin, w + margin * 2, h + margin * 2);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     <span class="keywordflow">if</span> (pos != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01171"></a>01171         pos[0] = mpos[0] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> - x1 + margin;
<a name="l01172"></a>01172         pos[1] = mpos[1] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - y1 + margin;
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     <span class="keywordflow">if</span> (origin != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01176"></a>01176         origin[0] = x1 - margin;
<a name="l01177"></a>01177         origin[1] = y1 - margin;
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     <span class="keywordflow">if</span> ((track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a287d4e439fd32fd445ef236b21cfc02d">TRACK_PREVIEW_GRAYSCALE</a>) ||
<a name="l01181"></a>01181        (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a7919f6a0e4abf59b96319cbe26133b27">TRACK_DISABLE_RED</a>)       ||
<a name="l01182"></a>01182        (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aad0f87447cdc098476bed385acd72b0e">TRACK_DISABLE_GREEN</a>)     ||
<a name="l01183"></a>01183        (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a189efce6e2dc01174496ff9343b1c81f">TRACK_DISABLE_BLUE</a>))
<a name="l01184"></a>01184     {
<a name="l01185"></a>01185         <a class="code" href="../../de/ddb/tracking_8c.html#a0256ab2057d4df6b2a1e38bf4381383b">disable_imbuf_channels</a>(tmpibuf, track, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> <span class="comment">/* grayscale */</span>);
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     <span class="keywordflow">return</span> tmpibuf;
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 
<a name="l01191"></a><a class="code" href="../../de/ddb/tracking_8c.html#a446c1bbd05a19cf3bf4ac5e22f62c480">01191</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#ab826ecac4abe321781b77d1e3c1082d0">BKE_tracking_get_pattern_imbuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker,
<a name="l01192"></a>01192                                       <span class="keywordtype">int</span> margin, <span class="keywordtype">int</span> anchored, <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> origin[2])
<a name="l01193"></a>01193 {
<a name="l01194"></a>01194     <span class="keywordflow">return</span> <a class="code" href="../../de/ddb/tracking_8c.html#aa485ab75d07aff10e82238465b3ea634">get_area_imbuf</a>(ibuf, track, marker, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, margin, anchored, pos, origin);
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a><a class="code" href="../../de/ddb/tracking_8c.html#a443bd1c5a26447f64f6a185e901384fb">01197</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a412a9d44a5efc3f81e89c1f954730dd2">BKE_tracking_get_search_imbuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker,
<a name="l01198"></a>01198                                      <span class="keywordtype">int</span> margin, <span class="keywordtype">int</span> anchored, <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> origin[2])
<a name="l01199"></a>01199 {
<a name="l01200"></a>01200     <span class="keywordflow">return</span> <a class="code" href="../../de/ddb/tracking_8c.html#aa485ab75d07aff10e82238465b3ea634">get_area_imbuf</a>(ibuf, track, marker, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>, margin, anchored, pos, origin);
<a name="l01201"></a>01201 }
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">float</span> *get_search_floatbuf(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker,
<a name="l01205"></a>01205                                   <span class="keywordtype">int</span> *width_r, <span class="keywordtype">int</span> *height_r, <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> origin[2])
<a name="l01206"></a>01206 {
<a name="l01207"></a>01207     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf;
<a name="l01208"></a>01208     <span class="keywordtype">float</span> *pixels, *fp;
<a name="l01209"></a>01209     <span class="keywordtype">int</span> x, y, width, height;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     width = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[0] - track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[0]) * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01212"></a>01212     height = (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4d48237a7b7724250dd0050185f2d778">search_max</a>[1] - track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a50df86277a7ffcf87ec1168fe45683fc">search_min</a>[1]) * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     tmpibuf = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a412a9d44a5efc3f81e89c1f954730dd2">BKE_tracking_get_search_imbuf</a>(ibuf, track, marker, 0, 0, pos, origin);
<a name="l01215"></a>01215     <a class="code" href="../../de/ddb/tracking_8c.html#a0256ab2057d4df6b2a1e38bf4381383b">disable_imbuf_channels</a>(tmpibuf, track, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> <span class="comment">/* don&#39;t grayscale */</span>);
<a name="l01216"></a>01216 
<a name="l01217"></a>01217     *width_r = width;
<a name="l01218"></a>01218     *height_r = height;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220     fp = pixels = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(width * height * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;tracking floatBuf&quot;</span>);
<a name="l01221"></a>01221     <span class="keywordflow">for</span> (y = 0; y &lt; (int)height; y++) {
<a name="l01222"></a>01222         <span class="keywordflow">for</span> (x = 0; x &lt; (int)width; x++) {
<a name="l01223"></a>01223             <span class="keywordtype">int</span> pixel = tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * y + x;
<a name="l01224"></a>01224 
<a name="l01225"></a>01225             <span class="keywordflow">if</span> (tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01226"></a>01226                 <span class="keywordtype">float</span> *rrgbf = tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + pixel * 4;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228                 *fp = 0.2126 * rrgbf[0] + 0.7152 * rrgbf[1] + 0.0722 * rrgbf[2];
<a name="l01229"></a>01229             }
<a name="l01230"></a>01230             <span class="keywordflow">else</span> {
<a name="l01231"></a>01231                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rrgb = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + pixel * 4;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233                 *fp = (0.2126 * rrgb[0] + 0.7152 * rrgb[1] + 0.0722 * rrgb[2]) / 255.0f;
<a name="l01234"></a>01234             }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236             fp++;
<a name="l01237"></a>01237         }
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tmpibuf);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="keywordflow">return</span> pixels;
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *get_ucharbuf(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01246"></a>01246 {
<a name="l01247"></a>01247     <span class="keywordtype">int</span> x, y;
<a name="l01248"></a>01248     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pixels, *cp;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     cp = pixels = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>), <span class="stringliteral">&quot;tracking ucharBuf&quot;</span>);
<a name="l01251"></a>01251     <span class="keywordflow">for</span> (y = 0; y &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; y++) {
<a name="l01252"></a>01252         <span class="keywordflow">for</span> (x = 0; x &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>; x++) {
<a name="l01253"></a>01253             <span class="keywordtype">int</span> pixel = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * y + x;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01256"></a>01256                 <span class="keyword">const</span> <span class="keywordtype">float</span> *rrgbf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + pixel*4;
<a name="l01257"></a>01257                 <span class="keyword">const</span> <span class="keywordtype">float</span> grey_f = 0.2126f * rrgbf[0] + 0.7152f * rrgbf[1] + 0.0722f * rrgbf[2];
<a name="l01258"></a>01258 
<a name="l01259"></a>01259                 *cp = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(grey_f);
<a name="l01260"></a>01260             }
<a name="l01261"></a>01261             <span class="keywordflow">else</span> {
<a name="l01262"></a>01262                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rrgb = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + pixel * 4;
<a name="l01263"></a>01263 
<a name="l01264"></a>01264                 *cp = 0.2126f * rrgb[0] + 0.7152f * rrgb[1] + 0.0722f * rrgb[2];
<a name="l01265"></a>01265             }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267             cp++;
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <span class="keywordflow">return</span> pixels;
<a name="l01272"></a>01272 }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274 <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *get_frame_ibuf(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context, <span class="keywordtype">int</span> framenr)
<a name="l01275"></a>01275 {
<a name="l01276"></a>01276     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l01277"></a>01277     <a class="code" href="../../d8/dac/structMovieClipUser.html">MovieClipUser</a> user = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     user.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a> = framenr;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     ibuf = <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a4720b4bd9ad7e5a66fd4526b7e4fecb1">BKE_movieclip_get_ibuf_flag</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">clip</a>, &amp;user, context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a4f001075c9aec69334ab7005ce5b6e21">clip_flag</a>, <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a3d5c70290d12e83cbb5e606ead6b226f">MOVIECLIP_CACHE_SKIP</a>);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keywordflow">return</span> ibuf;
<a name="l01284"></a>01284 }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286 <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *get_keyframed_ibuf(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track,
<a name="l01287"></a>01287                                  <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> **marker_keyed)
<a name="l01288"></a>01288 {
<a name="l01289"></a>01289     <span class="keywordtype">int</span> framenr = marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>;
<a name="l01290"></a>01290     <span class="keywordtype">int</span> a = marker-track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>;
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     *marker_keyed = marker;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     <span class="keywordflow">while</span> (a &gt;= 0 &amp;&amp; a &lt; track-&gt;markersnr) {
<a name="l01295"></a>01295         <span class="keywordtype">int</span> <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a> = (context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>) ? a+1 : a-1;
<a name="l01296"></a>01296         <span class="keywordtype">int</span> is_keyframed = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01297"></a>01297         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *cur_marker = &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l01298"></a>01298         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *next_marker = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01299"></a>01299 
<a name="l01300"></a>01300         <span class="keywordflow">if</span> (next&gt;=0 &amp;&amp; next&lt;track-&gt;markersnr)
<a name="l01301"></a>01301             next_marker= &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>];
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         <span class="comment">/* if next mrker is disabled, stop searching keyframe and use current frame as keyframe */</span>
<a name="l01304"></a>01304         <span class="keywordflow">if</span> (next_marker &amp;&amp; next_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>)
<a name="l01305"></a>01305             is_keyframed = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         is_keyframed |= (cur_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ae82a1c87be95f416b45c5a0c25270a83">MARKER_TRACKED</a>) == 0;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         <span class="keywordflow">if</span> (is_keyframed) {
<a name="l01310"></a>01310             framenr = cur_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>;
<a name="l01311"></a>01311             *marker_keyed = cur_marker;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313             <span class="keywordflow">break</span>;
<a name="l01314"></a>01314         }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316         a = <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01317"></a>01317     }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keywordflow">return</span> get_frame_ibuf(context, framenr);
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322 <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *get_adjust_ibuf(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker,
<a name="l01323"></a>01323                               <span class="keywordtype">int</span> curfra, <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> **marker_keyed)
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aed2913a03a0fbc50ea3c4e623c8474a1">pattern_match</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aad79e7c0935df320514057a94c847f16">TRACK_MATCH_KEYFRAME</a>) {
<a name="l01328"></a>01328         ibuf = get_keyframed_ibuf(context, track, marker, marker_keyed);
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330     <span class="keywordflow">else</span> {
<a name="l01331"></a>01331         ibuf = get_frame_ibuf(context, curfra);
<a name="l01332"></a>01332 
<a name="l01333"></a>01333         <span class="comment">/* use current marker as keyframed position */</span>
<a name="l01334"></a>01334         *marker_keyed = marker;
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     <span class="keywordflow">return</span> ibuf;
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340 <span class="preprocessor">#endif</span>
<a name="l01341"></a>01341 <span class="preprocessor"></span>
<a name="l01342"></a><a class="code" href="../../de/ddb/tracking_8c.html#ab1f52ebf4616694be9152140f0ab18a5">01342</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a34b06f887aee5521f5295934b79b867c">BKE_tracking_sync</a>(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking = &amp;context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">clip</a>-&gt;<a class="code" href="../../d0/d44/structMovieClip.html#ad152541b1860f6ba2761a16270df8159">tracking</a>;
<a name="l01345"></a>01345     <span class="keywordtype">int</span> newframe;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <a class="code" href="../../de/ddb/tracking_8c.html#a278e8f6edc4d4bf240cfc411a28b457a">tracks_map_merge</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>, tracking);
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>)
<a name="l01350"></a>01350         newframe = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a> + 1;
<a name="l01351"></a>01351     <span class="keywordflow">else</span>
<a name="l01352"></a>01352         newframe = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a> - 1;
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a532176d73f2a52edb3eb963ad9772e4f">sync_frame</a> = newframe;
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="../../de/ddb/tracking_8c.html#a284765bf5b04efb27042927f76051922">01357</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#afeb04a5fe59b22a8fd510913cfe422ae">BKE_tracking_sync_user</a>(<a class="code" href="../../d8/dac/structMovieClipUser.html">MovieClipUser</a> *user, <a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359     user-&gt;<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a> = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a532176d73f2a52edb3eb963ad9772e4f">sync_frame</a>;
<a name="l01360"></a>01360 }
<a name="l01361"></a>01361 
<a name="l01362"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad35058fe010f619341691be26c1adebc">01362</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ada223ff4260ab5aa4a3ff8c35ee35023">BKE_tracking_next</a>(<a class="code" href="../../da/d2a/structMovieTrackingContext.html">MovieTrackingContext</a> *context)
<a name="l01363"></a>01363 {
<a name="l01364"></a>01364     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf_new;
<a name="l01365"></a>01365     <span class="keywordtype">int</span> curfra = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>;
<a name="l01366"></a>01366     <span class="keywordtype">int</span> a, ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, map_size;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368     map_size = <a class="code" href="../../de/ddb/tracking_8c.html#ab64b20238c2d09ea371392e4b4952c75">tracks_map_size</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <span class="comment">/* nothing to track, avoid unneeded frames reading to save time and memory */</span>
<a name="l01371"></a>01371     <span class="keywordflow">if</span> (!map_size)
<a name="l01372"></a>01372         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374     <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>)
<a name="l01375"></a>01375         context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>--;
<a name="l01376"></a>01376     <span class="keywordflow">else</span>
<a name="l01377"></a>01377         context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>.<a class="code" href="../../d8/dac/structMovieClipUser.html#a645bba5909762a5df052e903bfb00afb">framenr</a>++;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379     ibuf_new = <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a4720b4bd9ad7e5a66fd4526b7e4fecb1">BKE_movieclip_get_ibuf_flag</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#af1f19ab46e1555b1a6de4341ee8dfb8b">clip</a>, &amp;context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a195e95733b8f4a5660655a7a0deae961">user</a>, context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a4f001075c9aec69334ab7005ce5b6e21">clip_flag</a>, <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a3d5c70290d12e83cbb5e606ead6b226f">MOVIECLIP_CACHE_SKIP</a>);
<a name="l01380"></a>01380     <span class="keywordflow">if</span> (!ibuf_new)
<a name="l01381"></a>01381         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383 <span class="preprocessor">    #pragma omp parallel for private(a) shared(ibuf_new, ok) if (map_size&gt;1)</span>
<a name="l01384"></a>01384 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (a = 0; a &lt; map_size; a++) {
<a name="l01385"></a>01385         <a class="code" href="../../d2/d28/structTrackContext.html">TrackContext</a> *track_context = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01386"></a>01386         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l01387"></a>01387         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389         <a class="code" href="../../de/ddb/tracking_8c.html#a6f91863f90e0e77f8aefc759295d036b">tracks_map_get</a>(context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a7117bafbccb6d57f365344816a7893cf">tracks_map</a>, a, &amp;track, (<span class="keywordtype">void</span>**)&amp;track_context);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a56697c83fb3ce5f0db748213a3262f60">BKE_tracking_exact_marker</a>(track, curfra);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393         <span class="keywordflow">if</span> (marker &amp;&amp; (marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) == 0) {
<a name="l01394"></a>01394 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01395"></a>01395 <span class="preprocessor"></span>            <span class="keywordtype">int</span> width, height, origin[2], tracked = 0, need_readjust = 0;
<a name="l01396"></a>01396             <span class="keywordtype">float</span> pos[2], margin[2], dim[2];
<a name="l01397"></a>01397             <span class="keywordtype">double</span> x1, y1, x2, y2;
<a name="l01398"></a>01398             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01399"></a>01399             <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> marker_new, *marker_keyed;
<a name="l01400"></a>01400             <span class="keywordtype">int</span> onbound = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, nextfra;
<a name="l01401"></a>01401 
<a name="l01402"></a>01402             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aed2913a03a0fbc50ea3c4e623c8474a1">pattern_match</a> == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aad79e7c0935df320514057a94c847f16">TRACK_MATCH_KEYFRAME</a>)
<a name="l01403"></a>01403                 need_readjust = context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a132fb1986fe3a24643a5622841065e21">first_time</a>;
<a name="l01404"></a>01404             <span class="keywordflow">else</span>
<a name="l01405"></a>01405                 need_readjust = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407             <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>)
<a name="l01408"></a>01408                 nextfra = curfra - 1;
<a name="l01409"></a>01409             <span class="keywordflow">else</span>
<a name="l01410"></a>01410                 nextfra = curfra + 1;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412             <span class="comment">/* margin from frame boundaries */</span>
<a name="l01413"></a>01413             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dim, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ac1a4d3e8768f8001d6401b113fa87c98">pat_max</a>, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a75e3bf61886d823eb3f4a5d6971269cb">pat_min</a>);
<a name="l01414"></a>01414             margin[0] = margin[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(dim[0], dim[1]) / 2.0f;
<a name="l01415"></a>01415 
<a name="l01416"></a>01416             margin[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(margin[0], (<span class="keywordtype">float</span>)track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ab9ac14b1c80dd6baab8b1b4e0ae7da97">margin</a> / ibuf_new-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l01417"></a>01417             margin[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(margin[1], (<span class="keywordtype">float</span>)track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ab9ac14b1c80dd6baab8b1b4e0ae7da97">margin</a> / ibuf_new-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419             <span class="comment">/* do not track markers which are too close to boundary */</span>
<a name="l01420"></a>01420             <span class="keywordflow">if</span> (marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[0]&lt;margin[0] || marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[0]&gt;1.0f-margin[0] ||
<a name="l01421"></a>01421                 marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[1]&lt;margin[1] || marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[1]&gt;1.0f-margin[1])
<a name="l01422"></a>01422             {
<a name="l01423"></a>01423                 onbound = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01424"></a>01424             }
<a name="l01425"></a>01425             <span class="keywordflow">else</span> {
<a name="l01426"></a>01426                 <span class="keywordtype">float</span> *patch_new;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428                 <span class="keywordflow">if</span> (need_readjust) {
<a name="l01429"></a>01429                     <span class="comment">/* calculate patch for keyframed position */</span>
<a name="l01430"></a>01430                     ibuf = get_adjust_ibuf(context, track, marker, curfra, &amp;marker_keyed);
<a name="l01431"></a>01431 
<a name="l01432"></a>01432                     <span class="keywordflow">if</span> (track_context-&gt;patch)
<a name="l01433"></a>01433                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(track_context-&gt;patch);
<a name="l01434"></a>01434 
<a name="l01435"></a>01435                     track_context-&gt;patch = get_search_floatbuf(ibuf, track, marker_keyed, &amp;width, &amp;height,
<a name="l01436"></a>01436                                                                track_context-&gt;keyframed_pos, origin);
<a name="l01437"></a>01437 
<a name="l01438"></a>01438                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l01439"></a>01439                 }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441                 patch_new = get_search_floatbuf(ibuf_new, track, marker, &amp;width, &amp;height, pos, origin);
<a name="l01442"></a>01442 
<a name="l01443"></a>01443                 x1 = track_context-&gt;keyframed_pos[0];
<a name="l01444"></a>01444                 y1 = track_context-&gt;keyframed_pos[1];
<a name="l01445"></a>01445 
<a name="l01446"></a>01446                 x2 = pos[0];
<a name="l01447"></a>01447                 y2 = pos[1];
<a name="l01448"></a>01448 
<a name="l01449"></a>01449                 tracked = libmv_regionTrackerTrack(track_context-&gt;region_tracker, track_context-&gt;patch, patch_new,
<a name="l01450"></a>01450                             width, height, x1, y1, &amp;x2, &amp;y2);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(patch_new);
<a name="l01453"></a>01453             }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455             <span class="keywordflow">if</span> (tracked &amp;&amp; !onbound &amp;&amp; finite(x2) &amp;&amp; finite(y2)) {
<a name="l01456"></a>01456                 <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a132fb1986fe3a24643a5622841065e21">first_time</a>) {
<a name="l01457"></a>01457 <span class="preprocessor">                    #pragma omp critical</span>
<a name="l01458"></a>01458 <span class="preprocessor"></span>                    {
<a name="l01459"></a>01459                         <span class="comment">/* check if there&#39;s no keyframe/tracked markers before tracking marker.</span>
<a name="l01460"></a>01460 <span class="comment">                         * if so -- create disabled marker before currently tracking &quot;segment&quot; */</span>
<a name="l01461"></a>01461                         <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, marker, !context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>, 0);
<a name="l01462"></a>01462                     }
<a name="l01463"></a>01463                 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465                 memset(&amp;marker_new, 0, <span class="keyword">sizeof</span>(marker_new));
<a name="l01466"></a>01466 
<a name="l01467"></a>01467                 <span class="keywordflow">if</span> (!onbound) {
<a name="l01468"></a>01468                     marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[0] = (origin[0] + x2) / ibuf_new-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01469"></a>01469                     marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[1] = (origin[1] + y2) / ibuf_new-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01470"></a>01470                 }
<a name="l01471"></a>01471                 <span class="keywordflow">else</span> {
<a name="l01472"></a>01472                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>);
<a name="l01473"></a>01473                 }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475                 marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ae82a1c87be95f416b45c5a0c25270a83">MARKER_TRACKED</a>;
<a name="l01476"></a>01476                 marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>= nextfra;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478 <span class="preprocessor">                #pragma omp critical</span>
<a name="l01479"></a>01479 <span class="preprocessor"></span>                {
<a name="l01480"></a>01480                     <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker_new);
<a name="l01481"></a>01481                 }
<a name="l01482"></a>01482 
<a name="l01483"></a>01483                 <span class="comment">/* make currently tracked segment be finished with disabled marker */</span>
<a name="l01484"></a>01484 <span class="preprocessor">                #pragma omp critical</span>
<a name="l01485"></a>01485 <span class="preprocessor"></span>                {
<a name="l01486"></a>01486                     <a class="code" href="../../de/ddb/tracking_8c.html#ac11f4e075f61e3e205b1286f3381bb0a">put_disabled_marker</a>(track, &amp;marker_new, context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a21ee0690f4623b488fd22e55659cebf8">backwards</a>, 0);
<a name="l01487"></a>01487                 }
<a name="l01488"></a>01488             }
<a name="l01489"></a>01489             <span class="keywordflow">else</span> {
<a name="l01490"></a>01490                 marker_new = *marker;
<a name="l01491"></a>01491 
<a name="l01492"></a>01492                 marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a> = nextfra;
<a name="l01493"></a>01493                 marker_new.<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>;
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 <span class="preprocessor">                #pragma omp critical</span>
<a name="l01496"></a>01496 <span class="preprocessor"></span>                {
<a name="l01497"></a>01497                     <a class="code" href="../../da/d72/BKE__tracking_8h.html#acfb391b09b47a0645f6c6db0e3b1a752">BKE_tracking_insert_marker</a>(track, &amp;marker_new);
<a name="l01498"></a>01498                 }
<a name="l01499"></a>01499             }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501             ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01502"></a>01502 <span class="preprocessor">#endif</span>
<a name="l01503"></a>01503 <span class="preprocessor"></span>        }
<a name="l01504"></a>01504     }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf_new);
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a132fb1986fe3a24643a5622841065e21">first_time</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01509"></a>01509     context-&gt;<a class="code" href="../../da/d2a/structMovieTrackingContext.html#a765cd9dd9897be3a399fb39127eae23e">frames</a>++;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">return</span> ok;
<a name="l01512"></a>01512 }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514 <span class="comment">/*********************** camera solving *************************/</span>
<a name="l01515"></a>01515 
<a name="l01516"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html">01516</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> {
<a name="l01517"></a>01517 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01518"></a>01518 <span class="preprocessor"></span>    <span class="keyword">struct </span>libmv_Tracks *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>;
<a name="l01519"></a>01519     <span class="keywordtype">int</span> keyframe1, keyframe2;
<a name="l01520"></a>01520     <span class="keywordtype">short</span> refine_flags;
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     <span class="keyword">struct </span>libmv_Reconstruction *reconstruction;
<a name="l01523"></a>01523 <span class="preprocessor">#endif</span>
<a name="l01524"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">01524</a> <span class="preprocessor"></span>    <span class="keywordtype">char</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>[<a class="code" href="../../d1/db4/DNA__defs_8h.html#ac7c0207aa5a0e10d378be03b68041350">MAX_NAME</a>];
<a name="l01525"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">01525</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">is_camera</a>;
<a name="l01526"></a>01526 
<a name="l01527"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#a21020b4c4a58da48facef5bd06f5528d">01527</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a21020b4c4a58da48facef5bd06f5528d">focal_length</a>;
<a name="l01528"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">01528</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">principal_point</a>[2];
<a name="l01529"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#a44712917093a189257444bbfdc968e67">01529</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#acff4230b2146dc9979ee917031338a9e">k1</a>, <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a126be51097b2d719659e000c6684ccb9">k2</a>, <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a44712917093a189257444bbfdc968e67">k3</a>;
<a name="l01530"></a>01530 
<a name="l01531"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab8b4602175a45317d15c7e78ec8d925a">01531</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab8b4602175a45317d15c7e78ec8d925a">reprojection_error</a>;
<a name="l01532"></a>01532 
<a name="l01533"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">01533</a>     <a class="code" href="../../d3/dea/structTracksMap.html">TracksMap</a> *<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">tracks_map</a>;
<a name="l01534"></a>01534 
<a name="l01535"></a><a class="code" href="../../d9/de6/structMovieReconstructContext.html#aa7c3502eaa29701a40be4cbe1d52ca36">01535</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/de6/structMovieReconstructContext.html#aa7c3502eaa29701a40be4cbe1d52ca36">sfra</a>, <a class="code" href="../../d9/de6/structMovieReconstructContext.html#a6963efba5831dcd521d8ae230b845ff9">efra</a>;
<a name="l01536"></a>01536 } <a class="code" href="../../de/ddb/tracking_8c.html#ab04a8f864b3ed5b78902504ccde9e00c">MovieReconstructContext</a>;
<a name="l01537"></a>01537 
<a name="l01538"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html">01538</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d7a/structReconstructProgressData.html">ReconstructProgressData</a> {
<a name="l01539"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html#aff2c7818fbbbdcab67e01849ca1f6c5d">01539</a>     <span class="keywordtype">short</span> *<a class="code" href="../../d2/d7a/structReconstructProgressData.html#aff2c7818fbbbdcab67e01849ca1f6c5d">stop</a>;
<a name="l01540"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html#af4c89a9f6b2a78f748634256f3f934cc">01540</a>     <span class="keywordtype">short</span> *<a class="code" href="../../d2/d7a/structReconstructProgressData.html#af4c89a9f6b2a78f748634256f3f934cc">do_update</a>;
<a name="l01541"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html#a8d90a2dd82772ffbb38626453e65d2d0">01541</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a8d90a2dd82772ffbb38626453e65d2d0">progress</a>;
<a name="l01542"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html#a1ab6c09aea48d5435f833df8de42230f">01542</a>     <span class="keywordtype">char</span> *<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a1ab6c09aea48d5435f833df8de42230f">stats_message</a>;
<a name="l01543"></a><a class="code" href="../../d2/d7a/structReconstructProgressData.html#ae011c5c34b6d778d7387516dacd7527d">01543</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d7a/structReconstructProgressData.html#ae011c5c34b6d778d7387516dacd7527d">message_size</a>;
<a name="l01544"></a>01544 } <a class="code" href="../../de/ddb/tracking_8c.html#a6b41a0db26539be62d3ad44a40a39044">ReconstructProgressData</a>;
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="preprocessor">#if WITH_LIBMV</span>
<a name="l01547"></a>01547 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>libmv_Tracks *create_libmv_tracks(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l01548"></a>01548 {
<a name="l01549"></a>01549     <span class="keywordtype">int</span> tracknr = 0;
<a name="l01550"></a>01550     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l01551"></a>01551     <span class="keyword">struct </span>libmv_Tracks *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a> = libmv_tracksNew();
<a name="l01552"></a>01552 
<a name="l01553"></a>01553     track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01554"></a>01554     <span class="keywordflow">while</span> (track) {
<a name="l01555"></a>01555         <span class="keywordtype">int</span> a = 0;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557         <span class="keywordflow">for</span> (a = 0; a &lt; track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>; a++) {
<a name="l01558"></a>01558             <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[a];
<a name="l01559"></a>01559 
<a name="l01560"></a>01560             <span class="keywordflow">if</span> ((marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) == 0) {
<a name="l01561"></a>01561                 libmv_tracksInsert(tracks, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>, tracknr,
<a name="l01562"></a>01562                             marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[0] * width, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>[1] * height);
<a name="l01563"></a>01563             }
<a name="l01564"></a>01564         }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01567"></a>01567         tracknr++;
<a name="l01568"></a>01568     }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570     <span class="keywordflow">return</span> <a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>;
<a name="l01571"></a>01571 }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 <span class="keyword">static</span> <span class="keywordtype">void</span> retrieve_libmv_reconstruct_intrinscis(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l01574"></a>01574 {
<a name="l01575"></a>01575     <span class="keyword">struct </span>libmv_Reconstruction *libmv_reconstruction = context-&gt;reconstruction;
<a name="l01576"></a>01576     <span class="keyword">struct </span>libmv_CameraIntrinsics *libmv_intrinsics = libmv_ReconstructionExtractIntrinsics(libmv_reconstruction);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <span class="keywordtype">float</span> aspy = 1.0f / tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     <span class="keywordtype">double</span> focal_length, principal_x, principal_y, k1, k2, k3;
<a name="l01581"></a>01581     <span class="keywordtype">int</span> width, height;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583     libmv_CameraIntrinsicsExtract(libmv_intrinsics, &amp;focal_length, &amp;principal_x, &amp;principal_y,
<a name="l01584"></a>01584                                   &amp;k1, &amp;k2, &amp;k3, &amp;width, &amp;height);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a> = focal_length;
<a name="l01587"></a>01587     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0] = principal_x;
<a name="l01588"></a>01588 
<a name="l01589"></a>01589     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] = principal_y / aspy;
<a name="l01590"></a>01590     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a> = k1;
<a name="l01591"></a>01591     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a> = k2;
<a name="l01592"></a>01592 }
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 <span class="keyword">static</span> <span class="keywordtype">int</span> retrieve_libmv_reconstruct_tracks(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l01595"></a>01595 {
<a name="l01596"></a>01596     <span class="keyword">struct </span>libmv_Reconstruction *libmv_reconstruction = context-&gt;reconstruction;
<a name="l01597"></a>01597     <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01598"></a>01598     <a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a> *reconstructed;
<a name="l01599"></a>01599     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l01600"></a>01600     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase =  <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01601"></a>01601     <span class="keywordtype">int</span> ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, tracknr = 0, a, origin_set = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01602"></a>01602     <span class="keywordtype">int</span> sfra = context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aa7c3502eaa29701a40be4cbe1d52ca36">sfra</a>, efra = context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a6963efba5831dcd521d8ae230b845ff9">efra</a>;
<a name="l01603"></a>01603     <span class="keywordtype">float</span> imat[4][4];
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">is_camera</a>) {
<a name="l01606"></a>01606         tracksbase = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>;
<a name="l01607"></a>01607         reconstruction = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a08fa44e235d5e8555098950eca818076">reconstruction</a>;
<a name="l01608"></a>01608     }
<a name="l01609"></a>01609     <span class="keywordflow">else</span> {
<a name="l01610"></a>01610         <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a44872d3e133985f2608b4a5b3465417e">BKE_tracking_named_object</a>(tracking, context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>);
<a name="l01611"></a>01611 
<a name="l01612"></a>01612         tracksbase = &amp;<span class="keywordtype">object</span>-&gt;tracks;
<a name="l01613"></a>01613         reconstruction = &amp;<span class="keywordtype">object</span>-&gt;reconstruction;
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(imat);
<a name="l01617"></a>01617 
<a name="l01618"></a>01618     track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01619"></a>01619     <span class="keywordflow">while</span> (track) {
<a name="l01620"></a>01620         <span class="keywordtype">double</span> pos[3];
<a name="l01621"></a>01621 
<a name="l01622"></a>01622         <span class="keywordflow">if</span> (libmv_reporojectionPointForTrack(libmv_reconstruction, tracknr, pos)) {
<a name="l01623"></a>01623             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4e616aa095d540fba49777fdf9d2abd6">bundle_pos</a>[0] = pos[0];
<a name="l01624"></a>01624             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4e616aa095d540fba49777fdf9d2abd6">bundle_pos</a>[1] = pos[1];
<a name="l01625"></a>01625             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4e616aa095d540fba49777fdf9d2abd6">bundle_pos</a>[2] = pos[2];
<a name="l01626"></a>01626 
<a name="l01627"></a>01627             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a0ecbc30a5ba19dbf9ded156314eed34e">TRACK_HAS_BUNDLE</a>;
<a name="l01628"></a>01628             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a2da385d92d6b1aa429fe5c272707fbbf">error</a> = libmv_reporojectionErrorForTrack(libmv_reconstruction, tracknr);
<a name="l01629"></a>01629         }
<a name="l01630"></a>01630         <span class="keywordflow">else</span> {
<a name="l01631"></a>01631             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp;= ~<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a0ecbc30a5ba19dbf9ded156314eed34e">TRACK_HAS_BUNDLE</a>;
<a name="l01632"></a>01632             ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634             printf(<span class="stringliteral">&quot;No bundle for track #%d &#39;%s&#39;\n&quot;</span>, tracknr, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a5ede2cebd7d3af52ad94c60a496c8781">name</a>);
<a name="l01635"></a>01635         }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01638"></a>01638         tracknr++;
<a name="l01639"></a>01639     }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     <span class="keywordflow">if</span> (reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>)
<a name="l01642"></a>01642         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a> = 0;
<a name="l01645"></a>01645     reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01646"></a>01646     reconstructed = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((efra-sfra+1)*<span class="keyword">sizeof</span>(<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a>), <span class="stringliteral">&quot;temp reconstructed camera&quot;</span>);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648     <span class="keywordflow">for</span> (a = sfra; a &lt;= efra; a++) {
<a name="l01649"></a>01649         <span class="keywordtype">double</span> matd[4][4];
<a name="l01650"></a>01650 
<a name="l01651"></a>01651         <span class="keywordflow">if</span> (libmv_reporojectionCameraForImage(libmv_reconstruction, a, matd)) {
<a name="l01652"></a>01652             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01653"></a>01653             <span class="keywordtype">float</span> mat[4][4];
<a name="l01654"></a>01654             <span class="keywordtype">float</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = libmv_reporojectionErrorForImage(libmv_reconstruction, a);
<a name="l01655"></a>01655 
<a name="l01656"></a>01656             <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++)
<a name="l01657"></a>01657                 <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++)
<a name="l01658"></a>01658                     mat[i][j] = matd[i][j];
<a name="l01659"></a>01659 
<a name="l01660"></a>01660             <span class="keywordflow">if</span> (!origin_set) {
<a name="l01661"></a>01661                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(imat, mat);
<a name="l01662"></a>01662                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a64a4f057663e6d9174264739ac12fd34">invert_m4</a>(imat);
<a name="l01663"></a>01663                 origin_set = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01664"></a>01664             }
<a name="l01665"></a>01665 
<a name="l01666"></a>01666             <span class="keywordflow">if</span> (origin_set)
<a name="l01667"></a>01667                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, imat, mat);
<a name="l01668"></a>01668 
<a name="l01669"></a>01669             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(reconstructed[reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a9668120603df1c73d8c174083c52cbd7">mat</a>, mat);
<a name="l01670"></a>01670             reconstructed[reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a04041234e354c19fa27a80cc5f194361">framenr</a> = a;
<a name="l01671"></a>01671             reconstructed[reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a573f1b7bb28787b57a5f1a12aadbf45a">error</a> = <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l01672"></a>01672             reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>++;
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674         <span class="keywordflow">else</span> {
<a name="l01675"></a>01675             ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01676"></a>01676             printf(<span class="stringliteral">&quot;No camera for frame %d\n&quot;</span>, a);
<a name="l01677"></a>01677         }
<a name="l01678"></a>01678     }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     <span class="keywordflow">if</span> (reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>) {
<a name="l01681"></a>01681         reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a>), <span class="stringliteral">&quot;reconstructed camera&quot;</span>);
<a name="l01682"></a>01682         memcpy(reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>, reconstructed, reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a>));
<a name="l01683"></a>01683     }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="keywordflow">if</span> (origin_set) {
<a name="l01686"></a>01686         track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01687"></a>01687         <span class="keywordflow">while</span> (track) {
<a name="l01688"></a>01688             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a0ecbc30a5ba19dbf9ded156314eed34e">TRACK_HAS_BUNDLE</a>)
<a name="l01689"></a>01689                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4e616aa095d540fba49777fdf9d2abd6">bundle_pos</a>, imat, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a4e616aa095d540fba49777fdf9d2abd6">bundle_pos</a>);
<a name="l01690"></a>01690 
<a name="l01691"></a>01691             track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01692"></a>01692         }
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(reconstructed);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="keywordflow">return</span> ok;
<a name="l01698"></a>01698 }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700 <span class="keyword">static</span> <span class="keywordtype">int</span> retrieve_libmv_reconstruct(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l01701"></a>01701 {
<a name="l01702"></a>01702     <span class="comment">/* take the intrinscis back from libmv */</span>
<a name="l01703"></a>01703     retrieve_libmv_reconstruct_intrinscis(context, tracking);
<a name="l01704"></a>01704 
<a name="l01705"></a>01705     <span class="keywordflow">return</span> retrieve_libmv_reconstruct_tracks(context, tracking);
<a name="l01706"></a>01706 }
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 <span class="keyword">static</span> <span class="keywordtype">int</span> get_refine_intrinsics_flags(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l01709"></a>01709 {
<a name="l01710"></a>01710     <span class="keywordtype">int</span> refine = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a23a0c8e966055b4608a9ceccd469fe9c">refine_camera_intrinsics</a>;
<a name="l01711"></a>01711     <span class="keywordtype">int</span> flags = 0;
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <span class="keywordflow">if</span> ((object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) == 0)
<a name="l01714"></a>01714         <span class="keywordflow">return</span> 0;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">if</span> (refine &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a7ec10fdfa9cdf12e1bdfa9b701e17b51">REFINE_FOCAL_LENGTH</a>)
<a name="l01717"></a>01717         flags |= LIBMV_REFINE_FOCAL_LENGTH;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719     <span class="keywordflow">if</span> (refine &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ac729639249b782c76533e60a97ff9ed9">REFINE_PRINCIPAL_POINT</a>)
<a name="l01720"></a>01720         flags |= LIBMV_REFINE_PRINCIPAL_POINT;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     <span class="keywordflow">if</span> (refine &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a022f49fe36f4dd94c2e1c73850c67d75">REFINE_RADIAL_DISTORTION_K1</a>)
<a name="l01723"></a>01723         flags |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a022f49fe36f4dd94c2e1c73850c67d75">REFINE_RADIAL_DISTORTION_K1</a>;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725     <span class="keywordflow">if</span> (refine &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a97e335e65c12ce17ff9804f8e8870f42">REFINE_RADIAL_DISTORTION_K2</a>)
<a name="l01726"></a>01726         flags |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a97e335e65c12ce17ff9804f8e8870f42">REFINE_RADIAL_DISTORTION_K2</a>;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728     <span class="keywordflow">return</span> flags;
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 <span class="keyword">static</span> <span class="keywordtype">int</span> count_tracks_on_both_keyframes(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase)
<a name="l01732"></a>01732 {
<a name="l01733"></a>01733     <span class="keywordtype">int</span> tot = 0;
<a name="l01734"></a>01734     <span class="keywordtype">int</span> frame1 = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#ab320cbb600cc2d019a30ce3029f033a1">keyframe1</a>, frame2= tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#afa585c1d91bd61a9a0de3ace505685f0">settings</a>.<a class="code" href="../../da/ddb/structMovieTrackingSettings.html#a4270d8ac653dcb0238856bb31d6827ca">keyframe2</a>;
<a name="l01735"></a>01735     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l01736"></a>01736 
<a name="l01737"></a>01737     track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01738"></a>01738     <span class="keywordflow">while</span> (track) {
<a name="l01739"></a>01739         <span class="keywordflow">if</span> (<a class="code" href="../../da/d72/BKE__tracking_8h.html#a2a514c295070bfb8630bf8195a0f6752">BKE_tracking_has_enabled_marker</a>(track, frame1))
<a name="l01740"></a>01740             <span class="keywordflow">if</span> (<a class="code" href="../../da/d72/BKE__tracking_8h.html#a2a514c295070bfb8630bf8195a0f6752">BKE_tracking_has_enabled_marker</a>(track, frame2))
<a name="l01741"></a>01741                 tot++;
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01744"></a>01744     }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746     <span class="keywordflow">return</span> tot;
<a name="l01747"></a>01747 }
<a name="l01748"></a>01748 <span class="preprocessor">#endif</span>
<a name="l01749"></a>01749 <span class="preprocessor"></span>
<a name="l01750"></a><a class="code" href="../../de/ddb/tracking_8c.html#a884974c2df6bd5fd5791a19aad828949">01750</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6c0abfb30fe66eea220780d8b8a4cb15">BKE_tracking_can_reconstruct</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>, <span class="keywordtype">char</span> *error_msg, <span class="keywordtype">int</span> error_size)
<a name="l01751"></a>01751 {
<a name="l01752"></a>01752 <span class="preprocessor">#if WITH_LIBMV</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span>    <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755     <span class="keywordflow">if</span> (count_tracks_on_both_keyframes(tracking, tracksbase)&lt;8) {
<a name="l01756"></a>01756         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(error_msg, <span class="stringliteral">&quot;At least 8 common tracks on both of keyframes are needed for reconstruction&quot;</span>, error_size);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01759"></a>01759     }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01762"></a>01762 <span class="preprocessor">#else</span>
<a name="l01763"></a>01763 <span class="preprocessor"></span>    <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(error_msg, <span class="stringliteral">&quot;Blender is compiled without motion tracking library&quot;</span>, error_size);
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     (void) tracking;
<a name="l01766"></a>01766     (void) <span class="keywordtype">object</span>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="keywordflow">return</span> 0;
<a name="l01769"></a>01769 <span class="preprocessor">#endif</span>
<a name="l01770"></a>01770 <span class="preprocessor"></span>}
<a name="l01771"></a>01771 
<a name="l01772"></a><a class="code" href="../../de/ddb/tracking_8c.html#acdc5827e584a66066d242fc1105046c7">01772</a> <a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a>* <a class="code" href="../../da/d72/BKE__tracking_8h.html#a8ecc0857ce82e72da91756d4a8c4866a">BKE_tracking_reconstruction_context_new</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>,
<a name="l01773"></a>01773                                                                  <span class="keywordtype">int</span> keyframe1, <span class="keywordtype">int</span> keyframe2, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l01774"></a>01774 {
<a name="l01775"></a>01775     <a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a>), <span class="stringliteral">&quot;MovieReconstructContext data&quot;</span>);
<a name="l01776"></a>01776     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l01777"></a>01777     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l01778"></a>01778     <span class="keywordtype">float</span> aspy = 1.0f / tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l01779"></a>01779     <span class="keywordtype">int</span> num_tracks = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(tracksbase);
<a name="l01780"></a>01780     <span class="keywordtype">int</span> sfra = INT_MAX, efra = INT_MIN;
<a name="l01781"></a>01781     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>, object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>, <span class="keyword">sizeof</span>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>));
<a name="l01784"></a>01784     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">is_camera</a> = <span class="keywordtype">object</span>-&gt;flag&amp;<a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">tracks_map</a> = <a class="code" href="../../de/ddb/tracking_8c.html#a07e55f35f153281ccf9d80a33fafb3a8">tracks_map_new</a>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>, context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">is_camera</a>, num_tracks, 0);
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01789"></a>01789     <span class="keywordflow">while</span> (track) {
<a name="l01790"></a>01790         <span class="keywordtype">int</span> first = 0, last = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a>-1;
<a name="l01791"></a>01791         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *first_marker = &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[0];
<a name="l01792"></a>01792         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *last_marker = &amp;track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> - 1];
<a name="l01793"></a>01793 
<a name="l01794"></a>01794         <span class="comment">/* find first not-disabled marker */</span>
<a name="l01795"></a>01795         <span class="keywordflow">while</span> (first &lt;= track-&gt;markersnr - 1 &amp;&amp; first_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) {
<a name="l01796"></a>01796             first++;
<a name="l01797"></a>01797             first_marker++;
<a name="l01798"></a>01798         }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800         <span class="comment">/* find last not-disabled marker */</span>
<a name="l01801"></a>01801         <span class="keywordflow">while</span> (last &gt;= 0 &amp;&amp; last_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a6bf7281cddce79f77edb8e48d58a5973">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a90fb842f2f7efe62795eff3853df39ba">MARKER_DISABLED</a>) {
<a name="l01802"></a>01802             last--;
<a name="l01803"></a>01803             last_marker--;
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806         <span class="keywordflow">if</span> (first&lt;track-&gt;markersnr - 1)
<a name="l01807"></a>01807             sfra = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(sfra, first_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>);
<a name="l01808"></a>01808 
<a name="l01809"></a>01809         <span class="keywordflow">if</span> (last &gt;= 0)
<a name="l01810"></a>01810             efra = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(efra, last_marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         <a class="code" href="../../de/ddb/tracking_8c.html#ab4ac4f5c164480f3b4ec5d2573d7132f">tracks_map_insert</a>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">tracks_map</a>, track, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01815"></a>01815     }
<a name="l01816"></a>01816 
<a name="l01817"></a>01817     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aa7c3502eaa29701a40be4cbe1d52ca36">sfra</a> = sfra;
<a name="l01818"></a>01818     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a6963efba5831dcd521d8ae230b845ff9">efra</a> = efra;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01821"></a>01821 <span class="preprocessor"></span>    context-&gt;tracks = create_libmv_tracks(tracksbase, width, height*aspy);
<a name="l01822"></a>01822     context-&gt;keyframe1 = keyframe1;
<a name="l01823"></a>01823     context-&gt;keyframe2 = keyframe2;
<a name="l01824"></a>01824     context-&gt;refine_flags = get_refine_intrinsics_flags(tracking, <span class="keywordtype">object</span>);
<a name="l01825"></a>01825 <span class="preprocessor">#else</span>
<a name="l01826"></a>01826 <span class="preprocessor"></span>    (void) width;
<a name="l01827"></a>01827     (void) height;
<a name="l01828"></a>01828     (void) keyframe1;
<a name="l01829"></a>01829     (void) keyframe2;
<a name="l01830"></a>01830 <span class="preprocessor">#endif</span>
<a name="l01831"></a>01831 <span class="preprocessor"></span>
<a name="l01832"></a>01832     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a21020b4c4a58da48facef5bd06f5528d">focal_length</a> = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>;
<a name="l01833"></a>01833     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">principal_point</a>[0] = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0];
<a name="l01834"></a>01834     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">principal_point</a>[1] = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#acff4230b2146dc9979ee917031338a9e">k1</a> = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a>;
<a name="l01837"></a>01837     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a126be51097b2d719659e000c6684ccb9">k2</a> = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a>;
<a name="l01838"></a>01838     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a44712917093a189257444bbfdc968e67">k3</a> = camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a0a86cfdb028a7b2303b216546f8c6fd8">k3</a>;
<a name="l01839"></a>01839 
<a name="l01840"></a>01840     <span class="keywordflow">return</span> context;
<a name="l01841"></a>01841 }
<a name="l01842"></a>01842 
<a name="l01843"></a><a class="code" href="../../de/ddb/tracking_8c.html#a3cef8c66af52e0e71fedea15114e6619">01843</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1f6ae7bfa410f238dd63c9245f52c9b1">BKE_tracking_reconstruction_context_free</a>(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context)
<a name="l01844"></a>01844 {
<a name="l01845"></a>01845 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01846"></a>01846 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (context-&gt;reconstruction)
<a name="l01847"></a>01847             libmv_destroyReconstruction(context-&gt;reconstruction);
<a name="l01848"></a>01848 
<a name="l01849"></a>01849     libmv_tracksDestroy(context-&gt;tracks);
<a name="l01850"></a>01850 <span class="preprocessor">#endif</span>
<a name="l01851"></a>01851 <span class="preprocessor"></span>
<a name="l01852"></a>01852     <a class="code" href="../../de/ddb/tracking_8c.html#a8cd6b3257043dd18f5c33f2c350c2455">tracks_map_free</a>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">tracks_map</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01853"></a>01853 
<a name="l01854"></a>01854     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(context);
<a name="l01855"></a>01855 }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01858"></a>01858 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> solve_reconstruction_update_cb(<span class="keywordtype">void</span> *customdata, <span class="keywordtype">double</span> progress, <span class="keyword">const</span> <span class="keywordtype">char</span> *message)
<a name="l01859"></a>01859 {
<a name="l01860"></a>01860     <a class="code" href="../../d2/d7a/structReconstructProgressData.html">ReconstructProgressData</a> *progressdata= customdata;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862     <span class="keywordflow">if</span> (progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a8d90a2dd82772ffbb38626453e65d2d0">progress</a>) {
<a name="l01863"></a>01863         *progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a8d90a2dd82772ffbb38626453e65d2d0">progress</a> = progress;
<a name="l01864"></a>01864         *progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#af4c89a9f6b2a78f748634256f3f934cc">do_update</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01865"></a>01865     }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a1ab6c09aea48d5435f833df8de42230f">stats_message</a>, progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#ae011c5c34b6d778d7387516dacd7527d">message_size</a>, <span class="stringliteral">&quot;Solving camera | %s&quot;</span>, message);
<a name="l01868"></a>01868 }
<a name="l01869"></a>01869 <span class="preprocessor">#endif</span>
<a name="l01870"></a>01870 <span class="preprocessor"></span>
<a name="l01871"></a>01871 <span class="preprocessor">#if 0</span>
<a name="l01872"></a>01872 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> solve_reconstruction_testbreak_cb(<span class="keywordtype">void</span> *customdata)
<a name="l01873"></a>01873 {
<a name="l01874"></a>01874     <a class="code" href="../../d2/d7a/structReconstructProgressData.html">ReconstructProgressData</a> *progressdata = customdata;
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="keywordflow">if</span> (progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#aff2c7818fbbbdcab67e01849ca1f6c5d">stop</a> &amp;&amp; *progressdata-&gt;<a class="code" href="../../d2/d7a/structReconstructProgressData.html#aff2c7818fbbbdcab67e01849ca1f6c5d">stop</a>)
<a name="l01877"></a>01877         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <span class="keywordflow">return</span> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek;
<a name="l01880"></a>01880 }
<a name="l01881"></a>01881 <span class="preprocessor">#endif</span>
<a name="l01882"></a>01882 <span class="preprocessor"></span>
<a name="l01883"></a><a class="code" href="../../de/ddb/tracking_8c.html#a1d61a2f1766ca94ceb5b12b3e1e197bd">01883</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a257e9f16885aac0fdcef9c85260e244c">BKE_tracking_solve_reconstruction</a>(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context, <span class="keywordtype">short</span> *stop, <span class="keywordtype">short</span> *do_update,
<a name="l01884"></a>01884                                        <span class="keywordtype">float</span> *progress, <span class="keywordtype">char</span> *stats_message, <span class="keywordtype">int</span> message_size)
<a name="l01885"></a>01885 {
<a name="l01886"></a>01886 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01887"></a>01887 <span class="preprocessor"></span>    <span class="keywordtype">float</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     <a class="code" href="../../d2/d7a/structReconstructProgressData.html">ReconstructProgressData</a> progressdata;
<a name="l01890"></a>01890 
<a name="l01891"></a>01891     progressdata.<a class="code" href="../../d2/d7a/structReconstructProgressData.html#aff2c7818fbbbdcab67e01849ca1f6c5d">stop</a> = stop;
<a name="l01892"></a>01892     progressdata.<a class="code" href="../../d2/d7a/structReconstructProgressData.html#af4c89a9f6b2a78f748634256f3f934cc">do_update</a> = do_update;
<a name="l01893"></a>01893     progressdata.<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a8d90a2dd82772ffbb38626453e65d2d0">progress</a> = progress;
<a name="l01894"></a>01894     progressdata.<a class="code" href="../../d2/d7a/structReconstructProgressData.html#a1ab6c09aea48d5435f833df8de42230f">stats_message</a> = stats_message;
<a name="l01895"></a>01895     progressdata.<a class="code" href="../../d2/d7a/structReconstructProgressData.html#ae011c5c34b6d778d7387516dacd7527d">message_size</a> = message_size;
<a name="l01896"></a>01896 
<a name="l01897"></a>01897     context-&gt;reconstruction = libmv_solveReconstruction(context-&gt;tracks,
<a name="l01898"></a>01898         context-&gt;keyframe1, context-&gt;keyframe2,
<a name="l01899"></a>01899         context-&gt;refine_flags,
<a name="l01900"></a>01900         context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a21020b4c4a58da48facef5bd06f5528d">focal_length</a>,
<a name="l01901"></a>01901         context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">principal_point</a>[0], context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a67dafee59ce58bc973a977fd7212acd3">principal_point</a>[1],
<a name="l01902"></a>01902         context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#acff4230b2146dc9979ee917031338a9e">k1</a>, context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a126be51097b2d719659e000c6684ccb9">k2</a>, context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a44712917093a189257444bbfdc968e67">k3</a>,
<a name="l01903"></a>01903         solve_reconstruction_update_cb, &amp;progressdata);
<a name="l01904"></a>01904 
<a name="l01905"></a>01905     error = libmv_reprojectionError(context-&gt;reconstruction);
<a name="l01906"></a>01906 
<a name="l01907"></a>01907     context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab8b4602175a45317d15c7e78ec8d925a">reprojection_error</a> = <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l01908"></a>01908 <span class="preprocessor">#else</span>
<a name="l01909"></a>01909 <span class="preprocessor"></span>    (void) context;
<a name="l01910"></a>01910     (void) stop;
<a name="l01911"></a>01911     (void) do_update;
<a name="l01912"></a>01912     (void) progress;
<a name="l01913"></a>01913     (void) stats_message;
<a name="l01914"></a>01914     (void) message_size;
<a name="l01915"></a>01915 <span class="preprocessor">#endif</span>
<a name="l01916"></a>01916 <span class="preprocessor"></span>}
<a name="l01917"></a>01917 
<a name="l01918"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad1abce2b3fe961ac1a6083c0242a5b9c">01918</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a091b71aafaac31864bb68d9ea77edba3">BKE_tracking_finish_reconstruction</a>(<a class="code" href="../../d9/de6/structMovieReconstructContext.html">MovieReconstructContext</a> *context, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l01919"></a>01919 {
<a name="l01920"></a>01920     <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction;
<a name="l01921"></a>01921 
<a name="l01922"></a>01922     <a class="code" href="../../de/ddb/tracking_8c.html#a278e8f6edc4d4bf240cfc411a28b457a">tracks_map_merge</a>(context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#aaabf07101b49228b1fd56a3adb84931c">tracks_map</a>, tracking);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     <span class="keywordflow">if</span> (context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab478670a3909150a64f921c37eca0a05">is_camera</a>) {
<a name="l01925"></a>01925         reconstruction = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a08fa44e235d5e8555098950eca818076">reconstruction</a>;
<a name="l01926"></a>01926     }
<a name="l01927"></a>01927     <span class="keywordflow">else</span> {
<a name="l01928"></a>01928         <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *object;
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a44872d3e133985f2608b4a5b3465417e">BKE_tracking_named_object</a>(tracking, context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#a93c436152e2c2c4e62e656e8a9d4d66c">object_name</a>);
<a name="l01931"></a>01931         reconstruction = &amp;<span class="keywordtype">object</span>-&gt;reconstruction;
<a name="l01932"></a>01932     }
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a747ace7d3ea18c0c8d9c69d2560a3699">error</a> = context-&gt;<a class="code" href="../../d9/de6/structMovieReconstructContext.html#ab8b4602175a45317d15c7e78ec8d925a">reprojection_error</a>;
<a name="l01935"></a>01935     reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#acbbc5cb932463c2679953777bffa6158">flag</a> |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aed3b04e5189b1e0de0f79374cab6693a">TRACKING_RECONSTRUCTED</a>;
<a name="l01936"></a>01936 
<a name="l01937"></a>01937 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!retrieve_libmv_reconstruct(context, tracking))
<a name="l01939"></a>01939         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01940"></a>01940 <span class="preprocessor">#endif</span>
<a name="l01941"></a>01941 <span class="preprocessor"></span>
<a name="l01942"></a>01942     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01943"></a>01943 }
<a name="l01944"></a>01944 
<a name="l01945"></a><a class="code" href="../../de/ddb/tracking_8c.html#ae0e7807da37e43927bb7cef3ac83aa10">01945</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a0b939ff1b691932a853cb3f978761993">BKE_track_unique_name</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track)
<a name="l01946"></a>01946 {
<a name="l01947"></a>01947     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(tracksbase, track, <span class="stringliteral">&quot;Track&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, offsetof(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a>, name), <span class="keyword">sizeof</span>(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a5ede2cebd7d3af52ad94c60a496c8781">name</a>));
<a name="l01948"></a>01948 }
<a name="l01949"></a>01949 
<a name="l01950"></a><a class="code" href="../../de/ddb/tracking_8c.html#a76eb5628086dc274126692e49f1d077c">01950</a> <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#af41c185b3eac53033ba48fcb2be7e76c">BKE_tracking_named_track</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l01951"></a>01951 {
<a name="l01952"></a>01952     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l01953"></a>01953     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <span class="keywordflow">while</span> (track) {
<a name="l01956"></a>01956         <span class="keywordflow">if</span> (!strcmp(track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a5ede2cebd7d3af52ad94c60a496c8781">name</a>, name))
<a name="l01957"></a>01957             <span class="keywordflow">return</span> track;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l01960"></a>01960     }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01963"></a>01963 }
<a name="l01964"></a>01964 
<a name="l01965"></a><a class="code" href="../../de/ddb/tracking_8c.html#a6dedf4c17e9ab882dafbe984f5dc5006">01965</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/ddb/tracking_8c.html#a6dedf4c17e9ab882dafbe984f5dc5006">reconstruction_camera_index</a>(<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction, <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> nearest)
<a name="l01966"></a>01966 {
<a name="l01967"></a>01967     <a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a> *cameras= reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>;
<a name="l01968"></a>01968     <span class="keywordtype">int</span> a = 0, d = 1;
<a name="l01969"></a>01969 
<a name="l01970"></a>01970     <span class="keywordflow">if</span> (!reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>)
<a name="l01971"></a>01971         <span class="keywordflow">return</span> -1;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973     <span class="keywordflow">if</span> (framenr&lt;cameras[0].framenr) {
<a name="l01974"></a>01974         <span class="keywordflow">if</span> (nearest)
<a name="l01975"></a>01975             <span class="keywordflow">return</span> 0;
<a name="l01976"></a>01976         <span class="keywordflow">else</span>
<a name="l01977"></a>01977             <span class="keywordflow">return</span> -1;
<a name="l01978"></a>01978     }
<a name="l01979"></a>01979 
<a name="l01980"></a>01980     <span class="keywordflow">if</span> (framenr&gt;cameras[reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a> - 1].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a04041234e354c19fa27a80cc5f194361">framenr</a>) {
<a name="l01981"></a>01981         <span class="keywordflow">if</span> (nearest)
<a name="l01982"></a>01982             <span class="keywordflow">return</span> reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a> - 1;
<a name="l01983"></a>01983         <span class="keywordflow">else</span>
<a name="l01984"></a>01984             <span class="keywordflow">return</span> -1;
<a name="l01985"></a>01985     }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     <span class="keywordflow">if</span> (reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a70285b6d3fb99341999850c56b4f154b">last_camera</a>&lt;reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a858a10d0ab1f32e42121e13ed67ae008">camnr</a>)
<a name="l01988"></a>01988         a = reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a70285b6d3fb99341999850c56b4f154b">last_camera</a>;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <span class="keywordflow">if</span> (cameras[a].framenr &gt;= framenr)
<a name="l01991"></a>01991         d = -1;
<a name="l01992"></a>01992 
<a name="l01993"></a>01993     <span class="keywordflow">while</span> (a &gt;= 0 &amp;&amp; a &lt; reconstruction-&gt;camnr) {
<a name="l01994"></a>01994         <span class="keywordtype">int</span> cfra = cameras[a].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a04041234e354c19fa27a80cc5f194361">framenr</a>;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996         <span class="comment">/* check if needed framenr was &quot;skipped&quot; -- no data for requested frame */</span>
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         <span class="keywordflow">if</span> (d &gt; 0 &amp;&amp; cfra &gt; framenr) {
<a name="l01999"></a>01999             <span class="comment">/* interpolate with previous position */</span>
<a name="l02000"></a>02000             <span class="keywordflow">if</span> (nearest)
<a name="l02001"></a>02001                 <span class="keywordflow">return</span> a - 1;
<a name="l02002"></a>02002             <span class="keywordflow">else</span>
<a name="l02003"></a>02003                 <span class="keywordflow">break</span>;
<a name="l02004"></a>02004         }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006         <span class="keywordflow">if</span> (d &lt; 0 &amp;&amp; cfra &lt; framenr) {
<a name="l02007"></a>02007             <span class="comment">/* interpolate with next position */</span>
<a name="l02008"></a>02008             <span class="keywordflow">if</span> (nearest)
<a name="l02009"></a>02009                 <span class="keywordflow">return</span> a;
<a name="l02010"></a>02010             <span class="keywordflow">else</span>
<a name="l02011"></a>02011                 <span class="keywordflow">break</span>;
<a name="l02012"></a>02012         }
<a name="l02013"></a>02013 
<a name="l02014"></a>02014         <span class="keywordflow">if</span> (cfra == framenr) {
<a name="l02015"></a>02015             reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#a70285b6d3fb99341999850c56b4f154b">last_camera</a> = a;
<a name="l02016"></a>02016 
<a name="l02017"></a>02017             <span class="keywordflow">return</span> a;
<a name="l02018"></a>02018         }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020         a += d;
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023     <span class="keywordflow">return</span> -1;
<a name="l02024"></a>02024 }
<a name="l02025"></a>02025 
<a name="l02026"></a><a class="code" href="../../de/ddb/tracking_8c.html#adf7ee77fc07e6705d765e59760ffd32e">02026</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#adf7ee77fc07e6705d765e59760ffd32e">scale_reconstructed_camera</a>(<a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>, <span class="keywordtype">float</span> mat[4][4])
<a name="l02027"></a>02027 {
<a name="l02028"></a>02028     <span class="keywordflow">if</span> ((object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) == 0) {
<a name="l02029"></a>02029         <span class="keywordtype">float</span> smat[4][4];
<a name="l02030"></a>02030 
<a name="l02031"></a>02031         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a909e45714081a534c919ac867e070b29">scale_m4_fl</a>(smat, 1.0f / object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#af6debc27f132b1e44dad10c459b3a6bc">scale</a>);
<a name="l02032"></a>02032         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, mat, smat);
<a name="l02033"></a>02033     }
<a name="l02034"></a>02034 }
<a name="l02035"></a>02035 
<a name="l02036"></a><a class="code" href="../../de/ddb/tracking_8c.html#a8e059c065c5aef422d2fcd3a819cc012">02036</a> <a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#ab41e143807d3d199e93fb1e743e9da4d">BKE_tracking_get_reconstructed_camera</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking,
<a name="l02037"></a>02037                                                                 <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>, <span class="keywordtype">int</span> framenr)
<a name="l02038"></a>02038 {
<a name="l02039"></a>02039     <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction;
<a name="l02040"></a>02040     <span class="keywordtype">int</span> a;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     reconstruction = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a93b49c63ec3d36b72f2c947eceda5ee7">BKE_tracking_object_reconstruction</a>(tracking, <span class="keywordtype">object</span>);
<a name="l02043"></a>02043     a = <a class="code" href="../../de/ddb/tracking_8c.html#a6dedf4c17e9ab882dafbe984f5dc5006">reconstruction_camera_index</a>(reconstruction, framenr, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02044"></a>02044 
<a name="l02045"></a>02045     <span class="keywordflow">if</span> (a ==-1)
<a name="l02046"></a>02046         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     <span class="keywordflow">return</span> &amp;reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>[a];
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a><a class="code" href="../../de/ddb/tracking_8c.html#a91e02d4868e4ad4ed930ff9c072f4b2e">02051</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a96d54640646bbd7da504bd98baab321b">BKE_tracking_get_interpolated_camera</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>,
<a name="l02052"></a>02052                                           <span class="keywordtype">int</span> framenr, <span class="keywordtype">float</span> mat[4][4])
<a name="l02053"></a>02053 {
<a name="l02054"></a>02054     <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *reconstruction;
<a name="l02055"></a>02055     <a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a> *cameras;
<a name="l02056"></a>02056     <span class="keywordtype">int</span> a;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058     reconstruction = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a93b49c63ec3d36b72f2c947eceda5ee7">BKE_tracking_object_reconstruction</a>(tracking, <span class="keywordtype">object</span>);
<a name="l02059"></a>02059     cameras = reconstruction-&gt;<a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html#ac680e228e4654f3375f1458195da30e1">cameras</a>;
<a name="l02060"></a>02060     a = <a class="code" href="../../de/ddb/tracking_8c.html#a6dedf4c17e9ab882dafbe984f5dc5006">reconstruction_camera_index</a>(reconstruction, framenr, 1);
<a name="l02061"></a>02061 
<a name="l02062"></a>02062     <span class="keywordflow">if</span> (a == -1) {
<a name="l02063"></a>02063         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(mat);
<a name="l02064"></a>02064 
<a name="l02065"></a>02065         <span class="keywordflow">return</span>;
<a name="l02066"></a>02066     }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <span class="keywordflow">if</span> (cameras[a].framenr != framenr &amp;&amp; a &gt; 0 &amp;&amp; a &lt; reconstruction-&gt;camnr - 1) {
<a name="l02069"></a>02069         <span class="keywordtype">float</span> t = ((float)framenr-cameras[a].framenr) / (cameras[a + 1].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a04041234e354c19fa27a80cc5f194361">framenr</a>-cameras[a].<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a04041234e354c19fa27a80cc5f194361">framenr</a>);
<a name="l02070"></a>02070 
<a name="l02071"></a>02071         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a3d5bcb56397fadbf6966427875962a01">blend_m4_m4m4</a>(mat, cameras[a].mat, cameras[a+1].mat, t);
<a name="l02072"></a>02072     }
<a name="l02073"></a>02073     <span class="keywordflow">else</span> {
<a name="l02074"></a>02074         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, cameras[a].mat);
<a name="l02075"></a>02075     }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077     <a class="code" href="../../de/ddb/tracking_8c.html#adf7ee77fc07e6705d765e59760ffd32e">scale_reconstructed_camera</a>(<span class="keywordtype">object</span>, mat);
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 
<a name="l02080"></a><a class="code" href="../../de/ddb/tracking_8c.html#a268ad849eddf017e9b543a7967f4d646">02080</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad50223def7cd0a2546dd3fec650ee253">BKE_get_tracking_mat</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> mat[4][4])
<a name="l02081"></a>02081 {
<a name="l02082"></a>02082     <span class="keywordflow">if</span> (!ob) {
<a name="l02083"></a>02083         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>)
<a name="l02084"></a>02084             ob = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>;
<a name="l02085"></a>02085         <span class="keywordflow">else</span>
<a name="l02086"></a>02086             ob = <a class="code" href="../../d8/d53/BKE__scene_8h.html#abb034059e60f19f508f88bc867e01760">scene_find_camera</a>(scene);
<a name="l02087"></a>02087     }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <span class="keywordflow">if</span> (ob)
<a name="l02090"></a>02090         <a class="code" href="../../df/dac/BKE__object_8h.html#a2e2ae332fc715b27eef001253593053b">where_is_object_mat</a>(scene, ob, mat);
<a name="l02091"></a>02091     <span class="keywordflow">else</span>
<a name="l02092"></a>02092         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(mat);
<a name="l02093"></a>02093 }
<a name="l02094"></a>02094 
<a name="l02095"></a><a class="code" href="../../de/ddb/tracking_8c.html#af180f07927be2337431ee7ec69588e45">02095</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a23682a2566b12144d7d0cdb8a2e863ad">BKE_tracking_camera_shift</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <span class="keywordtype">float</span> *shiftx, <span class="keywordtype">float</span> *shifty)
<a name="l02096"></a>02096 {
<a name="l02097"></a>02097     <span class="comment">/* indeed in both of cases it should be winx -- it&#39;s just how camera shift works for blender&#39;s camera */</span>
<a name="l02098"></a>02098     *shiftx = (0.5f * winx-tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0]) / winx;
<a name="l02099"></a>02099     *shifty = (0.5f * winy-tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1]) / winx;
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a><a class="code" href="../../de/ddb/tracking_8c.html#a31e54db8be5ea073dd1282b1b6a61f57">02102</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a7c246f9a8a88529572cfda90792f58ed">BKE_tracking_camera_to_blender</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d7/d7e/structCamera.html">Camera</a> *camera, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l02103"></a>02103 {
<a name="l02104"></a>02104     <span class="keywordtype">float</span> focal = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106     camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#acdf39c5ffbd9b9363fd230256a6a5bef">sensor_x</a> = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a65ba33a89879f2c22a2876610d393d69">sensor_width</a>;
<a name="l02107"></a>02107     camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a0ed5613b5883c690ae6b8cf690a36d11">sensor_fit</a> = <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a7cfd9f3a93c7ffd7ee104c8b560d1d5f">CAMERA_SENSOR_FIT_AUTO</a>;
<a name="l02108"></a>02108     camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a480d411803627517badcebf58c28d0da">lens</a> = focal*camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#acdf39c5ffbd9b9363fd230256a6a5bef">sensor_x</a>/width;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afac89783028ff848f111de04e0c29fbe">xsch</a> = width*tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02111"></a>02111     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aca3c1ebdf50a6c74730e19e24983217d">ysch</a> = height;
<a name="l02112"></a>02112 
<a name="l02113"></a>02113     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a> = 1.0f;
<a name="l02114"></a>02114     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a> = 1.0f;
<a name="l02115"></a>02115 
<a name="l02116"></a>02116     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a23682a2566b12144d7d0cdb8a2e863ad">BKE_tracking_camera_shift</a>(tracking, width, height, &amp;camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a69e033fd80e2390b579d43d81b79f1c7">shiftx</a>, &amp;camera-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ae9ed1d789ff2218ca0c0f2170353d563">shifty</a>);
<a name="l02117"></a>02117 }
<a name="l02118"></a>02118 
<a name="l02119"></a><a class="code" href="../../de/ddb/tracking_8c.html#af13db10079069c9b0bc7160d28eafadd">02119</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6e6d26a139246d995077af2c695250ea">BKE_tracking_projection_matrix</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>,
<a name="l02120"></a>02120                                     <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <span class="keywordtype">float</span> mat[4][4])
<a name="l02121"></a>02121 {
<a name="l02122"></a>02122     <a class="code" href="../../dc/db7/structMovieReconstructedCamera.html">MovieReconstructedCamera</a> *camera;
<a name="l02123"></a>02123     <span class="keywordtype">float</span> lens = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>*tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a65ba33a89879f2c22a2876610d393d69">sensor_width</a>/(float)winx;
<a name="l02124"></a>02124     <span class="keywordtype">float</span> viewfac, pixsize, <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, right, bottom, top, clipsta, clipend;
<a name="l02125"></a>02125     <span class="keywordtype">float</span> winmat[4][4];
<a name="l02126"></a>02126     <span class="keywordtype">float</span> ycor =  1.0f / tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02127"></a>02127     <span class="keywordtype">float</span> shiftx, shifty, winside = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(winx, winy);
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a23682a2566b12144d7d0cdb8a2e863ad">BKE_tracking_camera_shift</a>(tracking, winx, winy, &amp;shiftx, &amp;shifty);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131     clipsta = 0.1f;
<a name="l02132"></a>02132     clipend = 1000.0f;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134     <span class="keywordflow">if</span> (winx &gt;= winy)
<a name="l02135"></a>02135         viewfac = (lens*winx)/tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a65ba33a89879f2c22a2876610d393d69">sensor_width</a>;
<a name="l02136"></a>02136     <span class="keywordflow">else</span>
<a name="l02137"></a>02137         viewfac = (ycor*lens*winy)/tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a65ba33a89879f2c22a2876610d393d69">sensor_width</a>;
<a name="l02138"></a>02138 
<a name="l02139"></a>02139     pixsize = clipsta/viewfac;
<a name="l02140"></a>02140 
<a name="l02141"></a>02141     left = -0.5f * (float)winx + shiftx * winside;
<a name="l02142"></a>02142     bottom = -0.5f * (ycor) * (<span class="keywordtype">float</span>)winy + shifty * winside;
<a name="l02143"></a>02143     right =  0.5f * (float)winx + shiftx * winside;
<a name="l02144"></a>02144     top =  0.5f * (ycor) * (<span class="keywordtype">float</span>)winy + shifty * winside;
<a name="l02145"></a>02145 
<a name="l02146"></a>02146     left *= pixsize;
<a name="l02147"></a>02147     right *= pixsize;
<a name="l02148"></a>02148     bottom *= pixsize;
<a name="l02149"></a>02149     top *= pixsize;
<a name="l02150"></a>02150 
<a name="l02151"></a>02151     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8e39ae9dcc346cc95db26002260d0ee7">perspective_m4</a>(winmat, left, right, bottom, top, clipsta, clipend);
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     camera = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ab41e143807d3d199e93fb1e743e9da4d">BKE_tracking_get_reconstructed_camera</a>(tracking, <span class="keywordtype">object</span>, framenr);
<a name="l02154"></a>02154 
<a name="l02155"></a>02155     <span class="keywordflow">if</span> (camera) {
<a name="l02156"></a>02156         <span class="keywordtype">float</span> imat[4][4];
<a name="l02157"></a>02157 
<a name="l02158"></a>02158         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, camera-&gt;<a class="code" href="../../dc/db7/structMovieReconstructedCamera.html#a9668120603df1c73d8c174083c52cbd7">mat</a>);
<a name="l02159"></a>02159         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, winmat, imat);
<a name="l02160"></a>02160     }
<a name="l02161"></a>02161     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, winmat);
<a name="l02162"></a>02162 }
<a name="l02163"></a>02163 
<a name="l02164"></a><a class="code" href="../../de/ddb/tracking_8c.html#a6a7a40dc9cbca8735b6f16dd294d8838">02164</a> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a306f9d42cfc651d8620b0d31bfbebd98">BKE_tracking_get_tracks</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l02165"></a>02165 {
<a name="l02166"></a>02166     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a80f28d9682b0ac7ef0330d8ba9ce06f3">BKE_tracking_active_object</a>(tracking);
<a name="l02167"></a>02167 
<a name="l02168"></a>02168     <span class="keywordflow">if</span> (<span class="keywordtype">object</span> &amp;&amp; (object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) == 0) {
<a name="l02169"></a>02169         <span class="keywordflow">return</span> &amp;<span class="keywordtype">object</span>-&gt;tracks;
<a name="l02170"></a>02170     }
<a name="l02171"></a>02171 
<a name="l02172"></a>02172     <span class="keywordflow">return</span> &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>;
<a name="l02173"></a>02173 }
<a name="l02174"></a>02174 
<a name="l02175"></a><a class="code" href="../../de/ddb/tracking_8c.html#a8619261f4bdd596db756682f22501cb6">02175</a> <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a8f9e672798114ca61c2b66776bf4a6c8">BKE_tracking_active_track</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l02176"></a>02176 {
<a name="l02177"></a>02177     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase;
<a name="l02178"></a>02178 
<a name="l02179"></a>02179     <span class="keywordflow">if</span> (!tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a>)
<a name="l02180"></a>02180         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02181"></a>02181 
<a name="l02182"></a>02182     tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a306f9d42cfc651d8620b0d31bfbebd98">BKE_tracking_get_tracks</a>(tracking);
<a name="l02183"></a>02183 
<a name="l02184"></a>02184     <span class="comment">/* check that active track is in current tracks list */</span>
<a name="l02185"></a>02185     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(tracksbase, tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a>) &gt;= 0)
<a name="l02186"></a>02186         <span class="keywordflow">return</span> tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a>;
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02189"></a>02189 }
<a name="l02190"></a>02190 
<a name="l02191"></a><a class="code" href="../../de/ddb/tracking_8c.html#ae9404c7cc3671d07cc86212e41c3ed1f">02191</a> <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a80f28d9682b0ac7ef0330d8ba9ce06f3">BKE_tracking_active_object</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l02192"></a>02192 {
<a name="l02193"></a>02193     <span class="keywordflow">return</span> <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>, tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a4053f7b709ef765fc6d449a0b742ff14">objectnr</a>);
<a name="l02194"></a>02194 }
<a name="l02195"></a>02195 
<a name="l02196"></a><a class="code" href="../../de/ddb/tracking_8c.html#a4f73a3290984a8edd06b58283084788d">02196</a> <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a6cf53366cb46f7d547264460318ef68b">BKE_tracking_get_camera_object</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l02197"></a>02197 {
<a name="l02198"></a>02198     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     <span class="keywordflow">while</span> (<span class="keywordtype">object</span>) {
<a name="l02201"></a>02201         <span class="keywordflow">if</span> (object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>)
<a name="l02202"></a>02202             <span class="keywordflow">return</span> object;
<a name="l02203"></a>02203 
<a name="l02204"></a>02204         <span class="keywordtype">object</span>= <span class="keywordtype">object</span>-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a9c25b559861625fafa9281d308689f46">next</a>;
<a name="l02205"></a>02205     }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02208"></a>02208 }
<a name="l02209"></a>02209 
<a name="l02210"></a><a class="code" href="../../de/ddb/tracking_8c.html#abded9b65a71efa8bd1976c9692a95586">02210</a> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l02211"></a>02211 {
<a name="l02212"></a>02212     <span class="keywordflow">if</span> (object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) {
<a name="l02213"></a>02213         <span class="keywordflow">return</span> &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>;
<a name="l02214"></a>02214     }
<a name="l02215"></a>02215 
<a name="l02216"></a>02216     <span class="keywordflow">return</span> &amp;<span class="keywordtype">object</span>-&gt;tracks;
<a name="l02217"></a>02217 }
<a name="l02218"></a>02218 
<a name="l02219"></a><a class="code" href="../../de/ddb/tracking_8c.html#a8ec9574ad9f13c2191b53b4ef90ed318">02219</a> <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a93b49c63ec3d36b72f2c947eceda5ee7">BKE_tracking_object_reconstruction</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l02220"></a>02220 {
<a name="l02221"></a>02221     <span class="keywordflow">if</span> (object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) {
<a name="l02222"></a>02222         <span class="keywordflow">return</span> &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a08fa44e235d5e8555098950eca818076">reconstruction</a>;
<a name="l02223"></a>02223     }
<a name="l02224"></a>02224 
<a name="l02225"></a>02225     <span class="keywordflow">return</span> &amp;<span class="keywordtype">object</span>-&gt;reconstruction;
<a name="l02226"></a>02226 }
<a name="l02227"></a>02227 
<a name="l02228"></a><a class="code" href="../../de/ddb/tracking_8c.html#a5251948f2802be220d9c2ec8f269f10f">02228</a> <a class="code" href="../../dd/d65/structMovieTrackingReconstruction.html">MovieTrackingReconstruction</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#ab3e13ed91183be384ade135feb3ce5c9">BKE_tracking_get_reconstruction</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking)
<a name="l02229"></a>02229 {
<a name="l02230"></a>02230     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a80f28d9682b0ac7ef0330d8ba9ce06f3">BKE_tracking_active_object</a>(tracking);
<a name="l02231"></a>02231 
<a name="l02232"></a>02232     <span class="keywordflow">return</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a93b49c63ec3d36b72f2c947eceda5ee7">BKE_tracking_object_reconstruction</a>(tracking, <span class="keywordtype">object</span>);
<a name="l02233"></a>02233 }
<a name="l02234"></a>02234 
<a name="l02235"></a><a class="code" href="../../de/ddb/tracking_8c.html#a6d38b068a34038e9595080e86369d227">02235</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a5d56ac1af4fbb9afef926d1bd54ae95b">BKE_tracking_apply_intrinsics</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2], <span class="keywordtype">float</span> nco[2])
<a name="l02236"></a>02236 {
<a name="l02237"></a>02237     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera= &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l02238"></a>02238 
<a name="l02239"></a>02239 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02240"></a>02240 <span class="preprocessor"></span>    <span class="keywordtype">double</span> x, y;
<a name="l02241"></a>02241     <span class="keywordtype">float</span> aspy = 1.0f/tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     <span class="comment">/* normalize coords */</span>
<a name="l02244"></a>02244     x = (co[0] - camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0]) / camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>;
<a name="l02245"></a>02245     y = (co[1] - camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy) / camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>;
<a name="l02246"></a>02246 
<a name="l02247"></a>02247     libmv_applyCameraIntrinsics(camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0], camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy,
<a name="l02248"></a>02248                                 camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a0a86cfdb028a7b2303b216546f8c6fd8">k3</a>, x, y, &amp;x, &amp;y);
<a name="l02249"></a>02249 
<a name="l02250"></a>02250     <span class="comment">/* result is in image coords already */</span>
<a name="l02251"></a>02251     nco[0] = x;
<a name="l02252"></a>02252     nco[1] = y;
<a name="l02253"></a>02253 <span class="preprocessor">#else</span>
<a name="l02254"></a>02254 <span class="preprocessor"></span>    (void) camera;
<a name="l02255"></a>02255     (void) co;
<a name="l02256"></a>02256     (void) nco;
<a name="l02257"></a>02257 <span class="preprocessor">#endif</span>
<a name="l02258"></a>02258 <span class="preprocessor"></span>}
<a name="l02259"></a>02259 
<a name="l02260"></a><a class="code" href="../../de/ddb/tracking_8c.html#a3cb6b36bb07296922955a01fa8cedc1b">02260</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#ae053067dcbc1a132eec77ca007977ce3">BKE_tracking_invert_intrinsics</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2], <span class="keywordtype">float</span> nco[2])
<a name="l02261"></a>02261 {
<a name="l02262"></a>02262     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l02263"></a>02263 
<a name="l02264"></a>02264 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02265"></a>02265 <span class="preprocessor"></span>    <span class="keywordtype">double</span> x = co[0], y = co[1];
<a name="l02266"></a>02266     <span class="keywordtype">float</span> aspy = 1.0f / tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02267"></a>02267 
<a name="l02268"></a>02268     libmv_InvertIntrinsics(camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0], camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy,
<a name="l02269"></a>02269                            camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a0a86cfdb028a7b2303b216546f8c6fd8">k3</a>, x, y, &amp;x, &amp;y);
<a name="l02270"></a>02270 
<a name="l02271"></a>02271     nco[0] = x * camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a> + camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0];
<a name="l02272"></a>02272     nco[1] = y * camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a> + camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy;
<a name="l02273"></a>02273 <span class="preprocessor">#else</span>
<a name="l02274"></a>02274 <span class="preprocessor"></span>    (void) camera;
<a name="l02275"></a>02275     (void) co;
<a name="l02276"></a>02276     (void) nco;
<a name="l02277"></a>02277 <span class="preprocessor">#endif</span>
<a name="l02278"></a>02278 <span class="preprocessor"></span>}
<a name="l02279"></a>02279 
<a name="l02280"></a>02280 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02281"></a>02281 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> point_in_stroke(<a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *stroke, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y)
<a name="l02282"></a>02282 {
<a name="l02283"></a>02283     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, prev;
<a name="l02284"></a>02284     <span class="keywordtype">int</span> count = 0;
<a name="l02285"></a>02285     <a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a> *points = stroke-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287     prev = stroke-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> - 1;
<a name="l02288"></a>02288 
<a name="l02289"></a>02289     <span class="keywordflow">for</span> (i = 0; i&lt;stroke-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>; i++) {
<a name="l02290"></a>02290         <span class="keywordflow">if</span> ((points[i].y &lt; y &amp;&amp; points[prev].y &gt;= y) || (points[prev].y &lt; y &amp;&amp; points[i].y &gt;= y)) {
<a name="l02291"></a>02291             <span class="keywordtype">float</span> fac = (y - points[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a>) / (points[prev].y - points[i].y);
<a name="l02292"></a>02292 
<a name="l02293"></a>02293             <span class="keywordflow">if</span> (points[i].x + fac * (points[prev].x - points[i].x) &lt; x)
<a name="l02294"></a>02294                 count++;
<a name="l02295"></a>02295         }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297         prev= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02298"></a>02298     }
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     <span class="keywordflow">return</span> count % 2;
<a name="l02301"></a>02301 }
<a name="l02302"></a>02302 
<a name="l02303"></a>02303 <span class="keyword">static</span> <span class="keywordtype">int</span> point_in_layer(<a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *layer, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y)
<a name="l02304"></a>02304 {
<a name="l02305"></a>02305     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *frame = layer-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#ab6b8d0f88de061c89b2e6c982cf315d8">frames</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02306"></a>02306 
<a name="l02307"></a>02307     <span class="keywordflow">while</span> (frame) {
<a name="l02308"></a>02308         <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *stroke = frame-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02309"></a>02309 
<a name="l02310"></a>02310         <span class="keywordflow">while</span> (stroke) {
<a name="l02311"></a>02311             <span class="keywordflow">if</span> (point_in_stroke(stroke, x, y))
<a name="l02312"></a>02312                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02313"></a>02313 
<a name="l02314"></a>02314             stroke = stroke-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#aeec4e6a65ac743fd5a2a3ede11f2f85e">next</a>;
<a name="l02315"></a>02315         }
<a name="l02316"></a>02316         frame = frame-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#a4d6f43b91302df84606cc035b683243c">next</a>;
<a name="l02317"></a>02317     }
<a name="l02318"></a>02318 
<a name="l02319"></a>02319     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02320"></a>02320 }
<a name="l02321"></a>02321 
<a name="l02322"></a>02322 <span class="keyword">static</span> <span class="keywordtype">void</span> retrieve_libmv_features(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase,
<a name="l02323"></a>02323                                     <span class="keyword">struct</span> libmv_Features *features, <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height,
<a name="l02324"></a>02324                                     <a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *layer, <span class="keywordtype">int</span> place_outside_layer)
<a name="l02325"></a>02325 {
<a name="l02326"></a>02326     <span class="keywordtype">int</span> a;
<a name="l02327"></a>02327 
<a name="l02328"></a>02328     a = libmv_countFeatures(features);
<a name="l02329"></a>02329     <span class="keywordflow">while</span> (a--) {
<a name="l02330"></a>02330         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l02331"></a>02331         <span class="keywordtype">double</span> x, y, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, score;
<a name="l02332"></a>02332         <span class="keywordtype">int</span> ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02333"></a>02333         <span class="keywordtype">float</span> xu, yu;
<a name="l02334"></a>02334 
<a name="l02335"></a>02335         libmv_getFeature(features, a, &amp;x, &amp;y, &amp;score, &amp;size);
<a name="l02336"></a>02336 
<a name="l02337"></a>02337         xu = x / width;
<a name="l02338"></a>02338         yu = y / height;
<a name="l02339"></a>02339 
<a name="l02340"></a>02340         <span class="keywordflow">if</span> (layer)
<a name="l02341"></a>02341             ok = point_in_layer(layer, xu, yu) != place_outside_layer;
<a name="l02342"></a>02342 
<a name="l02343"></a>02343         <span class="keywordflow">if</span> (ok) {
<a name="l02344"></a>02344             track = <a class="code" href="../../da/d72/BKE__tracking_8h.html#a45af13c41af118eb40b58e5c688285c7">BKE_tracking_add_track</a>(tracking, tracksbase, xu, yu, framenr, width, height);
<a name="l02345"></a>02345             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> |= <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l02346"></a>02346             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec9e4b85457888f46e115bd7eecd8147">pat_flag</a> |= <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l02347"></a>02347             track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a0c81dbd39eaf96130d20074eceb8f73d">search_flag</a> |= <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l02348"></a>02348         }
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350 }
<a name="l02351"></a>02351 <span class="preprocessor">#endif</span>
<a name="l02352"></a>02352 <span class="preprocessor"></span>
<a name="l02353"></a><a class="code" href="../../de/ddb/tracking_8c.html#ae875a33bb20000e62b561888aed763de">02353</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#aa54f80e93d36828dd74ec09c1938806d">BKE_tracking_detect_fast</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf,
<a name="l02354"></a>02354                               <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> margin, <span class="keywordtype">int</span> min_trackness, <span class="keywordtype">int</span> min_distance, <a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *layer,
<a name="l02355"></a>02355                               <span class="keywordtype">int</span> place_outside_layer)
<a name="l02356"></a>02356 {
<a name="l02357"></a>02357 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02358"></a>02358 <span class="preprocessor"></span>    <span class="keyword">struct </span>libmv_Features *features;
<a name="l02359"></a>02359     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pixels = get_ucharbuf(ibuf);
<a name="l02360"></a>02360 
<a name="l02361"></a>02361     features = libmv_detectFeaturesFAST(pixels, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>,
<a name="l02362"></a>02362                                         margin, min_trackness, min_distance);
<a name="l02363"></a>02363 
<a name="l02364"></a>02364     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pixels);
<a name="l02365"></a>02365 
<a name="l02366"></a>02366     retrieve_libmv_features(tracking, tracksbase, features, framenr,
<a name="l02367"></a>02367                             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, layer, place_outside_layer);
<a name="l02368"></a>02368 
<a name="l02369"></a>02369     libmv_destroyFeatures(features);
<a name="l02370"></a>02370 <span class="preprocessor">#else</span>
<a name="l02371"></a>02371 <span class="preprocessor"></span>    (void) tracking;
<a name="l02372"></a>02372     (void) tracksbase;
<a name="l02373"></a>02373     (void) ibuf;
<a name="l02374"></a>02374     (void) framenr;
<a name="l02375"></a>02375     (void) margin;
<a name="l02376"></a>02376     (void) min_trackness;
<a name="l02377"></a>02377     (void) min_distance;
<a name="l02378"></a>02378     (void) layer;
<a name="l02379"></a>02379     (void) place_outside_layer;
<a name="l02380"></a>02380 <span class="preprocessor">#endif</span>
<a name="l02381"></a>02381 <span class="preprocessor"></span>}
<a name="l02382"></a>02382 
<a name="l02383"></a><a class="code" href="../../de/ddb/tracking_8c.html#a634870f9eef5c321d42a4dfc96a97c89">02383</a> <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#afba1959ce12c6c7a19de5488d91e2122">BKE_tracking_indexed_track</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> tracknr, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **tracksbase_r)
<a name="l02384"></a>02384 {
<a name="l02385"></a>02385     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *object;
<a name="l02386"></a>02386     <span class="keywordtype">int</span> cur = 1;
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="keywordtype">object</span> = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02389"></a>02389     <span class="keywordflow">while</span> (<span class="keywordtype">object</span>) {
<a name="l02390"></a>02390         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase = <a class="code" href="../../da/d72/BKE__tracking_8h.html#abec329052feec9dd243b253ac2ce2033">BKE_tracking_object_tracks</a>(tracking, <span class="keywordtype">object</span>);
<a name="l02391"></a>02391         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02392"></a>02392 
<a name="l02393"></a>02393         <span class="keywordflow">while</span> (track) {
<a name="l02394"></a>02394             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a0ecbc30a5ba19dbf9ded156314eed34e">TRACK_HAS_BUNDLE</a>) {
<a name="l02395"></a>02395                 <span class="keywordflow">if</span> (cur == tracknr) {
<a name="l02396"></a>02396                     *tracksbase_r = tracksbase;
<a name="l02397"></a>02397                     <span class="keywordflow">return</span> track;
<a name="l02398"></a>02398                 }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400                 cur++;
<a name="l02401"></a>02401             }
<a name="l02402"></a>02402 
<a name="l02403"></a>02403             track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02404"></a>02404         }
<a name="l02405"></a>02405 
<a name="l02406"></a>02406         <span class="keywordtype">object</span>= <span class="keywordtype">object</span>-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02407"></a>02407     }
<a name="l02408"></a>02408 
<a name="l02409"></a>02409     *tracksbase_r= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02410"></a>02410 
<a name="l02411"></a>02411     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02412"></a>02412 }
<a name="l02413"></a>02413 
<a name="l02414"></a><a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">02414</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">stabilization_median_point</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> framenr, <span class="keywordtype">float</span> median[2])
<a name="l02415"></a>02415 {
<a name="l02416"></a>02416     <span class="keywordtype">int</span> ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02417"></a>02417     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[2], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[2];
<a name="l02418"></a>02418     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l02419"></a>02419 
<a name="l02420"></a>02420     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1a74cc7bfb4a5b9eda1fb38c3fbb51c1">INIT_MINMAX2</a>(min, max);
<a name="l02421"></a>02421 
<a name="l02422"></a>02422     track = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02423"></a>02423     <span class="keywordflow">while</span> (track) {
<a name="l02424"></a>02424         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#adc2b44ad0a3d508c5e794f12285e5daa">TRACK_USE_2D_STAB</a>) {
<a name="l02425"></a>02425             <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(track, framenr);
<a name="l02426"></a>02426 
<a name="l02427"></a>02427             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, min, max);
<a name="l02428"></a>02428 
<a name="l02429"></a>02429             ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02430"></a>02430         }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432         track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02433"></a>02433     }
<a name="l02434"></a>02434 
<a name="l02435"></a>02435     median[0] = (max[0] + min[0]) / 2.0f;
<a name="l02436"></a>02436     median[1] = (max[1] + min[1]) / 2.0f;
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     <span class="keywordflow">return</span> ok;
<a name="l02439"></a>02439 }
<a name="l02440"></a>02440 
<a name="l02441"></a><a class="code" href="../../de/ddb/tracking_8c.html#a8b7460f930bd7a591b73a3dcaab73e18">02441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#a8b7460f930bd7a591b73a3dcaab73e18">calculate_stabdata</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> framenr, <span class="keywordtype">float</span> width, <span class="keywordtype">float</span> height,
<a name="l02442"></a>02442                                <span class="keywordtype">float</span> firstmedian[2], <span class="keywordtype">float</span> median[2], <span class="keywordtype">float</span> loc[2], <span class="keywordtype">float</span> *scale, <span class="keywordtype">float</span> *<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>)
<a name="l02443"></a>02443 {
<a name="l02444"></a>02444     <a class="code" href="../../db/ddf/structMovieTrackingStabilization.html">MovieTrackingStabilization</a> *stab = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>;
<a name="l02445"></a>02445 
<a name="l02446"></a>02446     *scale = (stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> - 1.0f) * stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a70a926f4fcaacd2310d34e46a4290abf">scaleinf</a> + 1.0f;
<a name="l02447"></a>02447     *angle = 0.0f;
<a name="l02448"></a>02448 
<a name="l02449"></a>02449     loc[0] = (firstmedian[0] - median[0]) *width * (*scale);
<a name="l02450"></a>02450     loc[1] = (firstmedian[1] - median[1]) *height * (*scale);
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(loc, stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a51483e98af0b28fd0e3505b3436dbfce">locinf</a>);
<a name="l02453"></a>02453 
<a name="l02454"></a>02454     <span class="keywordflow">if</span> ((stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06683e1f99859f966d98c00495873532">TRACKING_STABILIZE_ROTATION</a>) &amp;&amp; stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a> &amp;&amp; stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a66851bed9131dbabc35af2922fd5cc75">rotinf</a>) {
<a name="l02455"></a>02455         <a class="code" href="../../d2/d75/structMovieTrackingMarker.html">MovieTrackingMarker</a> *marker;
<a name="l02456"></a>02456         <span class="keywordtype">float</span> a[2], b[2];
<a name="l02457"></a>02457         <span class="keywordtype">float</span> x0 = (float)width / 2.0f, y0 = (<span class="keywordtype">float</span>)height / 2.0f;
<a name="l02458"></a>02458         <span class="keywordtype">float</span> x = median[0] * width, y = median[1] * height;
<a name="l02459"></a>02459 
<a name="l02460"></a>02460         marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a>, 1);
<a name="l02461"></a>02461         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(a, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, firstmedian);
<a name="l02462"></a>02462         a[0] *= width;
<a name="l02463"></a>02463         a[1] *= height;
<a name="l02464"></a>02464 
<a name="l02465"></a>02465         marker = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ad5dea623719f25d453310a97ee138b6f">BKE_tracking_get_marker</a>(stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a>, framenr);
<a name="l02466"></a>02466         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(b, marker-&gt;<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#a77909423cde0f8a5b52779c8897bb654">pos</a>, median);
<a name="l02467"></a>02467         b[0] *= width;
<a name="l02468"></a>02468         b[1] *= height;
<a name="l02469"></a>02469 
<a name="l02470"></a>02470         *angle = -<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(a[0]*b[1]-a[1]*b[0], a[0]*b[0]+a[1]*b[1]);
<a name="l02471"></a>02471         *angle *= stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a66851bed9131dbabc35af2922fd5cc75">rotinf</a>;
<a name="l02472"></a>02472 
<a name="l02473"></a>02473         <span class="comment">/* convert to rotation around image center */</span>
<a name="l02474"></a>02474         loc[0] -= (x0 + (x - x0) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(*angle) - (y - y0) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(*angle) - x) * (*scale);
<a name="l02475"></a>02475         loc[1] -= (y0 + (x - x0) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(*angle) + (y - y0) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(*angle) - y) * (*scale);
<a name="l02476"></a>02476     }
<a name="l02477"></a>02477 }
<a name="l02478"></a>02478 
<a name="l02479"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad934bf1bc956a10c7b9a066fdbd056c4">02479</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../de/ddb/tracking_8c.html#ad934bf1bc956a10c7b9a066fdbd056c4">stabilization_auto_scale_factor</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l02480"></a>02480 {
<a name="l02481"></a>02481     <span class="keywordtype">float</span> firstmedian[2];
<a name="l02482"></a>02482     <a class="code" href="../../db/ddf/structMovieTrackingStabilization.html">MovieTrackingStabilization</a> *stab = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>;
<a name="l02483"></a>02483     <span class="keywordtype">float</span> aspect = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02484"></a>02484 
<a name="l02485"></a>02485     <span class="keywordflow">if</span> (stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#af45dd7955027c6f892e7f1ad15ffdc9a">ok</a>)
<a name="l02486"></a>02486         <span class="keywordflow">return</span> stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a>;
<a name="l02487"></a>02487 
<a name="l02488"></a>02488     <span class="keywordflow">if</span> (<a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">stabilization_median_point</a>(tracking, 1, firstmedian)) {
<a name="l02489"></a>02489         <span class="keywordtype">int</span> sfra = INT_MAX, efra = INT_MIN, cfra;
<a name="l02490"></a>02490         <span class="keywordtype">float</span> scale = 1.0f;
<a name="l02491"></a>02491         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l02492"></a>02492 
<a name="l02493"></a>02493         stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> = 1.0f;
<a name="l02494"></a>02494 
<a name="l02495"></a>02495         track = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a74fe531242e070b2108266db9046bf8f">tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02496"></a>02496         <span class="keywordflow">while</span> (track) {
<a name="l02497"></a>02497             <span class="keywordflow">if</span> (track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#adc2b44ad0a3d508c5e794f12285e5daa">TRACK_USE_2D_STAB</a> ||
<a name="l02498"></a>02498                ((stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06683e1f99859f966d98c00495873532">TRACKING_STABILIZE_ROTATION</a>) &amp;&amp; track == stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#ae9b55bdb3802264af7f2c14ab8056df2">rot_track</a>))
<a name="l02499"></a>02499             {
<a name="l02500"></a>02500                 sfra = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(sfra, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[0].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>);
<a name="l02501"></a>02501                 efra = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(efra, track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a9b873f8e5dc871f03a5ea0a42095927e">markers</a>[track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#ada388ae01f83b973d2efb1414aab67de">markersnr</a> - 1].<a class="code" href="../../d2/d75/structMovieTrackingMarker.html#add7ffc50ffb44d63da012f43977e38ad">framenr</a>);
<a name="l02502"></a>02502             }
<a name="l02503"></a>02503 
<a name="l02504"></a>02504             track = track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02505"></a>02505         }
<a name="l02506"></a>02506 
<a name="l02507"></a>02507         <span class="keywordflow">for</span> (cfra = sfra; cfra &lt;= efra; cfra++) {
<a name="l02508"></a>02508             <span class="keywordtype">float</span> median[2];
<a name="l02509"></a>02509             <span class="keywordtype">float</span> loc[2], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, tmp_scale;
<a name="l02510"></a>02510             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02511"></a>02511             <span class="keywordtype">float</span> mat[4][4];
<a name="l02512"></a>02512             <span class="keywordtype">float</span> points[4][2] = {{0.0f, 0.0f}, {0.0f, height}, {width, height}, {width, 0.0f}};
<a name="l02513"></a>02513             <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l02514"></a>02514 
<a name="l02515"></a>02515             <a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">stabilization_median_point</a>(tracking, cfra, median);
<a name="l02516"></a>02516 
<a name="l02517"></a>02517             <a class="code" href="../../de/ddb/tracking_8c.html#a8b7460f930bd7a591b73a3dcaab73e18">calculate_stabdata</a>(tracking, cfra, width, height, firstmedian, median, loc, &amp;tmp_scale, &amp;angle);
<a name="l02518"></a>02518 
<a name="l02519"></a>02519             <a class="code" href="../../da/d72/BKE__tracking_8h.html#a14d773199549ab436912e58abdbb7d0d">BKE_tracking_stabdata_to_mat4</a>(width, height, aspect, loc, 1.0f, angle, mat);
<a name="l02520"></a>02520 
<a name="l02521"></a>02521             si = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(angle);
<a name="l02522"></a>02522             co = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(angle);
<a name="l02523"></a>02523 
<a name="l02524"></a>02524             <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l02525"></a>02525                 <span class="keywordtype">int</span> j;
<a name="l02526"></a>02526                 <span class="keywordtype">float</span> a[3] = {0.0f, 0.0f, 0.0f}, b[3]= {0.0f, 0.0f, 0.0f};
<a name="l02527"></a>02527 
<a name="l02528"></a>02528                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(a, points[i]);
<a name="l02529"></a>02529                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(b, points[(i+1)%4]);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, a);
<a name="l02532"></a>02532                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, b);
<a name="l02533"></a>02533 
<a name="l02534"></a>02534                 <span class="keywordflow">for</span> (j = 0; j &lt; 4; j++) {
<a name="l02535"></a>02535                     <span class="keywordtype">float</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>[3] = {points[j][0], points[j][1], 0.0f};
<a name="l02536"></a>02536                     <span class="keywordtype">float</span> v1[3], v2[3];
<a name="l02537"></a>02537 
<a name="l02538"></a>02538                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1, b, a);
<a name="l02539"></a>02539                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v2, point, a);
<a name="l02540"></a>02540 
<a name="l02541"></a>02541                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a71ede3b1f299a0f5296b21f10b63a246">cross_v2v2</a>(v1, v2) &gt;= 0.0f) {
<a name="l02542"></a>02542                         <span class="keyword">const</span> <span class="keywordtype">float</span> rotDx[4][2] = {{1.0f, 0.0f}, {0.0f, -1.0f}, {-1.0f, 0.0f}, {0.0f, 1.0f}};
<a name="l02543"></a>02543                         <span class="keyword">const</span> <span class="keywordtype">float</span> rotDy[4][2] = {{0.0f, 1.0f}, {1.0f, 0.0f}, {0.0f, -1.0f}, {-1.0f, 0.0f}};
<a name="l02544"></a>02544 
<a name="l02545"></a>02545                         <span class="keywordtype">float</span> dx = loc[0] * rotDx[j][0] + loc[1] * rotDx[j][1],
<a name="l02546"></a>02546                               dy = loc[0] * rotDy[j][0] + loc[1] * rotDy[j][1];
<a name="l02547"></a>02547 
<a name="l02548"></a>02548                         <span class="keywordtype">float</span> w, h, E, <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ae42219072d798876e6b08e6b78614ff6">H</a>, <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>, J, <a class="code" href="../../d8/d9e/EventToBuf_8c.html#a44274d284f44463aaf509177c78913ed">K</a>, S;
<a name="l02549"></a>02549 
<a name="l02550"></a>02550                         <span class="keywordflow">if</span> (j % 2) {
<a name="l02551"></a>02551                             w = (float)height / 2.0f;
<a name="l02552"></a>02552                             h = (float)width / 2.0f;
<a name="l02553"></a>02553                         }
<a name="l02554"></a>02554                         <span class="keywordflow">else</span> {
<a name="l02555"></a>02555                             w = (float)width / 2.0f;
<a name="l02556"></a>02556                             h = (float)height / 2.0f;
<a name="l02557"></a>02557                         }
<a name="l02558"></a>02558 
<a name="l02559"></a>02559                         E = -w*co + h*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02560"></a>02560                         F = -h*co - w*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02561"></a>02561 
<a name="l02562"></a>02562                         <span class="keywordflow">if</span> ((i % 2) == (j % 2)) {
<a name="l02563"></a>02563                             G = -w*co - h*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02564"></a>02564                             H = h*co - w*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02565"></a>02565                         }
<a name="l02566"></a>02566                         <span class="keywordflow">else</span> {
<a name="l02567"></a>02567                             G = w*co + h*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02568"></a>02568                             H = -h*co + w*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02569"></a>02569                         }
<a name="l02570"></a>02570 
<a name="l02571"></a>02571                         I = F - H;
<a name="l02572"></a>02572                         J = G - E;
<a name="l02573"></a>02573                         K = G*F - E*H;
<a name="l02574"></a>02574 
<a name="l02575"></a>02575                         S = (-w*I - h*J) / (dx*I + dy*J + K);
<a name="l02576"></a>02576 
<a name="l02577"></a>02577                         scale = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(scale, S);
<a name="l02578"></a>02578                     }
<a name="l02579"></a>02579                 }
<a name="l02580"></a>02580             }
<a name="l02581"></a>02581         }
<a name="l02582"></a>02582 
<a name="l02583"></a>02583         stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> = scale;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585         <span class="keywordflow">if</span> (stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a34b69461632b44a5e4c2b191382a485a">maxscale</a>&gt;0.0f)
<a name="l02586"></a>02586             stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a>, stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a34b69461632b44a5e4c2b191382a485a">maxscale</a>);
<a name="l02587"></a>02587     }
<a name="l02588"></a>02588     <span class="keywordflow">else</span> {
<a name="l02589"></a>02589         stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> = 1.0f;
<a name="l02590"></a>02590     }
<a name="l02591"></a>02591 
<a name="l02592"></a>02592     stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#af45dd7955027c6f892e7f1ad15ffdc9a">ok</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02593"></a>02593 
<a name="l02594"></a>02594     <span class="keywordflow">return</span> stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a>;
<a name="l02595"></a>02595 }
<a name="l02596"></a>02596 
<a name="l02597"></a><a class="code" href="../../de/ddb/tracking_8c.html#af014fe4dfbb87f9138f4aaa792e15a4a">02597</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* <a class="code" href="../../de/ddb/tracking_8c.html#af014fe4dfbb87f9138f4aaa792e15a4a">stabilize_alloc_ibuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *cacheibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *srcibuf, <span class="keywordtype">int</span> fill)
<a name="l02598"></a>02598 {
<a name="l02599"></a>02599     <span class="keywordtype">int</span> flags;
<a name="l02600"></a>02600 
<a name="l02601"></a>02601     <span class="keywordflow">if</span> (cacheibuf &amp;&amp; (cacheibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> != srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> || cacheibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> != srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>)) {
<a name="l02602"></a>02602         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(cacheibuf);
<a name="l02603"></a>02603         cacheibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02604"></a>02604     }
<a name="l02605"></a>02605 
<a name="l02606"></a>02606     flags = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>;
<a name="l02607"></a>02607 
<a name="l02608"></a>02608     <span class="keywordflow">if</span> (srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l02609"></a>02609         flags |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611     <span class="keywordflow">if</span> (cacheibuf) {
<a name="l02612"></a>02612         <span class="keywordflow">if</span> (fill) {
<a name="l02613"></a>02613             <span class="keywordtype">float</span> col[4] = {0.0f, 0.0f, 0.0f, 0.0f};
<a name="l02614"></a>02614 
<a name="l02615"></a>02615             <a class="code" href="../../dd/d38/iff_8h.html#ae67a3a18923ca91dc1b9835bc35df35c">IMB_rectfill</a>(cacheibuf, col);
<a name="l02616"></a>02616         }
<a name="l02617"></a>02617     }
<a name="l02618"></a>02618     <span class="keywordflow">else</span> {
<a name="l02619"></a>02619         cacheibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>, flags);
<a name="l02620"></a>02620         cacheibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> = srcibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a>;
<a name="l02621"></a>02621     }
<a name="l02622"></a>02622 
<a name="l02623"></a>02623     <span class="keywordflow">return</span> cacheibuf;
<a name="l02624"></a>02624 }
<a name="l02625"></a>02625 
<a name="l02626"></a><a class="code" href="../../de/ddb/tracking_8c.html#ade2d657759e94fcbdd22589c8f5731d8">02626</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a5f65c729dff75494592668c3d3de3476">BKE_tracking_stabilization_data</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> framenr, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> loc[2], <span class="keywordtype">float</span> *scale, <span class="keywordtype">float</span> *<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>)
<a name="l02627"></a>02627 {
<a name="l02628"></a>02628     <span class="keywordtype">float</span> firstmedian[2], median[2];
<a name="l02629"></a>02629     <a class="code" href="../../db/ddf/structMovieTrackingStabilization.html">MovieTrackingStabilization</a> *stab = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>;
<a name="l02630"></a>02630 
<a name="l02631"></a>02631     <span class="keywordflow">if</span> ((stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a1a1e9450813ad36460c7abf720ce45df">TRACKING_2D_STABILIZATION</a>) == 0) {
<a name="l02632"></a>02632         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(loc);
<a name="l02633"></a>02633         *scale= 1.0f;
<a name="l02634"></a>02634         *angle= 0.0f;
<a name="l02635"></a>02635 
<a name="l02636"></a>02636         <span class="keywordflow">return</span>;
<a name="l02637"></a>02637     }
<a name="l02638"></a>02638 
<a name="l02639"></a>02639     <span class="keywordflow">if</span> (<a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">stabilization_median_point</a>(tracking, 1, firstmedian)) {
<a name="l02640"></a>02640         <a class="code" href="../../de/ddb/tracking_8c.html#a16a6bd3f62c9d0717463624731a29984">stabilization_median_point</a>(tracking, framenr, median);
<a name="l02641"></a>02641 
<a name="l02642"></a>02642         <span class="keywordflow">if</span> ((stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#af3d2b7daf9e836ae9ffb7480c98d1623">TRACKING_AUTOSCALE</a>) == 0)
<a name="l02643"></a>02643             stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a187b771b98c550f82509a4763a2f0820">scale</a> = 1.0f;
<a name="l02644"></a>02644 
<a name="l02645"></a>02645         <span class="keywordflow">if</span> (!stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#af45dd7955027c6f892e7f1ad15ffdc9a">ok</a>) {
<a name="l02646"></a>02646             <span class="keywordflow">if</span> (stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#af3d2b7daf9e836ae9ffb7480c98d1623">TRACKING_AUTOSCALE</a>)
<a name="l02647"></a>02647                 <a class="code" href="../../de/ddb/tracking_8c.html#ad934bf1bc956a10c7b9a066fdbd056c4">stabilization_auto_scale_factor</a>(tracking, width, height);
<a name="l02648"></a>02648 
<a name="l02649"></a>02649             <a class="code" href="../../de/ddb/tracking_8c.html#a8b7460f930bd7a591b73a3dcaab73e18">calculate_stabdata</a>(tracking, framenr, width, height, firstmedian, median, loc, scale, angle);
<a name="l02650"></a>02650 
<a name="l02651"></a>02651             stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#af45dd7955027c6f892e7f1ad15ffdc9a">ok</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02652"></a>02652         }
<a name="l02653"></a>02653         <span class="keywordflow">else</span> {
<a name="l02654"></a>02654             <a class="code" href="../../de/ddb/tracking_8c.html#a8b7460f930bd7a591b73a3dcaab73e18">calculate_stabdata</a>(tracking, framenr, width, height, firstmedian, median, loc, scale, angle);
<a name="l02655"></a>02655         }
<a name="l02656"></a>02656     }
<a name="l02657"></a>02657     <span class="keywordflow">else</span> {
<a name="l02658"></a>02658         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(loc);
<a name="l02659"></a>02659         *scale = 1.0f;
<a name="l02660"></a>02660         *angle = 0.0f;
<a name="l02661"></a>02661     }
<a name="l02662"></a>02662 }
<a name="l02663"></a>02663 
<a name="l02664"></a><a class="code" href="../../de/ddb/tracking_8c.html#a058f228d98a8b70ab23356d571276b59">02664</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a97aa73d806f6dc53148b7a4429479c33">BKE_tracking_stabilize</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> framenr, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> loc[2], <span class="keywordtype">float</span> *scale, <span class="keywordtype">float</span> *<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>)
<a name="l02665"></a>02665 {
<a name="l02666"></a>02666     <span class="keywordtype">float</span> tloc[2], tscale, tangle;
<a name="l02667"></a>02667     <a class="code" href="../../db/ddf/structMovieTrackingStabilization.html">MovieTrackingStabilization</a> *stab = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>;
<a name="l02668"></a>02668     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf;
<a name="l02669"></a>02669     <span class="keywordtype">float</span> width = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, height = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l02670"></a>02670     <span class="keywordtype">float</span> aspect = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02671"></a>02671 
<a name="l02672"></a>02672     <span class="keywordflow">if</span> (loc)
<a name="l02673"></a>02673         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(tloc, loc);
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     <span class="keywordflow">if</span> (scale)
<a name="l02676"></a>02676         tscale = *scale;
<a name="l02677"></a>02677 
<a name="l02678"></a>02678     <span class="keywordflow">if</span> ((stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#a9a717186c7355f33c0a20922fb0a6b4d">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a1a1e9450813ad36460c7abf720ce45df">TRACKING_2D_STABILIZATION</a>) == 0) {
<a name="l02679"></a>02679         <span class="keywordflow">if</span> (loc)
<a name="l02680"></a>02680             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(loc);
<a name="l02681"></a>02681 
<a name="l02682"></a>02682         <span class="keywordflow">if</span> (scale)
<a name="l02683"></a>02683             *scale = 1.0f;
<a name="l02684"></a>02684 
<a name="l02685"></a>02685         <span class="keywordflow">return</span> ibuf;
<a name="l02686"></a>02686     }
<a name="l02687"></a>02687 
<a name="l02688"></a>02688     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a5f65c729dff75494592668c3d3de3476">BKE_tracking_stabilization_data</a>(tracking, framenr, width, height, tloc, &amp;tscale, &amp;tangle);
<a name="l02689"></a>02689 
<a name="l02690"></a>02690     tmpibuf = <a class="code" href="../../de/ddb/tracking_8c.html#af014fe4dfbb87f9138f4aaa792e15a4a">stabilize_alloc_ibuf</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ibuf, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02691"></a>02691 
<a name="l02692"></a>02692     <span class="comment">/* scale would be handled by matrix transformation when angle is non-zero */</span>
<a name="l02693"></a>02693     <span class="keywordflow">if</span> (tscale != 1.0f &amp;&amp; tangle == 0.0f) {
<a name="l02694"></a>02694         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *scaleibuf;
<a name="l02695"></a>02695 
<a name="l02696"></a>02696         <a class="code" href="../../de/ddb/tracking_8c.html#ad934bf1bc956a10c7b9a066fdbd056c4">stabilization_auto_scale_factor</a>(tracking, width, height);
<a name="l02697"></a>02697 
<a name="l02698"></a>02698         scaleibuf = <a class="code" href="../../de/ddb/tracking_8c.html#af014fe4dfbb87f9138f4aaa792e15a4a">stabilize_alloc_ibuf</a>(stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#aa31124cc2c83761d5a93ac50679ae9f3">scaleibuf</a>, ibuf, 0);
<a name="l02699"></a>02699         stab-&gt;<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#aa31124cc2c83761d5a93ac50679ae9f3">scaleibuf</a> = scaleibuf;
<a name="l02700"></a>02700 
<a name="l02701"></a>02701         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(scaleibuf, ibuf, 0, 0, 0, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l02702"></a>02702         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a861e356514b5fe806f5e29d2758fdc4a">IMB_scalefastImBuf</a>(scaleibuf, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*tscale, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*tscale);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704         ibuf = scaleibuf;
<a name="l02705"></a>02705     }
<a name="l02706"></a>02706 
<a name="l02707"></a>02707     <span class="keywordflow">if</span> (tangle == 0.0f) {
<a name="l02708"></a>02708         <span class="comment">/* if angle is zero, then it&#39;s much faster to use rect copy</span>
<a name="l02709"></a>02709 <span class="comment">         * but could be issues with subpixel precisions */</span>
<a name="l02710"></a>02710         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tmpibuf, ibuf,
<a name="l02711"></a>02711                     tloc[0] - (tscale - 1.0f) * width / 2.0f,
<a name="l02712"></a>02712                     tloc[1] - (tscale - 1.0f) * height / 2.0f,
<a name="l02713"></a>02713                     0, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l02714"></a>02714     }
<a name="l02715"></a>02715     <span class="keywordflow">else</span> {
<a name="l02716"></a>02716         <span class="keywordtype">float</span> mat[4][4];
<a name="l02717"></a>02717         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a> = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ab5ac3e5dd2ce804822d65f691f6f114a">stabilization</a>.<a class="code" href="../../db/ddf/structMovieTrackingStabilization.html#aa31453fcd2503a7d435b73136c432bc2">filter</a>;
<a name="l02718"></a>02718         void (*interpolation) (<span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>*, <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>*, float, float, int, int) = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02719"></a>02719 
<a name="l02720"></a>02720         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a14d773199549ab436912e58abdbb7d0d">BKE_tracking_stabdata_to_mat4</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, aspect, tloc, tscale, tangle, mat);
<a name="l02721"></a>02721         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a64a4f057663e6d9174264739ac12fd34">invert_m4</a>(mat);
<a name="l02722"></a>02722 
<a name="l02723"></a>02723         <span class="keywordflow">if</span> (filter == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a179ad314e8887a988ab5301f95a48187">TRACKING_FILTER_NEAREAST</a>)
<a name="l02724"></a>02724             interpolation = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2d63bfded58cd14eb63c0bef322c6a9a">neareast_interpolation</a>;
<a name="l02725"></a>02725         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filter == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a275de58a6d19186e7bb64b241cce72b5">TRACKING_FILTER_BILINEAR</a>)
<a name="l02726"></a>02726             interpolation = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a5810b3b46ac2081dc39d315026d0cad5">bilinear_interpolation</a>;
<a name="l02727"></a>02727         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filter == <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#ab9ee8d45ab81131204fb5cdb4edb8cad">TRACKING_FILTER_BICUBIC</a>)
<a name="l02728"></a>02728             interpolation = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0ca4482c909990236e9f98aa3b8c5256">bicubic_interpolation</a>;
<a name="l02729"></a>02729         <span class="keywordflow">else</span>
<a name="l02730"></a>02730             <span class="comment">/* fallback to default interpolation method */</span>
<a name="l02731"></a>02731             interpolation = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2d63bfded58cd14eb63c0bef322c6a9a">neareast_interpolation</a>;
<a name="l02732"></a>02732 
<a name="l02733"></a>02733         <span class="keywordflow">for</span> (j = 0; j &lt; tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; j++) {
<a name="l02734"></a>02734             <span class="keywordflow">for</span> (i = 0; i &lt; tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;i++) {
<a name="l02735"></a>02735                 <span class="keywordtype">float</span> vec[3] = {<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, 0};
<a name="l02736"></a>02736 
<a name="l02737"></a>02737                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(vec, mat, vec);
<a name="l02738"></a>02738 
<a name="l02739"></a>02739                 interpolation(ibuf, tmpibuf, vec[0], vec[1], i, j);
<a name="l02740"></a>02740             }
<a name="l02741"></a>02741         }
<a name="l02742"></a>02742     }
<a name="l02743"></a>02743 
<a name="l02744"></a>02744     tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l02745"></a>02745 
<a name="l02746"></a>02746     <span class="keywordflow">if</span> (tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l02747"></a>02747         tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l02748"></a>02748 
<a name="l02749"></a>02749     <span class="keywordflow">if</span> (loc)
<a name="l02750"></a>02750         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(loc, tloc);
<a name="l02751"></a>02751 
<a name="l02752"></a>02752     <span class="keywordflow">if</span> (scale)
<a name="l02753"></a>02753         *scale= tscale;
<a name="l02754"></a>02754 
<a name="l02755"></a>02755     <span class="keywordflow">if</span> (angle)
<a name="l02756"></a>02756         *angle= tangle;
<a name="l02757"></a>02757 
<a name="l02758"></a>02758     <span class="keywordflow">return</span> tmpibuf;
<a name="l02759"></a>02759 }
<a name="l02760"></a>02760 
<a name="l02761"></a><a class="code" href="../../de/ddb/tracking_8c.html#a14d773199549ab436912e58abdbb7d0d">02761</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a14d773199549ab436912e58abdbb7d0d">BKE_tracking_stabdata_to_mat4</a>(<span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> aspect, <span class="keywordtype">float</span> loc[2], <span class="keywordtype">float</span> scale, <span class="keywordtype">float</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, <span class="keywordtype">float</span> mat[4][4])
<a name="l02762"></a>02762 {
<a name="l02763"></a>02763     <span class="keywordtype">float</span> lmat[4][4], rmat[4][4], smat[4][4], cmat[4][4], icmat[4][4], amat[4][4], iamat[4][4];
<a name="l02764"></a>02764     <span class="keywordtype">float</span> svec[3]= {scale, scale, scale};
<a name="l02765"></a>02765 
<a name="l02766"></a>02766     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(rmat);
<a name="l02767"></a>02767     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(lmat);
<a name="l02768"></a>02768     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(smat);
<a name="l02769"></a>02769     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(cmat);
<a name="l02770"></a>02770     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(amat);
<a name="l02771"></a>02771 
<a name="l02772"></a>02772     <span class="comment">/* aspect ratio correction matrix */</span>
<a name="l02773"></a>02773     amat[0][0] = 1.0f / aspect;
<a name="l02774"></a>02774     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(iamat, amat);
<a name="l02775"></a>02775 
<a name="l02776"></a>02776     <span class="comment">/* image center as rotation center */</span>
<a name="l02777"></a>02777     cmat[3][0] = (float)width / 2.0f;
<a name="l02778"></a>02778     cmat[3][1] = (float)height / 2.0f;
<a name="l02779"></a>02779     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(icmat, cmat);
<a name="l02780"></a>02780 
<a name="l02781"></a>02781     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8a7511e7f02ac7530280787b7dd5597b">size_to_mat4</a>(smat, svec);       <span class="comment">/* scale matrix */</span>
<a name="l02782"></a>02782     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a7f222b1bc110fa45434894fc9a919dec">add_v2_v2</a>(lmat[3], loc);        <span class="comment">/* translation matrix */</span>
<a name="l02783"></a>02783     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#afcc068c37902397b59b109c4ce769925">rotate_m4</a>(rmat, <span class="charliteral">&#39;Z&#39;</span>, angle);    <span class="comment">/* rotation matrix */</span>
<a name="l02784"></a>02784 
<a name="l02785"></a>02785     <span class="comment">/* compose transformation matrix */</span>
<a name="l02786"></a>02786     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(mat, lmat, cmat, amat, rmat, iamat, smat, icmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02787"></a>02787 }
<a name="l02788"></a>02788 
<a name="l02789"></a><a class="code" href="../../de/ddb/tracking_8c.html#a9168daee8e657469f15d7ce95e16117b">02789</a> <a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#ae0196f8885484e8581930e4dfaae34ca">BKE_tracking_distortion_create</a>(<span class="keywordtype">void</span>)
<a name="l02790"></a>02790 {
<a name="l02791"></a>02791     <a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *distortion;
<a name="l02792"></a>02792 
<a name="l02793"></a>02793     distortion = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a>), <span class="stringliteral">&quot;BKE_tracking_distortion_create&quot;</span>);
<a name="l02794"></a>02794 
<a name="l02795"></a>02795     <span class="keywordflow">return</span> distortion;
<a name="l02796"></a>02796 }
<a name="l02797"></a>02797 
<a name="l02798"></a><a class="code" href="../../de/ddb/tracking_8c.html#ad3fbd1d6899a2d6458e65b4668a8516e">02798</a> <a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a398224a9861ff5ad8eeae79a17e400ac">BKE_tracking_distortion_copy</a>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *distortion)
<a name="l02799"></a>02799 {
<a name="l02800"></a>02800     <a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *new_distortion;
<a name="l02801"></a>02801 
<a name="l02802"></a>02802     new_distortion = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a>), <span class="stringliteral">&quot;BKE_tracking_distortion_create&quot;</span>);
<a name="l02803"></a>02803 
<a name="l02804"></a>02804 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02805"></a>02805 <span class="preprocessor"></span>    new_distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a> = libmv_CameraIntrinsicsCopy(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>);
<a name="l02806"></a>02806 <span class="preprocessor">#else</span>
<a name="l02807"></a>02807 <span class="preprocessor"></span>    (void) distortion;
<a name="l02808"></a>02808 <span class="preprocessor">#endif</span>
<a name="l02809"></a>02809 <span class="preprocessor"></span>
<a name="l02810"></a>02810     <span class="keywordflow">return</span> new_distortion;
<a name="l02811"></a>02811 }
<a name="l02812"></a>02812 
<a name="l02813"></a><a class="code" href="../../de/ddb/tracking_8c.html#ac727bc3b75622ff874ad0d48344a22d3">02813</a> <span class="keywordtype">void</span> <a class="code" href="../../de/ddb/tracking_8c.html#ac727bc3b75622ff874ad0d48344a22d3">BKE_tracking_distortion_update</a>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *distortion, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l02814"></a>02814 {
<a name="l02815"></a>02815     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l02816"></a>02816     <span class="keywordtype">float</span> aspy = 1.0f / tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>.<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aff807f14ebd4dc9c7855d996745ea2eb">pixel_aspect</a>;
<a name="l02817"></a>02817 
<a name="l02818"></a>02818 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02819"></a>02819 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>) {
<a name="l02820"></a>02820         distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a> = libmv_CameraIntrinsicsNew(camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>,
<a name="l02821"></a>02821                 camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0], camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy,
<a name="l02822"></a>02822                 camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a0a86cfdb028a7b2303b216546f8c6fd8">k3</a>, width, height * aspy);
<a name="l02823"></a>02823     }
<a name="l02824"></a>02824     <span class="keywordflow">else</span> {
<a name="l02825"></a>02825         libmv_CameraIntrinsicsUpdate(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a7dedc9ab5a26cd7892460eea17b8fb8f">focal</a>,
<a name="l02826"></a>02826                 camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[0], camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a1ca8a041769c4d8eb6d2931470322941">principal</a>[1] * aspy,
<a name="l02827"></a>02827                 camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a5548d214fc9a37738dff5cba61a2493c">k1</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#accb1bea1b9a103756ba6f91e5514eeb2">k2</a>, camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#a0a86cfdb028a7b2303b216546f8c6fd8">k3</a>, width, height * aspy);
<a name="l02828"></a>02828     }
<a name="l02829"></a>02829 <span class="preprocessor">#else</span>
<a name="l02830"></a>02830 <span class="preprocessor"></span>    (void) distortion;
<a name="l02831"></a>02831     (void) width;
<a name="l02832"></a>02832     (void) height;
<a name="l02833"></a>02833     (void) camera;
<a name="l02834"></a>02834     (void) aspy;
<a name="l02835"></a>02835 <span class="preprocessor">#endif</span>
<a name="l02836"></a>02836 <span class="preprocessor"></span>}
<a name="l02837"></a>02837 
<a name="l02838"></a><a class="code" href="../../de/ddb/tracking_8c.html#a1be817cd478943d5692962f0afbf3de1">02838</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a8c1d43b5c590e6bda3d7a025a18da357">BKE_tracking_distortion_exec</a>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *distortion, <a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking,
<a name="l02839"></a>02839                                     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> overscan, <span class="keywordtype">int</span> undistort)
<a name="l02840"></a>02840 {
<a name="l02841"></a>02841     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *resibuf;
<a name="l02842"></a>02842 
<a name="l02843"></a>02843     <a class="code" href="../../de/ddb/tracking_8c.html#ac727bc3b75622ff874ad0d48344a22d3">BKE_tracking_distortion_update</a>(distortion, tracking, width, height);
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     resibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a094bab2aa339f34922893e1d6d617c28">IMB_dupImBuf</a>(ibuf);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l02848"></a>02848 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02849"></a>02849 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (undistort) {
<a name="l02850"></a>02850             libmv_CameraIntrinsicsUndistortFloat(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>,
<a name="l02851"></a>02851                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>, resibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>,
<a name="l02852"></a>02852                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, overscan, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>);
<a name="l02853"></a>02853         }
<a name="l02854"></a>02854         <span class="keywordflow">else</span> {
<a name="l02855"></a>02855             libmv_CameraIntrinsicsDistortFloat(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>,
<a name="l02856"></a>02856                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>, resibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>,
<a name="l02857"></a>02857                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, overscan, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>);
<a name="l02858"></a>02858         }
<a name="l02859"></a>02859 <span class="preprocessor">#endif</span>
<a name="l02860"></a>02860 <span class="preprocessor"></span>
<a name="l02861"></a>02861         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l02862"></a>02862     }
<a name="l02863"></a>02863     <span class="keywordflow">else</span> {
<a name="l02864"></a>02864 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02865"></a>02865 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (undistort) {
<a name="l02866"></a>02866                 libmv_CameraIntrinsicsUndistortByte(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>,
<a name="l02867"></a>02867                             (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)resibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>,
<a name="l02868"></a>02868                             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, overscan, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>);
<a name="l02869"></a>02869         }
<a name="l02870"></a>02870         <span class="keywordflow">else</span> {
<a name="l02871"></a>02871             libmv_CameraIntrinsicsDistortByte(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>,
<a name="l02872"></a>02872                         (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)resibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>,
<a name="l02873"></a>02873                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, overscan, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>);
<a name="l02874"></a>02874         }
<a name="l02875"></a>02875 <span class="preprocessor">#endif</span>
<a name="l02876"></a>02876 <span class="preprocessor"></span>    }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878 <span class="preprocessor">#ifndef WITH_LIBMV</span>
<a name="l02879"></a>02879 <span class="preprocessor"></span>    (void) overscan;
<a name="l02880"></a>02880     (void) undistort;
<a name="l02881"></a>02881 <span class="preprocessor">#endif</span>
<a name="l02882"></a>02882 <span class="preprocessor"></span>
<a name="l02883"></a>02883     <span class="keywordflow">return</span> resibuf;
<a name="l02884"></a>02884 }
<a name="l02885"></a>02885 
<a name="l02886"></a><a class="code" href="../../de/ddb/tracking_8c.html#a4f9d2c29fb296d783102b2523d87d2c3">02886</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#aa7c948cbe0d344d925709216b6fb8132">BKE_tracking_distortion_destroy</a>(<a class="code" href="../../d6/da4/structMovieDistortion.html">MovieDistortion</a> *distortion)
<a name="l02887"></a>02887 {
<a name="l02888"></a>02888 <span class="preprocessor">#ifdef WITH_LIBMV</span>
<a name="l02889"></a>02889 <span class="preprocessor"></span>    libmv_CameraIntrinsicsDestroy(distortion-&gt;<a class="code" href="../../d6/da4/structMovieDistortion.html#a51355159a1673f433711371aabfa9fc7">intrinsics</a>);
<a name="l02890"></a>02890 <span class="preprocessor">#endif</span>
<a name="l02891"></a>02891 <span class="preprocessor"></span>
<a name="l02892"></a>02892     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(distortion);
<a name="l02893"></a>02893 }
<a name="l02894"></a>02894 
<a name="l02895"></a><a class="code" href="../../de/ddb/tracking_8c.html#a42dc79cbefaeb8624ffedb44eb25bc79">02895</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#abd423fae3a6341d57339ceefe9256bc3">BKE_tracking_undistort</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> overscan)
<a name="l02896"></a>02896 {
<a name="l02897"></a>02897     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l02898"></a>02898 
<a name="l02899"></a>02899     <span class="keywordflow">if</span> (camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02900"></a>02900         camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ae0196f8885484e8581930e4dfaae34ca">BKE_tracking_distortion_create</a>();
<a name="l02901"></a>02901 
<a name="l02902"></a>02902     <span class="keywordflow">return</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a8c1d43b5c590e6bda3d7a025a18da357">BKE_tracking_distortion_exec</a>(camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a>, tracking, ibuf, width, height, overscan, 1);
<a name="l02903"></a>02903 }
<a name="l02904"></a>02904 
<a name="l02905"></a><a class="code" href="../../de/ddb/tracking_8c.html#acb5a1944b509ee5f547bbd555af590ee">02905</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#aa6912956cd876c42265525433b9e24b1">BKE_tracking_distort</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">float</span> overscan)
<a name="l02906"></a>02906 {
<a name="l02907"></a>02907     <a class="code" href="../../df/d7b/structMovieTrackingCamera.html">MovieTrackingCamera</a> *camera = &amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#ade9814b7982abc95b2e2d63798f7487e">camera</a>;
<a name="l02908"></a>02908 
<a name="l02909"></a>02909     <span class="keywordflow">if</span> (camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02910"></a>02910         camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a> = <a class="code" href="../../da/d72/BKE__tracking_8h.html#ae0196f8885484e8581930e4dfaae34ca">BKE_tracking_distortion_create</a>();
<a name="l02911"></a>02911 
<a name="l02912"></a>02912     <span class="keywordflow">return</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a8c1d43b5c590e6bda3d7a025a18da357">BKE_tracking_distortion_exec</a>(camera-&gt;<a class="code" href="../../df/d7b/structMovieTrackingCamera.html#aa298f48dc58796d47294d1def37e1571">intrinsics</a>, tracking, ibuf, width, height, overscan, 0);
<a name="l02913"></a>02913 }
<a name="l02914"></a>02914 
<a name="l02915"></a>02915 <span class="comment">/* area - which part of marker should be selected. see TRACK_AREA_* constants */</span>
<a name="l02916"></a><a class="code" href="../../de/ddb/tracking_8c.html#a7169569a0fdc26a65d19b5d7315decd9">02916</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a4350aed8f0c692b27bb96ccb188f63ca">BKE_tracking_select_track</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *tracksbase, <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> area, <span class="keywordtype">int</span> extend)
<a name="l02917"></a>02917 {
<a name="l02918"></a>02918     <span class="keywordflow">if</span> (extend) {
<a name="l02919"></a>02919         <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(track, area, <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>, 0);
<a name="l02920"></a>02920     }
<a name="l02921"></a>02921     <span class="keywordflow">else</span> {
<a name="l02922"></a>02922         <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *cur = tracksbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02923"></a>02923 
<a name="l02924"></a>02924         <span class="keywordflow">while</span> (cur) {
<a name="l02925"></a>02925             <span class="keywordflow">if</span> ((cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#a71bf96554b319d35bd7c5570c261ba9a">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#aa1baad05f9de7e624727dcdab9f9d64e">TRACK_HIDDEN</a>) == 0) {
<a name="l02926"></a>02926                 <span class="keywordflow">if</span> (cur == track) {
<a name="l02927"></a>02927                     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(cur, <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1988daf49bb214d82695ce278b7170f9">TRACK_AREA_ALL</a>, <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>, 1);
<a name="l02928"></a>02928                     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(cur, area, <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>, 0);
<a name="l02929"></a>02929                 }
<a name="l02930"></a>02930                 <span class="keywordflow">else</span> {
<a name="l02931"></a>02931                     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(cur, <a class="code" href="../../da/d72/BKE__tracking_8h.html#a1988daf49bb214d82695ce278b7170f9">TRACK_AREA_ALL</a>, <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>, 1);
<a name="l02932"></a>02932                 }
<a name="l02933"></a>02933             }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935             cur = cur-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02936"></a>02936         }
<a name="l02937"></a>02937     }
<a name="l02938"></a>02938 }
<a name="l02939"></a>02939 
<a name="l02940"></a><a class="code" href="../../de/ddb/tracking_8c.html#ac839321b09876f6c8e155aa1f18b4904">02940</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6709806df0f14905ec16ec9a78f8ab0e">BKE_tracking_deselect_track</a>(<a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track, <span class="keywordtype">int</span> area)
<a name="l02941"></a>02941 {
<a name="l02942"></a>02942     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a6a462910dc23280e200df8002b917e66">BKE_tracking_track_flag</a>(track, area, <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>, 1);
<a name="l02943"></a>02943 }
<a name="l02944"></a>02944 
<a name="l02945"></a><a class="code" href="../../de/ddb/tracking_8c.html#a416afd45727e8f602addeb6f2fc2670b">02945</a> <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#aaa24525c80d4ace1d53606d850992e76">BKE_tracking_new_object</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>)
<a name="l02946"></a>02946 {
<a name="l02947"></a>02947     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a>), <span class="stringliteral">&quot;tracking object&quot;</span>);
<a name="l02948"></a>02948 
<a name="l02949"></a>02949     <span class="keywordflow">if</span> (tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#acf2e8abff0a11324f1465c854322504b">tot_object</a> == 0) {
<a name="l02950"></a>02950         <span class="comment">/* first object is always camera */</span>
<a name="l02951"></a>02951         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>, <span class="stringliteral">&quot;Camera&quot;</span>, <span class="keyword">sizeof</span>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>));
<a name="l02952"></a>02952 
<a name="l02953"></a>02953         <span class="keywordtype">object</span>-&gt;flag |= <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>;
<a name="l02954"></a>02954     }
<a name="l02955"></a>02955     <span class="keywordflow">else</span> {
<a name="l02956"></a>02956         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>, name, <span class="keyword">sizeof</span>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>));
<a name="l02957"></a>02957     }
<a name="l02958"></a>02958 
<a name="l02959"></a>02959     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>, <span class="keywordtype">object</span>);
<a name="l02960"></a>02960 
<a name="l02961"></a>02961     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#acf2e8abff0a11324f1465c854322504b">tot_object</a>++;
<a name="l02962"></a>02962     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a4053f7b709ef765fc6d449a0b742ff14">objectnr</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>) - 1;
<a name="l02963"></a>02963 
<a name="l02964"></a>02964     <span class="keywordtype">object</span>-&gt;scale = 1.0f;
<a name="l02965"></a>02965 
<a name="l02966"></a>02966     <a class="code" href="../../da/d72/BKE__tracking_8h.html#a706934a709c416a5fc59194ed29ee37a">BKE_tracking_object_unique_name</a>(tracking, <span class="keywordtype">object</span>);
<a name="l02967"></a>02967 
<a name="l02968"></a>02968     <span class="keywordflow">return</span> object;
<a name="l02969"></a>02969 }
<a name="l02970"></a>02970 
<a name="l02971"></a><a class="code" href="../../de/ddb/tracking_8c.html#a0ac9e70ef525814e11d806c1b95f540c">02971</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a95e7feb2a0d40b1fcf26c1560086df94">BKE_tracking_remove_object</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l02972"></a>02972 {
<a name="l02973"></a>02973     <a class="code" href="../../da/d5f/structMovieTrackingTrack.html">MovieTrackingTrack</a> *track;
<a name="l02974"></a>02974     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>, <span class="keywordtype">object</span>);
<a name="l02975"></a>02975 
<a name="l02976"></a>02976     <span class="keywordflow">if</span> (index&lt;0)
<a name="l02977"></a>02977         <span class="keywordflow">return</span>;
<a name="l02978"></a>02978 
<a name="l02979"></a>02979     <span class="keywordflow">if</span> (object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#ac43786f911f695796bba9afbdc976f2c">flag</a> &amp; <a class="code" href="../../d3/dd4/DNA__tracking__types_8h.html#a06e7a47b7bac422584f1ce1607f6268f">TRACKING_OBJECT_CAMERA</a>) {
<a name="l02980"></a>02980         <span class="comment">/* object used for camera solving can&#39;t be deleted */</span>
<a name="l02981"></a>02981         <span class="keywordflow">return</span>;
<a name="l02982"></a>02982     }
<a name="l02983"></a>02983 
<a name="l02984"></a>02984     track = <span class="keywordtype">object</span>-&gt;tracks.first;
<a name="l02985"></a>02985     <span class="keywordflow">while</span> (track) {
<a name="l02986"></a>02986         <span class="keywordflow">if</span> (track == tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a>)
<a name="l02987"></a>02987             tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8589447927c2d2ed3f7fa8b23434046f">act_track</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02988"></a>02988 
<a name="l02989"></a>02989         track= track-&gt;<a class="code" href="../../da/d5f/structMovieTrackingTrack.html#aec565ab687123b2707c7be0182b24ea6">next</a>;
<a name="l02990"></a>02990     }
<a name="l02991"></a>02991 
<a name="l02992"></a>02992     <a class="code" href="../../de/ddb/tracking_8c.html#a0b7378a1c422f76e846446735aed3b25">tracking_object_free</a>(<span class="keywordtype">object</span>);
<a name="l02993"></a>02993     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>, <span class="keywordtype">object</span>);
<a name="l02994"></a>02994 
<a name="l02995"></a>02995     tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#acf2e8abff0a11324f1465c854322504b">tot_object</a>--;
<a name="l02996"></a>02996 
<a name="l02997"></a>02997     <span class="keywordflow">if</span> (index&gt;0)
<a name="l02998"></a>02998         tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a4053f7b709ef765fc6d449a0b742ff14">objectnr</a> = index - 1;
<a name="l02999"></a>02999     <span class="keywordflow">else</span>
<a name="l03000"></a>03000         tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a4053f7b709ef765fc6d449a0b742ff14">objectnr</a> = 0;
<a name="l03001"></a>03001 }
<a name="l03002"></a>03002 
<a name="l03003"></a><a class="code" href="../../de/ddb/tracking_8c.html#aace14caf6aee2bf52781e63b3f832101">03003</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d72/BKE__tracking_8h.html#a706934a709c416a5fc59194ed29ee37a">BKE_tracking_object_unique_name</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span>)
<a name="l03004"></a>03004 {
<a name="l03005"></a>03005     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(&amp;tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>, <span class="keywordtype">object</span>, <span class="stringliteral">&quot;Object&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, offsetof(<a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a>, <a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>), <span class="keyword">sizeof</span>(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>));
<a name="l03006"></a>03006 }
<a name="l03007"></a>03007 
<a name="l03008"></a><a class="code" href="../../de/ddb/tracking_8c.html#a0b0871e99118bcfea49cb19d3efa09d9">03008</a> <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<a class="code" href="../../da/d72/BKE__tracking_8h.html#a44872d3e133985f2608b4a5b3465417e">BKE_tracking_named_object</a>(<a class="code" href="../../d9/ddb/structMovieTracking.html">MovieTracking</a> *tracking, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>)
<a name="l03009"></a>03009 {
<a name="l03010"></a>03010     <a class="code" href="../../d2/de6/structMovieTrackingObject.html">MovieTrackingObject</a> *<span class="keywordtype">object</span> = tracking-&gt;<a class="code" href="../../d9/ddb/structMovieTracking.html#a8b83f22c1c9fa84904d2a6689973b789">objects</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l03011"></a>03011 
<a name="l03012"></a>03012     <span class="keywordflow">while</span> (<span class="keywordtype">object</span>) {
<a name="l03013"></a>03013         <span class="keywordflow">if</span> (!strcmp(object-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a229e3acc8dd9f787656af90c258c3587">name</a>, name))
<a name="l03014"></a>03014             <span class="keywordflow">return</span> object;
<a name="l03015"></a>03015 
<a name="l03016"></a>03016         <span class="keywordtype">object</span> = <span class="keywordtype">object</span>-&gt;<a class="code" href="../../d2/de6/structMovieTrackingObject.html#a9c25b559861625fafa9281d308689f46">next</a>;
<a name="l03017"></a>03017     }
<a name="l03018"></a>03018 
<a name="l03019"></a>03019     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03020"></a>03020 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:59 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
