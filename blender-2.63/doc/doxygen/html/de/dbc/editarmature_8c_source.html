<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: editarmature.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">editarmature.c</div>  </div>
</div>
<div class="contents">
<a href="../../de/dbc/editarmature_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Blender Foundation, 2002-2009 full recode.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;math.h&gt;</span> 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;float.h&gt;</span> 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;assert.h&gt;</span> 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d95/BKE__idprop_8h.html">BKE_idprop.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d98/ED__armature_8h.html">ED_armature.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df9/ED__keyframing_8h.html">ED_keyframing.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7a/ED__object_8h.html">ED_object.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df1/ED__util_8h.html">ED_util.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d1e/UI__interface_8h.html">UI_interface.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d26/armature__intern_8h.html">armature_intern.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/de3/meshlaplacian_8h.html">meshlaplacian.h</a>&quot;</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="preprocessor">#if 0</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d5/d76/reeb_8h.html">reeb.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a>00097 <span class="comment">/* **************** tools on Editmode Armature **************** */</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">/* Sync selection to parent for connected children */</span>
<a name="l00100"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a615756aa78da96e85ba813d2e1a2cc56">00100</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo;
<a name="l00103"></a>00103     
<a name="l00104"></a>00104     <span class="keywordflow">for</span> (ebo=edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00105"></a>00105         <span class="comment">/* if bone is not selectable, we shouldn&#39;t alter this setting... */</span>
<a name="l00106"></a>00106         <span class="keywordflow">if</span> ((ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>) == 0) {
<a name="l00107"></a>00107             <span class="keywordflow">if</span> ((ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) &amp;&amp; (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>)) {
<a name="l00108"></a>00108                 <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>)
<a name="l00109"></a>00109                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l00110"></a>00110                 <span class="keywordflow">else</span>
<a name="l00111"></a>00111                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l00112"></a>00112             }
<a name="l00113"></a>00113             
<a name="l00114"></a>00114             <span class="keywordflow">if</span> ((ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) &amp;&amp; (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>))
<a name="l00115"></a>00115                 ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l00116"></a>00116             <span class="keywordflow">else</span>
<a name="l00117"></a>00117                 ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119     }               
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a35c0db71fe98d109520c401547cd0c5b">00122</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (ebone) { 
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>)
<a name="l00128"></a>00128             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">00132</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">bone_free</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>==bone)
<a name="l00135"></a>00135         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>) {
<a name="l00138"></a>00138         <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l00139"></a>00139         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, bone);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#afba12bcbfe0738878122244964e0a1a8">00145</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a7c373891630bb74f110cd6743cda92b6">ED_armature_edit_bone_remove</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *exBone)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="comment">/* Find any bones that refer to this bone */</span>
<a name="l00150"></a>00150     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00151"></a>00151         <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>==exBone) {
<a name="l00152"></a>00152             curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>=exBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l00153"></a>00153             curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l00154"></a>00154         }
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">bone_free</a>(arm, exBone);
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">/* context: editmode armature */</span>
<a name="l00161"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a80f39cae9fd6edac42c1fe94ee5305ac">00161</a> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eboflip= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00164"></a>00164     <span class="keywordtype">char</span> name[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (ebo == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00167"></a>00167         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a13c8067511267c6d95644db2450a367a">flip_side_name</a>(name, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     <span class="keywordflow">for</span> (eboflip= edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eboflip; eboflip=eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00172"></a>00172         <span class="keywordflow">if</span> (ebo != eboflip) {
<a name="l00173"></a>00173             <span class="keywordflow">if</span> (!strcmp (name, eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>)) 
<a name="l00174"></a>00174                 <span class="keywordflow">break</span>;
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     
<a name="l00178"></a>00178     <span class="keywordflow">return</span> eboflip;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">/* helper function for tools to work on mirrored parts.</span>
<a name="l00182"></a>00182 <span class="comment"> * it leaves mirrored bones selected then too, which is a good indication of what happened */</span>
<a name="l00183"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a894de3351f0072247eb3f393d5e936ad">00183</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a894de3351f0072247eb3f393d5e936ad">armature_select_mirrored</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185     <span class="comment">/* Select mirrored bones */</span>
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l00187"></a>00187         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone, *ebone_mirr;
<a name="l00188"></a>00188         
<a name="l00189"></a>00189         <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00190"></a>00190             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) {
<a name="l00191"></a>00191                 <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l00192"></a>00192                     ebone_mirr= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curBone);
<a name="l00193"></a>00193                     <span class="keywordflow">if</span> (ebone_mirr)
<a name="l00194"></a>00194                         ebone_mirr-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l00195"></a>00195                 }
<a name="l00196"></a>00196             }
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa94906c039f3ad0ce5650e9669fb3804">00202</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aa94906c039f3ad0ce5650e9669fb3804">armature_tag_select_mirrored</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">/* always untag */</span>
<a name="l00207"></a>00207     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00208"></a>00208         curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">/* Select mirrored bones */</span>
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l00213"></a>00213         <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00214"></a>00214             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) {
<a name="l00215"></a>00215                 <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>)) {
<a name="l00216"></a>00216                     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone_mirr= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curBone);
<a name="l00217"></a>00217                     <span class="keywordflow">if</span> (ebone_mirr &amp;&amp; (ebone_mirr-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) == 0) {
<a name="l00218"></a>00218                         ebone_mirr-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>;
<a name="l00219"></a>00219                     }
<a name="l00220"></a>00220                 }
<a name="l00221"></a>00221             }
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00225"></a>00225             <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>) {
<a name="l00226"></a>00226                 <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone_mirr= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curBone);
<a name="l00227"></a>00227                 curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= ebone_mirr-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l00228"></a>00228             }
<a name="l00229"></a>00229         }
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">/* only works when tagged */</span>
<a name="l00235"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a2420837bcbbc5edd1a2262f5553bff7d">00235</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a2420837bcbbc5edd1a2262f5553bff7d">armature_tag_unselect</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>) {
<a name="l00241"></a>00241             curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>);
<a name="l00242"></a>00242         }
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="comment">/* converts Bones to EditBone list, used for tools as well */</span>
<a name="l00247"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a4725159e40eac8463b44fdefdf466ffc">00247</a> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../dc/d26/armature__intern_8h.html#a776fc766f66fd5f2ce563cec7a612dad">make_boneList</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *bones, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *parent, <a class="code" href="../../de/de0/structBone.html">Bone</a> *actBone)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *eBone;
<a name="l00250"></a>00250     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *eBoneAct= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00251"></a>00251     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *eBoneTest= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00252"></a>00252     <a class="code" href="../../de/de0/structBone.html">Bone</a>        *curBone;
<a name="l00253"></a>00253         
<a name="l00254"></a>00254     <span class="keywordflow">for</span> (curBone=bones-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00255"></a>00255         eBone= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>), <span class="stringliteral">&quot;make_editbone&quot;</span>);
<a name="l00256"></a>00256         
<a name="l00257"></a>00257         <span class="comment">/*  Copy relevant data from bone to eBone */</span>
<a name="l00258"></a>00258         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= parent;
<a name="l00259"></a>00259         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>, <span class="keyword">sizeof</span>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>));
<a name="l00260"></a>00260         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a>;
<a name="l00261"></a>00261         
<a name="l00262"></a>00262         <span class="comment">/* fix selection flags */</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l00265"></a>00265             <span class="comment">/* if the bone is selected the copy its root selection to the parents tip */</span>
<a name="l00266"></a>00266             eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l00267"></a>00267             <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l00268"></a>00268                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l00269"></a>00269                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>; <span class="comment">/* this is ignored when there is a connected parent, so unset it */</span>
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271             <span class="keywordflow">else</span> {
<a name="l00272"></a>00272                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l00273"></a>00273             }
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         <span class="keywordflow">else</span> {
<a name="l00276"></a>00276             <span class="comment">/* if the bone is not selected, but connected to its parent</span>
<a name="l00277"></a>00277 <span class="comment">             *  copy the parents tip selection state */</span>
<a name="l00278"></a>00278             <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp;  (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l00279"></a>00279                 <span class="comment">/* selecting with the mouse gives this behavior */</span>
<a name="l00280"></a>00280                 <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) {
<a name="l00281"></a>00281                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l00282"></a>00282                 }
<a name="l00283"></a>00283                 <span class="keywordflow">else</span> {
<a name="l00284"></a>00284                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l00285"></a>00285                 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287                 <span class="comment">/* probably not selected but just in case */</span>
<a name="l00288"></a>00288                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l00289"></a>00289             }
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>);
<a name="l00293"></a>00293         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l00294"></a>00294         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a> = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#afd67e451c3b933289c0fc88a515ef6a6">arm_roll</a>;
<a name="l00295"></a>00295         
<a name="l00296"></a>00296         <span class="comment">/* rest of stuff copy */</span>
<a name="l00297"></a>00297         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a9f6371e8c53554e6d61db6eb65e30f8a">length</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l00298"></a>00298         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae41dbb73ded85fe0699b8c7283998ea9">dist</a>;
<a name="l00299"></a>00299         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a2753960f025df5ba4b63a6b6367d88bc">weight</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#afa2a71efdb2d15bcab524ddddf54ee70">weight</a>;
<a name="l00300"></a>00300         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a69db347b7b06645a732d0660af547d26">xwidth</a>;
<a name="l00301"></a>00301         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a48fe605b53ad8762ce588b7d5e868e64">zwidth</a>;
<a name="l00302"></a>00302         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad9fd275367fb8380d2687f2792f55ad3">ease1</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a1a8c73a40cb50593f865077eb42b47e4">ease1</a>;
<a name="l00303"></a>00303         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a1ea52dfee3cbfe086800c86d2ac30db8">ease2</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ac19a237ba3a787497f2d147bfe045d99">ease2</a>;
<a name="l00304"></a>00304         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#aa3a081bf3e8f40876c53868e52174190">rad_head</a>;
<a name="l00305"></a>00305         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ac603bd97e3cb0f73ec55cc73ee8ac1d0">rad_tail</a>;
<a name="l00306"></a>00306         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a386520de6d24a893cc598b38535c5687">segments</a> = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>;        
<a name="l00307"></a>00307         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a> = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>)
<a name="l00310"></a>00310             eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>= <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(curBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>);
<a name="l00311"></a>00311         
<a name="l00312"></a>00312         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(edbo, eBone);
<a name="l00313"></a>00313         
<a name="l00314"></a>00314         <span class="comment">/*  Add children if necessary */</span>
<a name="l00315"></a>00315         <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00316"></a>00316             eBoneTest= <a class="code" href="../../dc/d26/armature__intern_8h.html#a776fc766f66fd5f2ce563cec7a612dad">make_boneList</a>(edbo, &amp;curBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>, eBone, actBone);
<a name="l00317"></a>00317             <span class="keywordflow">if</span> (eBoneTest)
<a name="l00318"></a>00318                 eBoneAct= eBoneTest;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         <span class="keywordflow">if</span> (curBone==actBone)
<a name="l00322"></a>00322             eBoneAct= eBone;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordflow">return</span> eBoneAct;
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">/* nasty stuff for converting roll in editbones into bones */</span>
<a name="l00329"></a>00329 <span class="comment">/* also sets restposition in armature (arm_mat) */</span>
<a name="l00330"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a2ad9382886f0806dcb44fcdabaf2ca9a">00330</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a2ad9382886f0806dcb44fcdabaf2ca9a">fix_bonelist_roll</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *bonelist, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbonelist)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     <a class="code" href="../../de/de0/structBone.html">Bone</a> *curBone;
<a name="l00333"></a>00333     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l00334"></a>00334     <span class="keywordtype">float</span> premat[3][3];
<a name="l00335"></a>00335     <span class="keywordtype">float</span> postmat[3][3];
<a name="l00336"></a>00336     <span class="keywordtype">float</span> difmat[3][3];
<a name="l00337"></a>00337     <span class="keywordtype">float</span> imat[3][3];
<a name="l00338"></a>00338     <span class="keywordtype">float</span> delta[3];
<a name="l00339"></a>00339     
<a name="l00340"></a>00340     <span class="keywordflow">for</span> (curBone=bonelist-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00341"></a>00341         <span class="comment">/* sets local matrix and arm_mat (restpos) */</span>
<a name="l00342"></a>00342         <a class="code" href="../../da/d17/BKE__armature_8h.html#a3932f556348bad6a8bd95a6350b5450f">where_is_armature_bone</a>(curBone, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>);
<a name="l00343"></a>00343         
<a name="l00344"></a>00344         <span class="comment">/* Find the associated editbone */</span>
<a name="l00345"></a>00345         <span class="keywordflow">for</span> (ebone = editbonelist-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>)
<a name="l00346"></a>00346             <span class="keywordflow">if</span> ((<a class="code" href="../../de/de0/structBone.html">Bone</a>*)ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a> == curBone)
<a name="l00347"></a>00347                 <span class="keywordflow">break</span>;
<a name="l00348"></a>00348         
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (ebone) {
<a name="l00350"></a>00350             <span class="comment">/* Get the ebone premat */</span>
<a name="l00351"></a>00351             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00352"></a>00352             <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>, premat);
<a name="l00353"></a>00353             
<a name="l00354"></a>00354             <span class="comment">/* Get the bone postmat */</span>
<a name="l00355"></a>00355             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(postmat, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l00356"></a>00356             
<a name="l00357"></a>00357             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat, premat);
<a name="l00358"></a>00358             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(difmat, imat, postmat);
<a name="l00359"></a>00359 <span class="preprocessor">#if 0</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>            printf (<span class="stringliteral">&quot;Bone %s\n&quot;</span>, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l00361"></a>00361             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a66d7ac1b08fbeb6ac52f0b6e21e2e768">print_m4</a>(<span class="stringliteral">&quot;premat&quot;</span>, premat);
<a name="l00362"></a>00362             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a66d7ac1b08fbeb6ac52f0b6e21e2e768">print_m4</a>(<span class="stringliteral">&quot;postmat&quot;</span>, postmat);
<a name="l00363"></a>00363             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a66d7ac1b08fbeb6ac52f0b6e21e2e768">print_m4</a>(<span class="stringliteral">&quot;difmat&quot;</span>, difmat);
<a name="l00364"></a>00364             printf (<span class="stringliteral">&quot;Roll = %f\n&quot;</span>,  <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a95c550a7b3c9b2628d20aef44bc12b56">RAD2DEGF</a>(-<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(difmat[2][0], difmat[2][2])));
<a name="l00365"></a>00365 <span class="preprocessor">#endif</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>            curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a46729be80412a30d51f792ef291c5d01">roll</a> = (float)-<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(difmat[2][0], difmat[2][2]);
<a name="l00367"></a>00367             
<a name="l00368"></a>00368             <span class="comment">/* and set restposition again */</span>
<a name="l00369"></a>00369             <a class="code" href="../../da/d17/BKE__armature_8h.html#a3932f556348bad6a8bd95a6350b5450f">where_is_armature_bone</a>(curBone, curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>);
<a name="l00370"></a>00370         }
<a name="l00371"></a>00371         <a class="code" href="../../de/dbc/editarmature_8c.html#a2ad9382886f0806dcb44fcdabaf2ca9a">fix_bonelist_roll</a>(&amp;curBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>, editbonelist);
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="comment">/* put EditMode back in Object */</span>
<a name="l00376"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#afd45a9e19b4eaf8e329f42d9ba549aba">00376</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00379"></a>00379     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone, *neBone;
<a name="l00380"></a>00380     <a class="code" href="../../de/de0/structBone.html">Bone</a>    *newBone;
<a name="l00381"></a>00381     <a class="code" href="../../de/de7/structObject.html">Object</a> *obt;
<a name="l00382"></a>00382     
<a name="l00383"></a>00383     <span class="comment">/* armature bones */</span>
<a name="l00384"></a>00384     <a class="code" href="../../da/d17/BKE__armature_8h.html#a197a7c908db86e9a921de33254085b2c">free_bonelist</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>);
<a name="l00385"></a>00385     
<a name="l00386"></a>00386     <span class="comment">/* remove zero sized bones, this gives instable restposes */</span>
<a name="l00387"></a>00387     <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone= neBone) {
<a name="l00388"></a>00388         <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00389"></a>00389         neBone= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>;
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (len &lt;= 0.000001f) {     <span class="comment">/* FLT_EPSILON is too large? */</span>
<a name="l00391"></a>00391             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *fBone;
<a name="l00392"></a>00392             
<a name="l00393"></a>00393             <span class="comment">/*  Find any bones that refer to this bone  */</span>
<a name="l00394"></a>00394             <span class="keywordflow">for</span> (fBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fBone; fBone= fBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00395"></a>00395                 <span class="keywordflow">if</span> (fBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>==eBone)
<a name="l00396"></a>00396                     fBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00399"></a>00399                 printf(<span class="stringliteral">&quot;Warning: removed zero sized bone: %s\n&quot;</span>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>);
<a name="l00400"></a>00400             <a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">bone_free</a>(arm, eBone);
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403     
<a name="l00404"></a>00404     <span class="comment">/*  Copy the bones from the editData into the armature */</span>
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00406"></a>00406         newBone= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/de0/structBone.html">Bone</a>), <span class="stringliteral">&quot;bone&quot;</span>);
<a name="l00407"></a>00407         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>= newBone;   <span class="comment">/* Associate the real Bones with the EditBones */</span>
<a name="l00408"></a>00408         
<a name="l00409"></a>00409         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>));
<a name="l00410"></a>00410         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00411"></a>00411         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00412"></a>00412         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#afd67e451c3b933289c0fc88a515ef6a6">arm_roll</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l00413"></a>00413         
<a name="l00414"></a>00414         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a>;
<a name="l00415"></a>00415         
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (eBone == arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) {
<a name="l00417"></a>00417             <span class="comment">/* don&#39;t change active selection, this messes up separate which uses</span>
<a name="l00418"></a>00418 <span class="comment">             * editmode toggle and can separate active bone which is de-selected originally */</span>
<a name="l00419"></a>00419             <span class="comment">/* newBone-&gt;flag |= BONE_SELECTED; */</span> <span class="comment">/* important, editbones can be active with only 1 point selected */</span>
<a name="l00420"></a>00420             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00421"></a>00421             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= newBone;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a46729be80412a30d51f792ef291c5d01">roll</a> = 0.0f;
<a name="l00424"></a>00424         
<a name="l00425"></a>00425         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#afa2a71efdb2d15bcab524ddddf54ee70">weight</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a2753960f025df5ba4b63a6b6367d88bc">weight</a>;
<a name="l00426"></a>00426         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae41dbb73ded85fe0699b8c7283998ea9">dist</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>;
<a name="l00427"></a>00427         
<a name="l00428"></a>00428         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a69db347b7b06645a732d0660af547d26">xwidth</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>;
<a name="l00429"></a>00429         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a48fe605b53ad8762ce588b7d5e868e64">zwidth</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>;
<a name="l00430"></a>00430         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a1a8c73a40cb50593f865077eb42b47e4">ease1</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad9fd275367fb8380d2687f2792f55ad3">ease1</a>;
<a name="l00431"></a>00431         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ac19a237ba3a787497f2d147bfe045d99">ease2</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a1ea52dfee3cbfe086800c86d2ac30db8">ease2</a>;
<a name="l00432"></a>00432         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#aa3a081bf3e8f40876c53868e52174190">rad_head</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>;
<a name="l00433"></a>00433         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ac603bd97e3cb0f73ec55cc73ee8ac1d0">rad_tail</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l00434"></a>00434         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a386520de6d24a893cc598b38535c5687">segments</a>;
<a name="l00435"></a>00435         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a> = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>;
<a name="l00436"></a>00436         
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>)
<a name="l00438"></a>00438             newBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>= <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440     
<a name="l00441"></a>00441     <span class="comment">/* Fix parenting in a separate pass to ensure ebone-&gt;bone connections</span>
<a name="l00442"></a>00442 <span class="comment">     * are valid at this point */</span>
<a name="l00443"></a>00443     <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;eBone;eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00444"></a>00444         newBone= (<a class="code" href="../../de/de0/structBone.html">Bone</a> *)eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l00445"></a>00445         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l00446"></a>00446             newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>= (<a class="code" href="../../de/de0/structBone.html">Bone</a> *)eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l00447"></a>00447             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>, newBone);
<a name="l00448"></a>00448             
<a name="l00449"></a>00449             {
<a name="l00450"></a>00450                 <span class="keywordtype">float</span> M_parentRest[3][3];
<a name="l00451"></a>00451                 <span class="keywordtype">float</span> iM_parentRest[3][3];
<a name="l00452"></a>00452                 <span class="keywordtype">float</span>   delta[3];
<a name="l00453"></a>00453                 
<a name="l00454"></a>00454                 <span class="comment">/* Get the parent&#39;s  matrix (rotation only) */</span>
<a name="l00455"></a>00455                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00456"></a>00456                 <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>, M_parentRest);
<a name="l00457"></a>00457                 
<a name="l00458"></a>00458                 <span class="comment">/* Invert the parent matrix */</span>
<a name="l00459"></a>00459                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(iM_parentRest, M_parentRest);
<a name="l00460"></a>00460                 
<a name="l00461"></a>00461                 <span class="comment">/* Get the new head and tail */</span>
<a name="l00462"></a>00462                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00463"></a>00463                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a6a61049fb891cd38380668926819f823">tail</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00464"></a>00464                 
<a name="l00465"></a>00465                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(iM_parentRest, newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>);
<a name="l00466"></a>00466                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(iM_parentRest, newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a6a61049fb891cd38380668926819f823">tail</a>);
<a name="l00467"></a>00467             }
<a name="l00468"></a>00468         }
<a name="l00469"></a>00469         <span class="comment">/*  ...otherwise add this bone to the armature&#39;s bonebase */</span>
<a name="l00470"></a>00470         <span class="keywordflow">else</span> {
<a name="l00471"></a>00471             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00472"></a>00472             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a6a61049fb891cd38380668926819f823">tail</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00473"></a>00473             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>, newBone);
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     
<a name="l00477"></a>00477     <span class="comment">/* Make a pass through the new armature to fix rolling */</span>
<a name="l00478"></a>00478     <span class="comment">/* also builds restposition again (like where_is_armature) */</span>
<a name="l00479"></a>00479     <a class="code" href="../../de/dbc/editarmature_8c.html#a2ad9382886f0806dcb44fcdabaf2ca9a">fix_bonelist_roll</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l00480"></a>00480     
<a name="l00481"></a>00481     <span class="comment">/* so all users of this armature should get rebuilt */</span>
<a name="l00482"></a>00482     <span class="keywordflow">for</span> (obt= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; obt; obt= obt-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00483"></a>00483         <span class="keywordflow">if</span> (obt-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>==arm)
<a name="l00484"></a>00484             <a class="code" href="../../da/d17/BKE__armature_8h.html#a565b57760b56c855cc22ee91ff4f6225">armature_rebuild_pose</a>(obt, arm);
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486     
<a name="l00487"></a>00487     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l00488"></a>00488 }
<a name="l00489"></a>00489 
<a name="l00490"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#af6a5210768f9cf8453b02ae9b01f7307">00490</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a608f02feb2265bd9195428e232308f87">ED_armature_apply_transform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> mat[4][4])
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l00493"></a>00493     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00494"></a>00494     <span class="keywordtype">float</span> scale = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a1e63f7e6f978bfb2570cb43d25829c09">mat4_to_scale</a>(mat);   <span class="comment">/* store the scale of the matrix here to use on envelopes */</span>
<a name="l00495"></a>00495     <span class="keywordtype">float</span> mat3[3][3];
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mat3, mat);
<a name="l00498"></a>00498     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(mat3);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="comment">/* Put the armature into editmode */</span>
<a name="l00501"></a>00501     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(ob);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="comment">/* Do the rotations */</span>
<a name="l00504"></a>00504     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00505"></a>00505         <span class="keywordtype">float</span>   delta[3], tmat[3][3];
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">/* find the current bone&#39;s roll matrix */</span>
<a name="l00508"></a>00508         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00509"></a>00509         <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>, tmat);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="comment">/* transform the roll matrix */</span>
<a name="l00512"></a>00512         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(tmat, mat3, tmat);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="comment">/* transform the bone */</span>
<a name="l00515"></a>00515         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00516"></a>00516         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <span class="comment">/* apply the transfiormed roll back */</span>
<a name="l00519"></a>00519         <a class="code" href="../../da/d17/BKE__armature_8h.html#a2b53ce3fca660bd148f0e11b7d9692fd">mat3_to_vec_roll</a>(tmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a> *= scale;
<a name="l00522"></a>00522         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a> *= scale;
<a name="l00523"></a>00523         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>     *= scale;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">/* we could be smarter and scale by the matrix along the x &amp; z axis */</span>
<a name="l00526"></a>00526         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>   *= scale;
<a name="l00527"></a>00527         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>   *= scale;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     
<a name="l00530"></a>00530     <span class="comment">/* Turn the list into an armature */</span>
<a name="l00531"></a>00531     <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(ob);
<a name="l00532"></a>00532     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="comment">/* exported for use in editors/object/ */</span>
<a name="l00536"></a>00536 <span class="comment">/* 0 == do center, 1 == center new, 2 == center cursor */</span>
<a name="l00537"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a4c702c35d9f97f51c1923e1ee0954eb8">00537</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a45bc64963ac0553d8cdd38aaa2cd8a27">docenter_armature</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> cursor[3], <span class="keywordtype">int</span> centermode, <span class="keywordtype">int</span> around)
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l00540"></a>00540     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l00541"></a>00541     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00542"></a>00542     <span class="keywordtype">float</span> cent[3];
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">/* Put the armature into editmode */</span>
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (ob != obedit) {
<a name="l00546"></a>00546         <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(ob);
<a name="l00547"></a>00547         obedit= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* we cant use this so behave as if there is no obedit */</span>
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     <span class="comment">/* Find the centerpoint */</span>
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (centermode == 2) {
<a name="l00552"></a>00552         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cent, cursor);
<a name="l00553"></a>00553         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00554"></a>00554         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, cent);
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="keywordflow">else</span> {
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (around==<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#afd8c47e8e264b1f878a625b2d9d72858">V3D_CENTROID</a>) {
<a name="l00558"></a>00558             <span class="keywordtype">int</span> total= 0;
<a name="l00559"></a>00559             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(cent);
<a name="l00560"></a>00560             <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00561"></a>00561                 total+=2;
<a name="l00562"></a>00562                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(cent, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00563"></a>00563                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(cent, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l00564"></a>00564             }
<a name="l00565"></a>00565             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cent, 1.0f/(<span class="keywordtype">float</span>)total);
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567         <span class="keywordflow">else</span> {
<a name="l00568"></a>00568             <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3];
<a name="l00569"></a>00569             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l00570"></a>00570             <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00571"></a>00571                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, min, max);
<a name="l00572"></a>00572                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, min, max);
<a name="l00573"></a>00573             }
<a name="l00574"></a>00574             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(cent, min, max);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577     
<a name="l00578"></a>00578     <span class="comment">/* Do the adjustments */</span>
<a name="l00579"></a>00579     <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l00580"></a>00580         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, cent);
<a name="l00581"></a>00581         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, cent);
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     
<a name="l00584"></a>00584     <span class="comment">/* Turn the list into an armature */</span>
<a name="l00585"></a>00585     <span class="keywordflow">if</span> (obedit==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00586"></a>00586         <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(ob);
<a name="l00587"></a>00587         <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="comment">/* Adjust object location for new centerpoint */</span>
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (centermode &amp;&amp; obedit==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00592"></a>00592         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, cent); <span class="comment">/* ommit translation part */</span>
<a name="l00593"></a>00593         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>, cent);
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">/* ---------------------- */</span>
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="comment">/* checks if an EditBone with a matching name already, returning the matching bone if it exists */</span>
<a name="l00600"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">00600</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     <span class="keywordflow">return</span> <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(edbo, name, offsetof(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>, name));
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 <span class="comment">/* note: there&#39;s a unique_bone_name() too! */</span>
<a name="l00606"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5665dda95e2f3fdb83f0ffe810a717a7">00606</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5665dda95e2f3fdb83f0ffe810a717a7">editbone_unique_check</a>(<span class="keywordtype">void</span> *arg, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608     <span class="keyword">struct </span>{<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb;<span class="keywordtype">void</span> *bone;} *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= arg;
<a name="l00609"></a>00609     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *dupli= <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>-&gt;lb, name);
<a name="l00610"></a>00610     <span class="keywordflow">return</span> dupli &amp;&amp; dupli != <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>-&gt;bone;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a7dabc39181f111f45914e2279a6567bd">00613</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <span class="keywordtype">char</span> *name, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615     <span class="keyword">struct </span>{<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb; <span class="keywordtype">void</span> *bone;} <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00616"></a>00616     <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>.lb= edbo;
<a name="l00617"></a>00617     <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>.bone= bone;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a55d85aa9be3dcae052659d317bdc962b">BLI_uniquename_cb</a>(<a class="code" href="../../de/dbc/editarmature_8c.html#a5665dda95e2f3fdb83f0ffe810a717a7">editbone_unique_check</a>, &amp;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="stringliteral">&quot;Bone&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, name, <span class="keyword">sizeof</span>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>));
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="comment">/* helper for apply_armature_pose2bones - fixes parenting of objects that are bone-parented to armature */</span>
<a name="l00623"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a1a8ffd451d8b3bba4daffa3d9530a510">00623</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a1a8ffd451d8b3bba4daffa3d9530a510">applyarmature_fix_boneparents</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *armob)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625     <a class="code" href="../../de/de7/structObject.html">Object</a> workob, *ob;
<a name="l00626"></a>00626     
<a name="l00627"></a>00627     <span class="comment">/* go through all objects in database */</span>
<a name="l00628"></a>00628     <span class="keywordflow">for</span> (ob= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00629"></a>00629         <span class="comment">/* if parent is bone in this armature, apply corrections */</span>
<a name="l00630"></a>00630         <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> == armob) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0ed2df4a386ce2b22084aaaa701d73ff">partype</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa660de9e3216076e99f66fac72274ea0">PARBONE</a>)) {
<a name="l00631"></a>00631             <span class="comment">/* apply current transform from parent (not yet destroyed), </span>
<a name="l00632"></a>00632 <span class="comment">             * then calculate new parent inverse matrix</span>
<a name="l00633"></a>00633 <span class="comment">             */</span>
<a name="l00634"></a>00634             <a class="code" href="../../df/dac/BKE__object_8h.html#ada756f0afaa15cb2fdb1eff6a908ce0c">object_apply_mat4</a>(ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00635"></a>00635             
<a name="l00636"></a>00636             <a class="code" href="../../df/dac/BKE__object_8h.html#a47bd162131b92025c4eff4bb2316a9d2">what_does_parent</a>(scene, ob, &amp;workob);
<a name="l00637"></a>00637             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a7809bbfa606a220179929cc5cd198a30">parentinv</a>, workob.<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="comment">/* set the current pose as the restpose */</span>
<a name="l00643"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab2f8f72593530c171abc44743913e47e">00643</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ab2f8f72593530c171abc44743913e47e">apply_armature_pose2bones_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00646"></a>00646     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C)); <span class="comment">// must be active object, not edit-object</span>
<a name="l00647"></a>00647     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= <a class="code" href="../../da/d17/BKE__armature_8h.html#a0c6c9c472b6b6bb51a784294b3688ae9">get_armature</a>(ob);
<a name="l00648"></a>00648     <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose;
<a name="l00649"></a>00649     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l00650"></a>00650     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone;
<a name="l00651"></a>00651     
<a name="l00652"></a>00652     <span class="comment">/* don&#39;t check if editmode (should be done by caller) */</span>
<a name="l00653"></a>00653     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l00654"></a>00654         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00655"></a>00655     <span class="keywordflow">if</span> (<a class="code" href="../../df/dac/BKE__object_8h.html#a7e66121d861c5070a2b6f9ed04ca87cb">object_data_is_libdata</a>(ob)) {
<a name="l00656"></a>00656         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Cannot apply pose to lib-linked armature&quot;</span>); <span class="comment">//error_libdata();</span>
<a name="l00657"></a>00657         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659     
<a name="l00660"></a>00660     <span class="comment">/* helpful warnings... */</span>
<a name="l00661"></a>00661     <span class="comment">// TODO: add warnings to be careful about actions, applying deforms first, etc.</span>
<a name="l00662"></a>00662     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>) 
<a name="l00663"></a>00663         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Actions on this armature will be destroyed by this new rest pose as the transforms stored are relative to the old rest pose&quot;</span>);
<a name="l00664"></a>00664     
<a name="l00665"></a>00665     <span class="comment">/* Get editbones of active armature to alter */</span>
<a name="l00666"></a>00666     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(ob);    
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     <span class="comment">/* get pose of active object and move it out of posemode */</span>
<a name="l00669"></a>00669     pose= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l00670"></a>00670     
<a name="l00671"></a>00671     <span class="keywordflow">for</span> (pchan=pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan=pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l00672"></a>00672         curbone= <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l00673"></a>00673         
<a name="l00674"></a>00674         <span class="comment">/* simply copy the head/tail values from pchan over to curbone */</span>
<a name="l00675"></a>00675         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l00676"></a>00676         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00677"></a>00677         
<a name="l00678"></a>00678         <span class="comment">/* fix roll:</span>
<a name="l00679"></a>00679 <span class="comment">         *  1. find auto-calculated roll value for this bone now</span>
<a name="l00680"></a>00680 <span class="comment">         *  2. remove this from the &#39;visual&#39; y-rotation</span>
<a name="l00681"></a>00681 <span class="comment">         */</span>
<a name="l00682"></a>00682         {
<a name="l00683"></a>00683             <span class="keywordtype">float</span> premat[3][3], imat[3][3],pmat[3][3], tmat[3][3];
<a name="l00684"></a>00684             <span class="keywordtype">float</span> delta[3], eul[3];
<a name="l00685"></a>00685             
<a name="l00686"></a>00686             <span class="comment">/* obtain new auto y-rotation */</span>
<a name="l00687"></a>00687             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l00688"></a>00688             <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, 0.0f, premat);
<a name="l00689"></a>00689             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat, premat);
<a name="l00690"></a>00690             
<a name="l00691"></a>00691             <span class="comment">/* get pchan &#39;visual&#39; matrix */</span>
<a name="l00692"></a>00692             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(pmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00693"></a>00693             
<a name="l00694"></a>00694             <span class="comment">/* remove auto from visual and get euler rotation */</span>
<a name="l00695"></a>00695             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(tmat, imat, pmat);
<a name="l00696"></a>00696             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ac702d04b4ffc7a1c7b803181a88e42df">mat3_to_eul</a>( eul,tmat);
<a name="l00697"></a>00697             
<a name="l00698"></a>00698             <span class="comment">/* just use this euler-y as new roll value */</span>
<a name="l00699"></a>00699             curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= eul[1];
<a name="l00700"></a>00700         }
<a name="l00701"></a>00701         
<a name="l00702"></a>00702         <span class="comment">/* clear transform values for pchan */</span>
<a name="l00703"></a>00703         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>);
<a name="l00704"></a>00704         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>);
<a name="l00705"></a>00705         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a66672ccf9e1308f3ba8c6b6f55fd2a8c">unit_qt</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>);
<a name="l00706"></a>00706         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#acceefe4ea6d15958a0e4e059c114b00e">unit_axis_angle</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>);
<a name="l00707"></a>00707         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[0]= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[1]= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[2]= 1.0f;
<a name="l00708"></a>00708         
<a name="l00709"></a>00709         <span class="comment">/* set anim lock */</span>
<a name="l00710"></a>00710         curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1cffb8d9b288e7798d0c533ba94a695">BONE_UNKEYED</a>;
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712     
<a name="l00713"></a>00713     <span class="comment">/* convert editbones back to bones, and then free the edit-data */</span>
<a name="l00714"></a>00714     <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(ob);
<a name="l00715"></a>00715     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l00716"></a>00716     
<a name="l00717"></a>00717     <span class="comment">/* flush positions of posebones */</span>
<a name="l00718"></a>00718     <a class="code" href="../../da/d17/BKE__armature_8h.html#a3fe187591b5f112128d0139196accf48">where_is_pose</a>(scene, ob);
<a name="l00719"></a>00719     
<a name="l00720"></a>00720     <span class="comment">/* fix parenting of objects which are bone-parented */</span>
<a name="l00721"></a>00721     <a class="code" href="../../de/dbc/editarmature_8c.html#a1a8ffd451d8b3bba4daffa3d9530a510">applyarmature_fix_boneparents</a>(scene, ob);
<a name="l00722"></a>00722     
<a name="l00723"></a>00723     <span class="comment">/* note, notifier might evolve */</span>
<a name="l00724"></a>00724     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, ob);
<a name="l00725"></a>00725     
<a name="l00726"></a>00726     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a109226a1d149540412a44f260bf13055">00729</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#af6c5dee8cc3379bf4c016dd2ef1f4b8a">POSE_OT_armature_apply</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00730"></a>00730 {
<a name="l00731"></a>00731     <span class="comment">/* identifiers */</span>
<a name="l00732"></a>00732     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Apply Pose as Rest Pose&quot;</span>;
<a name="l00733"></a>00733     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_armature_apply&quot;</span>;
<a name="l00734"></a>00734     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Apply the current pose as the new rest pose&quot;</span>;
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     <span class="comment">/* callbacks */</span>
<a name="l00737"></a>00737     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ab2f8f72593530c171abc44743913e47e">apply_armature_pose2bones_exec</a>;
<a name="l00738"></a>00738     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l00739"></a>00739     
<a name="l00740"></a>00740     <span class="comment">/* flags */</span>
<a name="l00741"></a>00741     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 <span class="comment">/* set the current pose as the restpose */</span>
<a name="l00746"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a8062e689a8fc5a271b1bd32265c184d8">00746</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8062e689a8fc5a271b1bd32265c184d8">pose_visual_transform_apply_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C)); <span class="comment">// must be active object, not edit-object</span>
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <span class="comment">/* don&#39;t check if editmode (should be done by caller) */</span>
<a name="l00751"></a>00751     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l00752"></a>00752         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="comment">/* loop over all selected pchans</span>
<a name="l00755"></a>00755 <span class="comment">     *</span>
<a name="l00756"></a>00756 <span class="comment">     * TODO, loop over children before parents if multiple bones</span>
<a name="l00757"></a>00757 <span class="comment">     * at once are to be predictable*/</span>
<a name="l00758"></a>00758     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *, pchan, selected_pose_bones)
<a name="l00759"></a>00759     {
<a name="l00760"></a>00760         <span class="keywordtype">float</span> delta_mat[4][4];
<a name="l00761"></a>00761         
<a name="l00762"></a>00762         <span class="comment">/* chan_mat already contains the delta transform from rest pose to pose-mode pose</span>
<a name="l00763"></a>00763 <span class="comment">         * as that is baked into there so that B-Bones will work. Once we&#39;ve set this as the</span>
<a name="l00764"></a>00764 <span class="comment">         * new raw-transform components, don&#39;t recalc the poses yet, otherwise IK result will </span>
<a name="l00765"></a>00765 <span class="comment">         * change, thus changing the result we may be trying to record.</span>
<a name="l00766"></a>00766 <span class="comment">         */</span>
<a name="l00767"></a>00767         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(delta_mat, pchan-&gt;chan_mat);
<a name="l00768"></a>00768         <a class="code" href="../../da/d17/BKE__armature_8h.html#ae95841a135f2f83613e8ba5ee479ad88">pchan_apply_mat4</a>(pchan, delta_mat, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00771"></a>00771     
<a name="l00772"></a>00772     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="comment">/* note, notifier might evolve */</span>
<a name="l00775"></a>00775     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, ob);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a6163a2c7adb46bf1aebec71ec6921ed6">00780</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a8cc2f8757f953fc572bad00b432d671f">POSE_OT_visual_transform_apply</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782     <span class="comment">/* identifiers */</span>
<a name="l00783"></a>00783     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Apply Visual Transform to Pose&quot;</span>;
<a name="l00784"></a>00784     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_visual_transform_apply&quot;</span>;
<a name="l00785"></a>00785     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Apply final constrained position of pose bones to their transform&quot;</span>;
<a name="l00786"></a>00786     
<a name="l00787"></a>00787     <span class="comment">/* callbacks */</span>
<a name="l00788"></a>00788     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a8062e689a8fc5a271b1bd32265c184d8">pose_visual_transform_apply_exec</a>;
<a name="l00789"></a>00789     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l00790"></a>00790     
<a name="l00791"></a>00791     <span class="comment">/* flags */</span>
<a name="l00792"></a>00792     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="comment">/* ---------------------- */</span>
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="comment">/* Helper function for armature joining - link fixing */</span>
<a name="l00798"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abe17ddeb8d9a0bfdaa411f82706ac59e">00798</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#abe17ddeb8d9a0bfdaa411f82706ac59e">joined_armature_fix_links</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *tarArm, <a class="code" href="../../de/de7/structObject.html">Object</a> *srcArm, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone)
<a name="l00799"></a>00799 {
<a name="l00800"></a>00800     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00801"></a>00801     <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose;
<a name="l00802"></a>00802     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchant;
<a name="l00803"></a>00803     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l00804"></a>00804     
<a name="l00805"></a>00805     <span class="comment">/* let&#39;s go through all objects in database */</span>
<a name="l00806"></a>00806     <span class="keywordflow">for</span> (ob= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00807"></a>00807         <span class="comment">/* do some object-type specific things */</span>
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) {
<a name="l00809"></a>00809             pose= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l00810"></a>00810             <span class="keywordflow">for</span> (pchant= pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchant; pchant= pchant-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l00811"></a>00811                 <span class="keywordflow">for</span> (con= pchant-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l00812"></a>00812                     <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l00813"></a>00813                     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00814"></a>00814                     <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l00815"></a>00815                     
<a name="l00816"></a>00816                     <span class="comment">/* constraint targets */</span>
<a name="l00817"></a>00817                     <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l00818"></a>00818                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l00819"></a>00819                         
<a name="l00820"></a>00820                         <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l00821"></a>00821                             <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == srcArm) {
<a name="l00822"></a>00822                                 <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0] == <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00823"></a>00823                                     ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = tarArm;
<a name="l00824"></a>00824                                 }
<a name="l00825"></a>00825                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>)==0) {
<a name="l00826"></a>00826                                     ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = tarArm;
<a name="l00827"></a>00827                                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>));
<a name="l00828"></a>00828                                 }
<a name="l00829"></a>00829                             }
<a name="l00830"></a>00830                         }
<a name="l00831"></a>00831                         
<a name="l00832"></a>00832                         <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l00833"></a>00833                             cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l00834"></a>00834                     }
<a name="l00835"></a>00835                     
<a name="l00836"></a>00836                     <span class="comment">/* action constraint? */</span>
<a name="l00837"></a>00837                     <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a> == <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5acb260fa057d2251a78fe7939f09e4613">CONSTRAINT_TYPE_ACTION</a>) {
<a name="l00838"></a>00838                         <a class="code" href="../../da/dc5/structbActionConstraint.html">bActionConstraint</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>; <span class="comment">// XXX old animation system</span>
<a name="l00839"></a>00839                         <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act;
<a name="l00840"></a>00840                         <a class="code" href="../../da/d47/structbActionChannel.html">bActionChannel</a> *achan;
<a name="l00841"></a>00841                         
<a name="l00842"></a>00842                         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../da/dc5/structbActionConstraint.html#a6b1be879529b9ddc52d3ea079ca670b3">act</a>) {
<a name="l00843"></a>00843                             act= data-&gt;<a class="code" href="../../da/dc5/structbActionConstraint.html#a6b1be879529b9ddc52d3ea079ca670b3">act</a>;
<a name="l00844"></a>00844                             
<a name="l00845"></a>00845                             <span class="keywordflow">for</span> (achan= act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a3d353dd48d5478f1a943612bf1ac2388">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; achan; achan= achan-&gt;<a class="code" href="../../da/d47/structbActionChannel.html#a5bffc2b5bcea64ed3cfefa67496d1e4b">next</a>) {
<a name="l00846"></a>00846                                 <span class="keywordflow">if</span> (strcmp(achan-&gt;<a class="code" href="../../da/d47/structbActionChannel.html#a5f5171f59fd14394b9fc6e0d7dce25df">name</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>)==0)
<a name="l00847"></a>00847                                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(achan-&gt;<a class="code" href="../../da/d47/structbActionChannel.html#a5f5171f59fd14394b9fc6e0d7dce25df">name</a>, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(achan-&gt;<a class="code" href="../../da/d47/structbActionChannel.html#a5f5171f59fd14394b9fc6e0d7dce25df">name</a>));
<a name="l00848"></a>00848                             }
<a name="l00849"></a>00849                         }
<a name="l00850"></a>00850                     }
<a name="l00851"></a>00851                     
<a name="l00852"></a>00852                 }
<a name="l00853"></a>00853             }
<a name="l00854"></a>00854         }
<a name="l00855"></a>00855             
<a name="l00856"></a>00856         <span class="comment">/* fix object-level constraints */</span>
<a name="l00857"></a>00857         <span class="keywordflow">if</span> (ob != srcArm) {
<a name="l00858"></a>00858             <span class="keywordflow">for</span> (con= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a15cd252985e63b0a4b12a07297a7aa8b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l00859"></a>00859                 <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l00860"></a>00860                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00861"></a>00861                 <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l00862"></a>00862                 
<a name="l00863"></a>00863                 <span class="comment">/* constraint targets */</span>
<a name="l00864"></a>00864                 <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l00865"></a>00865                     cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l00866"></a>00866                     
<a name="l00867"></a>00867                     <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l00868"></a>00868                         <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == srcArm) {
<a name="l00869"></a>00869                             <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0] == <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00870"></a>00870                                 ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = tarArm;
<a name="l00871"></a>00871                             }
<a name="l00872"></a>00872                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>)==0) {
<a name="l00873"></a>00873                                 ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = tarArm;
<a name="l00874"></a>00874                                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>));
<a name="l00875"></a>00875                             }
<a name="l00876"></a>00876                         }
<a name="l00877"></a>00877                     }
<a name="l00878"></a>00878                     
<a name="l00879"></a>00879                     <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l00880"></a>00880                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l00881"></a>00881                 }
<a name="l00882"></a>00882             }
<a name="l00883"></a>00883         }
<a name="l00884"></a>00884         
<a name="l00885"></a>00885         <span class="comment">/* See if an object is parented to this armature */</span>
<a name="l00886"></a>00886         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> == srcArm)) {
<a name="l00887"></a>00887             <span class="comment">/* Is object parented to a bone of this src armature? */</span>
<a name="l00888"></a>00888             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0ed2df4a386ce2b22084aaaa701d73ff">partype</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa660de9e3216076e99f66fac72274ea0">PARBONE</a>) {
<a name="l00889"></a>00889                 <span class="comment">/* bone name in object */</span>
<a name="l00890"></a>00890                 <span class="keywordflow">if</span> (!strcmp(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>))
<a name="l00891"></a>00891                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>, curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>));
<a name="l00892"></a>00892             }
<a name="l00893"></a>00893             
<a name="l00894"></a>00894             <span class="comment">/* make tar armature be new parent */</span>
<a name="l00895"></a>00895             ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> = tarArm;
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897     }   
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="comment">/* join armature exec is exported for use in object-&gt;join objects operator... */</span>
<a name="l00901"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa85903721b5dd265182b711b568ba7e4">00901</a> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aa85903721b5dd265182b711b568ba7e4">join_armature_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l00902"></a>00902 {
<a name="l00903"></a>00903     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l00904"></a>00904     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00905"></a>00905     <a class="code" href="../../de/de7/structObject.html">Object</a>  *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00906"></a>00906     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (ob)? ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00907"></a>00907     <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose, *opose;
<a name="l00908"></a>00908     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchann;
<a name="l00909"></a>00909     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone;
<a name="l00910"></a>00910     <span class="keywordtype">float</span>   mat[4][4], oimat[4][4];
<a name="l00911"></a>00911     
<a name="l00912"></a>00912     <span class="comment">/*  Ensure we&#39;re not in editmode and that the active object is an armature*/</span>
<a name="l00913"></a>00913     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!ob || ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l00914"></a>00914         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00915"></a>00915     <span class="keywordflow">if</span> (!arm || arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>)
<a name="l00916"></a>00916         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00917"></a>00917     
<a name="l00918"></a>00918     <span class="comment">/* Get editbones of active armature to add editbones to */</span>
<a name="l00919"></a>00919     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(ob);
<a name="l00920"></a>00920     
<a name="l00921"></a>00921     <span class="comment">/* get pose of active object and move it out of posemode */</span>
<a name="l00922"></a>00922     pose= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l00923"></a>00923     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550acfed9b4bf4a7e2d3c5ae0b3571e38950">OB_MODE_POSE</a>;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a>*, base, selected_editable_bases) {
<a name="l00926"></a>00926         <span class="keywordflow">if</span> ((base-&gt;object-&gt;type==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) &amp;&amp; (base-&gt;object!=ob)) {
<a name="l00927"></a>00927             <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *curarm= base-&gt;object-&gt;data;
<a name="l00928"></a>00928             
<a name="l00929"></a>00929             <span class="comment">/* Make a list of editbones in current armature */</span>
<a name="l00930"></a>00930             <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(base-&gt;object);
<a name="l00931"></a>00931             
<a name="l00932"></a>00932             <span class="comment">/* Get Pose of current armature */</span>
<a name="l00933"></a>00933             opose= base-&gt;object-&gt;pose;
<a name="l00934"></a>00934             base-&gt;object-&gt;mode &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550acfed9b4bf4a7e2d3c5ae0b3571e38950">OB_MODE_POSE</a>;
<a name="l00935"></a>00935             <span class="comment">//BASACT-&gt;flag &amp;= ~OB_MODE_POSE;</span>
<a name="l00936"></a>00936             
<a name="l00937"></a>00937             <span class="comment">/* Find the difference matrix */</span>
<a name="l00938"></a>00938             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(oimat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00939"></a>00939             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, oimat, base-&gt;object-&gt;obmat);
<a name="l00940"></a>00940             
<a name="l00941"></a>00941             <span class="comment">/* Copy bones and posechannels from the object to the edit armature */</span>
<a name="l00942"></a>00942             <span class="keywordflow">for</span> (pchan=opose-&gt;chanbase.first; pchan; pchan=pchann) {
<a name="l00943"></a>00943                 pchann= pchan-&gt;next;
<a name="l00944"></a>00944                 curbone= <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(curarm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, pchan-&gt;name);
<a name="l00945"></a>00945                 
<a name="l00946"></a>00946                 <span class="comment">/* Get new name */</span>
<a name="l00947"></a>00947                 <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curbone-&gt;name, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00948"></a>00948                 
<a name="l00949"></a>00949                 <span class="comment">/* Transform the bone */</span>
<a name="l00950"></a>00950                 {
<a name="l00951"></a>00951                     <span class="keywordtype">float</span> premat[4][4];
<a name="l00952"></a>00952                     <span class="keywordtype">float</span> postmat[4][4];
<a name="l00953"></a>00953                     <span class="keywordtype">float</span> difmat[4][4];
<a name="l00954"></a>00954                     <span class="keywordtype">float</span> imat[4][4];
<a name="l00955"></a>00955                     <span class="keywordtype">float</span> temp[3][3];
<a name="l00956"></a>00956                     <span class="keywordtype">float</span> delta[3];
<a name="l00957"></a>00957                     
<a name="l00958"></a>00958                     <span class="comment">/* Get the premat */</span>
<a name="l00959"></a>00959                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, curbone-&gt;tail, curbone-&gt;head);
<a name="l00960"></a>00960                     <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, curbone-&gt;roll, temp);
<a name="l00961"></a>00961                     
<a name="l00962"></a>00962                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(premat); <span class="comment">/* Mat4MulMat34 only sets 3x3 part */</span>
<a name="l00963"></a>00963                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad9a7248dd2f3d52b786c2476b05daa76">mul_m4_m3m4</a>(premat, temp, mat);
<a name="l00964"></a>00964                     
<a name="l00965"></a>00965                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, curbone-&gt;head);
<a name="l00966"></a>00966                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, curbone-&gt;tail);
<a name="l00967"></a>00967                     
<a name="l00968"></a>00968                     <span class="comment">/* Get the postmat */</span>
<a name="l00969"></a>00969                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, curbone-&gt;tail, curbone-&gt;head);
<a name="l00970"></a>00970                     <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(delta, curbone-&gt;roll, temp);
<a name="l00971"></a>00971                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(postmat, temp);
<a name="l00972"></a>00972                     
<a name="l00973"></a>00973                     <span class="comment">/* Find the roll */</span>
<a name="l00974"></a>00974                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, premat);
<a name="l00975"></a>00975                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(difmat, imat, postmat);
<a name="l00976"></a>00976                     
<a name="l00977"></a>00977                     curbone-&gt;roll -= (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(difmat[2][0], difmat[2][2]);
<a name="l00978"></a>00978                 }
<a name="l00979"></a>00979                 
<a name="l00980"></a>00980                 <span class="comment">/* Fix Constraints and Other Links to this Bone and Armature */</span>
<a name="l00981"></a>00981                 <a class="code" href="../../de/dbc/editarmature_8c.html#abe17ddeb8d9a0bfdaa411f82706ac59e">joined_armature_fix_links</a>(ob, base-&gt;object, pchan, curbone);
<a name="l00982"></a>00982                 
<a name="l00983"></a>00983                 <span class="comment">/* Rename pchan */</span>
<a name="l00984"></a>00984                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pchan-&gt;name, curbone-&gt;name, <span class="keyword">sizeof</span>(pchan-&gt;name));
<a name="l00985"></a>00985                 
<a name="l00986"></a>00986                 <span class="comment">/* Jump Ship! */</span>
<a name="l00987"></a>00987                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(curarm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curbone);
<a name="l00988"></a>00988                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curbone);
<a name="l00989"></a>00989                 
<a name="l00990"></a>00990                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;opose-&gt;chanbase, pchan);
<a name="l00991"></a>00991                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pose-&gt;chanbase, pchan);
<a name="l00992"></a>00992                 <a class="code" href="../../d8/df5/BKE__action_8h.html#af13c0947ece98793cfba086d1b31815b">free_pose_channels_hash</a>(opose);
<a name="l00993"></a>00993                 <a class="code" href="../../d8/df5/BKE__action_8h.html#af13c0947ece98793cfba086d1b31815b">free_pose_channels_hash</a>(pose);
<a name="l00994"></a>00994             }
<a name="l00995"></a>00995             
<a name="l00996"></a>00996             <a class="code" href="../../da/d7a/ED__object_8h.html#af606d9df3349e6cc4267296011bf4f12">ED_base_object_free_and_unlink</a>(bmain, scene, base);
<a name="l00997"></a>00997         }
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01000"></a>01000     
<a name="l01001"></a>01001     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a1916587a9ec19eb3543b1c1bc54a8ded">DAG_scene_sort</a>(bmain, scene);   <span class="comment">// because we removed object(s)</span>
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(ob);
<a name="l01004"></a>01004     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a2072407a0c536bf373bd0b6b7c159c5c">ND_OB_ACTIVE</a>, scene);
<a name="l01007"></a>01007     
<a name="l01008"></a>01008     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="comment">/* ---------------------- */</span>
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="comment">/* Helper function for armature separating - link fixing */</span>
<a name="l01014"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aaf128d0018144e5ce942b1082b17a0fd">01014</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aaf128d0018144e5ce942b1082b17a0fd">separated_armature_fix_links</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *origArm, <a class="code" href="../../de/de7/structObject.html">Object</a> *newArm)
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01017"></a>01017     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01018"></a>01018     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l01019"></a>01019     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *opchans, *npchans;
<a name="l01020"></a>01020     
<a name="l01021"></a>01021     <span class="comment">/* get reference to list of bones in original and new armatures  */</span>
<a name="l01022"></a>01022     opchans= &amp;origArm-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>;
<a name="l01023"></a>01023     npchans= &amp;newArm-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>;
<a name="l01024"></a>01024     
<a name="l01025"></a>01025     <span class="comment">/* let&#39;s go through all objects in database */</span>
<a name="l01026"></a>01026     <span class="keywordflow">for</span> (ob= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l01027"></a>01027         <span class="comment">/* do some object-type specific things */</span>
<a name="l01028"></a>01028         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) {
<a name="l01029"></a>01029             <span class="keywordflow">for</span> (pchan= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01030"></a>01030                 <span class="keywordflow">for</span> (con= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l01031"></a>01031                     <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l01032"></a>01032                     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01033"></a>01033                     <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l01034"></a>01034                     
<a name="l01035"></a>01035                     <span class="comment">/* constraint targets */</span>
<a name="l01036"></a>01036                     <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l01037"></a>01037                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l01038"></a>01038                         
<a name="l01039"></a>01039                         <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l01040"></a>01040                             <span class="comment">/* any targets which point to original armature are redirected to the new one only if:</span>
<a name="l01041"></a>01041 <span class="comment">                             *  - the target isn&#39;t origArm/newArm itself</span>
<a name="l01042"></a>01042 <span class="comment">                             *  - the target is one that can be found in newArm/origArm</span>
<a name="l01043"></a>01043 <span class="comment">                             */</span>
<a name="l01044"></a>01044                             <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0] != 0) {
<a name="l01045"></a>01045                                 <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == origArm) {
<a name="l01046"></a>01046                                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(npchans, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, offsetof(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>, name))) {
<a name="l01047"></a>01047                                         ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a>= newArm;
<a name="l01048"></a>01048                                     }
<a name="l01049"></a>01049                                 }
<a name="l01050"></a>01050                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == newArm) {
<a name="l01051"></a>01051                                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(opchans, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, offsetof(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>, name))) {
<a name="l01052"></a>01052                                         ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a>= origArm;
<a name="l01053"></a>01053                                     }
<a name="l01054"></a>01054                                 }
<a name="l01055"></a>01055                             }
<a name="l01056"></a>01056                         }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058                         <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>) {
<a name="l01059"></a>01059                             cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l01060"></a>01060                         }
<a name="l01061"></a>01061                     }
<a name="l01062"></a>01062                 }
<a name="l01063"></a>01063             }
<a name="l01064"></a>01064         }
<a name="l01065"></a>01065             
<a name="l01066"></a>01066         <span class="comment">/* fix object-level constraints */</span>
<a name="l01067"></a>01067         <span class="keywordflow">if</span> (ob != origArm) {
<a name="l01068"></a>01068             <span class="keywordflow">for</span> (con= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a15cd252985e63b0a4b12a07297a7aa8b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l01069"></a>01069                 <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l01070"></a>01070                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01071"></a>01071                 <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l01072"></a>01072                 
<a name="l01073"></a>01073                 <span class="comment">/* constraint targets */</span>
<a name="l01074"></a>01074                 <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l01075"></a>01075                     cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l01076"></a>01076                     
<a name="l01077"></a>01077                     <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l01078"></a>01078                         <span class="comment">/* any targets which point to original armature are redirected to the new one only if:</span>
<a name="l01079"></a>01079 <span class="comment">                         *  - the target isn&#39;t origArm/newArm itself</span>
<a name="l01080"></a>01080 <span class="comment">                         *  - the target is one that can be found in newArm/origArm</span>
<a name="l01081"></a>01081 <span class="comment">                         */</span>
<a name="l01082"></a>01082                         <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0] != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l01083"></a>01083                             <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == origArm) {
<a name="l01084"></a>01084                                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(npchans, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, offsetof(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>, name))) {
<a name="l01085"></a>01085                                     ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a>= newArm;
<a name="l01086"></a>01086                                 }
<a name="l01087"></a>01087                             }
<a name="l01088"></a>01088                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == newArm) {
<a name="l01089"></a>01089                                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(opchans, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, offsetof(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>, name))) {
<a name="l01090"></a>01090                                     ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a>= origArm;
<a name="l01091"></a>01091                                 }
<a name="l01092"></a>01092                             }
<a name="l01093"></a>01093                         }
<a name="l01094"></a>01094                     }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096                     <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>) {
<a name="l01097"></a>01097                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l01098"></a>01098                     }
<a name="l01099"></a>01099                 }
<a name="l01100"></a>01100             }
<a name="l01101"></a>01101         }
<a name="l01102"></a>01102         
<a name="l01103"></a>01103         <span class="comment">/* See if an object is parented to this armature */</span>
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> == origArm)) {
<a name="l01105"></a>01105             <span class="comment">/* Is object parented to a bone of this src armature? */</span>
<a name="l01106"></a>01106             <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0ed2df4a386ce2b22084aaaa701d73ff">partype</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa660de9e3216076e99f66fac72274ea0">PARBONE</a>) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>[0] != <span class="charliteral">&#39;\0&#39;</span>)) {
<a name="l01107"></a>01107                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(npchans, ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>, offsetof(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>, name))) {
<a name="l01108"></a>01108                     ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>= newArm;
<a name="l01109"></a>01109                 }
<a name="l01110"></a>01110             }
<a name="l01111"></a>01111         }
<a name="l01112"></a>01112     }   
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="comment">/* Helper function for armature separating - remove certain bones from the given armature </span>
<a name="l01116"></a>01116 <span class="comment"> *  sel: remove selected bones from the armature, otherwise the unselected bones are removed</span>
<a name="l01117"></a>01117 <span class="comment"> *  (ob is not in editmode)</span>
<a name="l01118"></a>01118 <span class="comment"> */</span>
<a name="l01119"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a05b2350ad26e777dd9f4c7bf248b6e72">01119</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a05b2350ad26e777dd9f4c7bf248b6e72">separate_armature_bones</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">short</span> sel) 
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01122"></a>01122     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchann;
<a name="l01123"></a>01123     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone;
<a name="l01124"></a>01124     
<a name="l01125"></a>01125     <span class="comment">/* make local set of editbones to manipulate here */</span>
<a name="l01126"></a>01126     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(ob);
<a name="l01127"></a>01127     
<a name="l01128"></a>01128     <span class="comment">/* go through pose-channels, checking if a bone should be removed */</span>
<a name="l01129"></a>01129     <span class="keywordflow">for</span> (pchan=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan=pchann) {
<a name="l01130"></a>01130         pchann= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>;
<a name="l01131"></a>01131         curbone= <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l01132"></a>01132         
<a name="l01133"></a>01133         <span class="comment">/* check if bone needs to be removed */</span>
<a name="l01134"></a>01134         <span class="keywordflow">if</span> ( (sel &amp;&amp; (curbone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)) ||
<a name="l01135"></a>01135              (!sel &amp;&amp; !(curbone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)) )
<a name="l01136"></a>01136         {
<a name="l01137"></a>01137             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo;
<a name="l01138"></a>01138             <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchn;
<a name="l01139"></a>01139             
<a name="l01140"></a>01140             <span class="comment">/* clear the bone-&gt;parent var of any bone that had this as its parent  */</span>
<a name="l01141"></a>01141             <span class="keywordflow">for</span> (ebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01142"></a>01142                 <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == curbone) {
<a name="l01143"></a>01143                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01144"></a>01144                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* this is needed to prevent random crashes with in ED_armature_from_edit */</span>
<a name="l01145"></a>01145                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l01146"></a>01146                 }
<a name="l01147"></a>01147             }
<a name="l01148"></a>01148             
<a name="l01149"></a>01149             <span class="comment">/* clear the pchan-&gt;parent var of any pchan that had this as its parent */</span>
<a name="l01150"></a>01150             <span class="keywordflow">for</span> (pchn= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchn; pchn=pchn-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01151"></a>01151                 <span class="keywordflow">if</span> (pchn-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a> == pchan)
<a name="l01152"></a>01152                     pchn-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01153"></a>01153             }
<a name="l01154"></a>01154             
<a name="l01155"></a>01155             <span class="comment">/* free any of the extra-data this pchan might have */</span>
<a name="l01156"></a>01156             <a class="code" href="../../d8/df5/BKE__action_8h.html#a5c5c36a7ec5f5e2ad9da713268de1872">free_pose_channel</a>(pchan);
<a name="l01157"></a>01157             <a class="code" href="../../d8/df5/BKE__action_8h.html#af13c0947ece98793cfba086d1b31815b">free_pose_channels_hash</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01158"></a>01158             
<a name="l01159"></a>01159             <span class="comment">/* get rid of unneeded bone */</span>
<a name="l01160"></a>01160             <a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">bone_free</a>(arm, curbone);
<a name="l01161"></a>01161             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>, pchan);
<a name="l01162"></a>01162         }
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164     
<a name="l01165"></a>01165     <span class="comment">/* exit editmode (recalculates pchans too) */</span>
<a name="l01166"></a>01166     <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(ob);
<a name="l01167"></a>01167     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 <span class="comment">/* separate selected bones into their armature */</span>
<a name="l01171"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af8124770c623f8cdaa835866a2a0ef5a">01171</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af8124770c623f8cdaa835866a2a0ef5a">separate_armature_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l01172"></a>01172 {
<a name="l01173"></a>01173     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01174"></a>01174     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01175"></a>01175     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l01176"></a>01176     <a class="code" href="../../de/de7/structObject.html">Object</a> *oldob, *newob;
<a name="l01177"></a>01177     <a class="code" href="../../d3/da9/structBase.html">Base</a> *oldbase, *newbase;
<a name="l01178"></a>01178     
<a name="l01179"></a>01179     <span class="comment">/* sanity checks */</span>
<a name="l01180"></a>01180     <span class="keywordflow">if</span> (obedit == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01181"></a>01181         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01182"></a>01182     
<a name="l01183"></a>01183     <span class="comment">/* set wait cursor in case this takes a while */</span>
<a name="l01184"></a>01184     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(1);
<a name="l01185"></a>01185     
<a name="l01186"></a>01186     <span class="comment">/* we are going to do this as follows (unlike every other instance of separate):</span>
<a name="l01187"></a>01187 <span class="comment">     *  1. exit editmode +posemode for active armature/base. Take note of what this is.</span>
<a name="l01188"></a>01188 <span class="comment">     *  2. duplicate base - BASACT is the new one now</span>
<a name="l01189"></a>01189 <span class="comment">     *  3. for each of the two armatures, enter editmode -&gt; remove appropriate bones -&gt; exit editmode + recalc</span>
<a name="l01190"></a>01190 <span class="comment">     *  4. fix constraint links</span>
<a name="l01191"></a>01191 <span class="comment">     *  5. make original armature active and enter editmode</span>
<a name="l01192"></a>01192 <span class="comment">     */</span>
<a name="l01193"></a>01193     
<a name="l01194"></a>01194     <span class="comment">/* 1) only edit-base selected */</span>
<a name="l01195"></a>01195     <span class="comment">// TODO: use context iterators for this?</span>
<a name="l01196"></a>01196     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, visible_bases) {
<a name="l01197"></a>01197         <span class="keywordflow">if</span> (base-&gt;object==obedit) base-&gt;flag |= 1;
<a name="l01198"></a>01198         <span class="keywordflow">else</span> base-&gt;flag &amp;= ~1;
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01201"></a>01201     
<a name="l01202"></a>01202     <span class="comment">/* 1) store starting settings and exit editmode */</span>
<a name="l01203"></a>01203     oldob= obedit;
<a name="l01204"></a>01204     oldbase= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a>;
<a name="l01205"></a>01205     oldob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550acfed9b4bf4a7e2d3c5ae0b3571e38950">OB_MODE_POSE</a>;
<a name="l01206"></a>01206     <span class="comment">//oldbase-&gt;flag &amp;= ~OB_POSEMODE;</span>
<a name="l01207"></a>01207     
<a name="l01208"></a>01208     <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(obedit);
<a name="l01209"></a>01209     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(obedit);
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     <span class="comment">/* 2) duplicate base */</span>
<a name="l01212"></a>01212     newbase= <a class="code" href="../../da/d7a/ED__object_8h.html#aa93e8afe3780f669ae8fe17af3ebcfe6">ED_object_add_duplicate</a>(bmain, scene, oldbase, <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a87c758ac7a109715fec9244d643d8262">USER_DUP_ARM</a>); <span class="comment">/* only duplicate linked armature */</span>
<a name="l01213"></a>01213     newob= newbase-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;     
<a name="l01214"></a>01214     newbase-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp;= ~<a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l01215"></a>01215     
<a name="l01216"></a>01216     
<a name="l01217"></a>01217     <span class="comment">/* 3) remove bones that shouldn&#39;t still be around on both armatures */</span>
<a name="l01218"></a>01218     <a class="code" href="../../de/dbc/editarmature_8c.html#a05b2350ad26e777dd9f4c7bf248b6e72">separate_armature_bones</a>(oldob, 1);
<a name="l01219"></a>01219     <a class="code" href="../../de/dbc/editarmature_8c.html#a05b2350ad26e777dd9f4c7bf248b6e72">separate_armature_bones</a>(newob, 0);
<a name="l01220"></a>01220     
<a name="l01221"></a>01221     
<a name="l01222"></a>01222     <span class="comment">/* 4) fix links before depsgraph flushes */</span> <span class="comment">// err... or after?</span>
<a name="l01223"></a>01223     <a class="code" href="../../de/dbc/editarmature_8c.html#aaf128d0018144e5ce942b1082b17a0fd">separated_armature_fix_links</a>(oldob, newob);
<a name="l01224"></a>01224     
<a name="l01225"></a>01225     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;oldob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);  <span class="comment">/* this is the original one */</span>
<a name="l01226"></a>01226     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;newob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);  <span class="comment">/* this is the separated one */</span>
<a name="l01227"></a>01227     
<a name="l01228"></a>01228     
<a name="l01229"></a>01229     <span class="comment">/* 5) restore original conditions */</span>
<a name="l01230"></a>01230     obedit= oldob;
<a name="l01231"></a>01231     
<a name="l01232"></a>01232     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(obedit);
<a name="l01233"></a>01233     
<a name="l01234"></a>01234     <span class="comment">/* note, notifier might evolve */</span>
<a name="l01235"></a>01235     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, obedit);
<a name="l01236"></a>01236     
<a name="l01237"></a>01237     <span class="comment">/* recalc/redraw + cleanup */</span>
<a name="l01238"></a>01238     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l01239"></a>01239     
<a name="l01240"></a>01240     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01243"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abd25bae32aa2184e2547cba26016265e">01243</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a15be8f468636613e32ad2fc205a9bc72">ARMATURE_OT_separate</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01244"></a>01244 {
<a name="l01245"></a>01245     <span class="comment">/* identifiers */</span>
<a name="l01246"></a>01246     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Separate Bones&quot;</span>;
<a name="l01247"></a>01247     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_separate&quot;</span>;
<a name="l01248"></a>01248     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Isolate selected bones into a separate armature&quot;</span>;
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     <span class="comment">/* callbacks */</span>
<a name="l01251"></a>01251     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a63ac1372a9efaaca8bec8660ff770026">WM_operator_confirm</a>;
<a name="l01252"></a>01252     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#af8124770c623f8cdaa835866a2a0ef5a">separate_armature_exec</a>;
<a name="l01253"></a>01253     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l01254"></a>01254     
<a name="l01255"></a>01255     <span class="comment">/* flags */</span>
<a name="l01256"></a>01256     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01257"></a>01257 }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 <span class="comment">/* **************** END tools on Editmode Armature **************** */</span>
<a name="l01260"></a>01260 <span class="comment">/* **************** PoseMode &amp; EditMode *************************** */</span>
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 <span class="comment">/* only for opengl selection indices */</span>
<a name="l01263"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a27a7a6985039c4bac30e76661c55b160">01263</a> <a class="code" href="../../de/de0/structBone.html">Bone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#afee1dd939954cf85c79af7ddf556473c">get_indexed_bone</a> (<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> index)
<a name="l01264"></a>01264 {
<a name="l01265"></a>01265     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01266"></a>01266     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01267"></a>01267     index&gt;&gt;=16;     <span class="comment">// bone selection codes use left 2 bytes</span>
<a name="l01268"></a>01268     
<a name="l01269"></a>01269     pchan= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>, index);
<a name="l01270"></a>01270     <span class="keywordflow">return</span> pchan ? pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01271"></a>01271 }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 <span class="comment">/* See if there are any selected bones in this buffer */</span>
<a name="l01274"></a>01274 <span class="comment">/* only bones from base are checked on */</span>
<a name="l01275"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af60e1140453df41a61a691547542c0a5">01275</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/dbc/editarmature_8c.html#af60e1140453df41a61a691547542c0a5">get_bone_from_selectbuffer</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d3/da9/structBase.html">Base</a> *base, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buffer, <span class="keywordtype">short</span> hits, <span class="keywordtype">short</span> findunsel)
<a name="l01276"></a>01276 {
<a name="l01277"></a>01277     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l01278"></a>01278     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01279"></a>01279     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l01280"></a>01280     <span class="keywordtype">void</span> *firstunSel=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *firstSel=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01281"></a>01281     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hitresult;
<a name="l01282"></a>01282     <span class="keywordtype">short</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, takeNext=0, sel;
<a name="l01283"></a>01283     
<a name="l01284"></a>01284     <span class="keywordflow">for</span> (i=0; i&lt; hits; i++) {
<a name="l01285"></a>01285         hitresult = buffer[3+(i*4)];
<a name="l01286"></a>01286         
<a name="l01287"></a>01287         <span class="keywordflow">if</span> (!(hitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#adff6e5e3d1803357e322a416cb8412a5">BONESEL_NOSEL</a>)) { <span class="comment">// -1</span>
<a name="l01288"></a>01288             <span class="keywordflow">if</span> (hitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a1af8055aa8b5c6fcc1ebb9f5c7e4c921">BONESEL_ANY</a>) {  <span class="comment">// to avoid including objects in selection</span>
<a name="l01289"></a>01289                 
<a name="l01290"></a>01290                 hitresult &amp;= ~(<a class="code" href="../../d1/d98/ED__armature_8h.html#a1af8055aa8b5c6fcc1ebb9f5c7e4c921">BONESEL_ANY</a>);
<a name="l01291"></a>01291                 <span class="comment">/* Determine what the current bone is */</span>
<a name="l01292"></a>01292                 <span class="keywordflow">if</span> (obedit==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>!=obedit) {
<a name="l01293"></a>01293                     <span class="comment">/* no singular posemode, so check for correct object */</span>
<a name="l01294"></a>01294                     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a89a67eef05b0a12dd3c9bd69600486de">selcol</a> == (hitresult &amp; 0xFFFF)) {
<a name="l01295"></a>01295                         bone = <a class="code" href="../../de/dbc/editarmature_8c.html#afee1dd939954cf85c79af7ddf556473c">get_indexed_bone</a>(base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>, hitresult);
<a name="l01296"></a>01296                         
<a name="l01297"></a>01297                         <span class="keywordflow">if</span> (findunsel)
<a name="l01298"></a>01298                             sel = (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l01299"></a>01299                         <span class="keywordflow">else</span>
<a name="l01300"></a>01300                             sel = !(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l01301"></a>01301                         
<a name="l01302"></a>01302                         data = bone;
<a name="l01303"></a>01303                     }
<a name="l01304"></a>01304                     <span class="keywordflow">else</span> {
<a name="l01305"></a>01305                         data= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01306"></a>01306                         sel= 0;
<a name="l01307"></a>01307                     }
<a name="l01308"></a>01308                 }
<a name="l01309"></a>01309                 <span class="keywordflow">else</span> {
<a name="l01310"></a>01310                     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01311"></a>01311                     
<a name="l01312"></a>01312                     ebone = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, hitresult);
<a name="l01313"></a>01313                     <span class="keywordflow">if</span> (findunsel)
<a name="l01314"></a>01314                         sel = (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l01315"></a>01315                     <span class="keywordflow">else</span>
<a name="l01316"></a>01316                         sel = !(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l01317"></a>01317                     
<a name="l01318"></a>01318                     data = ebone;
<a name="l01319"></a>01319                 }
<a name="l01320"></a>01320                 
<a name="l01321"></a>01321                 <span class="keywordflow">if</span> (data) {
<a name="l01322"></a>01322                     <span class="keywordflow">if</span> (sel) {
<a name="l01323"></a>01323                         <span class="keywordflow">if</span> (!firstSel) firstSel= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01324"></a>01324                         takeNext=1;
<a name="l01325"></a>01325                     }
<a name="l01326"></a>01326                     <span class="keywordflow">else</span> {
<a name="l01327"></a>01327                         <span class="keywordflow">if</span> (!firstunSel)
<a name="l01328"></a>01328                             firstunSel=<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01329"></a>01329                         <span class="keywordflow">if</span> (takeNext)
<a name="l01330"></a>01330                             <span class="keywordflow">return</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01331"></a>01331                     }
<a name="l01332"></a>01332                 }
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334         }
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336     
<a name="l01337"></a>01337     <span class="keywordflow">if</span> (firstunSel)
<a name="l01338"></a>01338         <span class="keywordflow">return</span> firstunSel;
<a name="l01339"></a>01339     <span class="keywordflow">else</span> 
<a name="l01340"></a>01340         <span class="keywordflow">return</span> firstSel;
<a name="l01341"></a>01341 }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 <span class="comment">/* used by posemode as well editmode */</span>
<a name="l01346"></a>01346 <span class="comment">/* only checks scene-&gt;basact! */</span>
<a name="l01347"></a>01347 <span class="comment">/* x and y are mouse coords (area space) */</span>
<a name="l01348"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">01348</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">get_nearest_bone</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keywordtype">short</span> findunsel, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01349"></a>01349 {
<a name="l01350"></a>01350     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> vc;
<a name="l01351"></a>01351     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> rect;
<a name="l01352"></a>01352     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffer[<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6bf150a3c83492b0adab9ea7068a3f86">MAXPICKBUF</a>];
<a name="l01353"></a>01353     <span class="keywordtype">short</span> hits;
<a name="l01354"></a>01354     
<a name="l01355"></a>01355     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vc);
<a name="l01356"></a>01356     
<a name="l01357"></a>01357     <span class="comment">// rect.xmin = ... mouseco!</span>
<a name="l01358"></a>01358     rect.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = rect.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = x;
<a name="l01359"></a>01359     rect.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = rect.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = y;
<a name="l01360"></a>01360     
<a name="l01361"></a>01361     glInitNames();
<a name="l01362"></a>01362     hits= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a0f44a733a5f482f839faaafa07e4f3da">view3d_opengl_select</a>(&amp;vc, buffer, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6bf150a3c83492b0adab9ea7068a3f86">MAXPICKBUF</a>, &amp;rect);
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     <span class="keywordflow">if</span> (hits&gt;0)
<a name="l01365"></a>01365         <span class="keywordflow">return</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af60e1140453df41a61a691547542c0a5">get_bone_from_selectbuffer</a>(vc.<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>, vc.<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>, buffer, hits, findunsel);
<a name="l01366"></a>01366     
<a name="l01367"></a>01367     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 <span class="comment">/* Get the first available child of an editbone */</span>
<a name="l01371"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a4ce6c25dd697792d45fa22df846b4302">01371</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#a4ce6c25dd697792d45fa22df846b4302">editbone_get_child</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *pabone, <span class="keywordtype">short</span> use_visibility)
<a name="l01372"></a>01372 {
<a name="l01373"></a>01373     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone, *chbone=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01374"></a>01374     
<a name="l01375"></a>01375     <span class="keywordflow">for</span> (curbone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curbone; curbone= curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01376"></a>01376         <span class="keywordflow">if</span> (curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == pabone) {
<a name="l01377"></a>01377             <span class="keywordflow">if</span> (use_visibility) {
<a name="l01378"></a>01378                 <span class="keywordflow">if</span> ((arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) &amp;&amp; !(pabone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>)) {
<a name="l01379"></a>01379                     chbone = curbone;
<a name="l01380"></a>01380                 }
<a name="l01381"></a>01381             }
<a name="l01382"></a>01382             <span class="keywordflow">else</span>
<a name="l01383"></a>01383                 chbone = curbone;
<a name="l01384"></a>01384         }
<a name="l01385"></a>01385     }
<a name="l01386"></a>01386     
<a name="l01387"></a>01387     <span class="keywordflow">return</span> chbone;
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 <span class="comment">/* **************** END PoseMode &amp; EditMode *************************** */</span>
<a name="l01391"></a>01391 <span class="comment">/* **************** Posemode stuff ********************** */</span>
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 
<a name="l01394"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af2c74c3a972f4a44ed1e230b0e1c5171">01394</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af2c74c3a972f4a44ed1e230b0e1c5171">selectconnected_posebonechildren</a> (<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">int</span> extend)
<a name="l01395"></a>01395 {
<a name="l01396"></a>01396     <a class="code" href="../../de/de0/structBone.html">Bone</a> *curBone;
<a name="l01397"></a>01397     
<a name="l01398"></a>01398     <span class="comment">/* stop when unconnected child is encontered, or when unselectable bone is encountered */</span>
<a name="l01399"></a>01399     <span class="keywordflow">if</span> (!(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) || (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>))
<a name="l01400"></a>01400         <span class="keywordflow">return</span>;
<a name="l01401"></a>01401     
<a name="l01402"></a>01402         <span class="comment">// XXX old cruft! use notifiers instead</span>
<a name="l01403"></a>01403     <span class="comment">//select_actionchannel_by_name (ob-&gt;action, bone-&gt;name, !(shift));</span>
<a name="l01404"></a>01404     
<a name="l01405"></a>01405     <span class="keywordflow">if</span> (extend)
<a name="l01406"></a>01406         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l01407"></a>01407     <span class="keywordflow">else</span>
<a name="l01408"></a>01408         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l01409"></a>01409     
<a name="l01410"></a>01410     <span class="keywordflow">for</span> (curBone=bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>)
<a name="l01411"></a>01411         <a class="code" href="../../de/dbc/editarmature_8c.html#af2c74c3a972f4a44ed1e230b0e1c5171">selectconnected_posebonechildren</a>(ob, curBone, extend);
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 <span class="comment">/* within active object context */</span>
<a name="l01415"></a>01415 <span class="comment">/* previously known as &quot;selectconnected_posearmature&quot; */</span>
<a name="l01416"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a8f933577a72f2e03aabfcfe36acd72f6">01416</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8f933577a72f2e03aabfcfe36acd72f6">pose_select_connected_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01417"></a>01417 {
<a name="l01418"></a>01418     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l01419"></a>01419     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, *curBone, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01420"></a>01420     <span class="keywordtype">int</span> extend= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;extend&quot;</span>);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l01423"></a>01423     
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (extend)
<a name="l01425"></a>01425         bone= <a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">get_nearest_bone</a>(C, 0, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l01426"></a>01426     <span class="keywordflow">else</span>
<a name="l01427"></a>01427         bone= <a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">get_nearest_bone</a>(C, 1, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l01428"></a>01428     
<a name="l01429"></a>01429     <span class="keywordflow">if</span> (!bone)
<a name="l01430"></a>01430         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01431"></a>01431     
<a name="l01432"></a>01432     <span class="comment">/* Select parents */</span>
<a name="l01433"></a>01433     <span class="keywordflow">for</span> (curBone=bone; curBone; curBone=<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>) {
<a name="l01434"></a>01434         <span class="comment">/* ignore bone if cannot be selected */</span>
<a name="l01435"></a>01435         <span class="keywordflow">if</span> ((curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>) == 0) { 
<a name="l01436"></a>01436                 <span class="comment">// XXX old cruft! use notifiers instead</span>
<a name="l01437"></a>01437             <span class="comment">//select_actionchannel_by_name (ob-&gt;action, curBone-&gt;name, !(shift));</span>
<a name="l01438"></a>01438             
<a name="l01439"></a>01439             <span class="keywordflow">if</span> (extend)
<a name="l01440"></a>01440                 curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l01441"></a>01441             <span class="keywordflow">else</span>
<a name="l01442"></a>01442                 curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l01443"></a>01443             
<a name="l01444"></a>01444             <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)
<a name="l01445"></a>01445                 next=curBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>;
<a name="l01446"></a>01446             <span class="keywordflow">else</span>
<a name="l01447"></a>01447                 next=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01448"></a>01448         }
<a name="l01449"></a>01449         <span class="keywordflow">else</span>
<a name="l01450"></a>01450             next= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452     
<a name="l01453"></a>01453     <span class="comment">/* Select children */</span>
<a name="l01454"></a>01454     <span class="keywordflow">for</span> (curBone=bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=next)
<a name="l01455"></a>01455         <a class="code" href="../../de/dbc/editarmature_8c.html#af2c74c3a972f4a44ed1e230b0e1c5171">selectconnected_posebonechildren</a>(ob, curBone, extend);
<a name="l01456"></a>01456     
<a name="l01457"></a>01457     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01460"></a>01460 }
<a name="l01461"></a>01461 
<a name="l01462"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a7148c694504a0deec4e94da2a8af89c2">01462</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a7148c694504a0deec4e94da2a8af89c2">pose_select_linked_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l01463"></a>01463 {
<a name="l01464"></a>01464     <span class="keywordflow">return</span> ( <a class="code" href="../../d1/d12/ED__screen_8h.html#a77a2371bebf89db17c2e83075447972b">ED_operator_view3d_active</a>(C) &amp;&amp; <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>(C) );
<a name="l01465"></a>01465 }
<a name="l01466"></a>01466 
<a name="l01467"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aecc2eaf95fceb2cedf1604aa797dbc04">01467</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a626a3898acd1aadc2bfe1b8ed6b7d305">POSE_OT_select_linked</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01468"></a>01468 {
<a name="l01469"></a>01469     <span class="comment">/* identifiers */</span>
<a name="l01470"></a>01470     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Select Connected&quot;</span>;
<a name="l01471"></a>01471     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_select_linked&quot;</span>;
<a name="l01472"></a>01472     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Select bones related to selected ones by parent/child relationships&quot;</span>;
<a name="l01473"></a>01473     
<a name="l01474"></a>01474     <span class="comment">/* api callbacks */</span>
<a name="l01475"></a>01475     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01476"></a>01476     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a8f933577a72f2e03aabfcfe36acd72f6">pose_select_connected_invoke</a>;
<a name="l01477"></a>01477     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a7148c694504a0deec4e94da2a8af89c2">pose_select_linked_poll</a>;
<a name="l01478"></a>01478     
<a name="l01479"></a>01479     <span class="comment">/* flags */</span>
<a name="l01480"></a>01480     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01481"></a>01481     
<a name="l01482"></a>01482     <span class="comment">/* props */</span> 
<a name="l01483"></a>01483     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;extend&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Extend&quot;</span>, <span class="stringliteral">&quot;Extend selection instead of deselecting everything first&quot;</span>);
<a name="l01484"></a>01484 }
<a name="l01485"></a>01485 
<a name="l01486"></a>01486 <span class="comment">/* **************** END Posemode stuff ********************** */</span>
<a name="l01487"></a>01487 <span class="comment">/* **************** EditMode stuff ********************** */</span>
<a name="l01488"></a>01488 
<a name="l01489"></a>01489 <span class="comment">/* called in space.c */</span>
<a name="l01490"></a>01490 <span class="comment">/* previously &quot;selectconnected_armature&quot; */</span>
<a name="l01491"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0715ecdc8a42ef8bb6320091f45e3a51">01491</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a0715ecdc8a42ef8bb6320091f45e3a51">armature_select_linked_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01492"></a>01492 {
<a name="l01493"></a>01493     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l01494"></a>01494     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone, *curBone, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01495"></a>01495     <span class="keywordtype">int</span> extend= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;extend&quot;</span>);
<a name="l01496"></a>01496     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l01497"></a>01497     arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (extend)
<a name="l01502"></a>01502         bone= <a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">get_nearest_bone</a>(C, 0, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l01503"></a>01503     <span class="keywordflow">else</span>
<a name="l01504"></a>01504         bone= <a class="code" href="../../de/dbc/editarmature_8c.html#af3b9f7e2981e891c8eaf30e54e1525c1">get_nearest_bone</a>(C, 1, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     <span class="keywordflow">if</span> (!bone)
<a name="l01507"></a>01507         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="comment">/* Select parents */</span>
<a name="l01510"></a>01510     <span class="keywordflow">for</span> (curBone=bone; curBone; curBone=<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>) {
<a name="l01511"></a>01511         <span class="keywordflow">if</span> ((curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>) == 0) {
<a name="l01512"></a>01512             <span class="keywordflow">if</span> (extend) {
<a name="l01513"></a>01513                 curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01514"></a>01514             }
<a name="l01515"></a>01515             <span class="keywordflow">else</span> {
<a name="l01516"></a>01516                 curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01517"></a>01517             }
<a name="l01518"></a>01518         }
<a name="l01519"></a>01519         
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)
<a name="l01521"></a>01521             next=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l01522"></a>01522         <span class="keywordflow">else</span>
<a name="l01523"></a>01523             next=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     <span class="comment">/* Select children */</span>
<a name="l01527"></a>01527     <span class="keywordflow">while</span> (bone) {
<a name="l01528"></a>01528         <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=next) {
<a name="l01529"></a>01529             next = curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>;
<a name="l01530"></a>01530             <span class="keywordflow">if</span> ((curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == bone) &amp;&amp; (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0) {
<a name="l01531"></a>01531                 <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) {
<a name="l01532"></a>01532                     <span class="keywordflow">if</span> (extend)
<a name="l01533"></a>01533                         curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01534"></a>01534                     <span class="keywordflow">else</span>
<a name="l01535"></a>01535                         curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01536"></a>01536                     bone=curBone;
<a name="l01537"></a>01537                     <span class="keywordflow">break</span>;
<a name="l01538"></a>01538                 }
<a name="l01539"></a>01539                 <span class="keywordflow">else</span> { 
<a name="l01540"></a>01540                     bone=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01541"></a>01541                     <span class="keywordflow">break</span>;
<a name="l01542"></a>01542                 }
<a name="l01543"></a>01543             }
<a name="l01544"></a>01544         }
<a name="l01545"></a>01545         <span class="keywordflow">if</span> (!curBone)
<a name="l01546"></a>01546             bone=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01547"></a>01547     }
<a name="l01548"></a>01548     
<a name="l01549"></a>01549     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01550"></a>01550     
<a name="l01551"></a>01551     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l01552"></a>01552     
<a name="l01553"></a>01553     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01554"></a>01554 }
<a name="l01555"></a>01555 
<a name="l01556"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a2b05ad36a1df92e7615927988d239fb0">01556</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a2b05ad36a1df92e7615927988d239fb0">armature_select_linked_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l01557"></a>01557 {
<a name="l01558"></a>01558     <span class="keywordflow">return</span> ( <a class="code" href="../../d1/d12/ED__screen_8h.html#a77a2371bebf89db17c2e83075447972b">ED_operator_view3d_active</a>(C) &amp;&amp; <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>(C) );
<a name="l01559"></a>01559 }
<a name="l01560"></a>01560 
<a name="l01561"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab146528d0cca1cf3c7635c7204bc6cb1">01561</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a699998facec311d1defe732a75bc3b15">ARMATURE_OT_select_linked</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01562"></a>01562 {
<a name="l01563"></a>01563     <span class="comment">/* identifiers */</span>
<a name="l01564"></a>01564     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Select Connected&quot;</span>;
<a name="l01565"></a>01565     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_select_linked&quot;</span>;
<a name="l01566"></a>01566     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Select bones related to selected ones by parent/child relationships&quot;</span>;
<a name="l01567"></a>01567     
<a name="l01568"></a>01568     <span class="comment">/* api callbacks */</span>
<a name="l01569"></a>01569     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01570"></a>01570     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a0715ecdc8a42ef8bb6320091f45e3a51">armature_select_linked_invoke</a>;
<a name="l01571"></a>01571     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a2b05ad36a1df92e7615927988d239fb0">armature_select_linked_poll</a>;
<a name="l01572"></a>01572     
<a name="l01573"></a>01573     <span class="comment">/* flags */</span>
<a name="l01574"></a>01574     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01575"></a>01575     
<a name="l01576"></a>01576     <span class="comment">/* properties s*/</span>
<a name="l01577"></a>01577     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;extend&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Extend&quot;</span>, <span class="stringliteral">&quot;Extend selection instead of deselecting everything first&quot;</span>);
<a name="l01578"></a>01578 }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 <span class="comment">/* does bones and points */</span>
<a name="l01581"></a>01581 <span class="comment">/* note that BONE ROOT only gets drawn for root bones (or without IK) */</span>
<a name="l01582"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac66b0ed7004355b82924666ef0024779">01582</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#ac66b0ed7004355b82924666ef0024779">get_nearest_editbonepoint</a> (<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <span class="keywordtype">int</span> findunsel, <span class="keywordtype">int</span> *selmask)
<a name="l01583"></a>01583 {
<a name="l01584"></a>01584     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l01585"></a>01585     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> rect;
<a name="l01586"></a>01586     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffer[<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6bf150a3c83492b0adab9ea7068a3f86">MAXPICKBUF</a>];
<a name="l01587"></a>01587     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hitresult, besthitresult=<a class="code" href="../../d1/d98/ED__armature_8h.html#adff6e5e3d1803357e322a416cb8412a5">BONESEL_NOSEL</a>;
<a name="l01588"></a>01588     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, mindep= 4;
<a name="l01589"></a>01589     <span class="keywordtype">short</span> hits;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     glInitNames();
<a name="l01592"></a>01592     
<a name="l01593"></a>01593     rect.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = mval[0]-5;
<a name="l01594"></a>01594     rect.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = mval[0]+5;
<a name="l01595"></a>01595     rect.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = mval[1]-5;
<a name="l01596"></a>01596     rect.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = mval[1]+5;
<a name="l01597"></a>01597     
<a name="l01598"></a>01598     hits= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a0f44a733a5f482f839faaafa07e4f3da">view3d_opengl_select</a>(vc, buffer, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6bf150a3c83492b0adab9ea7068a3f86">MAXPICKBUF</a>, &amp;rect);
<a name="l01599"></a>01599     <span class="keywordflow">if</span> (hits==0) {
<a name="l01600"></a>01600         rect.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = mval[0]-12;
<a name="l01601"></a>01601         rect.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = mval[0]+12;
<a name="l01602"></a>01602         rect.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = mval[1]-12;
<a name="l01603"></a>01603         rect.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = mval[1]+12;
<a name="l01604"></a>01604         hits= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a0f44a733a5f482f839faaafa07e4f3da">view3d_opengl_select</a>(vc, buffer, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6bf150a3c83492b0adab9ea7068a3f86">MAXPICKBUF</a>, &amp;rect);
<a name="l01605"></a>01605     }
<a name="l01606"></a>01606     <span class="comment">/* See if there are any selected bones in this group */</span>
<a name="l01607"></a>01607     <span class="keywordflow">if</span> (hits&gt;0) {
<a name="l01608"></a>01608         
<a name="l01609"></a>01609         <span class="keywordflow">if</span> (hits==1) {
<a name="l01610"></a>01610             <span class="keywordflow">if</span> (!(buffer[3] &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#adff6e5e3d1803357e322a416cb8412a5">BONESEL_NOSEL</a>)) 
<a name="l01611"></a>01611                 besthitresult= buffer[3];
<a name="l01612"></a>01612         }
<a name="l01613"></a>01613         <span class="keywordflow">else</span> {
<a name="l01614"></a>01614             <span class="keywordflow">for</span> (i=0; i&lt; hits; i++) {
<a name="l01615"></a>01615                 hitresult= buffer[3+(i*4)];
<a name="l01616"></a>01616                 <span class="keywordflow">if</span> (!(hitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#adff6e5e3d1803357e322a416cb8412a5">BONESEL_NOSEL</a>)) {
<a name="l01617"></a>01617                     <span class="keywordtype">int</span> dep;
<a name="l01618"></a>01618                     
<a name="l01619"></a>01619                     ebone = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(edbo, hitresult &amp; ~<a class="code" href="../../d1/d98/ED__armature_8h.html#a1af8055aa8b5c6fcc1ebb9f5c7e4c921">BONESEL_ANY</a>);
<a name="l01620"></a>01620                     
<a name="l01621"></a>01621                     <span class="comment">/* clicks on bone points get advantage */</span>
<a name="l01622"></a>01622                     <span class="keywordflow">if</span> ( hitresult &amp; (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2705489681b2cb4f0204ce1e532dab42">BONESEL_ROOT</a>|<a class="code" href="../../d1/d98/ED__armature_8h.html#a6ff4362835773728b70b6b94af894b76">BONESEL_TIP</a>)) {
<a name="l01623"></a>01623                         <span class="comment">/* but also the unselected one */</span>
<a name="l01624"></a>01624                         <span class="keywordflow">if</span> (findunsel) {
<a name="l01625"></a>01625                             <span class="keywordflow">if</span> ( (hitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a2705489681b2cb4f0204ce1e532dab42">BONESEL_ROOT</a>) &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>)==0) 
<a name="l01626"></a>01626                                 dep= 1;
<a name="l01627"></a>01627                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (hitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a6ff4362835773728b70b6b94af894b76">BONESEL_TIP</a>) &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>)==0) 
<a name="l01628"></a>01628                                 dep= 1;
<a name="l01629"></a>01629                             <span class="keywordflow">else</span> 
<a name="l01630"></a>01630                                 dep= 2;
<a name="l01631"></a>01631                         }
<a name="l01632"></a>01632                         <span class="keywordflow">else</span> dep= 2;
<a name="l01633"></a>01633                     }
<a name="l01634"></a>01634                     <span class="keywordflow">else</span> {
<a name="l01635"></a>01635                         <span class="comment">/* bone found */</span>
<a name="l01636"></a>01636                         <span class="keywordflow">if</span> (findunsel) {
<a name="l01637"></a>01637                             <span class="keywordflow">if</span> ((ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)==0)
<a name="l01638"></a>01638                                 dep= 2;
<a name="l01639"></a>01639                             <span class="keywordflow">else</span>
<a name="l01640"></a>01640                                 dep= 3;
<a name="l01641"></a>01641                         }
<a name="l01642"></a>01642                         <span class="keywordflow">else</span> dep= 3;
<a name="l01643"></a>01643                     }
<a name="l01644"></a>01644                     <span class="keywordflow">if</span> (dep &lt; mindep) {
<a name="l01645"></a>01645                         mindep= dep;
<a name="l01646"></a>01646                         besthitresult= hitresult;
<a name="l01647"></a>01647                     }
<a name="l01648"></a>01648                 }
<a name="l01649"></a>01649             }
<a name="l01650"></a>01650         }
<a name="l01651"></a>01651         
<a name="l01652"></a>01652         <span class="keywordflow">if</span> (!(besthitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#adff6e5e3d1803357e322a416cb8412a5">BONESEL_NOSEL</a>)) {
<a name="l01653"></a>01653             
<a name="l01654"></a>01654             ebone= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(edbo, besthitresult &amp; ~<a class="code" href="../../d1/d98/ED__armature_8h.html#a1af8055aa8b5c6fcc1ebb9f5c7e4c921">BONESEL_ANY</a>);
<a name="l01655"></a>01655             
<a name="l01656"></a>01656             *selmask = 0;
<a name="l01657"></a>01657             <span class="keywordflow">if</span> (besthitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a2705489681b2cb4f0204ce1e532dab42">BONESEL_ROOT</a>)
<a name="l01658"></a>01658                 *selmask |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l01659"></a>01659             <span class="keywordflow">if</span> (besthitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a6ff4362835773728b70b6b94af894b76">BONESEL_TIP</a>)
<a name="l01660"></a>01660                 *selmask |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01661"></a>01661             <span class="keywordflow">if</span> (besthitresult &amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#a88d3ae76b815e50c41557107340e4c4f">BONESEL_BONE</a>)
<a name="l01662"></a>01662                 *selmask |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l01663"></a>01663             <span class="keywordflow">return</span> ebone;
<a name="l01664"></a>01664         }
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666     *selmask = 0;
<a name="l01667"></a>01667     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01668"></a>01668 }
<a name="l01669"></a>01669 
<a name="l01670"></a>01670 <span class="comment">/* previously delete_armature */</span>
<a name="l01671"></a>01671 <span class="comment">/* only editmode! */</span>
<a name="l01672"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a7c9806f375926ae8d6dd4fa7da99741e">01672</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a7c9806f375926ae8d6dd4fa7da99741e">armature_delete_selected_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l01673"></a>01673 {
<a name="l01674"></a>01674     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l01675"></a>01675     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *curBone, *ebone_next;
<a name="l01676"></a>01676     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l01677"></a>01677     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C); <span class="comment">// XXX get from context</span>
<a name="l01678"></a>01678     arm = obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     <span class="comment">/* cancel if nothing selected */</span>
<a name="l01681"></a>01681     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_bones) == 0)
<a name="l01682"></a>01682         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01683"></a>01683     
<a name="l01684"></a>01684     <a class="code" href="../../de/dbc/editarmature_8c.html#a894de3351f0072247eb3f393d5e936ad">armature_select_mirrored</a>(arm);
<a name="l01685"></a>01685     
<a name="l01686"></a>01686     <span class="comment">/*  First erase any associated pose channel */</span>
<a name="l01687"></a>01687     <span class="keywordflow">if</span> (obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) {
<a name="l01688"></a>01688         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchan_next;
<a name="l01689"></a>01689         <span class="keywordflow">for</span> (pchan=obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan_next) {
<a name="l01690"></a>01690             pchan_next= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>;
<a name="l01691"></a>01691             curBone = <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l01692"></a>01692             
<a name="l01693"></a>01693             <span class="keywordflow">if</span> (curBone &amp;&amp; (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) &amp;&amp; (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>)) {
<a name="l01694"></a>01694                 <a class="code" href="../../d8/df5/BKE__action_8h.html#a5c5c36a7ec5f5e2ad9da713268de1872">free_pose_channel</a>(pchan);
<a name="l01695"></a>01695                 <a class="code" href="../../d8/df5/BKE__action_8h.html#af13c0947ece98793cfba086d1b31815b">free_pose_channels_hash</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01696"></a>01696                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a> (&amp;obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>, pchan);
<a name="l01697"></a>01697             }
<a name="l01698"></a>01698             <span class="keywordflow">else</span> {
<a name="l01699"></a>01699                 <span class="keywordflow">for</span> (con= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l01700"></a>01700                     <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l01701"></a>01701                     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01702"></a>01702                     <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l01703"></a>01703                     
<a name="l01704"></a>01704                     <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l01705"></a>01705                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l01706"></a>01706                         
<a name="l01707"></a>01707                         <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l01708"></a>01708                             <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == obedit) {
<a name="l01709"></a>01709                                 <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0]) {
<a name="l01710"></a>01710                                     curBone = <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>);
<a name="l01711"></a>01711                                     <span class="keywordflow">if</span> (curBone &amp;&amp; (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) &amp;&amp; (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>)) {
<a name="l01712"></a>01712                                         con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> |= <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efdac624d1811979843b913fe2a7c3833c53">CONSTRAINT_DISABLE</a>;
<a name="l01713"></a>01713                                         ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0]= 0;
<a name="l01714"></a>01714                                     }
<a name="l01715"></a>01715                                 }
<a name="l01716"></a>01716                             }
<a name="l01717"></a>01717                         }
<a name="l01718"></a>01718                         
<a name="l01719"></a>01719                         <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l01720"></a>01720                             cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l01721"></a>01721                     }
<a name="l01722"></a>01722                 }
<a name="l01723"></a>01723             }
<a name="l01724"></a>01724         }
<a name="l01725"></a>01725     }
<a name="l01726"></a>01726     
<a name="l01727"></a>01727     
<a name="l01728"></a>01728     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone= ebone_next) {
<a name="l01729"></a>01729         ebone_next= curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>;
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) {
<a name="l01731"></a>01731             <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l01732"></a>01732                 <span class="keywordflow">if</span> (curBone==arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01733"></a>01733                 <a class="code" href="../../de/dbc/editarmature_8c.html#a7c373891630bb74f110cd6743cda92b6">ED_armature_edit_bone_remove</a>(arm, curBone);
<a name="l01734"></a>01734             }
<a name="l01735"></a>01735         }
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737     
<a name="l01738"></a>01738     
<a name="l01739"></a>01739     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0b32f1bbe98269ee9b28a20d8e4091dc">01746</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a61240cd8ce351dc45f32420615562a6e">ARMATURE_OT_delete</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01747"></a>01747 {
<a name="l01748"></a>01748     <span class="comment">/* identifiers */</span>
<a name="l01749"></a>01749     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Delete Selected Bone(s)&quot;</span>;
<a name="l01750"></a>01750     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_delete&quot;</span>;
<a name="l01751"></a>01751     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Remove selected bones from the armature&quot;</span>;
<a name="l01752"></a>01752     
<a name="l01753"></a>01753     <span class="comment">/* api callbacks */</span>
<a name="l01754"></a>01754     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a63ac1372a9efaaca8bec8660ff770026">WM_operator_confirm</a>;
<a name="l01755"></a>01755     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a7c9806f375926ae8d6dd4fa7da99741e">armature_delete_selected_exec</a>;
<a name="l01756"></a>01756     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l01757"></a>01757     
<a name="l01758"></a>01758     <span class="comment">/* flags */</span>
<a name="l01759"></a>01759     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01760"></a>01760 }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="comment">/* toggle==0: deselect</span>
<a name="l01763"></a>01763 <span class="comment"> * toggle==1: swap (based on test)</span>
<a name="l01764"></a>01764 <span class="comment"> * toggle==2: swap (no test), CURRENTLY UNUSED</span>
<a name="l01765"></a>01765 <span class="comment"> */</span>
<a name="l01766"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#ac803dc65978bc09d4aad6012f2e4a0dc">01766</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a6e29e50cb8f7692065a1bc44fe80cfcf">ED_armature_deselect_all</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <span class="keywordtype">int</span> toggle)
<a name="l01767"></a>01767 {
<a name="l01768"></a>01768     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01769"></a>01769     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *eBone;
<a name="l01770"></a>01770     <span class="keywordtype">int</span>         sel=1;
<a name="l01771"></a>01771     
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (toggle==1) {
<a name="l01773"></a>01773         <span class="comment">/* Determine if there are any selected bones</span>
<a name="l01774"></a>01774 <span class="comment">         * and therefore whether we are selecting or deselecting */</span>
<a name="l01775"></a>01775         <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;eBone;eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01776"></a>01776             <span class="comment">//          if (arm-&gt;layer &amp; eBone-&gt;layer) {</span>
<a name="l01777"></a>01777             <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>)) {
<a name="l01778"></a>01778                 sel=0;
<a name="l01779"></a>01779                 <span class="keywordflow">break</span>;
<a name="l01780"></a>01780             }
<a name="l01781"></a>01781             <span class="comment">//          }</span>
<a name="l01782"></a>01782         }
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784     <span class="keywordflow">else</span> sel= toggle;
<a name="l01785"></a>01785     
<a name="l01786"></a>01786     <span class="comment">/*  Set the flags */</span>
<a name="l01787"></a>01787     <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;eBone;eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01788"></a>01788         <span class="keywordflow">if</span> (sel==2) {
<a name="l01789"></a>01789             <span class="comment">/* invert selection of bone */</span>
<a name="l01790"></a>01790             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, eBone)) {
<a name="l01791"></a>01791                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> ^= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01792"></a>01792                 <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>==eBone)
<a name="l01793"></a>01793                     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01794"></a>01794             }
<a name="l01795"></a>01795         }
<a name="l01796"></a>01796         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sel==1) {
<a name="l01797"></a>01797             <span class="comment">/* select bone */</span>
<a name="l01798"></a>01798             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, eBone)) {
<a name="l01799"></a>01799                 eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01800"></a>01800                 <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>)
<a name="l01801"></a>01801                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l01802"></a>01802             }
<a name="l01803"></a>01803         }
<a name="l01804"></a>01804         <span class="keywordflow">else</span> {
<a name="l01805"></a>01805             <span class="comment">/* deselect bone */</span>
<a name="l01806"></a>01806             eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01807"></a>01807             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>==eBone)
<a name="l01808"></a>01808                 arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01809"></a>01809         }
<a name="l01810"></a>01810     }
<a name="l01811"></a>01811     
<a name="l01812"></a>01812     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01813"></a>01813 }
<a name="l01814"></a>01814 
<a name="l01815"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#aa2f0f85a48f0b74f06b130a3a7bea6d3">01815</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a9dbe9cfa7d6fc440c50e3ad95e24372d">ED_armature_deselect_all_visible</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit)
<a name="l01816"></a>01816 {
<a name="l01817"></a>01817     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01818"></a>01818     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *ebone;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820     <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01821"></a>01821         <span class="comment">/* first and foremost, bone must be visible and selected */</span>
<a name="l01822"></a>01822         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone) &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0) {
<a name="l01823"></a>01823             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01824"></a>01824         }
<a name="l01825"></a>01825     }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01828"></a>01828 }
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 <span class="comment">/* accounts for connected parents */</span>
<a name="l01831"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a17af5211bd091413169736c5e81713ae">01831</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a17af5211bd091413169736c5e81713ae">ebone_select_flag</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone)
<a name="l01832"></a>01832 {
<a name="l01833"></a>01833     <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l01834"></a>01834         <span class="keywordflow">return</span> ((ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) ? <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a> : 0) | (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>));
<a name="l01835"></a>01835     }
<a name="l01836"></a>01836     <span class="keywordflow">else</span> {
<a name="l01837"></a>01837         <span class="keywordflow">return</span> ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l01838"></a>01838     }
<a name="l01839"></a>01839 }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841 <span class="comment">/* context: editmode armature in view3d */</span>
<a name="l01842"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#ab6b80dd008072bda96d11ff0dc8ce510">01842</a> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ae0c25cc5dc5ae11fb26ed8098c475666">mouse_armature</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">int</span> extend)
<a name="l01843"></a>01843 {
<a name="l01844"></a>01844     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l01845"></a>01845     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01846"></a>01846     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> vc;
<a name="l01847"></a>01847     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *nearBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01848"></a>01848     <span class="keywordtype">int</span> selmask;
<a name="l01849"></a>01849 
<a name="l01850"></a>01850     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vc);
<a name="l01851"></a>01851     
<a name="l01852"></a>01852     <a class="code" href="../../dc/d26/armature__intern_8h.html#a2c18e6e03183fdcec9562e025dae13a4">BIF_sk_selectStroke</a>(C, mval, extend);
<a name="l01853"></a>01853     
<a name="l01854"></a>01854     nearBone= <a class="code" href="../../de/dbc/editarmature_8c.html#ac66b0ed7004355b82924666ef0024779">get_nearest_editbonepoint</a>(&amp;vc, mval, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, 1, &amp;selmask);
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (nearBone) {
<a name="l01856"></a>01856 
<a name="l01857"></a>01857         <span class="keywordflow">if</span> (!extend)
<a name="l01858"></a>01858             <a class="code" href="../../de/dbc/editarmature_8c.html#a6e29e50cb8f7692065a1bc44fe80cfcf">ED_armature_deselect_all</a>(obedit, 0);
<a name="l01859"></a>01859         
<a name="l01860"></a>01860         <span class="comment">/* by definition the non-root connected bones have no root point drawn,</span>
<a name="l01861"></a>01861 <span class="comment">         * so a root selection needs to be delivered to the parent tip */</span>
<a name="l01862"></a>01862         
<a name="l01863"></a>01863         <span class="keywordflow">if</span> (selmask &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l01864"></a>01864             <span class="keywordflow">if</span> (nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l01865"></a>01865                 <span class="comment">/* click in a chain */</span>
<a name="l01866"></a>01866                 <span class="keywordflow">if</span> (extend) {
<a name="l01867"></a>01867                     <span class="comment">/* hold shift inverts this bone&#39;s selection */</span>
<a name="l01868"></a>01868                     <span class="keywordflow">if</span> (nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; BONE_SELECTED) {
<a name="l01869"></a>01869                         <span class="comment">/* deselect this bone */</span>
<a name="l01870"></a>01870                         nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l01871"></a>01871                         <span class="comment">/* only deselect parent tip if it is not selected */</span>
<a name="l01872"></a>01872                         <span class="keywordflow">if</span> (!(nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; BONE_SELECTED))
<a name="l01873"></a>01873                             nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01874"></a>01874                     }
<a name="l01875"></a>01875                     <span class="keywordflow">else</span> {
<a name="l01876"></a>01876                         <span class="comment">/* select this bone */</span>
<a name="l01877"></a>01877                         nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01878"></a>01878                         nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01879"></a>01879                     }
<a name="l01880"></a>01880                 }
<a name="l01881"></a>01881                 <span class="keywordflow">else</span> {
<a name="l01882"></a>01882                     <span class="comment">/* select this bone */</span>
<a name="l01883"></a>01883                     nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01884"></a>01884                     nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l01885"></a>01885                 }
<a name="l01886"></a>01886             }
<a name="l01887"></a>01887             <span class="keywordflow">else</span> {
<a name="l01888"></a>01888                 <span class="keywordflow">if</span> (extend) {
<a name="l01889"></a>01889                     <span class="comment">/* hold shift inverts this bone&#39;s selection */</span>
<a name="l01890"></a>01890                     <span class="keywordflow">if</span> (nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; BONE_SELECTED)
<a name="l01891"></a>01891                        nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01892"></a>01892                     <span class="keywordflow">else</span>
<a name="l01893"></a>01893                         nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01894"></a>01894                 }
<a name="l01895"></a>01895                 <span class="keywordflow">else</span> nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l01896"></a>01896             }
<a name="l01897"></a>01897         }
<a name="l01898"></a>01898         <span class="keywordflow">else</span> {
<a name="l01899"></a>01899             <span class="keywordflow">if</span> (extend &amp;&amp; (nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; selmask))
<a name="l01900"></a>01900                 nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~selmask;
<a name="l01901"></a>01901             <span class="keywordflow">else</span>
<a name="l01902"></a>01902                 nearBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= selmask;
<a name="l01903"></a>01903         }
<a name="l01904"></a>01904         
<a name="l01905"></a>01905         <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01906"></a>01906         
<a name="l01907"></a>01907         <span class="keywordflow">if</span> (nearBone) {
<a name="l01908"></a>01908             <span class="comment">/* then now check for active status */</span>
<a name="l01909"></a>01909             <span class="keywordflow">if</span> (<a class="code" href="../../de/dbc/editarmature_8c.html#a17af5211bd091413169736c5e81713ae">ebone_select_flag</a>(nearBone)) {
<a name="l01910"></a>01910                 arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= nearBone;
<a name="l01911"></a>01911             }
<a name="l01912"></a>01912         }
<a name="l01913"></a>01913         
<a name="l01914"></a>01914         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, vc.<a class="code" href="../../d8/d30/structViewContext.html#aa802aba424149fb5c03e34795a836810">obedit</a>);
<a name="l01915"></a>01915         <span class="keywordflow">return</span> 1;
<a name="l01916"></a>01916     }
<a name="l01917"></a>01917 
<a name="l01918"></a>01918     <span class="keywordflow">return</span> 0;
<a name="l01919"></a>01919 }
<a name="l01920"></a>01920 
<a name="l01921"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#aa12e4dd01a83f83ea125ce1215054862">01921</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01922"></a>01922 {
<a name="l01923"></a>01923     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01924"></a>01924     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone;
<a name="l01925"></a>01925     
<a name="l01926"></a>01926     <span class="comment">/*  Clear the editbones list */</span>
<a name="l01927"></a>01927     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>) {
<a name="l01928"></a>01928         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01929"></a>01929             <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01930"></a>01930                 <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>) {
<a name="l01931"></a>01931                     <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l01932"></a>01932                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l01933"></a>01933                 }
<a name="l01934"></a>01934             }
<a name="l01935"></a>01935 
<a name="l01936"></a>01936             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01937"></a>01937         }
<a name="l01938"></a>01938         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l01939"></a>01939         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01940"></a>01940     }
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a>01943 <span class="comment">/* Put armature in EditMode */</span>
<a name="l01944"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a8505b628dede4943e6604fd53a535ca5">01944</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01945"></a>01945 {
<a name="l01946"></a>01946     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01947"></a>01947     
<a name="l01948"></a>01948     <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(ob);
<a name="l01949"></a>01949     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>), <span class="stringliteral">&quot;edbo armature&quot;</span>);
<a name="l01950"></a>01950     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../dc/d26/armature__intern_8h.html#a776fc766f66fd5f2ce563cec7a612dad">make_boneList</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, &amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>);
<a name="l01951"></a>01951     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01952"></a>01952 
<a name="l01953"></a>01953 <span class="comment">//  BIF_freeTemplates(); /* force template update when entering editmode */</span>
<a name="l01954"></a>01954 }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956 
<a name="l01957"></a>01957 <span class="comment">/* adjust bone roll to align Z axis with vector</span>
<a name="l01958"></a>01958 <span class="comment"> * vec is in local space and is normalized</span>
<a name="l01959"></a>01959 <span class="comment"> */</span>
<a name="l01960"></a>01960 
<a name="l01961"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a77d9567aa5740184aead930b141d203f">01961</a> <span class="keywordtype">float</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af02a0dd1f4951a29c0c238120acd1d9a">ED_rollBoneToVector</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone, <span class="keyword">const</span> <span class="keywordtype">float</span> align_axis[3], <span class="keyword">const</span> <span class="keywordtype">short</span> axis_only)
<a name="l01962"></a>01962 {
<a name="l01963"></a>01963     <span class="keywordtype">float</span> mat[3][3], nor[3];
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l01966"></a>01966     <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(nor, 0.0f, mat);
<a name="l01967"></a>01967 
<a name="l01968"></a>01968     <span class="comment">/* check the bone isn&#39;t aligned with the axis */</span>
<a name="l01969"></a>01969     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(align_axis) &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c9c98bea8608f03de5d2745c2066f8f">angle_v3v3</a>(align_axis, mat[2]) &gt; FLT_EPSILON) {
<a name="l01970"></a>01970         <span class="keywordtype">float</span> vec[3], align_axis_proj[3], roll;
<a name="l01971"></a>01971 
<a name="l01972"></a>01972         <span class="comment">/* project the new_up_axis along the normal */</span>
<a name="l01973"></a>01973         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(vec, align_axis, nor);
<a name="l01974"></a>01974         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(align_axis_proj, align_axis, vec);
<a name="l01975"></a>01975         
<a name="l01976"></a>01976         <span class="keywordflow">if</span> (axis_only) {
<a name="l01977"></a>01977             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c9c98bea8608f03de5d2745c2066f8f">angle_v3v3</a>(align_axis_proj, mat[2]) &gt; (<span class="keywordtype">float</span>)(<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0)) {
<a name="l01978"></a>01978                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(align_axis_proj);
<a name="l01979"></a>01979             }
<a name="l01980"></a>01980         }
<a name="l01981"></a>01981         
<a name="l01982"></a>01982         roll = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c9c98bea8608f03de5d2745c2066f8f">angle_v3v3</a>(align_axis_proj, mat[2]);
<a name="l01983"></a>01983         
<a name="l01984"></a>01984         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vec, mat[2], align_axis_proj);
<a name="l01985"></a>01985         
<a name="l01986"></a>01986         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, nor) &lt; 0) {
<a name="l01987"></a>01987             roll = -roll;
<a name="l01988"></a>01988         }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990         <span class="keywordflow">return</span> roll;
<a name="l01991"></a>01991     }
<a name="l01992"></a>01992 
<a name="l01993"></a>01993     <span class="keywordflow">return</span> 0.0f;
<a name="l01994"></a>01994 }
<a name="l01995"></a>01995 
<a name="l01996"></a>01996 
<a name="l01997"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ae6423dd4eb942bf14a06446be32cc8bd">01997</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> <a class="code" href="../../de/dbc/editarmature_8c.html#ae6423dd4eb942bf14a06446be32cc8bd">prop_calc_roll_types</a>[] = {
<a name="l01998"></a>01998     {0, <span class="stringliteral">&quot;X&quot;</span>, 0, <span class="stringliteral">&quot;X Axis&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l01999"></a>01999     {1, <span class="stringliteral">&quot;Y&quot;</span>, 0, <span class="stringliteral">&quot;Y Axis&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02000"></a>02000     {2, <span class="stringliteral">&quot;Z&quot;</span>, 0, <span class="stringliteral">&quot;Z Axis&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02001"></a>02001     {5, <span class="stringliteral">&quot;ACTIVE&quot;</span>, 0, <span class="stringliteral">&quot;Active Bone&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02002"></a>02002     {6, <span class="stringliteral">&quot;VIEW&quot;</span>, 0, <span class="stringliteral">&quot;View Axis&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02003"></a>02003     {7, <span class="stringliteral">&quot;CURSOR&quot;</span>, 0, <span class="stringliteral">&quot;Cursor&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02004"></a>02004     {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l02005"></a>02005 };
<a name="l02006"></a>02006 
<a name="l02007"></a>02007 
<a name="l02008"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9f8aacf9d9acccfabeca0277e4315d81">02008</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a9f8aacf9d9acccfabeca0277e4315d81">armature_calc_roll_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l02009"></a>02009 {
<a name="l02010"></a>02010     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02011"></a>02011     <span class="keyword">const</span> <span class="keywordtype">short</span> type= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l02012"></a>02012     <span class="keyword">const</span> <span class="keywordtype">short</span> axis_only= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;axis_only&quot;</span>);
<a name="l02013"></a>02013     <span class="keyword">const</span> <span class="keywordtype">short</span> axis_flip= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;axis_flip&quot;</span>);
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="keywordtype">float</span> imat[3][3];
<a name="l02016"></a>02016 
<a name="l02017"></a>02017     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02018"></a>02018     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02021"></a>02021     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(imat);
<a name="l02022"></a>02022 
<a name="l02023"></a>02023     <span class="keywordflow">if</span> (type==7) { <span class="comment">/* Cursor */</span>
<a name="l02024"></a>02024         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02025"></a>02025         <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C); <span class="comment">/* can be NULL */</span>
<a name="l02026"></a>02026         <span class="keywordtype">float</span> cursor_local[3];
<a name="l02027"></a>02027         <span class="keywordtype">float</span>   *cursor= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d);
<a name="l02028"></a>02028     
<a name="l02029"></a>02029 
<a name="l02030"></a>02030         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cursor_local, cursor);
<a name="l02031"></a>02031         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, cursor_local);
<a name="l02032"></a>02032 
<a name="l02033"></a>02033         <span class="comment">/* cursor */</span>
<a name="l02034"></a>02034         <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02035"></a>02035             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(ebone)) {
<a name="l02036"></a>02036                 <span class="keywordtype">float</span> cursor_rel[3];
<a name="l02037"></a>02037                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(cursor_rel, cursor_local, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02038"></a>02038                 <span class="keywordflow">if</span> (axis_flip) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(cursor_rel);
<a name="l02039"></a>02039                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= <a class="code" href="../../de/dbc/editarmature_8c.html#af02a0dd1f4951a29c0c238120acd1d9a">ED_rollBoneToVector</a>(ebone, cursor_rel, axis_only);
<a name="l02040"></a>02040             }
<a name="l02041"></a>02041         }
<a name="l02042"></a>02042     }
<a name="l02043"></a>02043     <span class="keywordflow">else</span> {
<a name="l02044"></a>02044         <span class="keywordtype">float</span> vec[3]= {0.0f, 0.0f, 0.0f};
<a name="l02045"></a>02045         <span class="keywordflow">if</span> (type==6) { <span class="comment">/* View */</span>
<a name="l02046"></a>02046             <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d= <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l02047"></a>02047             <span class="keywordflow">if</span> (rv3d==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02048"></a>02048                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No region view3d available&quot;</span>);
<a name="l02049"></a>02049                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02050"></a>02050             }
<a name="l02051"></a>02051 
<a name="l02052"></a>02052             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>[2]);
<a name="l02053"></a>02053             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, vec);
<a name="l02054"></a>02054         }
<a name="l02055"></a>02055         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type==5) {
<a name="l02056"></a>02056             <span class="keywordtype">float</span> mat[3][3], nor[3];
<a name="l02057"></a>02057             ebone= (<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *)arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>;
<a name="l02058"></a>02058             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ebone==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02059"></a>02059                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active bone set&quot;</span>);
<a name="l02060"></a>02060                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02061"></a>02061             }
<a name="l02062"></a>02062 
<a name="l02063"></a>02063             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02064"></a>02064             <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(nor, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>, mat);            
<a name="l02065"></a>02065             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, mat[2]);
<a name="l02066"></a>02066         }
<a name="l02067"></a>02067         <span class="keywordflow">else</span> { <span class="comment">/* Axis */</span>
<a name="l02068"></a>02068             <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(type &gt;= 0 &amp;&amp; type &lt;= 5);
<a name="l02069"></a>02069             <span class="keywordflow">if</span> (type&lt;3) vec[type]= 1.0f; 
<a name="l02070"></a>02070             <span class="keywordflow">else</span>        vec[type-2]= -1.0f; 
<a name="l02071"></a>02071             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, vec);
<a name="l02072"></a>02072         }
<a name="l02073"></a>02073 
<a name="l02074"></a>02074         <span class="keywordflow">if</span> (axis_flip) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(vec);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076         <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02077"></a>02077             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(ebone)) {
<a name="l02078"></a>02078                 <span class="comment">/* roll func is a callback which assumes that all is well */</span>
<a name="l02079"></a>02079                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= <a class="code" href="../../de/dbc/editarmature_8c.html#af02a0dd1f4951a29c0c238120acd1d9a">ED_rollBoneToVector</a>(ebone, vec, axis_only);
<a name="l02080"></a>02080             }
<a name="l02081"></a>02081         }
<a name="l02082"></a>02082     }
<a name="l02083"></a>02083 
<a name="l02084"></a>02084     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l02085"></a>02085         <span class="keywordflow">for</span> (ebone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02086"></a>02086             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(ebone)) == 0) {
<a name="l02087"></a>02087                 <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone_mirr= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone);
<a name="l02088"></a>02088                 <span class="keywordflow">if</span> (ebone_mirr &amp;&amp; (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone_mirr) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(ebone_mirr))) {
<a name="l02089"></a>02089                     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= -ebone_mirr-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l02090"></a>02090                 }
<a name="l02091"></a>02091             }
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093     }
<a name="l02094"></a>02094 
<a name="l02095"></a>02095     <span class="comment">/* note, notifier might evolve */</span>
<a name="l02096"></a>02096     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, ob);
<a name="l02097"></a>02097     
<a name="l02098"></a>02098     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a985a8cb216b25c3c8080412e00a8cfa4">02101</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a13a28f7e915c5bbdfd5974d4b18e9824">ARMATURE_OT_calculate_roll</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02102"></a>02102 {
<a name="l02103"></a>02103     <span class="comment">/* identifiers */</span>
<a name="l02104"></a>02104     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Recalculate Roll&quot;</span>;
<a name="l02105"></a>02105     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_calculate_roll&quot;</span>;
<a name="l02106"></a>02106     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Automatically fix alignment of select bones&#39; axes&quot;</span>;
<a name="l02107"></a>02107     
<a name="l02108"></a>02108     <span class="comment">/* api callbacks */</span>
<a name="l02109"></a>02109     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l02110"></a>02110     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a9f8aacf9d9acccfabeca0277e4315d81">armature_calc_roll_exec</a>;
<a name="l02111"></a>02111     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l02112"></a>02112     
<a name="l02113"></a>02113     <span class="comment">/* flags */</span>
<a name="l02114"></a>02114     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02115"></a>02115 
<a name="l02116"></a>02116     <span class="comment">/* properties */</span>
<a name="l02117"></a>02117     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, prop_calc_roll_types, 0, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02118"></a>02118     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;axis_flip&quot;</span>, 0, <span class="stringliteral">&quot;Flip Axis&quot;</span>, <span class="stringliteral">&quot;Negate the alignment axis&quot;</span>);
<a name="l02119"></a>02119     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;axis_only&quot;</span>, 0, <span class="stringliteral">&quot;Shortest Rotation&quot;</span>, <span class="stringliteral">&quot;Ignore the axis direction, use the shortest rotation to align&quot;</span>);
<a name="l02120"></a>02120 }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122 <span class="comment">/* **************** undo for armatures ************** */</span>
<a name="l02123"></a>02123 
<a name="l02124"></a><a class="code" href="../../da/dab/structUndoArmature.html">02124</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/dab/structUndoArmature.html">UndoArmature</a> {
<a name="l02125"></a><a class="code" href="../../da/dab/structUndoArmature.html#a4975b263ec90b8c6bc90796b4506f7fd">02125</a>     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../da/dab/structUndoArmature.html#a4975b263ec90b8c6bc90796b4506f7fd">act_edbone</a>;
<a name="l02126"></a><a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">02126</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">lb</a>;
<a name="l02127"></a>02127 } <a class="code" href="../../de/dbc/editarmature_8c.html#a070ac5c0586fa7eb3ec938fc523d31b5">UndoArmature</a>;
<a name="l02128"></a>02128 
<a name="l02129"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac0d298ad41dca202116c6b60e09105cf">02129</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac0d298ad41dca202116c6b60e09105cf">undoBones_to_editBones</a>(<span class="keywordtype">void</span> *uarmv, <span class="keywordtype">void</span> *armv, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>))
<a name="l02130"></a>02130 {
<a name="l02131"></a>02131     <a class="code" href="../../da/dab/structUndoArmature.html">UndoArmature</a> *uarm= uarmv;
<a name="l02132"></a>02132     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= armv;
<a name="l02133"></a>02133     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, *newebo;
<a name="l02134"></a>02134     
<a name="l02135"></a>02135     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l02136"></a>02136     
<a name="l02137"></a>02137     <span class="comment">/* copy  */</span>
<a name="l02138"></a>02138     <span class="keywordflow">for</span> (ebo= uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">lb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02139"></a>02139         newebo= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ebo);
<a name="l02140"></a>02140         ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>= newebo;
<a name="l02141"></a>02141         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newebo);
<a name="l02142"></a>02142     }
<a name="l02143"></a>02143     
<a name="l02144"></a>02144     <span class="comment">/* active bone */</span>
<a name="l02145"></a>02145     <span class="keywordflow">if</span> (uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#a4975b263ec90b8c6bc90796b4506f7fd">act_edbone</a>) {
<a name="l02146"></a>02146         ebo= uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#a4975b263ec90b8c6bc90796b4506f7fd">act_edbone</a>;
<a name="l02147"></a>02147         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02148"></a>02148     }
<a name="l02149"></a>02149     <span class="keywordflow">else</span>
<a name="l02150"></a>02150         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02151"></a>02151 
<a name="l02152"></a>02152     <span class="comment">/* set pointers */</span>
<a name="l02153"></a>02153     <span class="keywordflow">for</span> (newebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; newebo; newebo= newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02154"></a>02154         <span class="keywordflow">if</span> (newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156     <span class="comment">/* be sure they don&#39;t hang ever */</span>
<a name="l02157"></a>02157     <span class="keywordflow">for</span> (newebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; newebo; newebo= newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02158"></a>02158         newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160 }
<a name="l02161"></a>02161 
<a name="l02162"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a142b41467f5c5adf1d9f6514a58b0ad5">02162</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/dbc/editarmature_8c.html#a142b41467f5c5adf1d9f6514a58b0ad5">editBones_to_undoBones</a>(<span class="keywordtype">void</span> *armv, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(obdata))
<a name="l02163"></a>02163 {
<a name="l02164"></a>02164     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= armv;
<a name="l02165"></a>02165     <a class="code" href="../../da/dab/structUndoArmature.html">UndoArmature</a> *uarm;
<a name="l02166"></a>02166     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, *newebo;
<a name="l02167"></a>02167     
<a name="l02168"></a>02168     uarm= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/dab/structUndoArmature.html">UndoArmature</a>), <span class="stringliteral">&quot;listbase undo&quot;</span>);
<a name="l02169"></a>02169     
<a name="l02170"></a>02170     <span class="comment">/* copy */</span>
<a name="l02171"></a>02171     <span class="keywordflow">for</span> (ebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02172"></a>02172         newebo= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ebo);
<a name="l02173"></a>02173         ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>= newebo;
<a name="l02174"></a>02174         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">lb</a>, newebo);
<a name="l02175"></a>02175     }
<a name="l02176"></a>02176     
<a name="l02177"></a>02177     <span class="comment">/* active bone */</span>
<a name="l02178"></a>02178     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) {
<a name="l02179"></a>02179         ebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>;
<a name="l02180"></a>02180         uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#a4975b263ec90b8c6bc90796b4506f7fd">act_edbone</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02181"></a>02181     }
<a name="l02182"></a>02182 
<a name="l02183"></a>02183     <span class="comment">/* set pointers */</span>
<a name="l02184"></a>02184     <span class="keywordflow">for</span> (newebo= uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">lb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; newebo; newebo= newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02185"></a>02185         <span class="keywordflow">if</span> (newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= newebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02186"></a>02186     }
<a name="l02187"></a>02187     
<a name="l02188"></a>02188     <span class="keywordflow">return</span> uarm;
<a name="l02189"></a>02189 }
<a name="l02190"></a>02190 
<a name="l02191"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a8d790edb7a802fdd19936b32f6d03efe">02191</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8d790edb7a802fdd19936b32f6d03efe">free_undoBones</a>(<span class="keywordtype">void</span> *uarmv)
<a name="l02192"></a>02192 {
<a name="l02193"></a>02193     <a class="code" href="../../da/dab/structUndoArmature.html">UndoArmature</a> *uarm= uarmv;
<a name="l02194"></a>02194     
<a name="l02195"></a>02195     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;uarm-&gt;<a class="code" href="../../da/dab/structUndoArmature.html#ab02b8c4eaa49a4623beb33d23147c59b">lb</a>);
<a name="l02196"></a>02196     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(uarm);
<a name="l02197"></a>02197 }
<a name="l02198"></a>02198 
<a name="l02199"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac580c7d6832d2acd13d53879f2908bef">02199</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../de/dbc/editarmature_8c.html#ac580c7d6832d2acd13d53879f2908bef">get_armature_edit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l02200"></a>02200 {
<a name="l02201"></a>02201     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02202"></a>02202     <span class="keywordflow">if</span> (obedit &amp;&amp; obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) {
<a name="l02203"></a>02203         <span class="keywordflow">return</span> obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02204"></a>02204     }
<a name="l02205"></a>02205     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02206"></a>02206 }
<a name="l02207"></a>02207 
<a name="l02208"></a>02208 <span class="comment">/* and this is all the undo system needs to know */</span>
<a name="l02209"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a309cc1f1f7408ef6081f9495fc0d48f3">02209</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ae73f49b3d13f3e07a5c7b04c9a0e747c">undo_push_armature</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l02210"></a>02210 {
<a name="l02211"></a>02211     <span class="comment">// XXX solve getdata()</span>
<a name="l02212"></a>02212     <a class="code" href="../../d6/df1/ED__util_8h.html#ab72acb872843c87ffaa182ae19ac4b67">undo_editmode_push</a>(C, name, <a class="code" href="../../de/dbc/editarmature_8c.html#ac580c7d6832d2acd13d53879f2908bef">get_armature_edit</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#a8d790edb7a802fdd19936b32f6d03efe">free_undoBones</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#ac0d298ad41dca202116c6b60e09105cf">undoBones_to_editBones</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#a142b41467f5c5adf1d9f6514a58b0ad5">editBones_to_undoBones</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02213"></a>02213 }
<a name="l02214"></a>02214 
<a name="l02215"></a>02215 
<a name="l02216"></a>02216 
<a name="l02217"></a>02217 <span class="comment">/* **************** END EditMode stuff ********************** */</span>
<a name="l02218"></a>02218 <span class="comment">/* *************** Adding stuff in editmode *************** */</span>
<a name="l02219"></a>02219 
<a name="l02220"></a>02220 <span class="comment">/* default bone add, returns it selected, but without tail set */</span>
<a name="l02221"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a5c1913e09c35588f0a6fc8752147989a">02221</a> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l02222"></a>02222 {
<a name="l02223"></a>02223     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>), <span class="stringliteral">&quot;eBone&quot;</span>);
<a name="l02224"></a>02224     
<a name="l02225"></a>02225     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, name, <span class="keyword">sizeof</span>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>));
<a name="l02226"></a>02226     <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02227"></a>02227     
<a name="l02228"></a>02228     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, bone);
<a name="l02229"></a>02229     
<a name="l02230"></a>02230     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l02231"></a>02231     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a2753960f025df5ba4b63a6b6367d88bc">weight</a>= 1.0f;
<a name="l02232"></a>02232     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>= 0.25f;
<a name="l02233"></a>02233     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>= 0.1f;
<a name="l02234"></a>02234     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>= 0.1f;
<a name="l02235"></a>02235     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad9fd275367fb8380d2687f2792f55ad3">ease1</a>= 1.0f;
<a name="l02236"></a>02236     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a1ea52dfee3cbfe086800c86d2ac30db8">ease2</a>= 1.0f;
<a name="l02237"></a>02237     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= 0.10f;
<a name="l02238"></a>02238     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= 0.05f;
<a name="l02239"></a>02239     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a386520de6d24a893cc598b38535c5687">segments</a>= 1;
<a name="l02240"></a>02240     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a>;
<a name="l02241"></a>02241     
<a name="l02242"></a>02242     <span class="keywordflow">return</span> bone;
<a name="l02243"></a>02243 }
<a name="l02244"></a>02244 
<a name="l02245"></a>02245 <span class="comment">/* v3d and rv3d are allowed to be NULL */</span>
<a name="l02246"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#ab883a2c0d8c49928745ac1b449d5a88d">02246</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a1f96f9d356e0fc7092eece0aa7895271">add_primitive_bone</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l02247"></a>02247 {
<a name="l02248"></a>02248     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l02249"></a>02249     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02250"></a>02250     <span class="keywordtype">float</span>       obmat[3][3], curs[3], viewmat[3][3], totmat[3][3], imat[3][3];
<a name="l02251"></a>02251     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *bone;
<a name="l02252"></a>02252 
<a name="l02253"></a>02253     <span class="comment">/* Get inverse point for head and orientation for tail */</span>
<a name="l02254"></a>02254     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02255"></a>02255     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(curs, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d));
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     <span class="keywordflow">if</span> (rv3d &amp;&amp; (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a77b2559064358b40097c406230b89576">USER_ADD_VIEWALIGNED</a>))
<a name="l02258"></a>02258         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(obmat, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02259"></a>02259     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(obmat);
<a name="l02260"></a>02260     
<a name="l02261"></a>02261     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(viewmat, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02262"></a>02262     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(totmat, obmat, viewmat);
<a name="l02263"></a>02263     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat, totmat);
<a name="l02264"></a>02264     
<a name="l02265"></a>02265     <a class="code" href="../../de/dbc/editarmature_8c.html#a6e29e50cb8f7692065a1bc44fe80cfcf">ED_armature_deselect_all</a>(obedit, 0);
<a name="l02266"></a>02266     
<a name="l02267"></a>02267     <span class="comment">/*  Create a bone   */</span>
<a name="l02268"></a>02268     bone= <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(arm, <span class="stringliteral">&quot;Bone&quot;</span>);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= bone;
<a name="l02271"></a>02271 
<a name="l02272"></a>02272     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, curs);
<a name="l02273"></a>02273     
<a name="l02274"></a>02274     <span class="keywordflow">if</span> (rv3d &amp;&amp; (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a77b2559064358b40097c406230b89576">USER_ADD_VIEWALIGNED</a>))
<a name="l02275"></a>02275         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, imat[1]);   <span class="comment">// bone with unit length 1</span>
<a name="l02276"></a>02276     <span class="keywordflow">else</span>
<a name="l02277"></a>02277         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, imat[2]);   <span class="comment">// bone with unit length 1, pointing up Z</span>
<a name="l02278"></a>02278     
<a name="l02279"></a>02279 }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 <span class="comment">/* previously addvert_armature */</span>
<a name="l02283"></a>02283 <span class="comment">/* the ctrl-click method */</span>
<a name="l02284"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a3f1a27ad0a69515383740722085b1948">02284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a3f1a27ad0a69515383740722085b1948">armature_click_extrude_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l02285"></a>02285 {
<a name="l02286"></a>02286     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d;
<a name="l02287"></a>02287     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l02288"></a>02288     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone, *newbone, *flipbone;
<a name="l02289"></a>02289     <span class="keywordtype">float</span> *curs, mat[3][3],imat[3][3];
<a name="l02290"></a>02290     <span class="keywordtype">int</span> a, to_root= 0;
<a name="l02291"></a>02291     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit;
<a name="l02292"></a>02292     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l02293"></a>02293 
<a name="l02294"></a>02294     scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02295"></a>02295     v3d= <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02296"></a>02296     obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02297"></a>02297     arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02298"></a>02298     
<a name="l02299"></a>02299     <span class="comment">/* find the active or selected bone */</span>
<a name="l02300"></a>02300     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02301"></a>02301         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l02302"></a>02302             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> || arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a> == ebone)
<a name="l02303"></a>02303                 <span class="keywordflow">break</span>;
<a name="l02304"></a>02304         }
<a name="l02305"></a>02305     }
<a name="l02306"></a>02306     
<a name="l02307"></a>02307     <span class="keywordflow">if</span> (ebone==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02308"></a>02308         <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02309"></a>02309             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l02310"></a>02310                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a> || arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a> == ebone)
<a name="l02311"></a>02311                     <span class="keywordflow">break</span>;
<a name="l02312"></a>02312             }
<a name="l02313"></a>02313         }
<a name="l02314"></a>02314         <span class="keywordflow">if</span> (ebone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l02315"></a>02315             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02316"></a>02316         
<a name="l02317"></a>02317         to_root= 1;
<a name="l02318"></a>02318     }
<a name="l02319"></a>02319     
<a name="l02320"></a>02320     <a class="code" href="../../de/dbc/editarmature_8c.html#a6e29e50cb8f7692065a1bc44fe80cfcf">ED_armature_deselect_all</a>(obedit, 0);
<a name="l02321"></a>02321     
<a name="l02322"></a>02322     <span class="comment">/* we re-use code for mirror editing... */</span>
<a name="l02323"></a>02323     flipbone= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02324"></a>02324     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>)
<a name="l02325"></a>02325         flipbone= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone);
<a name="l02326"></a>02326 
<a name="l02327"></a>02327     <span class="keywordflow">for</span> (a=0; a&lt;2; a++) {
<a name="l02328"></a>02328         <span class="keywordflow">if</span> (a==1) {
<a name="l02329"></a>02329             <span class="keywordflow">if</span> (flipbone==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02330"></a>02330                 <span class="keywordflow">break</span>;
<a name="l02331"></a>02331             <span class="keywordflow">else</span> {
<a name="l02332"></a>02332                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, flipbone, ebone);
<a name="l02333"></a>02333             }
<a name="l02334"></a>02334         }
<a name="l02335"></a>02335         
<a name="l02336"></a>02336         newbone= <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(arm, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>);
<a name="l02337"></a>02337         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= newbone;
<a name="l02338"></a>02338         
<a name="l02339"></a>02339         <span class="keywordflow">if</span> (to_root) {
<a name="l02340"></a>02340             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02341"></a>02341             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l02342"></a>02342             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l02343"></a>02343         }
<a name="l02344"></a>02344         <span class="keywordflow">else</span> {
<a name="l02345"></a>02345             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02346"></a>02346             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l02347"></a>02347             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebone;
<a name="l02348"></a>02348             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l02349"></a>02349         }
<a name="l02350"></a>02350         
<a name="l02351"></a>02351         curs= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d);
<a name="l02352"></a>02352         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, curs);
<a name="l02353"></a>02353         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l02354"></a>02354         
<a name="l02355"></a>02355         <span class="keywordflow">if</span> (a==1) 
<a name="l02356"></a>02356             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[0]= -newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[0];
<a name="l02357"></a>02357         
<a name="l02358"></a>02358         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mat, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02359"></a>02359         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat, mat);
<a name="l02360"></a>02360         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02361"></a>02361         
<a name="l02362"></a>02362         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a9f6371e8c53554e6d61db6eb65e30f8a">length</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02363"></a>02363         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a9f6371e8c53554e6d61db6eb65e30f8a">length</a>*0.05f;
<a name="l02364"></a>02364         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>= newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a9f6371e8c53554e6d61db6eb65e30f8a">length</a>*0.25f;
<a name="l02365"></a>02365         
<a name="l02366"></a>02366     }
<a name="l02367"></a>02367     
<a name="l02368"></a>02368     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l02369"></a>02369 
<a name="l02370"></a>02370     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l02371"></a>02371     
<a name="l02372"></a>02372     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02373"></a>02373 }
<a name="l02374"></a>02374 
<a name="l02375"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac573eea5876083d7887bf33801fe5f0d">02375</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac573eea5876083d7887bf33801fe5f0d">armature_click_extrude_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02376"></a>02376 {
<a name="l02377"></a>02377     <span class="comment">/* TODO most of this code is copied from set3dcursor_invoke,</span>
<a name="l02378"></a>02378 <span class="comment">     * it would be better to reuse code in set3dcursor_invoke */</span>
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="comment">/* temporarily change 3d cursor position */</span>
<a name="l02381"></a>02381     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l02382"></a>02382     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar;
<a name="l02383"></a>02383     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d;
<a name="l02384"></a>02384     <span class="keywordtype">float</span> *fp = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tvec[3], oldcurs[3], mval_f[2];
<a name="l02385"></a>02385     <span class="keywordtype">int</span> retv;
<a name="l02386"></a>02386 
<a name="l02387"></a>02387     scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02388"></a>02388     ar= <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l02389"></a>02389     v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02390"></a>02390     
<a name="l02391"></a>02391     fp= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d);
<a name="l02392"></a>02392     
<a name="l02393"></a>02393     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(oldcurs, fp);
<a name="l02394"></a>02394 
<a name="l02395"></a>02395     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a6f9e3205a25a942a5c33cb609c31db65">VECCOPY2D</a>(mval_f, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>);
<a name="l02396"></a>02396     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a0b8d76038db8c25bdc58fc17423ef7be">ED_view3d_win_to_3d</a>(ar, fp, mval_f, tvec);
<a name="l02397"></a>02397     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, tvec);
<a name="l02398"></a>02398 
<a name="l02399"></a>02399     <span class="comment">/* extrude to the where new cursor is and store the operation result */</span>
<a name="l02400"></a>02400     retv= <a class="code" href="../../de/dbc/editarmature_8c.html#a3f1a27ad0a69515383740722085b1948">armature_click_extrude_exec</a>(C, op);
<a name="l02401"></a>02401 
<a name="l02402"></a>02402     <span class="comment">/* restore previous 3d cursor position */</span>
<a name="l02403"></a>02403     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, oldcurs);
<a name="l02404"></a>02404 
<a name="l02405"></a>02405     <span class="keywordflow">return</span> retv;
<a name="l02406"></a>02406 }
<a name="l02407"></a>02407 
<a name="l02408"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5b9505a2211a81d45cdd7da3770de854">02408</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a8dba61e50108d6ff548f8467a1b147bd">ARMATURE_OT_click_extrude</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02409"></a>02409 {
<a name="l02410"></a>02410     <span class="comment">/* identifiers */</span>
<a name="l02411"></a>02411     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Click-Extrude&quot;</span>;
<a name="l02412"></a>02412     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_click_extrude&quot;</span>;
<a name="l02413"></a>02413     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Create a new bone going from the last selected joint to the mouse position&quot;</span>;
<a name="l02414"></a>02414     
<a name="l02415"></a>02415     <span class="comment">/* api callbacks */</span>
<a name="l02416"></a>02416     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ac573eea5876083d7887bf33801fe5f0d">armature_click_extrude_invoke</a>;
<a name="l02417"></a>02417     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a3f1a27ad0a69515383740722085b1948">armature_click_extrude_exec</a>;
<a name="l02418"></a>02418     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l02419"></a>02419     
<a name="l02420"></a>02420     <span class="comment">/* flags */</span>
<a name="l02421"></a>02421     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02422"></a>02422 
<a name="l02423"></a>02423     <span class="comment">/* props */</span>
<a name="l02424"></a>02424 }
<a name="l02425"></a>02425 
<a name="l02426"></a>02426 <span class="comment">/* adds an EditBone between the nominated locations (should be in the right space) */</span>
<a name="l02427"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aff65d1434af8f1c3508ddf2c816546c2">02427</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#aff65d1434af8f1c3508ddf2c816546c2">add_points_bone</a> (<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <span class="keywordtype">float</span> head[], <span class="keywordtype">float</span> tail[]) 
<a name="l02428"></a>02428 {
<a name="l02429"></a>02429     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo;
<a name="l02430"></a>02430     
<a name="l02431"></a>02431     ebo= <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, <span class="stringliteral">&quot;Bone&quot;</span>);
<a name="l02432"></a>02432     
<a name="l02433"></a>02433     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, head);
<a name="l02434"></a>02434     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, tail);
<a name="l02435"></a>02435     
<a name="l02436"></a>02436     <span class="keywordflow">return</span> ebo;
<a name="l02437"></a>02437 }
<a name="l02438"></a>02438 
<a name="l02439"></a>02439 
<a name="l02440"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abb9f268e3a21a9e9b0aea681b4fd748b">02440</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../de/dbc/editarmature_8c.html#abb9f268e3a21a9e9b0aea681b4fd748b">get_named_editbone</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <span class="keywordtype">char</span> *name)
<a name="l02441"></a>02441 {
<a name="l02442"></a>02442     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>  *eBone;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444     <span class="keywordflow">if</span> (name) {
<a name="l02445"></a>02445         <span class="keywordflow">for</span> (eBone=edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02446"></a>02446             <span class="keywordflow">if</span> (!strcmp(name, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>))
<a name="l02447"></a>02447                 <span class="keywordflow">return</span> eBone;
<a name="l02448"></a>02448         }
<a name="l02449"></a>02449     }
<a name="l02450"></a>02450 
<a name="l02451"></a>02451     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02452"></a>02452 }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454 <span class="comment">/* Call this before doing any duplications</span>
<a name="l02455"></a>02455 <span class="comment"> * */</span>
<a name="l02456"></a><a class="code" href="../../de/dbc/editarmature_8c.html#adc24ac1184b0501d32a743f6d75f6b7e">02456</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a19b96064154f6483f43881ee460ef2b1">preEditBoneDuplicate</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbones)
<a name="l02457"></a>02457 {
<a name="l02458"></a>02458     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone;
<a name="l02459"></a>02459     
<a name="l02460"></a>02460     <span class="comment">/* clear temp */</span>
<a name="l02461"></a>02461     <span class="keywordflow">for</span> (eBone = editbones-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone = eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>)
<a name="l02462"></a>02462     {
<a name="l02463"></a>02463         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465 }
<a name="l02466"></a>02466 
<a name="l02467"></a>02467 <span class="comment">/*</span>
<a name="l02468"></a>02468 <span class="comment"> * Note: When duplicating cross objects, editbones here is the list of bones</span>
<a name="l02469"></a>02469 <span class="comment"> * from the SOURCE object but ob is the DESTINATION object</span>
<a name="l02470"></a>02470 <span class="comment"> * */</span>
<a name="l02471"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa88cb96539a3cfd685c848ec7fef5284">02471</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a75863f8fd49ee5b8dfdd97cc7b99e09e">updateDuplicateSubtargetObjects</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *dupBone, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbones, <a class="code" href="../../de/de7/structObject.html">Object</a> *src_ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *dst_ob)
<a name="l02472"></a>02472 {
<a name="l02473"></a>02473     <span class="comment">/* If an edit bone has been duplicated, lets</span>
<a name="l02474"></a>02474 <span class="comment">     * update it&#39;s constraints if the subtarget</span>
<a name="l02475"></a>02475 <span class="comment">     * they point to has also been duplicated</span>
<a name="l02476"></a>02476 <span class="comment">     */</span>
<a name="l02477"></a>02477     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>     *oldtarget, *newtarget;
<a name="l02478"></a>02478     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l02479"></a>02479     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a>  *curcon;
<a name="l02480"></a>02480     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a>     *conlist;
<a name="l02481"></a>02481     
<a name="l02482"></a>02482     <span class="keywordflow">if</span> ( (pchan = <a class="code" href="../../d8/df5/BKE__action_8h.html#a74ba25276e2aa4b007aafa4a545f649d">verify_pose_channel</a>(dst_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, dupBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>)) ) {
<a name="l02483"></a>02483         <span class="keywordflow">if</span> ( (conlist = &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>) ) {
<a name="l02484"></a>02484             <span class="keywordflow">for</span> (curcon = conlist-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curcon; curcon=curcon-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l02485"></a>02485                 <span class="comment">/* does this constraint have a subtarget in</span>
<a name="l02486"></a>02486 <span class="comment">                 * this armature?</span>
<a name="l02487"></a>02487 <span class="comment">                 */</span>
<a name="l02488"></a>02488                 <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(curcon);
<a name="l02489"></a>02489                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02490"></a>02490                 <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l02491"></a>02491                 
<a name="l02492"></a>02492                 <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l02493"></a>02493                     cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(curcon, &amp;targets);
<a name="l02494"></a>02494                     
<a name="l02495"></a>02495                     <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l02496"></a>02496                         <span class="keywordflow">if</span> ((ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == src_ob) &amp;&amp; (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>[0])) {
<a name="l02497"></a>02497                             ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = dst_ob; <span class="comment">/* update target */</span> 
<a name="l02498"></a>02498                             oldtarget = <a class="code" href="../../de/dbc/editarmature_8c.html#abb9f268e3a21a9e9b0aea681b4fd748b">get_named_editbone</a>(editbones, ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>);
<a name="l02499"></a>02499                             <span class="keywordflow">if</span> (oldtarget) {
<a name="l02500"></a>02500                                 <span class="comment">/* was the subtarget bone duplicated too? If</span>
<a name="l02501"></a>02501 <span class="comment">                                 * so, update the constraint to point at the </span>
<a name="l02502"></a>02502 <span class="comment">                                 * duplicate of the old subtarget.</span>
<a name="l02503"></a>02503 <span class="comment">                                 */</span>
<a name="l02504"></a>02504                                 <span class="keywordflow">if</span> (oldtarget-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>) {
<a name="l02505"></a>02505                                     newtarget = (<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *) oldtarget-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02506"></a>02506                                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, newtarget-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>));
<a name="l02507"></a>02507                                 }
<a name="l02508"></a>02508                             }
<a name="l02509"></a>02509                         }
<a name="l02510"></a>02510                     }
<a name="l02511"></a>02511                     
<a name="l02512"></a>02512                     <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l02513"></a>02513                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(curcon, &amp;targets, 0);
<a name="l02514"></a>02514                 }
<a name="l02515"></a>02515             }
<a name="l02516"></a>02516         }
<a name="l02517"></a>02517     }
<a name="l02518"></a>02518 }
<a name="l02519"></a>02519 
<a name="l02520"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab946eca08be1ebf0924ca4c8768a059a">02520</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a7d1294fee2902304bd50e5c4e1d8ced6">updateDuplicateSubtarget</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *dupBone, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbones, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02521"></a>02521 {
<a name="l02522"></a>02522     <a class="code" href="../../dc/d26/armature__intern_8h.html#a75863f8fd49ee5b8dfdd97cc7b99e09e">updateDuplicateSubtargetObjects</a>(dupBone, editbones, ob, ob);
<a name="l02523"></a>02523 }
<a name="l02524"></a>02524 
<a name="l02525"></a>02525 
<a name="l02526"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac9e7f8a399d5c72c36eeae2b86b44fe1">02526</a> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../dc/d26/armature__intern_8h.html#a9bdce1b3e32b7e17003c77afb03efbc1">duplicateEditBoneObjects</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbones, <a class="code" href="../../de/de7/structObject.html">Object</a> *src_ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *dst_ob)
<a name="l02527"></a>02527 {
<a name="l02528"></a>02528     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>), <span class="stringliteral">&quot;addup_editbone&quot;</span>);
<a name="l02529"></a>02529     
<a name="l02530"></a>02530     <span class="comment">/*  Copy data from old bone to new bone */</span>
<a name="l02531"></a>02531     memcpy(eBone, curBone, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>));
<a name="l02532"></a>02532     
<a name="l02533"></a>02533     curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a> = eBone;
<a name="l02534"></a>02534     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a> = curBone;
<a name="l02535"></a>02535     
<a name="l02536"></a>02536     <span class="keywordflow">if</span> (name != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02537"></a>02537         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, name, <span class="keyword">sizeof</span>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>));
<a name="l02538"></a>02538     }
<a name="l02539"></a>02539 
<a name="l02540"></a>02540     <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(editbones, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02541"></a>02541     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(editbones, eBone);
<a name="l02542"></a>02542     
<a name="l02543"></a>02543     <span class="comment">/* copy the ID property */</span>
<a name="l02544"></a>02544     <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>)
<a name="l02545"></a>02545         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>= <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#acc4496275f4e96eaa2d237c21d65a934">prop</a>);
<a name="l02546"></a>02546 
<a name="l02547"></a>02547     <span class="comment">/* Lets duplicate the list of constraints that the</span>
<a name="l02548"></a>02548 <span class="comment">     * current bone has.</span>
<a name="l02549"></a>02549 <span class="comment">     */</span>
<a name="l02550"></a>02550     <span class="keywordflow">if</span> (src_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) {
<a name="l02551"></a>02551         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *chanold, *channew;
<a name="l02552"></a>02552         
<a name="l02553"></a>02553         chanold = <a class="code" href="../../d8/df5/BKE__action_8h.html#a74ba25276e2aa4b007aafa4a545f649d">verify_pose_channel</a>(src_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>);
<a name="l02554"></a>02554         <span class="keywordflow">if</span> (chanold) {
<a name="l02555"></a>02555             <span class="comment">/* WARNING: this creates a new posechannel, but there will not be an attached bone</span>
<a name="l02556"></a>02556 <span class="comment">             *      yet as the new bones created here are still &#39;EditBones&#39; not &#39;Bones&#39;.</span>
<a name="l02557"></a>02557 <span class="comment">             */</span>
<a name="l02558"></a>02558             channew= <a class="code" href="../../d8/df5/BKE__action_8h.html#a74ba25276e2aa4b007aafa4a545f649d">verify_pose_channel</a>(dst_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>);
<a name="l02559"></a>02559 
<a name="l02560"></a>02560             <span class="keywordflow">if</span> (channew) {
<a name="l02561"></a>02561                 <a class="code" href="../../d8/df5/BKE__action_8h.html#a10db4e11d4bba4d87f59cb7640caea78">duplicate_pose_channel_data</a>(channew, chanold);
<a name="l02562"></a>02562             }
<a name="l02563"></a>02563         }
<a name="l02564"></a>02564     }
<a name="l02565"></a>02565     
<a name="l02566"></a>02566     <span class="keywordflow">return</span> eBone;
<a name="l02567"></a>02567 }
<a name="l02568"></a>02568 
<a name="l02569"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac0acb2235ebe6dbc4be103f83afdb08e">02569</a> <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../dc/d26/armature__intern_8h.html#ae11b753be1df06ac01273a75a6f72ecc">duplicateEditBone</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *editbones, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02570"></a>02570 {
<a name="l02571"></a>02571     <span class="keywordflow">return</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a9bdce1b3e32b7e17003c77afb03efbc1">duplicateEditBoneObjects</a>(curBone, name, editbones, ob, ob);
<a name="l02572"></a>02572 }
<a name="l02573"></a>02573 
<a name="l02574"></a>02574 <span class="comment">/* previously adduplicate_armature */</span>
<a name="l02575"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5ad5cae73172ac699b4b3916651f0dc9">02575</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5ad5cae73172ac699b4b3916651f0dc9">armature_duplicate_selected_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l02576"></a>02576 {
<a name="l02577"></a>02577     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l02578"></a>02578     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *eBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02579"></a>02579     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *curBone;
<a name="l02580"></a>02580     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *firstDup=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/*  The beginning of the duplicated bones in the edbo list */</span>
<a name="l02581"></a>02581 
<a name="l02582"></a>02582     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02583"></a>02583     arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585     <span class="comment">/* cancel if nothing selected */</span>
<a name="l02586"></a>02586     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_bones) == 0)
<a name="l02587"></a>02587         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02588"></a>02588     
<a name="l02589"></a>02589     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>); <span class="comment">// XXX why is this needed?</span>
<a name="l02590"></a>02590 
<a name="l02591"></a>02591     <a class="code" href="../../dc/d26/armature__intern_8h.html#a19b96064154f6483f43881ee460ef2b1">preEditBoneDuplicate</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l02592"></a>02592 
<a name="l02593"></a>02593     <span class="comment">/* Select mirrored bones */</span>
<a name="l02594"></a>02594     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l02595"></a>02595         <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02596"></a>02596             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, curBone)) {
<a name="l02597"></a>02597                 <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l02598"></a>02598                     eBone = <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, curBone);
<a name="l02599"></a>02599                     <span class="keywordflow">if</span> (eBone)
<a name="l02600"></a>02600                         eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l02601"></a>02601                 }
<a name="l02602"></a>02602             }
<a name="l02603"></a>02603         }
<a name="l02604"></a>02604     }
<a name="l02605"></a>02605 
<a name="l02606"></a>02606     
<a name="l02607"></a>02607     <span class="comment">/*  Find the selected bones and duplicate them as needed */</span>
<a name="l02608"></a>02608     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone &amp;&amp; curBone!=firstDup; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02609"></a>02609         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, curBone)) {
<a name="l02610"></a>02610             <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l02611"></a>02611                 
<a name="l02612"></a>02612                 eBone= <a class="code" href="../../dc/d26/armature__intern_8h.html#ae11b753be1df06ac01273a75a6f72ecc">duplicateEditBone</a>(curBone, curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, obedit);
<a name="l02613"></a>02613                 
<a name="l02614"></a>02614                 <span class="keywordflow">if</span> (!firstDup)
<a name="l02615"></a>02615                     firstDup=eBone;
<a name="l02616"></a>02616 
<a name="l02617"></a>02617             }
<a name="l02618"></a>02618         }
<a name="l02619"></a>02619     }
<a name="l02620"></a>02620 
<a name="l02621"></a>02621     <span class="comment">/*  Run though the list and fix the pointers */</span>
<a name="l02622"></a>02622     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone &amp;&amp; curBone!=firstDup; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02623"></a>02623         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, curBone)) {
<a name="l02624"></a>02624             <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l02625"></a>02625                 eBone=(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>*) curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02626"></a>02626                 
<a name="l02627"></a>02627                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l02628"></a>02628                     <span class="comment">/* If this bone has no parent,</span>
<a name="l02629"></a>02629 <span class="comment">                     * Set the duplicate-&gt;parent to NULL</span>
<a name="l02630"></a>02630 <span class="comment">                     */</span>
<a name="l02631"></a>02631                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02632"></a>02632                 }
<a name="l02633"></a>02633                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>) {
<a name="l02634"></a>02634                     <span class="comment">/* If this bone has a parent that was duplicated,</span>
<a name="l02635"></a>02635 <span class="comment">                     * Set the duplicate-&gt;parent to the curBone-&gt;parent-&gt;temp</span>
<a name="l02636"></a>02636 <span class="comment">                     */</span>
<a name="l02637"></a>02637                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= (<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *)curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02638"></a>02638                 }
<a name="l02639"></a>02639                 <span class="keywordflow">else</span> {
<a name="l02640"></a>02640                     <span class="comment">/* If this bone has a parent that IS not selected,</span>
<a name="l02641"></a>02641 <span class="comment">                     * Set the duplicate-&gt;parent to the curBone-&gt;parent</span>
<a name="l02642"></a>02642 <span class="comment">                     */</span>
<a name="l02643"></a>02643                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>=(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>*) curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>; 
<a name="l02644"></a>02644                     eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l02645"></a>02645                 }
<a name="l02646"></a>02646                 
<a name="l02647"></a>02647                 <span class="comment">/* Lets try to fix any constraint subtargets that might</span>
<a name="l02648"></a>02648 <span class="comment">                 * have been duplicated </span>
<a name="l02649"></a>02649 <span class="comment">                 */</span>
<a name="l02650"></a>02650                 <a class="code" href="../../dc/d26/armature__intern_8h.html#a7d1294fee2902304bd50e5c4e1d8ced6">updateDuplicateSubtarget</a>(eBone, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, obedit);
<a name="l02651"></a>02651             }
<a name="l02652"></a>02652         }
<a name="l02653"></a>02653     } 
<a name="l02654"></a>02654     
<a name="l02655"></a>02655     <span class="comment">/* correct the active bone */</span>
<a name="l02656"></a>02656     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) {
<a name="l02657"></a>02657         eBone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>;
<a name="l02658"></a>02658         <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>)
<a name="l02659"></a>02659             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c32c80b621663d70c32fbc4d5b44246">temp</a>;
<a name="l02660"></a>02660     }
<a name="l02661"></a>02661 
<a name="l02662"></a>02662     <span class="comment">/*  Deselect the old bones and select the new ones */</span>
<a name="l02663"></a>02663     <span class="keywordflow">for</span> (curBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone &amp;&amp; curBone!=firstDup; curBone=curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02664"></a>02664         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, curBone))
<a name="l02665"></a>02665             curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l02666"></a>02666     }
<a name="l02667"></a>02667 
<a name="l02668"></a>02668     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l02669"></a>02669 
<a name="l02670"></a>02670     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l02671"></a>02671     
<a name="l02672"></a>02672     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02673"></a>02673 }
<a name="l02674"></a>02674 
<a name="l02675"></a>02675 
<a name="l02676"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a826ac636514957598a307d65f4ce0d1f">02676</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#adce894f1f62674f5e64d28eb149233ed">ARMATURE_OT_duplicate</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02677"></a>02677 {
<a name="l02678"></a>02678     <span class="comment">/* identifiers */</span>
<a name="l02679"></a>02679     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Duplicate Selected Bone(s)&quot;</span>;
<a name="l02680"></a>02680     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_duplicate&quot;</span>;
<a name="l02681"></a>02681     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Make copies of the selected bones within the same armature&quot;</span>;
<a name="l02682"></a>02682     
<a name="l02683"></a>02683     <span class="comment">/* api callbacks */</span>
<a name="l02684"></a>02684     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a5ad5cae73172ac699b4b3916651f0dc9">armature_duplicate_selected_exec</a>;
<a name="l02685"></a>02685     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l02686"></a>02686     
<a name="l02687"></a>02687     <span class="comment">/* flags */</span>
<a name="l02688"></a>02688     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02689"></a>02689 }
<a name="l02690"></a>02690 
<a name="l02691"></a>02691 
<a name="l02692"></a>02692 <span class="comment">/* *************** END Adding stuff in editmode *************** */</span>
<a name="l02693"></a>02693 <span class="comment">/* ************** Add/Remove stuff in editmode **************** */</span>
<a name="l02694"></a>02694 
<a name="l02695"></a>02695 <span class="comment">/* temporary data-structure for merge/fill bones */</span>
<a name="l02696"></a><a class="code" href="../../d3/dd0/structEditBonePoint.html">02696</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> {
<a name="l02697"></a><a class="code" href="../../d3/dd0/structEditBonePoint.html#aa82cc03c483c295e3a4e950b81ebb365">02697</a>     <span class="keyword">struct </span><a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *<a class="code" href="../../d3/dd0/structEditBonePoint.html#a2c596ea22bdfe08172bff5cd79f72938">next</a>, *<a class="code" href="../../d3/dd0/structEditBonePoint.html#aa82cc03c483c295e3a4e950b81ebb365">prev</a>;
<a name="l02698"></a>02698     
<a name="l02699"></a><a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">02699</a>     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>;       <span class="comment">/* EditBone which uses this point as a &#39;head&#39; point */</span>
<a name="l02700"></a><a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">02700</a>     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>;       <span class="comment">/* EditBone which uses this point as a &#39;tail&#39; point */</span>
<a name="l02701"></a>02701     
<a name="l02702"></a><a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">02702</a>     <span class="keywordtype">float</span> <a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>[3];               <span class="comment">/* the actual location of the point in local/EditMode space */</span>
<a name="l02703"></a>02703 } <a class="code" href="../../de/dbc/editarmature_8c.html#a4ad8b02b1a6a01e4a59e9943a812d5fc">EditBonePoint</a>;
<a name="l02704"></a>02704 
<a name="l02705"></a>02705 <span class="comment">/* find chain-tips (i.e. bones without children) */</span>
<a name="l02706"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5a9b937186175dbde9ea5a586c06a9d7">02706</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5a9b937186175dbde9ea5a586c06a9d7">chains_find_tips</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *list)
<a name="l02707"></a>02707 {
<a name="l02708"></a>02708     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curBone, *ebo;
<a name="l02709"></a>02709     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *ld;
<a name="l02710"></a>02710     
<a name="l02711"></a>02711     <span class="comment">/* note: this is potentially very slow ... there&#39;s got to be a better way */</span>
<a name="l02712"></a>02712     <span class="keywordflow">for</span> (curBone= edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone= curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l02713"></a>02713         <span class="keywordtype">short</span> stop= 0;
<a name="l02714"></a>02714         
<a name="l02715"></a>02715         <span class="comment">/* is this bone contained within any existing chain? (skip if so) */</span>
<a name="l02716"></a>02716         <span class="keywordflow">for</span> (ld= list-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ld; ld= ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l02717"></a>02717             <span class="keywordflow">for</span> (ebo= ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l02718"></a>02718                 <span class="keywordflow">if</span> (ebo == curBone) {
<a name="l02719"></a>02719                     stop= 1;
<a name="l02720"></a>02720                     <span class="keywordflow">break</span>;
<a name="l02721"></a>02721                 }
<a name="l02722"></a>02722             }
<a name="l02723"></a>02723             
<a name="l02724"></a>02724             <span class="keywordflow">if</span> (stop) <span class="keywordflow">break</span>;
<a name="l02725"></a>02725         }
<a name="l02726"></a>02726         <span class="comment">/* skip current bone if it is part of an existing chain */</span>
<a name="l02727"></a>02727         <span class="keywordflow">if</span> (stop) <span class="keywordflow">continue</span>;
<a name="l02728"></a>02728         
<a name="l02729"></a>02729         <span class="comment">/* is any existing chain part of the chain formed by this bone? */</span>
<a name="l02730"></a>02730         stop= 0;
<a name="l02731"></a>02731         <span class="keywordflow">for</span> (ebo= curBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>; ebo; ebo= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l02732"></a>02732             <span class="keywordflow">for</span> (ld= list-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ld; ld= ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l02733"></a>02733                 <span class="keywordflow">if</span> (ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a> == ebo) {
<a name="l02734"></a>02734                     ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>= curBone;
<a name="l02735"></a>02735                     stop= 1;
<a name="l02736"></a>02736                     <span class="keywordflow">break</span>;
<a name="l02737"></a>02737                 }
<a name="l02738"></a>02738             }
<a name="l02739"></a>02739             
<a name="l02740"></a>02740             <span class="keywordflow">if</span> (stop) <span class="keywordflow">break</span>;
<a name="l02741"></a>02741         }
<a name="l02742"></a>02742         <span class="comment">/* current bone has already been added to a chain? */</span>
<a name="l02743"></a>02743         <span class="keywordflow">if</span> (stop) <span class="keywordflow">continue</span>;
<a name="l02744"></a>02744         
<a name="l02745"></a>02745         <span class="comment">/* add current bone to a new chain */</span>
<a name="l02746"></a>02746         ld= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/df2/structLinkData.html">LinkData</a>), <span class="stringliteral">&quot;BoneChain&quot;</span>);
<a name="l02747"></a>02747         ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>= curBone;
<a name="l02748"></a>02748         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(list, ld);
<a name="l02749"></a>02749     }
<a name="l02750"></a>02750 }
<a name="l02751"></a>02751 
<a name="l02752"></a>02752 <span class="comment">/* --------------------- */</span>
<a name="l02753"></a>02753 
<a name="l02754"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a91babc0857144376962fa14826ca653f">02754</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a91babc0857144376962fa14826ca653f">fill_add_joint</a> (<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, <span class="keywordtype">short</span> eb_tail, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *points)
<a name="l02755"></a>02755 {
<a name="l02756"></a>02756     <a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *ebp;
<a name="l02757"></a>02757     <span class="keywordtype">float</span> <a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>[3];
<a name="l02758"></a>02758     <span class="keywordtype">short</span> found= 0;
<a name="l02759"></a>02759     
<a name="l02760"></a>02760     <span class="keywordflow">if</span> (eb_tail) {
<a name="l02761"></a>02761         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02762"></a>02762     }
<a name="l02763"></a>02763     <span class="keywordflow">else</span> {
<a name="l02764"></a>02764         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02765"></a>02765     }
<a name="l02766"></a>02766     
<a name="l02767"></a>02767     <span class="keywordflow">for</span> (ebp= points-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebp; ebp= ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a2c596ea22bdfe08172bff5cd79f72938">next</a>) {
<a name="l02768"></a>02768         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, vec)) {           
<a name="l02769"></a>02769             <span class="keywordflow">if</span> (eb_tail) {
<a name="l02770"></a>02770                 <span class="keywordflow">if</span> ((ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>) &amp;&amp; (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == ebo)) {
<a name="l02771"></a>02771                     <span class="comment">/* so this bone&#39;s tail owner is this bone */</span>
<a name="l02772"></a>02772                     ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>= ebo;
<a name="l02773"></a>02773                     found= 1;
<a name="l02774"></a>02774                     <span class="keywordflow">break</span>;
<a name="l02775"></a>02775                 }
<a name="l02776"></a>02776             }
<a name="l02777"></a>02777             <span class="keywordflow">else</span> {
<a name="l02778"></a>02778                 <span class="keywordflow">if</span> ((ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>) &amp;&amp; (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>)) {
<a name="l02779"></a>02779                     <span class="comment">/* so this bone&#39;s head owner is this bone */</span>
<a name="l02780"></a>02780                     ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>= ebo;
<a name="l02781"></a>02781                     found = 1;
<a name="l02782"></a>02782                     <span class="keywordflow">break</span>;
<a name="l02783"></a>02783                 }
<a name="l02784"></a>02784             }
<a name="l02785"></a>02785         }
<a name="l02786"></a>02786     }
<a name="l02787"></a>02787     
<a name="l02788"></a>02788     <span class="comment">/* allocate a new point if no existing point was related */</span>
<a name="l02789"></a>02789     <span class="keywordflow">if</span> (found == 0) {
<a name="l02790"></a>02790         ebp= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a>), <span class="stringliteral">&quot;EditBonePoint&quot;</span>);
<a name="l02791"></a>02791         
<a name="l02792"></a>02792         <span class="keywordflow">if</span> (eb_tail) {
<a name="l02793"></a>02793             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02794"></a>02794             ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>= ebo;
<a name="l02795"></a>02795         }
<a name="l02796"></a>02796         <span class="keywordflow">else</span> {
<a name="l02797"></a>02797             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02798"></a>02798             ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>= ebo;
<a name="l02799"></a>02799         }
<a name="l02800"></a>02800         
<a name="l02801"></a>02801         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(points, ebp);
<a name="l02802"></a>02802     }
<a name="l02803"></a>02803 }
<a name="l02804"></a>02804 
<a name="l02805"></a>02805 <span class="comment">/* bone adding between selected joints */</span>
<a name="l02806"></a><a class="code" href="../../de/dbc/editarmature_8c.html#adbd5a3b4fae2fe063a033fff72b06ad9">02806</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#adbd5a3b4fae2fe063a033fff72b06ad9">armature_fill_bones_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02807"></a>02807 {
<a name="l02808"></a>02808     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02809"></a>02809     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (obedit) ? obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02810"></a>02810     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02811"></a>02811     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02812"></a>02812     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> points = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02813"></a>02813     <span class="keywordtype">int</span> count;
<a name="l02814"></a>02814 
<a name="l02815"></a>02815     <span class="comment">/* sanity checks */</span>
<a name="l02816"></a>02816     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obedit, arm))
<a name="l02817"></a>02817         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02818"></a>02818 
<a name="l02819"></a>02819     <span class="comment">/* loop over all bones, and only consider if visible */</span>
<a name="l02820"></a>02820     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, visible_bones)
<a name="l02821"></a>02821     {
<a name="l02822"></a>02822         <span class="keywordflow">if</span> (!(ebone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) &amp;&amp; (ebone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>))
<a name="l02823"></a>02823             <a class="code" href="../../de/dbc/editarmature_8c.html#a91babc0857144376962fa14826ca653f">fill_add_joint</a>(ebone, 0, &amp;points);
<a name="l02824"></a>02824         <span class="keywordflow">if</span> (ebone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) 
<a name="l02825"></a>02825             <a class="code" href="../../de/dbc/editarmature_8c.html#a91babc0857144376962fa14826ca653f">fill_add_joint</a>(ebone, 1, &amp;points);
<a name="l02826"></a>02826     }
<a name="l02827"></a>02827     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l02828"></a>02828     
<a name="l02829"></a>02829     <span class="comment">/* the number of joints determines how we fill:</span>
<a name="l02830"></a>02830 <span class="comment">     *  1) between joint and cursor (joint=head, cursor=tail)</span>
<a name="l02831"></a>02831 <span class="comment">     *  2) between the two joints (order is dependent on active-bone/hierachy)</span>
<a name="l02832"></a>02832 <span class="comment">     *  3+) error (a smarter method involving finding chains needs to be worked out</span>
<a name="l02833"></a>02833 <span class="comment">     */</span>
<a name="l02834"></a>02834     count= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;points);
<a name="l02835"></a>02835     
<a name="l02836"></a>02836     <span class="keywordflow">if</span> (count == 0) {
<a name="l02837"></a>02837         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No joints selected&quot;</span>);
<a name="l02838"></a>02838         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02839"></a>02839     }
<a name="l02840"></a>02840     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count == 1) {
<a name="l02841"></a>02841         <a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *ebp;
<a name="l02842"></a>02842         <span class="keywordtype">float</span> curs[3];
<a name="l02843"></a>02843         
<a name="l02844"></a>02844         <span class="comment">/* Get Points - selected joint */</span>
<a name="l02845"></a>02845         ebp= (<a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *)points.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02846"></a>02846         
<a name="l02847"></a>02847         <span class="comment">/* Get points - cursor (tail) */</span>
<a name="l02848"></a>02848         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02849"></a>02849         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(curs, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d));
<a name="l02850"></a>02850         
<a name="l02851"></a>02851         <span class="comment">/* Create a bone */</span>
<a name="l02852"></a>02852         <span class="comment">/* newbone= */</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aff65d1434af8f1c3508ddf2c816546c2">add_points_bone</a>(obedit, ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, curs);
<a name="l02853"></a>02853     }
<a name="l02854"></a>02854     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count == 2) {
<a name="l02855"></a>02855         <a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *ebp, *ebp2;
<a name="l02856"></a>02856         <span class="keywordtype">float</span> head[3], tail[3];
<a name="l02857"></a>02857         <span class="keywordtype">short</span> headtail = 0;
<a name="l02858"></a>02858         
<a name="l02859"></a>02859         <span class="comment">/* check that the points don&#39;t belong to the same bone */</span>
<a name="l02860"></a>02860         ebp= (<a class="code" href="../../d3/dd0/structEditBonePoint.html">EditBonePoint</a> *)points.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02861"></a>02861         ebp2= ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a2c596ea22bdfe08172bff5cd79f72938">next</a>;
<a name="l02862"></a>02862         
<a name="l02863"></a>02863         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>==ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>) &amp;&amp; (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02864"></a>02864             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Same bone selected...&quot;</span>);
<a name="l02865"></a>02865             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;points);
<a name="l02866"></a>02866             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02867"></a>02867         }
<a name="l02868"></a>02868         <span class="keywordflow">if</span> ((ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>==ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>) &amp;&amp; (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02869"></a>02869             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Same bone selected...&quot;</span>);
<a name="l02870"></a>02870             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;points);
<a name="l02871"></a>02871             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02872"></a>02872         }
<a name="l02873"></a>02873         
<a name="l02874"></a>02874         <span class="comment">/* find which one should be the &#39;head&#39; */</span>
<a name="l02875"></a>02875         <span class="keywordflow">if</span> ((ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a> &amp;&amp; ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>) || (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a> &amp;&amp; ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>)) {
<a name="l02876"></a>02876             <span class="comment">/* rule: whichever one is closer to 3d-cursor */</span>
<a name="l02877"></a>02877             <span class="keywordtype">float</span> curs[3];
<a name="l02878"></a>02878             <span class="keywordtype">float</span> vecA[3], vecB[3];
<a name="l02879"></a>02879             <span class="keywordtype">float</span> distA, distB;
<a name="l02880"></a>02880             
<a name="l02881"></a>02881             <span class="comment">/* get cursor location */</span>
<a name="l02882"></a>02882             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02883"></a>02883             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(curs, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d));
<a name="l02884"></a>02884             
<a name="l02885"></a>02885             <span class="comment">/* get distances */</span>
<a name="l02886"></a>02886             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vecA, ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, curs);
<a name="l02887"></a>02887             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vecB, ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>, curs);
<a name="l02888"></a>02888             distA= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vecA);
<a name="l02889"></a>02889             distB= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vecB);
<a name="l02890"></a>02890             
<a name="l02891"></a>02891             <span class="comment">/* compare distances - closer one therefore acts as direction for bone to go */</span>
<a name="l02892"></a>02892             headtail= (distA &lt; distB) ? 2 : 1;
<a name="l02893"></a>02893         }
<a name="l02894"></a>02894         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>) {
<a name="l02895"></a>02895             headtail = 1;
<a name="l02896"></a>02896         }
<a name="l02897"></a>02897         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>) {
<a name="l02898"></a>02898             headtail = 2;
<a name="l02899"></a>02899         }
<a name="l02900"></a>02900         
<a name="l02901"></a>02901         <span class="comment">/* assign head/tail combinations */</span>
<a name="l02902"></a>02902         <span class="keywordflow">if</span> (headtail == 2) {
<a name="l02903"></a>02903             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(head, ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>);
<a name="l02904"></a>02904             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tail, ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>);
<a name="l02905"></a>02905         }
<a name="l02906"></a>02906         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (headtail == 1) {
<a name="l02907"></a>02907             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(head, ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>);
<a name="l02908"></a>02908             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tail, ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#adcc459b7148f025bb953cfa3e094851a">vec</a>);
<a name="l02909"></a>02909         }
<a name="l02910"></a>02910         
<a name="l02911"></a>02911         <span class="comment">/* add new bone and parent it to the appropriate end */</span>
<a name="l02912"></a>02912         <span class="keywordflow">if</span> (headtail) {
<a name="l02913"></a>02913             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *newbone= <a class="code" href="../../de/dbc/editarmature_8c.html#aff65d1434af8f1c3508ddf2c816546c2">add_points_bone</a>(obedit, head, tail);
<a name="l02914"></a>02914             
<a name="l02915"></a>02915             <span class="comment">/* do parenting (will need to set connected flag too) */</span>
<a name="l02916"></a>02916             <span class="keywordflow">if</span> (headtail == 2) {
<a name="l02917"></a>02917                 <span class="comment">/* ebp tail or head - tail gets priority */</span>
<a name="l02918"></a>02918                 <span class="keywordflow">if</span> (ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>)
<a name="l02919"></a>02919                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>;
<a name="l02920"></a>02920                 <span class="keywordflow">else</span>
<a name="l02921"></a>02921                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebp-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>;
<a name="l02922"></a>02922             }
<a name="l02923"></a>02923             <span class="keywordflow">else</span> {
<a name="l02924"></a>02924                 <span class="comment">/* ebp2 tail or head - tail gets priority */</span>
<a name="l02925"></a>02925                 <span class="keywordflow">if</span> (ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>)
<a name="l02926"></a>02926                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a0824f5aa9c33be1d64b38b629b9bac13">tail_owner</a>;
<a name="l02927"></a>02927                 <span class="keywordflow">else</span>
<a name="l02928"></a>02928                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebp2-&gt;<a class="code" href="../../d3/dd0/structEditBonePoint.html#a1dbc64387024068474727107b1433bf7">head_owner</a>;
<a name="l02929"></a>02929             }
<a name="l02930"></a>02930             
<a name="l02931"></a>02931             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l02932"></a>02932         }
<a name="l02933"></a>02933     }
<a name="l02934"></a>02934     <span class="keywordflow">else</span> {
<a name="l02935"></a>02935         <span class="comment">// FIXME.. figure out a method for multiple bones</span>
<a name="l02936"></a>02936         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Too many points selected: %d\n&quot;</span>, count);
<a name="l02937"></a>02937         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;points);
<a name="l02938"></a>02938         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02939"></a>02939     }
<a name="l02940"></a>02940     
<a name="l02941"></a>02941     <span class="comment">/* updates */</span>
<a name="l02942"></a>02942     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, obedit);
<a name="l02943"></a>02943     
<a name="l02944"></a>02944     <span class="comment">/* free points */</span>
<a name="l02945"></a>02945     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;points);
<a name="l02946"></a>02946     
<a name="l02947"></a>02947     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02948"></a>02948 }
<a name="l02949"></a>02949 
<a name="l02950"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a4ebaf43ffcf74f8a95667d2dd5e2cfd4">02950</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a77bf39f50900717a7c1bdeb4cc61258e">ARMATURE_OT_fill</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02951"></a>02951 {
<a name="l02952"></a>02952     <span class="comment">/* identifiers */</span>
<a name="l02953"></a>02953     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Fill Between Joints&quot;</span>;
<a name="l02954"></a>02954     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_fill&quot;</span>;
<a name="l02955"></a>02955     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Add bone between selected joint(s) and/or 3D-Cursor&quot;</span>;
<a name="l02956"></a>02956     
<a name="l02957"></a>02957     <span class="comment">/* callbacks */</span>
<a name="l02958"></a>02958     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#adbd5a3b4fae2fe063a033fff72b06ad9">armature_fill_bones_exec</a>;
<a name="l02959"></a>02959     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l02960"></a>02960     
<a name="l02961"></a>02961     <span class="comment">/* flags */</span>
<a name="l02962"></a>02962     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02963"></a>02963 }
<a name="l02964"></a>02964 
<a name="l02965"></a>02965 <span class="comment">/* --------------------- */</span>
<a name="l02966"></a>02966 
<a name="l02967"></a>02967 <span class="comment">/* this function merges between two bones, removes them and those in-between, </span>
<a name="l02968"></a>02968 <span class="comment"> * and adjusts the parent relationships for those in-between</span>
<a name="l02969"></a>02969 <span class="comment"> */</span>
<a name="l02970"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0b4396823041ea8162c6c0d07b1bdee5">02970</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a0b4396823041ea8162c6c0d07b1bdee5">bones_merge</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *start, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *end, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *endchild, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *chains)
<a name="l02971"></a>02971 {
<a name="l02972"></a>02972     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02973"></a>02973     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, *ebone, *newbone;
<a name="l02974"></a>02974     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *chain;
<a name="l02975"></a>02975     <span class="keywordtype">float</span> head[3], tail[3];
<a name="l02976"></a>02976     
<a name="l02977"></a>02977     <span class="comment">/* check if same bone */</span>
<a name="l02978"></a>02978     <span class="keywordflow">if</span> (start == end) {
<a name="l02979"></a>02979         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) {
<a name="l02980"></a>02980             printf(<span class="stringliteral">&quot;Error: same bone!\n&quot;</span>);
<a name="l02981"></a>02981             printf(<span class="stringliteral">&quot;\tstart = %s, end = %s\n&quot;</span>, start-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, end-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>);
<a name="l02982"></a>02982         }
<a name="l02983"></a>02983     }
<a name="l02984"></a>02984     
<a name="l02985"></a>02985     <span class="comment">/* step 1: add a new bone</span>
<a name="l02986"></a>02986 <span class="comment">     *  - head = head/tail of start (default head)</span>
<a name="l02987"></a>02987 <span class="comment">     *  - tail = head/tail of end (default tail)</span>
<a name="l02988"></a>02988 <span class="comment">     *  - parent = parent of start</span>
<a name="l02989"></a>02989 <span class="comment">     */</span>
<a name="l02990"></a>02990     <span class="keywordflow">if</span> ((start-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) &amp;&amp; (start-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)==0) {
<a name="l02991"></a>02991         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(head, start-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l02992"></a>02992     }
<a name="l02993"></a>02993     <span class="keywordflow">else</span> {
<a name="l02994"></a>02994         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(head, start-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02995"></a>02995     }
<a name="l02996"></a>02996     <span class="keywordflow">if</span> ((end-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>) &amp;&amp; (end-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)==0) {
<a name="l02997"></a>02997         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tail, end-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l02998"></a>02998     }
<a name="l02999"></a>02999     <span class="keywordflow">else</span> {
<a name="l03000"></a>03000         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tail, end-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03001"></a>03001     }
<a name="l03002"></a>03002     newbone= <a class="code" href="../../de/dbc/editarmature_8c.html#aff65d1434af8f1c3508ddf2c816546c2">add_points_bone</a>(obedit, head, tail);
<a name="l03003"></a>03003     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = start-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l03004"></a>03004 
<a name="l03005"></a>03005     <span class="comment">/* TODO, copy more things to the new bone */</span>
<a name="l03006"></a>03006     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a>= start-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a2144fe3882bb6af627bc9ea3a99fae38">BONE_NO_CYCLICOFFSET</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a96060fca6e8491d622e98f7644d98b17">BONE_NO_LOCAL_LOCATION</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5720c8f427c098c3d598203cc77a92e7">BONE_DONE</a>);
<a name="l03007"></a>03007     
<a name="l03008"></a>03008     <span class="comment">/* step 2a: reparent any side chains which may be parented to any bone in the chain of bones to merge </span>
<a name="l03009"></a>03009 <span class="comment">     *  - potentially several tips for side chains leading to some tree exist...</span>
<a name="l03010"></a>03010 <span class="comment">     */</span>
<a name="l03011"></a>03011     <span class="keywordflow">for</span> (chain = chains-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; chain; chain = chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l03012"></a>03012         <span class="comment">/* traverse down chain until we hit the bottom or if we run into the tip of the chain of bones we&#39;re </span>
<a name="l03013"></a>03013 <span class="comment">         * merging (need to stop in this case to avoid corrupting this chain too!) </span>
<a name="l03014"></a>03014 <span class="comment">         */</span>
<a name="l03015"></a>03015         <span class="keywordflow">for</span> (ebone = chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>; (ebone) &amp;&amp; (ebone != end); ebone = ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03016"></a>03016             <span class="keywordtype">short</span> found = 0;
<a name="l03017"></a>03017             
<a name="l03018"></a>03018             <span class="comment">/* check if this bone is parented to one in the merging chain</span>
<a name="l03019"></a>03019 <span class="comment">             * ! WATCHIT: must only go check until end of checking chain</span>
<a name="l03020"></a>03020 <span class="comment">             */</span>
<a name="l03021"></a>03021             <span class="keywordflow">for</span> (ebo = end; (ebo) &amp;&amp; (ebo != start-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>); ebo = ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03022"></a>03022                 <span class="comment">/* side-chain found? --&gt; remap parent to new bone, then we&#39;re done with this chain :) */</span>
<a name="l03023"></a>03023                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == ebo) {
<a name="l03024"></a>03024                     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = newbone;
<a name="l03025"></a>03025                     found = 1;
<a name="l03026"></a>03026                     <span class="keywordflow">break</span>;
<a name="l03027"></a>03027                 }
<a name="l03028"></a>03028             }
<a name="l03029"></a>03029             
<a name="l03030"></a>03030             <span class="comment">/* carry on to the next tip now  */</span>
<a name="l03031"></a>03031             <span class="keywordflow">if</span> (found) 
<a name="l03032"></a>03032                 <span class="keywordflow">break</span>;
<a name="l03033"></a>03033         }
<a name="l03034"></a>03034     }
<a name="l03035"></a>03035     
<a name="l03036"></a>03036     <span class="comment">/* step 2b: parent child of end to newbone (child from this chain) */</span>
<a name="l03037"></a>03037     <span class="keywordflow">if</span> (endchild)
<a name="l03038"></a>03038         endchild-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= newbone;
<a name="l03039"></a>03039     
<a name="l03040"></a>03040     <span class="comment">/* step 3: delete all bones between and including start and end */</span>
<a name="l03041"></a>03041     <span class="keywordflow">for</span> (ebo= end; ebo; ebo= ebone) {
<a name="l03042"></a>03042         ebone= (ebo == start) ? (<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>);
<a name="l03043"></a>03043         <a class="code" href="../../de/dbc/editarmature_8c.html#ab343a9786592d506e264c3ac694f44af">bone_free</a>(arm, ebo);
<a name="l03044"></a>03044     }
<a name="l03045"></a>03045     
<a name="l03046"></a>03046     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>);
<a name="l03047"></a>03047     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03048"></a>03048 }
<a name="l03049"></a>03049 
<a name="l03050"></a>03050 
<a name="l03051"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a7195d09443ef963f3127dafe484779d0">03051</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a7195d09443ef963f3127dafe484779d0">armature_merge_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03052"></a>03052 {
<a name="l03053"></a>03053     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03054"></a>03054     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (obedit) ? obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03055"></a>03055     <span class="keywordtype">short</span> type= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l03056"></a>03056     
<a name="l03057"></a>03057     <span class="comment">/* sanity checks */</span>
<a name="l03058"></a>03058     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obedit, arm))
<a name="l03059"></a>03059         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03060"></a>03060     
<a name="l03061"></a>03061     <span class="comment">/* for now, there&#39;s only really one type of merging that&#39;s performed... */</span>
<a name="l03062"></a>03062     <span class="keywordflow">if</span> (type == 1) {
<a name="l03063"></a>03063         <span class="comment">/* go down chains, merging bones */</span>
<a name="l03064"></a>03064         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> chains = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l03065"></a>03065         <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *chain, *nchain;
<a name="l03066"></a>03066         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo;
<a name="l03067"></a>03067         
<a name="l03068"></a>03068         <a class="code" href="../../de/dbc/editarmature_8c.html#aa94906c039f3ad0ce5650e9669fb3804">armature_tag_select_mirrored</a>(arm);
<a name="l03069"></a>03069         
<a name="l03070"></a>03070         <span class="comment">/* get chains (ends on chains) */</span>
<a name="l03071"></a>03071         <a class="code" href="../../de/dbc/editarmature_8c.html#a5a9b937186175dbde9ea5a586c06a9d7">chains_find_tips</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, &amp;chains);
<a name="l03072"></a>03072         <span class="keywordflow">if</span> (chains.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03073"></a>03073         
<a name="l03074"></a>03074         <span class="comment">/* each &#39;chain&#39; is the last bone in the chain (with no children) */</span>
<a name="l03075"></a>03075         <span class="keywordflow">for</span> (chain= chains.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; chain; chain= nchain) {
<a name="l03076"></a>03076             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bstart= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *bend= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03077"></a>03077             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bchild= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *child=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03078"></a>03078             
<a name="l03079"></a>03079             <span class="comment">/* temporarily remove chain from list of chains */</span>
<a name="l03080"></a>03080             nchain= chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>;
<a name="l03081"></a>03081             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;chains, chain);
<a name="l03082"></a>03082             
<a name="l03083"></a>03083             <span class="comment">/* only consider bones that are visible and selected */</span>
<a name="l03084"></a>03084             <span class="keywordflow">for</span> (ebo=chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>; ebo; child=ebo, ebo=ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03085"></a>03085                 <span class="comment">/* check if visible + selected */</span>
<a name="l03086"></a>03086                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebo) &amp;&amp;
<a name="l03087"></a>03087                      ((ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) || (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) &amp;&amp;
<a name="l03088"></a>03088                      (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) )
<a name="l03089"></a>03089                 {
<a name="l03090"></a>03090                     <span class="comment">/* set either end or start (end gets priority, unless it is already set) */</span>
<a name="l03091"></a>03091                     <span class="keywordflow">if</span> (bend == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03092"></a>03092                         bend= ebo;
<a name="l03093"></a>03093                         bchild= child;
<a name="l03094"></a>03094                     }
<a name="l03095"></a>03095                     <span class="keywordflow">else</span> 
<a name="l03096"></a>03096                         bstart= ebo;
<a name="l03097"></a>03097                 }
<a name="l03098"></a>03098                 <span class="keywordflow">else</span> {
<a name="l03099"></a>03099                     <span class="comment">/* chain is broken... merge any continous segments then clear */</span>
<a name="l03100"></a>03100                     <span class="keywordflow">if</span> (bstart &amp;&amp; bend)
<a name="l03101"></a>03101                         <a class="code" href="../../de/dbc/editarmature_8c.html#a0b4396823041ea8162c6c0d07b1bdee5">bones_merge</a>(obedit, bstart, bend, bchild, &amp;chains);
<a name="l03102"></a>03102                     
<a name="l03103"></a>03103                     bstart = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03104"></a>03104                     bend = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03105"></a>03105                     bchild = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03106"></a>03106                 }
<a name="l03107"></a>03107             }
<a name="l03108"></a>03108             
<a name="l03109"></a>03109             <span class="comment">/* merge from bstart to bend if something not merged */</span>
<a name="l03110"></a>03110             <span class="keywordflow">if</span> (bstart &amp;&amp; bend)
<a name="l03111"></a>03111                 <a class="code" href="../../de/dbc/editarmature_8c.html#a0b4396823041ea8162c6c0d07b1bdee5">bones_merge</a>(obedit, bstart, bend, bchild, &amp;chains);
<a name="l03112"></a>03112             
<a name="l03113"></a>03113             <span class="comment">/* put back link */</span>
<a name="l03114"></a>03114             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(&amp;chains, nchain, chain);
<a name="l03115"></a>03115         }       
<a name="l03116"></a>03116         
<a name="l03117"></a>03117         <a class="code" href="../../de/dbc/editarmature_8c.html#a2420837bcbbc5edd1a2262f5553bff7d">armature_tag_unselect</a>(arm);
<a name="l03118"></a>03118         
<a name="l03119"></a>03119         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;chains);
<a name="l03120"></a>03120     }
<a name="l03121"></a>03121     
<a name="l03122"></a>03122     <span class="comment">/* updates */</span>
<a name="l03123"></a>03123     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03124"></a>03124     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, obedit);
<a name="l03125"></a>03125     
<a name="l03126"></a>03126     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03127"></a>03127 }
<a name="l03128"></a>03128 
<a name="l03129"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a4bfcd140ae9c43b0ec467453d8b76e42">03129</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a5ce937370749321b968cae92b5c14c4d">ARMATURE_OT_merge</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03130"></a>03130 {
<a name="l03131"></a>03131     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> merge_types[] = {
<a name="l03132"></a>03132         {1, <span class="stringliteral">&quot;WITHIN_CHAIN&quot;</span>, 0, <span class="stringliteral">&quot;Within Chains&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l03133"></a>03133         {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l03134"></a>03134     };
<a name="l03135"></a>03135 
<a name="l03136"></a>03136     <span class="comment">/* identifiers */</span>
<a name="l03137"></a>03137     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Merge Bones&quot;</span>;
<a name="l03138"></a>03138     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_merge&quot;</span>;
<a name="l03139"></a>03139     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Merge continuous chains of selected bones&quot;</span>;
<a name="l03140"></a>03140     
<a name="l03141"></a>03141     <span class="comment">/* callbacks */</span>
<a name="l03142"></a>03142     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l03143"></a>03143     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a7195d09443ef963f3127dafe484779d0">armature_merge_exec</a>;
<a name="l03144"></a>03144     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03145"></a>03145     
<a name="l03146"></a>03146     <span class="comment">/* flags */</span>
<a name="l03147"></a>03147     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03148"></a>03148     
<a name="l03149"></a>03149     <span class="comment">/* properties */</span>
<a name="l03150"></a>03150     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, merge_types, 0, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03151"></a>03151 }
<a name="l03152"></a>03152 
<a name="l03153"></a>03153 <span class="comment">/* ************** END Add/Remove stuff in editmode ************ */</span>
<a name="l03154"></a>03154 <span class="comment">/* *************** Tools in editmode *********** */</span>
<a name="l03155"></a>03155 
<a name="l03156"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a75878456134c913ce42ace4bf2831423">03156</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a75878456134c913ce42ace4bf2831423">armature_hide_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03157"></a>03157 {
<a name="l03158"></a>03158     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03159"></a>03159     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03160"></a>03160     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03161"></a>03161     <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d26/svm__invert_8h.html#a68699e276b6fc0d0278f5c6936c7e23d">invert</a>= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;unselected&quot;</span>) ? <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> : 0;
<a name="l03162"></a>03162 
<a name="l03163"></a>03163     <span class="comment">/* cancel if nothing selected */</span>
<a name="l03164"></a>03164     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_bones) == 0)
<a name="l03165"></a>03165         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03166"></a>03166 
<a name="l03167"></a>03167     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03168"></a>03168         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l03169"></a>03169             <span class="keywordflow">if</span> ((ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) != invert) {
<a name="l03170"></a>03170                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03171"></a>03171                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>;
<a name="l03172"></a>03172             }
<a name="l03173"></a>03173         }
<a name="l03174"></a>03174     }
<a name="l03175"></a>03175     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l03176"></a>03176     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03177"></a>03177 
<a name="l03178"></a>03178     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l03179"></a>03179 
<a name="l03180"></a>03180     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03181"></a>03181 }
<a name="l03182"></a>03182 
<a name="l03183"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a02aef7fd427ab7cc76600f437e484418">03183</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a5d6fe45b42c29bb20d8eaf4f423a48b7">ARMATURE_OT_hide</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03184"></a>03184 {
<a name="l03185"></a>03185     <span class="comment">/* identifiers */</span>
<a name="l03186"></a>03186     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Hide Selected Bones&quot;</span>;
<a name="l03187"></a>03187     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_hide&quot;</span>;
<a name="l03188"></a>03188     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Tag selected bones to not be visible in Edit Mode&quot;</span>;
<a name="l03189"></a>03189     
<a name="l03190"></a>03190     <span class="comment">/* api callbacks */</span>
<a name="l03191"></a>03191     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a75878456134c913ce42ace4bf2831423">armature_hide_exec</a>;
<a name="l03192"></a>03192     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03193"></a>03193     
<a name="l03194"></a>03194     <span class="comment">/* flags */</span>
<a name="l03195"></a>03195     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03196"></a>03196 
<a name="l03197"></a>03197     <span class="comment">/* props */</span>
<a name="l03198"></a>03198     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;unselected&quot;</span>, 0, <span class="stringliteral">&quot;Unselected&quot;</span>, <span class="stringliteral">&quot;Hide unselected rather than selected&quot;</span>);
<a name="l03199"></a>03199 }
<a name="l03200"></a>03200 
<a name="l03201"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a337a9863d568ea6a1c122a28ecb71c78">03201</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a337a9863d568ea6a1c122a28ecb71c78">armature_reveal_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l03202"></a>03202 {
<a name="l03203"></a>03203     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03204"></a>03204     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03205"></a>03205     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03206"></a>03206     
<a name="l03207"></a>03207     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03208"></a>03208         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) {
<a name="l03209"></a>03209             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>) {
<a name="l03210"></a>03210                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03211"></a>03211                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>;
<a name="l03212"></a>03212             }
<a name="l03213"></a>03213         }
<a name="l03214"></a>03214     }
<a name="l03215"></a>03215     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l03216"></a>03216     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03217"></a>03217 
<a name="l03218"></a>03218     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l03219"></a>03219 
<a name="l03220"></a>03220     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03221"></a>03221 }
<a name="l03222"></a>03222 
<a name="l03223"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ad7cf2b4c7190dc60ebb85d0841b663b7">03223</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a010d5bcffa6963e223e29d793699aff9">ARMATURE_OT_reveal</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03224"></a>03224 {
<a name="l03225"></a>03225     <span class="comment">/* identifiers */</span>
<a name="l03226"></a>03226     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Reveal Bones&quot;</span>;
<a name="l03227"></a>03227     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_reveal&quot;</span>;
<a name="l03228"></a>03228     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Unhide all bones that have been tagged to be hidden in Edit Mode&quot;</span>;
<a name="l03229"></a>03229     
<a name="l03230"></a>03230     <span class="comment">/* api callbacks */</span>
<a name="l03231"></a>03231     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a337a9863d568ea6a1c122a28ecb71c78">armature_reveal_exec</a>;
<a name="l03232"></a>03232     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03233"></a>03233     
<a name="l03234"></a>03234     <span class="comment">/* flags */</span>
<a name="l03235"></a>03235     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03236"></a>03236 
<a name="l03237"></a>03237 }
<a name="l03238"></a>03238 <span class="preprocessor">#if 0 // remove this?</span>
<a name="l03239"></a>03239 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> hide_selected_armature_bones(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l03240"></a>03240 {
<a name="l03241"></a>03241     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l03242"></a>03242     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03243"></a>03243     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03244"></a>03244     
<a name="l03245"></a>03245     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03246"></a>03246         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l03247"></a>03247             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l03248"></a>03248                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03249"></a>03249                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>;
<a name="l03250"></a>03250             }
<a name="l03251"></a>03251         }
<a name="l03252"></a>03252     }
<a name="l03253"></a>03253     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l03254"></a>03254     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03255"></a>03255 }
<a name="l03256"></a>03256 
<a name="l03257"></a>03257 <span class="keyword">static</span> <span class="keywordtype">void</span> hide_unselected_armature_bones(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l03258"></a>03258 {
<a name="l03259"></a>03259     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l03260"></a>03260     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03261"></a>03261     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03262"></a>03262     
<a name="l03263"></a>03263     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03264"></a>03264         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03265"></a>03265         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l03266"></a>03266             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>));
<a name="l03267"></a>03267             <span class="keywordflow">else</span> {
<a name="l03268"></a>03268                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>;
<a name="l03269"></a>03269             }
<a name="l03270"></a>03270         }
<a name="l03271"></a>03271     }
<a name="l03272"></a>03272 
<a name="l03273"></a>03273     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l03274"></a>03274     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03275"></a>03275 }
<a name="l03276"></a>03276 
<a name="l03277"></a>03277 <span class="keywordtype">void</span> show_all_armature_bones(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l03278"></a>03278 {
<a name="l03279"></a>03279     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l03280"></a>03280     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03281"></a>03281     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03282"></a>03282     
<a name="l03283"></a>03283     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03284"></a>03284         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>) {
<a name="l03285"></a>03285             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>) {
<a name="l03286"></a>03286                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03287"></a>03287                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>;
<a name="l03288"></a>03288             }
<a name="l03289"></a>03289         }
<a name="l03290"></a>03290     }
<a name="l03291"></a>03291     <a class="code" href="../../de/dbc/editarmature_8c.html#a35c0db71fe98d109520c401547cd0c5b">ED_armature_validate_active</a>(arm);
<a name="l03292"></a>03292     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03293"></a>03293 }
<a name="l03294"></a>03294 <span class="preprocessor">#endif</span>
<a name="l03295"></a>03295 <span class="preprocessor"></span>
<a name="l03296"></a>03296 <span class="comment">/* previously extrude_armature */</span>
<a name="l03297"></a>03297 <span class="comment">/* context; editmode armature */</span>
<a name="l03298"></a>03298 <span class="comment">/* if forked &amp;&amp; mirror-edit: makes two bones with flipped names */</span>
<a name="l03299"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a254020523fb9827890ac54b444711ee9">03299</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a254020523fb9827890ac54b444711ee9">armature_extrude_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03300"></a>03300 {
<a name="l03301"></a>03301     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit;
<a name="l03302"></a>03302     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l03303"></a>03303     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *newbone, *ebone, *flipbone, *first=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03304"></a>03304     <span class="keywordtype">int</span> a, totbone= 0, do_extrude;
<a name="l03305"></a>03305     <span class="keywordtype">int</span> forked = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;forked&quot;</span>);
<a name="l03306"></a>03306 
<a name="l03307"></a>03307     obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03308"></a>03308     arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03309"></a>03309 
<a name="l03310"></a>03310     <span class="comment">/* since we allow root extrude too, we have to make sure selection is OK */</span>
<a name="l03311"></a>03311     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03312"></a>03312         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l03313"></a>03313             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>) {
<a name="l03314"></a>03314                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l03315"></a>03315                     <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>)
<a name="l03316"></a>03316                         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l03317"></a>03317                 }
<a name="l03318"></a>03318             }
<a name="l03319"></a>03319         }
<a name="l03320"></a>03320     }
<a name="l03321"></a>03321     
<a name="l03322"></a>03322     <span class="comment">/* Duplicate the necessary bones */</span>
<a name="l03323"></a>03323     <span class="keywordflow">for</span> (ebone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ((ebone) &amp;&amp; (ebone!=first)); ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03324"></a>03324         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebone)) {
<a name="l03325"></a>03325             <span class="comment">/* we extrude per definition the tip */</span>
<a name="l03326"></a>03326             do_extrude= 0;
<a name="l03327"></a>03327             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>))
<a name="l03328"></a>03328                 do_extrude= 1;
<a name="l03329"></a>03329             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>) {
<a name="l03330"></a>03330                 <span class="comment">/* but, a bone with parent deselected we do the root... */</span>
<a name="l03331"></a>03331                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>));
<a name="l03332"></a>03332                 <span class="keywordflow">else</span> do_extrude= 2;
<a name="l03333"></a>03333             }
<a name="l03334"></a>03334             
<a name="l03335"></a>03335             <span class="keywordflow">if</span> (do_extrude) {
<a name="l03336"></a>03336                 <span class="comment">/* we re-use code for mirror editing... */</span>
<a name="l03337"></a>03337                 flipbone= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03338"></a>03338                 <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l03339"></a>03339                     flipbone= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone);
<a name="l03340"></a>03340                     <span class="keywordflow">if</span> (flipbone) {
<a name="l03341"></a>03341                         forked= 0;  <span class="comment">// we extrude 2 different bones</span>
<a name="l03342"></a>03342                         <span class="keywordflow">if</span> (flipbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>))
<a name="l03343"></a>03343                             <span class="comment">/* don&#39;t want this bone to be selected... */</span>
<a name="l03344"></a>03344                             flipbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03345"></a>03345                     }
<a name="l03346"></a>03346                     <span class="keywordflow">if</span> ((flipbone==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (forked))
<a name="l03347"></a>03347                         flipbone= ebone;
<a name="l03348"></a>03348                 }
<a name="l03349"></a>03349                 
<a name="l03350"></a>03350                 <span class="keywordflow">for</span> (a=0; a&lt;2; a++) {
<a name="l03351"></a>03351                     <span class="keywordflow">if</span> (a==1) {
<a name="l03352"></a>03352                         <span class="keywordflow">if</span> (flipbone==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03353"></a>03353                             <span class="keywordflow">break</span>;
<a name="l03354"></a>03354                         <span class="keywordflow">else</span> {
<a name="l03355"></a>03355                             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, flipbone, ebone);
<a name="l03356"></a>03356                         }
<a name="l03357"></a>03357                     }
<a name="l03358"></a>03358                     
<a name="l03359"></a>03359                     totbone++;
<a name="l03360"></a>03360                     newbone = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>), <span class="stringliteral">&quot;extrudebone&quot;</span>);
<a name="l03361"></a>03361                     
<a name="l03362"></a>03362                     <span class="keywordflow">if</span> (do_extrude==1) {
<a name="l03363"></a>03363                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03364"></a>03364                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03365"></a>03365                         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = ebone;
<a name="l03366"></a>03366                         
<a name="l03367"></a>03367                         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> = ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;  <span class="comment">// copies it, in case mirrored bone</span>
<a name="l03368"></a>03368                         
<a name="l03369"></a>03369                         <span class="keywordflow">if</span> (newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03370"></a>03370                     }
<a name="l03371"></a>03371                     <span class="keywordflow">else</span> {
<a name="l03372"></a>03372                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03373"></a>03373                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03374"></a>03374                         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l03375"></a>03375                         
<a name="l03376"></a>03376                         newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a>= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l03377"></a>03377                         
<a name="l03378"></a>03378                         <span class="keywordflow">if</span> (newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l03379"></a>03379                             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03380"></a>03380                         }
<a name="l03381"></a>03381                     }
<a name="l03382"></a>03382                     
<a name="l03383"></a>03383                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a2753960f025df5ba4b63a6b6367d88bc">weight</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a2753960f025df5ba4b63a6b6367d88bc">weight</a>;
<a name="l03384"></a>03384                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>;
<a name="l03385"></a>03385                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>;
<a name="l03386"></a>03386                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>;
<a name="l03387"></a>03387                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad9fd275367fb8380d2687f2792f55ad3">ease1</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad9fd275367fb8380d2687f2792f55ad3">ease1</a>;
<a name="l03388"></a>03388                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a1ea52dfee3cbfe086800c86d2ac30db8">ease2</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a1ea52dfee3cbfe086800c86d2ac30db8">ease2</a>;
<a name="l03389"></a>03389                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>; <span class="comment">// don&#39;t copy entire bone...</span>
<a name="l03390"></a>03390                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l03391"></a>03391                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a386520de6d24a893cc598b38535c5687">segments</a>= 1;
<a name="l03392"></a>03392                     newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a>;
<a name="l03393"></a>03393                     
<a name="l03394"></a>03394                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a> (newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>));
<a name="l03395"></a>03395                     
<a name="l03396"></a>03396                     <span class="keywordflow">if</span> (flipbone &amp;&amp; forked) {   <span class="comment">// only set if mirror edit</span>
<a name="l03397"></a>03397                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>)&lt;30) {
<a name="l03398"></a>03398                             <span class="keywordflow">if</span> (a==0) strcat(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="stringliteral">&quot;_L&quot;</span>);
<a name="l03399"></a>03399                             <span class="keywordflow">else</span> strcat(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="stringliteral">&quot;_R&quot;</span>);
<a name="l03400"></a>03400                         }
<a name="l03401"></a>03401                     }
<a name="l03402"></a>03402                     <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03403"></a>03403                     
<a name="l03404"></a>03404                     <span class="comment">/* Add the new bone to the list */</span>
<a name="l03405"></a>03405                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newbone);
<a name="l03406"></a>03406                     <span class="keywordflow">if</span> (!first)
<a name="l03407"></a>03407                         first = newbone;
<a name="l03408"></a>03408                     
<a name="l03409"></a>03409                     <span class="comment">/* restore ebone if we were flipping */</span>
<a name="l03410"></a>03410                     <span class="keywordflow">if</span> (a==1 &amp;&amp; flipbone) 
<a name="l03411"></a>03411                         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, flipbone, ebone);
<a name="l03412"></a>03412                 }
<a name="l03413"></a>03413             }
<a name="l03414"></a>03414             
<a name="l03415"></a>03415             <span class="comment">/* Deselect the old bone */</span>
<a name="l03416"></a>03416             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03417"></a>03417         }       
<a name="l03418"></a>03418     }
<a name="l03419"></a>03419     <span class="comment">/* if only one bone, make this one active */</span>
<a name="l03420"></a>03420     <span class="keywordflow">if</span> (totbone==1 &amp;&amp; first) arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= first;
<a name="l03421"></a>03421 
<a name="l03422"></a>03422     <span class="keywordflow">if</span> (totbone==0) <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03423"></a>03423 
<a name="l03424"></a>03424     <span class="comment">/* Transform the endpoints */</span>
<a name="l03425"></a>03425     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03426"></a>03426 
<a name="l03427"></a>03427     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l03428"></a>03428 
<a name="l03429"></a>03429     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03430"></a>03430 }
<a name="l03431"></a>03431 
<a name="l03432"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a89cf16de7d5e463ae79b7944e4fc0e8f">03432</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#afe3c3dc38c45c6a6348e24ed78f3ad1e">ARMATURE_OT_extrude</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03433"></a>03433 {
<a name="l03434"></a>03434     <span class="comment">/* identifiers */</span>
<a name="l03435"></a>03435     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Extrude&quot;</span>;
<a name="l03436"></a>03436     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_extrude&quot;</span>;
<a name="l03437"></a>03437     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Create new bones from the selected joints&quot;</span>;
<a name="l03438"></a>03438     
<a name="l03439"></a>03439     <span class="comment">/* api callbacks */</span>
<a name="l03440"></a>03440     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a254020523fb9827890ac54b444711ee9">armature_extrude_exec</a>;
<a name="l03441"></a>03441     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03442"></a>03442     
<a name="l03443"></a>03443     <span class="comment">/* flags */</span>
<a name="l03444"></a>03444     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03445"></a>03445     
<a name="l03446"></a>03446     <span class="comment">/* props */</span>
<a name="l03447"></a>03447     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;forked&quot;</span>, 0, <span class="stringliteral">&quot;Forked&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03448"></a>03448 }
<a name="l03449"></a>03449 <span class="comment">/* ********************** Bone Add ********************/</span>
<a name="l03450"></a>03450 
<a name="l03451"></a>03451 <span class="comment">/*op makes a new bone and returns it with its tip selected */</span>
<a name="l03452"></a>03452 
<a name="l03453"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ada209772d7ba077940c92051379b96b4">03453</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ada209772d7ba077940c92051379b96b4">armature_bone_primitive_add_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l03454"></a>03454 {
<a name="l03455"></a>03455     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d= <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l03456"></a>03456     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03457"></a>03457     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone;
<a name="l03458"></a>03458     <span class="keywordtype">float</span> obmat[3][3], curs[3], viewmat[3][3], totmat[3][3], imat[3][3];
<a name="l03459"></a>03459     <span class="keywordtype">char</span> name[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l03460"></a>03460     
<a name="l03461"></a>03461     <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;name&quot;</span>, name);
<a name="l03462"></a>03462     
<a name="l03463"></a>03463     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(curs, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C),<a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C)));  
<a name="l03464"></a>03464 
<a name="l03465"></a>03465     <span class="comment">/* Get inverse point for head and orientation for tail */</span>
<a name="l03466"></a>03466     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03467"></a>03467     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, curs);
<a name="l03468"></a>03468 
<a name="l03469"></a>03469     <span class="keywordflow">if</span> (rv3d &amp;&amp; (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a77b2559064358b40097c406230b89576">USER_ADD_VIEWALIGNED</a>))
<a name="l03470"></a>03470         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(obmat, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l03471"></a>03471     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(obmat);
<a name="l03472"></a>03472     
<a name="l03473"></a>03473     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(viewmat, obedit-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03474"></a>03474     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(totmat, obmat, viewmat);
<a name="l03475"></a>03475     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat, totmat);
<a name="l03476"></a>03476     
<a name="l03477"></a>03477     <a class="code" href="../../de/dbc/editarmature_8c.html#a6e29e50cb8f7692065a1bc44fe80cfcf">ED_armature_deselect_all</a>(obedit, 0);
<a name="l03478"></a>03478     
<a name="l03479"></a>03479     <span class="comment">/*  Create a bone   */</span>
<a name="l03480"></a>03480     bone= <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, name);
<a name="l03481"></a>03481 
<a name="l03482"></a>03482     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, curs);
<a name="l03483"></a>03483     
<a name="l03484"></a>03484     <span class="keywordflow">if</span> (rv3d &amp;&amp; (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a77b2559064358b40097c406230b89576">USER_ADD_VIEWALIGNED</a>))
<a name="l03485"></a>03485         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, imat[1]);   <span class="comment">// bone with unit length 1</span>
<a name="l03486"></a>03486     <span class="keywordflow">else</span>
<a name="l03487"></a>03487         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, imat[2]);   <span class="comment">// bone with unit length 1, pointing up Z</span>
<a name="l03488"></a>03488 
<a name="l03489"></a>03489     <span class="comment">/* note, notifier might evolve */</span>
<a name="l03490"></a>03490     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l03491"></a>03491 
<a name="l03492"></a>03492     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03493"></a>03493 }
<a name="l03494"></a>03494 
<a name="l03495"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab9f221c0307f7476edd176e181c7014d">03495</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a082747aace152f943112e089bc36f6f3">ARMATURE_OT_bone_primitive_add</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03496"></a>03496 {
<a name="l03497"></a>03497     <span class="comment">/* identifiers */</span>
<a name="l03498"></a>03498     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Add Bone&quot;</span>;
<a name="l03499"></a>03499     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_bone_primitive_add&quot;</span>;
<a name="l03500"></a>03500     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Add a new bone located at the 3D-Cursor&quot;</span>;
<a name="l03501"></a>03501     
<a name="l03502"></a>03502     <span class="comment">/* api callbacks */</span>
<a name="l03503"></a>03503     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ada209772d7ba077940c92051379b96b4">armature_bone_primitive_add_exec</a>;
<a name="l03504"></a>03504     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03505"></a>03505     
<a name="l03506"></a>03506     <span class="comment">/* flags */</span>
<a name="l03507"></a>03507     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03508"></a>03508     
<a name="l03509"></a>03509     <a class="code" href="../../dc/d7e/rna__define_8c.html#ac53a3ed18da454971065d5b4e4cb4d62">RNA_def_string</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Bone&quot;</span>, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>, <span class="stringliteral">&quot;Name&quot;</span>, <span class="stringliteral">&quot;Name of the newly created bone&quot;</span>);
<a name="l03510"></a>03510     
<a name="l03511"></a>03511 }
<a name="l03512"></a>03512 
<a name="l03513"></a>03513 
<a name="l03514"></a>03514 <span class="comment">/* ----------- */</span>
<a name="l03515"></a>03515 
<a name="l03516"></a>03516 <span class="comment">/* Subdivide Operators:</span>
<a name="l03517"></a>03517 <span class="comment"> * This group of operators all use the same &#39;exec&#39; callback, but they are called</span>
<a name="l03518"></a>03518 <span class="comment"> * through several different operators - a combined menu (which just calls the exec in the </span>
<a name="l03519"></a>03519 <span class="comment"> * appropriate ways), and two separate ones.</span>
<a name="l03520"></a>03520 <span class="comment"> */</span>
<a name="l03521"></a>03521 
<a name="l03522"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9de08e6f228bae05c8642487f873147a">03522</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a9de08e6f228bae05c8642487f873147a">armature_subdivide_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03523"></a>03523 {
<a name="l03524"></a>03524     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03525"></a>03525     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03526"></a>03526     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *newbone, *tbone;
<a name="l03527"></a>03527     <span class="keywordtype">int</span> numcuts, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03528"></a>03528     
<a name="l03529"></a>03529     <span class="comment">/* there may not be a number_cuts property defined (for &#39;simple&#39; subdivide) */</span>
<a name="l03530"></a>03530     numcuts= <a class="code" href="../../d3/d10/rna__access_8c.html#a852d694fd9e9dbdc92b6a6608e3a73ef">RNA_int_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;number_cuts&quot;</span>);
<a name="l03531"></a>03531     
<a name="l03532"></a>03532     <span class="comment">/* loop over all editable bones */</span>
<a name="l03533"></a>03533     <span class="comment">// XXX the old code did this in reverse order though!</span>
<a name="l03534"></a>03534     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones) 
<a name="l03535"></a>03535     {
<a name="l03536"></a>03536         <span class="keywordflow">for</span> (i=numcuts+1; i&gt;1; i--) {
<a name="l03537"></a>03537             <span class="comment">/* compute cut ratio first */</span>
<a name="l03538"></a>03538             <span class="keywordtype">float</span> cutratio= 1.0f / (float)i;
<a name="l03539"></a>03539             <span class="keywordtype">float</span> cutratioI= 1.0f - cutratio;
<a name="l03540"></a>03540             
<a name="l03541"></a>03541             <span class="keywordtype">float</span> val1[3];
<a name="l03542"></a>03542             <span class="keywordtype">float</span> val2[3];
<a name="l03543"></a>03543             <span class="keywordtype">float</span> val3[3];
<a name="l03544"></a>03544             
<a name="l03545"></a>03545             newbone= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a>), <span class="stringliteral">&quot;ebone subdiv&quot;</span>);
<a name="l03546"></a>03546             *newbone = *ebone;
<a name="l03547"></a>03547             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newbone);
<a name="l03548"></a>03548             
<a name="l03549"></a>03549             <span class="comment">/* calculate location of newbone-&gt;head */</span>
<a name="l03550"></a>03550             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(val1, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03551"></a>03551             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(val2, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03552"></a>03552             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(val3, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03553"></a>03553             
<a name="l03554"></a>03554             val3[0]= val1[0]*cutratio + val2[0]*cutratioI;
<a name="l03555"></a>03555             val3[1]= val1[1]*cutratio + val2[1]*cutratioI;
<a name="l03556"></a>03556             val3[2]= val1[2]*cutratio + val2[2]*cutratioI;
<a name="l03557"></a>03557             
<a name="l03558"></a>03558             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, val3);
<a name="l03559"></a>03559             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03560"></a>03560             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03561"></a>03561             
<a name="l03562"></a>03562             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= 0.5f * (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a> + ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>);
<a name="l03563"></a>03563             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>;
<a name="l03564"></a>03564             
<a name="l03565"></a>03565             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03566"></a>03566             
<a name="l03567"></a>03567             <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03568"></a>03568             
<a name="l03569"></a>03569             <span class="comment">/* correct parent bones */</span>
<a name="l03570"></a>03570             <span class="keywordflow">for</span> (tbone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tbone; tbone=tbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03571"></a>03571                 <span class="keywordflow">if</span> (tbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>==ebone)
<a name="l03572"></a>03572                     tbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= newbone;
<a name="l03573"></a>03573             }
<a name="l03574"></a>03574             newbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= ebone;
<a name="l03575"></a>03575         }
<a name="l03576"></a>03576     }
<a name="l03577"></a>03577     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l03578"></a>03578     
<a name="l03579"></a>03579     <span class="comment">/* note, notifier might evolve */</span>
<a name="l03580"></a>03580     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, obedit);
<a name="l03581"></a>03581     
<a name="l03582"></a>03582     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03583"></a>03583 }
<a name="l03584"></a>03584 
<a name="l03585"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0bb5c047b887faf7d95eea3631a859a0">03585</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a5ec9dc159a83fc9038f3d7503fe370ce">ARMATURE_OT_subdivide</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03586"></a>03586 {
<a name="l03587"></a>03587     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l03588"></a>03588 
<a name="l03589"></a>03589     <span class="comment">/* identifiers */</span>
<a name="l03590"></a>03590     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Subdivide Multi&quot;</span>;
<a name="l03591"></a>03591     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_subdivide&quot;</span>;
<a name="l03592"></a>03592     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Break selected bones into chains of smaller bones&quot;</span>;
<a name="l03593"></a>03593     
<a name="l03594"></a>03594     <span class="comment">/* api callbacks */</span>
<a name="l03595"></a>03595     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a9de08e6f228bae05c8642487f873147a">armature_subdivide_exec</a>;
<a name="l03596"></a>03596     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03597"></a>03597     
<a name="l03598"></a>03598     <span class="comment">/* flags */</span>
<a name="l03599"></a>03599     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03600"></a>03600     
<a name="l03601"></a>03601     <span class="comment">/* Properties */</span>
<a name="l03602"></a>03602     prop = <a class="code" href="../../dc/d7e/rna__define_8c.html#ad9b0c75a6330ff1837409c5d1767af62">RNA_def_int</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;number_cuts&quot;</span>, 1, 1, INT_MAX, <span class="stringliteral">&quot;Number of Cuts&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 1, 10);
<a name="l03603"></a>03603     <span class="comment">/* avoid re-using last var because it can cause _very_ high poly meshes and annoy users (or worse crash) */</span>
<a name="l03604"></a>03604     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ac49bd36c069e337f7ee269c672ef1332">PROP_SKIP_SAVE</a>);
<a name="l03605"></a>03605 }
<a name="l03606"></a>03606 
<a name="l03607"></a>03607 <span class="comment">/* ----------- */</span>
<a name="l03608"></a>03608 
<a name="l03609"></a>03609 <span class="comment">/* Switch Direction operator:</span>
<a name="l03610"></a>03610 <span class="comment"> * Currently, this does not use context loops, as context loops do not make it</span>
<a name="l03611"></a>03611 <span class="comment"> * easy to retrieve any hierarchical/chain relationships which are necessary for</span>
<a name="l03612"></a>03612 <span class="comment"> * this to be done easily.</span>
<a name="l03613"></a>03613 <span class="comment"> */</span>
<a name="l03614"></a>03614 
<a name="l03615"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a3f3ade3d8114706d90436d179a481efe">03615</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a3f3ade3d8114706d90436d179a481efe">armature_switch_direction_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op)) 
<a name="l03616"></a>03616 {
<a name="l03617"></a>03617     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03618"></a>03618     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03619"></a>03619     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> chains = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l03620"></a>03620     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *chain;
<a name="l03621"></a>03621     
<a name="l03622"></a>03622     <span class="comment">/* get chains of bones (ends on chains) */</span>
<a name="l03623"></a>03623     <a class="code" href="../../de/dbc/editarmature_8c.html#a5a9b937186175dbde9ea5a586c06a9d7">chains_find_tips</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, &amp;chains);
<a name="l03624"></a>03624     <span class="keywordflow">if</span> (chains.first == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03625"></a>03625 
<a name="l03626"></a>03626     <a class="code" href="../../de/dbc/editarmature_8c.html#aa94906c039f3ad0ce5650e9669fb3804">armature_tag_select_mirrored</a>(arm);
<a name="l03627"></a>03627 
<a name="l03628"></a>03628     <span class="comment">/* loop over chains, only considering selected and visible bones */</span>
<a name="l03629"></a>03629     <span class="keywordflow">for</span> (chain= chains.first; chain; chain= chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l03630"></a>03630         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, *child=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *parent=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03631"></a>03631         
<a name="l03632"></a>03632         <span class="comment">/* loop over bones in chain */</span>
<a name="l03633"></a>03633         <span class="keywordflow">for</span> (ebo= chain-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>; ebo; ebo= parent) {
<a name="l03634"></a>03634             <span class="comment">/* parent is this bone&#39;s original parent</span>
<a name="l03635"></a>03635 <span class="comment">             *  - we store this, as the next bone that is checked is this one</span>
<a name="l03636"></a>03636 <span class="comment">             *    but the value of ebo-&gt;parent may change here...</span>
<a name="l03637"></a>03637 <span class="comment">             */</span>
<a name="l03638"></a>03638             parent= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l03639"></a>03639             
<a name="l03640"></a>03640             <span class="comment">/* only if selected and editable */</span>
<a name="l03641"></a>03641             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, ebo) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(ebo)) {               
<a name="l03642"></a>03642                 <span class="comment">/* swap head and tail coordinates */</span>
<a name="l03643"></a>03643                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[0], ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[0]);
<a name="l03644"></a>03644                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[1], ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[1]);
<a name="l03645"></a>03645                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[2], ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[2]);
<a name="l03646"></a>03646                 
<a name="l03647"></a>03647                 <span class="comment">/* do parent swapping:</span>
<a name="l03648"></a>03648 <span class="comment">                 *  - use &#39;child&#39; as new parent</span>
<a name="l03649"></a>03649 <span class="comment">                 *  - connected flag is only set if points are coincidental</span>
<a name="l03650"></a>03650 <span class="comment">                 */</span>
<a name="l03651"></a>03651                 ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= child;
<a name="l03652"></a>03652                 <span class="keywordflow">if</span> ((child) &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, child-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>))
<a name="l03653"></a>03653                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03654"></a>03654                 <span class="keywordflow">else</span>    
<a name="l03655"></a>03655                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03656"></a>03656                 
<a name="l03657"></a>03657                 <span class="comment">/* get next bones </span>
<a name="l03658"></a>03658 <span class="comment">                 *  - child will become the new parent of next bone</span>
<a name="l03659"></a>03659 <span class="comment">                 */</span>
<a name="l03660"></a>03660                 child= ebo;
<a name="l03661"></a>03661             }
<a name="l03662"></a>03662             <span class="keywordflow">else</span> {
<a name="l03663"></a>03663                 <span class="comment">/* not swapping this bone, however, if its &#39;parent&#39; got swapped, unparent us from it </span>
<a name="l03664"></a>03664 <span class="comment">                 * as it will be facing in opposite direction</span>
<a name="l03665"></a>03665 <span class="comment">                 */</span>
<a name="l03666"></a>03666                 <span class="keywordflow">if</span> ((parent) &amp;&amp; (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, parent) &amp;&amp; <a class="code" href="../../d1/d98/ED__armature_8h.html#ab4cd18e6d1ca7c0e4434d9c46a485630">EBONE_EDITABLE</a>(parent))) {
<a name="l03667"></a>03667                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03668"></a>03668                     ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03669"></a>03669                 }
<a name="l03670"></a>03670                 
<a name="l03671"></a>03671                 <span class="comment">/* get next bones</span>
<a name="l03672"></a>03672 <span class="comment">                 *  - child will become new parent of next bone (not swapping occurred, </span>
<a name="l03673"></a>03673 <span class="comment">                 *    so set to NULL to prevent infinite-loop)</span>
<a name="l03674"></a>03674 <span class="comment">                 */</span>
<a name="l03675"></a>03675                 child= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03676"></a>03676             }
<a name="l03677"></a>03677         }
<a name="l03678"></a>03678     }
<a name="l03679"></a>03679     
<a name="l03680"></a>03680     <span class="comment">/* free chains */</span>
<a name="l03681"></a>03681     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;chains); 
<a name="l03682"></a>03682 
<a name="l03683"></a>03683     <a class="code" href="../../de/dbc/editarmature_8c.html#a2420837bcbbc5edd1a2262f5553bff7d">armature_tag_unselect</a>(arm);
<a name="l03684"></a>03684 
<a name="l03685"></a>03685     <span class="comment">/* note, notifier might evolve */</span>
<a name="l03686"></a>03686     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l03687"></a>03687     
<a name="l03688"></a>03688     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03689"></a>03689 }
<a name="l03690"></a>03690 
<a name="l03691"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abff519610cddaac7bab2e89f60e026c0">03691</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a27af41fff7c05544eab9823c6ea69d85">ARMATURE_OT_switch_direction</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03692"></a>03692 {
<a name="l03693"></a>03693     <span class="comment">/* identifiers */</span>
<a name="l03694"></a>03694     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Switch Direction&quot;</span>;
<a name="l03695"></a>03695     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_switch_direction&quot;</span>;
<a name="l03696"></a>03696     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Change the direction that a chain of bones points in (head &lt;-&gt; tail swap)&quot;</span>;
<a name="l03697"></a>03697     
<a name="l03698"></a>03698     <span class="comment">/* api callbacks */</span>
<a name="l03699"></a>03699     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a3f3ade3d8114706d90436d179a481efe">armature_switch_direction_exec</a>;
<a name="l03700"></a>03700     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03701"></a>03701     
<a name="l03702"></a>03702     <span class="comment">/* flags */</span>
<a name="l03703"></a>03703     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03704"></a>03704 }
<a name="l03705"></a>03705 <span class="comment">/* ***************** Parenting *********************** */</span>
<a name="l03706"></a>03706 
<a name="l03707"></a>03707 <span class="comment">/* armature parenting options */</span>
<a name="l03708"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ae20ad2de9dd755c25fad772dfad827d4">03708</a> <span class="preprocessor">#define ARM_PAR_CONNECT 1</span>
<a name="l03709"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab43b0f98d08ad7bc6d23ef3f66e723e9">03709</a> <span class="preprocessor"></span><span class="preprocessor">#define ARM_PAR_OFFSET  2</span>
<a name="l03710"></a>03710 <span class="preprocessor"></span>
<a name="l03711"></a>03711 <span class="comment">/* check for null, before calling! */</span>
<a name="l03712"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af752d557bff8cf06fbbb16ccdad46647">03712</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af752d557bff8cf06fbbb16ccdad46647">bone_connect_to_existing_parent</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *bone)
<a name="l03713"></a>03713 {
<a name="l03714"></a>03714     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03715"></a>03715     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03716"></a>03716     bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a> = bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l03717"></a>03717 }
<a name="l03718"></a>03718 
<a name="l03719"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9fca600150aff01b8fbb70e4ae0d9cc7">03719</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a9fca600150aff01b8fbb70e4ae0d9cc7">bone_connect_to_new_parent</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *selbone, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actbone, <span class="keywordtype">short</span> mode)
<a name="l03720"></a>03720 {
<a name="l03721"></a>03721     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone;
<a name="l03722"></a>03722     <span class="keywordtype">float</span> offset[3];
<a name="l03723"></a>03723     
<a name="l03724"></a>03724     <span class="keywordflow">if</span> ((selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) &amp;&amp; (selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>))
<a name="l03725"></a>03725         selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l03726"></a>03726     
<a name="l03727"></a>03727     <span class="comment">/* make actbone the parent of selbone */</span>
<a name="l03728"></a>03728     selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= actbone;
<a name="l03729"></a>03729     
<a name="l03730"></a>03730     <span class="comment">/* in actbone tree we cannot have a loop */</span>
<a name="l03731"></a>03731     <span class="keywordflow">for</span> (ebone= actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>; ebone; ebone= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03732"></a>03732         <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>==selbone) {
<a name="l03733"></a>03733             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03734"></a>03734             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03735"></a>03735         }
<a name="l03736"></a>03736     }
<a name="l03737"></a>03737     
<a name="l03738"></a>03738     <span class="keywordflow">if</span> (mode == <a class="code" href="../../de/dbc/editarmature_8c.html#ae20ad2de9dd755c25fad772dfad827d4">ARM_PAR_CONNECT</a>) {  
<a name="l03739"></a>03739         <span class="comment">/* Connected: Child bones will be moved to the parent tip */</span>
<a name="l03740"></a>03740         selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03741"></a>03741         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(offset, actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l03742"></a>03742         
<a name="l03743"></a>03743         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l03744"></a>03744         selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l03745"></a>03745         
<a name="l03746"></a>03746         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, offset);
<a name="l03747"></a>03747         
<a name="l03748"></a>03748         <span class="comment">/* offset for all its children */</span>
<a name="l03749"></a>03749         <span class="keywordflow">for</span> (ebone = edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebone; ebone=ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l03750"></a>03750             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *par;
<a name="l03751"></a>03751             
<a name="l03752"></a>03752             <span class="keywordflow">for</span> (par= ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>; par; par= par-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03753"></a>03753                 <span class="keywordflow">if</span> (par==selbone) {
<a name="l03754"></a>03754                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, offset);
<a name="l03755"></a>03755                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, offset);
<a name="l03756"></a>03756                     <span class="keywordflow">break</span>;
<a name="l03757"></a>03757                 }
<a name="l03758"></a>03758             }
<a name="l03759"></a>03759         }
<a name="l03760"></a>03760     }
<a name="l03761"></a>03761     <span class="keywordflow">else</span> {
<a name="l03762"></a>03762         <span class="comment">/* Offset: Child bones will retain their distance from the parent tip */</span>
<a name="l03763"></a>03763         selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03764"></a>03764     }
<a name="l03765"></a>03765 }
<a name="l03766"></a>03766 
<a name="l03767"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ad30fc1a5bdce23ea126ed8a8840d08a9">03767</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> <a class="code" href="../../de/dbc/editarmature_8c.html#ad30fc1a5bdce23ea126ed8a8840d08a9">prop_editarm_make_parent_types</a>[] = {
<a name="l03768"></a>03768     {<a class="code" href="../../de/dbc/editarmature_8c.html#ae20ad2de9dd755c25fad772dfad827d4">ARM_PAR_CONNECT</a>, <span class="stringliteral">&quot;CONNECTED&quot;</span>, 0, <span class="stringliteral">&quot;Connected&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l03769"></a>03769     {<a class="code" href="../../de/dbc/editarmature_8c.html#ab43b0f98d08ad7bc6d23ef3f66e723e9">ARM_PAR_OFFSET</a>, <span class="stringliteral">&quot;OFFSET&quot;</span>, 0, <span class="stringliteral">&quot;Keep Offset&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l03770"></a>03770     {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l03771"></a>03771 };
<a name="l03772"></a>03772 
<a name="l03773"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a72d86eb3fceecbcec8f81f6672bf173f">03773</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a72d86eb3fceecbcec8f81f6672bf173f">armature_parent_set_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l03774"></a>03774 {
<a name="l03775"></a>03775     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03776"></a>03776     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03777"></a>03777     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actbone = <a class="code" href="../../df/d01/BKE__context_8h.html#a8b7ac849448ff4c1505bf397ca920a18">CTX_data_active_bone</a>(C);
<a name="l03778"></a>03778     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actmirb = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03779"></a>03779     <span class="keywordtype">short</span> val = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l03780"></a>03780     
<a name="l03781"></a>03781     <span class="comment">/* there must be an active bone */</span>
<a name="l03782"></a>03782     <span class="keywordflow">if</span> (actbone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03783"></a>03783         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Operation requires an Active Bone&quot;</span>);
<a name="l03784"></a>03784         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03785"></a>03785     }
<a name="l03786"></a>03786     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l03787"></a>03787         <span class="comment">/* For X-Axis Mirror Editing option, we may need a mirror copy of actbone</span>
<a name="l03788"></a>03788 <span class="comment">         * - if there&#39;s a mirrored copy of selbone, try to find a mirrored copy of actbone </span>
<a name="l03789"></a>03789 <span class="comment">         *   (i.e.  selbone=&quot;child.L&quot; and actbone=&quot;parent.L&quot;, find &quot;child.R&quot; and &quot;parent.R&quot;).</span>
<a name="l03790"></a>03790 <span class="comment">         * This is useful for arm-chains, for example parenting lower arm to upper arm</span>
<a name="l03791"></a>03791 <span class="comment">         * - if there&#39;s no mirrored copy of actbone (i.e. actbone = &quot;parent.C&quot; or &quot;parent&quot;)</span>
<a name="l03792"></a>03792 <span class="comment">         *   then just use actbone. Useful when doing upper arm to spine.</span>
<a name="l03793"></a>03793 <span class="comment">         */</span>
<a name="l03794"></a>03794         actmirb= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, actbone);
<a name="l03795"></a>03795         <span class="keywordflow">if</span> (actmirb == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l03796"></a>03796             actmirb= actbone;
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798     
<a name="l03799"></a>03799     <span class="comment">/* if there is only 1 selected bone, we assume that that is the active bone, </span>
<a name="l03800"></a>03800 <span class="comment">     * since a user will need to have clicked on a bone (thus selecting it) to make it active</span>
<a name="l03801"></a>03801 <span class="comment">     */</span>
<a name="l03802"></a>03802     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_editable_bones) &lt;= 1) {
<a name="l03803"></a>03803         <span class="comment">/* When only the active bone is selected, and it has a parent,</span>
<a name="l03804"></a>03804 <span class="comment">         * connect it to the parent, as that is the only possible outcome. </span>
<a name="l03805"></a>03805 <span class="comment">         */</span>
<a name="l03806"></a>03806         <span class="keywordflow">if</span> (actbone-&gt;parent) {
<a name="l03807"></a>03807             <a class="code" href="../../de/dbc/editarmature_8c.html#af752d557bff8cf06fbbb16ccdad46647">bone_connect_to_existing_parent</a>(actbone);
<a name="l03808"></a>03808             
<a name="l03809"></a>03809             <span class="keywordflow">if</span> ((arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) &amp;&amp; (actmirb-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>))
<a name="l03810"></a>03810                 <a class="code" href="../../de/dbc/editarmature_8c.html#af752d557bff8cf06fbbb16ccdad46647">bone_connect_to_existing_parent</a>(actmirb);
<a name="l03811"></a>03811         }
<a name="l03812"></a>03812     }
<a name="l03813"></a>03813     <span class="keywordflow">else</span> {
<a name="l03814"></a>03814         <span class="comment">/* Parent &#39;selected&#39; bones to the active one</span>
<a name="l03815"></a>03815 <span class="comment">         * - the context iterator contains both selected bones and their mirrored copies,</span>
<a name="l03816"></a>03816 <span class="comment">         *   so we assume that unselected bones are mirrored copies of some selected bone</span>
<a name="l03817"></a>03817 <span class="comment">         * - since the active one (and/or its mirror) will also be selected, we also need </span>
<a name="l03818"></a>03818 <span class="comment">         *  to check that we are not trying to operate on them, since such an operation</span>
<a name="l03819"></a>03819 <span class="comment">         *  would cause errors</span>
<a name="l03820"></a>03820 <span class="comment">         */</span>
<a name="l03821"></a>03821         
<a name="l03822"></a>03822         <span class="comment">/* parent selected bones to the active one */</span>
<a name="l03823"></a>03823         <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones) {
<a name="l03824"></a>03824             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ebone, actbone, actmirb) == 0) {
<a name="l03825"></a>03825                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) 
<a name="l03826"></a>03826                     <a class="code" href="../../de/dbc/editarmature_8c.html#a9fca600150aff01b8fbb70e4ae0d9cc7">bone_connect_to_new_parent</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone, actbone, val);
<a name="l03827"></a>03827                 <span class="keywordflow">else</span>
<a name="l03828"></a>03828                     <a class="code" href="../../de/dbc/editarmature_8c.html#a9fca600150aff01b8fbb70e4ae0d9cc7">bone_connect_to_new_parent</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone, actmirb, val);
<a name="l03829"></a>03829             }
<a name="l03830"></a>03830         }
<a name="l03831"></a>03831         <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l03832"></a>03832     }
<a name="l03833"></a>03833     
<a name="l03834"></a>03834 
<a name="l03835"></a>03835     <span class="comment">/* note, notifier might evolve */</span>
<a name="l03836"></a>03836     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l03837"></a>03837     
<a name="l03838"></a>03838     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03839"></a>03839 }
<a name="l03840"></a>03840 
<a name="l03841"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a77e36622ae7587f66cfcbe90929a12a6">03841</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a77e36622ae7587f66cfcbe90929a12a6">armature_parent_set_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op), <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l03842"></a>03842 {
<a name="l03843"></a>03843     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actbone = <a class="code" href="../../df/d01/BKE__context_8h.html#a8b7ac849448ff4c1505bf397ca920a18">CTX_data_active_bone</a>(C);
<a name="l03844"></a>03844     <a class="code" href="../../d9/d4b/structuiPopupMenu.html">uiPopupMenu</a> *pup= <a class="code" href="../../d8/d1e/UI__interface_8h.html#a402c012d9cde0ff0f0808c25c4213d43">uiPupMenuBegin</a>(C, <span class="stringliteral">&quot;Make Parent &quot;</span>, ICON_NONE);
<a name="l03845"></a>03845     <a class="code" href="../../d4/d94/structuiLayout.html">uiLayout</a> *layout= <a class="code" href="../../d8/d1e/UI__interface_8h.html#a8c1b07b81987cdc2168a7417f9104cca">uiPupMenuLayout</a>(pup);
<a name="l03846"></a>03846     <span class="keywordtype">int</span> allchildbones = 0;
<a name="l03847"></a>03847     
<a name="l03848"></a>03848     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones) {
<a name="l03849"></a>03849         <span class="keywordflow">if</span> (ebone != actbone) {
<a name="l03850"></a>03850             <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> != actbone) allchildbones= 1; 
<a name="l03851"></a>03851         }   
<a name="l03852"></a>03852     }
<a name="l03853"></a>03853     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l03854"></a>03854 
<a name="l03855"></a>03855     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a6acba52fa82a73c1af44e3d52ddc5be2">uiItemEnumO</a>(layout, <span class="stringliteral">&quot;ARMATURE_OT_parent_set&quot;</span>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="../../de/dbc/editarmature_8c.html#ae20ad2de9dd755c25fad772dfad827d4">ARM_PAR_CONNECT</a>);
<a name="l03856"></a>03856     
<a name="l03857"></a>03857     <span class="comment">/* ob becomes parent, make the associated menus */</span>
<a name="l03858"></a>03858     <span class="keywordflow">if</span> (allchildbones)
<a name="l03859"></a>03859         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a6acba52fa82a73c1af44e3d52ddc5be2">uiItemEnumO</a>(layout, <span class="stringliteral">&quot;ARMATURE_OT_parent_set&quot;</span>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="../../de/dbc/editarmature_8c.html#ab43b0f98d08ad7bc6d23ef3f66e723e9">ARM_PAR_OFFSET</a>); 
<a name="l03860"></a>03860         
<a name="l03861"></a>03861     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a3ab0b4d9de253d473a16d4f329d8b50f">uiPupMenuEnd</a>(C, pup);
<a name="l03862"></a>03862     
<a name="l03863"></a>03863     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l03864"></a>03864 }
<a name="l03865"></a>03865 
<a name="l03866"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9cc7e89de6b9edf506e1fe2844b55cb5">03866</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a1ce9789d07f6c532853c4a889525159b">ARMATURE_OT_parent_set</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03867"></a>03867 {
<a name="l03868"></a>03868     <span class="comment">/* identifiers */</span>
<a name="l03869"></a>03869     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Make Parent&quot;</span>;
<a name="l03870"></a>03870     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_parent_set&quot;</span>;
<a name="l03871"></a>03871     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Set the active bone as the parent of the selected bones&quot;</span>;
<a name="l03872"></a>03872     
<a name="l03873"></a>03873     <span class="comment">/* api callbacks */</span>
<a name="l03874"></a>03874     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a77e36622ae7587f66cfcbe90929a12a6">armature_parent_set_invoke</a>;
<a name="l03875"></a>03875     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a72d86eb3fceecbcec8f81f6672bf173f">armature_parent_set_exec</a>;
<a name="l03876"></a>03876     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03877"></a>03877     
<a name="l03878"></a>03878     <span class="comment">/* flags */</span>
<a name="l03879"></a>03879     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03880"></a>03880     
<a name="l03881"></a>03881     <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, prop_editarm_make_parent_types, 0, <span class="stringliteral">&quot;ParentType&quot;</span>, <span class="stringliteral">&quot;Type of parenting&quot;</span>);
<a name="l03882"></a>03882 }
<a name="l03883"></a>03883 
<a name="l03884"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a978b36dc667687b796b8d6527f602170">03884</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> <a class="code" href="../../de/dbc/editarmature_8c.html#a978b36dc667687b796b8d6527f602170">prop_editarm_clear_parent_types</a>[] = {
<a name="l03885"></a>03885     {1, <span class="stringliteral">&quot;CLEAR&quot;</span>, 0, <span class="stringliteral">&quot;Clear Parent&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l03886"></a>03886     {2, <span class="stringliteral">&quot;DISCONNECT&quot;</span>, 0, <span class="stringliteral">&quot;Disconnect Bone&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l03887"></a>03887     {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l03888"></a>03888 };
<a name="l03889"></a>03889 
<a name="l03890"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac7aeda511ac3b6bdcf82adf25156e09b">03890</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac7aeda511ac3b6bdcf82adf25156e09b">editbone_clear_parent</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone, <span class="keywordtype">int</span> mode)
<a name="l03891"></a>03891 {
<a name="l03892"></a>03892     <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) {
<a name="l03893"></a>03893         <span class="comment">/* for nice selection */</span>
<a name="l03894"></a>03894         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l03895"></a>03895     }
<a name="l03896"></a>03896     
<a name="l03897"></a>03897     <span class="keywordflow">if</span> (mode==1) ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03898"></a>03898     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l03899"></a>03899 }
<a name="l03900"></a>03900 
<a name="l03901"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a96d2771e3dfb21d37cc84552de5374fc">03901</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a96d2771e3dfb21d37cc84552de5374fc">armature_parent_clear_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l03902"></a>03902 {
<a name="l03903"></a>03903     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l03904"></a>03904     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03905"></a>03905     <span class="keywordtype">int</span> val = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l03906"></a>03906         
<a name="l03907"></a>03907     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones) {
<a name="l03908"></a>03908         <a class="code" href="../../de/dbc/editarmature_8c.html#ac7aeda511ac3b6bdcf82adf25156e09b">editbone_clear_parent</a>(ebone, val);
<a name="l03909"></a>03909     }
<a name="l03910"></a>03910     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l03911"></a>03911     
<a name="l03912"></a>03912     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l03913"></a>03913 
<a name="l03914"></a>03914     <span class="comment">/* note, notifier might evolve */</span>
<a name="l03915"></a>03915     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l03916"></a>03916     
<a name="l03917"></a>03917     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03918"></a>03918 }
<a name="l03919"></a>03919 
<a name="l03920"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a31d22aea6645d6f0fa30ef37b68ce70e">03920</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#aa8cfbcf5f0de17930f71615a287bceca">ARMATURE_OT_parent_clear</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03921"></a>03921 {
<a name="l03922"></a>03922     <span class="comment">/* identifiers */</span>
<a name="l03923"></a>03923     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Clear Parent&quot;</span>;
<a name="l03924"></a>03924     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_parent_clear&quot;</span>;
<a name="l03925"></a>03925     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Remove the parent-child relationship between selected bones and their parents&quot;</span>;
<a name="l03926"></a>03926     
<a name="l03927"></a>03927     <span class="comment">/* api callbacks */</span>
<a name="l03928"></a>03928     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l03929"></a>03929     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a96d2771e3dfb21d37cc84552de5374fc">armature_parent_clear_exec</a>;
<a name="l03930"></a>03930     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03931"></a>03931     
<a name="l03932"></a>03932     <span class="comment">/* flags */</span>
<a name="l03933"></a>03933     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03934"></a>03934     
<a name="l03935"></a>03935     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, prop_editarm_clear_parent_types, 0, <span class="stringliteral">&quot;ClearType&quot;</span>, <span class="stringliteral">&quot;What way to clear parenting&quot;</span>);
<a name="l03936"></a>03936 }
<a name="l03937"></a>03937 
<a name="l03938"></a>03938 <span class="comment">/* ****************  Selections  ******************/</span>
<a name="l03939"></a>03939 
<a name="l03940"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac34659cd46361439aaaf48c9b2a30145">03940</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac34659cd46361439aaaf48c9b2a30145">armature_select_inverse_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l03941"></a>03941 {
<a name="l03942"></a>03942     <span class="comment">/*  Set the flags */</span>
<a name="l03943"></a>03943     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, visible_bones) {
<a name="l03944"></a>03944         <span class="comment">/* ignore bone if selection can&#39;t change */</span>
<a name="l03945"></a>03945         <span class="keywordflow">if</span> ((ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>) == 0) {
<a name="l03946"></a>03946             <span class="comment">/* select bone */</span>
<a name="l03947"></a>03947             ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> ^= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03948"></a>03948         }
<a name="l03949"></a>03949     }
<a name="l03950"></a>03950     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;   
<a name="l03951"></a>03951 
<a name="l03952"></a>03952     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03953"></a>03953     
<a name="l03954"></a>03954     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03955"></a>03955 }
<a name="l03956"></a>03956 
<a name="l03957"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a19cc492cbbf281fee71e9dcd886127d9">03957</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#ad1fb05af9c3adce6065a298f6d26dd6e">ARMATURE_OT_select_inverse</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03958"></a>03958 {
<a name="l03959"></a>03959     <span class="comment">/* identifiers */</span>
<a name="l03960"></a>03960     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Select Inverse&quot;</span>;
<a name="l03961"></a>03961     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_select_inverse&quot;</span>;
<a name="l03962"></a>03962     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Flip the selection status of bones (selected -&gt; unselected, unselected -&gt; selected)&quot;</span>;
<a name="l03963"></a>03963     
<a name="l03964"></a>03964     <span class="comment">/* api callbacks */</span>
<a name="l03965"></a>03965     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ac34659cd46361439aaaf48c9b2a30145">armature_select_inverse_exec</a>;
<a name="l03966"></a>03966     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l03967"></a>03967     
<a name="l03968"></a>03968     <span class="comment">/* flags */</span>
<a name="l03969"></a>03969     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03970"></a>03970     
<a name="l03971"></a>03971 }
<a name="l03972"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a28cd41792459d7fc72572a696503a704">03972</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a28cd41792459d7fc72572a696503a704">armature_de_select_all_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03973"></a>03973 {
<a name="l03974"></a>03974     <span class="keywordtype">int</span> action = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;action&quot;</span>);
<a name="l03975"></a>03975 
<a name="l03976"></a>03976     <span class="keywordflow">if</span> (action == <a class="code" href="../../d4/d7f/WM__api_8h.html#a070b8f09bd544f3d0bd5786ca00cda02">SEL_TOGGLE</a>) {
<a name="l03977"></a>03977         action = <a class="code" href="../../d4/d7f/WM__api_8h.html#af76323cc5b70d4cbeca6b3887e166fb8">SEL_SELECT</a>;
<a name="l03978"></a>03978         <span class="comment">/* Determine if there are any selected bones</span>
<a name="l03979"></a>03979 <span class="comment">         * And therefore whether we are selecting or deselecting */</span>
<a name="l03980"></a>03980         <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_bones) &gt; 0)
<a name="l03981"></a>03981             action = <a class="code" href="../../d4/d7f/WM__api_8h.html#a94dcbe0e237e6d615cad805221261370">SEL_DESELECT</a>;
<a name="l03982"></a>03982     }
<a name="l03983"></a>03983     
<a name="l03984"></a>03984     <span class="comment">/*  Set the flags */</span>
<a name="l03985"></a>03985     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, visible_bones) {
<a name="l03986"></a>03986         <span class="comment">/* ignore bone if selection can&#39;t change */</span>
<a name="l03987"></a>03987         <span class="keywordflow">if</span> ((ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>) == 0) {
<a name="l03988"></a>03988             <span class="keywordflow">switch</span> (action) {
<a name="l03989"></a>03989             <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#af76323cc5b70d4cbeca6b3887e166fb8">SEL_SELECT</a>:
<a name="l03990"></a>03990                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03991"></a>03991                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>)
<a name="l03992"></a>03992                     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l03993"></a>03993                 <span class="keywordflow">break</span>;
<a name="l03994"></a>03994             <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#a94dcbe0e237e6d615cad805221261370">SEL_DESELECT</a>:
<a name="l03995"></a>03995                 ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l03996"></a>03996                 <span class="keywordflow">break</span>;
<a name="l03997"></a>03997             <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#ac906797cc9a2787004c6ad16b8151913">SEL_INVERT</a>:
<a name="l03998"></a>03998                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l03999"></a>03999                     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04000"></a>04000                 } 
<a name="l04001"></a>04001                 <span class="keywordflow">else</span> {
<a name="l04002"></a>04002                     ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a> | <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04003"></a>04003                     <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>)
<a name="l04004"></a>04004                         ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>);
<a name="l04005"></a>04005                 }
<a name="l04006"></a>04006                 <span class="keywordflow">break</span>;
<a name="l04007"></a>04007             }
<a name="l04008"></a>04008         }
<a name="l04009"></a>04009     }
<a name="l04010"></a>04010     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;   
<a name="l04011"></a>04011 
<a name="l04012"></a>04012     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04013"></a>04013     
<a name="l04014"></a>04014     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l04015"></a>04015 }
<a name="l04016"></a>04016 
<a name="l04017"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0d5c0ba47252465009faa43ae3a65912">04017</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a0a10aedc71cba3f9418b8e84d5bb2c0d">ARMATURE_OT_select_all</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l04018"></a>04018 {
<a name="l04019"></a>04019     <span class="comment">/* identifiers */</span>
<a name="l04020"></a>04020     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;(De)select All&quot;</span>;
<a name="l04021"></a>04021     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_select_all&quot;</span>;
<a name="l04022"></a>04022     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Toggle selection status of all bones&quot;</span>;
<a name="l04023"></a>04023     
<a name="l04024"></a>04024     <span class="comment">/* api callbacks */</span>
<a name="l04025"></a>04025     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a28cd41792459d7fc72572a696503a704">armature_de_select_all_exec</a>;
<a name="l04026"></a>04026     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l04027"></a>04027     
<a name="l04028"></a>04028     <span class="comment">/* flags */</span>
<a name="l04029"></a>04029     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l04030"></a>04030     
<a name="l04031"></a>04031     <a class="code" href="../../d6/dae/wm__operators_8c.html#ab59cd94616324bb4f3668be8f64bdcd8">WM_operator_properties_select_all</a>(ot);
<a name="l04032"></a>04032 }
<a name="l04033"></a>04033 
<a name="l04034"></a>04034 <span class="comment">/* ********************* select hierarchy operator ************** */</span>
<a name="l04035"></a>04035 
<a name="l04036"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa0e6d9dd561e07bcd9a803060eae6cf6">04036</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aa0e6d9dd561e07bcd9a803060eae6cf6">armature_select_hierarchy_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l04037"></a>04037 {
<a name="l04038"></a>04038     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l04039"></a>04039     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l04040"></a>04040     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l04041"></a>04041     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *curbone, *pabone, *chbone;
<a name="l04042"></a>04042     <span class="keywordtype">int</span> direction = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;direction&quot;</span>);
<a name="l04043"></a>04043     <span class="keywordtype">int</span> add_to_sel = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;extend&quot;</span>);
<a name="l04044"></a>04044     
<a name="l04045"></a>04045     ob= obedit;
<a name="l04046"></a>04046     arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04047"></a>04047     
<a name="l04048"></a>04048     for (curbone= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curbone; curbone= curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l04049"></a>04049         <span class="comment">/* only work on bone if it is visible and its selection can change */</span>
<a name="l04050"></a>04050         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, curbone) &amp;&amp; (curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0) {
<a name="l04051"></a>04051             <span class="keywordflow">if</span> (curbone == arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) {
<a name="l04052"></a>04052                 <span class="keywordflow">if</span> (direction == <a class="code" href="../../d1/d98/ED__armature_8h.html#a71dea0254b907892f609fd891fdc2323">BONE_SELECT_PARENT</a>) {
<a name="l04053"></a>04053                     <span class="keywordflow">if</span> (curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l04054"></a>04054                     <span class="keywordflow">else</span> pabone = curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l04055"></a>04055                     
<a name="l04056"></a>04056                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, pabone)) {
<a name="l04057"></a>04057                         pabone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04058"></a>04058                         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= pabone;
<a name="l04059"></a>04059                         <span class="keywordflow">if</span> (pabone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) pabone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l04060"></a>04060                         
<a name="l04061"></a>04061                         <span class="keywordflow">if</span> (!add_to_sel) curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04062"></a>04062                         <span class="keywordflow">break</span>;
<a name="l04063"></a>04063                     }
<a name="l04064"></a>04064                     
<a name="l04065"></a>04065                 } 
<a name="l04066"></a>04066                 <span class="keywordflow">else</span> { <span class="comment">// BONE_SELECT_CHILD</span>
<a name="l04067"></a>04067                     chbone = <a class="code" href="../../de/dbc/editarmature_8c.html#a4ce6c25dd697792d45fa22df846b4302">editbone_get_child</a>(arm, curbone, 1);
<a name="l04068"></a>04068                     <span class="keywordflow">if</span> (chbone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l04069"></a>04069                     
<a name="l04070"></a>04070                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d98/ED__armature_8h.html#a2600e60d62d23254735aee6041901885">EBONE_VISIBLE</a>(arm, chbone) &amp;&amp; (chbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0) {
<a name="l04071"></a>04071                         chbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04072"></a>04072                         arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= chbone;
<a name="l04073"></a>04073                         
<a name="l04074"></a>04074                         <span class="keywordflow">if</span> (!add_to_sel) {
<a name="l04075"></a>04075                             curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04076"></a>04076                             <span class="keywordflow">if</span> (curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) curbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>;
<a name="l04077"></a>04077                         }
<a name="l04078"></a>04078                         <span class="keywordflow">break</span>;
<a name="l04079"></a>04079                     }
<a name="l04080"></a>04080                 }
<a name="l04081"></a>04081             }
<a name="l04082"></a>04082         }
<a name="l04083"></a>04083     }
<a name="l04084"></a>04084     
<a name="l04085"></a>04085     <a class="code" href="../../de/dbc/editarmature_8c.html#ae1aa31661fedc078073374db952bce21">ED_armature_sync_selection</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l04086"></a>04086     
<a name="l04087"></a>04087     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l04088"></a>04088     
<a name="l04089"></a>04089     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l04090"></a>04090 }
<a name="l04091"></a>04091 
<a name="l04092"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0d5c17c34f5be5e0e58832123bcaf357">04092</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#ab3d0d32345b6d1f40ca2d8b98737933b">ARMATURE_OT_select_hierarchy</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l04093"></a>04093 {
<a name="l04094"></a>04094     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> <a class="code" href="../../d0/d85/editmesh__tools_8c.html#acc0ca7eba6ad393abd6ef1d4592a738c">direction_items</a>[]= {
<a name="l04095"></a>04095     {<a class="code" href="../../d1/d98/ED__armature_8h.html#a71dea0254b907892f609fd891fdc2323">BONE_SELECT_PARENT</a>, <span class="stringliteral">&quot;PARENT&quot;</span>, 0, <span class="stringliteral">&quot;Select Parent&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l04096"></a>04096     {<a class="code" href="../../d1/d98/ED__armature_8h.html#a4c564c681e73c512da0a86465b42206a">BONE_SELECT_CHILD</a>, <span class="stringliteral">&quot;CHILD&quot;</span>, 0, <span class="stringliteral">&quot;Select Child&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l04097"></a>04097     {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l04098"></a>04098     };
<a name="l04099"></a>04099     
<a name="l04100"></a>04100     <span class="comment">/* identifiers */</span>
<a name="l04101"></a>04101     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Select Hierarchy&quot;</span>;
<a name="l04102"></a>04102     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_select_hierarchy&quot;</span>;
<a name="l04103"></a>04103     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Select immediate parent/children of selected bones&quot;</span>;
<a name="l04104"></a>04104     
<a name="l04105"></a>04105     <span class="comment">/* api callbacks */</span>
<a name="l04106"></a>04106     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#aa0e6d9dd561e07bcd9a803060eae6cf6">armature_select_hierarchy_exec</a>;
<a name="l04107"></a>04107     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l04108"></a>04108     
<a name="l04109"></a>04109     <span class="comment">/* flags */</span>
<a name="l04110"></a>04110     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l04111"></a>04111 
<a name="l04112"></a>04112     <span class="comment">/* props */</span>
<a name="l04113"></a>04113     <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;direction&quot;</span>, direction_items,
<a name="l04114"></a>04114                  <a class="code" href="../../d1/d98/ED__armature_8h.html#a71dea0254b907892f609fd891fdc2323">BONE_SELECT_PARENT</a>, <span class="stringliteral">&quot;Direction&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04115"></a>04115     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;extend&quot;</span>, 0, <span class="stringliteral">&quot;Add to Selection&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04116"></a>04116 }
<a name="l04117"></a>04117 
<a name="l04118"></a>04118 <span class="comment">/* ***************** EditBone Alignment ********************* */</span>
<a name="l04119"></a>04119 
<a name="l04120"></a>04120 <span class="comment">/* helper to fix a ebone position if its parent has moved due to alignment*/</span>
<a name="l04121"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5256b01a1a45d8c0f64978acfe6477fb">04121</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5256b01a1a45d8c0f64978acfe6477fb">fix_connected_bone</a>(<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone)
<a name="l04122"></a>04122 {
<a name="l04123"></a>04123     <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>[3];
<a name="l04124"></a>04124     
<a name="l04125"></a>04125     <span class="keywordflow">if</span> (!(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) || !(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>))
<a name="l04126"></a>04126         <span class="keywordflow">return</span>;
<a name="l04127"></a>04127     
<a name="l04128"></a>04128     <span class="comment">/* if the parent has moved we translate child&#39;s head and tail accordingly*/</span>
<a name="l04129"></a>04129     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(diff, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l04130"></a>04130     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, diff);
<a name="l04131"></a>04131     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, diff);
<a name="l04132"></a>04132     <span class="keywordflow">return</span>;
<a name="l04133"></a>04133 }
<a name="l04134"></a>04134 
<a name="l04135"></a>04135 <span class="comment">/* helper to recursively find chains of connected bones starting at ebone and fix their position */</span>
<a name="l04136"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a3c9526831381ee5e0c654db733d286ad">04136</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a3c9526831381ee5e0c654db733d286ad">fix_editbone_connected_children</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebone)
<a name="l04137"></a>04137 {
<a name="l04138"></a>04138     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *selbone;
<a name="l04139"></a>04139     
<a name="l04140"></a>04140     <span class="keywordflow">for</span> (selbone = edbo-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; selbone; selbone=selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l04141"></a>04141         <span class="keywordflow">if</span> ((selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>) &amp;&amp; (selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == ebone) &amp;&amp; (selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l04142"></a>04142             <a class="code" href="../../de/dbc/editarmature_8c.html#a5256b01a1a45d8c0f64978acfe6477fb">fix_connected_bone</a>(selbone);
<a name="l04143"></a>04143             <a class="code" href="../../de/dbc/editarmature_8c.html#a3c9526831381ee5e0c654db733d286ad">fix_editbone_connected_children</a>(edbo, selbone);
<a name="l04144"></a>04144         }
<a name="l04145"></a>04145     }
<a name="l04146"></a>04146     <span class="keywordflow">return</span>;
<a name="l04147"></a>04147 }           
<a name="l04148"></a>04148 
<a name="l04149"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">04149</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">bone_align_to_bone</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *edbo, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *selbone, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actbone)
<a name="l04150"></a>04150 {
<a name="l04151"></a>04151     <span class="keywordtype">float</span> selboneaxis[3], actboneaxis[3], <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l04152"></a>04152 
<a name="l04153"></a>04153     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(actboneaxis, actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l04154"></a>04154     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(actboneaxis);
<a name="l04155"></a>04155 
<a name="l04156"></a>04156     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(selboneaxis, selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l04157"></a>04157     length =  <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(selboneaxis);
<a name="l04158"></a>04158 
<a name="l04159"></a>04159     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(actboneaxis, length);
<a name="l04160"></a>04160     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, actboneaxis);
<a name="l04161"></a>04161     selbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a> = actbone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l04162"></a>04162     
<a name="l04163"></a>04163     <span class="comment">/* if the bone being aligned has connected descendants they must be moved</span>
<a name="l04164"></a>04164 <span class="comment">     * according to their parent new position, otherwise they would be left</span>
<a name="l04165"></a>04165 <span class="comment">     * in an inconsistent state: connected but away from the parent*/</span>
<a name="l04166"></a>04166     <a class="code" href="../../de/dbc/editarmature_8c.html#a3c9526831381ee5e0c654db733d286ad">fix_editbone_connected_children</a>(edbo, selbone);
<a name="l04167"></a>04167     <span class="keywordflow">return</span>;
<a name="l04168"></a>04168 }
<a name="l04169"></a>04169 
<a name="l04170"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a587ff93ece50e78953b1ee6c82e27679">04170</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a587ff93ece50e78953b1ee6c82e27679">armature_align_bones_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l04171"></a>04171 {
<a name="l04172"></a>04172     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l04173"></a>04173     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04174"></a>04174     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actbone= <a class="code" href="../../df/d01/BKE__context_8h.html#a8b7ac849448ff4c1505bf397ca920a18">CTX_data_active_bone</a>(C);
<a name="l04175"></a>04175     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *actmirb= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04176"></a>04176     
<a name="l04177"></a>04177     <span class="comment">/* there must be an active bone */</span>
<a name="l04178"></a>04178     <span class="keywordflow">if</span> (actbone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04179"></a>04179         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Operation requires an Active Bone&quot;</span>);
<a name="l04180"></a>04180         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l04181"></a>04181     }
<a name="l04182"></a>04182     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) {
<a name="l04183"></a>04183         <span class="comment">/* For X-Axis Mirror Editing option, we may need a mirror copy of actbone</span>
<a name="l04184"></a>04184 <span class="comment">         * - if there&#39;s a mirrored copy of selbone, try to find a mirrored copy of actbone </span>
<a name="l04185"></a>04185 <span class="comment">         *   (i.e.  selbone=&quot;child.L&quot; and actbone=&quot;parent.L&quot;, find &quot;child.R&quot; and &quot;parent.R&quot;).</span>
<a name="l04186"></a>04186 <span class="comment">         *   This is useful for arm-chains, for example parenting lower arm to upper arm</span>
<a name="l04187"></a>04187 <span class="comment">         * - if there&#39;s no mirrored copy of actbone (i.e. actbone = &quot;parent.C&quot; or &quot;parent&quot;)</span>
<a name="l04188"></a>04188 <span class="comment">         *   then just use actbone. Useful when doing upper arm to spine.</span>
<a name="l04189"></a>04189 <span class="comment">         */</span>
<a name="l04190"></a>04190         actmirb= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, actbone);
<a name="l04191"></a>04191         <span class="keywordflow">if</span> (actmirb == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l04192"></a>04192             actmirb= actbone;
<a name="l04193"></a>04193     }
<a name="l04194"></a>04194     
<a name="l04195"></a>04195     <span class="comment">/* if there is only 1 selected bone, we assume that that is the active bone, </span>
<a name="l04196"></a>04196 <span class="comment">     * since a user will need to have clicked on a bone (thus selecting it) to make it active</span>
<a name="l04197"></a>04197 <span class="comment">     */</span>
<a name="l04198"></a>04198     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_editable_bones) &lt;= 1) {
<a name="l04199"></a>04199         <span class="comment">/* When only the active bone is selected, and it has a parent,</span>
<a name="l04200"></a>04200 <span class="comment">         * align it to the parent, as that is the only possible outcome. </span>
<a name="l04201"></a>04201 <span class="comment">         */</span>
<a name="l04202"></a>04202         <span class="keywordflow">if</span> (actbone-&gt;parent) {
<a name="l04203"></a>04203             <a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">bone_align_to_bone</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, actbone, actbone-&gt;parent);
<a name="l04204"></a>04204             
<a name="l04205"></a>04205             <span class="keywordflow">if</span> ((arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837ac63b48df57afb245354fefdc20d0a98a">ARM_MIRROR_EDIT</a>) &amp;&amp; (actmirb-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>))
<a name="l04206"></a>04206                 <a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">bone_align_to_bone</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, actmirb, actmirb-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>);
<a name="l04207"></a>04207         }
<a name="l04208"></a>04208     }
<a name="l04209"></a>04209     <span class="keywordflow">else</span> {
<a name="l04210"></a>04210         <span class="comment">/* Align &#39;selected&#39; bones to the active one</span>
<a name="l04211"></a>04211 <span class="comment">         * - the context iterator contains both selected bones and their mirrored copies,</span>
<a name="l04212"></a>04212 <span class="comment">         *   so we assume that unselected bones are mirrored copies of some selected bone</span>
<a name="l04213"></a>04213 <span class="comment">         * - since the active one (and/or its mirror) will also be selected, we also need </span>
<a name="l04214"></a>04214 <span class="comment">         *   to check that we are not trying to operate on them, since such an operation</span>
<a name="l04215"></a>04215 <span class="comment">         *   would cause errors</span>
<a name="l04216"></a>04216 <span class="comment">         */</span>
<a name="l04217"></a>04217         
<a name="l04218"></a>04218         <span class="comment">/* align selected bones to the active one */</span>
<a name="l04219"></a>04219         <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones) {
<a name="l04220"></a>04220             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ebone, actbone, actmirb) == 0) {
<a name="l04221"></a>04221                 <span class="keywordflow">if</span> (ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)
<a name="l04222"></a>04222                     <a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">bone_align_to_bone</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone, actbone);
<a name="l04223"></a>04223                 <span class="keywordflow">else</span>
<a name="l04224"></a>04224                     <a class="code" href="../../de/dbc/editarmature_8c.html#a5f1c7f26bd26c4e5e14a4f07e7ec1390">bone_align_to_bone</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebone, actmirb);
<a name="l04225"></a>04225             }
<a name="l04226"></a>04226         }
<a name="l04227"></a>04227         <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l04228"></a>04228     }
<a name="l04229"></a>04229     
<a name="l04230"></a>04230 
<a name="l04231"></a>04231     <span class="comment">/* note, notifier might evolve */</span>
<a name="l04232"></a>04232     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aad6e17340eb558c0caa7c874dc0812f3">ND_TRANSFORM</a>, ob);
<a name="l04233"></a>04233     
<a name="l04234"></a>04234     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l04235"></a>04235 }
<a name="l04236"></a>04236 
<a name="l04237"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a77440c13f07cd9b4c11b8c2ed42b282f">04237</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a905e42e64ad09e047c03ae9c16e07be6">ARMATURE_OT_align</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l04238"></a>04238 {
<a name="l04239"></a>04239     <span class="comment">/* identifiers */</span>
<a name="l04240"></a>04240     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Align Bones&quot;</span>;
<a name="l04241"></a>04241     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_align&quot;</span>;
<a name="l04242"></a>04242     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Align selected bones to the active bone (or to their parent)&quot;</span>;
<a name="l04243"></a>04243     
<a name="l04244"></a>04244     <span class="comment">/* api callbacks */</span>
<a name="l04245"></a>04245     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a63ac1372a9efaaca8bec8660ff770026">WM_operator_confirm</a>;
<a name="l04246"></a>04246     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a587ff93ece50e78953b1ee6c82e27679">armature_align_bones_exec</a>;
<a name="l04247"></a>04247     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l04248"></a>04248     
<a name="l04249"></a>04249     <span class="comment">/* flags */</span>
<a name="l04250"></a>04250     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l04251"></a>04251 }
<a name="l04252"></a>04252 
<a name="l04253"></a>04253 <span class="comment">/* ***************** Pose tools ********************* */</span>
<a name="l04254"></a>04254 
<a name="l04255"></a>04255 <span class="comment">// XXX bone_looper is only to be used when we want to access settings (i.e. editability/visibility/selected) that context doesn&#39;t offer </span>
<a name="l04256"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">04256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>,
<a name="l04257"></a>04257                 <span class="keywordtype">int</span> (*bone_func)(<a class="code" href="../../de/de7/structObject.html">Object</a> *, <a class="code" href="../../de/de0/structBone.html">Bone</a> *, <span class="keywordtype">void</span> *)) 
<a name="l04258"></a>04258 {
<a name="l04259"></a>04259     <span class="comment">/* We want to apply the function bone_func to every bone </span>
<a name="l04260"></a>04260 <span class="comment">     * in an armature -- feed bone_looper the first bone and </span>
<a name="l04261"></a>04261 <span class="comment">     * a pointer to the bone_func and watch it go!. The int count </span>
<a name="l04262"></a>04262 <span class="comment">     * can be useful for counting bones with a certain property</span>
<a name="l04263"></a>04263 <span class="comment">     * (e.g. skinnable)</span>
<a name="l04264"></a>04264 <span class="comment">     */</span>
<a name="l04265"></a>04265     <span class="keywordtype">int</span> count = 0;
<a name="l04266"></a>04266     
<a name="l04267"></a>04267     <span class="keywordflow">if</span> (bone) {
<a name="l04268"></a>04268         <span class="comment">/* only do bone_func if the bone is non null */</span>
<a name="l04269"></a>04269         count += bone_func(ob, bone, data);
<a name="l04270"></a>04270         
<a name="l04271"></a>04271         <span class="comment">/* try to execute bone_func for the first child */</span>
<a name="l04272"></a>04272         count += <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, data, bone_func);
<a name="l04273"></a>04273         
<a name="l04274"></a>04274         <span class="comment">/* try to execute bone_func for the next bone at this</span>
<a name="l04275"></a>04275 <span class="comment">         * depth of the recursion.</span>
<a name="l04276"></a>04276 <span class="comment">         */</span>
<a name="l04277"></a>04277         count += <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>, data, bone_func);
<a name="l04278"></a>04278     }
<a name="l04279"></a>04279     
<a name="l04280"></a>04280     <span class="keywordflow">return</span> count;
<a name="l04281"></a>04281 }
<a name="l04282"></a>04282 
<a name="l04283"></a>04283 <span class="comment">/* called from editview.c, for mode-less pose selection */</span>
<a name="l04284"></a>04284 <span class="comment">/* assumes scene obact and basact is still on old situation */</span>
<a name="l04285"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a2dd87792f8737c54886457569efcf9ef">04285</a> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac08e07dec36fe1fa069f3cd1e6c779c9">ED_do_pose_selectbuffer</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d3/da9/structBase.html">Base</a> *base, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *buffer, <span class="keywordtype">short</span> hits, <span class="keywordtype">short</span> extend)
<a name="l04286"></a>04286 {
<a name="l04287"></a>04287     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l04288"></a>04288     <a class="code" href="../../de/de0/structBone.html">Bone</a> *nearBone;
<a name="l04289"></a>04289     
<a name="l04290"></a>04290     <span class="keywordflow">if</span> (!ob || !ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) <span class="keywordflow">return</span> 0;
<a name="l04291"></a>04291 
<a name="l04292"></a>04292     nearBone= <a class="code" href="../../de/dbc/editarmature_8c.html#af60e1140453df41a61a691547542c0a5">get_bone_from_selectbuffer</a>(scene, base, buffer, hits, 1);
<a name="l04293"></a>04293     
<a name="l04294"></a>04294     <span class="comment">/* if the bone cannot be affected, don&#39;t do anything */</span>
<a name="l04295"></a>04295     <span class="keywordflow">if</span> ((nearBone) &amp;&amp; !(nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)) {
<a name="l04296"></a>04296         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob_act= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>;
<a name="l04297"></a>04297         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04298"></a>04298         
<a name="l04299"></a>04299         <span class="comment">/* since we do unified select, we don&#39;t shift+select a bone if the</span>
<a name="l04300"></a>04300 <span class="comment">         * armature object was not active yet.</span>
<a name="l04301"></a>04301 <span class="comment">         * note, special exception for armature mode so we can do multi-select</span>
<a name="l04302"></a>04302 <span class="comment">         * we could check for multi-select explicitly but think its fine to</span>
<a name="l04303"></a>04303 <span class="comment">         * always give predictable behavior in weight paint mode - campbell */</span>
<a name="l04304"></a>04304         <span class="keywordflow">if</span> (!extend || ((ob_act &amp;&amp; (ob_act != ob) &amp;&amp; (ob_act-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>)==0))) {
<a name="l04305"></a>04305             <a class="code" href="../../de/dbc/editarmature_8c.html#ac8399d2699b5f7ecf96ac504f6f40c42">ED_pose_deselectall</a>(ob, 0);
<a name="l04306"></a>04306             nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04307"></a>04307             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= nearBone;
<a name="l04308"></a>04308             
<a name="l04309"></a>04309                 <span class="comment">// XXX old cruft! use notifiers instead</span>
<a name="l04310"></a>04310             <span class="comment">//select_actionchannel_by_name(ob-&gt;action, nearBone-&gt;name, 1);</span>
<a name="l04311"></a>04311         }
<a name="l04312"></a>04312         <span class="keywordflow">else</span> {
<a name="l04313"></a>04313             <span class="keywordflow">if</span> (nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l04314"></a>04314                 <span class="comment">/* if not active, we make it active */</span>
<a name="l04315"></a>04315                 <span class="keywordflow">if</span> (nearBone != arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>) {
<a name="l04316"></a>04316                     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= nearBone;
<a name="l04317"></a>04317                 }
<a name="l04318"></a>04318                 <span class="keywordflow">else</span> {
<a name="l04319"></a>04319                     nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04320"></a>04320                     
<a name="l04321"></a>04321                         <span class="comment">// XXX old cruft! use notifiers instead</span>
<a name="l04322"></a>04322                     <span class="comment">//select_actionchannel_by_name(ob-&gt;action, nearBone-&gt;name, 0);</span>
<a name="l04323"></a>04323                 }
<a name="l04324"></a>04324             }
<a name="l04325"></a>04325             <span class="keywordflow">else</span> {
<a name="l04326"></a>04326                 nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04327"></a>04327                 arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= nearBone;
<a name="l04328"></a>04328                 
<a name="l04329"></a>04329                     <span class="comment">// XXX old cruft! use notifiers instead</span>
<a name="l04330"></a>04330                 <span class="comment">//select_actionchannel_by_name(ob-&gt;action, nearBone-&gt;name, 1);</span>
<a name="l04331"></a>04331             }
<a name="l04332"></a>04332         }
<a name="l04333"></a>04333         
<a name="l04334"></a>04334         <span class="comment">/* in weightpaint we select the associated vertex group too */</span>
<a name="l04335"></a>04335         <span class="keywordflow">if</span> (ob_act &amp;&amp; ob_act-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) {
<a name="l04336"></a>04336             <span class="keywordflow">if</span> (nearBone == arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>) {
<a name="l04337"></a>04337                 <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ab0fb64913370413c4e4be54a23171dca">ED_vgroup_select_by_name</a>(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>, nearBone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l04338"></a>04338                 <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>-&gt;id, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l04339"></a>04339             }
<a name="l04340"></a>04340         }
<a name="l04341"></a>04341         
<a name="l04342"></a>04342     }
<a name="l04343"></a>04343     
<a name="l04344"></a>04344     <span class="keywordflow">return</span> nearBone!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04345"></a>04345 }
<a name="l04346"></a>04346 
<a name="l04347"></a>04347 <span class="comment">/* test==0: deselect all</span>
<a name="l04348"></a>04348 <span class="comment"> * test==1: swap select (apply to all the opposite of current situation) </span>
<a name="l04349"></a>04349 <span class="comment"> * test==2: only clear active tag</span>
<a name="l04350"></a>04350 <span class="comment"> * test==3: swap select (no test / inverse selection status of all independently)</span>
<a name="l04351"></a>04351 <span class="comment"> */</span>
<a name="l04352"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a7d9093b87e6a33299e57e6544103bd36">04352</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac8399d2699b5f7ecf96ac504f6f40c42">ED_pose_deselectall</a> (<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> test)
<a name="l04353"></a>04353 {
<a name="l04354"></a>04354     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04355"></a>04355     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l04356"></a>04356     <span class="keywordtype">int</span> selectmode= 0;
<a name="l04357"></a>04357     
<a name="l04358"></a>04358     <span class="comment">/* we call this from outliner too */</span>
<a name="l04359"></a>04359     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>)) <span class="keywordflow">return</span>;
<a name="l04360"></a>04360     
<a name="l04361"></a>04361     <span class="comment">/*  Determine if we&#39;re selecting or deselecting */</span>
<a name="l04362"></a>04362     <span class="keywordflow">if</span> (test==1) {
<a name="l04363"></a>04363         <span class="keywordflow">for</span> (pchan= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l04364"></a>04364             <span class="keywordflow">if</span> (<a class="code" href="../../da/d17/BKE__armature_8h.html#a98bb7bb8d3c78d1b5a0d725b58e3ac35">PBONE_VISIBLE</a>(arm, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>)) {
<a name="l04365"></a>04365                 <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)
<a name="l04366"></a>04366                     <span class="keywordflow">break</span>;
<a name="l04367"></a>04367             }
<a name="l04368"></a>04368         }
<a name="l04369"></a>04369         
<a name="l04370"></a>04370         <span class="keywordflow">if</span> (pchan == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04371"></a>04371             selectmode= 1;
<a name="l04372"></a>04372     }
<a name="l04373"></a>04373     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (test == 2)
<a name="l04374"></a>04374         selectmode= 2;
<a name="l04375"></a>04375     
<a name="l04376"></a>04376     <span class="comment">/*  Set the flags accordingly   */</span>
<a name="l04377"></a>04377     <span class="keywordflow">for</span> (pchan= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l04378"></a>04378         <span class="comment">/* ignore the pchan if it isn&#39;t visible or if its selection cannot be changed */</span>
<a name="l04379"></a>04379         <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a> &amp; arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>))) {
<a name="l04380"></a>04380             <span class="keywordflow">if</span> (test==3) {
<a name="l04381"></a>04381                 pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> ^= (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04382"></a>04382             }
<a name="l04383"></a>04383             <span class="keywordflow">else</span> {
<a name="l04384"></a>04384                 <span class="keywordflow">if</span> (selectmode==0) pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l04385"></a>04385                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (selectmode==1) pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l04386"></a>04386             }
<a name="l04387"></a>04387         }
<a name="l04388"></a>04388     }
<a name="l04389"></a>04389 }
<a name="l04390"></a>04390 
<a name="l04391"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af2416d16573f485d64ef60c67def5724">04391</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af2416d16573f485d64ef60c67def5724">bone_skinnable_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *datap)
<a name="l04392"></a>04392 {
<a name="l04393"></a>04393     <span class="comment">/* Bones that are deforming</span>
<a name="l04394"></a>04394 <span class="comment">     * are regarded to be &quot;skinnable&quot; and are eligible for</span>
<a name="l04395"></a>04395 <span class="comment">     * auto-skinning.</span>
<a name="l04396"></a>04396 <span class="comment">     *</span>
<a name="l04397"></a>04397 <span class="comment">     * This function performs 2 functions:</span>
<a name="l04398"></a>04398 <span class="comment">     *</span>
<a name="l04399"></a>04399 <span class="comment">     *   a) It returns 1 if the bone is skinnable.</span>
<a name="l04400"></a>04400 <span class="comment">     *      If we loop over all bones with this </span>
<a name="l04401"></a>04401 <span class="comment">     *      function, we can count the number of</span>
<a name="l04402"></a>04402 <span class="comment">     *      skinnable bones.</span>
<a name="l04403"></a>04403 <span class="comment">     *   b) If the pointer data is non null,</span>
<a name="l04404"></a>04404 <span class="comment">     *      it is treated like a handle to a</span>
<a name="l04405"></a>04405 <span class="comment">     *      bone pointer -- the bone pointer</span>
<a name="l04406"></a>04406 <span class="comment">     *      is set to point at this bone, and</span>
<a name="l04407"></a>04407 <span class="comment">     *      the pointer the handle points to</span>
<a name="l04408"></a>04408 <span class="comment">     *      is incremented to point to the</span>
<a name="l04409"></a>04409 <span class="comment">     *      next member of an array of pointers</span>
<a name="l04410"></a>04410 <span class="comment">     *      to bones. This way we can loop using</span>
<a name="l04411"></a>04411 <span class="comment">     *      this function to construct an array of</span>
<a name="l04412"></a>04412 <span class="comment">     *      pointers to bones that point to all</span>
<a name="l04413"></a>04413 <span class="comment">     *      skinnable bones.</span>
<a name="l04414"></a>04414 <span class="comment">     */</span>
<a name="l04415"></a>04415     <a class="code" href="../../de/de0/structBone.html">Bone</a> ***hbone;
<a name="l04416"></a>04416     <span class="keywordtype">int</span> a, segments;
<a name="l04417"></a>04417     <span class="keyword">struct </span>{ <a class="code" href="../../de/de7/structObject.html">Object</a> *armob; <span class="keywordtype">void</span> *list; <span class="keywordtype">int</span> heat; } *data = datap;
<a name="l04418"></a>04418 
<a name="l04419"></a>04419     <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) || !(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>)) {
<a name="l04420"></a>04420         <span class="keywordflow">if</span> (!(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>)) {
<a name="l04421"></a>04421             <span class="keywordflow">if</span> (data-&gt;heat &amp;&amp; data-&gt;armob-&gt;pose &amp;&amp; <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(data-&gt;armob-&gt;pose, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>))
<a name="l04422"></a>04422                 segments = bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>;
<a name="l04423"></a>04423             <span class="keywordflow">else</span>
<a name="l04424"></a>04424                 segments = 1;
<a name="l04425"></a>04425             
<a name="l04426"></a>04426             <span class="keywordflow">if</span> (data-&gt;list != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04427"></a>04427                 hbone = (<a class="code" href="../../de/de0/structBone.html">Bone</a> ***) &amp;data-&gt;list;
<a name="l04428"></a>04428                 
<a name="l04429"></a>04429                 for (a=0; a&lt;segments; a++) {
<a name="l04430"></a>04430                     **hbone = bone;
<a name="l04431"></a>04431                     ++*hbone;
<a name="l04432"></a>04432                 }
<a name="l04433"></a>04433             }
<a name="l04434"></a>04434             <span class="keywordflow">return</span> segments;
<a name="l04435"></a>04435         }
<a name="l04436"></a>04436     }
<a name="l04437"></a>04437     <span class="keywordflow">return</span> 0;
<a name="l04438"></a>04438 }
<a name="l04439"></a>04439 
<a name="l04440"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ada5ec87422f762b0b8d44b2b9560f852">04440</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ada5ec87422f762b0b8d44b2b9560f852">vgroup_add_unique_bone_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr)) 
<a name="l04441"></a>04441 {
<a name="l04442"></a>04442     <span class="comment">/* This group creates a vertex group to ob that has the</span>
<a name="l04443"></a>04443 <span class="comment">     * same name as bone (provided the bone is skinnable). </span>
<a name="l04444"></a>04444 <span class="comment">     * If such a vertex group aleady exist the routine exits.</span>
<a name="l04445"></a>04445 <span class="comment">     */</span>
<a name="l04446"></a>04446     <span class="keywordflow">if</span> (!(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>)) {
<a name="l04447"></a>04447         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob,bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>)) {
<a name="l04448"></a>04448             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#af563a0e7930017802f6403c33de6a5f6">ED_vgroup_add_name</a>(ob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l04449"></a>04449             <span class="keywordflow">return</span> 1;
<a name="l04450"></a>04450         }
<a name="l04451"></a>04451     }
<a name="l04452"></a>04452     <span class="keywordflow">return</span> 0;
<a name="l04453"></a>04453 }
<a name="l04454"></a>04454 
<a name="l04455"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a75f324e6acd59ac8144efb0a78bbc63c">04455</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a75f324e6acd59ac8144efb0a78bbc63c">dgroup_skinnable_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *datap) 
<a name="l04456"></a>04456 {
<a name="l04457"></a>04457     <span class="comment">/* Bones that are deforming</span>
<a name="l04458"></a>04458 <span class="comment">     * are regarded to be &quot;skinnable&quot; and are eligible for</span>
<a name="l04459"></a>04459 <span class="comment">     * auto-skinning.</span>
<a name="l04460"></a>04460 <span class="comment">     *</span>
<a name="l04461"></a>04461 <span class="comment">     * This function performs 2 functions:</span>
<a name="l04462"></a>04462 <span class="comment">     *</span>
<a name="l04463"></a>04463 <span class="comment">     *   a) If the bone is skinnable, it creates </span>
<a name="l04464"></a>04464 <span class="comment">     *      a vertex group for ob that has</span>
<a name="l04465"></a>04465 <span class="comment">     *      the name of the skinnable bone</span>
<a name="l04466"></a>04466 <span class="comment">     *      (if one doesn&#39;t exist already).</span>
<a name="l04467"></a>04467 <span class="comment">     *   b) If the pointer data is non null,</span>
<a name="l04468"></a>04468 <span class="comment">     *      it is treated like a handle to a</span>
<a name="l04469"></a>04469 <span class="comment">     *      bDeformGroup pointer -- the </span>
<a name="l04470"></a>04470 <span class="comment">     *      bDeformGroup pointer is set to point</span>
<a name="l04471"></a>04471 <span class="comment">     *      to the deform group with the bone&#39;s</span>
<a name="l04472"></a>04472 <span class="comment">     *      name, and the pointer the handle </span>
<a name="l04473"></a>04473 <span class="comment">     *      points to is incremented to point to the</span>
<a name="l04474"></a>04474 <span class="comment">     *      next member of an array of pointers</span>
<a name="l04475"></a>04475 <span class="comment">     *      to bDeformGroups. This way we can loop using</span>
<a name="l04476"></a>04476 <span class="comment">     *      this function to construct an array of</span>
<a name="l04477"></a>04477 <span class="comment">     *      pointers to bDeformGroups, all with names</span>
<a name="l04478"></a>04478 <span class="comment">     *      of skinnable bones.</span>
<a name="l04479"></a>04479 <span class="comment">     */</span>
<a name="l04480"></a>04480     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> ***hgroup, *defgroup= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04481"></a>04481     <span class="keywordtype">int</span> a, segments;
<a name="l04482"></a>04482     <span class="keyword">struct </span>{ <a class="code" href="../../de/de7/structObject.html">Object</a> *armob; <span class="keywordtype">void</span> *list; <span class="keywordtype">int</span> heat; } *data= datap;
<a name="l04483"></a>04483     <span class="keywordtype">int</span> wpmode = (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>);
<a name="l04484"></a>04484     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= data-&gt;armob-&gt;data;
<a name="l04485"></a>04485 
<a name="l04486"></a>04486     <span class="keywordflow">if</span> (!wpmode || !(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>)) {
<a name="l04487"></a>04487        <span class="keywordflow">if</span> (!(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>)) {
<a name="l04488"></a>04488             <span class="keywordflow">if</span> (data-&gt;heat &amp;&amp; data-&gt;armob-&gt;pose &amp;&amp; <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(data-&gt;armob-&gt;pose, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>))
<a name="l04489"></a>04489                 segments = bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>;
<a name="l04490"></a>04490             <span class="keywordflow">else</span>
<a name="l04491"></a>04491                 segments = 1;
<a name="l04492"></a>04492 
<a name="l04493"></a>04493             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!wpmode || ((arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>) &amp;&amp; (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)))
<a name="l04494"></a>04494                 <span class="keywordflow">if</span> (!(defgroup = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>)))
<a name="l04495"></a>04495                     defgroup = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#af563a0e7930017802f6403c33de6a5f6">ED_vgroup_add_name</a>(ob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l04496"></a>04496             
<a name="l04497"></a>04497             <span class="keywordflow">if</span> (data-&gt;list != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04498"></a>04498                 hgroup = (<a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> ***) &amp;data-&gt;list;
<a name="l04499"></a>04499                 
<a name="l04500"></a>04500                 for (a=0; a&lt;segments; a++) {
<a name="l04501"></a>04501                     **hgroup = defgroup;
<a name="l04502"></a>04502                     ++*hgroup;
<a name="l04503"></a>04503                 }
<a name="l04504"></a>04504             }
<a name="l04505"></a>04505             <span class="keywordflow">return</span> segments;
<a name="l04506"></a>04506         }
<a name="l04507"></a>04507     }
<a name="l04508"></a>04508     <span class="keywordflow">return</span> 0;
<a name="l04509"></a>04509 }
<a name="l04510"></a>04510 
<a name="l04511"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9f36845257564da8f68da31b1251a6ba">04511</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a9f36845257564da8f68da31b1251a6ba">add_vgroups__mapFunc</a>(<span class="keywordtype">void</span> *userData, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3],
<a name="l04512"></a>04512                                  <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(no_f[3]), <span class="keyword">const</span> <span class="keywordtype">short</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(no_s[3]))
<a name="l04513"></a>04513 {
<a name="l04514"></a>04514     <span class="comment">/* DerivedMesh mapFunc for getting final coords in weight paint mode */</span>
<a name="l04515"></a>04515 
<a name="l04516"></a>04516     float (*verts)[3] = userData;
<a name="l04517"></a>04517     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(verts[index], co);
<a name="l04518"></a>04518 }
<a name="l04519"></a>04519 
<a name="l04520"></a><a class="code" href="../../de/dbc/editarmature_8c.html#af65a50fe397fe6d9b92f4e1b64c239e5">04520</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#af65a50fe397fe6d9b92f4e1b64c239e5">envelope_bone_weighting</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, <span class="keywordtype">float</span> (*verts)[3], <span class="keywordtype">int</span> numbones, <a class="code" href="../../de/de0/structBone.html">Bone</a> **bonelist, <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> **dgrouplist, <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> **dgroupflip, <span class="keywordtype">float</span> (*root)[3], <span class="keywordtype">float</span> (*tip)[3], <span class="keywordtype">int</span> *selected, <span class="keywordtype">float</span> scale)
<a name="l04521"></a>04521 {
<a name="l04522"></a>04522     <span class="comment">/* Create vertex group weights from envelopes */</span>
<a name="l04523"></a>04523 
<a name="l04524"></a>04524     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l04525"></a>04525     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dgroup;
<a name="l04526"></a>04526     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>;
<a name="l04527"></a>04527     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, iflip, j;
<a name="l04528"></a>04528 
<a name="l04529"></a>04529     <span class="comment">/* for each vertex in the mesh */</span>
<a name="l04530"></a>04530     <span class="keywordflow">for</span> (i=0; i &lt; mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; i++) {
<a name="l04531"></a>04531         iflip = (dgroupflip)? <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(ob, i): 0;
<a name="l04532"></a>04532         
<a name="l04533"></a>04533         <span class="comment">/* for each skinnable bone */</span>
<a name="l04534"></a>04534         <span class="keywordflow">for</span> (j=0; j &lt; numbones; ++j) {
<a name="l04535"></a>04535             <span class="keywordflow">if</span> (!selected[j])
<a name="l04536"></a>04536                 <span class="keywordflow">continue</span>;
<a name="l04537"></a>04537             
<a name="l04538"></a>04538             bone = bonelist[j];
<a name="l04539"></a>04539             dgroup = dgrouplist[j];
<a name="l04540"></a>04540             
<a name="l04541"></a>04541             <span class="comment">/* store the distance-factor from the vertex to the bone */</span>
<a name="l04542"></a>04542             distance = <a class="code" href="../../da/d17/BKE__armature_8h.html#a4047ce9de4bf6ef8d4afe6ae35e8940c">distfactor_to_bone</a> (verts[i], root[j], tip[j],
<a name="l04543"></a>04543                 bone-&gt;<a class="code" href="../../de/de0/structBone.html#aa3a081bf3e8f40876c53868e52174190">rad_head</a> * scale, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac603bd97e3cb0f73ec55cc73ee8ac1d0">rad_tail</a> * scale, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae41dbb73ded85fe0699b8c7283998ea9">dist</a> * scale);
<a name="l04544"></a>04544             
<a name="l04545"></a>04545             <span class="comment">/* add the vert to the deform group if weight!=0.0 */</span>
<a name="l04546"></a>04546             <span class="keywordflow">if</span> (distance != 0.0f)
<a name="l04547"></a>04547                 <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a> (ob, dgroup, i, distance, <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a5728db514cd0fa3c032a5df057111454">WEIGHT_REPLACE</a>);
<a name="l04548"></a>04548             <span class="keywordflow">else</span>
<a name="l04549"></a>04549                 <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a> (ob, dgroup, i);
<a name="l04550"></a>04550             
<a name="l04551"></a>04551             <span class="comment">/* do same for mirror */</span>
<a name="l04552"></a>04552             <span class="keywordflow">if</span> (dgroupflip &amp;&amp; dgroupflip[j] &amp;&amp; iflip &gt;= 0) {
<a name="l04553"></a>04553                 <span class="keywordflow">if</span> (distance != 0.0f)
<a name="l04554"></a>04554                     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a> (ob, dgroupflip[j], iflip, distance,
<a name="l04555"></a>04555                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a5728db514cd0fa3c032a5df057111454">WEIGHT_REPLACE</a>);
<a name="l04556"></a>04556                 <span class="keywordflow">else</span>
<a name="l04557"></a>04557                     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a> (ob, dgroupflip[j], iflip);
<a name="l04558"></a>04558             }
<a name="l04559"></a>04559         }
<a name="l04560"></a>04560     }
<a name="l04561"></a>04561 }
<a name="l04562"></a>04562 
<a name="l04563"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a6975e55ee47a8a88f09d64e9382573c5">04563</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a6975e55ee47a8a88f09d64e9382573c5">add_verts_to_dgroups</a>(<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *par, <span class="keywordtype">int</span> heat, <span class="keywordtype">int</span> mirror)
<a name="l04564"></a>04564 {
<a name="l04565"></a>04565     <span class="comment">/* This functions implements the automatic computation of vertex group</span>
<a name="l04566"></a>04566 <span class="comment">     * weights, either through envelopes or using a heat equilibrium.</span>
<a name="l04567"></a>04567 <span class="comment">     *</span>
<a name="l04568"></a>04568 <span class="comment">     * This function can be called both when parenting a mesh to an armature,</span>
<a name="l04569"></a>04569 <span class="comment">     * or in weightpaint + posemode. In the latter case selection is taken</span>
<a name="l04570"></a>04570 <span class="comment">     * into account and vertex weights can be mirrored.</span>
<a name="l04571"></a>04571 <span class="comment">     *</span>
<a name="l04572"></a>04572 <span class="comment">     * The mesh vertex positions used are either the final deformed coords</span>
<a name="l04573"></a>04573 <span class="comment">     * from the derivedmesh in weightpaint mode, the final subsurf coords</span>
<a name="l04574"></a>04574 <span class="comment">     * when parenting, or simply the original mesh coords.</span>
<a name="l04575"></a>04575 <span class="comment">     */</span>
<a name="l04576"></a>04576 
<a name="l04577"></a>04577     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= par-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04578"></a>04578     <a class="code" href="../../de/de0/structBone.html">Bone</a> **bonelist, *bone;
<a name="l04579"></a>04579     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> **dgrouplist, **dgroupflip;
<a name="l04580"></a>04580     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dgroup;
<a name="l04581"></a>04581     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l04582"></a>04582     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh;
<a name="l04583"></a>04583     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *bbone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04584"></a>04584     float (*root)[3], (*tip)[3], (*verts)[3];
<a name="l04585"></a>04585     <span class="keywordtype">int</span> *selected;
<a name="l04586"></a>04586     <span class="keywordtype">int</span> numbones, vertsfilled = 0, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, segments = 0;
<a name="l04587"></a>04587     <span class="keywordtype">int</span> wpmode = (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>);
<a name="l04588"></a>04588     <span class="keyword">struct </span>{ <a class="code" href="../../de/de7/structObject.html">Object</a> *armob; <span class="keywordtype">void</span> *list; <span class="keywordtype">int</span> heat; } looper_data;
<a name="l04589"></a>04589 
<a name="l04590"></a>04590     looper_data.armob = par;
<a name="l04591"></a>04591     looper_data.heat= heat;
<a name="l04592"></a>04592     looper_data.list= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04593"></a>04593 
<a name="l04594"></a>04594     <span class="comment">/* count the number of skinnable bones */</span>
<a name="l04595"></a>04595     numbones = <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;looper_data, <a class="code" href="../../de/dbc/editarmature_8c.html#af2416d16573f485d64ef60c67def5724">bone_skinnable_cb</a>);
<a name="l04596"></a>04596     
<a name="l04597"></a>04597     <span class="keywordflow">if</span> (numbones == 0)
<a name="l04598"></a>04598         <span class="keywordflow">return</span>;
<a name="l04599"></a>04599     
<a name="l04600"></a>04600     <span class="comment">/* create an array of pointer to bones that are skinnable</span>
<a name="l04601"></a>04601 <span class="comment">     * and fill it with all of the skinnable bones */</span>
<a name="l04602"></a>04602     bonelist = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<a class="code" href="../../de/de0/structBone.html">Bone</a> *), <span class="stringliteral">&quot;bonelist&quot;</span>);
<a name="l04603"></a>04603     looper_data.list= bonelist;
<a name="l04604"></a>04604     <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;looper_data, <a class="code" href="../../de/dbc/editarmature_8c.html#af2416d16573f485d64ef60c67def5724">bone_skinnable_cb</a>);
<a name="l04605"></a>04605 
<a name="l04606"></a>04606     <span class="comment">/* create an array of pointers to the deform groups that</span>
<a name="l04607"></a>04607 <span class="comment">     * coorespond to the skinnable bones (creating them</span>
<a name="l04608"></a>04608 <span class="comment">     * as necessary. */</span>
<a name="l04609"></a>04609     dgrouplist = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *), <span class="stringliteral">&quot;dgrouplist&quot;</span>);
<a name="l04610"></a>04610     dgroupflip = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *), <span class="stringliteral">&quot;dgroupflip&quot;</span>);
<a name="l04611"></a>04611 
<a name="l04612"></a>04612     looper_data.list= dgrouplist;
<a name="l04613"></a>04613     <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;looper_data, <a class="code" href="../../de/dbc/editarmature_8c.html#a75f324e6acd59ac8144efb0a78bbc63c">dgroup_skinnable_cb</a>);
<a name="l04614"></a>04614 
<a name="l04615"></a>04615     <span class="comment">/* create an array of root and tip positions transformed into</span>
<a name="l04616"></a>04616 <span class="comment">     * global coords */</span>
<a name="l04617"></a>04617     root = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3, <span class="stringliteral">&quot;root&quot;</span>);
<a name="l04618"></a>04618     tip = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3, <span class="stringliteral">&quot;tip&quot;</span>);
<a name="l04619"></a>04619     selected = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(numbones*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;selected&quot;</span>);
<a name="l04620"></a>04620 
<a name="l04621"></a>04621     <span class="keywordflow">for</span> (j=0; j &lt; numbones; ++j) {
<a name="l04622"></a>04622         bone = bonelist[j];
<a name="l04623"></a>04623         dgroup = dgrouplist[j];
<a name="l04624"></a>04624         
<a name="l04625"></a>04625         <span class="comment">/* handle bbone */</span>
<a name="l04626"></a>04626         <span class="keywordflow">if</span> (heat) {
<a name="l04627"></a>04627             <span class="keywordflow">if</span> (segments == 0) {
<a name="l04628"></a>04628                 segments = 1;
<a name="l04629"></a>04629                 bbone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04630"></a>04630                 
<a name="l04631"></a>04631                 <span class="keywordflow">if</span> ((par-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) &amp;&amp; (pchan=<a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(par-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>))) {
<a name="l04632"></a>04632                     <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1) {
<a name="l04633"></a>04633                         segments = bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>;
<a name="l04634"></a>04634                         bbone = <a class="code" href="../../da/d17/BKE__armature_8h.html#aff2236f3e8532360b1b7b72f5336ef53">b_bone_spline_setup</a>(pchan, 1);
<a name="l04635"></a>04635                     }
<a name="l04636"></a>04636                 }
<a name="l04637"></a>04637             }
<a name="l04638"></a>04638             
<a name="l04639"></a>04639             segments--;
<a name="l04640"></a>04640         }
<a name="l04641"></a>04641         
<a name="l04642"></a>04642         <span class="comment">/* compute root and tip */</span>
<a name="l04643"></a>04643         <span class="keywordflow">if</span> (bbone) {
<a name="l04644"></a>04644             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(root[j], bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, bbone[segments].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>[3]);
<a name="l04645"></a>04645             <span class="keywordflow">if</span> ((segments+1) &lt; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>) {
<a name="l04646"></a>04646                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(tip[j], bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, bbone[segments+1].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>[3]);
<a name="l04647"></a>04647             }
<a name="l04648"></a>04648             <span class="keywordflow">else</span> {
<a name="l04649"></a>04649                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tip[j], bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l04650"></a>04650             }
<a name="l04651"></a>04651         }
<a name="l04652"></a>04652         <span class="keywordflow">else</span> {
<a name="l04653"></a>04653             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(root[j], bone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>);
<a name="l04654"></a>04654             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tip[j], bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l04655"></a>04655         }
<a name="l04656"></a>04656         
<a name="l04657"></a>04657         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(par-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, root[j]);
<a name="l04658"></a>04658         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(par-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, tip[j]);
<a name="l04659"></a>04659         
<a name="l04660"></a>04660         <span class="comment">/* set selected */</span>
<a name="l04661"></a>04661         <span class="keywordflow">if</span> (wpmode) {
<a name="l04662"></a>04662             <span class="keywordflow">if</span> ((arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>) &amp;&amp; (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>))
<a name="l04663"></a>04663                 selected[j] = 1;
<a name="l04664"></a>04664         }
<a name="l04665"></a>04665         <span class="keywordflow">else</span>
<a name="l04666"></a>04666             selected[j] = 1;
<a name="l04667"></a>04667         
<a name="l04668"></a>04668         <span class="comment">/* find flipped group */</span>
<a name="l04669"></a>04669         <span class="keywordflow">if</span> (dgroup &amp;&amp; mirror) {
<a name="l04670"></a>04670             <span class="keywordtype">char</span> name[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l04671"></a>04671 
<a name="l04672"></a>04672             <span class="comment">// 0 = don&#39;t strip off number extensions</span>
<a name="l04673"></a>04673             <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a13c8067511267c6d95644db2450a367a">flip_side_name</a>(name, dgroup-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04674"></a>04674             dgroupflip[j] = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob, name);
<a name="l04675"></a>04675         }
<a name="l04676"></a>04676     }
<a name="l04677"></a>04677 
<a name="l04678"></a>04678     <span class="comment">/* create verts */</span>
<a name="l04679"></a>04679     mesh = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04680"></a>04680     verts = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>*<span class="keyword">sizeof</span>(*verts), <span class="stringliteral">&quot;closestboneverts&quot;</span>);
<a name="l04681"></a>04681 
<a name="l04682"></a>04682     <span class="keywordflow">if</span> (wpmode) {
<a name="l04683"></a>04683         <span class="comment">/* if in weight paint mode, use final verts from derivedmesh */</span>
<a name="l04684"></a>04684         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l04685"></a>04685         
<a name="l04686"></a>04686         <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a14c8a2dc23a8af0e7aaf2190f7cf0202">foreachMappedVert</a>) {
<a name="l04687"></a>04687             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a14c8a2dc23a8af0e7aaf2190f7cf0202">foreachMappedVert</a>(dm, <a class="code" href="../../de/dbc/editarmature_8c.html#a9f36845257564da8f68da31b1251a6ba">add_vgroups__mapFunc</a>, (<span class="keywordtype">void</span>*)verts);
<a name="l04688"></a>04688             vertsfilled = 1;
<a name="l04689"></a>04689         }
<a name="l04690"></a>04690         
<a name="l04691"></a>04691         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l04692"></a>04692     }
<a name="l04693"></a>04693     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1eb467ffa009a46723f1bf21be5fd730">eModifierType_Subsurf</a>)) {
<a name="l04694"></a>04694         <span class="comment">/* is subsurf on? Lets use the verts on the limit surface then.</span>
<a name="l04695"></a>04695 <span class="comment">         * = same amount of vertices as mesh, but vertices  moved to the</span>
<a name="l04696"></a>04696 <span class="comment">         * subsurfed position, like for &#39;optimal&#39;. */</span>
<a name="l04697"></a>04697         <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#ab7d59663e1a03a75d7a41f0a3f19bed7">subsurf_calculate_limit_positions</a>(mesh, verts);
<a name="l04698"></a>04698         vertsfilled = 1;
<a name="l04699"></a>04699     }
<a name="l04700"></a>04700 
<a name="l04701"></a>04701     <span class="comment">/* transform verts to global space */</span>
<a name="l04702"></a>04702     <span class="keywordflow">for</span> (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l04703"></a>04703         <span class="keywordflow">if</span> (!vertsfilled)
<a name="l04704"></a>04704             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(verts[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>], mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l04705"></a>04705         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, verts[i]);
<a name="l04706"></a>04706     }
<a name="l04707"></a>04707 
<a name="l04708"></a>04708     <span class="comment">/* compute the weights based on gathered vertices and bones */</span>
<a name="l04709"></a>04709     <span class="keywordflow">if</span> (heat) {
<a name="l04710"></a>04710         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04711"></a>04711         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#adcb1d4df2f116a2b0b11fc4bba730fe6">heat_bone_weighting</a>(ob, mesh, verts, numbones, dgrouplist, dgroupflip,
<a name="l04712"></a>04712             root, tip, selected, &amp;error);
<a name="l04713"></a>04713         
<a name="l04714"></a>04714         <span class="keywordflow">if</span> (error) {
<a name="l04715"></a>04715             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, error);
<a name="l04716"></a>04716         }
<a name="l04717"></a>04717     }
<a name="l04718"></a>04718     <span class="keywordflow">else</span> {
<a name="l04719"></a>04719         <a class="code" href="../../de/dbc/editarmature_8c.html#af65a50fe397fe6d9b92f4e1b64c239e5">envelope_bone_weighting</a>(ob, mesh, verts, numbones, bonelist, dgrouplist,
<a name="l04720"></a>04720             dgroupflip, root, tip, selected, <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a1e63f7e6f978bfb2570cb43d25829c09">mat4_to_scale</a>(par-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>));
<a name="l04721"></a>04721     }
<a name="l04722"></a>04722 
<a name="l04723"></a>04723     <span class="comment">/* only generated in some cases but can call anyway */</span>
<a name="l04724"></a>04724     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;e&#39;</span>);
<a name="l04725"></a>04725 
<a name="l04726"></a>04726     <span class="comment">/* free the memory allocated */</span>
<a name="l04727"></a>04727     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bonelist);
<a name="l04728"></a>04728     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dgrouplist);
<a name="l04729"></a>04729     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dgroupflip);
<a name="l04730"></a>04730     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(root);
<a name="l04731"></a>04731     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tip);
<a name="l04732"></a>04732     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(selected);
<a name="l04733"></a>04733     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(verts);
<a name="l04734"></a>04734 }
<a name="l04735"></a>04735 
<a name="l04736"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#ac13e389473235421ea7b6c985d618b0c">04736</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5b4d844c910c018e82212d0496e5a925">create_vgroups_from_armature</a>(<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *par, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> mirror)
<a name="l04737"></a>04737 {
<a name="l04738"></a>04738     <span class="comment">/* Lets try to create some vertex groups </span>
<a name="l04739"></a>04739 <span class="comment">     * based on the bones of the parent armature.</span>
<a name="l04740"></a>04740 <span class="comment">     */</span>
<a name="l04741"></a>04741     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= par-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l04742"></a>04742 
<a name="l04743"></a>04743     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d1/d98/ED__armature_8h.html#ab3c01a119de501d95b4c4c62d0595334">ARM_GROUPS_NAME</a>) {
<a name="l04744"></a>04744         <span class="comment">/* Traverse the bone list, trying to create empty vertex </span>
<a name="l04745"></a>04745 <span class="comment">         * groups corresponding to the bone.</span>
<a name="l04746"></a>04746 <span class="comment">         */</span>
<a name="l04747"></a>04747         <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#ada5ec87422f762b0b8d44b2b9560f852">vgroup_add_unique_bone_cb</a>);
<a name="l04748"></a>04748 
<a name="l04749"></a>04749         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>)
<a name="l04750"></a>04750             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a4338d4c52b452b1ca2fd8868f94e6b26">ED_vgroup_data_create</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>);
<a name="l04751"></a>04751     }
<a name="l04752"></a>04752     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../d1/d98/ED__armature_8h.html#aa8288c163d5238171f2f390a42531796">ARM_GROUPS_ENVELOPE</a> || mode == <a class="code" href="../../d1/d98/ED__armature_8h.html#aee05c190ea005c6c7fb413a09b9c1afb">ARM_GROUPS_AUTO</a>) {
<a name="l04753"></a>04753         <span class="comment">/* Traverse the bone list, trying to create vertex groups </span>
<a name="l04754"></a>04754 <span class="comment">         * that are populated with the vertices for which the</span>
<a name="l04755"></a>04755 <span class="comment">         * bone is closest.</span>
<a name="l04756"></a>04756 <span class="comment">         */</span>
<a name="l04757"></a>04757         <a class="code" href="../../de/dbc/editarmature_8c.html#a6975e55ee47a8a88f09d64e9382573c5">add_verts_to_dgroups</a>(reports, scene, ob, par, (mode == <a class="code" href="../../d1/d98/ED__armature_8h.html#aee05c190ea005c6c7fb413a09b9c1afb">ARM_GROUPS_AUTO</a>), mirror);
<a name="l04758"></a>04758     }
<a name="l04759"></a>04759 } 
<a name="l04760"></a>04760 <span class="comment">/* ************* Clear Pose *****************************/</span>
<a name="l04761"></a>04761 
<a name="l04762"></a>04762 <span class="comment">/* clear scale of pose-channel */</span>
<a name="l04763"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a60a646e9b5c282ad8e0bcc0124062d1d">04763</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a60a646e9b5c282ad8e0bcc0124062d1d">pchan_clear_scale</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l04764"></a>04764 {
<a name="l04765"></a>04765     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#adeeb69ce54fa6721347d823226c9041e">OB_LOCK_SCALEX</a>)==0)
<a name="l04766"></a>04766         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[0]= 1.0f;
<a name="l04767"></a>04767     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#adb3decebd5d9a0ed8d70b6fe30b07ae9">OB_LOCK_SCALEY</a>)==0)
<a name="l04768"></a>04768         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[1]= 1.0f;
<a name="l04769"></a>04769     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ac98049e7ab4c0fc185141c18b36bc85e">OB_LOCK_SCALEZ</a>)==0)
<a name="l04770"></a>04770         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>[2]= 1.0f;
<a name="l04771"></a>04771 }
<a name="l04772"></a>04772 
<a name="l04773"></a>04773 <span class="comment">/* clear location of pose-channel */</span>
<a name="l04774"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ae02691fe9657683a9177cf5c7fdaaa3f">04774</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ae02691fe9657683a9177cf5c7fdaaa3f">pchan_clear_loc</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l04775"></a>04775 {
<a name="l04776"></a>04776     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a7bd0615d3d1b4abbf6bdd1a384444ce3">OB_LOCK_LOCX</a>)==0)
<a name="l04777"></a>04777         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>[0]= 0.0f;
<a name="l04778"></a>04778     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8f462951f76927f5fe4579691b011919">OB_LOCK_LOCY</a>)==0)
<a name="l04779"></a>04779         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>[1]= 0.0f;
<a name="l04780"></a>04780     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a00a97ff22933307b29929585715e9e78">OB_LOCK_LOCZ</a>)==0)
<a name="l04781"></a>04781         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>[2]= 0.0f;
<a name="l04782"></a>04782 }
<a name="l04783"></a>04783 
<a name="l04784"></a>04784 <span class="comment">/* clear rotation of pose-channel */</span>
<a name="l04785"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab1b4213b12386e6e1c8581a4eec5a1b4">04785</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ab1b4213b12386e6e1c8581a4eec5a1b4">pchan_clear_rot</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l04786"></a>04786 {
<a name="l04787"></a>04787     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; (<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c5f8cb59dda9f6e6f825189ecaec592">OB_LOCK_ROTX</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ace10ab1587f74395e9ad3cdd707b5fc6">OB_LOCK_ROTY</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae914b3064cb1efb7cb6392287cc1d3de">OB_LOCK_ROTZ</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa54bdcc6d4b9be00a167a4d49264b1f1">OB_LOCK_ROTW</a>)) {
<a name="l04788"></a>04788         <span class="comment">/* check if convert to eulers for locking... */</span>
<a name="l04789"></a>04789         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a7479805656af00b23511bc1dbac25a76">OB_LOCK_ROT4D</a>) {
<a name="l04790"></a>04790             <span class="comment">/* perform clamping on a component by component basis */</span>
<a name="l04791"></a>04791             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l04792"></a>04792                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa54bdcc6d4b9be00a167a4d49264b1f1">OB_LOCK_ROTW</a>) == 0)
<a name="l04793"></a>04793                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>= 0.0f;
<a name="l04794"></a>04794                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c5f8cb59dda9f6e6f825189ecaec592">OB_LOCK_ROTX</a>) == 0)
<a name="l04795"></a>04795                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[0]= 0.0f;
<a name="l04796"></a>04796                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ace10ab1587f74395e9ad3cdd707b5fc6">OB_LOCK_ROTY</a>) == 0)
<a name="l04797"></a>04797                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[1]= 0.0f;
<a name="l04798"></a>04798                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae914b3064cb1efb7cb6392287cc1d3de">OB_LOCK_ROTZ</a>) == 0)
<a name="l04799"></a>04799                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[2]= 0.0f;
<a name="l04800"></a>04800                     
<a name="l04801"></a>04801                 <span class="comment">/* check validity of axis - axis should never be 0,0,0 (if so, then we make it rotate about y) */</span>
<a name="l04802"></a>04802                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[0], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[1]) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[1], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[2]))
<a name="l04803"></a>04803                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>[1] = 1.0f;
<a name="l04804"></a>04804             }
<a name="l04805"></a>04805             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l04806"></a>04806                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa54bdcc6d4b9be00a167a4d49264b1f1">OB_LOCK_ROTW</a>) == 0)
<a name="l04807"></a>04807                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[0]= 1.0f;
<a name="l04808"></a>04808                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c5f8cb59dda9f6e6f825189ecaec592">OB_LOCK_ROTX</a>) == 0)
<a name="l04809"></a>04809                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[1]= 0.0f;
<a name="l04810"></a>04810                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ace10ab1587f74395e9ad3cdd707b5fc6">OB_LOCK_ROTY</a>) == 0)
<a name="l04811"></a>04811                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[2]= 0.0f;
<a name="l04812"></a>04812                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae914b3064cb1efb7cb6392287cc1d3de">OB_LOCK_ROTZ</a>) == 0)
<a name="l04813"></a>04813                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[3]= 0.0f;
<a name="l04814"></a>04814             }
<a name="l04815"></a>04815             <span class="keywordflow">else</span> {
<a name="l04816"></a>04816                 <span class="comment">/* the flag may have been set for the other modes, so just ignore the extra flag... */</span>
<a name="l04817"></a>04817                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c5f8cb59dda9f6e6f825189ecaec592">OB_LOCK_ROTX</a>) == 0)
<a name="l04818"></a>04818                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>[0]= 0.0f;
<a name="l04819"></a>04819                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ace10ab1587f74395e9ad3cdd707b5fc6">OB_LOCK_ROTY</a>) == 0)
<a name="l04820"></a>04820                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>[1]= 0.0f;
<a name="l04821"></a>04821                 <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae914b3064cb1efb7cb6392287cc1d3de">OB_LOCK_ROTZ</a>) == 0)
<a name="l04822"></a>04822                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>[2]= 0.0f;
<a name="l04823"></a>04823             }
<a name="l04824"></a>04824         }
<a name="l04825"></a>04825         <span class="keywordflow">else</span> {
<a name="l04826"></a>04826             <span class="comment">/* perform clamping using euler form (3-components) */</span>
<a name="l04827"></a>04827             <span class="keywordtype">float</span> eul[3], oldeul[3], quat1[4] = {0};
<a name="l04828"></a>04828             <span class="keywordtype">float</span> qlen = 0.0f;
<a name="l04829"></a>04829             
<a name="l04830"></a>04830             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l04831"></a>04831                 qlen= <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ac6d9c2d913e7b6f0686db690ba55bc3e">normalize_qt_qt</a>(quat1, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>);
<a name="l04832"></a>04832                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a838c7ee5a2545c145c04787921175aad">quat_to_eul</a>(oldeul, quat1);
<a name="l04833"></a>04833             }
<a name="l04834"></a>04834             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l04835"></a>04835                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa12d17f2566056509d7d2eeb880496d9">axis_angle_to_eulO</a>( oldeul, <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4aa95d9f8c95e703a90ba8afe1a3c4bda7c3f7a4cf435a4a3bba131a862e322fa">EULER_ORDER_DEFAULT</a>,pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>);
<a name="l04836"></a>04836             }
<a name="l04837"></a>04837             <span class="keywordflow">else</span> {
<a name="l04838"></a>04838                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(oldeul, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>);
<a name="l04839"></a>04839             }
<a name="l04840"></a>04840             
<a name="l04841"></a>04841             eul[0]= eul[1]= eul[2]= 0.0f;
<a name="l04842"></a>04842             
<a name="l04843"></a>04843             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c5f8cb59dda9f6e6f825189ecaec592">OB_LOCK_ROTX</a>)
<a name="l04844"></a>04844                 eul[0]= oldeul[0];
<a name="l04845"></a>04845             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ace10ab1587f74395e9ad3cdd707b5fc6">OB_LOCK_ROTY</a>)
<a name="l04846"></a>04846                 eul[1]= oldeul[1];
<a name="l04847"></a>04847             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a58c1251ffe8611d8899219e1c0dda3e7">protectflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae914b3064cb1efb7cb6392287cc1d3de">OB_LOCK_ROTZ</a>)
<a name="l04848"></a>04848                 eul[2]= oldeul[2];
<a name="l04849"></a>04849             
<a name="l04850"></a>04850             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l04851"></a>04851                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a731eaf3dcfda22e037709a61a0377dff">eul_to_quat</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>, eul);
<a name="l04852"></a>04852                 
<a name="l04853"></a>04853                 <span class="comment">/* restore original quat size */</span>
<a name="l04854"></a>04854                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3ed59d039b7a6d8110efe9d4e83a84ef">mul_qt_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>, qlen);
<a name="l04855"></a>04855                 
<a name="l04856"></a>04856                 <span class="comment">/* quaternions flip w sign to accumulate rotations correctly */</span>
<a name="l04857"></a>04857                 <span class="keywordflow">if</span> ((quat1[0]&lt;0.0f &amp;&amp; pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[0]&gt;0.0f) || (quat1[0]&gt;0.0f &amp;&amp; pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>[0]&lt;0.0f)) {
<a name="l04858"></a>04858                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3ed59d039b7a6d8110efe9d4e83a84ef">mul_qt_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>, -1.0f);
<a name="l04859"></a>04859                 }
<a name="l04860"></a>04860             }
<a name="l04861"></a>04861             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l04862"></a>04862                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3b7c5f2e7add29b1531d78cab51baefd">eulO_to_axis_angle</a>( pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>,eul, <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4aa95d9f8c95e703a90ba8afe1a3c4bda7c3f7a4cf435a4a3bba131a862e322fa">EULER_ORDER_DEFAULT</a>);
<a name="l04863"></a>04863             }
<a name="l04864"></a>04864             <span class="keywordflow">else</span> {
<a name="l04865"></a>04865                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>, eul);
<a name="l04866"></a>04866             }
<a name="l04867"></a>04867         }
<a name="l04868"></a>04868     }                       <span class="comment">// Duplicated in source/blender/editors/object/object_transform.c</span>
<a name="l04869"></a>04869     <span class="keywordflow">else</span> { 
<a name="l04870"></a>04870         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l04871"></a>04871             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a66672ccf9e1308f3ba8c6b6f55fd2a8c">unit_qt</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>);
<a name="l04872"></a>04872         }
<a name="l04873"></a>04873         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l04874"></a>04874             <span class="comment">/* by default, make rotation of 0 radians around y-axis (roll) */</span>
<a name="l04875"></a>04875             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#acceefe4ea6d15958a0e4e059c114b00e">unit_axis_angle</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>);
<a name="l04876"></a>04876         }
<a name="l04877"></a>04877         <span class="keywordflow">else</span> {
<a name="l04878"></a>04878             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>);
<a name="l04879"></a>04879         }
<a name="l04880"></a>04880     }
<a name="l04881"></a>04881 }
<a name="l04882"></a>04882 
<a name="l04883"></a>04883 <span class="comment">/* clear loc/rot/scale of pose-channel */</span>
<a name="l04884"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a4f9b395a330f69c48c4a4720e7466f2c">04884</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a4f9b395a330f69c48c4a4720e7466f2c">pchan_clear_transforms</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l04885"></a>04885 {
<a name="l04886"></a>04886     <a class="code" href="../../de/dbc/editarmature_8c.html#ae02691fe9657683a9177cf5c7fdaaa3f">pchan_clear_loc</a>(pchan);
<a name="l04887"></a>04887     <a class="code" href="../../de/dbc/editarmature_8c.html#ab1b4213b12386e6e1c8581a4eec5a1b4">pchan_clear_rot</a>(pchan);
<a name="l04888"></a>04888     <a class="code" href="../../de/dbc/editarmature_8c.html#a60a646e9b5c282ad8e0bcc0124062d1d">pchan_clear_scale</a>(pchan);
<a name="l04889"></a>04889 }
<a name="l04890"></a>04890 
<a name="l04891"></a>04891 <span class="comment">/* --------------- */</span>
<a name="l04892"></a>04892 
<a name="l04893"></a>04893 <span class="comment">/* generic exec for clear-pose operators */</span>
<a name="l04894"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">04894</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">pose_clear_transform_generic_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, 
<a name="l04895"></a>04895         <span class="keywordtype">void</span> (*clear_func)(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*), <span class="keyword">const</span> <span class="keywordtype">char</span> default_ksName[])
<a name="l04896"></a>04896 {
<a name="l04897"></a>04897     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04898"></a>04898     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l04899"></a>04899     <span class="keywordtype">short</span> autokey = 0;
<a name="l04900"></a>04900     
<a name="l04901"></a>04901     <span class="comment">/* sanity checks */</span>
<a name="l04902"></a>04902     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, clear_func, default_ksName)) {
<a name="l04903"></a>04903         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Programming error: missing clear transform func or Keying Set Name&quot;</span>);
<a name="l04904"></a>04904         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l04905"></a>04905     }
<a name="l04906"></a>04906     
<a name="l04907"></a>04907     <span class="comment">/* only clear relevant transforms for selected bones */</span>
<a name="l04908"></a>04908     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*, pchan, selected_pose_bones) 
<a name="l04909"></a>04909     {
<a name="l04910"></a>04910         <span class="comment">/* run provided clearing function */</span>
<a name="l04911"></a>04911         clear_func(pchan);
<a name="l04912"></a>04912         
<a name="l04913"></a>04913         <span class="comment">/* do auto-keyframing as appropriate */</span>
<a name="l04914"></a>04914         <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#abae70599a7160c3c78c4e3347f5e0823">autokeyframe_cfra_can_key</a>(scene, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>)) {
<a name="l04915"></a>04915             <span class="comment">/* clear any unkeyed tags */</span>
<a name="l04916"></a>04916             <span class="keywordflow">if</span> (pchan-&gt;bone)
<a name="l04917"></a>04917                 pchan-&gt;bone-&gt;flag &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1cffb8d9b288e7798d0c533ba94a695">BONE_UNKEYED</a>;
<a name="l04918"></a>04918                 
<a name="l04919"></a>04919             <span class="comment">/* tag for autokeying later */</span>
<a name="l04920"></a>04920             autokey = 1;
<a name="l04921"></a>04921         }
<a name="l04922"></a>04922         <span class="keywordflow">else</span> {
<a name="l04923"></a>04923             <span class="comment">/* add unkeyed tags */</span>
<a name="l04924"></a>04924             <span class="keywordflow">if</span> (pchan-&gt;bone)
<a name="l04925"></a>04925                 pchan-&gt;bone-&gt;flag |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1cffb8d9b288e7798d0c533ba94a695">BONE_UNKEYED</a>;
<a name="l04926"></a>04926         }
<a name="l04927"></a>04927     }
<a name="l04928"></a>04928     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l04929"></a>04929     
<a name="l04930"></a>04930     <span class="comment">/* perform autokeying on the bones if needed */</span>
<a name="l04931"></a>04931     <span class="keywordflow">if</span> (autokey) {
<a name="l04932"></a>04932         <span class="comment">/* get KeyingSet to use */</span>
<a name="l04933"></a>04933         <a class="code" href="../../d4/d2c/structKeyingSet.html">KeyingSet</a> *ks = <a class="code" href="../../de/d5c/keyingsets_8c.html#a86660bfb5e6411a4bf913c4085129c8e">ANIM_get_keyingset_for_autokeying</a>(scene, default_ksName);
<a name="l04934"></a>04934         
<a name="l04935"></a>04935         <span class="comment">/* insert keyframes */</span>
<a name="l04936"></a>04936         <a class="code" href="../../de/d5c/keyingsets_8c.html#a01044547bfbc00a3377c900078313f51">ANIM_apply_keyingset</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ks, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a48e4988c2b608cebe42af2941d5e7d00abaf099b6ce7f582ab7790271f99a2614">MODIFYKEY_MODE_INSERT</a>, (<span class="keywordtype">float</span>)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l04937"></a>04937         
<a name="l04938"></a>04938         <span class="comment">/* now recalculate paths */</span>
<a name="l04939"></a>04939         <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a66f05f761e3d89a2717137132fff43cc">avs</a>.<a class="code" href="../../db/de3/structbAnimVizSettings.html#a1811764f4a3741028ebe2bf5e43496de">path_bakeflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a10649c21734145b9ff1cd2248d610e7bad7695beea9b150e286d2e267cf757ccb">MOTIONPATH_BAKE_HAS_PATHS</a>))
<a name="l04940"></a>04940             <a class="code" href="../../d1/d35/poseobject_8c.html#adb29f78af3745d28ef7c0f9199d25816">ED_pose_recalculate_paths</a>(scene, ob);
<a name="l04941"></a>04941     }
<a name="l04942"></a>04942     
<a name="l04943"></a>04943     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l04944"></a>04944 
<a name="l04945"></a>04945     <span class="comment">/* note, notifier might evolve */</span>
<a name="l04946"></a>04946     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aad6e17340eb558c0caa7c874dc0812f3">ND_TRANSFORM</a>, ob);
<a name="l04947"></a>04947     
<a name="l04948"></a>04948     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l04949"></a>04949 }
<a name="l04950"></a>04950 
<a name="l04951"></a>04951 <span class="comment">/* --------------- */</span>
<a name="l04952"></a>04952 
<a name="l04953"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abb31fe37647cbe79f56705f91795d475">04953</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#abb31fe37647cbe79f56705f91795d475">pose_clear_scale_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l04954"></a>04954 {
<a name="l04955"></a>04955     <span class="keywordflow">return</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">pose_clear_transform_generic_exec</a>(C, op, <a class="code" href="../../de/dbc/editarmature_8c.html#a60a646e9b5c282ad8e0bcc0124062d1d">pchan_clear_scale</a>, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a982df472ae906575ca8ec32afe6fcd6f">ANIM_KS_SCALING_ID</a>);
<a name="l04956"></a>04956 }
<a name="l04957"></a>04957 
<a name="l04958"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aeb9c4446b74f4581161cf9edca91b228">04958</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a21fc96b0294d07f356227b488467ae27">POSE_OT_scale_clear</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l04959"></a>04959 {
<a name="l04960"></a>04960     <span class="comment">/* identifiers */</span>
<a name="l04961"></a>04961     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Clear Pose Scale&quot;</span>;
<a name="l04962"></a>04962     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_scale_clear&quot;</span>;
<a name="l04963"></a>04963     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Reset scaling of selected bones to their default values&quot;</span>;
<a name="l04964"></a>04964     
<a name="l04965"></a>04965     <span class="comment">/* api callbacks */</span>
<a name="l04966"></a>04966     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#abb31fe37647cbe79f56705f91795d475">pose_clear_scale_exec</a>;
<a name="l04967"></a>04967     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l04968"></a>04968     
<a name="l04969"></a>04969     <span class="comment">/* flags */</span>
<a name="l04970"></a>04970     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l04971"></a>04971 }
<a name="l04972"></a>04972 
<a name="l04973"></a>04973 
<a name="l04974"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a90ad74935da206727c9413bda4832fe5">04974</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a90ad74935da206727c9413bda4832fe5">pose_clear_rot_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l04975"></a>04975 {
<a name="l04976"></a>04976     <span class="keywordflow">return</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">pose_clear_transform_generic_exec</a>(C, op, <a class="code" href="../../de/dbc/editarmature_8c.html#ab1b4213b12386e6e1c8581a4eec5a1b4">pchan_clear_rot</a>, <a class="code" href="../../da/df9/ED__keyframing_8h.html#acd7b3c08ff02815ba63937e3393f2734">ANIM_KS_ROTATION_ID</a>);
<a name="l04977"></a>04977 }
<a name="l04978"></a>04978 
<a name="l04979"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab951ea27dab412d03706343c913b8ea5">04979</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a61283e748a27a13a521fe4d8df146b4a">POSE_OT_rot_clear</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l04980"></a>04980 {
<a name="l04981"></a>04981     <span class="comment">/* identifiers */</span>
<a name="l04982"></a>04982     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Clear Pose Rotation&quot;</span>;
<a name="l04983"></a>04983     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_rot_clear&quot;</span>;
<a name="l04984"></a>04984     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Reset rotations of selected bones to their default values&quot;</span>;
<a name="l04985"></a>04985     
<a name="l04986"></a>04986     <span class="comment">/* api callbacks */</span>
<a name="l04987"></a>04987     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a90ad74935da206727c9413bda4832fe5">pose_clear_rot_exec</a>;
<a name="l04988"></a>04988     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l04989"></a>04989     
<a name="l04990"></a>04990     <span class="comment">/* flags */</span>
<a name="l04991"></a>04991     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l04992"></a>04992 }
<a name="l04993"></a>04993 
<a name="l04994"></a>04994 
<a name="l04995"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa3ee5522953c49aa70f218dcd5af1091">04995</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#aa3ee5522953c49aa70f218dcd5af1091">pose_clear_loc_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l04996"></a>04996 {
<a name="l04997"></a>04997     <span class="keywordflow">return</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">pose_clear_transform_generic_exec</a>(C, op, <a class="code" href="../../de/dbc/editarmature_8c.html#ae02691fe9657683a9177cf5c7fdaaa3f">pchan_clear_loc</a>, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a5e587f08d662a3a0752fde4650d891e6">ANIM_KS_LOCATION_ID</a>);
<a name="l04998"></a>04998 }
<a name="l04999"></a>04999 
<a name="l05000"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ad9d6776a50a613e9580e73540a66acbd">05000</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#ae9e59b06b8c4094feccd5dfcd142877a">POSE_OT_loc_clear</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05001"></a>05001 {
<a name="l05002"></a>05002     <span class="comment">/* identifiers */</span>
<a name="l05003"></a>05003     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Clear Pose Location&quot;</span>;
<a name="l05004"></a>05004     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_loc_clear&quot;</span>;
<a name="l05005"></a>05005     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Reset locations of selected bones to their default values&quot;</span>;
<a name="l05006"></a>05006     
<a name="l05007"></a>05007     <span class="comment">/* api callbacks */</span>
<a name="l05008"></a>05008     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#aa3ee5522953c49aa70f218dcd5af1091">pose_clear_loc_exec</a>;
<a name="l05009"></a>05009     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05010"></a>05010     
<a name="l05011"></a>05011     <span class="comment">/* flags */</span>
<a name="l05012"></a>05012     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05013"></a>05013 }
<a name="l05014"></a>05014 
<a name="l05015"></a>05015 
<a name="l05016"></a><a class="code" href="../../de/dbc/editarmature_8c.html#afa26dd0a7c5643c1a1f16d6eecb67214">05016</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#afa26dd0a7c5643c1a1f16d6eecb67214">pose_clear_transforms_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l05017"></a>05017 {
<a name="l05018"></a>05018     <span class="keywordflow">return</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a8914f9333a31ef3fddbbf14baef87c44">pose_clear_transform_generic_exec</a>(C, op, <a class="code" href="../../de/dbc/editarmature_8c.html#a4f9b395a330f69c48c4a4720e7466f2c">pchan_clear_transforms</a>, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a124f4130eac46dbad760860cd8f79a0f">ANIM_KS_LOC_ROT_SCALE_ID</a>);
<a name="l05019"></a>05019 }
<a name="l05020"></a>05020 
<a name="l05021"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a135ec8aed2f7e92bb417c1ecdbeeef18">05021</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#ae8160d27413323f7dec90705d885d351">POSE_OT_transforms_clear</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05022"></a>05022 {
<a name="l05023"></a>05023     <span class="comment">/* identifiers */</span>
<a name="l05024"></a>05024     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Clear Pose Transforms&quot;</span>;
<a name="l05025"></a>05025     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_transforms_clear&quot;</span>;
<a name="l05026"></a>05026     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Reset location, rotation, and scaling of selected bones to their default values&quot;</span>;
<a name="l05027"></a>05027     
<a name="l05028"></a>05028     <span class="comment">/* api callbacks */</span>
<a name="l05029"></a>05029     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#afa26dd0a7c5643c1a1f16d6eecb67214">pose_clear_transforms_exec</a>;
<a name="l05030"></a>05030     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05031"></a>05031     
<a name="l05032"></a>05032     <span class="comment">/* flags */</span>
<a name="l05033"></a>05033     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05034"></a>05034 }
<a name="l05035"></a>05035 
<a name="l05036"></a>05036 <span class="comment">/* ***************** selections ********************** */</span>
<a name="l05037"></a>05037 
<a name="l05038"></a><a class="code" href="../../de/dbc/editarmature_8c.html#abff2b02cf20d8c7928dfc7cf6a806205">05038</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#abff2b02cf20d8c7928dfc7cf6a806205">pose_de_select_all_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05039"></a>05039 {
<a name="l05040"></a>05040     <span class="keywordtype">int</span> action = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;action&quot;</span>);
<a name="l05041"></a>05041     
<a name="l05042"></a>05042     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05043"></a>05043     <span class="keywordtype">int</span> multipaint = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a87a556ea02e1c4d8373e54eb45610b74">multipaint</a>;
<a name="l05044"></a>05044 
<a name="l05045"></a>05045     <span class="keywordflow">if</span> (action == <a class="code" href="../../d4/d7f/WM__api_8h.html#a070b8f09bd544f3d0bd5786ca00cda02">SEL_TOGGLE</a>) {
<a name="l05046"></a>05046         action= <a class="code" href="../../df/d01/BKE__context_8h.html#a94bd6fd14d9df8885855a8ca0aea7c17">CTX_DATA_COUNT</a>(C, selected_pose_bones) ? <a class="code" href="../../d4/d7f/WM__api_8h.html#a94dcbe0e237e6d615cad805221261370">SEL_DESELECT</a> : <a class="code" href="../../d4/d7f/WM__api_8h.html#af76323cc5b70d4cbeca6b3887e166fb8">SEL_SELECT</a>;
<a name="l05047"></a>05047     }
<a name="l05048"></a>05048     
<a name="l05049"></a>05049     <span class="comment">/*  Set the flags */</span>
<a name="l05050"></a>05050     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *, pchan, visible_pose_bones) {
<a name="l05051"></a>05051         <span class="comment">/* select pchan only if selectable, but deselect works always */</span>
<a name="l05052"></a>05052         <span class="keywordflow">switch</span> (action) {
<a name="l05053"></a>05053         <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#af76323cc5b70d4cbeca6b3887e166fb8">SEL_SELECT</a>:
<a name="l05054"></a>05054             <span class="keywordflow">if</span> ((pchan-&gt;bone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0)
<a name="l05055"></a>05055                 pchan-&gt;bone-&gt;flag |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l05056"></a>05056             <span class="keywordflow">break</span>;
<a name="l05057"></a>05057         <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#a94dcbe0e237e6d615cad805221261370">SEL_DESELECT</a>:
<a name="l05058"></a>05058             pchan-&gt;bone-&gt;flag &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l05059"></a>05059             <span class="keywordflow">break</span>;
<a name="l05060"></a>05060         <span class="keywordflow">case</span> <a class="code" href="../../d4/d7f/WM__api_8h.html#ac906797cc9a2787004c6ad16b8151913">SEL_INVERT</a>:
<a name="l05061"></a>05061             <span class="keywordflow">if</span> (pchan-&gt;bone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l05062"></a>05062                 pchan-&gt;bone-&gt;flag &amp;= ~(<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>);
<a name="l05063"></a>05063             } 
<a name="l05064"></a>05064             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pchan-&gt;bone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>)==0) {
<a name="l05065"></a>05065                     pchan-&gt;bone-&gt;flag |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l05066"></a>05066             }
<a name="l05067"></a>05067             <span class="keywordflow">break</span>;
<a name="l05068"></a>05068         }
<a name="l05069"></a>05069     }
<a name="l05070"></a>05070     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l05071"></a>05071 
<a name="l05072"></a>05072     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05073"></a>05073     
<a name="l05074"></a>05074     <span class="keywordflow">if</span> (multipaint) {
<a name="l05075"></a>05075         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../da/d7a/ED__object_8h.html#a01f5782939cff9e5ad72853ac1fff05b">ED_object_context</a>(C);
<a name="l05076"></a>05076         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l05077"></a>05077     }
<a name="l05078"></a>05078 
<a name="l05079"></a>05079     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05080"></a>05080 }
<a name="l05081"></a>05081 
<a name="l05082"></a><a class="code" href="../../de/dbc/editarmature_8c.html#aa2df74e13b757841c108bbabba4566ad">05082</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#aab4f3cc68d87d9eac35c8bb07d2b300a">POSE_OT_select_all</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05083"></a>05083 {
<a name="l05084"></a>05084     <span class="comment">/* identifiers */</span>
<a name="l05085"></a>05085     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;(De)select All&quot;</span>;
<a name="l05086"></a>05086     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_select_all&quot;</span>;
<a name="l05087"></a>05087     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Toggle selection status of all bones&quot;</span>;
<a name="l05088"></a>05088     
<a name="l05089"></a>05089     <span class="comment">/* api callbacks */</span>
<a name="l05090"></a>05090     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#abff2b02cf20d8c7928dfc7cf6a806205">pose_de_select_all_exec</a>;
<a name="l05091"></a>05091     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05092"></a>05092     
<a name="l05093"></a>05093     <span class="comment">/* flags */</span>
<a name="l05094"></a>05094     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05095"></a>05095     
<a name="l05096"></a>05096     <a class="code" href="../../d6/dae/wm__operators_8c.html#ab59cd94616324bb4f3668be8f64bdcd8">WM_operator_properties_select_all</a>(ot);
<a name="l05097"></a>05097 }
<a name="l05098"></a>05098 
<a name="l05099"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ac8e91c6b71212801709c72af97a8b76f">05099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ac8e91c6b71212801709c72af97a8b76f">pose_select_parent_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l05100"></a>05100 {
<a name="l05101"></a>05101     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05102"></a>05102     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan,*parent;
<a name="l05103"></a>05103 
<a name="l05104"></a>05104     <span class="comment">/*  Determine if there is an active bone */</span>
<a name="l05105"></a>05105     pchan=<a class="code" href="../../df/d01/BKE__context_8h.html#afd2f8912aa143c0bf416c4ade0f0b03e">CTX_data_active_pose_bone</a>(C);
<a name="l05106"></a>05106     <span class="keywordflow">if</span> (pchan) {
<a name="l05107"></a>05107         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05108"></a>05108         parent=pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l05109"></a>05109         <span class="keywordflow">if</span> ((parent) &amp;&amp; !(parent-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a43b8f6f95c59bc19230dc54877807c1e">BONE_UNSELECTABLE</a>))) {
<a name="l05110"></a>05110             parent-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l05111"></a>05111             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= parent-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l05112"></a>05112         }
<a name="l05113"></a>05113         <span class="keywordflow">else</span> {
<a name="l05114"></a>05114             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05115"></a>05115         }
<a name="l05116"></a>05116     }
<a name="l05117"></a>05117     <span class="keywordflow">else</span> {
<a name="l05118"></a>05118         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05119"></a>05119     }
<a name="l05120"></a>05120 
<a name="l05121"></a>05121     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l05122"></a>05122     
<a name="l05123"></a>05123     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05124"></a>05124 }
<a name="l05125"></a>05125 
<a name="l05126"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a1bc70a7c06e975e0d3c7bbf3ed1b6dfa">05126</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#ad5fe92147221831bb49afb2dfe88ac03">POSE_OT_select_parent</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05127"></a>05127 {
<a name="l05128"></a>05128     <span class="comment">/* identifiers */</span>
<a name="l05129"></a>05129     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Select Parent Bone&quot;</span>;
<a name="l05130"></a>05130     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_select_parent&quot;</span>;
<a name="l05131"></a>05131     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Select bones that are parents of the currently selected bones&quot;</span>;
<a name="l05132"></a>05132 
<a name="l05133"></a>05133     <span class="comment">/* api callbacks */</span>
<a name="l05134"></a>05134     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ac8e91c6b71212801709c72af97a8b76f">pose_select_parent_exec</a>;
<a name="l05135"></a>05135     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05136"></a>05136 
<a name="l05137"></a>05137     <span class="comment">/* flags */</span>
<a name="l05138"></a>05138     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05139"></a>05139     
<a name="l05140"></a>05140 }
<a name="l05141"></a>05141 
<a name="l05142"></a>05142 <span class="comment">/* ************* hide/unhide pose bones ******************* */</span>
<a name="l05143"></a>05143 
<a name="l05144"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a10e73c5d1d93a2531e5f662ef65396e2">05144</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a10e73c5d1d93a2531e5f662ef65396e2">hide_selected_pose_bone_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr)) 
<a name="l05145"></a>05145 {
<a name="l05146"></a>05146     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05147"></a>05147     
<a name="l05148"></a>05148     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>) {
<a name="l05149"></a>05149         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l05150"></a>05150             bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>;
<a name="l05151"></a>05151             bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l05152"></a>05152             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>==bone)
<a name="l05153"></a>05153                 arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05154"></a>05154         }
<a name="l05155"></a>05155     }
<a name="l05156"></a>05156     <span class="keywordflow">return</span> 0;
<a name="l05157"></a>05157 }
<a name="l05158"></a>05158 
<a name="l05159"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ab22a7a7df7c77a936955dc1523c6ddb7">05159</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ab22a7a7df7c77a936955dc1523c6ddb7">hide_unselected_pose_bone_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr)) 
<a name="l05160"></a>05160 {
<a name="l05161"></a>05161     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05162"></a>05162     
<a name="l05163"></a>05163     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>) {
<a name="l05164"></a>05164         <span class="comment">// hrm... typo here?</span>
<a name="l05165"></a>05165         <span class="keywordflow">if</span> ((bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)==0) {
<a name="l05166"></a>05166             bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>;
<a name="l05167"></a>05167             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>==bone)
<a name="l05168"></a>05168                 arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05169"></a>05169         }
<a name="l05170"></a>05170     }
<a name="l05171"></a>05171     <span class="keywordflow">return</span> 0;
<a name="l05172"></a>05172 }
<a name="l05173"></a>05173 
<a name="l05174"></a>05174 <span class="comment">/* active object is armature in posemode, poll checked */</span>
<a name="l05175"></a><a class="code" href="../../de/dbc/editarmature_8c.html#ae041dbaea792866a2b145ede64fccc4d">05175</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#ae041dbaea792866a2b145ede64fccc4d">pose_hide_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op) 
<a name="l05176"></a>05176 {
<a name="l05177"></a>05177     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05178"></a>05178     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05179"></a>05179 
<a name="l05180"></a>05180     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;unselected&quot;</span>))
<a name="l05181"></a>05181         <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#ab22a7a7df7c77a936955dc1523c6ddb7">hide_unselected_pose_bone_cb</a>);
<a name="l05182"></a>05182     <span class="keywordflow">else</span>
<a name="l05183"></a>05183         <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#a10e73c5d1d93a2531e5f662ef65396e2">hide_selected_pose_bone_cb</a>);
<a name="l05184"></a>05184     
<a name="l05185"></a>05185     <span class="comment">/* note, notifier might evolve */</span>
<a name="l05186"></a>05186     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l05187"></a>05187     
<a name="l05188"></a>05188     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05189"></a>05189 }
<a name="l05190"></a>05190 
<a name="l05191"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a0599333c3d124c9bec146bf4006118b7">05191</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a65dbaae0a004f0fd244e41f289f424d2">POSE_OT_hide</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05192"></a>05192 {
<a name="l05193"></a>05193     <span class="comment">/* identifiers */</span>
<a name="l05194"></a>05194     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Hide Selected&quot;</span>;
<a name="l05195"></a>05195     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_hide&quot;</span>;
<a name="l05196"></a>05196     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Tag selected bones to not be visible in Pose Mode&quot;</span>;
<a name="l05197"></a>05197     
<a name="l05198"></a>05198     <span class="comment">/* api callbacks */</span>
<a name="l05199"></a>05199     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#ae041dbaea792866a2b145ede64fccc4d">pose_hide_exec</a>;
<a name="l05200"></a>05200     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05201"></a>05201     
<a name="l05202"></a>05202     <span class="comment">/* flags */</span>
<a name="l05203"></a>05203     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05204"></a>05204     
<a name="l05205"></a>05205     <span class="comment">/* props */</span>
<a name="l05206"></a>05206     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;unselected&quot;</span>, 0, <span class="stringliteral">&quot;Unselected&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05207"></a>05207 }
<a name="l05208"></a>05208 
<a name="l05209"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a924dface08cc369c9327f79769aeff4a">05209</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a924dface08cc369c9327f79769aeff4a">show_pose_bone_cb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr)) 
<a name="l05210"></a>05210 {
<a name="l05211"></a>05211     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05212"></a>05212     
<a name="l05213"></a>05213     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> &amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a>) {
<a name="l05214"></a>05214         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>) {
<a name="l05215"></a>05215             bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>;
<a name="l05216"></a>05216             bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>;
<a name="l05217"></a>05217         }
<a name="l05218"></a>05218     }
<a name="l05219"></a>05219     
<a name="l05220"></a>05220     <span class="keywordflow">return</span> 0;
<a name="l05221"></a>05221 }
<a name="l05222"></a>05222 
<a name="l05223"></a>05223 <span class="comment">/* active object is armature in posemode, poll checked */</span>
<a name="l05224"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a7f5a6a93f76820926843249c7f49df4f">05224</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a7f5a6a93f76820926843249c7f49df4f">pose_reveal_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op)) 
<a name="l05225"></a>05225 {
<a name="l05226"></a>05226     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05227"></a>05227     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05228"></a>05228     
<a name="l05229"></a>05229     <a class="code" href="../../de/dbc/editarmature_8c.html#a90dc59d18c68df68d7440e53788f4787">bone_looper</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../de/dbc/editarmature_8c.html#a924dface08cc369c9327f79769aeff4a">show_pose_bone_cb</a>);
<a name="l05230"></a>05230     
<a name="l05231"></a>05231     <span class="comment">/* note, notifier might evolve */</span>
<a name="l05232"></a>05232     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ac7693a07a6e4c10de8d8882649fe4f73">ND_BONE_SELECT</a>, ob);
<a name="l05233"></a>05233 
<a name="l05234"></a>05234     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05235"></a>05235 }
<a name="l05236"></a>05236 
<a name="l05237"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a732f4fe06f49ff1a52ff63032b57fb3e">05237</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a1c4c99bea5b2c592e1940e9813e044a4">POSE_OT_reveal</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05238"></a>05238 {
<a name="l05239"></a>05239     <span class="comment">/* identifiers */</span>
<a name="l05240"></a>05240     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Reveal Selected&quot;</span>;
<a name="l05241"></a>05241     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;POSE_OT_reveal&quot;</span>;
<a name="l05242"></a>05242     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Unhide all bones that have been tagged to be hidden in Pose Mode&quot;</span>;
<a name="l05243"></a>05243     
<a name="l05244"></a>05244     <span class="comment">/* api callbacks */</span>
<a name="l05245"></a>05245     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a7f5a6a93f76820926843249c7f49df4f">pose_reveal_exec</a>;
<a name="l05246"></a>05246     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a58cfd064018383fbdd69f7d409248fbb">ED_operator_posemode</a>;
<a name="l05247"></a>05247     
<a name="l05248"></a>05248     <span class="comment">/* flags */</span>
<a name="l05249"></a>05249     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05250"></a>05250 }
<a name="l05251"></a>05251 
<a name="l05252"></a>05252 <span class="comment">/* ************* RENAMING DISASTERS ************ */</span>
<a name="l05253"></a>05253 
<a name="l05254"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a827343dc637b9b11161e2895fab9ece5">05254</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a827343dc637b9b11161e2895fab9ece5">bone_unique_check</a>(<span class="keywordtype">void</span> *arg, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l05255"></a>05255 {
<a name="l05256"></a>05256     <span class="keywordflow">return</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#aa555e0c2fb76b7edbcbd5fc8344b993a">get_named_bone</a>((<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)arg, name) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05257"></a>05257 }
<a name="l05258"></a>05258 
<a name="l05259"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a1ad7fb57ef6c450e207a0c077910705c">05259</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a1ad7fb57ef6c450e207a0c077910705c">unique_bone_name</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <span class="keywordtype">char</span> *name)
<a name="l05260"></a>05260 {
<a name="l05261"></a>05261     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a55d85aa9be3dcae052659d317bdc962b">BLI_uniquename_cb</a>(<a class="code" href="../../de/dbc/editarmature_8c.html#a827343dc637b9b11161e2895fab9ece5">bone_unique_check</a>, (<span class="keywordtype">void</span> *)arm, <span class="stringliteral">&quot;Bone&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, name, <span class="keyword">sizeof</span>(((<a class="code" href="../../de/de0/structBone.html">Bone</a> *)<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)-&gt;name));
<a name="l05262"></a>05262 }
<a name="l05263"></a>05263 
<a name="l05264"></a>05264 <span class="comment">/* helper call for armature_bone_rename */</span>
<a name="l05265"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a37436c48f119c7fb086366e7341a7a95">05265</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a37436c48f119c7fb086366e7341a7a95">constraint_bone_name_fix</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *conlist, <span class="keywordtype">char</span> *oldname, <span class="keywordtype">char</span> *newname)
<a name="l05266"></a>05266 {
<a name="l05267"></a>05267     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *curcon;
<a name="l05268"></a>05268     <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l05269"></a>05269     
<a name="l05270"></a>05270     <span class="keywordflow">for</span> (curcon = conlist-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curcon; curcon=curcon-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l05271"></a>05271         <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti= <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(curcon);
<a name="l05272"></a>05272         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l05273"></a>05273         
<a name="l05274"></a>05274         <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l05275"></a>05275             cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(curcon, &amp;targets);
<a name="l05276"></a>05276             
<a name="l05277"></a>05277             <span class="keywordflow">for</span> (ct= targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct= ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l05278"></a>05278                 <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == ob) {
<a name="l05279"></a>05279                     <span class="keywordflow">if</span> (!strcmp(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, oldname) )
<a name="l05280"></a>05280                         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#ab1f6a09b2a30f6f55449e3e5871fafed">subtarget</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05281"></a>05281                 }
<a name="l05282"></a>05282             }
<a name="l05283"></a>05283             
<a name="l05284"></a>05284             <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l05285"></a>05285                 cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(curcon, &amp;targets, 0);
<a name="l05286"></a>05286         }   
<a name="l05287"></a>05287     }
<a name="l05288"></a>05288 }
<a name="l05289"></a>05289 
<a name="l05290"></a>05290 <span class="comment">/* called by UI for renaming a bone */</span>
<a name="l05291"></a>05291 <span class="comment">/* warning: make sure the original bone was not renamed yet! */</span>
<a name="l05292"></a>05292 <span class="comment">/* seems messy, but thats what you get with not using pointers but channel names :) */</span>
<a name="l05293"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a7dd98809305faf3396f6de3853b1e353">05293</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#abac425cdd2629a6d4350e455d293eb54">ED_armature_bone_rename</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <span class="keyword">const</span> <span class="keywordtype">char</span> *oldnamep, <span class="keyword">const</span> <span class="keywordtype">char</span> *newnamep)
<a name="l05294"></a>05294 {
<a name="l05295"></a>05295     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l05296"></a>05296     <span class="keywordtype">char</span> newname[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l05297"></a>05297     <span class="keywordtype">char</span> oldname[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l05298"></a>05298     
<a name="l05299"></a>05299     <span class="comment">/* names better differ! */</span>
<a name="l05300"></a>05300     <span class="keywordflow">if</span> (strncmp(oldnamep, newnamep, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>)) {
<a name="l05301"></a>05301         
<a name="l05302"></a>05302         <span class="comment">/* we alter newname string... so make copy */</span>
<a name="l05303"></a>05303         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(newname, newnamep, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05304"></a>05304         <span class="comment">/* we use oldname for search... so make copy */</span>
<a name="l05305"></a>05305         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(oldname, oldnamep, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05306"></a>05306         
<a name="l05307"></a>05307         <span class="comment">/* now check if we&#39;re in editmode, we need to find the unique name */</span>
<a name="l05308"></a>05308         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>) {
<a name="l05309"></a>05309             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone= <a class="code" href="../../de/dbc/editarmature_8c.html#ad5cdf66d94e1fc8508eb8ca2b10c4bc3">editbone_name_exists</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, oldname);
<a name="l05310"></a>05310             
<a name="l05311"></a>05311             <span class="keywordflow">if</span> (eBone) {
<a name="l05312"></a>05312                 <a class="code" href="../../de/dbc/editarmature_8c.html#aaf09da47d8a72721e0e91b502b46d1b8">unique_editbone_name</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, newname, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05313"></a>05313                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05314"></a>05314             }
<a name="l05315"></a>05315             <span class="keywordflow">else</span> <span class="keywordflow">return</span>;
<a name="l05316"></a>05316         }
<a name="l05317"></a>05317         <span class="keywordflow">else</span> {
<a name="l05318"></a>05318             <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone= <a class="code" href="../../da/d17/BKE__armature_8h.html#aa555e0c2fb76b7edbcbd5fc8344b993a">get_named_bone</a>(arm, oldname);
<a name="l05319"></a>05319             
<a name="l05320"></a>05320             <span class="keywordflow">if</span> (bone) {
<a name="l05321"></a>05321                 <a class="code" href="../../de/dbc/editarmature_8c.html#a1ad7fb57ef6c450e207a0c077910705c">unique_bone_name</a>(arm, newname);
<a name="l05322"></a>05322                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05323"></a>05323             }
<a name="l05324"></a>05324             <span class="keywordflow">else</span> <span class="keywordflow">return</span>;
<a name="l05325"></a>05325         }
<a name="l05326"></a>05326         
<a name="l05327"></a>05327         <span class="comment">/* do entire dbase - objects */</span>
<a name="l05328"></a>05328         <span class="keywordflow">for</span> (ob= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l05329"></a>05329             <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l05330"></a>05330             
<a name="l05331"></a>05331             <span class="comment">/* we have the object using the armature */</span>
<a name="l05332"></a>05332             <span class="keywordflow">if</span> (arm==ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>) {
<a name="l05333"></a>05333                 <a class="code" href="../../de/de7/structObject.html">Object</a> *cob;
<a name="l05334"></a>05334                 
<a name="l05335"></a>05335                 <span class="comment">/* Rename the pose channel, if it exists */</span>
<a name="l05336"></a>05336                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) {
<a name="l05337"></a>05337                     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, oldname);
<a name="l05338"></a>05338                     <span class="keywordflow">if</span> (pchan) {
<a name="l05339"></a>05339                         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05340"></a>05340                         
<a name="l05341"></a>05341                         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a53448bd807d93c5d257db12993430ef8">chanhash</a>) {
<a name="l05342"></a>05342                             <a class="code" href="../../df/da0/structGHash.html">GHash</a> *gh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a53448bd807d93c5d257db12993430ef8">chanhash</a>;
<a name="l05343"></a>05343                             
<a name="l05344"></a>05344                             <span class="comment">/* remove the old hash entry, and replace with the new name */</span>
<a name="l05345"></a>05345                             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(gh, oldname, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05346"></a>05346                             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(gh, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, pchan);
<a name="l05347"></a>05347                         }
<a name="l05348"></a>05348                     }
<a name="l05349"></a>05349                 }
<a name="l05350"></a>05350                 
<a name="l05351"></a>05351                 <span class="comment">/* Update any object constraints to use the new bone name */</span>
<a name="l05352"></a>05352                 <span class="keywordflow">for</span> (cob= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;object.first; cob; cob= cob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l05353"></a>05353                     <span class="keywordflow">if</span> (cob-&gt;<a class="code" href="../../de/de7/structObject.html#a15cd252985e63b0a4b12a07297a7aa8b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l05354"></a>05354                         <a class="code" href="../../de/dbc/editarmature_8c.html#a37436c48f119c7fb086366e7341a7a95">constraint_bone_name_fix</a>(ob, &amp;cob-&gt;<a class="code" href="../../de/de7/structObject.html#a15cd252985e63b0a4b12a07297a7aa8b">constraints</a>, oldname, newname);
<a name="l05355"></a>05355                     <span class="keywordflow">if</span> (cob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) {
<a name="l05356"></a>05356                         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l05357"></a>05357                         <span class="keywordflow">for</span> (pchan = cob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan=pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l05358"></a>05358                             <a class="code" href="../../de/dbc/editarmature_8c.html#a37436c48f119c7fb086366e7341a7a95">constraint_bone_name_fix</a>(ob, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>, oldname, newname);
<a name="l05359"></a>05359                         }
<a name="l05360"></a>05360                     }
<a name="l05361"></a>05361                 }
<a name="l05362"></a>05362             }
<a name="l05363"></a>05363             
<a name="l05364"></a>05364             <span class="comment">/* See if an object is parented to this armature */</span>
<a name="l05365"></a>05365             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> == arm)) {
<a name="l05366"></a>05366                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0ed2df4a386ce2b22084aaaa701d73ff">partype</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa660de9e3216076e99f66fac72274ea0">PARBONE</a>) {
<a name="l05367"></a>05367                     <span class="comment">/* bone name in object */</span>
<a name="l05368"></a>05368                     <span class="keywordflow">if</span> (!strcmp(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>, oldname))
<a name="l05369"></a>05369                         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af977a5a5856a9eb1938a006b90484524">parsubstr</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05370"></a>05370                 }
<a name="l05371"></a>05371             }
<a name="l05372"></a>05372             
<a name="l05373"></a>05373             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ab96d73f953ac55ddfddc0990021f62fc">modifiers_usesArmature</a>(ob, arm)) { 
<a name="l05374"></a>05374                 <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob, oldname);
<a name="l05375"></a>05375                 <span class="keywordflow">if</span> (dg) {
<a name="l05376"></a>05376                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05377"></a>05377                 }
<a name="l05378"></a>05378             }
<a name="l05379"></a>05379             
<a name="l05380"></a>05380             <span class="comment">/* fix modifiers that might be using this name */</span>
<a name="l05381"></a>05381             <span class="keywordflow">for</span> (md= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; md; md= md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l05382"></a>05382                 <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a82ec76427c7cc0b352e6aadb2e3d0b89">eModifierType_Hook</a>) {
<a name="l05383"></a>05383                     <a class="code" href="../../d8/d2c/structHookModifierData.html">HookModifierData</a> *hmd = (<a class="code" href="../../d8/d2c/structHookModifierData.html">HookModifierData</a> *)md;
<a name="l05384"></a>05384                     
<a name="l05385"></a>05385                     <span class="comment">/* uses armature, so may use the affected bone name */</span>
<a name="l05386"></a>05386                     <span class="keywordflow">if</span> (hmd-&gt;<a class="code" href="../../d8/d2c/structHookModifierData.html#ae539a97632b216b678294b1c1fa80a88">object</a> &amp;&amp; (hmd-&gt;<a class="code" href="../../d8/d2c/structHookModifierData.html#ae539a97632b216b678294b1c1fa80a88">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> == arm)) {
<a name="l05387"></a>05387                         <span class="keywordflow">if</span> (!strcmp(hmd-&gt;<a class="code" href="../../d8/d2c/structHookModifierData.html#a8833a43481ef0247c48fbe8ae24a1526">subtarget</a>, oldname))
<a name="l05388"></a>05388                             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(hmd-&gt;<a class="code" href="../../d8/d2c/structHookModifierData.html#a8833a43481ef0247c48fbe8ae24a1526">subtarget</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05389"></a>05389                     }
<a name="l05390"></a>05390                 }
<a name="l05391"></a>05391             }
<a name="l05392"></a>05392         }
<a name="l05393"></a>05393         
<a name="l05394"></a>05394         <span class="comment">/* Fix all animdata that may refer to this bone - we can&#39;t just do the ones attached to objects, since</span>
<a name="l05395"></a>05395 <span class="comment">         * other ID-blocks may have drivers referring to this bone [#29822]</span>
<a name="l05396"></a>05396 <span class="comment">         */</span>
<a name="l05397"></a>05397         {
<a name="l05398"></a>05398             
<a name="l05399"></a>05399             <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a9b16d4c54913bd599b0cb6f51a9a28ce">BKE_all_animdata_fix_paths_rename</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>, <span class="stringliteral">&quot;pose.bones&quot;</span>, oldname, newname);
<a name="l05400"></a>05400         }
<a name="l05401"></a>05401         
<a name="l05402"></a>05402         <span class="comment">/* correct view locking */</span>
<a name="l05403"></a>05403         {
<a name="l05404"></a>05404             <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *screen;
<a name="l05405"></a>05405             <span class="keywordflow">for</span> (screen= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;screen.first; screen; screen= screen-&gt;<a class="code" href="../../de/de7/structbScreen.html#ac661d280cae6952ebc9f9c95279cf6f2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l05406"></a>05406                 <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa;
<a name="l05407"></a>05407                 <span class="comment">/* add regions */</span>
<a name="l05408"></a>05408                 <span class="keywordflow">for</span> (sa= screen-&gt;<a class="code" href="../../de/de7/structbScreen.html#ae2f4a800c4c58fe953d91fe8136a0d0f">areabase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sa; sa= sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a884b59339f5c0d55408f8727bfc799b7">next</a>) {
<a name="l05409"></a>05409                     <a class="code" href="../../d4/d63/structSpaceLink.html">SpaceLink</a> *sl;
<a name="l05410"></a>05410                     <span class="keywordflow">for</span> (sl= sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sl; sl= sl-&gt;<a class="code" href="../../d4/d63/structSpaceLink.html#a02205c8e58d3bffda62cb69123b36629">next</a>) {
<a name="l05411"></a>05411                         <span class="keywordflow">if</span> (sl-&gt;<a class="code" href="../../d4/d63/structSpaceLink.html#a842775af6c8ee1e2b4fd1fa4ab77a633">spacetype</a>==<a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l05412"></a>05412                             <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= (<a class="code" href="../../d6/deb/structView3D.html">View3D</a> *)sl;
<a name="l05413"></a>05413                             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4f6d087894f000468b148ca934b3ec3a">ob_centre</a> &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4f6d087894f000468b148ca934b3ec3a">ob_centre</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> == arm) {
<a name="l05414"></a>05414                                 <span class="keywordflow">if</span> (!strcmp(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afa0cb5a0e5fd30b4ecc737cd0aba8e4d">ob_centre_bone</a>, oldname)) {
<a name="l05415"></a>05415                                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afa0cb5a0e5fd30b4ecc737cd0aba8e4d">ob_centre_bone</a>, newname, <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>);
<a name="l05416"></a>05416                                 }
<a name="l05417"></a>05417                             }
<a name="l05418"></a>05418                         }
<a name="l05419"></a>05419                     }
<a name="l05420"></a>05420                 }
<a name="l05421"></a>05421             }
<a name="l05422"></a>05422         }
<a name="l05423"></a>05423     }
<a name="l05424"></a>05424 }
<a name="l05425"></a>05425 
<a name="l05426"></a>05426 
<a name="l05427"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a5bc9d28e3b07e53a8980355d662786a4">05427</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a5bc9d28e3b07e53a8980355d662786a4">armature_flip_names_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l05428"></a>05428 {
<a name="l05429"></a>05429     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l05430"></a>05430     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l05431"></a>05431     <span class="keywordtype">char</span> newname[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l05432"></a>05432     
<a name="l05433"></a>05433     <span class="comment">/* paranoia checks */</span>
<a name="l05434"></a>05434     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>)) 
<a name="l05435"></a>05435         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05436"></a>05436     arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05437"></a>05437     
<a name="l05438"></a>05438     <span class="comment">/* loop through selected bones, auto-naming them */</span>
<a name="l05439"></a>05439     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones)
<a name="l05440"></a>05440     {
<a name="l05441"></a>05441         <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a13c8067511267c6d95644db2450a367a">flip_side_name</a>(newname, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>); <span class="comment">// 1 = do strip off number extensions</span>
<a name="l05442"></a>05442         <a class="code" href="../../de/dbc/editarmature_8c.html#abac425cdd2629a6d4350e455d293eb54">ED_armature_bone_rename</a>(arm, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, newname);
<a name="l05443"></a>05443     }
<a name="l05444"></a>05444     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l05445"></a>05445     
<a name="l05446"></a>05446     <span class="comment">/* since we renamed stuff... */</span>
<a name="l05447"></a>05447     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l05448"></a>05448 
<a name="l05449"></a>05449     <span class="comment">/* note, notifier might evolve */</span>
<a name="l05450"></a>05450     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, ob);
<a name="l05451"></a>05451     
<a name="l05452"></a>05452     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05453"></a>05453 }
<a name="l05454"></a>05454 
<a name="l05455"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a8d243b527ca9066ba751ddc958606146">05455</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#a7b202a8d677bcf6d771b0ef3e336099e">ARMATURE_OT_flip_names</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05456"></a>05456 {
<a name="l05457"></a>05457     <span class="comment">/* identifiers */</span>
<a name="l05458"></a>05458     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Flip Names&quot;</span>;
<a name="l05459"></a>05459     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_flip_names&quot;</span>;
<a name="l05460"></a>05460     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Flips (and corrects) the axis suffixes of the names of selected bones&quot;</span>;
<a name="l05461"></a>05461     
<a name="l05462"></a>05462     <span class="comment">/* api callbacks */</span>
<a name="l05463"></a>05463     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a5bc9d28e3b07e53a8980355d662786a4">armature_flip_names_exec</a>;
<a name="l05464"></a>05464     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l05465"></a>05465     
<a name="l05466"></a>05466     <span class="comment">/* flags */</span>
<a name="l05467"></a>05467     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05468"></a>05468 }
<a name="l05469"></a>05469 
<a name="l05470"></a>05470 
<a name="l05471"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a1ce8f6b569156475e0786d4d4bbe7fcb">05471</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/dbc/editarmature_8c.html#a1ce8f6b569156475e0786d4d4bbe7fcb">armature_autoside_names_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05472"></a>05472 {
<a name="l05473"></a>05473     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l05474"></a>05474     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l05475"></a>05475     <span class="keywordtype">char</span> newname[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l05476"></a>05476     <span class="keywordtype">short</span> axis= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l05477"></a>05477     
<a name="l05478"></a>05478     <span class="comment">/* paranoia checks */</span>
<a name="l05479"></a>05479     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>)) 
<a name="l05480"></a>05480         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05481"></a>05481     arm= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05482"></a>05482     
<a name="l05483"></a>05483     <span class="comment">/* loop through selected bones, auto-naming them */</span>
<a name="l05484"></a>05484     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *, ebone, selected_editable_bones)
<a name="l05485"></a>05485     {
<a name="l05486"></a>05486         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(newname, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, <span class="keyword">sizeof</span>(newname));
<a name="l05487"></a>05487         <span class="keywordflow">if</span> (<a class="code" href="../../da/d17/BKE__armature_8h.html#af721e7a6d7d58835277acef64651caa3">bone_autoside_name</a>(newname, 1, axis, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[axis], ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[axis]))
<a name="l05488"></a>05488             <a class="code" href="../../de/dbc/editarmature_8c.html#abac425cdd2629a6d4350e455d293eb54">ED_armature_bone_rename</a>(arm, ebone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a0b066e21cfe03e95a72ef517396fe139">name</a>, newname);
<a name="l05489"></a>05489     }
<a name="l05490"></a>05490     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l05491"></a>05491     
<a name="l05492"></a>05492     <span class="comment">/* since we renamed stuff... */</span>
<a name="l05493"></a>05493     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l05494"></a>05494 
<a name="l05495"></a>05495     <span class="comment">/* note, notifier might evolve */</span>
<a name="l05496"></a>05496     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a72e1ed3dc8d04e8bc84328ec6ef6ce80">ND_POSE</a>, ob);
<a name="l05497"></a>05497     
<a name="l05498"></a>05498     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05499"></a>05499 }
<a name="l05500"></a>05500 
<a name="l05501"></a><a class="code" href="../../de/dbc/editarmature_8c.html#a9f09e7e7df365c25b39d536ca281fa5c">05501</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d26/armature__intern_8h.html#aeea1f1a35f64242e3de54df9961b6aac">ARMATURE_OT_autoside_names</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05502"></a>05502 {
<a name="l05503"></a>05503     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> axis_items[]= {
<a name="l05504"></a>05504          {0, <span class="stringliteral">&quot;XAXIS&quot;</span>, 0, <span class="stringliteral">&quot;X-Axis&quot;</span>, <span class="stringliteral">&quot;Left/Right&quot;</span>},
<a name="l05505"></a>05505         {1, <span class="stringliteral">&quot;YAXIS&quot;</span>, 0, <span class="stringliteral">&quot;Y-Axis&quot;</span>, <span class="stringliteral">&quot;Front/Back&quot;</span>},
<a name="l05506"></a>05506         {2, <span class="stringliteral">&quot;ZAXIS&quot;</span>, 0, <span class="stringliteral">&quot;Z-Axis&quot;</span>, <span class="stringliteral">&quot;Top/Bottom&quot;</span>},
<a name="l05507"></a>05507         {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}};
<a name="l05508"></a>05508     
<a name="l05509"></a>05509     <span class="comment">/* identifiers */</span>
<a name="l05510"></a>05510     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;AutoName by Axis&quot;</span>;
<a name="l05511"></a>05511     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ARMATURE_OT_autoside_names&quot;</span>;
<a name="l05512"></a>05512     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Automatically renames the selected bones according to which side of the target axis they fall on&quot;</span>;
<a name="l05513"></a>05513     
<a name="l05514"></a>05514     <span class="comment">/* api callbacks */</span>
<a name="l05515"></a>05515     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l05516"></a>05516     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../de/dbc/editarmature_8c.html#a1ce8f6b569156475e0786d4d4bbe7fcb">armature_autoside_names_exec</a>;
<a name="l05517"></a>05517     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a38bfeb4c47a5c36662577cb7508473c1">ED_operator_editarmature</a>;
<a name="l05518"></a>05518     
<a name="l05519"></a>05519     <span class="comment">/* flags */</span>
<a name="l05520"></a>05520     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05521"></a>05521     
<a name="l05522"></a>05522     <span class="comment">/* settings */</span>
<a name="l05523"></a>05523     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, axis_items, 0, <span class="stringliteral">&quot;Axis&quot;</span>, <span class="stringliteral">&quot;Axis tag names with&quot;</span>);
<a name="l05524"></a>05524 }
<a name="l05525"></a>05525 
<a name="l05526"></a>05526 
<a name="l05527"></a>05527 
<a name="l05528"></a>05528 <span class="comment">/* if editbone (partial) selected, copy data */</span>
<a name="l05529"></a>05529 <span class="comment">/* context; editmode armature, with mirror editing enabled */</span>
<a name="l05530"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a382a2ef020661cb7243ff3213ec837eb">05530</a> <span class="keywordtype">void</span> <a class="code" href="../../de/dbc/editarmature_8c.html#afaacf5bff9e5f6245ffa31dd5f8224f1">transform_armature_mirror_update</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit)
<a name="l05531"></a>05531 {
<a name="l05532"></a>05532     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05533"></a>05533     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *ebo, *eboflip;
<a name="l05534"></a>05534     
<a name="l05535"></a>05535     <span class="keywordflow">for</span> (ebo= arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ebo; ebo=ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l05536"></a>05536         <span class="comment">/* no layer check, correct mirror is more important */</span>
<a name="l05537"></a>05537         <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>)) {
<a name="l05538"></a>05538             eboflip= <a class="code" href="../../de/dbc/editarmature_8c.html#a05a949b4165d023d564d093bbf9283ef">ED_armature_bone_get_mirrored</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, ebo);
<a name="l05539"></a>05539             
<a name="l05540"></a>05540             <span class="keywordflow">if</span> (eboflip) {
<a name="l05541"></a>05541                 <span class="comment">/* we assume X-axis flipping for now */</span>
<a name="l05542"></a>05542                 <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>) {
<a name="l05543"></a>05543                     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *children;
<a name="l05544"></a>05544                     
<a name="l05545"></a>05545                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[0]= -ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[0];
<a name="l05546"></a>05546                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[1]= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[1];
<a name="l05547"></a>05547                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[2]= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>[2];
<a name="l05548"></a>05548                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l05549"></a>05549                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= -ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l05550"></a>05550 
<a name="l05551"></a>05551                     <span class="comment">/* Also move connected children, in case children&#39;s name aren&#39;t mirrored properly */</span>
<a name="l05552"></a>05552                     <span class="keywordflow">for</span> (children=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; children; children=children-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l05553"></a>05553                         <span class="keywordflow">if</span> (children-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> == eboflip &amp;&amp; children-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) {
<a name="l05554"></a>05554                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(children-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l05555"></a>05555                             children-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a> = ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a>;
<a name="l05556"></a>05556                         }
<a name="l05557"></a>05557                     }
<a name="l05558"></a>05558                 }
<a name="l05559"></a>05559                 <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>) {
<a name="l05560"></a>05560                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[0]= -ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[0];
<a name="l05561"></a>05561                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[1]= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[1];
<a name="l05562"></a>05562                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[2]= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>[2];
<a name="l05563"></a>05563                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>;
<a name="l05564"></a>05564                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= -ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l05565"></a>05565                     
<a name="l05566"></a>05566                     <span class="comment">/* Also move connected parent, in case parent&#39;s name isn&#39;t mirrored properly */</span>
<a name="l05567"></a>05567                     <span class="keywordflow">if</span> (eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> &amp;&amp; eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) {
<a name="l05568"></a>05568                         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *parent = eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l05569"></a>05569                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l05570"></a>05570                         parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#ac09b2784c353a7d246cf1b6dd066e514">rad_tail</a> = ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#ae919754424b2a3de761e86f1a9e27fe2">rad_head</a>;
<a name="l05571"></a>05571                     }
<a name="l05572"></a>05572                 }
<a name="l05573"></a>05573                 <span class="keywordflow">if</span> (ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>) {
<a name="l05574"></a>05574                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa7a1c4706c5f92414adc49c050ebf7f3">dist</a>;
<a name="l05575"></a>05575                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>= -ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3df5c40c7d09aee2cad34b5694bde3ff">roll</a>;
<a name="l05576"></a>05576                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#aa2e6b9916ca92a7b41759f2bf00c4d25">xwidth</a>;
<a name="l05577"></a>05577                     eboflip-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>= ebo-&gt;<a class="code" href="../../da/d29/structEditBone.html#a94b394ad140ffe627cc9e6dab73e3be3">zwidth</a>;
<a name="l05578"></a>05578                 }
<a name="l05579"></a>05579             }
<a name="l05580"></a>05580         }
<a name="l05581"></a>05581     }
<a name="l05582"></a>05582 }
<a name="l05583"></a>05583 
<a name="l05584"></a>05584 
<a name="l05585"></a>05585 <span class="comment">/*****************************************************************************************************/</span>
<a name="l05586"></a>05586 <span class="comment">/*************************************** SKELETON GENERATOR ******************************************/</span>
<a name="l05587"></a>05587 <span class="comment">/*****************************************************************************************************/</span>
<a name="l05588"></a>05588 
<a name="l05589"></a>05589 <span class="preprocessor">#if 0</span>
<a name="l05590"></a>05590 <span class="preprocessor"></span>
<a name="l05591"></a>05591 <span class="comment">/**************************************** SUBDIVISION ALGOS ******************************************/</span>
<a name="l05592"></a>05592 
<a name="l05593"></a>05593 <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> * subdivideByAngle(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *arc, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *head, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *tail)
<a name="l05594"></a>05594 {
<a name="l05595"></a>05595     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05596"></a>05596     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *lastBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05597"></a>05597     
<a name="l05598"></a>05598     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af0b94a84b1f5e158a318aad58c19ea4b">skgen_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d5ea58b454d73bdee11971e686aa335">SKGEN_CUT_ANGLE</a>) {
<a name="l05599"></a>05599         <a class="code" href="../../d7/d84/structReebArcIterator.html">ReebArcIterator</a> arc_iter;
<a name="l05600"></a>05600         <a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a> *iter = (<a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a>*)&amp;arc_iter;
<a name="l05601"></a>05601         <span class="keywordtype">float</span> *previous = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *current = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05602"></a>05602         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *child = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05603"></a>05603         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *parent = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05604"></a>05604         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *root = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05605"></a>05605         <span class="keywordtype">float</span> angleLimit = (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a713edf332679a877df0768ff4483da6b">skgen_angle_limit</a> * <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f);
<a name="l05606"></a>05606         
<a name="l05607"></a>05607         parent = <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(arm, <span class="stringliteral">&quot;Bone&quot;</span>);
<a name="l05608"></a>05608         parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l05609"></a>05609         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, head-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>);
<a name="l05610"></a>05610         
<a name="l05611"></a>05611         root = parent;
<a name="l05612"></a>05612         
<a name="l05613"></a>05613         <a class="code" href="../../d2/dd8/reeb_8c.html#a1fc7f57576a7ca11375157936e8ac9f6">initArcIterator</a>(iter, arc, head);
<a name="l05614"></a>05614         <a class="code" href="../../d3/dd0/BLI__graph_8h.html#a8bf2bb555b97df25f34751ecb6d7527d">IT_next</a>(iter);
<a name="l05615"></a>05615         previous = iter-&gt;<a class="code" href="../../d7/da3/structBArcIterator.html#ab2ad35768c2da6593547c79bbffaa355">p</a>;
<a name="l05616"></a>05616         
<a name="l05617"></a>05617         <span class="keywordflow">for</span> (<a class="code" href="../../d3/dd0/BLI__graph_8h.html#a8bf2bb555b97df25f34751ecb6d7527d">IT_next</a>(iter);
<a name="l05618"></a>05618             <a class="code" href="../../d3/dd0/BLI__graph_8h.html#a6c6083e610273051cce10a7c11d5062c">IT_stopped</a>(iter) == 0;
<a name="l05619"></a>05619             previous = iter-&gt;<a class="code" href="../../d7/da3/structBArcIterator.html#ab2ad35768c2da6593547c79bbffaa355">p</a>, <a class="code" href="../../d3/dd0/BLI__graph_8h.html#a8bf2bb555b97df25f34751ecb6d7527d">IT_next</a>(iter))
<a name="l05620"></a>05620         {
<a name="l05621"></a>05621             <span class="keywordtype">float</span> vec1[3], vec2[3];
<a name="l05622"></a>05622             <span class="keywordtype">float</span> len1, len2;
<a name="l05623"></a>05623             
<a name="l05624"></a>05624             current = iter-&gt;<a class="code" href="../../d7/da3/structBArcIterator.html#ab2ad35768c2da6593547c79bbffaa355">p</a>;
<a name="l05625"></a>05625 
<a name="l05626"></a>05626             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec1, previous, parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>);
<a name="l05627"></a>05627             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec2, current, previous);
<a name="l05628"></a>05628 
<a name="l05629"></a>05629             len1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec1);
<a name="l05630"></a>05630             len2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec2);
<a name="l05631"></a>05631 
<a name="l05632"></a>05632             <span class="keywordflow">if</span> (len1 &gt; 0.0f &amp;&amp; len2 &gt; 0.0f &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec1, vec2) &lt; angleLimit) {
<a name="l05633"></a>05633                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, previous);
<a name="l05634"></a>05634 
<a name="l05635"></a>05635                 child = <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(arm, <span class="stringliteral">&quot;Bone&quot;</span>);
<a name="l05636"></a>05636                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(child-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>);
<a name="l05637"></a>05637                 child-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = parent;
<a name="l05638"></a>05638                 child-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l05639"></a>05639                 
<a name="l05640"></a>05640                 parent = child; <span class="comment">/* new child is next parent */</span>
<a name="l05641"></a>05641             }
<a name="l05642"></a>05642         }
<a name="l05643"></a>05643         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(parent-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, tail-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>);
<a name="l05644"></a>05644         
<a name="l05645"></a>05645         <span class="comment">/* If the bone wasn&#39;t subdivided, delete it and return NULL</span>
<a name="l05646"></a>05646 <span class="comment">         * to let subsequent subdivision methods do their thing. </span>
<a name="l05647"></a>05647 <span class="comment">         * */</span>
<a name="l05648"></a>05648         <span class="keywordflow">if</span> (parent == root) {
<a name="l05649"></a>05649             <span class="keywordflow">if</span> (parent==arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>) arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05650"></a>05650             <a class="code" href="../../de/dbc/editarmature_8c.html#a7c373891630bb74f110cd6743cda92b6">ED_armature_edit_bone_remove</a>(arm, parent);
<a name="l05651"></a>05651             parent = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05652"></a>05652         }
<a name="l05653"></a>05653         
<a name="l05654"></a>05654         lastBone = parent; <span class="comment">/* set last bone in the chain */</span>
<a name="l05655"></a>05655     }
<a name="l05656"></a>05656     
<a name="l05657"></a>05657     <span class="keywordflow">return</span> lastBone;
<a name="l05658"></a>05658 }
<a name="l05659"></a>05659 
<a name="l05660"></a>05660 <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> * test_subdivideByCorrelation(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *arc, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *head, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *tail)
<a name="l05661"></a>05661 {
<a name="l05662"></a>05662     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *lastBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05663"></a>05663 
<a name="l05664"></a>05664     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af0b94a84b1f5e158a318aad58c19ea4b">skgen_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#acf39a0b15c7dbe92aa3c9bfd2ad3cbe6">SKGEN_CUT_CORRELATION</a>) {
<a name="l05665"></a>05665         <span class="keywordtype">float</span> invmat[4][4]= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l05666"></a>05666         <span class="keywordtype">float</span> tmat[3][3]= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9351eb4f9017989083e1d3a7369fc9ed">MAT3_UNITY</a>;
<a name="l05667"></a>05667         <a class="code" href="../../d7/d84/structReebArcIterator.html">ReebArcIterator</a> arc_iter;
<a name="l05668"></a>05668         <a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a> *iter = (<a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a>*)&amp;arc_iter;
<a name="l05669"></a>05669         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05670"></a>05670         
<a name="l05671"></a>05671         <a class="code" href="../../d2/dd8/reeb_8c.html#a1fc7f57576a7ca11375157936e8ac9f6">initArcIterator</a>(iter, arc, head);
<a name="l05672"></a>05672         
<a name="l05673"></a>05673         lastBone = <a class="code" href="../../de/dad/BIF__generate_8h.html#affa9d2694503d93977208a63079042f4">subdivideArcBy</a>(arm, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, iter, invmat, tmat, <a class="code" href="../../de/dad/BIF__generate_8h.html#a0f6c6eb4f7eb04911abe87781d5e6cc5">nextAdaptativeSubdivision</a>);
<a name="l05674"></a>05674     }
<a name="l05675"></a>05675     
<a name="l05676"></a>05676     <span class="keywordflow">return</span> lastBone;
<a name="l05677"></a>05677 }
<a name="l05678"></a>05678 
<a name="l05679"></a>05679 <span class="keywordtype">float</span> arcLengthRatio(<a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *arc)
<a name="l05680"></a>05680 {
<a name="l05681"></a>05681     <span class="keywordtype">float</span> arcLength = 0.0f;
<a name="l05682"></a>05682     <span class="keywordtype">float</span> embedLength = 0.0f;
<a name="l05683"></a>05683     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l05684"></a>05684     
<a name="l05685"></a>05685     arcLength = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>, arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>);
<a name="l05686"></a>05686     
<a name="l05687"></a>05687     <span class="keywordflow">if</span> (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a0fa5154a652d5a6850f1fb3ad23e91b8">bcount</a> &gt; 0) {
<a name="l05688"></a>05688         <span class="comment">/* Add the embedding */</span>
<a name="l05689"></a>05689         <span class="keywordflow">for</span> ( i = 1; i &lt; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a0fa5154a652d5a6850f1fb3ad23e91b8">bcount</a>; i++) {
<a name="l05690"></a>05690             embedLength += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a23f7b86e6f92fc941384cbadef4f875c">buckets</a>[i - 1].<a class="code" href="../../d1/dd8/structEmbedBucket.html#a909132d17a0ff9dc6a7a5a2ee81ac60e">p</a>, arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a23f7b86e6f92fc941384cbadef4f875c">buckets</a>[i].<a class="code" href="../../d1/dd8/structEmbedBucket.html#a909132d17a0ff9dc6a7a5a2ee81ac60e">p</a>);
<a name="l05691"></a>05691         }
<a name="l05692"></a>05692         <span class="comment">/* Add head and tail -&gt; embedding vectors */</span>
<a name="l05693"></a>05693         embedLength += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>, arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a23f7b86e6f92fc941384cbadef4f875c">buckets</a>[0].<a class="code" href="../../d1/dd8/structEmbedBucket.html#a909132d17a0ff9dc6a7a5a2ee81ac60e">p</a>);
<a name="l05694"></a>05694         embedLength += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>, arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a23f7b86e6f92fc941384cbadef4f875c">buckets</a>[arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a0fa5154a652d5a6850f1fb3ad23e91b8">bcount</a> - 1].<a class="code" href="../../d1/dd8/structEmbedBucket.html#a909132d17a0ff9dc6a7a5a2ee81ac60e">p</a>);
<a name="l05695"></a>05695     }
<a name="l05696"></a>05696     <span class="keywordflow">else</span> {
<a name="l05697"></a>05697         embedLength = arcLength;
<a name="l05698"></a>05698     }
<a name="l05699"></a>05699     
<a name="l05700"></a>05700     <span class="keywordflow">return</span> embedLength / arcLength; 
<a name="l05701"></a>05701 }
<a name="l05702"></a>05702 
<a name="l05703"></a>05703 <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> * test_subdivideByLength(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *arc, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *head, <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *tail)
<a name="l05704"></a>05704 {
<a name="l05705"></a>05705     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *lastBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05706"></a>05706     <span class="keywordflow">if</span> ((scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af0b94a84b1f5e158a318aad58c19ea4b">skgen_options</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1d58e2593f002609077942dc2171421">SKGEN_CUT_LENGTH</a>) &amp;&amp;
<a name="l05707"></a>05707         arcLengthRatio(arc) &gt;= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.scene-&gt;toolsettings-&gt;skgen_length_ratio)
<a name="l05708"></a>05708     {
<a name="l05709"></a>05709         <span class="keywordtype">float</span> invmat[4][4]= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l05710"></a>05710         <span class="keywordtype">float</span> tmat[3][3]= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9351eb4f9017989083e1d3a7369fc9ed">MAT3_UNITY</a>;
<a name="l05711"></a>05711         <a class="code" href="../../d7/d84/structReebArcIterator.html">ReebArcIterator</a> arc_iter;
<a name="l05712"></a>05712         <a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a> *iter = (<a class="code" href="../../d7/da3/structBArcIterator.html">BArcIterator</a>*)&amp;arc_iter;
<a name="l05713"></a>05713         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm= obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05714"></a>05714         
<a name="l05715"></a>05715         <a class="code" href="../../d2/dd8/reeb_8c.html#a1fc7f57576a7ca11375157936e8ac9f6">initArcIterator</a>(iter, arc, head);
<a name="l05716"></a>05716         
<a name="l05717"></a>05717         lastBone = <a class="code" href="../../de/dad/BIF__generate_8h.html#affa9d2694503d93977208a63079042f4">subdivideArcBy</a>(arm, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>, iter, invmat, tmat, <a class="code" href="../../de/dad/BIF__generate_8h.html#a5a2568c2178400c3cae8701cef1b699c">nextLengthSubdivision</a>);
<a name="l05718"></a>05718     }
<a name="l05719"></a>05719     
<a name="l05720"></a>05720     <span class="keywordflow">return</span> lastBone;
<a name="l05721"></a>05721 }
<a name="l05722"></a>05722 
<a name="l05723"></a>05723 <span class="comment">/***************************************** MAIN ALGORITHM ********************************************/</span>
<a name="l05724"></a>05724 
<a name="l05725"></a>05725 <span class="keywordtype">void</span> generateSkeletonFromReebGraph(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d3/d02/structReebGraph.html">ReebGraph</a> *rg)
<a name="l05726"></a>05726 {
<a name="l05727"></a>05727     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>; <span class="comment">// XXX get from context</span>
<a name="l05728"></a>05728     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *arcBoneMap = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05729"></a>05729     <a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *arc = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05730"></a>05730     <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *node = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05731"></a>05731     <a class="code" href="../../de/de7/structObject.html">Object</a> *src = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05732"></a>05732     <a class="code" href="../../de/de7/structObject.html">Object</a> *dst = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05733"></a>05733     
<a name="l05734"></a>05734     src = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l05735"></a>05735     
<a name="l05736"></a>05736     <span class="keywordflow">if</span> (obedit != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05737"></a>05737         <a class="code" href="../../de/dbc/editarmature_8c.html#a2fe4a64b4c9cf17c809df717592d5bbe">ED_armature_from_edit</a>(obedit);
<a name="l05738"></a>05738         <a class="code" href="../../de/dbc/editarmature_8c.html#aa12e4dd01a83f83ea125ce1215054862">ED_armature_edit_free</a>(obedit);
<a name="l05739"></a>05739     }
<a name="l05740"></a>05740     
<a name="l05741"></a>05741     dst = <a class="code" href="../../df/dac/BKE__object_8h.html#a85239425cf97a3a7bdc40dd2590490c4">add_object</a>(scene, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>);
<a name="l05742"></a>05742     <a class="code" href="../../da/d7a/ED__object_8h.html#a523c930c437e74bf44af0021ec29cfd0">ED_object_base_init_transform</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);     <span class="comment">// XXX NULL is C, loc, rot</span>
<a name="l05743"></a>05743     obedit= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l05744"></a>05744     
<a name="l05745"></a>05745     <span class="comment">/* Copy orientation from source */</span>
<a name="l05746"></a>05746     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dst-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>, src-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l05747"></a>05747     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#abaa23f334189d294344e4c161701ddb2">mat4_to_eul</a>( dst-&gt;<a class="code" href="../../de/de7/structObject.html#a73a4242dd7998a04e9895fc07c749153">rot</a>,src-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05748"></a>05748     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a245c1bf7630bef5c065994ea56751d21">mat4_to_size</a>( dst-&gt;<a class="code" href="../../de/de7/structObject.html#a46e0f5309f8c13d85e16fa6436acf9f8">size</a>,src-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05749"></a>05749     
<a name="l05750"></a>05750     <a class="code" href="../../df/dac/BKE__object_8h.html#a8826fda9a63117e29f5340dd9db86998">where_is_object</a>(scene, obedit);
<a name="l05751"></a>05751     
<a name="l05752"></a>05752     <a class="code" href="../../de/dbc/editarmature_8c.html#a6b653e4e5f5a043678f51b72abdf350d">ED_armature_to_edit</a>(obedit);
<a name="l05753"></a>05753 
<a name="l05754"></a>05754     arcBoneMap = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;SkeletonFromReebGraph gh&quot;</span>);
<a name="l05755"></a>05755     
<a name="l05756"></a>05756     <a class="code" href="../../d3/dd0/BLI__graph_8h.html#a8d66d83c2a656d3025ee363ca8c4a35b">BLI_markdownSymmetry</a>((<a class="code" href="../../d0/d31/structBGraph.html">BGraph</a>*)rg, rg-&gt;<a class="code" href="../../d0/d31/structBGraph.html#a9824161be22b14cd50db8ad9bf607233">nodes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ad770c942287a18f84ffc8b6020081dbc">skgen_symmetry_limit</a>);
<a name="l05757"></a>05757     
<a name="l05758"></a>05758     <span class="keywordflow">for</span> (arc = rg-&gt;<a class="code" href="../../d3/d02/structReebGraph.html#a71efc113074211a91b5c62d2a377954b">arcs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; arc; arc = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8f981091e4b6f32f796d0a20fccf7bf2">next</a>) 
<a name="l05759"></a>05759     {
<a name="l05760"></a>05760         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *lastBone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05761"></a>05761         <a class="code" href="../../da/d14/structReebNode.html">ReebNode</a> *head, *tail;
<a name="l05762"></a>05762         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l05763"></a>05763 
<a name="l05764"></a>05764         <span class="comment">/* Find out the direction of the arc through simple heuristics (in order of priority) :</span>
<a name="l05765"></a>05765 <span class="comment">         * </span>
<a name="l05766"></a>05766 <span class="comment">         * 1- Arcs on primary symmetry axis (symmetry == 1) point up (head: high weight -&gt; tail: low weight)</span>
<a name="l05767"></a>05767 <span class="comment">         * 2- Arcs starting on a primary axis point away from it (head: node on primary axis)</span>
<a name="l05768"></a>05768 <span class="comment">         * 3- Arcs point down (head: low weight -&gt; tail: high weight)</span>
<a name="l05769"></a>05769 <span class="comment">         *</span>
<a name="l05770"></a>05770 <span class="comment">         * Finally, the arc direction is stored in its flag: 1 (low -&gt; high), -1 (high -&gt; low)</span>
<a name="l05771"></a>05771 <span class="comment">         */</span>
<a name="l05772"></a>05772 
<a name="l05773"></a>05773         <span class="comment">/* if arc is a symmetry axis, internal bones go up the tree */</span>
<a name="l05774"></a>05774         <span class="keywordflow">if</span> (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a2ad93b0efcba95cf298569eac15ad6a1">symmetry_level</a> == 1 &amp;&amp; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a523326bf4d4f23e7c0c679cb68a195ad">degree</a> != 1) {
<a name="l05775"></a>05775             head = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>;
<a name="l05776"></a>05776             tail = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>;
<a name="l05777"></a>05777             
<a name="l05778"></a>05778             arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> = -1; <span class="comment">/* mark arc direction */</span>
<a name="l05779"></a>05779         }
<a name="l05780"></a>05780         <span class="comment">/* Bones point AWAY from the symmetry axis */</span>
<a name="l05781"></a>05781         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a67d00e458e905011331309044f8dab81">symmetry_level</a> == 1) {
<a name="l05782"></a>05782             head = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>;
<a name="l05783"></a>05783             tail = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>;
<a name="l05784"></a>05784             
<a name="l05785"></a>05785             arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> = 1; <span class="comment">/* mark arc direction */</span>
<a name="l05786"></a>05786         }
<a name="l05787"></a>05787         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>-&gt;<a class="code" href="../../da/d14/structReebNode.html#a67d00e458e905011331309044f8dab81">symmetry_level</a> == 1) {
<a name="l05788"></a>05788             head = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>;
<a name="l05789"></a>05789             tail = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>;
<a name="l05790"></a>05790             
<a name="l05791"></a>05791             arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> = -1; <span class="comment">/* mark arc direction */</span>
<a name="l05792"></a>05792         }
<a name="l05793"></a>05793         <span class="comment">/* otherwise, always go from low weight to high weight */</span>
<a name="l05794"></a>05794         <span class="keywordflow">else</span> {
<a name="l05795"></a>05795             head = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a>;
<a name="l05796"></a>05796             tail = arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a>;
<a name="l05797"></a>05797             
<a name="l05798"></a>05798             arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> = 1; <span class="comment">/* mark arc direction */</span>
<a name="l05799"></a>05799         }
<a name="l05800"></a>05800         
<a name="l05801"></a>05801         <span class="comment">/* Loop over subdivision methods */</span> 
<a name="l05802"></a>05802         <span class="keywordflow">for</span> (i = 0; lastBone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; i &lt; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24bf68610e3ff4d00fb1fb50f41f447d">SKGEN_SUB_TOTAL</a>; i++) {
<a name="l05803"></a>05803             <span class="keywordflow">switch</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a9fb75687b5956f6aff36ea0d5a6f587e">skgen_subdivisions</a>[i]) {
<a name="l05804"></a>05804                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa48b85331094d01b26ad9752030db4ab">SKGEN_SUB_LENGTH</a>:
<a name="l05805"></a>05805                     lastBone = test_subdivideByLength(scene, obedit, arc, head, tail);
<a name="l05806"></a>05806                     <span class="keywordflow">break</span>;
<a name="l05807"></a>05807                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a361c0d433ad9e037ce767c0e2993dc27">SKGEN_SUB_ANGLE</a>:
<a name="l05808"></a>05808                     lastBone = subdivideByAngle(scene, obedit, arc, head, tail);
<a name="l05809"></a>05809                     <span class="keywordflow">break</span>;
<a name="l05810"></a>05810                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6bc84f7c60c397a71bee8f1417469e2f">SKGEN_SUB_CORRELATION</a>:
<a name="l05811"></a>05811                     lastBone = test_subdivideByCorrelation(scene, obedit, arc, head, tail);
<a name="l05812"></a>05812                     <span class="keywordflow">break</span>;
<a name="l05813"></a>05813             }
<a name="l05814"></a>05814         }
<a name="l05815"></a>05815     
<a name="l05816"></a>05816         <span class="keywordflow">if</span> (lastBone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05817"></a>05817             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a>    *bone;
<a name="l05818"></a>05818             bone = <a class="code" href="../../de/dbc/editarmature_8c.html#a17d573c0ef449519690d0786f8cacb90">ED_armature_edit_bone_add</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, <span class="stringliteral">&quot;Bone&quot;</span>);
<a name="l05819"></a>05819             bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>;
<a name="l05820"></a>05820             
<a name="l05821"></a>05821             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, head-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>);
<a name="l05822"></a>05822             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, tail-&gt;<a class="code" href="../../da/d14/structReebNode.html#a531e3c11f126ba6705d037004711f171">p</a>);
<a name="l05823"></a>05823             
<a name="l05824"></a>05824             <span class="comment">/* set first and last bone, since there&#39;s only one */</span>
<a name="l05825"></a>05825             lastBone = bone;
<a name="l05826"></a>05826         }
<a name="l05827"></a>05827         
<a name="l05828"></a>05828         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(arcBoneMap, arc, lastBone);
<a name="l05829"></a>05829     }
<a name="l05830"></a>05830 
<a name="l05831"></a>05831     <span class="comment">/* Second pass, setup parent relationship between arcs */</span>
<a name="l05832"></a>05832     <span class="keywordflow">for</span> (node = rg-&gt;<a class="code" href="../../d3/d02/structReebGraph.html#ab6693248bded8f1b2bfee0cfbc65c9c3">nodes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; node; node = node-&gt;<a class="code" href="../../da/d14/structReebNode.html#a39fc036210efbc6e47b660e9a4a617f7">next</a>)
<a name="l05833"></a>05833     {
<a name="l05834"></a>05834         <a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a> *incomingArc = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05835"></a>05835         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l05836"></a>05836 
<a name="l05837"></a>05837         <span class="keywordflow">for</span> (i = 0; i &lt; node-&gt;<a class="code" href="../../da/d14/structReebNode.html#a523326bf4d4f23e7c0c679cb68a195ad">degree</a>; i++) {
<a name="l05838"></a>05838             arc = (<a class="code" href="../../d0/dc1/structReebArc.html">ReebArc</a>*)node-&gt;<a class="code" href="../../da/d14/structReebNode.html#a7da1b5ca46aad9951b05ddefff4dd795">arcs</a>[i];
<a name="l05839"></a>05839 
<a name="l05840"></a>05840             <span class="comment">/* if arc is incoming into the node */</span>
<a name="l05841"></a>05841             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a> == node &amp;&amp; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> == -1) ||
<a name="l05842"></a>05842                 (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a> == node &amp;&amp; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> ==  1))
<a name="l05843"></a>05843             {
<a name="l05844"></a>05844                 <span class="keywordflow">if</span> (incomingArc == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05845"></a>05845                     incomingArc = arc;
<a name="l05846"></a>05846                     <span class="comment">/* loop further to make sure there&#39;s only one incoming arc */</span>
<a name="l05847"></a>05847                 }
<a name="l05848"></a>05848                 <span class="keywordflow">else</span> {
<a name="l05849"></a>05849                     <span class="comment">/* skip this node if more than one incomingArc */</span>
<a name="l05850"></a>05850                     incomingArc = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05851"></a>05851                     <span class="keywordflow">break</span>; <span class="comment">/* No need to look further, we are skipping already */</span>
<a name="l05852"></a>05852                 }
<a name="l05853"></a>05853             }
<a name="l05854"></a>05854         }
<a name="l05855"></a>05855 
<a name="l05856"></a>05856         <span class="keywordflow">if</span> (incomingArc != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05857"></a>05857             <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *parentBone = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(arcBoneMap, incomingArc);
<a name="l05858"></a>05858 
<a name="l05859"></a>05859             <span class="comment">/* Look for outgoing arcs and parent their bones */</span>
<a name="l05860"></a>05860             <span class="keywordflow">for</span> (i = 0; i &lt; node-&gt;<a class="code" href="../../da/d14/structReebNode.html#a523326bf4d4f23e7c0c679cb68a195ad">degree</a>; i++)
<a name="l05861"></a>05861             {
<a name="l05862"></a>05862                 arc = node-&gt;<a class="code" href="../../da/d14/structReebNode.html#a7da1b5ca46aad9951b05ddefff4dd795">arcs</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l05863"></a>05863 
<a name="l05864"></a>05864                 <span class="comment">/* if arc is outgoing from the node */</span>
<a name="l05865"></a>05865                 <span class="keywordflow">if</span> ((arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a9da6e154a0e84c6185d2abf18261f6b3">head</a> == node &amp;&amp; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> == 1) || (arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a8efc890a6ba67bd2a0ef6dc7b9692e29">tail</a> == node &amp;&amp; arc-&gt;<a class="code" href="../../d0/dc1/structReebArc.html#a51842c15bf8056a1fb870bfad5ffb9e4">flag</a> == -1)) {
<a name="l05866"></a>05866                     <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *childBone = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(arcBoneMap, arc);
<a name="l05867"></a>05867 
<a name="l05868"></a>05868                     <span class="comment">/* find the root bone */</span>
<a name="l05869"></a>05869                     <span class="keywordflow">while</span> (childBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l05870"></a>05870                     {
<a name="l05871"></a>05871                         childBone = childBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a>;
<a name="l05872"></a>05872                     }
<a name="l05873"></a>05873 
<a name="l05874"></a>05874                     childBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#abbbb707335156f8caef65a275c51cd96">parent</a> = parentBone;
<a name="l05875"></a>05875                     childBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>;
<a name="l05876"></a>05876                 }
<a name="l05877"></a>05877             }
<a name="l05878"></a>05878         }
<a name="l05879"></a>05879     }
<a name="l05880"></a>05880     
<a name="l05881"></a>05881     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(arcBoneMap, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05882"></a>05882 }
<a name="l05883"></a>05883 
<a name="l05884"></a>05884 <span class="keywordtype">void</span> generateSkeleton(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l05885"></a>05885 {
<a name="l05886"></a>05886     <a class="code" href="../../d3/d02/structReebGraph.html">ReebGraph</a> *reebg;
<a name="l05887"></a>05887     
<a name="l05888"></a>05888 <span class="comment">//  setcursor_space(SPACE_VIEW3D, CURSOR_WAIT);</span>
<a name="l05889"></a>05889     
<a name="l05890"></a>05890     reebg = <a class="code" href="../../d5/d76/reeb_8h.html#a0de7967172bc1c3a760e9bd3174b6210">BIF_ReebGraphFromEditMesh</a>();
<a name="l05891"></a>05891 
<a name="l05892"></a>05892     generateSkeletonFromReebGraph(scene, reebg);
<a name="l05893"></a>05893 
<a name="l05894"></a>05894     <a class="code" href="../../d2/dd8/reeb_8c.html#a269fa0b591a21be3c589911a0490ef2d">REEB_freeGraph</a>(reebg);
<a name="l05895"></a>05895 
<a name="l05896"></a>05896     <span class="comment">//setcursor_space(SPACE_VIEW3D, CURSOR_EDIT);</span>
<a name="l05897"></a>05897 }
<a name="l05898"></a>05898 
<a name="l05899"></a>05899 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:15 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
