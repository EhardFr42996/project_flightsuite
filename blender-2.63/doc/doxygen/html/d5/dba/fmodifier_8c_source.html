<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: fmodifier.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">fmodifier.c</div>  </div>
</div>
<div class="contents">
<a href="../../d5/dba/fmodifier_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2009 Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Joshua Leung (full recode)</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d61/BLF__translation_8h.html">BLF_translation.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span> <span class="comment">/* windows needs for M_PI */</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dba/BKE__fcurve_8h.html">BKE_fcurve.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d95/BKE__idprop_8h.html">BKE_idprop.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">00052</a> <span class="preprocessor">#define SMALL -1.0e-10</span>
<a name="l00053"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define SELECT 1</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="comment">/* ******************************** F-Modifiers ********************************* */</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">/* Info ------------------------------- */</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* F-Modifiers are modifiers which operate on F-Curves. However, they can also be defined</span>
<a name="l00060"></a>00060 <span class="comment"> * on NLA-Strips to affect all of the F-Curves referenced by the NLA-Strip. </span>
<a name="l00061"></a>00061 <span class="comment"> */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* Template --------------------------- */</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* Each modifier defines a set of functions, which will be called at the appropriate</span>
<a name="l00066"></a>00066 <span class="comment"> * times. In addition to this, each modifier should have a type-info struct, where</span>
<a name="l00067"></a>00067 <span class="comment"> * its functions are attached for use. </span>
<a name="l00068"></a>00068 <span class="comment"> */</span>
<a name="l00069"></a>00069  
<a name="l00070"></a>00070 <span class="comment">/* Template for type-info data:</span>
<a name="l00071"></a>00071 <span class="comment"> *  - make a copy of this when creating new modifiers, and just change the functions</span>
<a name="l00072"></a>00072 <span class="comment"> *    pointed to as necessary</span>
<a name="l00073"></a>00073 <span class="comment"> *  - although the naming of functions doesn&#39;t matter, it would help for code</span>
<a name="l00074"></a>00074 <span class="comment"> *    readability, to follow the same naming convention as is presented here</span>
<a name="l00075"></a>00075 <span class="comment"> *  - any functions that a constraint doesn&#39;t need to define, don&#39;t define</span>
<a name="l00076"></a>00076 <span class="comment"> *    for such cases, just use NULL </span>
<a name="l00077"></a>00077 <span class="comment"> *  - these should be defined after all the functions have been defined, so that</span>
<a name="l00078"></a>00078 <span class="comment"> *    forward-definitions/prototypes don&#39;t need to be used!</span>
<a name="l00079"></a>00079 <span class="comment"> *  - keep this copy #if-def&#39;d so that future constraints can get based off this</span>
<a name="l00080"></a>00080 <span class="comment"> */</span>
<a name="l00081"></a>00081 <span class="preprocessor">#if 0</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> FMI_MODNAME = {
<a name="l00083"></a>00083     FMODIFIER_TYPE_MODNAME, <span class="comment">/* type */</span>
<a name="l00084"></a>00084     <span class="keyword">sizeof</span>(FMod_ModName), <span class="comment">/* size */</span>
<a name="l00085"></a>00085     FMI_TYPE_SOME_ACTION, <span class="comment">/* action type */</span>
<a name="l00086"></a>00086     FMI_REQUIRES_SOME_REQUIREMENT, <span class="comment">/* requirements */</span>
<a name="l00087"></a>00087     <span class="stringliteral">&quot;Modifier Name&quot;</span>, <span class="comment">/* name */</span>
<a name="l00088"></a>00088     <span class="stringliteral">&quot;FMod_ModName&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00089"></a>00089     fcm_modname_free, <span class="comment">/* free data */</span>
<a name="l00090"></a>00090     fcm_modname_relink, <span class="comment">/* relink data */</span>
<a name="l00091"></a>00091     fcm_modname_copy, <span class="comment">/* copy data */</span>
<a name="l00092"></a>00092     fcm_modname_new_data, <span class="comment">/* new data */</span>
<a name="l00093"></a>00093     fcm_modname_verify, <span class="comment">/* verify */</span>
<a name="l00094"></a>00094     fcm_modname_time, <span class="comment">/* evaluate time */</span>
<a name="l00095"></a>00095     fcm_modname_evaluate <span class="comment">/* evaluate */</span>
<a name="l00096"></a>00096 };
<a name="l00097"></a>00097 <span class="preprocessor">#endif</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>
<a name="l00099"></a>00099 <span class="comment">/* Generator F-Curve Modifier --------------------------- */</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/* Generators available:</span>
<a name="l00102"></a>00102 <span class="comment"> *  1) simple polynomial generator:</span>
<a name="l00103"></a>00103 <span class="comment"> *      - Exanded form - (y = C[0]*(x^(n)) + C[1]*(x^(n-1)) + ... + C[n])  </span>
<a name="l00104"></a>00104 <span class="comment"> *      - Factorized form - (y = (C[0][0]*x + C[0][1]) * (C[1][0]*x + C[1][1]) * ... * (C[n][0]*x + C[n][1]))</span>
<a name="l00105"></a>00105 <span class="comment"> */</span>
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#aae4280db731fa8f6907718d7637f402f">00107</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#aae4280db731fa8f6907718d7637f402f">fcm_generator_free</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00110"></a>00110     
<a name="l00111"></a>00111     <span class="comment">/* free polynomial coefficients array */</span>
<a name="l00112"></a>00112     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>)
<a name="l00113"></a>00113         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>);
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#aea680e68967e8d643f3793f259a69e54">00116</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#aea680e68967e8d643f3793f259a69e54">fcm_generator_copy</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *src)
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *gen= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00119"></a>00119     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *ogen= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)src-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     <span class="comment">/* copy coefficients array? */</span>
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (ogen-&gt;coefficients)
<a name="l00123"></a>00123         gen-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ogen-&gt;coefficients);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#aa9de7718fedcc1f65dfbc55689a5f9c9">00126</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#aa9de7718fedcc1f65dfbc55689a5f9c9">fcm_generator_new_data</a> (<span class="keywordtype">void</span> *mdata)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)mdata;
<a name="l00129"></a>00129     <span class="keywordtype">float</span> *cp;
<a name="l00130"></a>00130     
<a name="l00131"></a>00131     <span class="comment">/* set default generator to be linear 0-1 (gradient = 1, y-offset = 0) */</span>
<a name="l00132"></a>00132     data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>= 1;
<a name="l00133"></a>00133     data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>= 2;
<a name="l00134"></a>00134     cp= data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*2, <span class="stringliteral">&quot;FMod_Generator_Coefs&quot;</span>);
<a name="l00135"></a>00135     cp[0] = 0; <span class="comment">// y-offset </span>
<a name="l00136"></a>00136     cp[1] = 1; <span class="comment">// gradient</span>
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ad7e0b649260825498ac60d9b7d5e6eea">00139</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ad7e0b649260825498ac60d9b7d5e6eea">fcm_generator_verify</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     <span class="comment">/* requirements depend on mode */</span>
<a name="l00144"></a>00144     switch (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#af9386d7d9d7448a3b670305fa479eafd">mode</a>) {
<a name="l00145"></a>00145         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a81440a0ea37b5199e9493a708f2c06efaa68ea339f8d68ad8dc4fdba821baa5ff">FCM_GENERATOR_POLYNOMIAL</a>: <span class="comment">/* expanded polynomial expression */</span>
<a name="l00146"></a>00146         {
<a name="l00147"></a>00147             <span class="comment">/* arraysize needs to be order+1, so resize if not */</span>
<a name="l00148"></a>00148             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a> != (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>+1)) {
<a name="l00149"></a>00149                 <span class="keywordtype">float</span> *nc;
<a name="l00150"></a>00150                 
<a name="l00151"></a>00151                 <span class="comment">/* make new coefficients array, and copy over as much data as can fit */</span>
<a name="l00152"></a>00152                 nc= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>+1), <span class="stringliteral">&quot;FMod_Generator_Coefs&quot;</span>);
<a name="l00153"></a>00153                 
<a name="l00154"></a>00154                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>) {
<a name="l00155"></a>00155                     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a> &gt; (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>+1))
<a name="l00156"></a>00156                         memcpy(nc, data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>+1));
<a name="l00157"></a>00157                     <span class="keywordflow">else</span>
<a name="l00158"></a>00158                         memcpy(nc, data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>);
<a name="l00159"></a>00159                         
<a name="l00160"></a>00160                     <span class="comment">/* free the old data */</span>
<a name="l00161"></a>00161                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>);
<a name="l00162"></a>00162                 }   
<a name="l00163"></a>00163                 
<a name="l00164"></a>00164                 <span class="comment">/* set the new data */</span>
<a name="l00165"></a>00165                 data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>= nc;
<a name="l00166"></a>00166                 data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>= data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>+1;
<a name="l00167"></a>00167             }
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169             <span class="keywordflow">break</span>;
<a name="l00170"></a>00170         
<a name="l00171"></a>00171         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a81440a0ea37b5199e9493a708f2c06efa25c72f574bd182122d59a6e9007fc7b1">FCM_GENERATOR_POLYNOMIAL_FACTORISED</a>: <span class="comment">/* expanded polynomial expression */</span>
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173             <span class="comment">/* arraysize needs to be 2*order, so resize if not */</span>
<a name="l00174"></a>00174             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a> != (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a> * 2)) {
<a name="l00175"></a>00175                 <span class="keywordtype">float</span> *nc;
<a name="l00176"></a>00176                 
<a name="l00177"></a>00177                 <span class="comment">/* make new coefficients array, and copy over as much data as can fit */</span>
<a name="l00178"></a>00178                 nc= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>*2), <span class="stringliteral">&quot;FMod_Generator_Coefs&quot;</span>);
<a name="l00179"></a>00179                 
<a name="l00180"></a>00180                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>) {
<a name="l00181"></a>00181                     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a> &gt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a> * 2))
<a name="l00182"></a>00182                         memcpy(nc, data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a> * 2));
<a name="l00183"></a>00183                     <span class="keywordflow">else</span>
<a name="l00184"></a>00184                         memcpy(nc, data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>);
<a name="l00185"></a>00185                         
<a name="l00186"></a>00186                     <span class="comment">/* free the old data */</span>
<a name="l00187"></a>00187                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>);
<a name="l00188"></a>00188                 }   
<a name="l00189"></a>00189                 
<a name="l00190"></a>00190                 <span class="comment">/* set the new data */</span>
<a name="l00191"></a>00191                 data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>= nc;
<a name="l00192"></a>00192                 data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>= data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a> * 2;
<a name="l00193"></a>00193             }
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195             <span class="keywordflow">break</span>;  
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a598dc8577e1278e4a6fb48832c101749">00199</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a598dc8577e1278e4a6fb48832c101749">fcm_generator_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00202"></a>00202     
<a name="l00203"></a>00203     <span class="comment">/* behavior depends on mode </span>
<a name="l00204"></a>00204 <span class="comment">     * NOTE: the data in its default state is fine too</span>
<a name="l00205"></a>00205 <span class="comment">     */</span>
<a name="l00206"></a>00206     switch (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#af9386d7d9d7448a3b670305fa479eafd">mode</a>) {
<a name="l00207"></a>00207         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a81440a0ea37b5199e9493a708f2c06efaa68ea339f8d68ad8dc4fdba821baa5ff">FCM_GENERATOR_POLYNOMIAL</a>: <span class="comment">/* expanded polynomial expression */</span>
<a name="l00208"></a>00208         {
<a name="l00209"></a>00209             <span class="comment">/* we overwrite cvalue with the sum of the polynomial */</span>
<a name="l00210"></a>00210             <span class="keywordtype">float</span> *powers = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>, <span class="stringliteral">&quot;Poly Powers&quot;</span>);
<a name="l00211"></a>00211             <span class="keywordtype">float</span> value= 0.0f;
<a name="l00212"></a>00212             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00213"></a>00213             
<a name="l00214"></a>00214             <span class="comment">/* for each x^n, precalculate value based on previous one first... this should be </span>
<a name="l00215"></a>00215 <span class="comment">             * faster that calling pow() for each entry</span>
<a name="l00216"></a>00216 <span class="comment">             */</span>
<a name="l00217"></a>00217             <span class="keywordflow">for</span> (i=0; i &lt; data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>; i++) {
<a name="l00218"></a>00218                 <span class="comment">/* first entry is x^0 = 1, otherwise, calculate based on previous */</span>
<a name="l00219"></a>00219                 <span class="keywordflow">if</span> (i)
<a name="l00220"></a>00220                     powers[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= powers[i-1] * evaltime;
<a name="l00221"></a>00221                 <span class="keywordflow">else</span>
<a name="l00222"></a>00222                     powers[0]= 1;
<a name="l00223"></a>00223             }
<a name="l00224"></a>00224             
<a name="l00225"></a>00225             <span class="comment">/* for each coefficient, add to value, which we&#39;ll write to *cvalue in one go */</span>
<a name="l00226"></a>00226             <span class="keywordflow">for</span> (i=0; i &lt; data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aa2d2e069e48310cf427bb61540504e96">arraysize</a>; i++)
<a name="l00227"></a>00227                 value += data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>[i] * powers[i];
<a name="l00228"></a>00228             
<a name="l00229"></a>00229             <span class="comment">/* only if something changed, write *cvalue in one go */</span>
<a name="l00230"></a>00230             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>) {
<a name="l00231"></a>00231                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ac1b0aa418d935b68a8d116e9dc455b50">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>)
<a name="l00232"></a>00232                     *cvalue += value;
<a name="l00233"></a>00233                 <span class="keywordflow">else</span>
<a name="l00234"></a>00234                     *cvalue= value;
<a name="l00235"></a>00235             }
<a name="l00236"></a>00236                 
<a name="l00237"></a>00237             <span class="comment">/* cleanup */</span>
<a name="l00238"></a>00238             <span class="keywordflow">if</span> (powers) 
<a name="l00239"></a>00239                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(powers);
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241             <span class="keywordflow">break</span>;
<a name="l00242"></a>00242             
<a name="l00243"></a>00243         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a81440a0ea37b5199e9493a708f2c06efa25c72f574bd182122d59a6e9007fc7b1">FCM_GENERATOR_POLYNOMIAL_FACTORISED</a>: <span class="comment">/* Factorized polynomial */</span>
<a name="l00244"></a>00244         {
<a name="l00245"></a>00245             <span class="keywordtype">float</span> value= 1.0f, *cp=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00246"></a>00246             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00247"></a>00247             
<a name="l00248"></a>00248             <span class="comment">/* for each coefficient pair, solve for that bracket before accumulating in value by multiplying */</span>
<a name="l00249"></a>00249             <span class="keywordflow">for</span> (cp=data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#aee6e820aad268412ab96a6f94e7bedf2">coefficients</a>, i=0; (cp) &amp;&amp; (i &lt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>); cp+=2, i++) 
<a name="l00250"></a>00250                 value *= (cp[0]*evaltime + cp[1]);
<a name="l00251"></a>00251                 
<a name="l00252"></a>00252             <span class="comment">/* only if something changed, write *cvalue in one go */</span>
<a name="l00253"></a>00253             <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ad9a69e44503cd478130a88b6a52c45b0">poly_order</a>) {
<a name="l00254"></a>00254                 <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ac1b0aa418d935b68a8d116e9dc455b50">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>)
<a name="l00255"></a>00255                     *cvalue += value;
<a name="l00256"></a>00256                 <span class="keywordflow">else</span>
<a name="l00257"></a>00257                     *cvalue= value;
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260             <span class="keywordflow">break</span>;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a5346f18ecefe41ddad7867c4f3b00ad4">00264</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#a5346f18ecefe41ddad7867c4f3b00ad4">FMI_GENERATOR</a> = {
<a name="l00265"></a>00265     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba57fb312e27b01da48bd9a5eabb7bd506">FMODIFIER_TYPE_GENERATOR</a>, <span class="comment">/* type */</span>
<a name="l00266"></a>00266     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a154c42ff107283284d386c436de30af5">FMod_Generator</a>), <span class="comment">/* size */</span>
<a name="l00267"></a>00267     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>, <span class="comment">/* action type */</span>
<a name="l00268"></a>00268     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4a29050c04754f870845a05515bec6424f">FMI_REQUIRES_NOTHING</a>, <span class="comment">/* requirements */</span>
<a name="l00269"></a>00269     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Generator&quot;</span>), <span class="comment">/* name */</span>
<a name="l00270"></a>00270     <span class="stringliteral">&quot;FMod_Generator&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00271"></a>00271     <a class="code" href="../../d5/dba/fmodifier_8c.html#aae4280db731fa8f6907718d7637f402f">fcm_generator_free</a>, <span class="comment">/* free data */</span>
<a name="l00272"></a>00272     <a class="code" href="../../d5/dba/fmodifier_8c.html#aea680e68967e8d643f3793f259a69e54">fcm_generator_copy</a>, <span class="comment">/* copy data */</span>
<a name="l00273"></a>00273     <a class="code" href="../../d5/dba/fmodifier_8c.html#aa9de7718fedcc1f65dfbc55689a5f9c9">fcm_generator_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00274"></a>00274     <a class="code" href="../../d5/dba/fmodifier_8c.html#ad7e0b649260825498ac60d9b7d5e6eea">fcm_generator_verify</a>, <span class="comment">/* verify */</span>
<a name="l00275"></a>00275     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* evaluate time */</span>
<a name="l00276"></a>00276     <a class="code" href="../../d5/dba/fmodifier_8c.html#a598dc8577e1278e4a6fb48832c101749">fcm_generator_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00277"></a>00277 };
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="comment">/* Built-In Function Generator F-Curve Modifier --------------------------- */</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">/* This uses the general equation for equations:</span>
<a name="l00282"></a>00282 <span class="comment"> *      y = amplitude * fn(phase_multiplier*x + phase_offset) + y_offset</span>
<a name="l00283"></a>00283 <span class="comment"> *</span>
<a name="l00284"></a>00284 <span class="comment"> * where amplitude, phase_multiplier/offset, y_offset are user-defined coefficients,</span>
<a name="l00285"></a>00285 <span class="comment"> * x is the evaluation &#39;time&#39;, and &#39;y&#39; is the resultant value</span>
<a name="l00286"></a>00286 <span class="comment"> *</span>
<a name="l00287"></a>00287 <span class="comment"> * Functions available are</span>
<a name="l00288"></a>00288 <span class="comment"> *  sin, cos, tan, sinc (normalised sin), natural log, square root </span>
<a name="l00289"></a>00289 <span class="comment"> */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a36759bcc3cd600c08cb689d9e0ae1e61">00291</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a36759bcc3cd600c08cb689d9e0ae1e61">fcm_fn_generator_new_data</a> (<span class="keywordtype">void</span> *mdata)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293     <a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *)mdata;
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     <span class="comment">/* set amplitude and phase multiplier to 1.0f so that something is generated */</span>
<a name="l00296"></a>00296     data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a415692ce4f152d0dbe4e68f4b73e58ce">amplitude</a>= 1.0f;
<a name="l00297"></a>00297     data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a006a0f6fb7093799850e0a45fbed5752">phase_multiplier</a>= 1.0f;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">/* Unary &#39;normalised sine&#39; function</span>
<a name="l00301"></a>00301 <span class="comment"> *  y = sin(PI + x) / (PI * x),</span>
<a name="l00302"></a>00302 <span class="comment"> * except for x = 0 when y = 1.</span>
<a name="l00303"></a>00303 <span class="comment"> */</span>
<a name="l00304"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a61c7a8307e5afc6c707720df4cfcdc17">00304</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a61c7a8307e5afc6c707720df4cfcdc17">sinc</a> (<span class="keywordtype">double</span> x)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(x) &lt; 0.0001)
<a name="l00307"></a>00307         <span class="keywordflow">return</span> 1.0;
<a name="l00308"></a>00308     <span class="keywordflow">else</span>
<a name="l00309"></a>00309         <span class="keywordflow">return</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * x) / (<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * x);
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a26963f1242acaeb3e5734a27a59d8104">00312</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a26963f1242acaeb3e5734a27a59d8104">fcm_fn_generator_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00315"></a>00315     <span class="keywordtype">double</span> arg= data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a006a0f6fb7093799850e0a45fbed5752">phase_multiplier</a>*evaltime + data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a59ecc8e65704929842a7aaa65c8f84ca">phase_offset</a>;
<a name="l00316"></a>00316     double (*fn)(<span class="keywordtype">double</span> v) = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00317"></a>00317     
<a name="l00318"></a>00318     <span class="comment">/* get function pointer to the func to use:</span>
<a name="l00319"></a>00319 <span class="comment">     * WARNING: must perform special argument validation hereto guard against crashes  </span>
<a name="l00320"></a>00320 <span class="comment">     */</span>
<a name="l00321"></a>00321     <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a05e8e5baea8ea00ac9670b76e6c07259">type</a>)
<a name="l00322"></a>00322     {
<a name="l00323"></a>00323         <span class="comment">/* simple ones */</span>           
<a name="l00324"></a>00324         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a59187d609ad1da84aa96269e28530512">FCM_GENERATOR_FN_SIN</a>: <span class="comment">/* sine wave */</span>
<a name="l00325"></a>00325             fn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>;
<a name="l00326"></a>00326             <span class="keywordflow">break</span>;
<a name="l00327"></a>00327         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a87afe901f17f2e191e3a822a19b7a3a1">FCM_GENERATOR_FN_COS</a>: <span class="comment">/* cosine wave */</span>
<a name="l00328"></a>00328             fn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>;
<a name="l00329"></a>00329             <span class="keywordflow">break</span>;
<a name="l00330"></a>00330         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a83d575ea54b3d78e9a6e14bf9fb3a06f">FCM_GENERATOR_FN_SINC</a>: <span class="comment">/* normalised sine wave */</span>
<a name="l00331"></a>00331             fn= <a class="code" href="../../d5/dba/fmodifier_8c.html#a61c7a8307e5afc6c707720df4cfcdc17">sinc</a>;
<a name="l00332"></a>00332             <span class="keywordflow">break</span>;
<a name="l00333"></a>00333             
<a name="l00334"></a>00334         <span class="comment">/* validation required */</span>
<a name="l00335"></a>00335         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a8f71dc3e98a493d5380b9f701d5ce3b7">FCM_GENERATOR_FN_TAN</a>: <span class="comment">/* tangent wave */</span>
<a name="l00336"></a>00336         {
<a name="l00337"></a>00337             <span class="comment">/* check that argument is not on one of the discontinuities (i.e. 90deg, 270 deg, etc) */</span>
<a name="l00338"></a>00338             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa35a6894bca38a8ffb558c2c22a1eee1">IS_EQ</a>(fmod((arg - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>), <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>), 0.0)) {
<a name="l00339"></a>00339                 <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a6f19bb34b73d31bd11db6c3bc1826283">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>) == 0)
<a name="l00340"></a>00340                     *cvalue = 0.0f; <span class="comment">/* no value possible here */</span>
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342             <span class="keywordflow">else</span>
<a name="l00343"></a>00343                 fn= <a class="code" href="../../d0/dbc/namespaceKDL.html#a4c38a2bd6500e4df8a3312309a56fa6d">tan</a>;
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345             <span class="keywordflow">break</span>;
<a name="l00346"></a>00346         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a432087ce67e91d88eb1fcb6ffa82457a">FCM_GENERATOR_FN_LN</a>: <span class="comment">/* natural log */</span>
<a name="l00347"></a>00347         {
<a name="l00348"></a>00348             <span class="comment">/* check that value is greater than 1? */</span>
<a name="l00349"></a>00349             <span class="keywordflow">if</span> (arg &gt; 1.0) {
<a name="l00350"></a>00350                 fn= <a class="code" href="../../d1/d22/stdosl_8h.html#a652ed6fadc80671ca500c85d11bce898">log</a>;
<a name="l00351"></a>00351             }
<a name="l00352"></a>00352             <span class="keywordflow">else</span> {
<a name="l00353"></a>00353                 <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a6f19bb34b73d31bd11db6c3bc1826283">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>) == 0)
<a name="l00354"></a>00354                     *cvalue = 0.0f; <span class="comment">/* no value possible here */</span>
<a name="l00355"></a>00355             }
<a name="l00356"></a>00356         }
<a name="l00357"></a>00357             <span class="keywordflow">break</span>;
<a name="l00358"></a>00358         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#af92f7a7f52296e9820d4d387be747a35a7ff122d52ec25fd578e28ba47434a3d6">FCM_GENERATOR_FN_SQRT</a>: <span class="comment">/* square root */</span>
<a name="l00359"></a>00359         {
<a name="l00360"></a>00360             <span class="comment">/* no negative numbers */</span>
<a name="l00361"></a>00361             <span class="keywordflow">if</span> (arg &gt; 0.0) {
<a name="l00362"></a>00362                 fn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>;
<a name="l00363"></a>00363             }
<a name="l00364"></a>00364             <span class="keywordflow">else</span> {
<a name="l00365"></a>00365                 <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a6f19bb34b73d31bd11db6c3bc1826283">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>) == 0)
<a name="l00366"></a>00366                     *cvalue = 0.0f; <span class="comment">/* no value possible here */</span>
<a name="l00367"></a>00367             }
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369             <span class="keywordflow">break</span>;
<a name="l00370"></a>00370         
<a name="l00371"></a>00371         <span class="keywordflow">default</span>:
<a name="l00372"></a>00372             printf(<span class="stringliteral">&quot;Invalid Function-Generator for F-Modifier - %d\n&quot;</span>, data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a05e8e5baea8ea00ac9670b76e6c07259">type</a>);
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374     
<a name="l00375"></a>00375     <span class="comment">/* execute function callback to set value if appropriate */</span>
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (fn) {
<a name="l00377"></a>00377         <span class="keywordtype">float</span> value= (float)(data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a415692ce4f152d0dbe4e68f4b73e58ce">amplitude</a>*(<span class="keywordtype">float</span>)fn(arg) + data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#acb7ba21c9dac6311acff9a2c04313f7e">value_offset</a>);
<a name="l00378"></a>00378         
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a6f19bb34b73d31bd11db6c3bc1826283">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>)
<a name="l00380"></a>00380             *cvalue += value;
<a name="l00381"></a>00381         <span class="keywordflow">else</span>
<a name="l00382"></a>00382             *cvalue= value;
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#af304ebcbe4c21e48922a653de86616d6">00386</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#af304ebcbe4c21e48922a653de86616d6">FMI_FN_GENERATOR</a> = {
<a name="l00387"></a>00387     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba3f5c7902b0a8c0aafe94ab0835a06c18">FMODIFIER_TYPE_FN_GENERATOR</a>, <span class="comment">/* type */</span>
<a name="l00388"></a>00388     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9635d8f4c5f51a744a7eac5ef2743dd2">FMod_FunctionGenerator</a>), <span class="comment">/* size */</span>
<a name="l00389"></a>00389     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>, <span class="comment">/* action type */</span>
<a name="l00390"></a>00390     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4a29050c04754f870845a05515bec6424f">FMI_REQUIRES_NOTHING</a>, <span class="comment">/* requirements */</span>
<a name="l00391"></a>00391     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Built-In Function&quot;</span>), <span class="comment">/* name */</span>
<a name="l00392"></a>00392     <span class="stringliteral">&quot;FMod_FunctionGenerator&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00393"></a>00393     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00394"></a>00394     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00395"></a>00395     <a class="code" href="../../d5/dba/fmodifier_8c.html#a36759bcc3cd600c08cb689d9e0ae1e61">fcm_fn_generator_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00396"></a>00396     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* verify */</span>
<a name="l00397"></a>00397     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* evaluate time */</span>
<a name="l00398"></a>00398     <a class="code" href="../../d5/dba/fmodifier_8c.html#a26963f1242acaeb3e5734a27a59d8104">fcm_fn_generator_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00399"></a>00399 };
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="comment">/* Envelope F-Curve Modifier --------------------------- */</span>
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ae09fb023d02cb02770d8d6e77faef6f3">00403</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ae09fb023d02cb02770d8d6e77faef6f3">fcm_envelope_free</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *env= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00406"></a>00406     
<a name="l00407"></a>00407     <span class="comment">/* free envelope data array */</span>
<a name="l00408"></a>00408     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a>)
<a name="l00409"></a>00409         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a>);
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a1b3aeb20be4a54cc11a4e60ba03fe093">00412</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a1b3aeb20be4a54cc11a4e60ba03fe093">fcm_envelope_copy</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *src)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *env= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00415"></a>00415     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *oenv= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)src-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00416"></a>00416     
<a name="l00417"></a>00417     <span class="comment">/* copy envelope data array */</span>
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (oenv-&gt;data)
<a name="l00419"></a>00419         env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(oenv-&gt;data);
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a1a0b05772099aee09be71b6ce8cd2c29">00422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a1a0b05772099aee09be71b6ce8cd2c29">fcm_envelope_new_data</a> (<span class="keywordtype">void</span> *mdata)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *env= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)mdata;
<a name="l00425"></a>00425     
<a name="l00426"></a>00426     <span class="comment">/* set default min/max ranges */</span>
<a name="l00427"></a>00427     env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#ae5826870132a1695127d514ef6d1ba89">min</a>= -1.0f;
<a name="l00428"></a>00428     env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a0e62fcb7be36904f87ba30625e0c2722">max</a>= 1.0f;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a3a97969cfaf0ce2498e137c8622fcf1d">00431</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a3a97969cfaf0ce2498e137c8622fcf1d">fcm_envelope_verify</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *env= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     <span class="comment">/* if the are points, perform bubble-sort on them, as user may have changed the order */</span>
<a name="l00436"></a>00436     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a>) {
<a name="l00437"></a>00437         <span class="comment">// XXX todo...</span>
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#aa52f5b03076a46a832f9cce2f7fa9ccb">00441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#aa52f5b03076a46a832f9cce2f7fa9ccb">fcm_envelope_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     <a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *env= (<a class="code" href="../../d4/dac/structFMod__Envelope.html">FMod_Envelope</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00444"></a>00444     <a class="code" href="../../d0/d69/structFCM__EnvelopeData.html">FCM_EnvelopeData</a> *fed, *prevfed, *lastfed;
<a name="l00445"></a>00445     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>=0.0f, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>=0.0f, fac=0.0f;
<a name="l00446"></a>00446     <span class="keywordtype">int</span> a;
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     <span class="comment">/* get pointers */</span>
<a name="l00449"></a>00449     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00450"></a>00450     prevfed= env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a434be05786035884f0f7f78f80812e4e">data</a>;
<a name="l00451"></a>00451     fed= prevfed + 1;
<a name="l00452"></a>00452     lastfed= prevfed + (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a2330bccf366488cd9b7df52f3fc07156">totvert</a>-1);
<a name="l00453"></a>00453     
<a name="l00454"></a>00454     <span class="comment">/* get min/max values for envelope at evaluation time (relative to mid-value) */</span>
<a name="l00455"></a>00455     <span class="keywordflow">if</span> (prevfed-&gt;time &gt;= evaltime) {
<a name="l00456"></a>00456         <span class="comment">/* before or on first sample, so just extend value */</span>
<a name="l00457"></a>00457         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>= prevfed-&gt;min;
<a name="l00458"></a>00458         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= prevfed-&gt;max;
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastfed-&gt;time &lt;= evaltime) {
<a name="l00461"></a>00461         <span class="comment">/* after or on last sample, so just extend value */</span>
<a name="l00462"></a>00462         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>= lastfed-&gt;min;
<a name="l00463"></a>00463         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= lastfed-&gt;max;
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     <span class="keywordflow">else</span> {
<a name="l00466"></a>00466         <span class="comment">/* evaltime occurs somewhere between segments */</span>
<a name="l00467"></a>00467         <span class="comment">// TODO: implement binary search for this to make it faster?</span>
<a name="l00468"></a>00468         <span class="keywordflow">for</span> (a=0; prevfed &amp;&amp; fed &amp;&amp; (a &lt; env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a2330bccf366488cd9b7df52f3fc07156">totvert</a>-1); a++, prevfed=fed, fed++) {  
<a name="l00469"></a>00469             <span class="comment">/* evaltime occurs within the interval defined by these two envelope points */</span>
<a name="l00470"></a>00470             <span class="keywordflow">if</span> ((prevfed-&gt;time &lt;= evaltime) &amp;&amp; (fed-&gt;<a class="code" href="../../d0/d69/structFCM__EnvelopeData.html#af93ecb687b498ed94805d1165ac382a5">time</a> &gt;= evaltime)) {
<a name="l00471"></a>00471                 <span class="keywordtype">float</span> afac, bfac, <a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>;
<a name="l00472"></a>00472                 
<a name="l00473"></a>00473                 diff= fed-&gt;<a class="code" href="../../d0/d69/structFCM__EnvelopeData.html#af93ecb687b498ed94805d1165ac382a5">time</a> - prevfed-&gt;time;
<a name="l00474"></a>00474                 afac= (evaltime - prevfed-&gt;time) / diff;
<a name="l00475"></a>00475                 bfac= (fed-&gt;<a class="code" href="../../d0/d69/structFCM__EnvelopeData.html#af93ecb687b498ed94805d1165ac382a5">time</a> - evaltime) / diff;
<a name="l00476"></a>00476                 
<a name="l00477"></a>00477                 <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>= bfac*prevfed-&gt;min + afac*fed-&gt;<a class="code" href="../../d0/d69/structFCM__EnvelopeData.html#a4a582c3338d1880376ac74e60cce5915">min</a>;
<a name="l00478"></a>00478                 <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= bfac*prevfed-&gt;max + afac*fed-&gt;<a class="code" href="../../d0/d69/structFCM__EnvelopeData.html#a16255732e241ddb4c004bd72d831aa0c">max</a>;
<a name="l00479"></a>00479                 
<a name="l00480"></a>00480                 <span class="keywordflow">break</span>;
<a name="l00481"></a>00481             }
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     
<a name="l00485"></a>00485     <span class="comment">/* adjust *cvalue </span>
<a name="l00486"></a>00486 <span class="comment">     *  - fac is the ratio of how the current y-value corresponds to the reference range</span>
<a name="l00487"></a>00487 <span class="comment">     *  - thus, the new value is found by mapping the old range to the new!</span>
<a name="l00488"></a>00488 <span class="comment">     */</span>
<a name="l00489"></a>00489     fac= (*cvalue - (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a7a4c3ee8182696677e5f29899ea6ed56">midval</a> + env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#ae5826870132a1695127d514ef6d1ba89">min</a>)) / (env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#a0e62fcb7be36904f87ba30625e0c2722">max</a> - env-&gt;<a class="code" href="../../d4/dac/structFMod__Envelope.html#ae5826870132a1695127d514ef6d1ba89">min</a>);
<a name="l00490"></a>00490     *cvalue= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a> + fac*(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a> - <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>); 
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a1468d0e979620f6f3846d6ef091b74a9">00493</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#a1468d0e979620f6f3846d6ef091b74a9">FMI_ENVELOPE</a> = {
<a name="l00494"></a>00494     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba8375444b37911c90b1255246a0d274af">FMODIFIER_TYPE_ENVELOPE</a>, <span class="comment">/* type */</span>
<a name="l00495"></a>00495     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a032f500fbe2df55f784f81bf1c460fe9">FMod_Envelope</a>), <span class="comment">/* size */</span>
<a name="l00496"></a>00496     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7a2bb22f0e64c6cbaaaa3523532a39f885">FMI_TYPE_REPLACE_VALUES</a>, <span class="comment">/* action type */</span>
<a name="l00497"></a>00497     0, <span class="comment">/* requirements */</span>
<a name="l00498"></a>00498     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Envelope&quot;</span>), <span class="comment">/* name */</span>
<a name="l00499"></a>00499     <span class="stringliteral">&quot;FMod_Envelope&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00500"></a>00500     <a class="code" href="../../d5/dba/fmodifier_8c.html#ae09fb023d02cb02770d8d6e77faef6f3">fcm_envelope_free</a>, <span class="comment">/* free data */</span>
<a name="l00501"></a>00501     <a class="code" href="../../d5/dba/fmodifier_8c.html#a1b3aeb20be4a54cc11a4e60ba03fe093">fcm_envelope_copy</a>, <span class="comment">/* copy data */</span>
<a name="l00502"></a>00502     <a class="code" href="../../d5/dba/fmodifier_8c.html#a1a0b05772099aee09be71b6ce8cd2c29">fcm_envelope_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00503"></a>00503     <a class="code" href="../../d5/dba/fmodifier_8c.html#a3a97969cfaf0ce2498e137c8622fcf1d">fcm_envelope_verify</a>, <span class="comment">/* verify */</span>
<a name="l00504"></a>00504     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* evaluate time */</span>
<a name="l00505"></a>00505     <a class="code" href="../../d5/dba/fmodifier_8c.html#aa52f5b03076a46a832f9cce2f7fa9ccb">fcm_envelope_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00506"></a>00506 };
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="comment">/* Cycles F-Curve Modifier  --------------------------- */</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 <span class="comment">/* This modifier changes evaltime to something that exists within the curve&#39;s frame-range, </span>
<a name="l00511"></a>00511 <span class="comment"> * then re-evaluates modifier stack up to this point using the new time. This re-entrant behavior</span>
<a name="l00512"></a>00512 <span class="comment"> * is very likely to be more time-consuming than the original approach... (which was tightly integrated into</span>
<a name="l00513"></a>00513 <span class="comment"> * the calculation code...).</span>
<a name="l00514"></a>00514 <span class="comment"> *</span>
<a name="l00515"></a>00515 <span class="comment"> * NOTE: this needs to be at the start of the stack to be of use, as it needs to know the extents of the</span>
<a name="l00516"></a>00516 <span class="comment"> * keyframes/sample-data.</span>
<a name="l00517"></a>00517 <span class="comment"> *</span>
<a name="l00518"></a>00518 <span class="comment"> * Possible TODO - store length of cycle information that can be initialized from the extents of the</span>
<a name="l00519"></a>00519 <span class="comment"> * keyframes/sample-data, and adjusted as appropriate.</span>
<a name="l00520"></a>00520 <span class="comment"> */</span>
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="comment">/* temp data used during evaluation */</span>
<a name="l00523"></a><a class="code" href="../../d9/df2/structtFCMED__Cycles.html">00523</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/df2/structtFCMED__Cycles.html">tFCMED_Cycles</a> {
<a name="l00524"></a><a class="code" href="../../d9/df2/structtFCMED__Cycles.html#a2ea894086fd1c5efb032677585552aee">00524</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/df2/structtFCMED__Cycles.html#a2ea894086fd1c5efb032677585552aee">cycyofs</a>;      <span class="comment">/* y-offset to apply */</span>
<a name="l00525"></a>00525 } <a class="code" href="../../d5/dba/fmodifier_8c.html#a5775933e9e93a3547e1ba94c54f01e1b">tFCMED_Cycles</a>;
<a name="l00526"></a>00526  
<a name="l00527"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a2192bfa2af33c180780844e8a51c4cac">00527</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a2192bfa2af33c180780844e8a51c4cac">fcm_cycles_new_data</a> (<span class="keywordtype">void</span> *mdata)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <a class="code" href="../../dd/d22/structFMod__Cycles.html">FMod_Cycles</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../dd/d22/structFMod__Cycles.html">FMod_Cycles</a> *)mdata;
<a name="l00530"></a>00530     
<a name="l00531"></a>00531     <span class="comment">/* turn on cycles by default */</span>
<a name="l00532"></a>00532     data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#ada5730de9fe6c18ebb62ffb9da000a7a">before_mode</a>= data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#a788ff5f906ec71a8d7b5f7655d5adb7d">after_mode</a>= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1be224f5cf919cb3c9dabfc9222d71c1a72033c604fd1de12557519f70ae9eee3">FCM_EXTRAPOLATE_CYCLIC</a>;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ab531246b1ba36cf5550dd8fa7e245f6d">00535</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ab531246b1ba36cf5550dd8fa7e245f6d">fcm_cycles_time</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cvalue), <span class="keywordtype">float</span> evaltime)
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     <a class="code" href="../../dd/d22/structFMod__Cycles.html">FMod_Cycles</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../dd/d22/structFMod__Cycles.html">FMod_Cycles</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00538"></a>00538     <span class="keywordtype">float</span> prevkey[2], lastkey[2], cycyofs=0.0f;
<a name="l00539"></a>00539     <span class="keywordtype">short</span> side=0, mode=0;
<a name="l00540"></a>00540     <span class="keywordtype">int</span> cycles=0, ofs=0;
<a name="l00541"></a>00541     
<a name="l00542"></a>00542     <span class="comment">/* check if modifier is first in stack, otherwise disable ourself... */</span>
<a name="l00543"></a>00543     <span class="comment">// FIXME...</span>
<a name="l00544"></a>00544     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#aff8bd6357c375b26fd5537e6c20cdda0">prev</a>) {
<a name="l00545"></a>00545         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2bac65e1acd5607743a689fc1ddb90b97e9">FMODIFIER_FLAG_DISABLED</a>;
<a name="l00546"></a>00546         <span class="keywordflow">return</span> evaltime;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     
<a name="l00549"></a>00549     <span class="comment">/* calculate new evaltime due to cyclic interpolation */</span>
<a name="l00550"></a>00550     <span class="keywordflow">if</span> (fcu &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00551"></a>00551         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *prevbezt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>;
<a name="l00552"></a>00552         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *lastbezt= prevbezt + fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1;
<a name="l00553"></a>00553         
<a name="l00554"></a>00554         prevkey[0]= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00555"></a>00555         prevkey[1]= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00556"></a>00556         
<a name="l00557"></a>00557         lastkey[0]= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00558"></a>00558         lastkey[1]= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fcu &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) {
<a name="l00561"></a>00561         <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *prevfpt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>;
<a name="l00562"></a>00562         <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *lastfpt= prevfpt + fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1;
<a name="l00563"></a>00563         
<a name="l00564"></a>00564         prevkey[0]= prevfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0];
<a name="l00565"></a>00565         prevkey[1]= prevfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l00566"></a>00566         
<a name="l00567"></a>00567         lastkey[0]= lastfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0];
<a name="l00568"></a>00568         lastkey[1]= lastfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     <span class="keywordflow">else</span>
<a name="l00571"></a>00571         <span class="keywordflow">return</span> evaltime;
<a name="l00572"></a>00572         
<a name="l00573"></a>00573     <span class="comment">/* check if modifier will do anything</span>
<a name="l00574"></a>00574 <span class="comment">     *  1) if in data range, definitely don&#39;t do anything</span>
<a name="l00575"></a>00575 <span class="comment">     *  2) if before first frame or after last frame, make sure some cycling is in use</span>
<a name="l00576"></a>00576 <span class="comment">     */</span>
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (evaltime &lt; prevkey[0]) {
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#ada5730de9fe6c18ebb62ffb9da000a7a">before_mode</a>) {
<a name="l00579"></a>00579             side= -1;
<a name="l00580"></a>00580             mode= data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#ada5730de9fe6c18ebb62ffb9da000a7a">before_mode</a>;
<a name="l00581"></a>00581             cycles= data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#a2c3f33783f01d71b3c8d4e4cfef49870">before_cycles</a>;
<a name="l00582"></a>00582             ofs= prevkey[0];
<a name="l00583"></a>00583         }
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (evaltime &gt; lastkey[0]) {
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#a788ff5f906ec71a8d7b5f7655d5adb7d">after_mode</a>) {
<a name="l00587"></a>00587             side= 1;
<a name="l00588"></a>00588             mode= data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#a788ff5f906ec71a8d7b5f7655d5adb7d">after_mode</a>;
<a name="l00589"></a>00589             cycles= data-&gt;<a class="code" href="../../dd/d22/structFMod__Cycles.html#aee4416ef89fe0f4728d8ccd7cf2daae2">after_cycles</a>;
<a name="l00590"></a>00590             ofs= lastkey[0];
<a name="l00591"></a>00591         }
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593     <span class="keywordflow">if</span> ((<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(0, side, mode)))
<a name="l00594"></a>00594         <span class="keywordflow">return</span> evaltime;
<a name="l00595"></a>00595         
<a name="l00596"></a>00596     <span class="comment">/* find relative place within a cycle */</span>
<a name="l00597"></a>00597     {
<a name="l00598"></a>00598         <span class="keywordtype">float</span> cycdx=0, cycdy=0;
<a name="l00599"></a>00599         <span class="keywordtype">float</span> cycle= 0, cyct=0;
<a name="l00600"></a>00600         
<a name="l00601"></a>00601         <span class="comment">/* calculate period and amplitude (total height) of a cycle */</span>
<a name="l00602"></a>00602         cycdx= lastkey[0] - prevkey[0];
<a name="l00603"></a>00603         cycdy= lastkey[1] - prevkey[1];
<a name="l00604"></a>00604         
<a name="l00605"></a>00605         <span class="comment">/* check if cycle is infinitely small, to be point of being impossible to use */</span>
<a name="l00606"></a>00606         <span class="keywordflow">if</span> (cycdx == 0)
<a name="l00607"></a>00607             <span class="keywordflow">return</span> evaltime;
<a name="l00608"></a>00608             
<a name="l00609"></a>00609         <span class="comment">/* calculate the &#39;number&#39; of the cycle */</span>
<a name="l00610"></a>00610         cycle= ((float)side * (evaltime - ofs) / cycdx);
<a name="l00611"></a>00611         
<a name="l00612"></a>00612         <span class="comment">/* calculate the time inside the cycle */</span>
<a name="l00613"></a>00613         cyct= fmod(evaltime - ofs, cycdx);
<a name="l00614"></a>00614         
<a name="l00615"></a>00615         <span class="comment">/* check that cyclic is still enabled for the specified time */</span>
<a name="l00616"></a>00616         <span class="keywordflow">if</span> (cycles == 0) {
<a name="l00617"></a>00617             <span class="comment">/* catch this case so that we don&#39;t exit when we have cycles=0</span>
<a name="l00618"></a>00618 <span class="comment">             * as this indicates infinite cycles...</span>
<a name="l00619"></a>00619 <span class="comment">             */</span>
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cycle &gt; cycles) {
<a name="l00622"></a>00622             <span class="comment">/* we are too far away from range to evaluate</span>
<a name="l00623"></a>00623 <span class="comment">             * TODO: but we should still hold last value... </span>
<a name="l00624"></a>00624 <span class="comment">             */</span>
<a name="l00625"></a>00625             <span class="keywordflow">return</span> evaltime;
<a name="l00626"></a>00626         }
<a name="l00627"></a>00627         
<a name="l00628"></a>00628         <span class="comment">/* check if &#39;cyclic extrapolation&#39;, and thus calculate y-offset for this cycle */</span>
<a name="l00629"></a>00629         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1be224f5cf919cb3c9dabfc9222d71c1aabf9e27d66329a785d994e215b28d169">FCM_EXTRAPOLATE_CYCLIC_OFFSET</a>) {
<a name="l00630"></a>00630             <span class="keywordflow">if</span> (side &lt; 0)
<a name="l00631"></a>00631                 cycyofs = (float)floor((evaltime - ofs) / cycdx);
<a name="l00632"></a>00632             <span class="keywordflow">else</span>
<a name="l00633"></a>00633                 cycyofs = (float)ceil((evaltime - ofs) / cycdx);
<a name="l00634"></a>00634             cycyofs *= cycdy;
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636         
<a name="l00637"></a>00637         <span class="comment">/* special case for cycle start/end */</span>
<a name="l00638"></a>00638         <span class="keywordflow">if</span> (cyct == 0.0f) {
<a name="l00639"></a>00639             evaltime = (side == 1 ? lastkey[0] : prevkey[0]);
<a name="l00640"></a>00640             
<a name="l00641"></a>00641             <span class="keywordflow">if</span> ((mode == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1be224f5cf919cb3c9dabfc9222d71c1a062e660ae71c695b0ee079b4dca415c3">FCM_EXTRAPOLATE_MIRROR</a>) &amp;&amp; ((int)cycle % 2))
<a name="l00642"></a>00642                 evaltime = (side == 1 ? prevkey[0] : lastkey[0]);
<a name="l00643"></a>00643         }
<a name="l00644"></a>00644         <span class="comment">/* calculate where in the cycle we are (overwrite evaltime to reflect this) */</span>
<a name="l00645"></a>00645         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((mode == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1be224f5cf919cb3c9dabfc9222d71c1a062e660ae71c695b0ee079b4dca415c3">FCM_EXTRAPOLATE_MIRROR</a>) &amp;&amp; ((int)(cycle+1) % 2)) {
<a name="l00646"></a>00646             <span class="comment">/* when &#39;mirror&#39; option is used and cycle number is odd, this cycle is played in reverse </span>
<a name="l00647"></a>00647 <span class="comment">             *  - for &#39;before&#39; extrapolation, we need to flip in a different way, otherwise values past</span>
<a name="l00648"></a>00648 <span class="comment">             *    then end of the curve get referenced (result of fmod will be negative, and with different phase)</span>
<a name="l00649"></a>00649 <span class="comment">             */</span>
<a name="l00650"></a>00650             <span class="keywordflow">if</span> (side &lt; 0)
<a name="l00651"></a>00651                 evaltime= prevkey[0] - cyct;
<a name="l00652"></a>00652             <span class="keywordflow">else</span>
<a name="l00653"></a>00653                 evaltime= lastkey[0] - cyct;
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655         <span class="keywordflow">else</span> {
<a name="l00656"></a>00656             <span class="comment">/* the cycle is played normally... */</span>
<a name="l00657"></a>00657             evaltime= prevkey[0] + cyct;
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (evaltime &lt; prevkey[0]) evaltime += cycdx;
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661     
<a name="l00662"></a>00662     <span class="comment">/* store temp data if needed */</span>
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1be224f5cf919cb3c9dabfc9222d71c1aabf9e27d66329a785d994e215b28d169">FCM_EXTRAPOLATE_CYCLIC_OFFSET</a>) {
<a name="l00664"></a>00664         <a class="code" href="../../d9/df2/structtFCMED__Cycles.html">tFCMED_Cycles</a> *edata;
<a name="l00665"></a>00665         
<a name="l00666"></a>00666         <span class="comment">/* for now, this is just a float, but we could get more stuff... */</span>
<a name="l00667"></a>00667         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a9a878718dc71ea858cc6c5c2417a2883">edata</a>= edata= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/df2/structtFCMED__Cycles.html">tFCMED_Cycles</a>), <span class="stringliteral">&quot;tFCMED_Cycles&quot;</span>);
<a name="l00668"></a>00668         edata-&gt;<a class="code" href="../../d9/df2/structtFCMED__Cycles.html#a2ea894086fd1c5efb032677585552aee">cycyofs</a>= cycyofs;
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670     
<a name="l00671"></a>00671     <span class="comment">/* return the new frame to evaluate */</span>
<a name="l00672"></a>00672     <span class="keywordflow">return</span> evaltime;
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674  
<a name="l00675"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a0d2a3dd33761557bec83ae70751b858a">00675</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a0d2a3dd33761557bec83ae70751b858a">fcm_cycles_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(evaltime))
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677     <a class="code" href="../../d9/df2/structtFCMED__Cycles.html">tFCMED_Cycles</a> *edata= (<a class="code" href="../../d9/df2/structtFCMED__Cycles.html">tFCMED_Cycles</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a9a878718dc71ea858cc6c5c2417a2883">edata</a>;
<a name="l00678"></a>00678     
<a name="l00679"></a>00679     <span class="comment">/* use temp data */</span>
<a name="l00680"></a>00680     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (edata) {
<a name="l00681"></a>00681         <span class="comment">/* add cyclic offset - no need to check for now, otherwise the data wouldn&#39;t exist! */</span>
<a name="l00682"></a>00682         *cvalue += edata-&gt;<a class="code" href="../../d9/df2/structtFCMED__Cycles.html#a2ea894086fd1c5efb032677585552aee">cycyofs</a>;
<a name="l00683"></a>00683         
<a name="l00684"></a>00684         <span class="comment">/* free temp data */</span>
<a name="l00685"></a>00685         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(edata);
<a name="l00686"></a>00686         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a9a878718dc71ea858cc6c5c2417a2883">edata</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a7621f5986df34f73226e4bd67d58efea">00690</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#a7621f5986df34f73226e4bd67d58efea">FMI_CYCLES</a> = {
<a name="l00691"></a>00691     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba0a9f871f719b71334e21fb78f83aa48d">FMODIFIER_TYPE_CYCLES</a>, <span class="comment">/* type */</span>
<a name="l00692"></a>00692     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a956adbb4aa965fe7c059ef5ab507394b">FMod_Cycles</a>), <span class="comment">/* size */</span>
<a name="l00693"></a>00693     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7a0bc3431a3d96afba04ddd0fc4919eed8">FMI_TYPE_EXTRAPOLATION</a>, <span class="comment">/* action type */</span>
<a name="l00694"></a>00694     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4ac0c25d40c63b56dc967e7e931fc5b5e9">FMI_REQUIRES_ORIGINAL_DATA</a>, <span class="comment">/* requirements */</span>
<a name="l00695"></a>00695     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Cycles&quot;</span>), <span class="comment">/* name */</span>
<a name="l00696"></a>00696     <span class="stringliteral">&quot;FMod_Cycles&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00697"></a>00697     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00698"></a>00698     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00699"></a>00699     <a class="code" href="../../d5/dba/fmodifier_8c.html#a2192bfa2af33c180780844e8a51c4cac">fcm_cycles_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00700"></a>00700     NULL <span class="comment">/*fcm_cycles_verify*/</span>, <span class="comment">/* verify */</span>
<a name="l00701"></a>00701     <a class="code" href="../../d5/dba/fmodifier_8c.html#ab531246b1ba36cf5550dd8fa7e245f6d">fcm_cycles_time</a>, <span class="comment">/* evaluate time */</span>
<a name="l00702"></a>00702     <a class="code" href="../../d5/dba/fmodifier_8c.html#a0d2a3dd33761557bec83ae70751b858a">fcm_cycles_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00703"></a>00703 };
<a name="l00704"></a>00704 
<a name="l00705"></a>00705 <span class="comment">/* Noise F-Curve Modifier  --------------------------- */</span>
<a name="l00706"></a>00706 
<a name="l00707"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a6f04f1b839768feaf3c3eba9f4fa371e">00707</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a6f04f1b839768feaf3c3eba9f4fa371e">fcm_noise_new_data</a> (<span class="keywordtype">void</span> *mdata)
<a name="l00708"></a>00708 {
<a name="l00709"></a>00709     <a class="code" href="../../d4/dee/structFMod__Noise.html">FMod_Noise</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d4/dee/structFMod__Noise.html">FMod_Noise</a> *)mdata;
<a name="l00710"></a>00710     
<a name="l00711"></a>00711     <span class="comment">/* defaults */</span>
<a name="l00712"></a>00712     data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a9658d3755e8734f39df784efabab4b34">size</a>= 1.0f;
<a name="l00713"></a>00713     data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#aad2b13644a1dc1a8ecbf3cff55eaed1e">strength</a>= 1.0f;
<a name="l00714"></a>00714     data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a6d39ba5775ee95599bf55fd5b07ad745">phase</a>= 1.0f;
<a name="l00715"></a>00715     data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a79ea3bac103beec89b7962765b8d81d3">depth</a> = 0;
<a name="l00716"></a>00716     data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a98c6c779fa608d568de1a185482528fe">modification</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5f2b5f5c14453c07f77eed479f469deea03fad893719c0bb4f1ce5cecfb650d04">FCM_NOISE_MODIF_REPLACE</a>;
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718  
<a name="l00719"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ad4934c011ca53ae70a3134fa1cc3f6ab">00719</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ad4934c011ca53ae70a3134fa1cc3f6ab">fcm_noise_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721     <a class="code" href="../../d4/dee/structFMod__Noise.html">FMod_Noise</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d4/dee/structFMod__Noise.html">FMod_Noise</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00722"></a>00722     <span class="keywordtype">float</span> <a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a>;
<a name="l00723"></a>00723     
<a name="l00724"></a>00724     <span class="comment">/* generate noise using good ol&#39; Blender Noise</span>
<a name="l00725"></a>00725 <span class="comment">     *  - 0.1 is passed as the &#39;z&#39; value, otherwise evaluation fails for size = phase = 1</span>
<a name="l00726"></a>00726 <span class="comment">     *    with evaltime being an integer (which happens when evaluating on frame by frame basis)</span>
<a name="l00727"></a>00727 <span class="comment">     */</span>
<a name="l00728"></a>00728     <a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a> = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a76981b7f143d0b07ed83aeae3d1e945e">BLI_turbulence</a>(data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a9658d3755e8734f39df784efabab4b34">size</a>, evaltime, data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a6d39ba5775ee95599bf55fd5b07ad745">phase</a>, 0.1f, data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a79ea3bac103beec89b7962765b8d81d3">depth</a>);
<a name="l00729"></a>00729     
<a name="l00730"></a>00730     <span class="comment">/* combine the noise with existing motion data */</span>
<a name="l00731"></a>00731     <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#a98c6c779fa608d568de1a185482528fe">modification</a>) {
<a name="l00732"></a>00732         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5f2b5f5c14453c07f77eed479f469deeacb9c78b22f86abed80831ffd860e0a8f">FCM_NOISE_MODIF_ADD</a>:
<a name="l00733"></a>00733             *cvalue= *cvalue + <a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a> * data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#aad2b13644a1dc1a8ecbf3cff55eaed1e">strength</a>;
<a name="l00734"></a>00734             <span class="keywordflow">break</span>;
<a name="l00735"></a>00735         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5f2b5f5c14453c07f77eed479f469deea846843a9053ac0c4f08403c613f5680a">FCM_NOISE_MODIF_SUBTRACT</a>:
<a name="l00736"></a>00736             *cvalue= *cvalue - <a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a> * data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#aad2b13644a1dc1a8ecbf3cff55eaed1e">strength</a>;
<a name="l00737"></a>00737             <span class="keywordflow">break</span>;
<a name="l00738"></a>00738         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5f2b5f5c14453c07f77eed479f469deead7d473b1d829621d5d56d71955fa4591">FCM_NOISE_MODIF_MULTIPLY</a>:
<a name="l00739"></a>00739             *cvalue= *cvalue * <a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a> * data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#aad2b13644a1dc1a8ecbf3cff55eaed1e">strength</a>;
<a name="l00740"></a>00740             <span class="keywordflow">break</span>;
<a name="l00741"></a>00741         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5f2b5f5c14453c07f77eed479f469deea03fad893719c0bb4f1ce5cecfb650d04">FCM_NOISE_MODIF_REPLACE</a>:
<a name="l00742"></a>00742         <span class="keywordflow">default</span>:
<a name="l00743"></a>00743             *cvalue= *cvalue + (<a class="code" href="../../df/d5a/svm__noise_8h.html#a724d197b873275e680f6c3b468e3d2ef">noise</a> - 0.5f) * data-&gt;<a class="code" href="../../d4/dee/structFMod__Noise.html#aad2b13644a1dc1a8ecbf3cff55eaed1e">strength</a>;
<a name="l00744"></a>00744             <span class="keywordflow">break</span>;
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#aec7f7c97bc1b74572d3033eb14535486">00748</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#aec7f7c97bc1b74572d3033eb14535486">FMI_NOISE</a> = {
<a name="l00749"></a>00749     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba48f599ed4496ee02ee9a85d2c0df0044">FMODIFIER_TYPE_NOISE</a>, <span class="comment">/* type */</span>
<a name="l00750"></a>00750     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aaf294d3519630491e9112a89b7337f97">FMod_Noise</a>), <span class="comment">/* size */</span>
<a name="l00751"></a>00751     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7a2bb22f0e64c6cbaaaa3523532a39f885">FMI_TYPE_REPLACE_VALUES</a>, <span class="comment">/* action type */</span>
<a name="l00752"></a>00752     0, <span class="comment">/* requirements */</span>
<a name="l00753"></a>00753     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Noise&quot;</span>), <span class="comment">/* name */</span>
<a name="l00754"></a>00754     <span class="stringliteral">&quot;FMod_Noise&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00755"></a>00755     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00756"></a>00756     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00757"></a>00757     <a class="code" href="../../d5/dba/fmodifier_8c.html#a6f04f1b839768feaf3c3eba9f4fa371e">fcm_noise_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00758"></a>00758     NULL <span class="comment">/*fcm_noise_verify*/</span>, <span class="comment">/* verify */</span>
<a name="l00759"></a>00759     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* evaluate time */</span>
<a name="l00760"></a>00760     <a class="code" href="../../d5/dba/fmodifier_8c.html#ad4934c011ca53ae70a3134fa1cc3f6ab">fcm_noise_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00761"></a>00761 };
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="comment">/* Filter F-Curve Modifier --------------------------- */</span>
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 <span class="preprocessor">#if 0 // XXX not yet implemented </span>
<a name="l00766"></a>00766 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> FMI_FILTER = {
<a name="l00767"></a>00767     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba1fb0d9677a02c85f2d4a4ee2f7f1e366">FMODIFIER_TYPE_FILTER</a>, <span class="comment">/* type */</span>
<a name="l00768"></a>00768     <span class="keyword">sizeof</span>(FMod_Filter), <span class="comment">/* size */</span>
<a name="l00769"></a>00769     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7a2bb22f0e64c6cbaaaa3523532a39f885">FMI_TYPE_REPLACE_VALUES</a>, <span class="comment">/* action type */</span>
<a name="l00770"></a>00770     0, <span class="comment">/* requirements */</span>
<a name="l00771"></a>00771     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Filter&quot;</span>), <span class="comment">/* name */</span>
<a name="l00772"></a>00772     <span class="stringliteral">&quot;FMod_Filter&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00773"></a>00773     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00774"></a>00774     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00775"></a>00775     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* new data */</span>
<a name="l00776"></a>00776     NULL <span class="comment">/*fcm_filter_verify*/</span>, <span class="comment">/* verify */</span>
<a name="l00777"></a>00777     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* evlauate time */</span>
<a name="l00778"></a>00778     fcm_filter_evaluate <span class="comment">/* evaluate */</span>
<a name="l00779"></a>00779 };
<a name="l00780"></a>00780 <span class="preprocessor">#endif // XXX not yet implemented</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="comment">/* Python F-Curve Modifier --------------------------- */</span>
<a name="l00784"></a>00784 
<a name="l00785"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ae1b49ed0fbd60f6ea42f6069cc1b2c7e">00785</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ae1b49ed0fbd60f6ea42f6069cc1b2c7e">fcm_python_free</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787     <a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00788"></a>00788     
<a name="l00789"></a>00789     <span class="comment">/* id-properties */</span>
<a name="l00790"></a>00790     <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(data-&gt;<a class="code" href="../../d3/dcb/structFMod__Python.html#a740f4de69d5331dc614700920af3f767">prop</a>);
<a name="l00791"></a>00791     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data-&gt;<a class="code" href="../../d3/dcb/structFMod__Python.html#a740f4de69d5331dc614700920af3f767">prop</a>);
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a85df9c85efefed5d77d0877718ed9c74">00794</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a85df9c85efefed5d77d0877718ed9c74">fcm_python_new_data</a> (<span class="keywordtype">void</span> *mdata) 
<a name="l00795"></a>00795 {
<a name="l00796"></a>00796     <a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *)mdata;
<a name="l00797"></a>00797     
<a name="l00798"></a>00798     <span class="comment">/* everything should be set correctly by calloc, except for the prop-&gt;type constant.*/</span>
<a name="l00799"></a>00799     data-&gt;<a class="code" href="../../d3/dcb/structFMod__Python.html#a740f4de69d5331dc614700920af3f767">prop</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a>), <span class="stringliteral">&quot;PyFModifierProps&quot;</span>);
<a name="l00800"></a>00800     data-&gt;<a class="code" href="../../d3/dcb/structFMod__Python.html#a740f4de69d5331dc614700920af3f767">prop</a>-&gt;<a class="code" href="../../df/d42/structIDProperty.html#afc4e09dbab4908446252e5fcb1b3c5ae">type</a> = <a class="code" href="../../d3/dfb/DNA__ID_8h.html#abf4b8c1027c684282b432b3c8033a2de">IDP_GROUP</a>;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a8ce87d2677e0f5cc489ba0255cda6a12">00803</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a8ce87d2677e0f5cc489ba0255cda6a12">fcm_python_copy</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *src)
<a name="l00804"></a>00804 {
<a name="l00805"></a>00805     <a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *pymod = (<a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00806"></a>00806     <a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *opymod = (<a class="code" href="../../d3/dcb/structFMod__Python.html">FMod_Python</a> *)src-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00807"></a>00807     
<a name="l00808"></a>00808     pymod-&gt;<a class="code" href="../../d3/dcb/structFMod__Python.html#a740f4de69d5331dc614700920af3f767">prop</a> = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(opymod-&gt;prop);
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#adfb4e7faf051b6c5fa622f695a5bab58">00811</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#adfb4e7faf051b6c5fa622f695a5bab58">fcm_python_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcm), <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cvalue), <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(evaltime))
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l00814"></a>00814 <span class="preprocessor"></span>    <span class="comment">//FMod_Python *data= (FMod_Python *)fcm-&gt;data;</span>
<a name="l00815"></a>00815     
<a name="l00816"></a>00816     <span class="comment">/* FIXME... need to implement this modifier...</span>
<a name="l00817"></a>00817 <span class="comment">     *  It will need it execute a script using the custom properties </span>
<a name="l00818"></a>00818 <span class="comment">     */</span>
<a name="l00819"></a>00819 <span class="preprocessor">#endif </span><span class="comment">/* WITH_PYTHON */</span>
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a8f5d6a7724818aa6038790d478eddde6">00822</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#a8f5d6a7724818aa6038790d478eddde6">FMI_PYTHON</a> = {
<a name="l00823"></a>00823     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97baa6f502fa0bc4eaa22eea8ee09ab8df62">FMODIFIER_TYPE_PYTHON</a>, <span class="comment">/* type */</span>
<a name="l00824"></a>00824     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a2e63d950811621cb23ff76bcdb0325d3">FMod_Python</a>), <span class="comment">/* size */</span>
<a name="l00825"></a>00825     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>, <span class="comment">/* action type */</span>
<a name="l00826"></a>00826     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4ab751387674bdb789edfeb1cb5ec93467">FMI_REQUIRES_RUNTIME_CHECK</a>, <span class="comment">/* requirements */</span>
<a name="l00827"></a>00827     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Python&quot;</span>), <span class="comment">/* name */</span>
<a name="l00828"></a>00828     <span class="stringliteral">&quot;FMod_Python&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00829"></a>00829     <a class="code" href="../../d5/dba/fmodifier_8c.html#ae1b49ed0fbd60f6ea42f6069cc1b2c7e">fcm_python_free</a>, <span class="comment">/* free data */</span>
<a name="l00830"></a>00830     <a class="code" href="../../d5/dba/fmodifier_8c.html#a8ce87d2677e0f5cc489ba0255cda6a12">fcm_python_copy</a>, <span class="comment">/* copy data */</span>
<a name="l00831"></a>00831     <a class="code" href="../../d5/dba/fmodifier_8c.html#a85df9c85efefed5d77d0877718ed9c74">fcm_python_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00832"></a>00832     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> <span class="comment">/*fcm_python_verify*/</span>, <span class="comment">/* verify */</span>
<a name="l00833"></a>00833     NULL <span class="comment">/*fcm_python_time*/</span>, <span class="comment">/* evaluate time */</span>
<a name="l00834"></a>00834     <a class="code" href="../../d5/dba/fmodifier_8c.html#adfb4e7faf051b6c5fa622f695a5bab58">fcm_python_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00835"></a>00835 };
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 
<a name="l00838"></a>00838 <span class="comment">/* Limits F-Curve Modifier --------------------------- */</span>
<a name="l00839"></a>00839 
<a name="l00840"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a9ab7bc62715e050258152fd6c7c1179a">00840</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a9ab7bc62715e050258152fd6c7c1179a">fcm_limits_time</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cvalue), <span class="keywordtype">float</span> evaltime)
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842     <a class="code" href="../../d5/ded/structFMod__Limits.html">FMod_Limits</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d5/ded/structFMod__Limits.html">FMod_Limits</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00843"></a>00843     
<a name="l00844"></a>00844     <span class="comment">/* check for the time limits */</span>
<a name="l00845"></a>00845     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#ab602d00a406ac91c2910e9393d518ce5">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5ab65046abde0605e5a71b273b074f21a326163499454b9cedbfa9634aaebde6d">FCM_LIMIT_XMIN</a>) &amp;&amp; (evaltime &lt; data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>))
<a name="l00846"></a>00846         <span class="keywordflow">return</span> data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00847"></a>00847     <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#ab602d00a406ac91c2910e9393d518ce5">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5ab65046abde0605e5a71b273b074f21a8f46da71928b5ce9b8ba64d3f2d56b07">FCM_LIMIT_XMAX</a>) &amp;&amp; (evaltime &gt; data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>))
<a name="l00848"></a>00848         <span class="keywordflow">return</span> data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l00849"></a>00849         
<a name="l00850"></a>00850     <span class="comment">/* modifier doesn&#39;t change time */</span>
<a name="l00851"></a>00851     <span class="keywordflow">return</span> evaltime;
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#af259310d54974d96f8f7b4c357910a8e">00854</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#af259310d54974d96f8f7b4c357910a8e">fcm_limits_evaluate</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(evaltime))
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856     <a class="code" href="../../d5/ded/structFMod__Limits.html">FMod_Limits</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d5/ded/structFMod__Limits.html">FMod_Limits</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00857"></a>00857     
<a name="l00858"></a>00858     <span class="comment">/* value limits now */</span>
<a name="l00859"></a>00859     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#ab602d00a406ac91c2910e9393d518ce5">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5ab65046abde0605e5a71b273b074f21a9fb76ca9f715a5dfb13189b4294ce4d1">FCM_LIMIT_YMIN</a>) &amp;&amp; (*cvalue &lt; data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>))
<a name="l00860"></a>00860         *cvalue= data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00861"></a>00861     <span class="keywordflow">if</span> ((data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#ab602d00a406ac91c2910e9393d518ce5">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5ab65046abde0605e5a71b273b074f21a3d6772dbfd95ba623c3b6c074ef226ca">FCM_LIMIT_YMAX</a>) &amp;&amp; (*cvalue &gt; data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>))
<a name="l00862"></a>00862         *cvalue= data-&gt;<a class="code" href="../../d5/ded/structFMod__Limits.html#a8cad32595f2444e6c2572b925fdd29ba">rect</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l00863"></a>00863 }
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ac8e7511056e6060180b9bf0170001b8e">00865</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#ac8e7511056e6060180b9bf0170001b8e">FMI_LIMITS</a> = {
<a name="l00866"></a>00866     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97badd4d122b31ce0364a192262bb583130b">FMODIFIER_TYPE_LIMITS</a>, <span class="comment">/* type */</span>
<a name="l00867"></a>00867     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ae02cb4a97dfcaa1f416bfff674bbb739">FMod_Limits</a>), <span class="comment">/* size */</span>
<a name="l00868"></a>00868     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>, <span class="comment">/* action type */</span>  <span class="comment">/* XXX... err... */</span>   
<a name="l00869"></a>00869     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4ab751387674bdb789edfeb1cb5ec93467">FMI_REQUIRES_RUNTIME_CHECK</a>, <span class="comment">/* requirements */</span>
<a name="l00870"></a>00870     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Limits&quot;</span>), <span class="comment">/* name */</span>
<a name="l00871"></a>00871     <span class="stringliteral">&quot;FMod_Limits&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00872"></a>00872     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00873"></a>00873     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00874"></a>00874     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* new data */</span>
<a name="l00875"></a>00875     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* verify */</span>
<a name="l00876"></a>00876     <a class="code" href="../../d5/dba/fmodifier_8c.html#a9ab7bc62715e050258152fd6c7c1179a">fcm_limits_time</a>, <span class="comment">/* evaluate time */</span>
<a name="l00877"></a>00877     <a class="code" href="../../d5/dba/fmodifier_8c.html#af259310d54974d96f8f7b4c357910a8e">fcm_limits_evaluate</a> <span class="comment">/* evaluate */</span>
<a name="l00878"></a>00878 };
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="comment">/* Stepped F-Curve Modifier --------------------------- */</span>
<a name="l00881"></a>00881 
<a name="l00882"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a7d8a4aead1aaf4626e2de09dc0ce0c5b">00882</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a7d8a4aead1aaf4626e2de09dc0ce0c5b">fcm_stepped_new_data</a> (<span class="keywordtype">void</span> *mdata) 
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884     <a class="code" href="../../d2/db7/structFMod__Stepped.html">FMod_Stepped</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d2/db7/structFMod__Stepped.html">FMod_Stepped</a> *)mdata;
<a name="l00885"></a>00885     
<a name="l00886"></a>00886     <span class="comment">/* just need to set the step-size to 2-frames by default */</span>
<a name="l00887"></a>00887     <span class="comment">// XXX: or would 5 be more normal?</span>
<a name="l00888"></a>00888     data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#ab4d3d0e51c9f5e449366b13554a6f5d7">step_size</a> = 2.0f;
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00891"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a446ba1165555c87a934a393a3e0ecdb4">00891</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a446ba1165555c87a934a393a3e0ecdb4">fcm_stepped_time</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fcu), <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cvalue), <span class="keywordtype">float</span> evaltime)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893     <a class="code" href="../../d2/db7/structFMod__Stepped.html">FMod_Stepped</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= (<a class="code" href="../../d2/db7/structFMod__Stepped.html">FMod_Stepped</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00894"></a>00894     <span class="keywordtype">int</span> snapblock;
<a name="l00895"></a>00895     
<a name="l00896"></a>00896     <span class="comment">/* check range clamping to see if we should alter the timing to achieve the desired results */</span>
<a name="l00897"></a>00897     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#a41fd345f696022cefe324f4bef0a66b8">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a114674d81f73bf5d64298b54364707bfa5acfab86f9c3e5bbd65ad41d2d70128a">FCM_STEPPED_NO_BEFORE</a>) {
<a name="l00898"></a>00898         <span class="keywordflow">if</span> (evaltime &lt; data-&gt;start_frame)
<a name="l00899"></a>00899             <span class="keywordflow">return</span> evaltime;
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#a41fd345f696022cefe324f4bef0a66b8">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a114674d81f73bf5d64298b54364707bfa0760faa2dec126c5d89a9440db2e7a78">FCM_STEPPED_NO_AFTER</a>) {
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (evaltime &gt; data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#aa9f65feb0f2058c32d9195f5904dcf33">end_frame</a>)
<a name="l00903"></a>00903             <span class="keywordflow">return</span> evaltime;
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905     
<a name="l00906"></a>00906     <span class="comment">/* we snap to the start of the previous closest block of &#39;step_size&#39; frames </span>
<a name="l00907"></a>00907 <span class="comment">     * after the start offset has been discarded </span>
<a name="l00908"></a>00908 <span class="comment">     *  - i.e. round down</span>
<a name="l00909"></a>00909 <span class="comment">     */</span>
<a name="l00910"></a>00910     snapblock = (int)((evaltime - data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#a5f352537a71fa7e9e7dcfc9bc19b9efc">offset</a>) / data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#ab4d3d0e51c9f5e449366b13554a6f5d7">step_size</a>);
<a name="l00911"></a>00911     
<a name="l00912"></a>00912     <span class="comment">/* reapply the offset, and multiple the snapblock by the size of the steps to get </span>
<a name="l00913"></a>00913 <span class="comment">     * the new time to evaluate at </span>
<a name="l00914"></a>00914 <span class="comment">     */</span>
<a name="l00915"></a>00915     <span class="keywordflow">return</span> ((<span class="keywordtype">float</span>)snapblock * data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#ab4d3d0e51c9f5e449366b13554a6f5d7">step_size</a>) + data-&gt;<a class="code" href="../../d2/db7/structFMod__Stepped.html#a5f352537a71fa7e9e7dcfc9bc19b9efc">offset</a>;
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 
<a name="l00918"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a4edac759131bff836d2e1a302a315800">00918</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> <a class="code" href="../../d5/dba/fmodifier_8c.html#a4edac759131bff836d2e1a302a315800">FMI_STEPPED</a> = {
<a name="l00919"></a>00919     <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba314c542c16a384de8c395fd2ae1d003b">FMODIFIER_TYPE_STEPPED</a>, <span class="comment">/* type */</span>
<a name="l00920"></a>00920     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ae02cb4a97dfcaa1f416bfff674bbb739">FMod_Limits</a>), <span class="comment">/* size */</span>
<a name="l00921"></a>00921     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>, <span class="comment">/* action type */</span>  <span class="comment">/* XXX... err... */</span>   
<a name="l00922"></a>00922     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa31b5d487eb7cae1c954a49e3a284cb4ab751387674bdb789edfeb1cb5ec93467">FMI_REQUIRES_RUNTIME_CHECK</a>, <span class="comment">/* requirements */</span>
<a name="l00923"></a>00923     <a class="code" href="../../d6/d61/BLF__translation_8h.html#abdf0847bd8caa2c2247f5d9bc5e12982">N_</a>(<span class="stringliteral">&quot;Stepped&quot;</span>), <span class="comment">/* name */</span>
<a name="l00924"></a>00924     <span class="stringliteral">&quot;FMod_Stepped&quot;</span>, <span class="comment">/* struct name */</span>
<a name="l00925"></a>00925     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* free data */</span>
<a name="l00926"></a>00926     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* copy data */</span>
<a name="l00927"></a>00927     <a class="code" href="../../d5/dba/fmodifier_8c.html#a7d8a4aead1aaf4626e2de09dc0ce0c5b">fcm_stepped_new_data</a>, <span class="comment">/* new data */</span>
<a name="l00928"></a>00928     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="comment">/* verify */</span>
<a name="l00929"></a>00929     <a class="code" href="../../d5/dba/fmodifier_8c.html#a446ba1165555c87a934a393a3e0ecdb4">fcm_stepped_time</a>, <span class="comment">/* evaluate time */</span>
<a name="l00930"></a>00930     NULL <span class="comment">/* evaluate */</span>
<a name="l00931"></a>00931 };
<a name="l00932"></a>00932 
<a name="l00933"></a>00933 <span class="comment">/* F-Curve Modifier API --------------------------- */</span>
<a name="l00934"></a>00934 <span class="comment">/* All of the F-Curve Modifier api functions use FModifierTypeInfo structs to carry out</span>
<a name="l00935"></a>00935 <span class="comment"> * and operations that involve F-Curve modifier specific code.</span>
<a name="l00936"></a>00936 <span class="comment"> */</span>
<a name="l00937"></a>00937 
<a name="l00938"></a>00938 <span class="comment">/* These globals only ever get directly accessed in this file */</span>
<a name="l00939"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a9ad150c6805c5173931005042a3ae672">00939</a> <span class="keyword">static</span> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *<a class="code" href="../../d5/dba/fmodifier_8c.html#a9ad150c6805c5173931005042a3ae672">fmodifiersTypeInfo</a>[<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba647b327a58819c9a1533272504703d8c">FMODIFIER_NUM_TYPES</a>];
<a name="l00940"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a9c779f7666c96a33e9be89bc46b7849a">00940</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a9c779f7666c96a33e9be89bc46b7849a">FMI_INIT</a>= 1; <span class="comment">/* when non-zero, the list needs to be updated */</span>
<a name="l00941"></a>00941 
<a name="l00942"></a>00942 <span class="comment">/* This function only gets called when FMI_INIT is non-zero */</span>
<a name="l00943"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ab24d66d846c4aac265d08f8edeb8d5fd">00943</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#ab24d66d846c4aac265d08f8edeb8d5fd">fmods_init_typeinfo</a> (<span class="keywordtype">void</span>) 
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945     fmodifiersTypeInfo[0]=  <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;                   <span class="comment">/* &#39;Null&#39; F-Curve Modifier */</span>
<a name="l00946"></a>00946     fmodifiersTypeInfo[1]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#a5346f18ecefe41ddad7867c4f3b00ad4">FMI_GENERATOR</a>;         <span class="comment">/* Generator F-Curve Modifier */</span>
<a name="l00947"></a>00947     fmodifiersTypeInfo[2]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#af304ebcbe4c21e48922a653de86616d6">FMI_FN_GENERATOR</a>;      <span class="comment">/* Built-In Function Generator F-Curve Modifier */</span>
<a name="l00948"></a>00948     fmodifiersTypeInfo[3]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#a1468d0e979620f6f3846d6ef091b74a9">FMI_ENVELOPE</a>;          <span class="comment">/* Envelope F-Curve Modifier */</span>
<a name="l00949"></a>00949     fmodifiersTypeInfo[4]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#a7621f5986df34f73226e4bd67d58efea">FMI_CYCLES</a>;            <span class="comment">/* Cycles F-Curve Modifier */</span>
<a name="l00950"></a>00950     fmodifiersTypeInfo[5]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#aec7f7c97bc1b74572d3033eb14535486">FMI_NOISE</a>;             <span class="comment">/* Apply-Noise F-Curve Modifier */</span>
<a name="l00951"></a>00951     fmodifiersTypeInfo[6]=  <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a><span class="comment">/*&amp;FMI_FILTER*/</span>;            <span class="comment">/* Filter F-Curve Modifier */</span>  <span class="comment">// XXX unimplemented</span>
<a name="l00952"></a>00952     fmodifiersTypeInfo[7]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#a8f5d6a7724818aa6038790d478eddde6">FMI_PYTHON</a>;            <span class="comment">/* Custom Python F-Curve Modifier */</span>
<a name="l00953"></a>00953     fmodifiersTypeInfo[8]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#ac8e7511056e6060180b9bf0170001b8e">FMI_LIMITS</a>;            <span class="comment">/* Limits F-Curve Modifier */</span>
<a name="l00954"></a>00954     fmodifiersTypeInfo[9]=  &amp;<a class="code" href="../../d5/dba/fmodifier_8c.html#a4edac759131bff836d2e1a302a315800">FMI_STEPPED</a>;           <span class="comment">/* Stepped F-Curve Modifier */</span>
<a name="l00955"></a>00955 }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957 <span class="comment">/* This function should be used for getting the appropriate type-info when only</span>
<a name="l00958"></a>00958 <span class="comment"> * a F-Curve modifier type is known</span>
<a name="l00959"></a>00959 <span class="comment"> */</span>
<a name="l00960"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ab3d348f3ab743fe9d0f9c196326bd15b">00960</a> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab3d348f3ab743fe9d0f9c196326bd15b">get_fmodifier_typeinfo</a> (<span class="keywordtype">int</span> type)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962     <span class="comment">/* initialize the type-info list? */</span>
<a name="l00963"></a>00963     <span class="keywordflow">if</span> (FMI_INIT) {
<a name="l00964"></a>00964         <a class="code" href="../../d5/dba/fmodifier_8c.html#ab24d66d846c4aac265d08f8edeb8d5fd">fmods_init_typeinfo</a>();
<a name="l00965"></a>00965         FMI_INIT = 0;
<a name="l00966"></a>00966     }
<a name="l00967"></a>00967     
<a name="l00968"></a>00968     <span class="comment">/* only return for valid types */</span>
<a name="l00969"></a>00969     <span class="keywordflow">if</span> ( (type &gt;= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba4bf233e2b80999d986fcd16269aaff83">FMODIFIER_TYPE_NULL</a>) &amp;&amp; 
<a name="l00970"></a>00970          (type &lt;= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba647b327a58819c9a1533272504703d8c">FMODIFIER_NUM_TYPES</a> ) ) 
<a name="l00971"></a>00971     {
<a name="l00972"></a>00972         <span class="comment">/* there shouldn&#39;t be any segfaults here... */</span>
<a name="l00973"></a>00973         <span class="keywordflow">return</span> fmodifiersTypeInfo[type];
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975     <span class="keywordflow">else</span> {
<a name="l00976"></a>00976         printf(<span class="stringliteral">&quot;No valid F-Curve Modifier type-info data available. Type = %i\n&quot;</span>, type);
<a name="l00977"></a>00977     }
<a name="l00978"></a>00978     
<a name="l00979"></a>00979     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00980"></a>00980 } 
<a name="l00981"></a>00981  
<a name="l00982"></a>00982 <span class="comment">/* This function should always be used to get the appropriate type-info, as it</span>
<a name="l00983"></a>00983 <span class="comment"> * has checks which prevent segfaults in some weird cases.</span>
<a name="l00984"></a>00984 <span class="comment"> */</span>
<a name="l00985"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a2dea69da8c17b0fb74c6499e4ce39b19">00985</a> <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987     <span class="comment">/* only return typeinfo for valid modifiers */</span>
<a name="l00988"></a>00988     <span class="keywordflow">if</span> (fcm)
<a name="l00989"></a>00989         <span class="keywordflow">return</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab3d348f3ab743fe9d0f9c196326bd15b">get_fmodifier_typeinfo</a>(fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2618b2144f7498de1afe54faa6692344">type</a>);
<a name="l00990"></a>00990     <span class="keywordflow">else</span>
<a name="l00991"></a>00991         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 <span class="comment">/* API --------------------------- */</span>
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 <span class="comment">/* Add a new F-Curve Modifier to the given F-Curve of a certain type */</span>
<a name="l00997"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a837a7cde11591d7d33b78348cb9f50f2">00997</a> <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a782b8a634387db32ffbadd880093bf60">add_fmodifier</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <span class="keywordtype">int</span> type)
<a name="l00998"></a>00998 {
<a name="l00999"></a>00999     <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab3d348f3ab743fe9d0f9c196326bd15b">get_fmodifier_typeinfo</a>(type);
<a name="l01000"></a>01000     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l01001"></a>01001     
<a name="l01002"></a>01002     <span class="comment">/* sanity checks */</span>
<a name="l01003"></a>01003     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, fmi))
<a name="l01004"></a>01004         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01005"></a>01005     
<a name="l01006"></a>01006     <span class="comment">/* special checks for whether modifier can be added */</span>
<a name="l01007"></a>01007     <span class="keywordflow">if</span> ((modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) &amp;&amp; (type == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba0a9f871f719b71334e21fb78f83aa48d">FMODIFIER_TYPE_CYCLES</a>)) {
<a name="l01008"></a>01008         <span class="comment">/* cycles modifier must be first in stack, so for now, don&#39;t add if it can&#39;t be */</span>
<a name="l01009"></a>01009         <span class="comment">// TODO: perhaps there is some better way, but for now, </span>
<a name="l01010"></a>01010         printf(<span class="stringliteral">&quot;Error: Cannot add &#39;Cycles&#39; modifier to F-Curve, as &#39;Cycles&#39; modifier can only be first in stack.\n&quot;</span>);
<a name="l01011"></a>01011         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013     
<a name="l01014"></a>01014     <span class="comment">/* add modifier itself */</span>
<a name="l01015"></a>01015     fcm= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a>), <span class="stringliteral">&quot;F-Curve Modifier&quot;</span>);
<a name="l01016"></a>01016     fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2618b2144f7498de1afe54faa6692344">type</a> = type;
<a name="l01017"></a>01017     fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba9efd0030d964d3a11f27180597b00bbe">FMODIFIER_FLAG_EXPANDED</a>;
<a name="l01018"></a>01018     fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a20b4827e757cda85537b6e9d42e9ff95">influence</a> = 1.0f;
<a name="l01019"></a>01019     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(modifiers, fcm);
<a name="l01020"></a>01020     
<a name="l01021"></a>01021     <span class="comment">/* tag modifier as &quot;active&quot; if no other modifiers exist in the stack yet */</span>
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>)
<a name="l01023"></a>01023         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba7bdc6d088e3c52a060cd8b1431fd3c84">FMODIFIER_FLAG_ACTIVE</a>;
<a name="l01024"></a>01024     
<a name="l01025"></a>01025     <span class="comment">/* add modifier&#39;s data */</span>
<a name="l01026"></a>01026     fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#af6a88f733540c78b3390fdb6a287c1ba">size</a>, fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#ab8681d17c99632f0a8d86c58aa0c29cc">structName</a>);
<a name="l01027"></a>01027     
<a name="l01028"></a>01028     <span class="comment">/* init custom settings if necessary */</span>
<a name="l01029"></a>01029     <span class="keywordflow">if</span> (fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#ae4711d94e14dc510e2a9bb07b3b495ba">new_data</a>)  
<a name="l01030"></a>01030         fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#ae4711d94e14dc510e2a9bb07b3b495ba">new_data</a>(fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>);
<a name="l01031"></a>01031         
<a name="l01032"></a>01032     <span class="comment">/* return modifier for further editing */</span>
<a name="l01033"></a>01033     <span class="keywordflow">return</span> fcm;
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">/* Make a copy of the specified F-Modifier */</span>
<a name="l01037"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a95e863459a11cb2d0c535fbc83b56c2d">01037</a> <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a7ab17b3a2ccdb6078839792ff8e141c1">copy_fmodifier</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *src)
<a name="l01038"></a>01038 {
<a name="l01039"></a>01039     <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(src);
<a name="l01040"></a>01040     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *dst;
<a name="l01041"></a>01041     
<a name="l01042"></a>01042     <span class="comment">/* sanity check */</span>
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (src == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01044"></a>01044         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01045"></a>01045         
<a name="l01046"></a>01046     <span class="comment">/* copy the base data, clearing the links */</span>
<a name="l01047"></a>01047     dst = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(src);
<a name="l01048"></a>01048     dst-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a> = dst-&gt;<a class="code" href="../../dc/d68/structFModifier.html#aff8bd6357c375b26fd5537e6c20cdda0">prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01049"></a>01049     
<a name="l01050"></a>01050     <span class="comment">/* make a new copy of the F-Modifier&#39;s data */</span>
<a name="l01051"></a>01051     dst-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(src-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>);
<a name="l01052"></a>01052     
<a name="l01053"></a>01053     <span class="comment">/* only do specific constraints if required */</span>
<a name="l01054"></a>01054     <span class="keywordflow">if</span> (fmi &amp;&amp; fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#aa1aae270b7c98ff7c67df879efa8abfd">copy_data</a>)
<a name="l01055"></a>01055         fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#aa1aae270b7c98ff7c67df879efa8abfd">copy_data</a>(dst, src);
<a name="l01056"></a>01056         
<a name="l01057"></a>01057     <span class="comment">/* return the new modifier */</span>
<a name="l01058"></a>01058     <span class="keywordflow">return</span> dst;
<a name="l01059"></a>01059 }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061 <span class="comment">/* Duplicate all of the F-Modifiers in the Modifier stacks */</span>
<a name="l01062"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a95962d86693b5a728216f9e2ba797cdc">01062</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a95962d86693b5a728216f9e2ba797cdc">copy_fmodifiers</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *dst, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *src)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, *srcfcm;
<a name="l01065"></a>01065     
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dst, src))
<a name="l01067"></a>01067         <span class="keywordflow">return</span>;
<a name="l01068"></a>01068     
<a name="l01069"></a>01069     dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01070"></a>01070     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(dst, src);
<a name="l01071"></a>01071     
<a name="l01072"></a>01072     <span class="keywordflow">for</span> (fcm=dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, srcfcm=src-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcm &amp;&amp; srcfcm; srcfcm=srcfcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>, fcm=fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>) {
<a name="l01073"></a>01073         <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(fcm);
<a name="l01074"></a>01074         
<a name="l01075"></a>01075         <span class="comment">/* make a new copy of the F-Modifier&#39;s data */</span>
<a name="l01076"></a>01076         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>);
<a name="l01077"></a>01077         
<a name="l01078"></a>01078         <span class="comment">/* only do specific constraints if required */</span>
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (fmi &amp;&amp; fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#aa1aae270b7c98ff7c67df879efa8abfd">copy_data</a>)
<a name="l01080"></a>01080             fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#aa1aae270b7c98ff7c67df879efa8abfd">copy_data</a>(fcm, srcfcm);
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084 <span class="comment">/* Remove and free the given F-Modifier from the given stack  */</span>
<a name="l01085"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a7d9ee9aa909def4bbbc0c06a78fd88f4">01085</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a0c7fe5f18826b120b79ce4c17f1ac17d">remove_fmodifier</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087     <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(fcm);
<a name="l01088"></a>01088     
<a name="l01089"></a>01089     <span class="comment">/* sanity check */</span>
<a name="l01090"></a>01090     <span class="keywordflow">if</span> (fcm == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01091"></a>01091         <span class="keywordflow">return</span> 0;
<a name="l01092"></a>01092     
<a name="l01093"></a>01093     <span class="comment">/* free modifier&#39;s special data (stored inside fcm-&gt;data) */</span>
<a name="l01094"></a>01094     <span class="keywordflow">if</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>) {
<a name="l01095"></a>01095         <span class="keywordflow">if</span> (fmi &amp;&amp; fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a0e45412ec9e9cf5266f0ce73158c5c19">free_data</a>)
<a name="l01096"></a>01096             fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a0e45412ec9e9cf5266f0ce73158c5c19">free_data</a>(fcm);
<a name="l01097"></a>01097             
<a name="l01098"></a>01098         <span class="comment">/* free modifier&#39;s data (fcm-&gt;data) */</span>
<a name="l01099"></a>01099         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>);
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101     
<a name="l01102"></a>01102     <span class="comment">/* remove modifier from stack */</span>
<a name="l01103"></a>01103     <span class="keywordflow">if</span> (modifiers) {
<a name="l01104"></a>01104         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(modifiers, fcm);
<a name="l01105"></a>01105         <span class="keywordflow">return</span> 1;
<a name="l01106"></a>01106     } 
<a name="l01107"></a>01107     <span class="keywordflow">else</span> {
<a name="l01108"></a>01108         <span class="comment">// XXX this case can probably be removed some day, as it shouldn&#39;t happen...</span>
<a name="l01109"></a>01109         printf(<span class="stringliteral">&quot;remove_fmodifier() - no modifier stack given\n&quot;</span>);
<a name="l01110"></a>01110         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcm);
<a name="l01111"></a>01111         <span class="keywordflow">return</span> 0;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="comment">/* Remove all of a given F-Curve&#39;s modifiers */</span>
<a name="l01116"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#ada226703127f86a28c14e4fcc807b0e6">01116</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ada226703127f86a28c14e4fcc807b0e6">free_fmodifiers</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, *fmn;
<a name="l01119"></a>01119     
<a name="l01120"></a>01120     <span class="comment">/* sanity check */</span>
<a name="l01121"></a>01121     <span class="keywordflow">if</span> (modifiers == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01122"></a>01122         <span class="keywordflow">return</span>;
<a name="l01123"></a>01123     
<a name="l01124"></a>01124     <span class="comment">/* free each modifier in order - modifier is unlinked from list and freed */</span>
<a name="l01125"></a>01125     <span class="keywordflow">for</span> (fcm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcm; fcm= fmn) {
<a name="l01126"></a>01126         fmn= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>;
<a name="l01127"></a>01127         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a0c7fe5f18826b120b79ce4c17f1ac17d">remove_fmodifier</a>(modifiers, fcm);
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131 <span class="comment">/* Find the active F-Modifier */</span>
<a name="l01132"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a17a9ceabd8040da3cedccecfa2ade956">01132</a> <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a679d15493006f123f64928156bcf134c">find_active_fmodifier</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers)
<a name="l01133"></a>01133 {
<a name="l01134"></a>01134     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l01135"></a>01135     
<a name="l01136"></a>01136     <span class="comment">/* sanity checks */</span>
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01138"></a>01138         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01139"></a>01139     
<a name="l01140"></a>01140     <span class="comment">/* loop over modifiers until &#39;active&#39; one is found */</span>
<a name="l01141"></a>01141     <span class="keywordflow">for</span> (fcm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcm; fcm= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>) {
<a name="l01142"></a>01142         <span class="keywordflow">if</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba7bdc6d088e3c52a060cd8b1431fd3c84">FMODIFIER_FLAG_ACTIVE</a>)
<a name="l01143"></a>01143             <span class="keywordflow">return</span> fcm;
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     <span class="comment">/* no modifier is active */</span>
<a name="l01147"></a>01147     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="comment">/* Set the active F-Modifier */</span>
<a name="l01151"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a6c8816d67d4dd90f5b9ec07235b921f4">01151</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a91933cf356b9ffc693d92bfa1c2c6900">set_active_fmodifier</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fm;
<a name="l01154"></a>01154     
<a name="l01155"></a>01155     <span class="comment">/* sanity checks */</span>
<a name="l01156"></a>01156     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01157"></a>01157         <span class="keywordflow">return</span>;
<a name="l01158"></a>01158     
<a name="l01159"></a>01159     <span class="comment">/* deactivate all, and set current one active */</span>
<a name="l01160"></a>01160     <span class="keywordflow">for</span> (fm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fm; fm= fm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>)
<a name="l01161"></a>01161         fm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba7bdc6d088e3c52a060cd8b1431fd3c84">FMODIFIER_FLAG_ACTIVE</a>;
<a name="l01162"></a>01162     
<a name="l01163"></a>01163     <span class="comment">/* make given modifier active */</span>
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (fcm)
<a name="l01165"></a>01165         fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba7bdc6d088e3c52a060cd8b1431fd3c84">FMODIFIER_FLAG_ACTIVE</a>;
<a name="l01166"></a>01166 }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168 <span class="comment">/* Do we have any modifiers which match certain criteria </span>
<a name="l01169"></a>01169 <span class="comment"> *  - mtype - type of modifier (if 0, doesn&#39;t matter)</span>
<a name="l01170"></a>01170 <span class="comment"> *  - acttype - type of action to perform (if -1, doesn&#39;t matter)</span>
<a name="l01171"></a>01171 <span class="comment"> */</span>
<a name="l01172"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#af507d5b05d44a294131417635cc297b9">01172</a> <span class="keywordtype">short</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#af507d5b05d44a294131417635cc297b9">list_has_suitable_fmodifier</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <span class="keywordtype">int</span> mtype, <span class="keywordtype">short</span> acttype)
<a name="l01173"></a>01173 {
<a name="l01174"></a>01174     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l01175"></a>01175     
<a name="l01176"></a>01176     <span class="comment">/* if there are no specific filtering criteria, just skip */</span>
<a name="l01177"></a>01177     <span class="keywordflow">if</span> ((mtype == 0) &amp;&amp; (acttype == 0))
<a name="l01178"></a>01178         <span class="keywordflow">return</span> (modifiers &amp;&amp; modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l01179"></a>01179         
<a name="l01180"></a>01180     <span class="comment">/* sanity checks */</span>
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01182"></a>01182         <span class="keywordflow">return</span> 0;
<a name="l01183"></a>01183         
<a name="l01184"></a>01184     <span class="comment">/* find the first mdifier fitting these criteria */</span>
<a name="l01185"></a>01185     <span class="keywordflow">for</span> (fcm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcm; fcm= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>) {
<a name="l01186"></a>01186         <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(fcm);
<a name="l01187"></a>01187         <span class="keywordtype">short</span> mOk=1, aOk=1; <span class="comment">/* by default 1, so that when only one test, won&#39;t fail */</span>
<a name="l01188"></a>01188         
<a name="l01189"></a>01189         <span class="comment">/* check if applicable ones are fullfilled */</span>
<a name="l01190"></a>01190         <span class="keywordflow">if</span> (mtype)
<a name="l01191"></a>01191             mOk= (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2618b2144f7498de1afe54faa6692344">type</a> == mtype);
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (acttype &gt; -1)
<a name="l01193"></a>01193             aOk= (fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a55ba61523d831c1279d274213fe49ea9">acttype</a> == acttype);
<a name="l01194"></a>01194             
<a name="l01195"></a>01195         <span class="comment">/* if both are ok, we&#39;ve found a hit */</span>
<a name="l01196"></a>01196         <span class="keywordflow">if</span> (mOk &amp;&amp; aOk)
<a name="l01197"></a>01197             <span class="keywordflow">return</span> 1;
<a name="l01198"></a>01198     }
<a name="l01199"></a>01199     
<a name="l01200"></a>01200     <span class="comment">/* no matches */</span>
<a name="l01201"></a>01201     <span class="keywordflow">return</span> 0;
<a name="l01202"></a>01202 }  
<a name="l01203"></a>01203 
<a name="l01204"></a>01204 <span class="comment">/* Evaluation API --------------------------- */</span>
<a name="l01205"></a>01205 
<a name="l01206"></a>01206 <span class="comment">/* helper function - calculate influence of FModifier */</span>
<a name="l01207"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a09a3c7c2a1557f202284a74e0e59e12b">01207</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/dba/fmodifier_8c.html#a09a3c7c2a1557f202284a74e0e59e12b">eval_fmodifier_influence</a> (<a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm, <span class="keywordtype">float</span> evaltime)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209     <span class="keywordtype">float</span> influence;
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     <span class="comment">/* sanity check */</span>
<a name="l01212"></a>01212     <span class="keywordflow">if</span> (fcm == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l01213"></a>01213         <span class="keywordflow">return</span> 0.0f;
<a name="l01214"></a>01214     
<a name="l01215"></a>01215     <span class="comment">/* should we use influence stored in modifier or not </span>
<a name="l01216"></a>01216 <span class="comment">     * NOTE: this is really just a hack so that we don&#39;t need to version patch old files ;)</span>
<a name="l01217"></a>01217 <span class="comment">     */</span>
<a name="l01218"></a>01218     <span class="keywordflow">if</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba505f0a99d7923dbd706916d438ffdcc2">FMODIFIER_FLAG_USEINFLUENCE</a>)
<a name="l01219"></a>01219         influence = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a20b4827e757cda85537b6e9d42e9ff95">influence</a>;
<a name="l01220"></a>01220     <span class="keywordflow">else</span>
<a name="l01221"></a>01221         influence = 1.0f;
<a name="l01222"></a>01222         
<a name="l01223"></a>01223     <span class="comment">/* restricted range or full range? */</span>
<a name="l01224"></a>01224     <span class="keywordflow">if</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2baf4acbcb9528fca66fb399acdbe9f83db">FMODIFIER_FLAG_RANGERESTRICT</a>) {
<a name="l01225"></a>01225         <span class="keywordflow">if</span> ((evaltime &lt;= fcm-&gt;sfra) || (evaltime &gt;= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a>)) {
<a name="l01226"></a>01226             <span class="comment">/* out of range */</span>
<a name="l01227"></a>01227             <span class="keywordflow">return</span> 0.0f;
<a name="l01228"></a>01228         }
<a name="l01229"></a>01229         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((evaltime &gt; fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a3f5fb0137f2890ffaccaa2964a5845b5">sfra</a>) &amp;&amp; (evaltime &lt; fcm-&gt;sfra + fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#ad5bc5b8ef919c3ed6ea2ff596188f6f5">blendin</a>)) {
<a name="l01230"></a>01230             <span class="comment">/* blend in range */</span>
<a name="l01231"></a>01231             <span class="keywordtype">float</span> a = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a3f5fb0137f2890ffaccaa2964a5845b5">sfra</a>;
<a name="l01232"></a>01232             <span class="keywordtype">float</span> b = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a3f5fb0137f2890ffaccaa2964a5845b5">sfra</a> + fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#ad5bc5b8ef919c3ed6ea2ff596188f6f5">blendin</a>;
<a name="l01233"></a>01233             <span class="keywordflow">return</span> influence * (evaltime - a) / (b - a);
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((evaltime &lt; fcm-&gt;efra) &amp;&amp; (evaltime &gt; fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a> - fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a74dfcc7c07be5afe0266032f11d75ba5">blendout</a>)) {
<a name="l01236"></a>01236             <span class="comment">/* blend out range */</span>
<a name="l01237"></a>01237             <span class="keywordtype">float</span> a = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a>;
<a name="l01238"></a>01238             <span class="keywordtype">float</span> b = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a> - fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a74dfcc7c07be5afe0266032f11d75ba5">blendout</a>;
<a name="l01239"></a>01239             <span class="keywordflow">return</span> influence * (evaltime - a) / (b - a);
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242     
<a name="l01243"></a>01243     <span class="comment">/* just return the influence of the modifier */</span>
<a name="l01244"></a>01244     <span class="keywordflow">return</span> influence;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 <span class="comment">/* evaluate time modifications imposed by some F-Curve Modifiers</span>
<a name="l01248"></a>01248 <span class="comment"> *  - this step acts as an optimization to prevent the F-Curve stack being evaluated </span>
<a name="l01249"></a>01249 <span class="comment"> *    several times by modifiers requesting the time be modified, as the final result</span>
<a name="l01250"></a>01250 <span class="comment"> *    would have required using the modified time</span>
<a name="l01251"></a>01251 <span class="comment"> *  - modifiers only ever receive the unmodified time, as subsequent modifiers should be</span>
<a name="l01252"></a>01252 <span class="comment"> *    working on the &#39;global&#39; result of the modified curve, not some localised segment,</span>
<a name="l01253"></a>01253 <span class="comment"> *    so nevaltime gets set to whatever the last time-modifying modifier likes...</span>
<a name="l01254"></a>01254 <span class="comment"> *  - we start from the end of the stack, as only the last one matters for now</span>
<a name="l01255"></a>01255 <span class="comment"> */</span>
<a name="l01256"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a94476d1b873d9804e50c91640dbc3878">01256</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a6e97a1611f606024e707f0beef7ec1df">evaluate_time_fmodifiers</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l01257"></a>01257 {
<a name="l01258"></a>01258     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l01259"></a>01259     
<a name="l01260"></a>01260     <span class="comment">/* sanity checks */</span>
<a name="l01261"></a>01261     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>))
<a name="l01262"></a>01262         <span class="keywordflow">return</span> evaltime;
<a name="l01263"></a>01263         
<a name="l01264"></a>01264     <span class="comment">/* Starting from the end of the stack, calculate the time effects of various stacked modifiers </span>
<a name="l01265"></a>01265 <span class="comment">     * on the time the F-Curve should be evaluated at. </span>
<a name="l01266"></a>01266 <span class="comment">     *</span>
<a name="l01267"></a>01267 <span class="comment">     * This is done in reverse order to standard evaluation, as when this is done in standard</span>
<a name="l01268"></a>01268 <span class="comment">     * order, each modifier would cause jumps to other points in the curve, forcing all</span>
<a name="l01269"></a>01269 <span class="comment">     * previous ones to be evaluated again for them to be correct. However, if we did in the </span>
<a name="l01270"></a>01270 <span class="comment">     * reverse order as we have here, we can consider them a macro to micro type of waterfall</span>
<a name="l01271"></a>01271 <span class="comment">     * effect, which should get us the desired effects when using layered time manipulations</span>
<a name="l01272"></a>01272 <span class="comment">     * (such as multiple &#39;stepped&#39; modifiers in sequence, causing different stepping rates)</span>
<a name="l01273"></a>01273 <span class="comment">     */</span>
<a name="l01274"></a>01274     <span class="keywordflow">for</span> (fcm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>; fcm; fcm= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#aff8bd6357c375b26fd5537e6c20cdda0">prev</a>) {
<a name="l01275"></a>01275         <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(fcm);
<a name="l01276"></a>01276         
<a name="l01277"></a>01277         <span class="keywordflow">if</span> (fmi == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l01278"></a>01278             <span class="keywordflow">continue</span>;
<a name="l01279"></a>01279         
<a name="l01280"></a>01280         <span class="comment">/* if modifier cannot be applied on this frame (whatever scale it is on, it won&#39;t affect the results)</span>
<a name="l01281"></a>01281 <span class="comment">         * hence we shouldn&#39;t bother seeing what it would do given the chance</span>
<a name="l01282"></a>01282 <span class="comment">         */</span>
<a name="l01283"></a>01283         <span class="keywordflow">if</span> ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2baf4acbcb9528fca66fb399acdbe9f83db">FMODIFIER_FLAG_RANGERESTRICT</a>)==0 || 
<a name="l01284"></a>01284             ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a3f5fb0137f2890ffaccaa2964a5845b5">sfra</a> &lt;= evaltime) &amp;&amp; (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a> &gt;= evaltime)) )
<a name="l01285"></a>01285         {
<a name="l01286"></a>01286             <span class="comment">/* only evaluate if there&#39;s a callback for this */</span>
<a name="l01287"></a>01287             <span class="keywordflow">if</span> (fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a9552066eb26b14a3a349b82f7dcf4de6">evaluate_modifier_time</a>) {
<a name="l01288"></a>01288                 <span class="keywordflow">if</span> ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2bac65e1acd5607743a689fc1ddb90b97e9">FMODIFIER_FLAG_DISABLED</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba1ff53e4dc66786f20c42f4b47460b9f5">FMODIFIER_FLAG_MUTED</a>)) == 0) {
<a name="l01289"></a>01289                     <span class="keywordtype">float</span> influence = <a class="code" href="../../d5/dba/fmodifier_8c.html#a09a3c7c2a1557f202284a74e0e59e12b">eval_fmodifier_influence</a>(fcm, evaltime);
<a name="l01290"></a>01290                     <span class="keywordtype">float</span> nval = fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a9552066eb26b14a3a349b82f7dcf4de6">evaluate_modifier_time</a>(fcu, fcm, cvalue, evaltime);
<a name="l01291"></a>01291                     
<a name="l01292"></a>01292                     evaltime = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab81894572f3dfe3985161cf8595bbe3a">interpf</a>(nval, evaltime, influence);
<a name="l01293"></a>01293                 }
<a name="l01294"></a>01294             }
<a name="l01295"></a>01295         }
<a name="l01296"></a>01296     }
<a name="l01297"></a>01297     
<a name="l01298"></a>01298     <span class="comment">/* return the modified evaltime */</span>
<a name="l01299"></a>01299     <span class="keywordflow">return</span> evaltime;
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302 <span class="comment">/* Evalautes the given set of F-Curve Modifiers using the given data</span>
<a name="l01303"></a>01303 <span class="comment"> * Should only be called after evaluate_time_fmodifiers() has been called...</span>
<a name="l01304"></a>01304 <span class="comment"> */</span>
<a name="l01305"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a084422e7c85294ef8feb50a0025bc5b1">01305</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a6c7259cde27b3daf8636f08372ea1e0e">evaluate_value_fmodifiers</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *modifiers, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> *cvalue, <span class="keywordtype">float</span> evaltime)
<a name="l01306"></a>01306 {
<a name="l01307"></a>01307     <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l01308"></a>01308     
<a name="l01309"></a>01309     <span class="comment">/* sanity checks */</span>
<a name="l01310"></a>01310     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifiers, modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01311"></a>01311         <span class="keywordflow">return</span>;
<a name="l01312"></a>01312     
<a name="l01313"></a>01313     <span class="comment">/* evaluate modifiers */</span>
<a name="l01314"></a>01314     <span class="keywordflow">for</span> (fcm= modifiers-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcm; fcm= fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2b03be89329aab5401fcd674e0f2d9ca">next</a>) {
<a name="l01315"></a>01315         <a class="code" href="../../d9/daa/structFModifierTypeInfo.html">FModifierTypeInfo</a> *fmi= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ade83c93762981b1a27bd40eb88dcccb6">fmodifier_get_typeinfo</a>(fcm);
<a name="l01316"></a>01316         
<a name="l01317"></a>01317         <span class="keywordflow">if</span> (fmi == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l01318"></a>01318             <span class="keywordflow">continue</span>;
<a name="l01319"></a>01319         
<a name="l01320"></a>01320         <span class="comment">/* only evaluate if there&#39;s a callback for this, and if F-Modifier can be evaluated on this frame */</span>
<a name="l01321"></a>01321         <span class="keywordflow">if</span> ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2baf4acbcb9528fca66fb399acdbe9f83db">FMODIFIER_FLAG_RANGERESTRICT</a>)==0 || 
<a name="l01322"></a>01322             ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a3f5fb0137f2890ffaccaa2964a5845b5">sfra</a> &lt;= evaltime) &amp;&amp; (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a53be235192348775b29c29afe6605d3c">efra</a> &gt;= evaltime)) )
<a name="l01323"></a>01323         {
<a name="l01324"></a>01324             <span class="keywordflow">if</span> (fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a2b5e1c52151fef06081da71cc6872598">evaluate_modifier</a>) {
<a name="l01325"></a>01325                 <span class="keywordflow">if</span> ((fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2bac65e1acd5607743a689fc1ddb90b97e9">FMODIFIER_FLAG_DISABLED</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba1ff53e4dc66786f20c42f4b47460b9f5">FMODIFIER_FLAG_MUTED</a>)) == 0) {
<a name="l01326"></a>01326                     <span class="keywordtype">float</span> influence = <a class="code" href="../../d5/dba/fmodifier_8c.html#a09a3c7c2a1557f202284a74e0e59e12b">eval_fmodifier_influence</a>(fcm, evaltime);
<a name="l01327"></a>01327                     <span class="keywordtype">float</span> nval = *cvalue;
<a name="l01328"></a>01328                     
<a name="l01329"></a>01329                     fmi-&gt;<a class="code" href="../../d9/daa/structFModifierTypeInfo.html#a2b5e1c52151fef06081da71cc6872598">evaluate_modifier</a>(fcu, fcm, &amp;nval, evaltime);
<a name="l01330"></a>01330                     *cvalue = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab81894572f3dfe3985161cf8595bbe3a">interpf</a>(nval, *cvalue, influence);
<a name="l01331"></a>01331                 }
<a name="l01332"></a>01332             }
<a name="l01333"></a>01333         }
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335 } 
<a name="l01336"></a>01336 
<a name="l01337"></a>01337 <span class="comment">/* ---------- */</span>
<a name="l01338"></a>01338 
<a name="l01339"></a>01339 <span class="comment">/* Bake modifiers for given F-Curve to curve sample data, in the frame range defined</span>
<a name="l01340"></a>01340 <span class="comment"> * by start and end (inclusive).</span>
<a name="l01341"></a>01341 <span class="comment"> */</span>
<a name="l01342"></a><a class="code" href="../../d5/dba/fmodifier_8c.html#a084eca247a7ebba0ac46a394bc075907">01342</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a9009113ae8aceee51f17810538137de8">fcurve_bake_modifiers</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver;
<a name="l01345"></a>01345     
<a name="l01346"></a>01346     <span class="comment">/* sanity checks */</span>
<a name="l01347"></a>01347     <span class="comment">// TODO: make these tests report errors using reports not printf&#39;s</span>
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l01349"></a>01349         printf(<span class="stringliteral">&quot;Error: No F-Curve with F-Curve Modifiers to Bake\n&quot;</span>);
<a name="l01350"></a>01350         <span class="keywordflow">return</span>;
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352     
<a name="l01353"></a>01353     <span class="comment">/* temporarily, disable driver while we sample, so that they don&#39;t influence the outcome */</span>
<a name="l01354"></a>01354     driver= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>;
<a name="l01355"></a>01355     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01356"></a>01356     
<a name="l01357"></a>01357     <span class="comment">/* bake the modifiers, by sampling the curve at each frame */</span>
<a name="l01358"></a>01358     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a74aab8fcbc30cc0337243ace43fc007c">fcurve_store_samples</a>(fcu, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, start, end, <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae4cd58a0dc544c1ba39f4621d91394eb">fcurve_samplingcb_evalcurve</a>);
<a name="l01359"></a>01359     
<a name="l01360"></a>01360     <span class="comment">/* free the modifiers now */</span>
<a name="l01361"></a>01361     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ada226703127f86a28c14e4fcc807b0e6">free_fmodifiers</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>);
<a name="l01362"></a>01362     
<a name="l01363"></a>01363     <span class="comment">/* restore driver */</span>
<a name="l01364"></a>01364     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>= driver;
<a name="l01365"></a>01365 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:21 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
