<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: multires.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">multires.c</div>  </div>
</div>
<div class="contents">
<a href="../../d5/de0/multires_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software  Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2007 by Nicholas Bishop</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/* for reading old multires */</span>
<a name="l00036"></a><a class="code" href="../../d5/de0/multires_8c.html#aab0b0efbdfa37ee26c8805af7d2e8c9c">00036</a> <span class="preprocessor">#define DNA_DEPRECATED_ALLOW</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd3/BLI__bitmap_8h.html">BLI_bitmap.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d13/BLI__pbvh_8h.html" title="A BVH for high poly meshes.">BLI_pbvh.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d37/BKE__multires_8h.html">BKE_multires.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d28/CCGSubSurf_8h.html">CCGSubSurf.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* MULTIRES MODIFIER */</span>
<a name="l00066"></a><a class="code" href="../../d5/de0/multires_8c.html#a9cc2a972bfa68aaec6d8c0e1baa5325f">00066</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/de0/multires_8c.html#a9cc2a972bfa68aaec6d8c0e1baa5325f">multires_max_levels</a> = 13;
<a name="l00067"></a><a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">00067</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">multires_grid_tot</a>[] = {0, 4, 9, 25, 81, 289, 1089, 4225, 16641, 66049, 263169, 1050625, 4198401, 16785409};
<a name="l00068"></a><a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">00068</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[] = {0, 2, 3, 5,  9,  17,  33,   65,   129,   257,   513,    1025,    2049,    4097};
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">/* See multiresModifier_disp_run for description of each operation */</span>
<a name="l00071"></a><a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78">00071</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l00072"></a><a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a1591d342cbff9d9ca1acc7097d904d68">00072</a>     <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a1591d342cbff9d9ca1acc7097d904d68">APPLY_DISPLACEMENTS</a>,
<a name="l00073"></a><a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">00073</a>     <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>,
<a name="l00074"></a><a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78ae5bbd67f7d3d31036bde34d9b259673f">00074</a>     <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78ae5bbd67f7d3d31036bde34d9b259673f">ADD_DISPLACEMENTS</a>,
<a name="l00075"></a>00075 } <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78">DispOp</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#afebbb61f3e8f7965520c4c32aa4338d2">multires_mvert_to_ss</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert);
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm2, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78">DispOp</a> op, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **oldGridData, <span class="keywordtype">int</span> totlvl);
<a name="l00079"></a>00079 
<a name="l00082"></a><a class="code" href="../../d5/de0/multires_8c.html#af9e8b74a77bd7f1896380a74a5265c02">00082</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a86414e7ca2b7b411173758afd892a2b1">multires_customdata_delete</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>) {
<a name="l00085"></a>00085         <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>;
<a name="l00086"></a>00086         <span class="comment">/* CustomData_external_remove is used here only to mark layer</span>
<a name="l00087"></a>00087 <span class="comment">         * as non-external for further free-ing, so zero element count</span>
<a name="l00088"></a>00088 <span class="comment">         * looks safer than em-&gt;totface */</span>
<a name="l00089"></a>00089         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ae811bdf90f0246245ba6b6219a689021">CustomData_external_remove</a>(&amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#abee9716c152e57c29af7d211ced0e178">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>,
<a name="l00090"></a>00090                                    <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>, 0);
<a name="l00091"></a>00091         <a class="code" href="../../de/d02/bmesh__interp_8c.html#a28b3056d3d3f0125438b472046963b29">BM_data_layer_free</a>(em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, &amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#abee9716c152e57c29af7d211ced0e178">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093     <span class="keywordflow">else</span> {
<a name="l00094"></a>00094         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ae811bdf90f0246245ba6b6219a689021">CustomData_external_remove</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>,
<a name="l00095"></a>00095                                    <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00096"></a>00096         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a206492daaf4a7bd388312de4d295cca8">CustomData_free_layer_active</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>,
<a name="l00097"></a>00097                                      me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00102"></a><a class="code" href="../../d5/de0/multires_8c.html#a93cadae1a9f68857a5ea83e5cff6e60d">00102</a> <span class="keyword">static</span> <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> <a class="code" href="../../d5/de0/multires_8c.html#a93cadae1a9f68857a5ea83e5cff6e60d">multires_mdisps_upsample_hidden</a>(<a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> lo_hidden,
<a name="l00103"></a>00103                                                   <span class="keywordtype">int</span> lo_level,
<a name="l00104"></a>00104                                                   <span class="keywordtype">int</span> hi_level,
<a name="l00105"></a>00105                                      
<a name="l00106"></a>00106                                                   <span class="comment">/* assumed to be at hi_level (or</span>
<a name="l00107"></a>00107 <span class="comment">                                                   *  null) */</span>
<a name="l00108"></a>00108                                                   <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> prev_hidden)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> subd;
<a name="l00111"></a>00111     <span class="keywordtype">int</span> hi_gridsize = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a31e1dd75a70cfac7b2a3e68a66fc43f6">ccg_gridsize</a>(hi_level);
<a name="l00112"></a>00112     <span class="keywordtype">int</span> lo_gridsize = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a31e1dd75a70cfac7b2a3e68a66fc43f6">ccg_gridsize</a>(lo_level);
<a name="l00113"></a>00113     <span class="keywordtype">int</span> yh, xh, xl, yl, xo, yo, hi_ndx;
<a name="l00114"></a>00114     <span class="keywordtype">int</span> offset, factor;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(lo_level &lt;= hi_level);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="comment">/* fast case */</span>
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (lo_level == hi_level)
<a name="l00120"></a>00120         <span class="keywordflow">return</span> <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(lo_hidden);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     subd = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ab5a4c9770bba8ca87005a5c84fa33dfa">BLI_BITMAP_NEW</a>(hi_gridsize * hi_gridsize, <span class="stringliteral">&quot;MDisps.hidden upsample&quot;</span>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     factor = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a9c196d152da40fe569328c88b7dadad2">ccg_factor</a>(lo_level, hi_level);
<a name="l00125"></a>00125     offset = 1 &lt;&lt; (hi_level - lo_level - 1);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="comment">/* low-res blocks */</span>
<a name="l00128"></a>00128     <span class="keywordflow">for</span> (yl = 0; yl &lt; lo_gridsize; yl++) {
<a name="l00129"></a>00129         <span class="keywordflow">for</span> (xl = 0; xl &lt; lo_gridsize; xl++) {
<a name="l00130"></a>00130             <span class="keywordtype">int</span> lo_val = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a74951d7a6b7401568d603bf3a55d5d8d">BLI_BITMAP_GET</a>(lo_hidden, yl * lo_gridsize + xl);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132             <span class="comment">/* high-res blocks */</span>
<a name="l00133"></a>00133             <span class="keywordflow">for</span> (yo = -offset; yo &lt;= offset; yo++) {
<a name="l00134"></a>00134                 yh = yl * factor + yo;
<a name="l00135"></a>00135                 <span class="keywordflow">if</span> (yh &lt; 0 || yh &gt;= hi_gridsize)
<a name="l00136"></a>00136                     <span class="keywordflow">continue</span>;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138                 <span class="keywordflow">for</span> (xo = -offset; xo &lt;= offset; xo++) {
<a name="l00139"></a>00139                     xh = xl * factor + xo;
<a name="l00140"></a>00140                     <span class="keywordflow">if</span> (xh &lt; 0 || xh &gt;= hi_gridsize)
<a name="l00141"></a>00141                         <span class="keywordflow">continue</span>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143                     hi_ndx = yh * hi_gridsize + xh;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145                     <span class="keywordflow">if</span> (prev_hidden) {
<a name="l00146"></a>00146                         <span class="comment">/* If prev_hidden is available, copy it to</span>
<a name="l00147"></a>00147 <span class="comment">                         * subd, except when the equivalent element in</span>
<a name="l00148"></a>00148 <span class="comment">                         * lo_hidden is different */</span>
<a name="l00149"></a>00149                         <span class="keywordflow">if</span> (lo_val != prev_hidden[hi_ndx])
<a name="l00150"></a>00150                             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(subd, hi_ndx, lo_val);
<a name="l00151"></a>00151                         <span class="keywordflow">else</span>
<a name="l00152"></a>00152                             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(subd, hi_ndx, prev_hidden[hi_ndx]);
<a name="l00153"></a>00153                     }
<a name="l00154"></a>00154                     <span class="keywordflow">else</span> {
<a name="l00155"></a>00155                         <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(subd, hi_ndx, lo_val);
<a name="l00156"></a>00156                     }
<a name="l00157"></a>00157                 }
<a name="l00158"></a>00158             }
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="keywordflow">return</span> subd;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="../../d5/de0/multires_8c.html#ace039703b490d832ac1b7562f51d0511">00165</a> <span class="keyword">static</span> <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> <a class="code" href="../../d5/de0/multires_8c.html#ace039703b490d832ac1b7562f51d0511">multires_mdisps_downsample_hidden</a>(<a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> old_hidden,
<a name="l00166"></a>00166                                                     <span class="keywordtype">int</span> old_level,
<a name="l00167"></a>00167                                                     <span class="keywordtype">int</span> new_level)
<a name="l00168"></a>00168 {
<a name="l00169"></a>00169     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> new_hidden;
<a name="l00170"></a>00170     <span class="keywordtype">int</span> new_gridsize = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a31e1dd75a70cfac7b2a3e68a66fc43f6">ccg_gridsize</a>(new_level);
<a name="l00171"></a>00171     <span class="keywordtype">int</span> old_gridsize = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a31e1dd75a70cfac7b2a3e68a66fc43f6">ccg_gridsize</a>(old_level);
<a name="l00172"></a>00172     <span class="keywordtype">int</span> x, y, factor, old_value;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(new_level &lt;= old_level);
<a name="l00175"></a>00175     factor = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a9c196d152da40fe569328c88b7dadad2">ccg_factor</a>(new_level, old_level);
<a name="l00176"></a>00176     new_hidden = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ab5a4c9770bba8ca87005a5c84fa33dfa">BLI_BITMAP_NEW</a>(new_gridsize * new_gridsize,
<a name="l00177"></a>00177                                 <span class="stringliteral">&quot;downsample hidden&quot;</span>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="keywordflow">for</span> (y = 0; y &lt; new_gridsize; y++) {
<a name="l00182"></a>00182         <span class="keywordflow">for</span> (x = 0; x &lt; new_gridsize; x++) {
<a name="l00183"></a>00183             old_value = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a74951d7a6b7401568d603bf3a55d5d8d">BLI_BITMAP_GET</a>(old_hidden,
<a name="l00184"></a>00184                                        factor*y*old_gridsize + x*factor);
<a name="l00185"></a>00185             
<a name="l00186"></a>00186             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(new_hidden, y*new_gridsize + x, old_value);
<a name="l00187"></a>00187         }
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">return</span> new_hidden;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="../../d5/de0/multires_8c.html#a167c40cb0bb7b0a91ea79ede0378145b">00193</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a167c40cb0bb7b0a91ea79ede0378145b">multires_output_hidden_to_ccgdm</a>(<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm,
<a name="l00194"></a>00194                                             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> level)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <span class="keyword">const</span> <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00197"></a>00197     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *grid_hidden = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a95f57e932ec2bb400a432ec37968313c">gridHidden</a>;
<a name="l00198"></a>00198     <span class="keywordtype">int</span> *gridOffset;
<a name="l00199"></a>00199     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l00200"></a>00200     
<a name="l00201"></a>00201     gridOffset = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#aa378b0ab6281d0b2f1c1c740314c4853">dm</a>.<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5a69ae7361f77bef729afa2ec720488">getGridOffset</a>(&amp;ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#aa378b0ab6281d0b2f1c1c740314c4853">dm</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; i++) {
<a name="l00204"></a>00204         <span class="keywordflow">for</span> (j = 0; j &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++) {
<a name="l00205"></a>00205             <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> = gridOffset[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + j;
<a name="l00206"></a>00206             <span class="keyword">const</span> <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *md = &amp;mdisps[<a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>];
<a name="l00207"></a>00207             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> gh = md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>;
<a name="l00208"></a>00208             
<a name="l00209"></a>00209             <span class="keywordflow">if</span> (gh) {
<a name="l00210"></a>00210                 grid_hidden[<a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>] =
<a name="l00211"></a>00211                     <a class="code" href="../../d5/de0/multires_8c.html#ace039703b490d832ac1b7562f51d0511">multires_mdisps_downsample_hidden</a>(gh, md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a>, level);
<a name="l00212"></a>00212             }
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="comment">/* subdivide mdisps.hidden if needed (assumes that md.level reflects</span>
<a name="l00218"></a>00218 <span class="comment"> * the current level of md.hidden) */</span>
<a name="l00219"></a><a class="code" href="../../d5/de0/multires_8c.html#a5a0b0b864f6de72825f71376ff4b193a">00219</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a5a0b0b864f6de72825f71376ff4b193a">multires_mdisps_subdivide_hidden</a>(<a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *md, <span class="keywordtype">int</span> new_level)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> subd;
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="comment">/* nothing to do if already subdivided enough */</span>
<a name="l00226"></a>00226     <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> &gt;= new_level)
<a name="l00227"></a>00227         <span class="keywordflow">return</span>;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     subd = <a class="code" href="../../d5/de0/multires_8c.html#a93cadae1a9f68857a5ea83e5cff6e60d">multires_mdisps_upsample_hidden</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>,
<a name="l00230"></a>00230                                            md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a>,
<a name="l00231"></a>00231                                            new_level,
<a name="l00232"></a>00232                                            <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00233"></a>00233     
<a name="l00234"></a>00234     <span class="comment">/* swap in the subdivided data */</span>
<a name="l00235"></a>00235     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l00236"></a>00236     md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a> = subd;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="../../d5/de0/multires_8c.html#acdd4211fe6dd87742dddbdceff36b0bb">00239</a> <span class="keyword">static</span> <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *<a class="code" href="../../d5/de0/multires_8c.html#acdd4211fe6dd87742dddbdceff36b0bb">multires_mdisps_initialize_hidden</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> level)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>,
<a name="l00242"></a>00242                                           <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, 0, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00243"></a>00243     <span class="keywordtype">int</span> gridsize = <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a31e1dd75a70cfac7b2a3e68a66fc43f6">ccg_gridsize</a>(level);
<a name="l00244"></a>00244     <span class="keywordtype">int</span> gridarea = gridsize * gridsize;
<a name="l00245"></a>00245     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k;
<a name="l00246"></a>00246     
<a name="l00247"></a>00247     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; i++) {
<a name="l00248"></a>00248         <span class="keywordtype">int</span> hide = 0;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         <span class="keywordflow">for</span> (j = 0; j &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++) {
<a name="l00251"></a>00251             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[i].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + j].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a9336832abc5e4645418d182f520d058f">ME_HIDE</a>) {
<a name="l00252"></a>00252                 hide = 1;
<a name="l00253"></a>00253                 <span class="keywordflow">break</span>;
<a name="l00254"></a>00254             }
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (!hide)
<a name="l00258"></a>00258             <span class="keywordflow">continue</span>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <span class="keywordflow">for</span> (j = 0; j &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++) {
<a name="l00261"></a>00261             <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *md = &amp;mdisps[me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + j];
<a name="l00262"></a>00262 
<a name="l00263"></a>00263             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265             md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a> = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ab5a4c9770bba8ca87005a5c84fa33dfa">BLI_BITMAP_NEW</a>(gridarea, <span class="stringliteral">&quot;MDisps.hidden initialize&quot;</span>);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267             <span class="keywordflow">for</span> (k = 0; k &lt; gridarea; k++)
<a name="l00268"></a>00268                 <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a27cfe01984456f412abfb142d8ae5a1c">BLI_BITMAP_SET</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>, k);
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="keywordflow">return</span> mdisps;
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="../../d5/de0/multires_8c.html#a139b638d5ec9f66b466f68459da9d727">00275</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d1/d37/BKE__multires_8h.html#a227c0e85cef7d40bb3432999d38910ce">get_multires_dm</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md= (<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *)mmd;
<a name="l00278"></a>00278     <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l00279"></a>00279     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tdm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0cb599f3f397fcb5f99b02677bf3b0ec">mesh_get_derived_deform</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00280"></a>00280     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     dm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, tdm, 0, 1);
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (dm == tdm) {
<a name="l00284"></a>00284         dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(tdm);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="keywordflow">return</span> dm;
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="../../d5/de0/multires_8c.html#a3210ac9f8695c268f80c9ff8c500bcf9">00290</a> <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *<a class="code" href="../../d1/d37/BKE__multires_8h.html#a447f2a81b1eb7621a50808c6b29aa009">find_multires_modifier_before</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *lastmd)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">for</span> (md = lastmd; md; md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a8203d9b7debfa7a6604a7aaf17a5fc8e">prev</a>) {
<a name="l00295"></a>00295         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a>) {
<a name="l00296"></a>00296             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>))
<a name="l00297"></a>00297                 <span class="keywordflow">return</span> (<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a>*)md;
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="comment">/* used for applying scale on mdisps layer and syncing subdivide levels when joining objects</span>
<a name="l00305"></a>00305 <span class="comment"> * use_first - return first multires modifier if all multires&#39;es are disabled</span>
<a name="l00306"></a>00306 <span class="comment"> */</span>
<a name="l00307"></a><a class="code" href="../../d5/de0/multires_8c.html#a0d61b492d800311437d1302ff09b8aac">00307</a> <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *<a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> use_first)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l00310"></a>00310     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *firstmmd= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <span class="comment">/* find first active multires modifier */</span>
<a name="l00313"></a>00313     <span class="keywordflow">for</span> (md = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; md; md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l00314"></a>00314         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a>) {
<a name="l00315"></a>00315             <span class="keywordflow">if</span> (!firstmmd)
<a name="l00316"></a>00316                 firstmmd= (<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a>*)md;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>)) {
<a name="l00319"></a>00319                 mmd= (<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a>*)md;
<a name="l00320"></a>00320                 <span class="keywordflow">break</span>;
<a name="l00321"></a>00321             }
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (!mmd &amp;&amp; use_first) {
<a name="l00326"></a>00326         <span class="comment">/* active multires have not been found</span>
<a name="l00327"></a>00327 <span class="comment">         * try to use first one */</span>
<a name="l00328"></a>00328         <span class="keywordflow">return</span> firstmmd;
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">return</span> mmd;
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a><a class="code" href="../../d5/de0/multires_8c.html#a344eb0953fab68df4106b5349f0cfeb8">00334</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/de0/multires_8c.html#a344eb0953fab68df4106b5349f0cfeb8">multires_get_level</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <span class="keywordtype">int</span> render)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (render)
<a name="l00337"></a>00337         <span class="keywordflow">return</span> (mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1086b878eeabc64e06962eee740bd75e">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>)? <a class="code" href="../../d8/d53/BKE__scene_8h.html#a5569680fe605835684a114ac08faf9eb">get_render_subsurf_level</a>(&amp;mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1086b878eeabc64e06962eee740bd75e">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a>): mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a>;
<a name="l00338"></a>00338     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a7b8620799f1bc866a5dc5ecaacf987a7">OB_MODE_SCULPT</a>)
<a name="l00339"></a>00339         <span class="keywordflow">return</span> mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>;
<a name="l00340"></a>00340     <span class="keywordflow">else</span>
<a name="l00341"></a>00341         <span class="keywordflow">return</span> (mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1086b878eeabc64e06962eee740bd75e">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>)? <a class="code" href="../../d8/d53/BKE__scene_8h.html#a5569680fe605835684a114ac08faf9eb">get_render_subsurf_level</a>(&amp;mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1086b878eeabc64e06962eee740bd75e">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>): mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a><a class="code" href="../../d5/de0/multires_8c.html#a58d22777ca6d105026b173477da1836a">00344</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a58d22777ca6d105026b173477da1836a">multires_set_tot_level</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <span class="keywordtype">int</span> lvl)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346     mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a> = lvl;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a7b8620799f1bc866a5dc5ecaacf987a7">OB_MODE_SCULPT</a>)
<a name="l00349"></a>00349         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>, lvl), 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>, lvl), 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00352"></a>00352     mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a>, lvl), 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a><a class="code" href="../../d5/de0/multires_8c.html#a6ef8b9c28919655a9cd68c68900cdd67">00355</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a6ef8b9c28919655a9cd68c68900cdd67">multires_dm_mark_as_modified</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4">MultiresModifiedFlags</a> flags)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm = (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)dm;
<a name="l00358"></a>00358     ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a8a09e30c2b5e17094a5e00a4fd9294e8">modified_flags</a> |= flags;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="../../d5/de0/multires_8c.html#aa63aa9c28a033c0ca0632dcab1cfbea4">00361</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#afd2c5ce15542c8f8d27b940f9cbf7a35">multires_mark_as_modified</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4">MultiresModifiedFlags</a> flags)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (ob &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>)
<a name="l00364"></a>00364         <a class="code" href="../../d5/de0/multires_8c.html#a6ef8b9c28919655a9cd68c68900cdd67">multires_dm_mark_as_modified</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>, flags);
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a><a class="code" href="../../d5/de0/multires_8c.html#aef029bb9b191990d6ae920a3de0e512d">00367</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (ob) {
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>) {
<a name="l00371"></a>00371             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> =1;
<a name="l00372"></a>00372             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>);
<a name="l00373"></a>00373             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>) {
<a name="l00376"></a>00376             <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a926a1b3c8250b12fd2a8915615e73146">BLI_pbvh_free</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>);
<a name="l00377"></a>00377             ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a><a class="code" href="../../d5/de0/multires_8c.html#a27f997b7be0fb05c363fc26a107e869b">00382</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#aee72f72c98bce8f5bae65f63fde62619">multires_force_external_reload</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a62e3dee76801baa20b102ffd41e0f419">CustomData_external_reload</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00387"></a>00387     <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00390"></a><a class="code" href="../../d5/de0/multires_8c.html#adc932a6c28701737b8c8cfd1e3b45ea7">00390</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a8dc111852c41527f8fa860ba5421a654">multires_force_render_update</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (ob &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a7b8620799f1bc866a5dc5ecaacf987a7">OB_MODE_SCULPT</a>) &amp;&amp; <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a>))
<a name="l00393"></a>00393         <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="../../d5/de0/multires_8c.html#ace0a8c998b28729ba6c592736bfa394a">00396</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a918ee9c0a53c6216b5171efaf6449ab5">multiresModifier_reshapeFromDM</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd,
<a name="l00397"></a>00397                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *srcdm)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *mrdm = <a class="code" href="../../d1/d37/BKE__multires_8h.html#a227c0e85cef7d40bb3432999d38910ce">get_multires_dm</a> (scene, mmd, ob);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (mrdm &amp;&amp; srcdm &amp;&amp; mrdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(mrdm) == srcdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(srcdm)) {
<a name="l00402"></a>00402         <a class="code" href="../../d5/de0/multires_8c.html#afebbb61f3e8f7965520c4c32aa4338d2">multires_mvert_to_ss</a>(mrdm, srcdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(srcdm));
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <a class="code" href="../../d5/de0/multires_8c.html#a6ef8b9c28919655a9cd68c68900cdd67">multires_dm_mark_as_modified</a>(mrdm, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4ad2bf78fc26652a42e8e000bb7a190d09">MULTIRES_COORDS_MODIFIED</a>);
<a name="l00405"></a>00405         <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         mrdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(mrdm);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="keywordflow">return</span> 1;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="keywordflow">if</span> (mrdm) mrdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(mrdm);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">return</span> 0;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">/* Returns 1 on success, 0 if the src&#39;s totvert doesn&#39;t match */</span>
<a name="l00418"></a><a class="code" href="../../d5/de0/multires_8c.html#a801239f6db64f4d688433803bf99cd55">00418</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#ac7e76e300059653c87faf61717f16a8d">multiresModifier_reshape</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *dst, <a class="code" href="../../de/de7/structObject.html">Object</a> *src)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *srcdm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, src, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00421"></a>00421     <span class="keywordflow">return</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a918ee9c0a53c6216b5171efaf6449ab5">multiresModifier_reshapeFromDM</a>(scene, mmd, dst, srcdm);
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="../../d5/de0/multires_8c.html#ad9d5021ef26340a8cf453517d976b10d">00424</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#aba340de63d481a42e5fe3cb5003a45c3">multiresModifier_reshapeFromDeformMod</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd,
<a name="l00425"></a>00425                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427     <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l00428"></a>00428     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, *ndm;
<a name="l00429"></a>00429     <span class="keywordtype">int</span> numVerts, result;
<a name="l00430"></a>00430     float (*deformedVerts)[3];
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (<a class="code" href="../../d5/de0/multires_8c.html#a344eb0953fab68df4106b5349f0cfeb8">multires_get_level</a>(ob, mmd, 0) == 0)
<a name="l00433"></a>00433         <span class="keywordflow">return</span> 0;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">/* Create DerivedMesh for deformation modifier */</span>
<a name="l00436"></a>00436     dm = <a class="code" href="../../d1/d37/BKE__multires_8h.html#a227c0e85cef7d40bb3432999d38910ce">get_multires_dm</a>(scene, mmd, ob);
<a name="l00437"></a>00437     numVerts= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00438"></a>00438     deformedVerts= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*numVerts*3, <span class="stringliteral">&quot;multiresReshape_deformVerts&quot;</span>);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(dm, deformedVerts);
<a name="l00441"></a>00441     mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, dm, deformedVerts, numVerts, 0, 0);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     ndm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l00444"></a>00444     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(ndm, deformedVerts);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l00447"></a>00447     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="comment">/* Reshaping */</span>
<a name="l00450"></a>00450     result= <a class="code" href="../../d1/d37/BKE__multires_8h.html#a918ee9c0a53c6216b5171efaf6449ab5">multiresModifier_reshapeFromDM</a>(scene, mmd, ob, ndm);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="comment">/* Cleanup */</span>
<a name="l00453"></a>00453     ndm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ndm);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="keywordflow">return</span> result;
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="comment">/* reset the multires levels to match the number of mdisps */</span>
<a name="l00459"></a><a class="code" href="../../d5/de0/multires_8c.html#a873857aaeefc849c1f28822220315f84">00459</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/de0/multires_8c.html#a873857aaeefc849c1f28822220315f84">get_levels_from_disps</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00462"></a>00462     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp, *md;
<a name="l00463"></a>00463     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, totlvl= 0;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     mdisp = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00468"></a>00468         md = mdisp + me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="keywordflow">for</span> (j=0; j&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, md++) {
<a name="l00471"></a>00471             <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> == 0) <span class="keywordflow">continue</span>;
<a name="l00472"></a>00472     
<a name="l00473"></a>00473             <span class="keywordflow">while</span> (1) {
<a name="l00474"></a>00474                 <span class="keywordtype">int</span> side = (1 &lt;&lt; (totlvl-1)) + 1;
<a name="l00475"></a>00475                 <span class="keywordtype">int</span> lvl_totdisp = side*side;
<a name="l00476"></a>00476                 <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> == lvl_totdisp)
<a name="l00477"></a>00477                     <span class="keywordflow">break</span>;
<a name="l00478"></a>00478                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> &lt; lvl_totdisp)
<a name="l00479"></a>00479                     --totlvl;
<a name="l00480"></a>00480                 <span class="keywordflow">else</span>
<a name="l00481"></a>00481                     ++totlvl;
<a name="l00482"></a>00482     
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484             
<a name="l00485"></a>00485             <span class="keywordflow">break</span>;
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="keywordflow">return</span> totlvl;
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="comment">/* reset the multires levels to match the number of mdisps */</span>
<a name="l00493"></a><a class="code" href="../../d5/de0/multires_8c.html#abbc3ec3642eabf087bb2a47479e38681">00493</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a689829550b26731d57ea1db96dc2d3b7">multiresModifier_set_levels_from_disps</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00496"></a>00496     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>)
<a name="l00499"></a>00499         mdisp = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#abee9716c152e57c29af7d211ced0e178">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00500"></a>00500     <span class="keywordflow">else</span>
<a name="l00501"></a>00501         mdisp = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (mdisp) {
<a name="l00504"></a>00504         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a> = <a class="code" href="../../d5/de0/multires_8c.html#a873857aaeefc849c1f28822220315f84">get_levels_from_disps</a>(ob);
<a name="l00505"></a>00505         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00506"></a>00506         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00507"></a>00507         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">00511</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">multires_set_tot_mdisps</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> lvl)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00514"></a>00514     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <span class="keywordflow">if</span> (mdisps) {
<a name="l00517"></a>00517         <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++, mdisps++) {
<a name="l00518"></a>00518             mdisps-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = <a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">multires_grid_tot</a>[lvl];
<a name="l00519"></a>00519             mdisps-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> = lvl;
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="../../d5/de0/multires_8c.html#af878bde26723a79bb3147fe527583f19">00524</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#af878bde26723a79bb3147fe527583f19">multires_reallocate_mdisps</a>(<span class="keywordtype">int</span> totloop, <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps, <span class="keywordtype">int</span> lvl)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <span class="comment">/* reallocate displacements to be filled in */</span>
<a name="l00529"></a>00529     <span class="keywordflow">for</span> (i = 0; i &lt; totloop; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00530"></a>00530         <span class="keywordtype">int</span> totdisp = <a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">multires_grid_tot</a>[lvl];
<a name="l00531"></a>00531         float (*disps)[3] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * totdisp, <span class="stringliteral">&quot;multires disps&quot;</span>);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         <span class="keywordflow">if</span> (mdisps[i].disps)
<a name="l00534"></a>00534             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdisps[i].disps);
<a name="l00535"></a>00535         
<a name="l00536"></a>00536         <span class="keywordflow">if</span> (mdisps[i].level &amp;&amp; mdisps[i].hidden)
<a name="l00537"></a>00537             <a class="code" href="../../d5/de0/multires_8c.html#a5a0b0b864f6de72825f71376ff4b193a">multires_mdisps_subdivide_hidden</a>(&amp;mdisps[i], lvl);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> = disps;
<a name="l00540"></a>00540         mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = totdisp;
<a name="l00541"></a>00541         mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> = lvl;
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">00545</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">column_vectors_to_mat3</a>(<span class="keywordtype">float</span> mat[][3], <span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> v2[3], <span class="keywordtype">float</span> v3[3])
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mat[0], v1);
<a name="l00548"></a>00548     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mat[1], v2);
<a name="l00549"></a>00549     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mat[2], v3);
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a><a class="code" href="../../d5/de0/multires_8c.html#a06063fb595955e8737fb6166b0df47ed">00552</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a06063fb595955e8737fb6166b0df47ed">multires_copy_grid</a>(<span class="keywordtype">float</span> (*gridA)[3], <span class="keywordtype">float</span> (*gridB)[3], <span class="keywordtype">int</span> sizeA, <span class="keywordtype">int</span> sizeB)
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <span class="keywordtype">int</span> x, y, j, skip;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (sizeA &gt; sizeB) {
<a name="l00557"></a>00557         skip = (sizeA-1)/(sizeB-1);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <span class="keywordflow">for</span> (j = 0, y = 0; y &lt; sizeB; y++)
<a name="l00560"></a>00560             <span class="keywordflow">for</span> (x = 0; x &lt; sizeB; x++, j++)
<a name="l00561"></a>00561                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gridA[y*skip*sizeA + x*skip], gridB[j]);
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563     <span class="keywordflow">else</span> {
<a name="l00564"></a>00564         skip = (sizeB-1)/(sizeA-1);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="keywordflow">for</span> (j = 0, y = 0; y &lt; sizeA; y++)
<a name="l00567"></a>00567             <span class="keywordflow">for</span> (x = 0; x &lt; sizeA; x++, j++)
<a name="l00568"></a>00568                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gridA[j], gridB[y*skip*sizeB + x*skip]);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a><a class="code" href="../../d5/de0/multires_8c.html#afc0f4a0465b7c618ace0540ff69fbb61">00572</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#afc0f4a0465b7c618ace0540ff69fbb61">multires_copy_dm_grid</a>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *gridA, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *gridB, <span class="keywordtype">int</span> sizeA, <span class="keywordtype">int</span> sizeB)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574     <span class="keywordtype">int</span> x, y, j, skip;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (sizeA &gt; sizeB) {
<a name="l00577"></a>00577         skip = (sizeA-1)/(sizeB-1);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579         <span class="keywordflow">for</span> (j = 0, y = 0; y &lt; sizeB; y++)
<a name="l00580"></a>00580             <span class="keywordflow">for</span> (x = 0; x &lt; sizeB; x++, j++)
<a name="l00581"></a>00581                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gridA[y*skip*sizeA + x*skip].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridB[j].co);
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     <span class="keywordflow">else</span> {
<a name="l00584"></a>00584         skip = (sizeB-1)/(sizeA-1);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keywordflow">for</span> (j = 0, y = 0; y &lt; sizeA; y++)
<a name="l00587"></a>00587             <span class="keywordflow">for</span> (x = 0; x &lt; sizeA; x++, j++)
<a name="l00588"></a>00588                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gridA[j].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridB[y*skip*sizeB + x*skip].co);
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="../../d5/de0/multires_8c.html#a3e838fb81f51bf1a4abf70a599d54555">00592</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a3e838fb81f51bf1a4abf70a599d54555">multires_del_higher</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> lvl)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00595"></a>00595     <span class="keywordtype">int</span> levels = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a> - lvl;
<a name="l00596"></a>00596     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">multires_set_tot_mdisps</a>(me, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00599"></a>00599     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00600"></a>00600     mdisps= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">if</span> (mdisps &amp;&amp; levels &gt; 0) {
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (lvl &gt; 0) {
<a name="l00606"></a>00606             <span class="comment">/* MLoop *ml = me-&gt;mloop; */</span> <span class="comment">/*UNUSED*/</span>
<a name="l00607"></a>00607             <span class="keywordtype">int</span> nsize = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[lvl];
<a name="l00608"></a>00608             <span class="keywordtype">int</span> hsize = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>];
<a name="l00609"></a>00609             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611             <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00612"></a>00612                 <span class="keywordflow">for</span> (j=0; j&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++) {
<a name="l00613"></a>00613                     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp= &amp;mdisps[me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>+j];
<a name="l00614"></a>00614                     float (*disps)[3], (*ndisps)[3], (*hdisps)[3];
<a name="l00615"></a>00615                     <span class="keywordtype">int</span> totdisp = <a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">multires_grid_tot</a>[lvl];
<a name="l00616"></a>00616 
<a name="l00617"></a>00617                     disps = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * totdisp, <span class="stringliteral">&quot;multires disps&quot;</span>);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619                     ndisps = disps;
<a name="l00620"></a>00620                     hdisps = mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622                     <a class="code" href="../../d5/de0/multires_8c.html#a06063fb595955e8737fb6166b0df47ed">multires_copy_grid</a>(ndisps, hdisps, nsize, hsize);
<a name="l00623"></a>00623                     <span class="keywordflow">if</span> (mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>) {
<a name="l00624"></a>00624                         <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> gh =
<a name="l00625"></a>00625                             <a class="code" href="../../d5/de0/multires_8c.html#ace039703b490d832ac1b7562f51d0511">multires_mdisps_downsample_hidden</a>(mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>,
<a name="l00626"></a>00626                                                               mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a>,
<a name="l00627"></a>00627                                                               lvl);
<a name="l00628"></a>00628                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l00629"></a>00629                         mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a> = gh;
<a name="l00630"></a>00630                     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632                     ndisps += nsize*nsize;
<a name="l00633"></a>00633                     hdisps += hsize*hsize;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>);
<a name="l00636"></a>00636                     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> = disps;
<a name="l00637"></a>00637                     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = totdisp;
<a name="l00638"></a>00638                     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> = lvl;
<a name="l00639"></a>00639                 }
<a name="l00640"></a>00640             }
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642         <span class="keywordflow">else</span> {
<a name="l00643"></a>00643             <a class="code" href="../../d1/d37/BKE__multires_8h.html#a86414e7ca2b7b411173758afd892a2b1">multires_customdata_delete</a>(me);
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <a class="code" href="../../d5/de0/multires_8c.html#a58d22777ca6d105026b173477da1836a">multires_set_tot_level</a>(ob, mmd, lvl);
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="comment">/* direction=1 for delete higher, direction=0 for lower (not implemented yet) */</span>
<a name="l00651"></a><a class="code" href="../../d5/de0/multires_8c.html#a2dec25516238930169b60461e2b87ecb">00651</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a5c60ead9d1046b83ec5842fcf9d1e9e3">multiresModifier_del_levels</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> direction)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00654"></a>00654     <span class="keywordtype">int</span> lvl = <a class="code" href="../../d5/de0/multires_8c.html#a344eb0953fab68df4106b5349f0cfeb8">multires_get_level</a>(ob, mmd, 0);
<a name="l00655"></a>00655     <span class="keywordtype">int</span> levels = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a> - lvl;
<a name="l00656"></a>00656     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">multires_set_tot_mdisps</a>(me, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l00659"></a>00659     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00660"></a>00660     mdisps= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (mdisps &amp;&amp; levels &gt; 0 &amp;&amp; direction == 1) {
<a name="l00665"></a>00665         <a class="code" href="../../d5/de0/multires_8c.html#a3e838fb81f51bf1a4abf70a599d54555">multires_del_higher</a>(mmd, ob, lvl);
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <a class="code" href="../../d5/de0/multires_8c.html#a58d22777ca6d105026b173477da1836a">multires_set_tot_level</a>(ob, mmd, lvl);
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">00671</a> <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">multires_dm_create_local</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> lvl, <span class="keywordtype">int</span> totlvl, <span class="keywordtype">int</span> simple)
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> mmd= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l00674"></a>00674 
<a name="l00675"></a>00675     mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a> = lvl;
<a name="l00676"></a>00676     mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a> = lvl;
<a name="l00677"></a>00677     mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aca86bb9d2ce9b1ed3a6e98b4c84ebe56">renderlvl</a> = lvl;
<a name="l00678"></a>00678     mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a> = totlvl;
<a name="l00679"></a>00679     mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a> = simple;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">return</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a2bc39adcf1c2a2c78ca9c59be60b8d0f">multires_dm_create_from_derived</a>(&amp;mmd, 1, dm, ob, 0);
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a><a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">00684</a> <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> lvl, <span class="keywordtype">int</span> simple, <span class="keywordtype">int</span> optimal, <span class="keywordtype">int</span> plain_uv)
<a name="l00685"></a>00685 {
<a name="l00686"></a>00686     <a class="code" href="../../dd/d1e/structSubsurfModifierData.html">SubsurfModifierData</a> smd= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#a64dfc0dbc8ce587b1e52733070241363">levels</a> = smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#ae33b8e5900f6cf266e869afb917f32ee">renderLevels</a> = lvl;
<a name="l00689"></a>00689     <span class="keywordflow">if</span> (!plain_uv)
<a name="l00690"></a>00690         smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#a855e94b53a58822910cd3f6826e72d2d">flags</a> |= <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ac6b7c4d55e26c3c444a936564f87bff0a49eca173d91020c659dbdef8b0124039">eSubsurfModifierFlag_SubsurfUv</a>;
<a name="l00691"></a>00691     <span class="keywordflow">if</span> (simple)
<a name="l00692"></a>00692         smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#ac73fe5bff5b1eb4f16b894077e7cd074">subdivType</a> = <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ac71f32bc6bc13b67e1623716119ea688">ME_SIMPLE_SUBSURF</a>;
<a name="l00693"></a>00693     <span class="keywordflow">if</span> (optimal)
<a name="l00694"></a>00694         smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#a855e94b53a58822910cd3f6826e72d2d">flags</a> |= <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ac6b7c4d55e26c3c444a936564f87bff0ab14bf620bb2b426e1f1a9f94d5c53a2e">eSubsurfModifierFlag_ControlEdges</a>;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">return</span> <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a57ccebcc6ff96fae9584945985e6d916">subsurf_make_derived_from_derived</a>(dm, &amp;smd, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a5aed90bff10a0fd5ad47c9ee79ae4580">OB_MODE_EDIT</a>));
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 <span class="comment">/* assumes no is normalized; return value&#39;s sign is negative if v is on</span>
<a name="l00702"></a>00702 <span class="comment"> * the other side of the plane */</span>
<a name="l00703"></a><a class="code" href="../../d5/de0/multires_8c.html#af744d2ecb8510e5fdfc0a6ee85df11a4">00703</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/de0/multires_8c.html#af744d2ecb8510e5fdfc0a6ee85df11a4">v3_dist_from_plane</a>(<span class="keywordtype">float</span> v[3], <span class="keywordtype">float</span> center[3], <span class="keywordtype">float</span> no[3])
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705     <span class="keywordtype">float</span> s[3];
<a name="l00706"></a>00706     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, v, center);
<a name="l00707"></a>00707     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(s, no);
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a><a class="code" href="../../d5/de0/multires_8c.html#ab99bae65dccee876b95a7fc8cbb3701c">00710</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#af36d5c30f2fe8532cf5e7434485d3f0f">multiresModifier_base_apply</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00711"></a>00711 {
<a name="l00712"></a>00712     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *cddm, *dispdm, *origdm;
<a name="l00713"></a>00713     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00714"></a>00714     <span class="keyword">const</span> <a class="code" href="../../de/d77/structMeshElemMap.html">MeshElemMap</a> *pmap;
<a name="l00715"></a>00715     float (*origco)[3];
<a name="l00716"></a>00716     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, offset, totlvl;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00721"></a>00721     totlvl = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="comment">/* nothing to do */</span>
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (!totlvl)
<a name="l00725"></a>00725         <span class="keywordflow">return</span>;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="comment">/* XXX - probably not necessary to regenerate the cddm so much? */</span>
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="comment">/* generate highest level with displacements */</span>
<a name="l00730"></a>00730     cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00731"></a>00731     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(cddm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00732"></a>00732     dispdm = <a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">multires_dm_create_local</a>(ob, cddm, totlvl, totlvl, 0);
<a name="l00733"></a>00733     cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="comment">/* copy the new locations of the base verts into the mesh */</span>
<a name="l00736"></a>00736     offset = dispdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dispdm) - me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00737"></a>00737     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00738"></a>00738         dispdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dispdm, offset + i, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="comment">/* heuristic to produce a better-fitting base mesh */</span>
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00744"></a>00744     pmap = cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab6ea6a823806062836338883beab6321">getPolyMap</a>(ob, cddm);
<a name="l00745"></a>00745     origco = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;multires apply base origco&quot;</span>);
<a name="l00746"></a>00746     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> ;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00747"></a>00747         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(origco[i], me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00750"></a>00750         <span class="keywordtype">float</span> avg_no[3] = {0,0,0}, center[3] = {0,0,0}, push[3];
<a name="l00751"></a>00751         <span class="keywordtype">float</span> dist;
<a name="l00752"></a>00752         <span class="keywordtype">int</span> tot = 0;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="comment">/* don&#39;t adjust verts not used by at least one poly */</span>
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (!pmap[i].count)
<a name="l00756"></a>00756             <span class="keywordflow">continue</span>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758         <span class="comment">/* find center */</span>
<a name="l00759"></a>00759         <span class="keywordflow">for</span> (j = 0; j &lt; pmap[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d77/structMeshElemMap.html#a442f8852d5d0a318cbd030a467ec5a91">count</a>; j++) {
<a name="l00760"></a>00760             <span class="keyword">const</span> <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[pmap[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d77/structMeshElemMap.html#ac471612628163bd1acbc072a6da7b642">indices</a>[j]];
<a name="l00761"></a>00761             
<a name="l00762"></a>00762             <span class="comment">/* this double counts, not sure if that&#39;s bad or good */</span>
<a name="l00763"></a>00763             <span class="keywordflow">for</span> (k = 0; k &lt; p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; ++k) {
<a name="l00764"></a>00764                 <span class="keywordtype">int</span> vndx = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + k].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l00765"></a>00765                 <span class="keywordflow">if</span> (vndx != i) {
<a name="l00766"></a>00766                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(center, origco[vndx]);
<a name="l00767"></a>00767                     ++tot;
<a name="l00768"></a>00768                 }
<a name="l00769"></a>00769             }
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(center, 1.0f / tot);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773         <span class="comment">/* find normal */</span>
<a name="l00774"></a>00774         <span class="keywordflow">for</span> (j = 0; j &lt; pmap[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d77/structMeshElemMap.html#a442f8852d5d0a318cbd030a467ec5a91">count</a>; j++) {
<a name="l00775"></a>00775             <span class="keyword">const</span> <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[pmap[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d77/structMeshElemMap.html#ac471612628163bd1acbc072a6da7b642">indices</a>[j]];
<a name="l00776"></a>00776             <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> fake_poly;
<a name="l00777"></a>00777             <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *fake_loops;
<a name="l00778"></a>00778             float (*fake_co)[3];
<a name="l00779"></a>00779             <span class="keywordtype">float</span> no[3];
<a name="l00780"></a>00780 
<a name="l00781"></a>00781             <span class="comment">/* set up poly, loops, and coords in order to call</span>
<a name="l00782"></a>00782 <span class="comment">             * mesh_calc_poly_normal_coords() */</span>
<a name="l00783"></a>00783             fake_poly.<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> = p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l00784"></a>00784             fake_poly.<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> = 0;
<a name="l00785"></a>00785             fake_loops = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d72/structMLoop.html">MLoop</a>) * p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>, <span class="stringliteral">&quot;fake_loops&quot;</span>);
<a name="l00786"></a>00786             fake_co = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>, <span class="stringliteral">&quot;fake_co&quot;</span>);
<a name="l00787"></a>00787             
<a name="l00788"></a>00788             <span class="keywordflow">for</span> (k = 0; k &lt; p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; ++k) {
<a name="l00789"></a>00789                 <span class="keywordtype">int</span> vndx = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[p-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + k].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l00790"></a>00790                 
<a name="l00791"></a>00791                 fake_loops[k].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> = k;
<a name="l00792"></a>00792                 
<a name="l00793"></a>00793                 <span class="keywordflow">if</span> (vndx == i)
<a name="l00794"></a>00794                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fake_co[k], center);
<a name="l00795"></a>00795                 <span class="keywordflow">else</span>
<a name="l00796"></a>00796                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fake_co[k], origco[vndx]);
<a name="l00797"></a>00797             }
<a name="l00798"></a>00798             
<a name="l00799"></a>00799             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#adf304c2c203d6ce280e595aeae5d4604">mesh_calc_poly_normal_coords</a>(&amp;fake_poly, fake_loops,
<a name="l00800"></a>00800                                          (<span class="keyword">const</span> <span class="keywordtype">float</span>(*)[3])fake_co, no);
<a name="l00801"></a>00801             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fake_loops);
<a name="l00802"></a>00802             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fake_co);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(avg_no, no);
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(avg_no);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <span class="comment">/* push vertex away from the plane */</span>
<a name="l00809"></a>00809         dist = <a class="code" href="../../d5/de0/multires_8c.html#af744d2ecb8510e5fdfc0a6ee85df11a4">v3_dist_from_plane</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, center, avg_no);
<a name="l00810"></a>00810         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(push, avg_no);
<a name="l00811"></a>00811         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(push, dist);
<a name="l00812"></a>00812         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, push);
<a name="l00813"></a>00813         
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(origco);
<a name="l00817"></a>00817     cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment">/* subdivide the mesh to highest level without displacements */</span>
<a name="l00820"></a>00820     cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00821"></a>00821     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(cddm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00822"></a>00822     origdm = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, cddm, totlvl, 0, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l00823"></a>00823     cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     <span class="comment">/* calc disps */</span>
<a name="l00826"></a>00826     <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(dispdm, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>, origdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(origdm), totlvl);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     origdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(origdm);
<a name="l00829"></a>00829     dispdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dispdm);
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00832"></a><a class="code" href="../../d5/de0/multires_8c.html#aefea64470e5d9258b3f4e34a7d67ef7d">00832</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#aefea64470e5d9258b3f4e34a7d67ef7d">multires_subdivide</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> totlvl, <span class="keywordtype">int</span> updateblock, <span class="keywordtype">int</span> simple)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00835"></a>00835     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l00836"></a>00836     <span class="keywordtype">int</span> lvl= mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (totlvl &gt; <a class="code" href="../../d5/de0/multires_8c.html#a9cc2a972bfa68aaec6d8c0e1baa5325f">multires_max_levels</a>)
<a name="l00839"></a>00839         <span class="keywordflow">return</span>;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00844"></a>00844     <span class="keywordflow">if</span> (!mdisps)
<a name="l00845"></a>00845         mdisps = <a class="code" href="../../d5/de0/multires_8c.html#acdd4211fe6dd87742dddbdceff36b0bb">multires_mdisps_initialize_hidden</a>(me, totlvl);
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <span class="keywordflow">if</span> (mdisps-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> &amp;&amp; !updateblock &amp;&amp; totlvl &gt; 1) {
<a name="l00848"></a>00848         <span class="comment">/* upsample */</span>
<a name="l00849"></a>00849         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lowdm, *cddm, *highdm;
<a name="l00850"></a>00850         <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **highGridData, **lowGridData, **subGridData;
<a name="l00851"></a>00851         <a class="code" href="../../d7/d07/structCCGSubSurf.html">CCGSubSurf</a> *ss;
<a name="l00852"></a>00852         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, numGrids, highGridSize, lowGridSize;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         <span class="comment">/* create subsurf DM from original mesh at high level */</span>
<a name="l00855"></a>00855         cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00856"></a>00856         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(cddm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00857"></a>00857         highdm = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, cddm, totlvl, simple, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="comment">/* create multires DM from original mesh at low level */</span>
<a name="l00860"></a>00860         lowdm = <a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">multires_dm_create_local</a>(ob, cddm, lvl, lvl, simple);
<a name="l00861"></a>00861         cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863         <span class="comment">/* copy subsurf grids and replace them with low displaced grids */</span>
<a name="l00864"></a>00864         numGrids = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a81ce6b1eab0f2d5646851b609e9cc842">getNumGrids</a>(highdm);
<a name="l00865"></a>00865         highGridSize = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(highdm);
<a name="l00866"></a>00866         highGridData = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(highdm);
<a name="l00867"></a>00867         lowGridSize = lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(lowdm);
<a name="l00868"></a>00868         lowGridData = lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(lowdm);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         subGridData = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>*)*numGrids, <span class="stringliteral">&quot;subGridData*&quot;</span>);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872         <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00873"></a>00873             <span class="comment">/* backup subsurf grids */</span>
<a name="l00874"></a>00874             subGridData[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*highGridSize*highGridSize, <span class="stringliteral">&quot;subGridData&quot;</span>);
<a name="l00875"></a>00875             memcpy(subGridData[i], highGridData[i], <span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*highGridSize*highGridSize);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877             <span class="comment">/* overwrite with current displaced grids */</span>
<a name="l00878"></a>00878             <a class="code" href="../../d5/de0/multires_8c.html#afc0f4a0465b7c618ace0540ff69fbb61">multires_copy_dm_grid</a>(highGridData[i], lowGridData[i], highGridSize, lowGridSize);
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         <span class="comment">/* low lower level dm no longer needed at this point */</span>
<a name="l00882"></a>00882         lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(lowdm);
<a name="l00883"></a>00883 
<a name="l00884"></a>00884         <span class="comment">/* subsurf higher levels again with displaced data */</span>
<a name="l00885"></a>00885         ss= ((<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)highdm)-&gt;ss;
<a name="l00886"></a>00886         <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a2e75087693866f43a56574207e78e5cb">ccgSubSurf_updateFromFaces</a>(ss, lvl, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00887"></a>00887         <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a4fd63daa37a47b2694e7fa403db5bf3a">ccgSubSurf_updateLevels</a>(ss, lvl, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889         <span class="comment">/* reallocate displacements */</span>
<a name="l00890"></a>00890         <a class="code" href="../../d5/de0/multires_8c.html#af878bde26723a79bb3147fe527583f19">multires_reallocate_mdisps</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>, mdisps, totlvl); 
<a name="l00891"></a>00891 
<a name="l00892"></a>00892         <span class="comment">/* compute displacements */</span>
<a name="l00893"></a>00893         <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(highdm, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>, subGridData, totlvl);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         <span class="comment">/* free */</span>
<a name="l00896"></a>00896         highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(highdm);
<a name="l00897"></a>00897         <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00898"></a>00898             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData[i]);
<a name="l00899"></a>00899         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData);
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901     <span class="keywordflow">else</span> {
<a name="l00902"></a>00902         <span class="comment">/* only reallocate, nothing to upsample */</span>
<a name="l00903"></a>00903         <a class="code" href="../../d5/de0/multires_8c.html#af878bde26723a79bb3147fe527583f19">multires_reallocate_mdisps</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>, mdisps, totlvl); 
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906     <a class="code" href="../../d5/de0/multires_8c.html#a58d22777ca6d105026b173477da1836a">multires_set_tot_level</a>(ob, mmd, totlvl);
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a><a class="code" href="../../d5/de0/multires_8c.html#a743de6306ff40e345a7e971a62605ba8">00909</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a35ffc6de70d2a5db0c381eee7607c534">multiresModifier_subdivide</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> updateblock, <span class="keywordtype">int</span> simple)
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911     <a class="code" href="../../d5/de0/multires_8c.html#aefea64470e5d9258b3f4e34a7d67ef7d">multires_subdivide</a>(mmd, ob, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>+1, updateblock, simple);
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00914"></a><a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">00914</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(<span class="keywordtype">int</span> gridSize, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> axis, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **gridData, <span class="keywordtype">float</span> t[3])
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916     <span class="keywordflow">if</span> (axis == 0) {
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (x == gridSize - 1) {
<a name="l00918"></a>00918             <span class="keywordflow">if</span> (y == gridSize - 1)
<a name="l00919"></a>00919                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x + gridSize*(y - 1)].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[index][x - 1 + gridSize*(y - 1)].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l00920"></a>00920             <span class="keywordflow">else</span>
<a name="l00921"></a>00921                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x + gridSize*y].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[index][x - 1 + gridSize*y].co);
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923         <span class="keywordflow">else</span>
<a name="l00924"></a>00924             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x + 1 + gridSize*y].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[index][x + gridSize*y].co);
<a name="l00925"></a>00925     }
<a name="l00926"></a>00926     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (axis == 1) {
<a name="l00927"></a>00927         <span class="keywordflow">if</span> (y == gridSize - 1) {
<a name="l00928"></a>00928             <span class="keywordflow">if</span> (x == gridSize - 1)
<a name="l00929"></a>00929                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x - 1 + gridSize*y].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[index][x - 1 + gridSize*(y - 1)].co);
<a name="l00930"></a>00930             <span class="keywordflow">else</span>
<a name="l00931"></a>00931                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x + gridSize*y].co, gridData[index][x + gridSize*(y - 1)].co);
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">else</span>
<a name="l00934"></a>00934             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, gridData[index][x + gridSize*(y + 1)].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[index][x + gridSize*y].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 
<a name="l00938"></a><a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">00938</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm2, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78">DispOp</a> op, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **oldGridData, <span class="keywordtype">int</span> totlvl)
<a name="l00939"></a>00939 {
<a name="l00940"></a>00940     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm = (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)dm;
<a name="l00941"></a>00941     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **gridData, **subGridData;
<a name="l00942"></a>00942     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>;
<a name="l00943"></a>00943     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00944"></a>00944     <span class="keywordtype">int</span> *gridOffset;
<a name="l00945"></a>00945     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, k, <span class="comment">/*numGrids,*/</span> gridSize, dGridSize, dSkip;
<a name="l00946"></a>00946     <span class="keywordtype">int</span> totloop, totpoly;
<a name="l00947"></a>00947     
<a name="l00948"></a>00948     <span class="comment">/* this happens in the dm made by bmesh_mdisps_space_set */</span>
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (dm2 &amp;&amp; <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm2-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>)) {
<a name="l00950"></a>00950         mpoly = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm2-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>);
<a name="l00951"></a>00951         mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm2-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00952"></a>00952         totloop = dm2-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>;
<a name="l00953"></a>00953         totpoly = dm2-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     <span class="keywordflow">else</span> {
<a name="l00956"></a>00956         totloop = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>;
<a name="l00957"></a>00957         totpoly = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>;
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959     
<a name="l00960"></a>00960     <span class="keywordflow">if</span> (!mdisps) {
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (op == <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>)
<a name="l00962"></a>00962             mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00963"></a>00963         <span class="keywordflow">else</span>
<a name="l00964"></a>00964             <span class="keywordflow">return</span>;
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="comment">/*numGrids = dm-&gt;getNumGrids(dm);*/</span> <span class="comment">/*UNUSED*/</span>
<a name="l00968"></a>00968     gridSize = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(dm);
<a name="l00969"></a>00969     gridData = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(dm);
<a name="l00970"></a>00970     gridOffset = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5a69ae7361f77bef729afa2ec720488">getGridOffset</a>(dm);
<a name="l00971"></a>00971     subGridData = (oldGridData)? oldGridData: gridData;
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     dGridSize = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl];
<a name="l00974"></a>00974     dSkip = (dGridSize-1)/(gridSize-1);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     k = 0; <span class="comment">/*current loop/mdisp index within the mloop array*/</span>
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 <span class="preprocessor">    #pragma omp parallel for private(i) if (totloop*gridSize*gridSize &gt;= CCG_OMP_LIMIT)</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span>
<a name="l00980"></a>00980     <span class="keywordflow">for</span> (i = 0; i &lt; totpoly; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00981"></a>00981         <span class="keyword">const</span> <span class="keywordtype">int</span> numVerts = mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l00982"></a>00982         <span class="keywordtype">int</span> S, x, y, gIndex = gridOffset[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00983"></a>00983 
<a name="l00984"></a>00984         <span class="keywordflow">for</span> (S = 0; S &lt; numVerts; ++S, ++gIndex, ++k) {
<a name="l00985"></a>00985             <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp = &amp;mdisps[mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>+S];
<a name="l00986"></a>00986             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *grid = gridData[gIndex];
<a name="l00987"></a>00987             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *subgrid = subGridData[gIndex];
<a name="l00988"></a>00988             float (*dispgrid)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990             <span class="comment">/* when adding new faces in edit mode, need to allocate disps */</span>
<a name="l00991"></a>00991             <span class="keywordflow">if</span> (!mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>)
<a name="l00992"></a>00992 <span class="preprocessor">            #pragma omp critical</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>            {
<a name="l00994"></a>00994                 <a class="code" href="../../d5/de0/multires_8c.html#af878bde26723a79bb3147fe527583f19">multires_reallocate_mdisps</a>(totloop, mdisps, totlvl);
<a name="l00995"></a>00995             }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997             dispgrid = mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999             <span class="keywordflow">for</span> (y = 0; y &lt; gridSize; y++) {
<a name="l01000"></a>01000                 <span class="keywordflow">for</span> (x = 0; x &lt; gridSize; x++) {
<a name="l01001"></a>01001                     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = grid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>;
<a name="l01002"></a>01002                     <span class="keywordtype">float</span> *sco = subgrid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>;
<a name="l01003"></a>01003                     <span class="keywordtype">float</span> *no = subgrid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a91db5970badedaaf7d68e109077cd189">no</a>;
<a name="l01004"></a>01004                     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = dispgrid[dGridSize*y*dSkip + x*dSkip];
<a name="l01005"></a>01005                     <span class="keywordtype">float</span> mat[3][3], tx[3], ty[3], disp[3], d[3];
<a name="l01006"></a>01006 
<a name="l01007"></a>01007                     <span class="comment">/* construct tangent space matrix */</span>
<a name="l01008"></a>01008                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 0, subGridData, tx);
<a name="l01009"></a>01009                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tx);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 1, subGridData, ty);
<a name="l01012"></a>01012                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ty);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014                     <span class="comment">//mul_v3_fl(tx, 1.0f/(gridSize-1));</span>
<a name="l01015"></a>01015                     <span class="comment">//mul_v3_fl(ty, 1.0f/(gridSize-1));</span>
<a name="l01016"></a>01016                     <span class="comment">//cross_v3_v3v3(no, tx, ty);</span>
<a name="l01017"></a>01017 
<a name="l01018"></a>01018                     <a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">column_vectors_to_mat3</a>(mat, tx, ty, no);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020                     <span class="keywordflow">switch</span>(op) {
<a name="l01021"></a>01021                     <span class="keywordflow">case</span> <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a1591d342cbff9d9ca1acc7097d904d68">APPLY_DISPLACEMENTS</a>:
<a name="l01022"></a>01022                         <span class="comment">/* Convert displacement to object space</span>
<a name="l01023"></a>01023 <span class="comment">                         * and add to grid points */</span>
<a name="l01024"></a>01024                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(disp, mat, data);
<a name="l01025"></a>01025                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, sco, disp);
<a name="l01026"></a>01026                         <span class="keywordflow">break</span>;
<a name="l01027"></a>01027                     <span class="keywordflow">case</span> <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>:
<a name="l01028"></a>01028                         <span class="comment">/* Calculate displacement between new and old</span>
<a name="l01029"></a>01029 <span class="comment">                         * grid points and convert to tangent space */</span>
<a name="l01030"></a>01030                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(disp, co, sco);
<a name="l01031"></a>01031                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(mat);
<a name="l01032"></a>01032                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(data, mat, disp);
<a name="l01033"></a>01033                         <span class="keywordflow">break</span>;
<a name="l01034"></a>01034                     <span class="keywordflow">case</span> <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78ae5bbd67f7d3d31036bde34d9b259673f">ADD_DISPLACEMENTS</a>:
<a name="l01035"></a>01035                         <span class="comment">/* Convert subdivided displacements to tangent</span>
<a name="l01036"></a>01036 <span class="comment">                         * space and add to the original displacements */</span>
<a name="l01037"></a>01037                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(mat);
<a name="l01038"></a>01038                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(d, mat, co);
<a name="l01039"></a>01039                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(data, d);
<a name="l01040"></a>01040                         <span class="keywordflow">break</span>;
<a name="l01041"></a>01041                     }
<a name="l01042"></a>01042                 }
<a name="l01043"></a>01043             }
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     <span class="keywordflow">if</span> (op == <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a1591d342cbff9d9ca1acc7097d904d68">APPLY_DISPLACEMENTS</a>) {
<a name="l01048"></a>01048         <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a882a2efefd34dfe22fe3df047e0b4934">ccgSubSurf_stitchFaces</a>(ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3fea726d390c252c3bf46119fa6a6237">ss</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01049"></a>01049         <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a30ebc716f8f58b3f0d90b91c22269049">ccgSubSurf_updateNormals</a>(ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3fea726d390c252c3bf46119fa6a6237">ss</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a><a class="code" href="../../d5/de0/multires_8c.html#a715d4becb53df4bde3c783f8bf586f62">01053</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a715d4becb53df4bde3c783f8bf586f62">multires_modifier_update_mdisps</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm= (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)dm;
<a name="l01056"></a>01056     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01057"></a>01057     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l01058"></a>01058     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l01059"></a>01059     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     ob = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#abb953f11a40eb8086c82df1c8c30ef3f">ob</a>;
<a name="l01062"></a>01062     me = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#abb953f11a40eb8086c82df1c8c30ef3f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01063"></a>01063     mmd = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a51660d8670c921d357ab5c16ddf28167">mmd</a>;
<a name="l01064"></a>01064     <a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">multires_set_tot_mdisps</a>(me, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l01065"></a>01065     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l01066"></a>01066     mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (mdisps) {
<a name="l01069"></a>01069         <span class="keywordtype">int</span> lvl = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3ed8ae9e758723954bf400782c73a2f7">lvl</a>;
<a name="l01070"></a>01070         <span class="keywordtype">int</span> totlvl = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a083dbea10669dcfc60384c6648f7b4f7">totlvl</a>;
<a name="l01071"></a>01071         
<a name="l01072"></a>01072         <span class="keywordflow">if</span> (lvl &lt; totlvl) {
<a name="l01073"></a>01073             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01074"></a>01074             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lowdm, *cddm, *highdm;
<a name="l01075"></a>01075             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **highGridData, **lowGridData, **subGridData, **gridData, *diffGrid;
<a name="l01076"></a>01076             <a class="code" href="../../d7/d07/structCCGSubSurf.html">CCGSubSurf</a> *ss;
<a name="l01077"></a>01077             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, numGrids, highGridSize, lowGridSize;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079             <span class="comment">/* create subsurf DM from original mesh at high level */</span>
<a name="l01080"></a>01080             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>) cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>);
<a name="l01081"></a>01081             <span class="keywordflow">else</span> cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01082"></a>01082             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(cddm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084             highdm = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, cddm, totlvl, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l01085"></a>01085 
<a name="l01086"></a>01086             <span class="comment">/* create multires DM from original mesh and displacements */</span>
<a name="l01087"></a>01087             lowdm = <a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">multires_dm_create_local</a>(ob, cddm, lvl, totlvl, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>);
<a name="l01088"></a>01088             cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l01089"></a>01089 
<a name="l01090"></a>01090             <span class="comment">/* gather grid data */</span>
<a name="l01091"></a>01091             numGrids = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a81ce6b1eab0f2d5646851b609e9cc842">getNumGrids</a>(highdm);
<a name="l01092"></a>01092             highGridSize = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(highdm);
<a name="l01093"></a>01093             highGridData = highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(highdm);
<a name="l01094"></a>01094             lowGridSize = lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(lowdm);
<a name="l01095"></a>01095             lowGridData = lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(lowdm);
<a name="l01096"></a>01096             gridData = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(dm);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098             subGridData = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>*)*numGrids, <span class="stringliteral">&quot;subGridData*&quot;</span>);
<a name="l01099"></a>01099             diffGrid = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*lowGridSize*lowGridSize, <span class="stringliteral">&quot;diff&quot;</span>);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101             <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01102"></a>01102                 <span class="comment">/* backup subsurf grids */</span>
<a name="l01103"></a>01103                 subGridData[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*highGridSize*highGridSize, <span class="stringliteral">&quot;subGridData&quot;</span>);
<a name="l01104"></a>01104                 memcpy(subGridData[i], highGridData[i], <span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*highGridSize*highGridSize);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106                 <span class="comment">/* write difference of subsurf and displaced low level into high subsurf */</span>
<a name="l01107"></a>01107                 <span class="keywordflow">for</span> (j = 0; j &lt; lowGridSize*lowGridSize; ++j)
<a name="l01108"></a>01108                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(diffGrid[j].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, gridData[i][j].co, lowGridData[i][j].co);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 <a class="code" href="../../d5/de0/multires_8c.html#afc0f4a0465b7c618ace0540ff69fbb61">multires_copy_dm_grid</a>(highGridData[i], diffGrid, highGridSize, lowGridSize);
<a name="l01111"></a>01111             }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113             <span class="comment">/* lower level dm no longer needed at this point */</span>
<a name="l01114"></a>01114             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(diffGrid);
<a name="l01115"></a>01115             lowdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(lowdm);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117             <span class="comment">/* subsurf higher levels again with difference of coordinates */</span>
<a name="l01118"></a>01118             ss= ((<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)highdm)-&gt;ss;
<a name="l01119"></a>01119             <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a2e75087693866f43a56574207e78e5cb">ccgSubSurf_updateFromFaces</a>(ss, lvl, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01120"></a>01120             <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a4fd63daa37a47b2694e7fa403db5bf3a">ccgSubSurf_updateLevels</a>(ss, lvl, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122             <span class="comment">/* add to displacements */</span>
<a name="l01123"></a>01123             <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(highdm, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78ae5bbd67f7d3d31036bde34d9b259673f">ADD_DISPLACEMENTS</a>, subGridData, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             <span class="comment">/* free */</span>
<a name="l01126"></a>01126             highdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(highdm);
<a name="l01127"></a>01127             <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01128"></a>01128                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData[i]);
<a name="l01129"></a>01129             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData);
<a name="l01130"></a>01130         }
<a name="l01131"></a>01131         <span class="keywordflow">else</span> {
<a name="l01132"></a>01132             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *cddm, *subdm;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>) cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>);
<a name="l01135"></a>01135             <span class="keywordflow">else</span> cddm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01136"></a>01136             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(cddm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138             subdm = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, cddm, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l01139"></a>01139             cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l01140"></a>01140 
<a name="l01141"></a>01141             <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(dm, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a3f054f27484eaacadd383cae457950fc">CALC_DISPLACEMENTS</a>, subdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(subdm), mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143             subdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(subdm);
<a name="l01144"></a>01144         }
<a name="l01145"></a>01145     }
<a name="l01146"></a>01146 }
<a name="l01147"></a>01147 
<a name="l01148"></a><a class="code" href="../../d5/de0/multires_8c.html#af10fb5ff3bdc35d4e08c3b34dcfd3828">01148</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae52791000812ba270ab22906d97cb7a0">multires_modifier_update_hidden</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l01149"></a>01149 {
<a name="l01150"></a>01150     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm= (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)dm;
<a name="l01151"></a>01151     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *grid_hidden= ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a95f57e932ec2bb400a432ec37968313c">gridHidden</a>;
<a name="l01152"></a>01152     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#abb953f11a40eb8086c82df1c8c30ef3f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01153"></a>01153     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l01154"></a>01154     <span class="keywordtype">int</span> totlvl = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a083dbea10669dcfc60384c6648f7b4f7">totlvl</a>;
<a name="l01155"></a>01155     <span class="keywordtype">int</span> lvl = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3ed8ae9e758723954bf400782c73a2f7">lvl</a>;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keywordflow">if</span> (mdisps) {
<a name="l01158"></a>01158         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01159"></a>01159         
<a name="l01160"></a>01160         <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++) {
<a name="l01161"></a>01161             <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *md = &amp;mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01162"></a>01162             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> gh = grid_hidden[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01163"></a>01163 
<a name="l01164"></a>01164             <span class="keywordflow">if</span> (!gh &amp;&amp; md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>) {
<a name="l01165"></a>01165                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l01166"></a>01166                 md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01167"></a>01167             }
<a name="l01168"></a>01168             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gh) {
<a name="l01169"></a>01169                 gh = <a class="code" href="../../d5/de0/multires_8c.html#a93cadae1a9f68857a5ea83e5cff6e60d">multires_mdisps_upsample_hidden</a>(gh, lvl, totlvl,
<a name="l01170"></a>01170                                                              md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l01171"></a>01171                 <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>)
<a name="l01172"></a>01172                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a>);
<a name="l01173"></a>01173                 
<a name="l01174"></a>01174                 md-&gt;<a class="code" href="../../da/d81/structMDisps.html#a2f831907f51e69b0b0a3efe4a8f1776a">hidden</a> = gh;
<a name="l01175"></a>01175             }
<a name="l01176"></a>01176         }
<a name="l01177"></a>01177     }
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a><a class="code" href="../../d5/de0/multires_8c.html#a8f8abb0d7ee870df8d7e5765997db8d1">01180</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a929748a421421b0a35c8c458de38b235">multires_set_space</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to)
<a name="l01181"></a>01181 {
<a name="l01182"></a>01182     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *ccgdm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *subsurf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01183"></a>01183     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **gridData, **subGridData=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01184"></a>01184     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>);
<a name="l01185"></a>01185     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l01186"></a>01186     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd = <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, 1);
<a name="l01187"></a>01187     <span class="keywordtype">int</span> *gridOffset, totlvl;
<a name="l01188"></a>01188     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, k, numGrids, gridSize, dGridSize, dSkip;
<a name="l01189"></a>01189     
<a name="l01190"></a>01190     <span class="keywordflow">if</span> (!mmd)
<a name="l01191"></a>01191         <span class="keywordflow">return</span>;
<a name="l01192"></a>01192     
<a name="l01193"></a>01193     mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     <span class="keywordflow">if</span> (!mdisps) {
<a name="l01196"></a>01196         <span class="keywordflow">goto</span> cleanup;
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     totlvl = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l01200"></a>01200     ccgdm = <a class="code" href="../../d5/de0/multires_8c.html#a02a18edc8e48f33f049c92841cb1e2af">multires_dm_create_local</a>(ob, dm, totlvl, totlvl, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>);
<a name="l01201"></a>01201     
<a name="l01202"></a>01202     subsurf = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, dm, totlvl,
<a name="l01203"></a>01203         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209dafa042b8ab957cc44528ae7c06d11d814">eMultiresModifierFlag_ControlEdges</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     numGrids = subsurf-&gt;getNumGrids(subsurf);
<a name="l01206"></a>01206     gridSize = subsurf-&gt;getGridSize(subsurf);
<a name="l01207"></a>01207     gridData = subsurf-&gt;getGridData(subsurf);
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     subGridData = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>*)*numGrids, <span class="stringliteral">&quot;subGridData*&quot;</span>);
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; i++) {
<a name="l01212"></a>01212         subGridData[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*gridSize*gridSize, <span class="stringliteral">&quot;subGridData&quot;</span>);
<a name="l01213"></a>01213         memcpy(subGridData[i], gridData[i], <span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*gridSize*gridSize);
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215     
<a name="l01216"></a>01216     <span class="comment">/*numGrids = ccgdm-&gt;dm-&gt;getNumGrids((DerivedMesh*)ccgdm);*/</span> <span class="comment">/*UNUSED*/</span>
<a name="l01217"></a>01217     gridSize = ccgdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>((<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>*)ccgdm);
<a name="l01218"></a>01218     gridData = ccgdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>((<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>*)ccgdm);
<a name="l01219"></a>01219     gridOffset = ccgdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5a69ae7361f77bef729afa2ec720488">getGridOffset</a>((<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>*)ccgdm);
<a name="l01220"></a>01220 
<a name="l01221"></a>01221     dGridSize = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl];
<a name="l01222"></a>01222     dSkip = (dGridSize-1)/(gridSize-1);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     k = 0; <span class="comment">/*current loop/mdisp index within the mloop array*/</span>
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <span class="comment">//#pragma omp parallel for private(i) if (dm-&gt;numLoopData*gridSize*gridSize &gt;= CCG_OMP_LIMIT)</span>
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="keywordflow">for</span> (i = 0; i &lt; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01229"></a>01229         <span class="keyword">const</span> <span class="keywordtype">int</span> numVerts = mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l01230"></a>01230         <span class="keywordtype">int</span> S, x, y, gIndex = gridOffset[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01231"></a>01231                         
<a name="l01232"></a>01232         <span class="keywordflow">for</span> (S = 0; S &lt; numVerts; ++S, ++gIndex, ++k) {
<a name="l01233"></a>01233             <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp = &amp;mdisps[mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>+S];
<a name="l01234"></a>01234             <span class="comment">/* DMGridData *grid = gridData[gIndex]; */</span> <span class="comment">/* UNUSED */</span>
<a name="l01235"></a>01235             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *subgrid = subGridData[gIndex];
<a name="l01236"></a>01236             float (*dispgrid)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238             <span class="comment">/* when adding new faces in edit mode, need to allocate disps */</span>
<a name="l01239"></a>01239             <span class="keywordflow">if</span> (!mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>) {
<a name="l01240"></a>01240                 mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = gridSize*gridSize;
<a name="l01241"></a>01241                 mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> = totlvl;
<a name="l01242"></a>01242                 mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a>, <span class="stringliteral">&quot;disp in multires_set_space&quot;</span>);
<a name="l01243"></a>01243             }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245             dispgrid = mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>;
<a name="l01246"></a>01246 
<a name="l01247"></a>01247             <span class="keywordflow">for</span> (y = 0; y &lt; gridSize; y++) {
<a name="l01248"></a>01248                 <span class="keywordflow">for</span> (x = 0; x &lt; gridSize; x++) {
<a name="l01249"></a>01249                     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = dispgrid[dGridSize*y*dSkip + x*dSkip];
<a name="l01250"></a>01250                     <span class="keywordtype">float</span> *no = subgrid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a91db5970badedaaf7d68e109077cd189">no</a>;
<a name="l01251"></a>01251                     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = subgrid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>;
<a name="l01252"></a>01252                     <span class="keywordtype">float</span> mat[3][3], tx[3], ty[3], dco[3];
<a name="l01253"></a>01253                     
<a name="l01254"></a>01254                     <span class="comment">/* construct tangent space matrix */</span>
<a name="l01255"></a>01255                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 0, subGridData, tx);
<a name="l01256"></a>01256                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tx);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 1, subGridData, ty);
<a name="l01259"></a>01259                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ty);
<a name="l01260"></a>01260                     <a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">column_vectors_to_mat3</a>(mat, tx, ty, no);
<a name="l01261"></a>01261 
<a name="l01262"></a>01262                     <span class="comment">/* convert to absolute coordinates in space */</span>
<a name="l01263"></a>01263                     <span class="keywordflow">if</span> (from == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388ad3ea46836acca4636283dc1b4d058ed2">MULTIRES_SPACE_TANGENT</a>) {
<a name="l01264"></a>01264                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(dco, mat, data);
<a name="l01265"></a>01265                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(dco, co);
<a name="l01266"></a>01266                     }
<a name="l01267"></a>01267                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (from == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388a34e99ee85df3f25beb55e1d9bf75679d">MULTIRES_SPACE_OBJECT</a>) {
<a name="l01268"></a>01268                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(dco, co, data);
<a name="l01269"></a>01269                     }
<a name="l01270"></a>01270                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (from == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388a1ec10ac332c6070b88a01145f4449822">MULTIRES_SPACE_ABSOLUTE</a>) {
<a name="l01271"></a>01271                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dco, data);
<a name="l01272"></a>01272                     }
<a name="l01273"></a>01273                     
<a name="l01274"></a>01274                     <a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">column_vectors_to_mat3</a>(mat, tx, ty, no);
<a name="l01275"></a>01275 
<a name="l01276"></a>01276                     <span class="comment">/*now, convert to desired displacement type*/</span>
<a name="l01277"></a>01277                     <span class="keywordflow">if</span> (to == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388ad3ea46836acca4636283dc1b4d058ed2">MULTIRES_SPACE_TANGENT</a>) {
<a name="l01278"></a>01278                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(mat);
<a name="l01279"></a>01279 
<a name="l01280"></a>01280                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(dco, co);
<a name="l01281"></a>01281                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(data, mat, dco);
<a name="l01282"></a>01282                     }
<a name="l01283"></a>01283                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (to == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388a34e99ee85df3f25beb55e1d9bf75679d">MULTIRES_SPACE_OBJECT</a>) {
<a name="l01284"></a>01284                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(dco, co);
<a name="l01285"></a>01285                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(data, mat, dco);
<a name="l01286"></a>01286                     }
<a name="l01287"></a>01287                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (to == <a class="code" href="../../d1/d37/BKE__multires_8h.html#a385c44f6fb256e5716a2302a5b940388a1ec10ac332c6070b88a01145f4449822">MULTIRES_SPACE_ABSOLUTE</a>) {
<a name="l01288"></a>01288                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data, dco);
<a name="l01289"></a>01289                     }
<a name="l01290"></a>01290                 }
<a name="l01291"></a>01291             }
<a name="l01292"></a>01292         }
<a name="l01293"></a>01293     }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295 cleanup:
<a name="l01296"></a>01296     <span class="keywordflow">if</span> (subsurf) {
<a name="l01297"></a>01297         subsurf-&gt;needsFree = 1;
<a name="l01298"></a>01298         subsurf-&gt;release(subsurf);
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301     <span class="keywordflow">if</span> (ccgdm) {
<a name="l01302"></a>01302         ccgdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l01303"></a>01303         ccgdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ccgdm);
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305 }
<a name="l01306"></a>01306 
<a name="l01307"></a><a class="code" href="../../d5/de0/multires_8c.html#a975cab436a8b311728abb2c8a88d97d6">01307</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a35d994e0fe83c06dd5e0f5d6a6877122">multires_stitch_grids</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01308"></a>01308 {
<a name="l01309"></a>01309     <span class="comment">/* utility for smooth brush */</span>
<a name="l01310"></a>01310     <span class="keywordflow">if</span> (ob &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>) {
<a name="l01311"></a>01311         <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm = (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l01312"></a>01312         <a class="code" href="../../df/d72/structCCGFace.html">CCGFace</a> **faces;
<a name="l01313"></a>01313         <span class="keywordtype">int</span> totface;
<a name="l01314"></a>01314 
<a name="l01315"></a>01315         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#aa8f287ddf66df28ab7c40b9259fe0af7">pbvh</a>) {
<a name="l01316"></a>01316             <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a9151a524bd860e19655e9140cff3511a">BLI_pbvh_get_grid_updates</a>(ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#aa8f287ddf66df28ab7c40b9259fe0af7">pbvh</a>, 0, (<span class="keywordtype">void</span>***)&amp;faces, &amp;totface);
<a name="l01317"></a>01317 
<a name="l01318"></a>01318             <span class="keywordflow">if</span> (totface) {
<a name="l01319"></a>01319                 <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a882a2efefd34dfe22fe3df047e0b4934">ccgSubSurf_stitchFaces</a>(ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3fea726d390c252c3bf46119fa6a6237">ss</a>, 0, faces, totface);
<a name="l01320"></a>01320                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(faces);
<a name="l01321"></a>01321             }
<a name="l01322"></a>01322         }
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324 }
<a name="l01325"></a>01325 
<a name="l01326"></a><a class="code" href="../../d5/de0/multires_8c.html#a9ac710023598d718c6acfb4c5997f025">01326</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d1/d37/BKE__multires_8h.html#a2bc39adcf1c2a2c78ca9c59be60b8d0f">multires_dm_create_from_derived</a>(<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd,
<a name="l01327"></a>01327                                              <span class="keywordtype">int</span> local_mmd, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l01328"></a>01328                                              <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> useRenderParams)
<a name="l01329"></a>01329 {
<a name="l01330"></a>01330     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01331"></a>01331     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *result;
<a name="l01332"></a>01332     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01333"></a>01333     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **gridData, **subGridData;
<a name="l01334"></a>01334     <span class="keywordtype">int</span> lvl= <a class="code" href="../../d5/de0/multires_8c.html#a344eb0953fab68df4106b5349f0cfeb8">multires_get_level</a>(ob, mmd, useRenderParams);
<a name="l01335"></a>01335     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, gridSize, numGrids;
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     <span class="keywordflow">if</span> (lvl == 0)
<a name="l01338"></a>01338         <span class="keywordflow">return</span> dm;
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     result = <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, dm, lvl,
<a name="l01341"></a>01341         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209dafa042b8ab957cc44528ae7c06d11d814">eMultiresModifierFlag_ControlEdges</a>,
<a name="l01342"></a>01342         mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344     <span class="keywordflow">if</span> (!local_mmd) {
<a name="l01345"></a>01345         ccgdm = (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*)result;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#abb953f11a40eb8086c82df1c8c30ef3f">ob</a> = ob;
<a name="l01348"></a>01348         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a51660d8670c921d357ab5c16ddf28167">mmd</a> = mmd;
<a name="l01349"></a>01349         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#ace7663172761e6fea49065de55d79487">local_mmd</a> = local_mmd;
<a name="l01350"></a>01350         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3ed8ae9e758723954bf400782c73a2f7">lvl</a> = lvl;
<a name="l01351"></a>01351         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a083dbea10669dcfc60384c6648f7b4f7">totlvl</a> = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l01352"></a>01352         ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a7e0d81a49f91c4570e209865a03651fe">multires</a>.<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a8a09e30c2b5e17094a5e00a4fd9294e8">modified_flags</a> = 0;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     numGrids = result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a81ce6b1eab0f2d5646851b609e9cc842">getNumGrids</a>(result);
<a name="l01356"></a>01356     gridSize = result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(result);
<a name="l01357"></a>01357     gridData = result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(result);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     subGridData = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>*)*numGrids, <span class="stringliteral">&quot;subGridData*&quot;</span>);
<a name="l01360"></a>01360 
<a name="l01361"></a>01361     <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; i++) {
<a name="l01362"></a>01362         subGridData[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*gridSize*gridSize, <span class="stringliteral">&quot;subGridData&quot;</span>);
<a name="l01363"></a>01363         memcpy(subGridData[i], gridData[i], <span class="keyword">sizeof</span>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a>)*gridSize*gridSize);
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     <a class="code" href="../../d5/de0/multires_8c.html#ae3252ae6cb66815717e8ea158cd39228">multires_set_tot_mdisps</a>(me, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l01367"></a>01367     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <span class="comment">/*run displacement*/</span>
<a name="l01370"></a>01370     <a class="code" href="../../d5/de0/multires_8c.html#affdf60a98f06d8cb065dda04690666a4">multiresModifier_disp_run</a>(result, ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, dm, <a class="code" href="../../d5/de0/multires_8c.html#a869f3860ffcb5e370eae732399a7ed78a1591d342cbff9d9ca1acc7097d904d68">APPLY_DISPLACEMENTS</a>, subGridData, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372     <span class="comment">/* copy hidden elements for this level */</span>
<a name="l01373"></a>01373     <span class="keywordflow">if</span> (ccgdm)
<a name="l01374"></a>01374         <a class="code" href="../../d5/de0/multires_8c.html#a167c40cb0bb7b0a91ea79ede0378145b">multires_output_hidden_to_ccgdm</a>(ccgdm, me, lvl);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     <span class="keywordflow">for</span> (i = 0; i &lt; numGrids; i++)
<a name="l01377"></a>01377         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData[i]);
<a name="l01378"></a>01378     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(subGridData);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380     <span class="keywordflow">return</span> result;
<a name="l01381"></a>01381 }
<a name="l01382"></a>01382 
<a name="l01383"></a>01383 <span class="comment">/**** Old Multires code ****</span>
<a name="l01384"></a>01384 <span class="comment"> ***************************/</span>
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 <span class="comment">/* Adapted from sculptmode.c */</span>
<a name="l01387"></a><a class="code" href="../../d5/de0/multires_8c.html#a7402af6e4f3142fa1acf39fe531e531e">01387</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a7402af6e4f3142fa1acf39fe531e531e">old_mdisps_bilinear</a>(<span class="keywordtype">float</span> out[3], <span class="keywordtype">float</span> (*disps)[3], <span class="keyword">const</span> <span class="keywordtype">int</span> st, <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v)
<a name="l01388"></a>01388 {
<a name="l01389"></a>01389     <span class="keywordtype">int</span> x, y, x2, y2;
<a name="l01390"></a>01390     <span class="keyword">const</span> <span class="keywordtype">int</span> st_max = st - 1;
<a name="l01391"></a>01391     <span class="keywordtype">float</span> urat, vrat, uopp;
<a name="l01392"></a>01392     <span class="keywordtype">float</span> d[4][3], d2[2][3];
<a name="l01393"></a>01393     
<a name="l01394"></a>01394     <span class="keywordflow">if</span> (!disps || <a class="code" href="../../d1/d22/stdosl_8h.html#a04f8ed7ab399e64ec13a184438279a23">isnan</a>(u) || <a class="code" href="../../d1/d22/stdosl_8h.html#a04f8ed7ab399e64ec13a184438279a23">isnan</a>(v))
<a name="l01395"></a>01395         <span class="keywordflow">return</span>;
<a name="l01396"></a>01396             
<a name="l01397"></a>01397     <span class="keywordflow">if</span> (u &lt; 0)
<a name="l01398"></a>01398         u = 0;
<a name="l01399"></a>01399     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u &gt;= st)
<a name="l01400"></a>01400         u = st_max;
<a name="l01401"></a>01401     <span class="keywordflow">if</span> (v &lt; 0)
<a name="l01402"></a>01402         v = 0;
<a name="l01403"></a>01403     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v &gt;= st)
<a name="l01404"></a>01404         v = st_max;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     x = floor(u);
<a name="l01407"></a>01407     y = floor(v);
<a name="l01408"></a>01408     x2 = x + 1;
<a name="l01409"></a>01409     y2 = y + 1;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     <span class="keywordflow">if</span> (x2 &gt;= st) x2 = st_max;
<a name="l01412"></a>01412     <span class="keywordflow">if</span> (y2 &gt;= st) y2 = st_max;
<a name="l01413"></a>01413     
<a name="l01414"></a>01414     urat = u - x;
<a name="l01415"></a>01415     vrat = v - y;
<a name="l01416"></a>01416     uopp = 1 - urat;
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(d[0], disps[y * st + x], uopp);
<a name="l01419"></a>01419     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(d[1], disps[y * st + x2], urat);
<a name="l01420"></a>01420     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(d[2], disps[y2 * st + x], uopp);
<a name="l01421"></a>01421     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(d[3], disps[y2 * st + x2], urat);
<a name="l01422"></a>01422 
<a name="l01423"></a>01423     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(d2[0], d[0], d[1]);
<a name="l01424"></a>01424     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(d2[1], d[2], d[3]);
<a name="l01425"></a>01425     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(d2[0], 1 - vrat);
<a name="l01426"></a>01426     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(d2[1], vrat);
<a name="l01427"></a>01427 
<a name="l01428"></a>01428     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(out, d2[0], d2[1]);
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a><a class="code" href="../../d5/de0/multires_8c.html#a1f3d66ea37a227248ad5c933faa28156">01431</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a1f3d66ea37a227248ad5c933faa28156">old_mdisps_rotate</a>(<span class="keywordtype">int</span> S, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(newside), <span class="keywordtype">int</span> oldside, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">float</span> *u, <span class="keywordtype">float</span> *v)
<a name="l01432"></a>01432 {
<a name="l01433"></a>01433     <span class="keywordtype">float</span> offset = oldside*0.5f - 0.5f;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     <span class="keywordflow">if</span> (S == 1) { *u= offset + x; *v = offset - y; }
<a name="l01436"></a>01436     <span class="keywordflow">if</span> (S == 2) { *u= offset + y; *v = offset + x; }
<a name="l01437"></a>01437     <span class="keywordflow">if</span> (S == 3) { *u= offset - x; *v = offset + y; }
<a name="l01438"></a>01438     <span class="keywordflow">if</span> (S == 0) { *u= offset - y; *v = offset - x; }
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 
<a name="l01441"></a><a class="code" href="../../d5/de0/multires_8c.html#a305823dc12e90fd471459ad3d03e7b04">01441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a305823dc12e90fd471459ad3d03e7b04">old_mdisps_convert</a>(<a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface, <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp)
<a name="l01442"></a>01442 {
<a name="l01443"></a>01443     <span class="keywordtype">int</span> newlvl = <a class="code" href="../../d1/d22/stdosl_8h.html#a652ed6fadc80671ca500c85d11bce898">log</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a>)-1)/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a92428112a5d24721208748774a4f23e6">M_LN2</a>;
<a name="l01444"></a>01444     <span class="keywordtype">int</span> oldlvl = newlvl+1;
<a name="l01445"></a>01445     <span class="keywordtype">int</span> oldside = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[oldlvl];
<a name="l01446"></a>01446     <span class="keywordtype">int</span> newside = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[newlvl];
<a name="l01447"></a>01447     <span class="keywordtype">int</span> nvert = (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)? 4: 3;
<a name="l01448"></a>01448     <span class="keywordtype">int</span> newtotdisp = <a class="code" href="../../d5/de0/multires_8c.html#a25b7349f55d9ff924b63182ed08e036d">multires_grid_tot</a>[newlvl]*nvert;
<a name="l01449"></a>01449     <span class="keywordtype">int</span> x, y, S;
<a name="l01450"></a>01450     float (*disps)[3], (*out)[3], u = 0.0f, v = 0.0f; <span class="comment">/* Quite gcc barking. */</span>
<a name="l01451"></a>01451 
<a name="l01452"></a>01452     disps = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * newtotdisp, <span class="stringliteral">&quot;multires disps&quot;</span>);
<a name="l01453"></a>01453 
<a name="l01454"></a>01454     out = disps;
<a name="l01455"></a>01455     <span class="keywordflow">for</span> (S = 0; S &lt; nvert; S++) {
<a name="l01456"></a>01456         <span class="keywordflow">for</span> (y = 0; y &lt; newside; ++y) {
<a name="l01457"></a>01457             <span class="keywordflow">for</span> (x = 0; x &lt; newside; ++x, ++out) {
<a name="l01458"></a>01458                 <a class="code" href="../../d5/de0/multires_8c.html#a1f3d66ea37a227248ad5c933faa28156">old_mdisps_rotate</a>(S, newside, oldside, x, y, &amp;u, &amp;v);
<a name="l01459"></a>01459                 <a class="code" href="../../d1/d37/BKE__multires_8h.html#a7402af6e4f3142fa1acf39fe531e531e">old_mdisps_bilinear</a>(*out, mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>, oldside, u, v);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461                 <span class="keywordflow">if</span> (S == 1) { (*out)[1]= -(*out)[1]; }
<a name="l01462"></a>01462                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 2) { <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, (*out)[0], (*out)[1]); }
<a name="l01463"></a>01463                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 3) { (*out)[0]= -(*out)[0]; }
<a name="l01464"></a>01464                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 0) { <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, (*out)[0], (*out)[1]); (*out)[0]= -(*out)[0]; (*out)[1]= -(*out)[1]; };
<a name="l01465"></a>01465             }
<a name="l01466"></a>01466         }
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>);
<a name="l01470"></a>01470 
<a name="l01471"></a>01471     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a>= newtotdisp;
<a name="l01472"></a>01472     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a>= newlvl;
<a name="l01473"></a>01473     mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>= disps;
<a name="l01474"></a>01474 }
<a name="l01475"></a>01475 
<a name="l01476"></a><a class="code" href="../../d5/de0/multires_8c.html#ad1826ee28cb0fd9215203018c2fc3b9b">01476</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a7db1d869c03bb552253e4a561e7e6db2">multires_load_old_250</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l01477"></a>01477 {
<a name="l01478"></a>01478     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps, *mdisps2;
<a name="l01479"></a>01479     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l01480"></a>01480     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482     mdisps= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l01483"></a>01483 
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (mdisps) {
<a name="l01485"></a>01485         <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; i++)
<a name="l01486"></a>01486             <span class="keywordflow">if</span> (mdisps[i].totdisp)
<a name="l01487"></a>01487                 <a class="code" href="../../d5/de0/multires_8c.html#a305823dc12e90fd471459ad3d03e7b04">old_mdisps_convert</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[i], &amp;mdisps[i]);
<a name="l01488"></a>01488         
<a name="l01489"></a>01489         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l01490"></a>01490         mdisps2 = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l01491"></a>01491 
<a name="l01492"></a>01492         k = 0;
<a name="l01493"></a>01493         mf = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l01494"></a>01494         <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; i++, mf++) {
<a name="l01495"></a>01495             <span class="keywordtype">int</span> nvert = mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3;
<a name="l01496"></a>01496             <span class="keywordtype">int</span> totdisp = mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> / nvert;
<a name="l01497"></a>01497             
<a name="l01498"></a>01498             <span class="keywordflow">for</span> (j=0; j &lt; mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3; j++, k++) {
<a name="l01499"></a>01499                 mdisps2[k].<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totdisp, <span class="stringliteral">&quot;multires disp in conversion&quot;</span>);         
<a name="l01500"></a>01500                 mdisps2[k].<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = totdisp;
<a name="l01501"></a>01501                 mdisps2[k].<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a> = mdisps[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d81/structMDisps.html#a95e9bed7045e91c5519f32008f7aafbf">level</a>;
<a name="l01502"></a>01502                 memcpy(mdisps2[k].disps, mdisps[i].disps + totdisp*j, totdisp);
<a name="l01503"></a>01503             }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505         }
<a name="l01506"></a>01506     }
<a name="l01507"></a>01507 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509 <span class="comment">/* Does not actually free lvl itself */</span>
<a name="l01510"></a><a class="code" href="../../d5/de0/multires_8c.html#ae473282e803a23c98dd2a07e71d5575a">01510</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#ae473282e803a23c98dd2a07e71d5575a">multires_free_level</a>(<a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl)
<a name="l01511"></a>01511 {
<a name="l01512"></a>01512     <span class="keywordflow">if</span> (lvl) {
<a name="l01513"></a>01513         <span class="keywordflow">if</span> (lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>);
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>);
<a name="l01515"></a>01515         <span class="keywordflow">if</span> (lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#ab7d7cc509af818af3a4d4dcdc4f99e24">colfaces</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#ab7d7cc509af818af3a4d4dcdc4f99e24">colfaces</a>);
<a name="l01516"></a>01516     }
<a name="l01517"></a>01517 }
<a name="l01518"></a>01518 
<a name="l01519"></a><a class="code" href="../../d5/de0/multires_8c.html#af69d103488667212f91a3d3da3e6b009">01519</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a21c4cb14ddd151c4242efa17a79ff035">multires_free</a>(<a class="code" href="../../dc/de4/structMultires.html">Multires</a> *mr)
<a name="l01520"></a>01520 {
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (mr) {
<a name="l01522"></a>01522         <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a>* lvl= mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#aae3b346e0ae3e69735b50c4703b09d48">levels</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01523"></a>01523 
<a name="l01524"></a>01524         <span class="comment">/* Free the first-level data */</span>
<a name="l01525"></a>01525         <span class="keywordflow">if</span> (lvl) {
<a name="l01526"></a>01526             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a0526eb7aea9c149b86b71ca6950b81ce">vdata</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>);
<a name="l01527"></a>01527             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a0f1b5e530cdd9f12b16a46f83d21eec9">fdata</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>);
<a name="l01528"></a>01528             <span class="keywordflow">if</span> (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#aa2f6c2c080c465f0673e58fac552abe6">edge_flags</a>)
<a name="l01529"></a>01529                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#aa2f6c2c080c465f0673e58fac552abe6">edge_flags</a>);
<a name="l01530"></a>01530             <span class="keywordflow">if</span> (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#ac142c5d66a084d9a369390afc530737e">edge_creases</a>)
<a name="l01531"></a>01531                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#ac142c5d66a084d9a369390afc530737e">edge_creases</a>);
<a name="l01532"></a>01532         }
<a name="l01533"></a>01533 
<a name="l01534"></a>01534         <span class="keywordflow">while</span> (lvl) {
<a name="l01535"></a>01535             <a class="code" href="../../d5/de0/multires_8c.html#ae473282e803a23c98dd2a07e71d5575a">multires_free_level</a>(lvl);           
<a name="l01536"></a>01536             lvl= lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01537"></a>01537         }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a972d2b74488417d9f6bd5d6ed10a4f27">verts</a>);
<a name="l01540"></a>01540 
<a name="l01541"></a>01541         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#aae3b346e0ae3e69735b50c4703b09d48">levels</a>);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mr);
<a name="l01544"></a>01544     }
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a><a class="code" href="../../d5/de0/multires_8c.html#ad0a2f634ebce102a020cbc882b4d2575">01547</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#ad0a2f634ebce102a020cbc882b4d2575">create_old_vert_face_map</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **map, <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> **mem, <span class="keyword">const</span> <a class="code" href="../../de/d9c/structMultiresFace.html">MultiresFace</a> *mface,
<a name="l01548"></a>01548                      <span class="keyword">const</span> <span class="keywordtype">int</span> totvert, <span class="keyword">const</span> <span class="keywordtype">int</span> totface)
<a name="l01549"></a>01549 {
<a name="l01550"></a>01550     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j;
<a name="l01551"></a>01551     <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> *node = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01552"></a>01552     
<a name="l01553"></a>01553     (*map) = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>) * totvert, <span class="stringliteral">&quot;vert face map&quot;</span>);
<a name="l01554"></a>01554     (*mem) = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a>) * totface*4, <span class="stringliteral">&quot;vert face map mem&quot;</span>);
<a name="l01555"></a>01555     node = *mem;
<a name="l01556"></a>01556     
<a name="l01557"></a>01557     <span class="comment">/* Find the users */</span>
<a name="l01558"></a>01558     <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01559"></a>01559         <span class="keywordflow">for</span> (j = 0; j &lt; (mface[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[3]?4:3); ++j, ++node) {
<a name="l01560"></a>01560             node-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01561"></a>01561             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;(*map)[mface[i].v[j]], node);
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01566"></a><a class="code" href="../../d5/de0/multires_8c.html#a880f9745323bcab134572261a987f006">01566</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a880f9745323bcab134572261a987f006">create_old_vert_edge_map</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **map, <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> **mem, <span class="keyword">const</span> <a class="code" href="../../d1/d8a/structMultiresEdge.html">MultiresEdge</a> *medge,
<a name="l01567"></a>01567                      <span class="keyword">const</span> <span class="keywordtype">int</span> totvert, <span class="keyword">const</span> <span class="keywordtype">int</span> totedge)
<a name="l01568"></a>01568 {
<a name="l01569"></a>01569     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j;
<a name="l01570"></a>01570     <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> *node = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01571"></a>01571     
<a name="l01572"></a>01572     (*map) = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>) * totvert, <span class="stringliteral">&quot;vert edge map&quot;</span>);
<a name="l01573"></a>01573     (*mem) = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a>) * totedge*2, <span class="stringliteral">&quot;vert edge map mem&quot;</span>);
<a name="l01574"></a>01574     node = *mem;
<a name="l01575"></a>01575     
<a name="l01576"></a>01576     <span class="comment">/* Find the users */</span>
<a name="l01577"></a>01577     <span class="keywordflow">for</span> (i = 0; i &lt; totedge; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01578"></a>01578         <span class="keywordflow">for</span> (j = 0; j &lt; 2; ++j, ++node) {
<a name="l01579"></a>01579             node-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01580"></a>01580             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;(*map)[medge[i].v[j]], node);
<a name="l01581"></a>01581         }
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583 }
<a name="l01584"></a>01584 
<a name="l01585"></a><a class="code" href="../../d5/de0/multires_8c.html#ae68ad9305cf5c3abe9e624e036e27936">01585</a> <span class="keyword">static</span> <a class="code" href="../../de/d9c/structMultiresFace.html">MultiresFace</a> *<a class="code" href="../../d5/de0/multires_8c.html#ae68ad9305cf5c3abe9e624e036e27936">find_old_face</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *map, <a class="code" href="../../de/d9c/structMultiresFace.html">MultiresFace</a> *faces, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> v3, <span class="keywordtype">int</span> v4)
<a name="l01586"></a>01586 {
<a name="l01587"></a>01587     <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> *n1;
<a name="l01588"></a>01588     <span class="keywordtype">int</span> v[4], <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01589"></a>01589 
<a name="l01590"></a>01590     v[0]= v1;
<a name="l01591"></a>01591     v[1]= v2;
<a name="l01592"></a>01592     v[2]= v3;
<a name="l01593"></a>01593     v[3]= v4;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="keywordflow">for</span> (n1 = map[v1].first; n1; n1 = n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#a9fa1e8eacc28f05da19c63ce9de30cb8">next</a>) {
<a name="l01596"></a>01596         <span class="keywordtype">int</span> fnd[4] = {0, 0, 0, 0};
<a name="l01597"></a>01597 
<a name="l01598"></a>01598         <span class="keywordflow">for</span> (i = 0; i &lt; 4; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01599"></a>01599             <span class="keywordflow">for</span> (j = 0; j &lt; 4; ++j) {
<a name="l01600"></a>01600                 <span class="keywordflow">if</span> (v[i] == faces[n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[j])
<a name="l01601"></a>01601                     fnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 1;
<a name="l01602"></a>01602             }
<a name="l01603"></a>01603         }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605         <span class="keywordflow">if</span> (fnd[0] &amp;&amp; fnd[1] &amp;&amp; fnd[2] &amp;&amp; fnd[3])
<a name="l01606"></a>01606             <span class="keywordflow">return</span> &amp;faces[n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a>];
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01610"></a>01610 }
<a name="l01611"></a>01611 
<a name="l01612"></a><a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">01612</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structMultiresEdge.html">MultiresEdge</a> *<a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *map, <a class="code" href="../../d1/d8a/structMultiresEdge.html">MultiresEdge</a> *edges, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614     <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> *n1, *n2;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <span class="keywordflow">for</span> (n1 = map[v1].first; n1; n1 = n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#a9fa1e8eacc28f05da19c63ce9de30cb8">next</a>) {
<a name="l01617"></a>01617         <span class="keywordflow">for</span> (n2 = map[v2].first; n2; n2 = n2-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#a9fa1e8eacc28f05da19c63ce9de30cb8">next</a>) {
<a name="l01618"></a>01618             <span class="keywordflow">if</span> (n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a> == n2-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a>)
<a name="l01619"></a>01619                 <span class="keywordflow">return</span> &amp;edges[n1-&gt;<a class="code" href="../../d6/dce/structIndexNode.html#aab4a18168dc50e97eb22c4d6d0e129b4">index</a>];
<a name="l01620"></a>01620         }
<a name="l01621"></a>01621     }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01624"></a>01624 }
<a name="l01625"></a>01625 
<a name="l01626"></a><a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">01626</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **emap, <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl, <span class="keywordtype">int</span> *vvmap, <span class="keywordtype">int</span> dst, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> mov)
<a name="l01627"></a>01627 {
<a name="l01628"></a>01628     <span class="keywordtype">int</span> emid = <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[2], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, v1, v2)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>;
<a name="l01629"></a>01629     vvmap[dst + mov] = emid;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="keywordflow">if</span> (lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>) {
<a name="l01632"></a>01632         <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst + mov, v1, emid, mov / 2);
<a name="l01633"></a>01633         <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst + mov, v2, emid, -mov / 2);
<a name="l01634"></a>01634     }
<a name="l01635"></a>01635 }
<a name="l01636"></a>01636 
<a name="l01637"></a><a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">01637</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **fmap, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **emap, <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl, <span class="keywordtype">int</span> *vvmap, <span class="keywordtype">int</span> dst,
<a name="l01638"></a>01638                     <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> v3, <span class="keywordtype">int</span> v4, <span class="keywordtype">int</span> st2, <span class="keywordtype">int</span> st3)
<a name="l01639"></a>01639 {
<a name="l01640"></a>01640     <span class="keywordtype">int</span> fmid;
<a name="l01641"></a>01641     <span class="keywordtype">int</span> emid13, emid14, emid23, emid24;
<a name="l01642"></a>01642 
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (lvl &amp;&amp; lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>) {
<a name="l01644"></a>01644         fmid = <a class="code" href="../../d5/de0/multires_8c.html#ae68ad9305cf5c3abe9e624e036e27936">find_old_face</a>(fmap[1], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>, v1, v2, v3, v4)-&gt;<a class="code" href="../../de/d9c/structMultiresFace.html#ada1cef01569cbaa2a2821f5c545b80e9">mid</a>;
<a name="l01645"></a>01645         vvmap[dst] = fmid;
<a name="l01646"></a>01646 
<a name="l01647"></a>01647         emid13 = <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[1], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, v1, v3)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>;
<a name="l01648"></a>01648         emid14 = <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[1], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, v1, v4)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>;
<a name="l01649"></a>01649         emid23 = <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[1], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, v2, v3)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>;
<a name="l01650"></a>01650         emid24 = <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[1], lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, v2, v4)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 
<a name="l01653"></a>01653         <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(fmap + 1, emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst + st2 * st3 + st3,
<a name="l01654"></a>01654                     fmid, v2, emid23, emid24, st2, st3 / 2);
<a name="l01655"></a>01655 
<a name="l01656"></a>01656         <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(fmap + 1, emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst - st2 * st3 + st3,
<a name="l01657"></a>01657                     emid14, emid24, fmid, v4, st2, st3 / 2);
<a name="l01658"></a>01658 
<a name="l01659"></a>01659         <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(fmap + 1, emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst + st2 * st3 - st3,
<a name="l01660"></a>01660                     emid13, emid23, v3, fmid, st2, st3 / 2);
<a name="l01661"></a>01661 
<a name="l01662"></a>01662         <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(fmap + 1, emap + 1, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst - st2 * st3 - st3,
<a name="l01663"></a>01663                     v1, fmid, emid13, emid14, st2, st3 / 2);
<a name="l01664"></a>01664 
<a name="l01665"></a>01665         <span class="keywordflow">if</span> (lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>) {
<a name="l01666"></a>01666             <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst, emid24, fmid, st3);
<a name="l01667"></a>01667             <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst, emid13, fmid, -st3);
<a name="l01668"></a>01668             <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst, emid14, fmid, -st2 * st3);
<a name="l01669"></a>01669             <a class="code" href="../../d5/de0/multires_8c.html#a598d4761e1062549abeb3b3d36dc4a8d">multires_load_old_edges</a>(emap, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, dst, emid23, fmid, st2 * st3);
<a name="l01670"></a>01670         }
<a name="l01671"></a>01671     }
<a name="l01672"></a>01672 }
<a name="l01673"></a>01673 
<a name="l01674"></a><a class="code" href="../../d5/de0/multires_8c.html#afebbb61f3e8f7965520c4c32aa4338d2">01674</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#afebbb61f3e8f7965520c4c32aa4338d2">multires_mvert_to_ss</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676     <a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a> *ccgdm = (<a class="code" href="../../d4/d67/structCCGDerivedMesh.html">CCGDerivedMesh</a>*) dm;
<a name="l01677"></a>01677     <a class="code" href="../../d7/d07/structCCGSubSurf.html">CCGSubSurf</a> *ss = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a3fea726d390c252c3bf46119fa6a6237">ss</a>;
<a name="l01678"></a>01678     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *vd;
<a name="l01679"></a>01679     <span class="keywordtype">int</span> index;
<a name="l01680"></a>01680     <span class="keywordtype">int</span> totvert, totedge, totface;
<a name="l01681"></a>01681     <span class="keywordtype">int</span> gridSize = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a98404dcdc9187d858be9a3d67ecd3477">ccgSubSurf_getGridSize</a>(ss);
<a name="l01682"></a>01682     <span class="keywordtype">int</span> edgeSize = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#ad2bb81a671209c57531d620346423308">ccgSubSurf_getEdgeSize</a>(ss);
<a name="l01683"></a>01683     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     totface = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a0c28e8aea6fefb386f38a17e2ae637bd">ccgSubSurf_getNumFaces</a>(ss);
<a name="l01686"></a>01686     <span class="keywordflow">for</span> (index = 0; index &lt; totface; index++) {
<a name="l01687"></a>01687         <a class="code" href="../../df/d72/structCCGFace.html">CCGFace</a> *f = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a8c4091f85b53bf137003eae7464c8d7d">faceMap</a>[index].<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#ac687ed02b2fbd0d7d56401d39390f051">face</a>;
<a name="l01688"></a>01688         <span class="keywordtype">int</span> x, y, S, numVerts = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#af116d593721a78916b3c9d205b5c8686">ccgSubSurf_getFaceNumVerts</a>(f);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690         vd= <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#aa6faf3814134e5efa17e57b49cf14de1">ccgSubSurf_getFaceCenterData</a>(f);
<a name="l01691"></a>01691         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vd-&gt;<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>, mvert[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01692"></a>01692         i++;
<a name="l01693"></a>01693         
<a name="l01694"></a>01694         <span class="keywordflow">for</span> (S = 0; S &lt; numVerts; S++) {
<a name="l01695"></a>01695             <span class="keywordflow">for</span> (x = 1; x &lt; gridSize - 1; x++, i++) {
<a name="l01696"></a>01696                 vd= <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#aa159f32d8b3285738247f5c028597ebe">ccgSubSurf_getFaceGridEdgeData</a>(ss, f, S, x);
<a name="l01697"></a>01697                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vd-&gt;<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>, mvert[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01698"></a>01698             }
<a name="l01699"></a>01699         }
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         <span class="keywordflow">for</span> (S = 0; S &lt; numVerts; S++) {
<a name="l01702"></a>01702             <span class="keywordflow">for</span> (y = 1; y &lt; gridSize - 1; y++) {
<a name="l01703"></a>01703                 <span class="keywordflow">for</span> (x = 1; x &lt; gridSize - 1; x++, i++) {
<a name="l01704"></a>01704                     vd= <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a78473ca2ba64bac0e2c7e8a4cc988026">ccgSubSurf_getFaceGridData</a>(ss, f, S, x, y);
<a name="l01705"></a>01705                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vd-&gt;<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>, mvert[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01706"></a>01706                 }
<a name="l01707"></a>01707             }
<a name="l01708"></a>01708         }
<a name="l01709"></a>01709     }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711     totedge = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#abf9636250ad6417b5843763978a98eef">ccgSubSurf_getNumEdges</a>(ss);
<a name="l01712"></a>01712     <span class="keywordflow">for</span> (index = 0; index &lt; totedge; index++) {
<a name="l01713"></a>01713         <a class="code" href="../../d4/d7f/structCCGEdge.html">CCGEdge</a> *e = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a19d3f241092608e2d05a5124caa0515d">edgeMap</a>[index].<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#aa67dbbe7595c9d85a2a7c28bab05d46d">edge</a>;
<a name="l01714"></a>01714         <span class="keywordtype">int</span> x;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <span class="keywordflow">for</span> (x = 1; x &lt; edgeSize - 1; x++, i++) {
<a name="l01717"></a>01717             vd= <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#ac6fb0578104f1b437fa4268cee403e78">ccgSubSurf_getEdgeData</a>(ss, e, x);
<a name="l01718"></a>01718             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vd-&gt;<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>, mvert[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01719"></a>01719         }
<a name="l01720"></a>01720     }
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     totvert = <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a4ba838737ee4647222f95406698d0b1b">ccgSubSurf_getNumVerts</a>(ss);
<a name="l01723"></a>01723     <span class="keywordflow">for</span> (index = 0; index &lt; totvert; index++) {
<a name="l01724"></a>01724         <a class="code" href="../../d8/d15/structCCGVert.html">CCGVert</a> *v = ccgdm-&gt;<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a885a7edcf1d2c11dd67898c817b265a5">vertMap</a>[index].<a class="code" href="../../d4/d67/structCCGDerivedMesh.html#a29a0a5bf156f73420655a10871231cdf">vert</a>;
<a name="l01725"></a>01725 
<a name="l01726"></a>01726         vd= <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a36cbb6a7c58e888b227b15dcfa37a696">ccgSubSurf_getVertData</a>(ss, v);
<a name="l01727"></a>01727         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vd-&gt;<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>, mvert[i].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01728"></a>01728         i++;
<a name="l01729"></a>01729     }
<a name="l01730"></a>01730 
<a name="l01731"></a>01731     <a class="code" href="../../d9/d9a/CCGSubSurf_8c.html#a368185f9241e1ace917f66bd55c14396">ccgSubSurf_updateToFaces</a>(ss, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01732"></a>01732 }
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 <span class="comment">/* Loads a multires object stored in the old Multires struct into the new format */</span>
<a name="l01735"></a><a class="code" href="../../d5/de0/multires_8c.html#a6ec5ff93364636a4d22bef98e119c9c9">01735</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a6ec5ff93364636a4d22bef98e119c9c9">multires_load_old_dm</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> totlvl)
<a name="l01736"></a>01736 {
<a name="l01737"></a>01737     <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl, *lvl1;
<a name="l01738"></a>01738     <a class="code" href="../../dc/de4/structMultires.html">Multires</a> *mr= me-&gt;mr;
<a name="l01739"></a>01739     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *vsrc, *vdst;
<a name="l01740"></a>01740     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> src, dst;
<a name="l01741"></a>01741     <span class="keywordtype">int</span> st = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - 1] - 1;
<a name="l01742"></a>01742     <span class="keywordtype">int</span> extedgelen = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl] - 2;
<a name="l01743"></a>01743     <span class="keywordtype">int</span> *vvmap; <span class="comment">// inorder for dst, map to src</span>
<a name="l01744"></a>01744     <span class="keywordtype">int</span> crossedgelen;
<a name="l01745"></a>01745     <span class="keywordtype">int</span> s, x, tottri, totquad;
<a name="l01746"></a>01746     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, totvert;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     src = 0;
<a name="l01749"></a>01749     vsrc = mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a972d2b74488417d9f6bd5d6ed10a4f27">verts</a>;
<a name="l01750"></a>01750     vdst = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01751"></a>01751     totvert = (<span class="keywordtype">unsigned</span> int)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01752"></a>01752     vvmap = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * totvert, <span class="stringliteral">&quot;multires vvmap&quot;</span>);
<a name="l01753"></a>01753 
<a name="l01754"></a>01754     lvl1 = mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#aae3b346e0ae3e69735b50c4703b09d48">levels</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01755"></a>01755     <span class="comment">/* Load base verts */</span>
<a name="l01756"></a>01756     <span class="keywordflow">for</span> (i = 0; i &lt; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01757"></a>01757         vvmap[totvert - lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = src;
<a name="l01758"></a>01758         ++src;
<a name="l01759"></a>01759     }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="comment">/* Original edges */</span>
<a name="l01762"></a>01762     dst = totvert - lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a> - extedgelen * lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a>;
<a name="l01763"></a>01763     <span class="keywordflow">for</span> (i = 0; i &lt; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01764"></a>01764         <span class="keywordtype">int</span> ldst = dst + extedgelen * <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01765"></a>01765         <span class="keywordtype">int</span> lsrc = src;
<a name="l01766"></a>01766         lvl = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="keywordflow">for</span> (j = 2; j &lt;= mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>; ++j) {
<a name="l01769"></a>01769             <span class="keywordtype">int</span> base = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - j + 1] - 2;
<a name="l01770"></a>01770             <span class="keywordtype">int</span> skip = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - j + 2] - 1;
<a name="l01771"></a>01771             <span class="keywordtype">int</span> st = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[j - 1] - 1;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773             <span class="keywordflow">for</span> (x = 0; x &lt; st; ++x)
<a name="l01774"></a>01774                 vvmap[ldst + base + x * skip] = lsrc + st * i + x;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776             lsrc += lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a> - lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#afcbc4c2e9cd07bf423e97c8851eaf2ea">prev</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>;
<a name="l01777"></a>01777             lvl = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01778"></a>01778         }
<a name="l01779"></a>01779     }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     <span class="comment">/* Center points */</span>
<a name="l01782"></a>01782     dst = 0;
<a name="l01783"></a>01783     <span class="keywordflow">for</span> (i = 0; i &lt; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01784"></a>01784         <span class="keywordtype">int</span> sides = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[3] ? 4 : 3;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         vvmap[dst] = src + lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01787"></a>01787         dst += 1 + sides * (st - 1) * st;
<a name="l01788"></a>01788     }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 
<a name="l01791"></a>01791     <span class="comment">/* The rest is only for level 3 and up */</span>
<a name="l01792"></a>01792     <span class="keywordflow">if</span> (lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a> &amp;&amp; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>) {
<a name="l01793"></a>01793         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **fmap, **emap;
<a name="l01794"></a>01794         <a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a> **fmem, **emem;
<a name="l01795"></a>01795 
<a name="l01796"></a>01796         <span class="comment">/* Face edge cross */</span>
<a name="l01797"></a>01797         tottri = totquad = 0;
<a name="l01798"></a>01798         crossedgelen = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - 1] - 2;
<a name="l01799"></a>01799         dst = 0;
<a name="l01800"></a>01800         <span class="keywordflow">for</span> (i = 0; i &lt; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01801"></a>01801             <span class="keywordtype">int</span> sides = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[3] ? 4 : 3;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803             lvl = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01804"></a>01804             ++dst;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806             <span class="keywordflow">for</span> (j = 3; j &lt;= mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>; ++j) {
<a name="l01807"></a>01807                 <span class="keywordtype">int</span> base = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - j + 1] - 2;
<a name="l01808"></a>01808                 <span class="keywordtype">int</span> skip = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - j + 2] - 1;
<a name="l01809"></a>01809                 <span class="keywordtype">int</span> st = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(2, j - 2);
<a name="l01810"></a>01810                 <span class="keywordtype">int</span> st2 = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(2, j - 3);
<a name="l01811"></a>01811                 <span class="keywordtype">int</span> lsrc = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#afcbc4c2e9cd07bf423e97c8851eaf2ea">prev</a>-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>;
<a name="l01812"></a>01812 
<a name="l01813"></a>01813                 <span class="comment">/* Skip exterior edge verts */</span>
<a name="l01814"></a>01814                 lsrc += lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a> * st;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816                 <span class="comment">/* Skip earlier face edge crosses */</span>
<a name="l01817"></a>01817                 lsrc += st2 * (tottri * 3 + totquad * 4);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819                 <span class="keywordflow">for</span> (s = 0; s &lt; sides; ++s) {
<a name="l01820"></a>01820                     <span class="keywordflow">for</span> (x = 0; x &lt; st2; ++x) {
<a name="l01821"></a>01821                         vvmap[dst + crossedgelen * (s + 1) - base - x * skip - 1] = lsrc;
<a name="l01822"></a>01822                         ++lsrc;
<a name="l01823"></a>01823                     }
<a name="l01824"></a>01824                 }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826                 lvl = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01827"></a>01827             }
<a name="l01828"></a>01828 
<a name="l01829"></a>01829             dst += sides * (st - 1) * st;
<a name="l01830"></a>01830 
<a name="l01831"></a>01831             <span class="keywordflow">if</span> (sides == 4) ++totquad;
<a name="l01832"></a>01832             <span class="keywordflow">else</span> ++tottri;
<a name="l01833"></a>01833 
<a name="l01834"></a>01834         }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836         <span class="comment">/* calculate vert to edge/face maps for each level (except the last) */</span>
<a name="l01837"></a>01837         fmap = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>*) * (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>-1), <span class="stringliteral">&quot;multires fmap&quot;</span>);
<a name="l01838"></a>01838         emap = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>*) * (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>-1), <span class="stringliteral">&quot;multires emap&quot;</span>);
<a name="l01839"></a>01839         fmem = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a>*) * (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>-1), <span class="stringliteral">&quot;multires fmem&quot;</span>);
<a name="l01840"></a>01840         emem = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/dce/structIndexNode.html">IndexNode</a>*) * (mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a>-1), <span class="stringliteral">&quot;multires emem&quot;</span>);
<a name="l01841"></a>01841         lvl = lvl1;
<a name="l01842"></a>01842         <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">unsigned</span> int)mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a> - 1; ++i) {
<a name="l01843"></a>01843             <a class="code" href="../../d5/de0/multires_8c.html#ad0a2f634ebce102a020cbc882b4d2575">create_old_vert_face_map</a>(fmap + i, fmem + i, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>);
<a name="l01844"></a>01844             <a class="code" href="../../d5/de0/multires_8c.html#a880f9745323bcab134572261a987f006">create_old_vert_edge_map</a>(emap + i, emem + i, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a>);
<a name="l01845"></a>01845             lvl = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>;
<a name="l01846"></a>01846         }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848         <span class="comment">/* Interior face verts */</span>
<a name="l01849"></a>01849         <span class="comment">/* lvl = lvl1-&gt;next-&gt;next; */</span> <span class="comment">/* UNUSED */</span>
<a name="l01850"></a>01850         dst = 0;
<a name="l01851"></a>01851         <span class="keywordflow">for</span> (j = 0; j &lt; lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>; ++j) {
<a name="l01852"></a>01852             <span class="keywordtype">int</span> sides = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[j].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[3] ? 4 : 3;
<a name="l01853"></a>01853             <span class="keywordtype">int</span> ldst = dst + 1 + sides * (st - 1);
<a name="l01854"></a>01854 
<a name="l01855"></a>01855             <span class="keywordflow">for</span> (s = 0; s &lt; sides; ++s) {
<a name="l01856"></a>01856                 <span class="keywordtype">int</span> st2 = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - 1] - 2;
<a name="l01857"></a>01857                 <span class="keywordtype">int</span> st3 = <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[totlvl - 2] - 2;
<a name="l01858"></a>01858                 <span class="keywordtype">int</span> st4 = st3 == 0 ? 1 : (st3 + 1) / 2;
<a name="l01859"></a>01859                 <span class="keywordtype">int</span> mid = ldst + st2 * st3 + st3;
<a name="l01860"></a>01860                 <span class="keywordtype">int</span> cv = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[j].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[s];
<a name="l01861"></a>01861                 <span class="keywordtype">int</span> nv = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[j].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[s == sides - 1 ? 0 : s + 1];
<a name="l01862"></a>01862                 <span class="keywordtype">int</span> pv = lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[j].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[s == 0 ? sides - 1 : s - 1];
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                 <a class="code" href="../../d5/de0/multires_8c.html#a963cb7b76073fc7fe1523594bb235153">multires_load_old_faces</a>(fmap, emap, lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a60870f4f7d8dce17d4154b4bf90c8053">next</a>, vvmap, mid,
<a name="l01865"></a>01865                             vvmap[dst], cv,
<a name="l01866"></a>01866                             <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[0], lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, pv, cv)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>,
<a name="l01867"></a>01867                             <a class="code" href="../../d5/de0/multires_8c.html#aa6df67d693175e21a6635182f331944c">find_old_edge</a>(emap[0], lvl1-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>, cv, nv)-&gt;<a class="code" href="../../d1/d8a/structMultiresEdge.html#ade0c2176cdb6b83387c5295fdc6424d7">mid</a>,
<a name="l01868"></a>01868                             st2, st4);
<a name="l01869"></a>01869 
<a name="l01870"></a>01870                 ldst += (st - 1) * (st - 1);
<a name="l01871"></a>01871             }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             dst = ldst;
<a name="l01875"></a>01875         }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877         <span class="comment">/*lvl = lvl-&gt;next;*/</span> <span class="comment">/*UNUSED*/</span>
<a name="l01878"></a>01878 
<a name="l01879"></a>01879         <span class="keywordflow">for</span> (i = 0; i &lt; (<span class="keywordtype">unsigned</span> int)(mr-&gt;<a class="code" href="../../dc/de4/structMultires.html#a38e87a59cd98a4753c76890b37b205a7">level_count</a> - 1); ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01880"></a>01880             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fmap[i]);
<a name="l01881"></a>01881             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fmem[i]);
<a name="l01882"></a>01882             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(emap[i]);
<a name="l01883"></a>01883             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(emem[i]);
<a name="l01884"></a>01884         }
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fmap);
<a name="l01887"></a>01887         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(emap);
<a name="l01888"></a>01888         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fmem);
<a name="l01889"></a>01889         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(emem);
<a name="l01890"></a>01890     }
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <span class="comment">/* Transfer verts */</span>
<a name="l01893"></a>01893     <span class="keywordflow">for</span> (i = 0; i &lt; totvert; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01894"></a>01894         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vdst[i].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, vsrc[vvmap[i]].co);
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vvmap);
<a name="l01897"></a>01897 
<a name="l01898"></a>01898     <a class="code" href="../../d5/de0/multires_8c.html#afebbb61f3e8f7965520c4c32aa4338d2">multires_mvert_to_ss</a>(dm, vdst);
<a name="l01899"></a>01899 }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901 <span class="comment">/* Copy the first-level vcol data to the mesh, if it exists */</span>
<a name="l01902"></a>01902 <span class="comment">/* Warning: higher-level vcol data will be lost */</span>
<a name="l01903"></a><a class="code" href="../../d5/de0/multires_8c.html#ac34a844b699128f9b0e666bb5984fdda">01903</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#ac34a844b699128f9b0e666bb5984fdda">multires_load_old_vcols</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l01904"></a>01904 {
<a name="l01905"></a>01905     <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl;
<a name="l01906"></a>01906     <a class="code" href="../../d2/dbf/structMultiresColFace.html">MultiresColFace</a> *colface;
<a name="l01907"></a>01907     <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mcol;
<a name="l01908"></a>01908     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910     <span class="keywordflow">if</span> (!(lvl = me-&gt;mr-&gt;levels.first))
<a name="l01911"></a>01911         <span class="keywordflow">return</span>;
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     <span class="keywordflow">if</span> (!(colface = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#ab7d7cc509af818af3a4d4dcdc4f99e24">colfaces</a>))
<a name="l01914"></a>01914         <span class="keywordflow">return</span>;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916     <span class="comment">/* older multires format never supported multiple vcol layers,</span>
<a name="l01917"></a>01917 <span class="comment">     * so we can assume the active vcol layer is the correct one */</span>
<a name="l01918"></a>01918     <span class="keywordflow">if</span> (!(mcol = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>)))
<a name="l01919"></a>01919         <span class="keywordflow">return</span>;
<a name="l01920"></a>01920     
<a name="l01921"></a>01921     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01922"></a>01922         <span class="keywordflow">for</span> (j = 0; j &lt; 4; ++j) {
<a name="l01923"></a>01923             mcol[i*4 + j].<a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a> = colface[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dbf/structMultiresColFace.html#ad1f9f6390d03b06c170b7accfccb77d6">col</a>[j].<a class="code" href="../../d4/d5f/structMultiresCol.html#ad248599420d6e2403ac75548bdefedf0">a</a>;
<a name="l01924"></a>01924             mcol[i*4 + j].<a class="code" href="../../db/d33/structMCol.html#accc9f47801208d2eb1f0c7b950e07073">r</a> = colface[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dbf/structMultiresColFace.html#ad1f9f6390d03b06c170b7accfccb77d6">col</a>[j].<a class="code" href="../../d4/d5f/structMultiresCol.html#ad09ddfaa240c287c3e830fb4f74dcdfd">r</a>;
<a name="l01925"></a>01925             mcol[i*4 + j].<a class="code" href="../../db/d33/structMCol.html#a0d8e18b80b44a87f65ac260ed2cbbb4c">g</a> = colface[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dbf/structMultiresColFace.html#ad1f9f6390d03b06c170b7accfccb77d6">col</a>[j].<a class="code" href="../../d4/d5f/structMultiresCol.html#a731b1c2a9add0f4b5d1d87fe2a9e9354">g</a>;
<a name="l01926"></a>01926             mcol[i*4 + j].<a class="code" href="../../db/d33/structMCol.html#a0c1e111507e18eecd82a9add920295d0">b</a> = colface[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d2/dbf/structMultiresColFace.html#ad1f9f6390d03b06c170b7accfccb77d6">col</a>[j].<a class="code" href="../../d4/d5f/structMultiresCol.html#aa462911c37382366a816b79a7a3ce2ca">b</a>;
<a name="l01927"></a>01927         }
<a name="l01928"></a>01928     }
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931 <span class="comment">/* Copy the first-level face-flag data to the mesh */</span>
<a name="l01932"></a><a class="code" href="../../d5/de0/multires_8c.html#a803c857cce94473047f4d47e22f3a7b1">01932</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a803c857cce94473047f4d47e22f3a7b1">multires_load_old_face_flags</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l01933"></a>01933 {
<a name="l01934"></a>01934     <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl;
<a name="l01935"></a>01935     <a class="code" href="../../de/d9c/structMultiresFace.html">MultiresFace</a> *faces;
<a name="l01936"></a>01936     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="keywordflow">if</span> (!(lvl = me-&gt;mr-&gt;levels.first))
<a name="l01939"></a>01939         <span class="keywordflow">return</span>;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941     <span class="keywordflow">if</span> (!(faces = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>))
<a name="l01942"></a>01942         <span class="keywordflow">return</span>;
<a name="l01943"></a>01943 
<a name="l01944"></a>01944     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01945"></a>01945         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[i].<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> = faces[i].<a class="code" href="../../de/d9c/structMultiresFace.html#ada303263b36fcffec4c413fe5a2fe4c3">flag</a>;
<a name="l01946"></a>01946 }
<a name="l01947"></a>01947 
<a name="l01948"></a><a class="code" href="../../d5/de0/multires_8c.html#aef36a8290ab8d9411fc7e278f4f4e609">01948</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#af631d63710c52b941a161a8e599ff093">multires_load_old</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l01949"></a>01949 {
<a name="l01950"></a>01950     <a class="code" href="../../db/d78/structMultiresLevel.html">MultiresLevel</a> *lvl;
<a name="l01951"></a>01951     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l01952"></a>01952     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd;
<a name="l01953"></a>01953     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, *orig;
<a name="l01954"></a>01954     <a class="code" href="../../d5/d97/structCustomDataLayer.html">CustomDataLayer</a> *l;
<a name="l01955"></a>01955     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01956"></a>01956 
<a name="l01957"></a>01957     <span class="comment">/* Load original level into the mesh */</span>
<a name="l01958"></a>01958     lvl = me-&gt;mr-&gt;levels.first;
<a name="l01959"></a>01959     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3f4ef32648ac09c8397fac2aadc9b61d">CustomData_free_layers</a>(&amp;me-&gt;vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>);
<a name="l01960"></a>01960     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3f4ef32648ac09c8397fac2aadc9b61d">CustomData_free_layers</a>(&amp;me-&gt;edata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a>);
<a name="l01961"></a>01961     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3f4ef32648ac09c8397fac2aadc9b61d">CustomData_free_layers</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>, lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>);
<a name="l01962"></a>01962     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a3bca18308d09f1fb7b145486520fca4e">totvert</a>;
<a name="l01963"></a>01963     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a8174faeaf5b232da149e653c38c784b5">totedge</a>;
<a name="l01964"></a>01964     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a5728f1d1a4bc284aa4e20bb6a6a8ca94">totface</a>;
<a name="l01965"></a>01965     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l01966"></a>01966     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a06722494d8fa0bf3af4b2d2b490da8dc">medge</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;edata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>);
<a name="l01967"></a>01967     me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l01968"></a>01968     memcpy(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>, me-&gt;mr-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/de5/structMVert.html">MVert</a>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l01969"></a>01969     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01970"></a>01970         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a06722494d8fa0bf3af4b2d2b490da8dc">medge</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d1/d8a/structMultiresEdge.html#a63cb9774511fbf3f535b5948ad1319bf">v</a>[0];
<a name="l01971"></a>01971         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a06722494d8fa0bf3af4b2d2b490da8dc">medge</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a4729500c54a43b85c0576ad628e1a691">edges</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d1/d8a/structMultiresEdge.html#a63cb9774511fbf3f535b5948ad1319bf">v</a>[1];
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01974"></a>01974         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[0];
<a name="l01975"></a>01975         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[1];
<a name="l01976"></a>01976         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[2];
<a name="l01977"></a>01977         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#a5395bafc1a9bebef12e4636772d93644">v</a>[3];
<a name="l01978"></a>01978         me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> = lvl-&gt;<a class="code" href="../../db/d78/structMultiresLevel.html#a076ed725b0a7040c84220194dfbdccb0">faces</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../de/d9c/structMultiresFace.html#afbf9f182e46ace574d24942e31be750e">mat_nr</a>;
<a name="l01979"></a>01979     }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981     <span class="comment">/* Add a multires modifier to the object */</span>
<a name="l01982"></a>01982     md = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01983"></a>01983     <span class="keywordflow">while</span> (md &amp;&amp; <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>)-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>)
<a name="l01984"></a>01984         md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>;                          
<a name="l01985"></a>01985     mmd = (<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a>*)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ad792bc6e3890679e671ffd17a10194c5">modifier_new</a>(<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a>);
<a name="l01986"></a>01986     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>, md, mmd);
<a name="l01987"></a>01987 
<a name="l01988"></a>01988     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;mr-&gt;level_count - 1; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01989"></a>01989         <a class="code" href="../../d1/d37/BKE__multires_8h.html#a35ffc6de70d2a5db0c381eee7607c534">multiresModifier_subdivide</a>(mmd, ob, 1, 0);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991     mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a> = mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l01992"></a>01992     orig = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01993"></a>01993     dm = <a class="code" href="../../d1/d37/BKE__multires_8h.html#a2bc39adcf1c2a2c78ca9c59be60b8d0f">multires_dm_create_from_derived</a>(mmd, 0, orig, ob, 0);
<a name="l01994"></a>01994                        
<a name="l01995"></a>01995     <a class="code" href="../../d5/de0/multires_8c.html#a6ec5ff93364636a4d22bef98e119c9c9">multires_load_old_dm</a>(dm, me, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>+1);
<a name="l01996"></a>01996 
<a name="l01997"></a>01997     <a class="code" href="../../d5/de0/multires_8c.html#a6ef8b9c28919655a9cd68c68900cdd67">multires_dm_mark_as_modified</a>(dm, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4ad2bf78fc26652a42e8e000bb7a190d09">MULTIRES_COORDS_MODIFIED</a>);
<a name="l01998"></a>01998     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01999"></a>01999     orig-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(orig);
<a name="l02000"></a>02000 
<a name="l02001"></a>02001     <span class="comment">/* Copy the first-level data to the mesh */</span>
<a name="l02002"></a>02002     <span class="keywordflow">for</span> (i = 0, l = me-&gt;mr-&gt;vdata.layers; i &lt; me-&gt;mr-&gt;vdata.totlayer; ++i, ++l)
<a name="l02003"></a>02003         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;vdata, l-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7c7345e54e02ab3da279ce5f0a3fff3d">CD_REFERENCE</a>, l-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l02004"></a>02004     <span class="keywordflow">for</span> (i = 0, l = me-&gt;mr-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>; i &lt; me-&gt;mr-&gt;fdata.totlayer; ++i, ++l)
<a name="l02005"></a>02005         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, l-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7c7345e54e02ab3da279ce5f0a3fff3d">CD_REFERENCE</a>, l-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l02006"></a>02006     memset(&amp;me-&gt;mr-&gt;vdata, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d04/structCustomData.html">CustomData</a>));
<a name="l02007"></a>02007     memset(&amp;me-&gt;mr-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d04/structCustomData.html">CustomData</a>));
<a name="l02008"></a>02008 
<a name="l02009"></a>02009     <a class="code" href="../../d5/de0/multires_8c.html#ac34a844b699128f9b0e666bb5984fdda">multires_load_old_vcols</a>(me);
<a name="l02010"></a>02010     <a class="code" href="../../d5/de0/multires_8c.html#a803c857cce94473047f4d47e22f3a7b1">multires_load_old_face_flags</a>(me);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012     <span class="comment">/* Remove the old multires */</span>
<a name="l02013"></a>02013     <a class="code" href="../../d1/d37/BKE__multires_8h.html#a21c4cb14ddd151c4242efa17a79ff035">multires_free</a>(me-&gt;mr);
<a name="l02014"></a>02014     me-&gt;mr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02015"></a>02015 }
<a name="l02016"></a>02016 
<a name="l02017"></a><a class="code" href="../../d5/de0/multires_8c.html#a2bd7b8ede5d3c823f621e88445de5040">02017</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#a2bd7b8ede5d3c823f621e88445de5040">multires_sync_levels</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *to_ob)
<a name="l02018"></a>02018 {
<a name="l02019"></a>02019     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 1);
<a name="l02020"></a>02020     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *to_mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, to_ob, 1);
<a name="l02021"></a>02021 
<a name="l02022"></a>02022     <span class="keywordflow">if</span> (!mmd) {
<a name="l02023"></a>02023         <span class="comment">/* object could have MDISP even when there is no multires modifier</span>
<a name="l02024"></a>02024 <span class="comment">         * this could lead to troubles due to i&#39;ve got no idea how mdisp could be</span>
<a name="l02025"></a>02025 <span class="comment">         * upsampled correct without modifier data.</span>
<a name="l02026"></a>02026 <span class="comment">         * just remove mdisps if no multires present (nazgul) */</span>
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         <a class="code" href="../../d1/d37/BKE__multires_8h.html#a86414e7ca2b7b411173758afd892a2b1">multires_customdata_delete</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>);
<a name="l02029"></a>02029     }
<a name="l02030"></a>02030 
<a name="l02031"></a>02031     <span class="keywordflow">if</span> (!mmd || !to_mmd) <span class="keywordflow">return</span>;
<a name="l02032"></a>02032 
<a name="l02033"></a>02033     <span class="keywordflow">if</span> (mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>&gt;to_mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>) <a class="code" href="../../d5/de0/multires_8c.html#a3e838fb81f51bf1a4abf70a599d54555">multires_del_higher</a>(mmd, ob, to_mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>);
<a name="l02034"></a>02034     <span class="keywordflow">else</span> <a class="code" href="../../d5/de0/multires_8c.html#aefea64470e5d9258b3f4e34a7d67ef7d">multires_subdivide</a>(mmd, ob, to_mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>);
<a name="l02035"></a>02035 }
<a name="l02036"></a>02036 
<a name="l02037"></a><a class="code" href="../../d5/de0/multires_8c.html#ac0823312070042f1e0718b4435ca0ef7">02037</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/de0/multires_8c.html#ac0823312070042f1e0718b4435ca0ef7">multires_apply_smat</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> smat[3][3])
<a name="l02038"></a>02038 {
<a name="l02039"></a>02039     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *cddm= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *subdm= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02040"></a>02040     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **gridData, **subGridData;
<a name="l02041"></a>02041     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02042"></a>02042     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly= me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>;
<a name="l02043"></a>02043     <span class="comment">/* MLoop *mloop = me-&gt;mloop; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02044"></a>02044     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps;
<a name="l02045"></a>02045     <span class="keywordtype">int</span> *gridOffset;
<a name="l02046"></a>02046     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <span class="comment">/*numGrids,*/</span> gridSize, dGridSize, dSkip, totvert;
<a name="l02047"></a>02047     float (*vertCos)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02048"></a>02048     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 1);
<a name="l02049"></a>02049     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> high_mmd;
<a name="l02050"></a>02050 
<a name="l02051"></a>02051     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l02052"></a>02052     mdisps= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l02053"></a>02053 
<a name="l02054"></a>02054     <span class="keywordflow">if</span> (!mdisps || !mmd || !mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>) <span class="keywordflow">return</span>;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056     <span class="comment">/* we need derived mesh created from highest resolution */</span>
<a name="l02057"></a>02057     high_mmd= *mmd;
<a name="l02058"></a>02058     high_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>= high_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>;
<a name="l02059"></a>02059 
<a name="l02060"></a>02060     <span class="comment">/* unscaled multires with applied displacement */</span>
<a name="l02061"></a>02061     subdm= <a class="code" href="../../d1/d37/BKE__multires_8h.html#a227c0e85cef7d40bb3432999d38910ce">get_multires_dm</a>(scene, &amp;high_mmd, ob);
<a name="l02062"></a>02062 
<a name="l02063"></a>02063     <span class="comment">/* prepare scaled CDDM to create ccgDN */</span>
<a name="l02064"></a>02064     cddm= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0cb599f3f397fcb5f99b02677bf3b0ec">mesh_get_derived_deform</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l02065"></a>02065 
<a name="l02066"></a>02066     totvert= cddm-&gt;getNumVerts(cddm);
<a name="l02067"></a>02067     vertCos= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(*vertCos) * totvert, <span class="stringliteral">&quot;multiresScale vertCos&quot;</span>);
<a name="l02068"></a>02068     cddm-&gt;getVertCos(cddm, vertCos);
<a name="l02069"></a>02069     <span class="keywordflow">for</span> (i=0; i&lt;totvert; i++)
<a name="l02070"></a>02070         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(smat, vertCos[i]);
<a name="l02071"></a>02071     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(cddm, vertCos);
<a name="l02072"></a>02072     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vertCos);
<a name="l02073"></a>02073 
<a name="l02074"></a>02074     <span class="comment">/* scaled ccgDM for tangent space of object with applied scale */</span>
<a name="l02075"></a>02075     dm= <a class="code" href="../../d5/de0/multires_8c.html#a89e09d8e71601103bb27cec15e6fca26">subsurf_dm_create_local</a>(ob, cddm, high_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>, high_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#ae1ae70a8374d544536abf30fc8994a68">simple</a>, 0, mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#aeedcdbb8a0c946ab593c987fc0d2be85">flags</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1892159c1d534a848c5013bfc93c209da4e6caeac059fed9efa89f11e64651535">eMultiresModifierFlag_PlainUv</a>);
<a name="l02076"></a>02076     cddm-&gt;release(cddm);
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     <span class="comment">/*numGrids= dm-&gt;getNumGrids(dm);*/</span> <span class="comment">/*UNUSED*/</span>
<a name="l02079"></a>02079     gridSize= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(dm);
<a name="l02080"></a>02080     gridData= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(dm);
<a name="l02081"></a>02081     gridOffset= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5a69ae7361f77bef729afa2ec720488">getGridOffset</a>(dm);
<a name="l02082"></a>02082     subGridData= subdm-&gt;getGridData(subdm);
<a name="l02083"></a>02083 
<a name="l02084"></a>02084     dGridSize= <a class="code" href="../../d5/de0/multires_8c.html#a75eb50a33a56ae23a9b939c63f532065">multires_side_tot</a>[high_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>];
<a name="l02085"></a>02085     dSkip= (dGridSize-1)/(gridSize-1);
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 <span class="preprocessor">    #pragma omp parallel for private(i) if (me-&gt;totface*gridSize*gridSize*4 &gt;= CCG_OMP_LIMIT)</span>
<a name="l02088"></a>02088 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l02089"></a>02089         <span class="keyword">const</span> <span class="keywordtype">int</span> numVerts= mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].totloop;
<a name="l02090"></a>02090         <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp= &amp;mdisps[mpoly[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].loopstart];
<a name="l02091"></a>02091         <span class="keywordtype">int</span> S, x, y, gIndex = gridOffset[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02092"></a>02092 
<a name="l02093"></a>02093         <span class="keywordflow">for</span> (S = 0; S &lt; numVerts; ++S, ++gIndex, mdisp++) {
<a name="l02094"></a>02094             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *grid= gridData[gIndex];
<a name="l02095"></a>02095             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *subgrid= subGridData[gIndex];
<a name="l02096"></a>02096             float (*dispgrid)[3]= mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>;
<a name="l02097"></a>02097 
<a name="l02098"></a>02098             <span class="keywordflow">for</span> (y = 0; y &lt; gridSize; y++) {
<a name="l02099"></a>02099                 <span class="keywordflow">for</span> (x = 0; x &lt; gridSize; x++) {
<a name="l02100"></a>02100                     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= grid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>;
<a name="l02101"></a>02101                     <span class="keywordtype">float</span> *sco= subgrid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a2eefcf4e517196c92930feeedb312643">co</a>;
<a name="l02102"></a>02102                     <span class="keywordtype">float</span> *no= grid[x + y*gridSize].<a class="code" href="../../de/d85/structDMGridData.html#a91db5970badedaaf7d68e109077cd189">no</a>;
<a name="l02103"></a>02103                     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= dispgrid[dGridSize*y*dSkip + x*dSkip];
<a name="l02104"></a>02104                     <span class="keywordtype">float</span> mat[3][3], tx[3], ty[3], disp[3];
<a name="l02105"></a>02105 
<a name="l02106"></a>02106                     <span class="comment">/* construct tangent space matrix */</span>
<a name="l02107"></a>02107                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 0, gridData, tx);
<a name="l02108"></a>02108                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tx);
<a name="l02109"></a>02109 
<a name="l02110"></a>02110                     <a class="code" href="../../d5/de0/multires_8c.html#a568f17cdb035feb8d276f733cdef450b">grid_tangent</a>(gridSize, gIndex, x, y, 1, gridData, ty);
<a name="l02111"></a>02111                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ty);
<a name="l02112"></a>02112 
<a name="l02113"></a>02113                     <a class="code" href="../../d5/de0/multires_8c.html#aab50dd812786f7604f683dbf586a0163">column_vectors_to_mat3</a>(mat, tx, ty, no);
<a name="l02114"></a>02114 
<a name="l02115"></a>02115                     <span class="comment">/* scale subgrid coord and calculate displacement */</span>
<a name="l02116"></a>02116                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(smat, sco);
<a name="l02117"></a>02117                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(disp, sco, co);
<a name="l02118"></a>02118 
<a name="l02119"></a>02119                     <span class="comment">/* convert difference to tangent space */</span>
<a name="l02120"></a>02120                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(mat);
<a name="l02121"></a>02121                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(data, mat, disp);
<a name="l02122"></a>02122                 }
<a name="l02123"></a>02123             }
<a name="l02124"></a>02124         }
<a name="l02125"></a>02125     }
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02128"></a>02128     subdm-&gt;release(subdm);
<a name="l02129"></a>02129 }
<a name="l02130"></a>02130 
<a name="l02131"></a><a class="code" href="../../d5/de0/multires_8c.html#acf183eefa223be6bf86e4b807daceb03">02131</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a889def13771bb31661732d2f6b4cf547">multires_mdisp_corners</a>(<a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *s)
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133     <span class="keywordtype">int</span> lvl= 13;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <span class="keywordflow">while</span> (lvl &gt; 0) {
<a name="l02136"></a>02136         <span class="keywordtype">int</span> side = (1 &lt;&lt; (lvl-1)) + 1;
<a name="l02137"></a>02137         <span class="keywordflow">if</span> ((s-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> % (side*side)) == 0) <span class="keywordflow">return</span> s-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> / (side*side);
<a name="l02138"></a>02138         lvl--;
<a name="l02139"></a>02139     }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141     <span class="keywordflow">return</span> 0;
<a name="l02142"></a>02142 }
<a name="l02143"></a>02143 
<a name="l02144"></a><a class="code" href="../../d5/de0/multires_8c.html#a5c2fbac11912e415afca17a9d53b2044">02144</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a11e1204772c89c0fe9daa0e657caa673">multiresModifier_scale_disp</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02145"></a>02145 {
<a name="l02146"></a>02146     <span class="keywordtype">float</span> smat[3][3];
<a name="l02147"></a>02147 
<a name="l02148"></a>02148     <span class="comment">/* object&#39;s scale matrix */</span>
<a name="l02149"></a>02149     <a class="code" href="../../df/dac/BKE__object_8h.html#a7679f9544ca6035f3076ae1aa49f33f0">object_scale_to_mat3</a>(ob, smat);
<a name="l02150"></a>02150 
<a name="l02151"></a>02151     <a class="code" href="../../d5/de0/multires_8c.html#ac0823312070042f1e0718b4435ca0ef7">multires_apply_smat</a>(scene, ob, smat);
<a name="l02152"></a>02152 }
<a name="l02153"></a>02153 
<a name="l02154"></a><a class="code" href="../../d5/de0/multires_8c.html#acdacd309c70e614fda3311cbff37c921">02154</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a8b9578c1caa1e443f9d7e9020c68ccab">multiresModifier_prepare_join</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *to_ob)
<a name="l02155"></a>02155 {
<a name="l02156"></a>02156     <span class="keywordtype">float</span> smat[3][3], tmat[3][3], mat[3][3];
<a name="l02157"></a>02157     <a class="code" href="../../d5/de0/multires_8c.html#a2bd7b8ede5d3c823f621e88445de5040">multires_sync_levels</a>(scene, ob, to_ob);
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <span class="comment">/* construct scale matrix for displacement */</span>
<a name="l02160"></a>02160     <a class="code" href="../../df/dac/BKE__object_8h.html#a7679f9544ca6035f3076ae1aa49f33f0">object_scale_to_mat3</a>(to_ob, tmat);
<a name="l02161"></a>02161     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(tmat);
<a name="l02162"></a>02162     <a class="code" href="../../df/dac/BKE__object_8h.html#a7679f9544ca6035f3076ae1aa49f33f0">object_scale_to_mat3</a>(ob, smat);
<a name="l02163"></a>02163     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(mat, smat, tmat);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     <a class="code" href="../../d5/de0/multires_8c.html#ac0823312070042f1e0718b4435ca0ef7">multires_apply_smat</a>(scene, ob, mat);
<a name="l02166"></a>02166 }
<a name="l02167"></a>02167 
<a name="l02168"></a>02168 <span class="comment">/* update multires data after topology changing */</span>
<a name="l02169"></a><a class="code" href="../../d5/de0/multires_8c.html#acf1860197f12e4338c148b3eb36519b5">02169</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a549b7292b9cb52ef606ade5cddf2e752">multires_topology_changed</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l02170"></a>02170 {
<a name="l02171"></a>02171     <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisp = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *cur = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02172"></a>02172     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, grid = 0;
<a name="l02173"></a>02173 
<a name="l02174"></a>02174     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac68d23d566298743570286ed78d3d9b5">CustomData_external_read</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae5e6502bcd3510cbe1297ccc063a3013">CD_MASK_MDISPS</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l02175"></a>02175     mdisp = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l02176"></a>02176 
<a name="l02177"></a>02177     <span class="keywordflow">if</span> (!mdisp)
<a name="l02178"></a>02178         <span class="keywordflow">return</span>;
<a name="l02179"></a>02179 
<a name="l02180"></a>02180     cur = mdisp;
<a name="l02181"></a>02181     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++, cur++) {
<a name="l02182"></a>02182         <span class="keywordflow">if</span> (cur-&gt;totdisp) {
<a name="l02183"></a>02183             grid = mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a>;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185             <span class="keywordflow">break</span>;
<a name="l02186"></a>02186         }
<a name="l02187"></a>02187     }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++, mdisp++) {
<a name="l02190"></a>02190         <span class="comment">/* allocate memory for mdisp, the whole disp layer would be erased otherwise */</span>
<a name="l02191"></a>02191         <span class="keywordflow">if</span> (!mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> || !mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a>) {
<a name="l02192"></a>02192             <span class="keywordflow">if</span> (grid) {
<a name="l02193"></a>02193                 mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> = grid;
<a name="l02194"></a>02194                 mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#a074f759a552afe40fba57e3069249e27">disps</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(3 * mdisp-&gt;<a class="code" href="../../da/d81/structMDisps.html#aa761cd4860d10148af662dffee5e0ce5">totdisp</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;mdisp topology&quot;</span>);
<a name="l02195"></a>02195             }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197             <span class="keywordflow">continue</span>;
<a name="l02198"></a>02198         }
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200 }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202 <span class="comment">/***************** Multires interpolation stuff *****************/</span>
<a name="l02203"></a>02203 
<a name="l02204"></a>02204 <span class="comment">/* Find per-corner coordinate with given per-face UV coord */</span>
<a name="l02205"></a><a class="code" href="../../d5/de0/multires_8c.html#a534b5f4e07113cd6979371d7c0e8a6ab">02205</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d37/BKE__multires_8h.html#a534b5f4e07113cd6979371d7c0e8a6ab">mdisp_rot_face_to_crn</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> corners, <span class="keyword">const</span> <span class="keywordtype">int</span> face_side, <span class="keyword">const</span> <span class="keywordtype">float</span> u, <span class="keyword">const</span> <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> *x, <span class="keywordtype">float</span> *y)
<a name="l02206"></a>02206 {
<a name="l02207"></a>02207     <span class="keyword">const</span> <span class="keywordtype">float</span> offset = face_side*0.5f - 0.5f;
<a name="l02208"></a>02208     <span class="keywordtype">int</span> S = 0;
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (corners == 4) {
<a name="l02211"></a>02211         <span class="keywordflow">if</span> (u &lt;= offset &amp;&amp; v &lt;= offset) S = 0;
<a name="l02212"></a>02212         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u &gt; offset  &amp;&amp; v &lt;= offset) S = 1;
<a name="l02213"></a>02213         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u &gt; offset  &amp;&amp; v &gt; offset) S = 2;
<a name="l02214"></a>02214         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u &lt;= offset &amp;&amp; v &gt;= offset)  S = 3;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216         <span class="keywordflow">if</span> (S == 0) {
<a name="l02217"></a>02217             *y = offset - u;
<a name="l02218"></a>02218             *x = offset - v;
<a name="l02219"></a>02219         }
<a name="l02220"></a>02220         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 1) {
<a name="l02221"></a>02221             *x = u - offset;
<a name="l02222"></a>02222             *y = offset - v;
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 2) {
<a name="l02225"></a>02225             *y = u - offset;
<a name="l02226"></a>02226             *x = v - offset;
<a name="l02227"></a>02227         }
<a name="l02228"></a>02228         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S == 3) {
<a name="l02229"></a>02229             *x= offset - u;
<a name="l02230"></a>02230             *y = v - offset;
<a name="l02231"></a>02231         }
<a name="l02232"></a>02232     }
<a name="l02233"></a>02233     <span class="keywordflow">else</span> {
<a name="l02234"></a>02234         <span class="keywordtype">int</span> grid_size = offset;
<a name="l02235"></a>02235         <span class="keywordtype">float</span> w = (face_side - 1) - u - v;
<a name="l02236"></a>02236         <span class="keywordtype">float</span> W1, W2;
<a name="l02237"></a>02237 
<a name="l02238"></a>02238         <span class="keywordflow">if</span> (u &gt;= v &amp;&amp; u &gt;= w) {S = 0; W1= w; W2= v;}
<a name="l02239"></a>02239         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v &gt;= u &amp;&amp; v &gt;= w) {S = 1; W1 = u; W2 = w;}
<a name="l02240"></a>02240         <span class="keywordflow">else</span> {S = 2; W1 = v; W2 = u;}
<a name="l02241"></a>02241 
<a name="l02242"></a>02242         W1 /= (face_side-1);
<a name="l02243"></a>02243         W2 /= (face_side-1);
<a name="l02244"></a>02244 
<a name="l02245"></a>02245         *x = (1-(2*W1)/(1-W2)) * grid_size;
<a name="l02246"></a>02246         *y = (1-(2*W2)/(1-W1)) * grid_size;
<a name="l02247"></a>02247     }
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     <span class="keywordflow">return</span> S;
<a name="l02250"></a>02250 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:34 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
