<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: object_bake.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">object_bake.c</div>  </div>
</div>
<div class="contents">
<a href="../../d5/d58/object__bake_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2004 by Blender Foundation</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Morten Mikkelsen,</span>
<a name="l00024"></a>00024 <span class="comment"> *                 Sergey Sharybin</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/da4/DNA__screen__types_8h.html">DNA_screen_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d5d/DNA__space__types_8h.html">DNA_space_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3b/DNA__world__types_8h.html">DNA_world_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html">BLI_math_geom.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/ddf/BKE__blender_8h.html" title="Blender util stuff.">BKE_blender.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da3/BKE__screen_8h.html">BKE_screen.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d37/BKE__multires_8h.html">BKE_multires.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dfd/RE__pipeline_8h.html">RE_pipeline.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d49/RE__shader__ext_8h.html">RE_shader_ext.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/df0/GPU__draw_8h.html">GPU_draw.h</a>&quot;</span> <span class="comment">/* GPU_free_image */</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7a/ED__object_8h.html">ED_object.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d80/object__intern_8h.html">object_intern.h</a>&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* ****************** multires BAKING ********************** */</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/* holder of per-object data needed for bake job</span>
<a name="l00084"></a>00084 <span class="comment"> * needed to make job totally thread-safe */</span>
<a name="l00085"></a><a class="code" href="../../dc/d63/structMultiresBakerJobData.html">00085</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a> {
<a name="l00086"></a><a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a32248cfde3ef104577b688b52906e2a0">00086</a>     <span class="keyword">struct </span><a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a> *<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a3ea1d2f22048227afca085e7ac4a2d02">next</a>, *<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a32248cfde3ef104577b688b52906e2a0">prev</a>;
<a name="l00087"></a><a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">00087</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a>, *<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a77c0acbcb33f08e1fe73b26bfa2ffa0b">hires_dm</a>;
<a name="l00088"></a><a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa90d95a70e16d80691eed485693df98a">00088</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/d63/structMultiresBakerJobData.html#ade952de13884fe5643ba070f0d94ae8a">simple</a>, <a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa4db35dbdd3ef579e487328a93f30ca2">lvl</a>, <a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa90d95a70e16d80691eed485693df98a">tot_lvl</a>;
<a name="l00089"></a>00089 } <a class="code" href="../../d5/d58/object__bake_8c.html#a3c8d846e6b9956f9780aa7809d6a264c">MultiresBakerJobData</a>;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/* data passing to multires-baker job */</span>
<a name="l00092"></a><a class="code" href="../../d0/d52/structMultiresBakeJob.html">00092</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00093"></a><a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">00093</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>;
<a name="l00094"></a><a class="code" href="../../d0/d52/structMultiresBakeJob.html#a1658bc45e82913466656a099afd992cc">00094</a>     <span class="keywordtype">int</span> bake_clear, <a class="code" href="../../d0/d52/structMultiresBakeJob.html#a1658bc45e82913466656a099afd992cc">bake_filter</a>;
<a name="l00095"></a><a class="code" href="../../d0/d52/structMultiresBakeJob.html#a336231d63e78621bffea17b152d9dbeb">00095</a>     <span class="keywordtype">short</span> mode, <a class="code" href="../../d0/d52/structMultiresBakeJob.html#a336231d63e78621bffea17b152d9dbeb">use_lores_mesh</a>;
<a name="l00096"></a>00096 } <a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a>;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">/* data passing to multires baker */</span>
<a name="l00099"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html">00099</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00100"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">00100</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>, *hires_dm;
<a name="l00101"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad1ffe8c56145dc7ae55763221c67483f">00101</a>     <span class="keywordtype">int</span> simple, lvl, <a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad1ffe8c56145dc7ae55763221c67483f">tot_lvl</a>, bake_filter;
<a name="l00102"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#a3ba5134558cc6e551ba0f33e9f190c09">00102</a>     <span class="keywordtype">short</span> mode, <a class="code" href="../../d7/d42/structMultiresBakeRender.html#a3ba5134558cc6e551ba0f33e9f190c09">use_lores_mesh</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#a12dd53d73f81a07754596ed0047f1ff8">00104</a>     <span class="keywordtype">int</span> <a class="code" href="../../d7/d42/structMultiresBakeRender.html#a12dd53d73f81a07754596ed0047f1ff8">tot_obj</a>, tot_image;
<a name="l00105"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">00105</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>;
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad31ef669bc096503612f2ef97844fa9d">00107</a>     <span class="keywordtype">int</span> <a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad31ef669bc096503612f2ef97844fa9d">baked_objects</a>, baked_faces;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#a48252a9488c21a9f6c3cc3b1a81d1671">00109</a>     <span class="keywordtype">short</span> *<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a48252a9488c21a9f6c3cc3b1a81d1671">stop</a>;
<a name="l00110"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#af87cef6e6c46bb15c85b9bbf05a952b3">00110</a>     <span class="keywordtype">short</span> *<a class="code" href="../../d7/d42/structMultiresBakeRender.html#af87cef6e6c46bb15c85b9bbf05a952b3">do_update</a>;
<a name="l00111"></a><a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad7f29b6919577fb0876d64c43087e326">00111</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad7f29b6919577fb0876d64c43087e326">progress</a>;
<a name="l00112"></a>00112 } <a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ab6453aae51d8930e524ba635276f64bd">00114</a> <span class="keyword">typedef</span> void (*<a class="code" href="../../d5/d58/object__bake_8c.html#ab6453aae51d8930e524ba635276f64bd">MPassKnownData</a>)(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lores_dm, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *hires_dm, <span class="keyword">const</span> <span class="keywordtype">void</span> *bake_data,
<a name="l00115"></a>00115                                <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">int</span> lvl, <span class="keyword">const</span> <span class="keywordtype">float</span> st[2],
<a name="l00116"></a>00116                                <span class="keywordtype">float</span> tangmat[3][3], <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y);
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a43d4f1c67520ec3521ab4794f9113985">00118</a> <span class="keyword">typedef</span> <span class="keywordtype">void</span>* (*MInitBakeData)(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a>* ima);
<a name="l00119"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a430ed692a7a85f3f45edae133ee60d7e">00119</a> <span class="keyword">typedef</span> void (*<a class="code" href="../../d5/d58/object__bake_8c.html#a430ed692a7a85f3f45edae133ee60d7e">MApplyBakeData</a>)(<span class="keywordtype">void</span> *bake_data);
<a name="l00120"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a1c38ab393ef7b2ef65d54e541bf9fea2">00120</a> <span class="keyword">typedef</span> void (*<a class="code" href="../../d5/d58/object__bake_8c.html#a1c38ab393ef7b2ef65d54e541bf9fea2">MFreeBakeData</a>)(<span class="keywordtype">void</span> *bake_data);
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html">00122</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00123"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">00123</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>;
<a name="l00124"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">00124</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>;
<a name="l00125"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">00125</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">mtface</a>;
<a name="l00126"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">00126</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">pvtangent</a>;
<a name="l00127"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a54acbafede22deae5bd227a70457fe73">00127</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#a54acbafede22deae5bd227a70457fe73">precomputed_normals</a>;
<a name="l00128"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#afe0a2756ddc77ebe809ec66c9dc55277">00128</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html#afe0a2756ddc77ebe809ec66c9dc55277">w</a>, h;
<a name="l00129"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">00129</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>;
<a name="l00130"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a4a2b6a6d8284b8abab26d0eebc97bec0">00130</a>     <span class="keywordtype">int</span> i0, i1, <a class="code" href="../../d2/db2/structMResolvePixelData.html#a4a2b6a6d8284b8abab26d0eebc97bec0">i2</a>;
<a name="l00131"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a937b9cd53e73387ca5bf8c4eece6c4dc">00131</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#a937b9cd53e73387ca5bf8c4eece6c4dc">lores_dm</a>, *hires_dm;
<a name="l00132"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#aec8fb54c46af1e4229b2a648eae8fac6">00132</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html#aec8fb54c46af1e4229b2a648eae8fac6">lvl</a>;
<a name="l00133"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">00133</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">bake_data</a>;
<a name="l00134"></a><a class="code" href="../../d2/db2/structMResolvePixelData.html#aa6fb95f2a4293eb1e21780ffdf17ec24">00134</a>     <a class="code" href="../../d5/d58/object__bake_8c.html#ab6453aae51d8930e524ba635276f64bd">MPassKnownData</a> <a class="code" href="../../d2/db2/structMResolvePixelData.html#aa6fb95f2a4293eb1e21780ffdf17ec24">pass_data</a>;
<a name="l00135"></a>00135 } <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a>;
<a name="l00136"></a>00136 
<a name="l00137"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a58c225c4a1eee0932222ffa330ab9bda">00137</a> <span class="keyword">typedef</span> void (*<a class="code" href="../../d5/d58/object__bake_8c.html#a58c225c4a1eee0932222ffa330ab9bda">MFlushPixel</a>)(<span class="keyword">const</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y);
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="../../df/dae/structMBakeRast.html">00139</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00140"></a><a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">00140</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">w</a>, h;
<a name="l00141"></a><a class="code" href="../../df/dae/structMBakeRast.html#a9f7b92b707ab58631ace9d7d396e309e">00141</a>     <span class="keywordtype">char</span> *<a class="code" href="../../df/dae/structMBakeRast.html#a9f7b92b707ab58631ace9d7d396e309e">texels</a>;
<a name="l00142"></a><a class="code" href="../../df/dae/structMBakeRast.html#a5473c6ec86ae14589d3599346a6246c2">00142</a>     <span class="keyword">const</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> *<a class="code" href="../../df/dae/structMBakeRast.html#a5473c6ec86ae14589d3599346a6246c2">data</a>;
<a name="l00143"></a><a class="code" href="../../df/dae/structMBakeRast.html#a466a1c50b333d4f7b92d4fce61fecad0">00143</a>     <a class="code" href="../../d5/d58/object__bake_8c.html#a58c225c4a1eee0932222ffa330ab9bda">MFlushPixel</a> <a class="code" href="../../df/dae/structMBakeRast.html#a466a1c50b333d4f7b92d4fce61fecad0">flush_pixel</a>;
<a name="l00144"></a>00144 } <a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a>;
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html">00146</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00147"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">00147</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">heights</a>;
<a name="l00148"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html#a9be18f2b933b2236a0f769226e617020">00148</a>     <span class="keywordtype">float</span> <a class="code" href="../../d3/d89/structMHeightBakeData.html#a9be18f2b933b2236a0f769226e617020">height_min</a>, height_max;
<a name="l00149"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html#aa0e4ee6881f697ed9c7a3e05ea835174">00149</a>     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d3/d89/structMHeightBakeData.html#aa0e4ee6881f697ed9c7a3e05ea835174">ima</a>;
<a name="l00150"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">00150</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>;
<a name="l00151"></a><a class="code" href="../../d3/d89/structMHeightBakeData.html#a8ef686b8b6bf23ddbdf66994a2f12eb6">00151</a>     <span class="keyword">const</span> <span class="keywordtype">int</span> *<a class="code" href="../../d3/d89/structMHeightBakeData.html#a8ef686b8b6bf23ddbdf66994a2f12eb6">origindex</a>;
<a name="l00152"></a>00152 } <a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a>;
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="../../d4/ddd/structMNormalBakeData.html">00154</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00155"></a><a class="code" href="../../d4/ddd/structMNormalBakeData.html#ad648598c9756cfaa931b72297a43ca81">00155</a>     <span class="keyword">const</span> <span class="keywordtype">int</span> *<a class="code" href="../../d4/ddd/structMNormalBakeData.html#ad648598c9756cfaa931b72297a43ca81">origindex</a>;
<a name="l00156"></a>00156 } <a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a>;
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a7e90c5f3e33d4345f0c424e5265b7122">00158</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a7e90c5f3e33d4345f0c424e5265b7122">multiresbake_get_normal</a>(<span class="keyword">const</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">float</span> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d6c/mball_8c.html#a47e7cc913f2b356de088363a1d87db4a">indices</a>[]= {data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>,
<a name="l00161"></a>00161                              data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>};
<a name="l00162"></a>00162     <span class="keyword">const</span> <span class="keywordtype">int</span> smoothnormal= (data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordflow">if</span> (!smoothnormal) { <span class="comment">/* flat */</span>
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a54acbafede22deae5bd227a70457fe73">precomputed_normals</a>) {
<a name="l00166"></a>00166             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(norm, &amp;data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a54acbafede22deae5bd227a70457fe73">precomputed_normals</a>[3*face_num]);
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168         <span class="keywordflow">else</span> {
<a name="l00169"></a>00169             <span class="keywordtype">float</span> nor[3];
<a name="l00170"></a>00170             <span class="keywordtype">float</span> *p0, *p1, *p2;
<a name="l00171"></a>00171             <span class="keyword">const</span> <span class="keywordtype">int</span> iGetNrVerts= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>!=0 ? 4 : 3;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173             p0= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>[indices[0]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00174"></a>00174             p1= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>[indices[1]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00175"></a>00175             p2= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>[indices[2]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (iGetNrVerts==4) {
<a name="l00178"></a>00178                 <span class="keywordtype">float</span> *p3= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>[indices[3]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00179"></a>00179                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>(nor, p0, p1, p2, p3);
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181             <span class="keywordflow">else</span> {
<a name="l00182"></a>00182                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(nor, p0, p1, p2);
<a name="l00183"></a>00183             }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(norm, nor);
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188     <span class="keywordflow">else</span> {
<a name="l00189"></a>00189         <span class="keywordtype">short</span> *no= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>[indices[vert_index]].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(norm, no);
<a name="l00192"></a>00192         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(norm);
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a5035240d64c827901753c9a52380328c">00196</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a5035240d64c827901753c9a52380328c">init_bake_rast</a>(<a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a> *bake_rast, <span class="keyword">const</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#a58c225c4a1eee0932222ffa330ab9bda">MFlushPixel</a> <a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">flush_pixel</a>)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     memset(bake_rast, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a>));
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a9f7b92b707ab58631ace9d7d396e309e">texels</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>;
<a name="l00201"></a>00201     bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">w</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00202"></a>00202     bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a400714da6a48749c41f1b9c3b89b6117">h</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00203"></a>00203     bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a5473c6ec86ae14589d3599346a6246c2">data</a>= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00204"></a>00204     bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a466a1c50b333d4f7b92d4fce61fecad0">flush_pixel</a>= <a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">flush_pixel</a>;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">00207</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">flush_pixel</a>(<span class="keyword">const</span> <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209     <span class="keywordtype">float</span> st[2]= {(x+0.5f)/data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#afe0a2756ddc77ebe809ec66c9dc55277">w</a>, (y+0.5f)/data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a1c849712e4c973246effbea07c3c6af3">h</a>};
<a name="l00210"></a>00210     <span class="keywordtype">float</span> *st0, *st1, *st2;
<a name="l00211"></a>00211     <span class="keywordtype">float</span> *tang0, *tang1, *tang2;
<a name="l00212"></a>00212     <span class="keywordtype">float</span> no0[3], no1[3], no2[3];
<a name="l00213"></a>00213     <span class="keywordtype">float</span> fUV[2], from_tang[3][3], to_tang[3][3];
<a name="l00214"></a>00214     <span class="keywordtype">float</span> u, v, w, <a class="code" href="../../d1/d13/namespaceTNT.html#a051812668d41cc65f9b8f0518e47b466">sign</a>;
<a name="l00215"></a>00215     <span class="keywordtype">int</span> r;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keyword">const</span> <span class="keywordtype">int</span> i0= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#acb3e054a8732864cee3042e55a12e1ab">i0</a>;
<a name="l00218"></a>00218     <span class="keyword">const</span> <span class="keywordtype">int</span> i1= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#abd25bab02fbeec4b246f370482ae0bad">i1</a>;
<a name="l00219"></a>00219     <span class="keyword">const</span> <span class="keywordtype">int</span> i2= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a4a2b6a6d8284b8abab26d0eebc97bec0">i2</a>;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     st0= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">mtface</a>[data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[i0];
<a name="l00222"></a>00222     st1= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">mtface</a>[data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[i1];
<a name="l00223"></a>00223     st2= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">mtface</a>[data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[i2];
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     tang0= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">pvtangent</a> + data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>*16 + i0*4;
<a name="l00226"></a>00226     tang1= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">pvtangent</a> + data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>*16 + i1*4;
<a name="l00227"></a>00227     tang2= data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">pvtangent</a> + data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>*16 + i2*4;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <a class="code" href="../../d5/d58/object__bake_8c.html#a7e90c5f3e33d4345f0c424e5265b7122">multiresbake_get_normal</a>(data, no0, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>, i0);   <span class="comment">/* can optimize these 3 into one call */</span>
<a name="l00230"></a>00230     <a class="code" href="../../d5/d58/object__bake_8c.html#a7e90c5f3e33d4345f0c424e5265b7122">multiresbake_get_normal</a>(data, no1, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>, i1);
<a name="l00231"></a>00231     <a class="code" href="../../d5/d58/object__bake_8c.html#a7e90c5f3e33d4345f0c424e5265b7122">multiresbake_get_normal</a>(data, no2, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>, i2);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3b21d6ce6bebb39febe24bb62ba150f5">resolve_tri_uv</a>(fUV, st, st0, st1, st2);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     u= fUV[0];
<a name="l00236"></a>00236     v= fUV[1];
<a name="l00237"></a>00237     w= 1-u-v;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="comment">/* the sign is the same at all face vertices for any non degenerate face.</span>
<a name="l00240"></a>00240 <span class="comment">     * Just in case we clamp the interpolated value though. */</span>
<a name="l00241"></a>00241     sign= (tang0[3]*u + tang1[3]*v + tang2[3]*w)&lt;0 ? (-1.0f) : 1.0f;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">/* this sequence of math is designed specifically as is with great care</span>
<a name="l00244"></a>00244 <span class="comment">     * to be compatible with our shader. Please don&#39;t change without good reason. */</span>
<a name="l00245"></a>00245     <span class="keywordflow">for</span> (r= 0; r&lt;3; r++) {
<a name="l00246"></a>00246         from_tang[0][r]= tang0[r]*u + tang1[r]*v + tang2[r]*w;
<a name="l00247"></a>00247         from_tang[2][r]= no0[r]*u + no1[r]*v + no2[r]*w;
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(from_tang[1], from_tang[2], from_tang[0]);  <span class="comment">/* B = sign * cross(N, T)  */</span>
<a name="l00251"></a>00251     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(from_tang[1], sign);
<a name="l00252"></a>00252     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(to_tang, from_tang);
<a name="l00253"></a>00253     <span class="comment">/* sequence end */</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#aa6fb95f2a4293eb1e21780ffdf17ec24">pass_data</a>(data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a937b9cd53e73387ca5bf8c4eece6c4dc">lores_dm</a>, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a42a7afb5685bef61c847657e3362e348">hires_dm</a>, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">bake_data</a>,
<a name="l00256"></a>00256                     data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>, data-&gt;<a class="code" href="../../d2/db2/structMResolvePixelData.html#aec8fb54c46af1e4229b2a648eae8fac6">lvl</a>, st, to_tang, x, y);
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a6744e14ae34a45148c842d5abf38aa79">00259</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a6744e14ae34a45148c842d5abf38aa79">set_rast_triangle</a>(<span class="keyword">const</span> <a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a> *bake_rast, <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keyword">const</span> <span class="keywordtype">int</span> w= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">w</a>;
<a name="l00262"></a>00262     <span class="keyword">const</span> <span class="keywordtype">int</span> h= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a400714da6a48749c41f1b9c3b89b6117">h</a>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; x&lt;w &amp;&amp; y&gt;=0 &amp;&amp; y&lt;h) {
<a name="l00265"></a>00265         <span class="keywordflow">if</span> ((bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a9f7b92b707ab58631ace9d7d396e309e">texels</a>[y*w+x])==0) {
<a name="l00266"></a>00266             <a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">flush_pixel</a>(bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a5473c6ec86ae14589d3599346a6246c2">data</a>, x, y);
<a name="l00267"></a>00267             bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a9f7b92b707ab58631ace9d7d396e309e">texels</a>[y*w+x]= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2205ba007ff3e14a265b05a4270a944d">FILTER_MASK_USED</a>;
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a2cb05c13867cbe5d9e4ec5c01e6777ea">00272</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a2cb05c13867cbe5d9e4ec5c01e6777ea">rasterize_half</a>(<span class="keyword">const</span> <a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a> *bake_rast,
<a name="l00273"></a>00273                            <span class="keyword">const</span> <span class="keywordtype">float</span> s0_s, <span class="keyword">const</span> <span class="keywordtype">float</span> t0_s, <span class="keyword">const</span> <span class="keywordtype">float</span> s1_s, <span class="keyword">const</span> <span class="keywordtype">float</span> t1_s,
<a name="l00274"></a>00274                            <span class="keyword">const</span> <span class="keywordtype">float</span> s0_l, <span class="keyword">const</span> <span class="keywordtype">float</span> t0_l, <span class="keyword">const</span> <span class="keywordtype">float</span> s1_l, <span class="keyword">const</span> <span class="keywordtype">float</span> t1_l,
<a name="l00275"></a>00275                            <span class="keyword">const</span> <span class="keywordtype">int</span> y0_in, <span class="keyword">const</span> <span class="keywordtype">int</span> y1_in, <span class="keyword">const</span> <span class="keywordtype">int</span> is_mid_right)
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277     <span class="keyword">const</span> <span class="keywordtype">int</span> s_stable= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(t1_s-t0_s)&gt;FLT_EPSILON ? 1 : 0;
<a name="l00278"></a>00278     <span class="keyword">const</span> <span class="keywordtype">int</span> l_stable= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(t1_l-t0_l)&gt;FLT_EPSILON ? 1 : 0;
<a name="l00279"></a>00279     <span class="keyword">const</span> <span class="keywordtype">int</span> w= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">w</a>;
<a name="l00280"></a>00280     <span class="keyword">const</span> <span class="keywordtype">int</span> h= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a400714da6a48749c41f1b9c3b89b6117">h</a>;
<a name="l00281"></a>00281     <span class="keywordtype">int</span> y, y0, y1;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (y1_in&lt;=0 || y0_in&gt;=h)
<a name="l00284"></a>00284         <span class="keywordflow">return</span>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     y0= y0_in&lt;0 ? 0 : y0_in;
<a name="l00287"></a>00287     y1= y1_in&gt;=h ? h : y1_in;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <span class="keywordflow">for</span> (y= y0; y&lt;y1; y++) {
<a name="l00290"></a>00290         <span class="comment">/*-b(x-x0) + a(y-y0) = 0 */</span>
<a name="l00291"></a>00291         <span class="keywordtype">int</span> iXl, iXr, x;
<a name="l00292"></a>00292         <span class="keywordtype">float</span> x_l= s_stable!=0 ? (s0_s + (((s1_s-s0_s)*(y-t0_s))/(t1_s-t0_s))) : s0_s;
<a name="l00293"></a>00293         <span class="keywordtype">float</span> x_r= l_stable!=0 ? (s0_l + (((s1_l-s0_l)*(y-t0_l))/(t1_l-t0_l))) : s0_l;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         <span class="keywordflow">if</span> (is_mid_right!=0)
<a name="l00296"></a>00296             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, x_l, x_r);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         iXl= (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(x_l);
<a name="l00299"></a>00299         iXr= (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(x_r);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (iXr&gt;0 &amp;&amp; iXl&lt;w) {
<a name="l00302"></a>00302             iXl= iXl&lt;0?0:iXl;
<a name="l00303"></a>00303             iXr= iXr&gt;=w?w:iXr;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305             <span class="keywordflow">for</span> (x= iXl; x&lt;iXr; x++)
<a name="l00306"></a>00306                 <a class="code" href="../../d5/d58/object__bake_8c.html#a6744e14ae34a45148c842d5abf38aa79">set_rast_triangle</a>(bake_rast, x, y);
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a90555f52b1a4ef1ec78a47d16ade518a">00311</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a90555f52b1a4ef1ec78a47d16ade518a">bake_rasterize</a>(<span class="keyword">const</span> <a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a> *bake_rast, <span class="keyword">const</span> <span class="keywordtype">float</span> st0_in[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st1_in[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st2_in[2])
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313     <span class="keyword">const</span> <span class="keywordtype">int</span> w= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a3c60fa709b9822ca9217feb74695805d">w</a>;
<a name="l00314"></a>00314     <span class="keyword">const</span> <span class="keywordtype">int</span> h= bake_rast-&gt;<a class="code" href="../../df/dae/structMBakeRast.html#a400714da6a48749c41f1b9c3b89b6117">h</a>;
<a name="l00315"></a>00315     <span class="keywordtype">float</span> slo= st0_in[0]*w - 0.5f;
<a name="l00316"></a>00316     <span class="keywordtype">float</span> tlo= st0_in[1]*h - 0.5f;
<a name="l00317"></a>00317     <span class="keywordtype">float</span> smi= st1_in[0]*w - 0.5f;
<a name="l00318"></a>00318     <span class="keywordtype">float</span> tmi= st1_in[1]*h - 0.5f;
<a name="l00319"></a>00319     <span class="keywordtype">float</span> shi= st2_in[0]*w - 0.5f;
<a name="l00320"></a>00320     <span class="keywordtype">float</span> thi= st2_in[1]*h - 0.5f;
<a name="l00321"></a>00321     <span class="keywordtype">int</span> is_mid_right= 0, ylo, yhi, yhi_beg;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="comment">/* skip degenerates */</span>
<a name="l00324"></a>00324     <span class="keywordflow">if</span> ((slo==smi &amp;&amp; tlo==tmi) || (slo==shi &amp;&amp; tlo==thi) || (smi==shi &amp;&amp; tmi==thi))
<a name="l00325"></a>00325         <span class="keywordflow">return</span>;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="comment">/* sort by T */</span>
<a name="l00328"></a>00328     <span class="keywordflow">if</span> (tlo&gt;tmi &amp;&amp; tlo&gt;thi) {
<a name="l00329"></a>00329         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, shi, slo);
<a name="l00330"></a>00330         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, thi, tlo);
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tmi&gt;thi) {
<a name="l00333"></a>00333         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, shi, smi);
<a name="l00334"></a>00334         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, thi, tmi);
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (tlo&gt;tmi) {
<a name="l00338"></a>00338         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, slo, smi);
<a name="l00339"></a>00339         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, tlo, tmi);
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="comment">/* check if mid point is to the left or to the right of the lo-hi edge */</span>
<a name="l00343"></a>00343     is_mid_right= (-(shi-slo)*(tmi-thi) + (thi-tlo)*(smi-shi))&gt;0 ? 1 : 0;
<a name="l00344"></a>00344     ylo= (int) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(tlo);
<a name="l00345"></a>00345     yhi_beg= (int) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(tmi);
<a name="l00346"></a>00346     yhi= (int) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(thi);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="comment">/*if (fTmi&gt;ceilf(fTlo))*/</span>
<a name="l00349"></a>00349     <a class="code" href="../../d5/d58/object__bake_8c.html#a2cb05c13867cbe5d9e4ec5c01e6777ea">rasterize_half</a>(bake_rast, slo, tlo, smi, tmi, slo, tlo, shi, thi, ylo, yhi_beg, is_mid_right);
<a name="l00350"></a>00350     <a class="code" href="../../d5/d58/object__bake_8c.html#a2cb05c13867cbe5d9e4ec5c01e6777ea">rasterize_half</a>(bake_rast, smi, tmi, shi, thi, slo, tlo, shi, thi, yhi_beg, yhi, is_mid_right);
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00353"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a1ba6d1b1b94d755268f3551f881b262f">00353</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a1ba6d1b1b94d755268f3551f881b262f">multiresbake_test_break</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr)
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (!bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a48252a9488c21a9f6c3cc3b1a81d1671">stop</a>) {
<a name="l00356"></a>00356         <span class="comment">/* this means baker is executed outside from job system */</span>
<a name="l00357"></a>00357         <span class="keywordflow">return</span> 0;
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">return</span> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a2420729dd71720f1c81b1dfa61628999">00363</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a2420729dd71720f1c81b1dfa61628999">do_multires_bake</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a>* ima, <a class="code" href="../../d5/d58/object__bake_8c.html#ab6453aae51d8930e524ba635276f64bd">MPassKnownData</a> passKnownData,
<a name="l00364"></a>00364                              <a class="code" href="../../d5/d58/object__bake_8c.html#a43d4f1c67520ec3521ab4794f9113985">MInitBakeData</a> initBakeData, <a class="code" href="../../d5/d58/object__bake_8c.html#a430ed692a7a85f3f45edae133ee60d7e">MApplyBakeData</a> applyBakeData, <a class="code" href="../../d5/d58/object__bake_8c.html#a1c38ab393ef7b2ef65d54e541bf9fea2">MFreeBakeData</a> freeBakeData)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>;
<a name="l00367"></a>00367     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00368"></a>00368     <span class="keyword">const</span> <span class="keywordtype">int</span> lvl= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#aa3d3898095b29abd4e4f12eee38c8fca">lvl</a>;
<a name="l00369"></a>00369     <span class="keyword">const</span> <span class="keywordtype">int</span> tot_face= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00370"></a>00370     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l00371"></a>00371     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l00372"></a>00372     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l00373"></a>00373     <span class="keywordtype">float</span> *pvtangent= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>) == -1)
<a name="l00376"></a>00376         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a63408f7aaa01a246352ce26d0123d480">DM_add_tangent_layer</a>(dm);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     pvtangent= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6f4a64ea66e4fa753666158e8fb9f2f2">DM_get_tessface_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (tot_face &gt; 0) {  <span class="comment">/* sanity check */</span>
<a name="l00381"></a>00381         <span class="keywordtype">int</span> f= 0;
<a name="l00382"></a>00382         <a class="code" href="../../df/dae/structMBakeRast.html">MBakeRast</a> bake_rast;
<a name="l00383"></a>00383         <a class="code" href="../../d2/db2/structMResolvePixelData.html">MResolvePixelData</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>={<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#af16abaf7f7e2d8ca568b924d76049276">mface</a>= mface;
<a name="l00386"></a>00386         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a18f93ca70db6de0f9a5eb81ee070515c">mvert</a>= mvert;
<a name="l00387"></a>00387         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#abf7f7dfc61e9abe3c9a2f2b0c545ebc7">mtface</a>= mtface;
<a name="l00388"></a>00388         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a33200b7dc1e2cc5e70c24e5cbb7bfd6b">pvtangent</a>= pvtangent;
<a name="l00389"></a>00389         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a54acbafede22deae5bd227a70457fe73">precomputed_normals</a>= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a28e89d54f6d2545bdce86f0511392f7e">CD_NORMAL</a>);  <span class="comment">/* don&#39;t strictly need this */</span>
<a name="l00390"></a>00390         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#afe0a2756ddc77ebe809ec66c9dc55277">w</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00391"></a>00391         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a1c849712e4c973246effbea07c3c6af3">h</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00392"></a>00392         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a937b9cd53e73387ca5bf8c4eece6c4dc">lores_dm</a>= dm;
<a name="l00393"></a>00393         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a42a7afb5685bef61c847657e3362e348">hires_dm</a>= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a23c8bf1e11c2edb294ed090f20a9d1a3">hires_dm</a>;
<a name="l00394"></a>00394         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#aec8fb54c46af1e4229b2a648eae8fac6">lvl</a>= lvl;
<a name="l00395"></a>00395         data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#aa6fb95f2a4293eb1e21780ffdf17ec24">pass_data</a>= passKnownData;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (initBakeData)
<a name="l00398"></a>00398             data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">bake_data</a>= initBakeData(bkr, ima);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400         <a class="code" href="../../d5/d58/object__bake_8c.html#a5035240d64c827901753c9a52380328c">init_bake_rast</a>(&amp;bake_rast, ibuf, &amp;data, <a class="code" href="../../d5/d58/object__bake_8c.html#ab5388dde750b21cd09bbfaeaf1f6c491">flush_pixel</a>);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="keywordflow">for</span> (f= 0; f&lt;tot_face; f++) {
<a name="l00403"></a>00403             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtfate= &amp;mtface[f];
<a name="l00404"></a>00404             <span class="keywordtype">int</span> verts[3][2], nr_tris, t;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d58/object__bake_8c.html#a1ba6d1b1b94d755268f3551f881b262f">multiresbake_test_break</a>(bkr))
<a name="l00407"></a>00407                 <span class="keywordflow">break</span>;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409             <span class="keywordflow">if</span> (mtfate-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>!=ima)
<a name="l00410"></a>00410                 <span class="keywordflow">continue</span>;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412             data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#ad5078187476e48ebe0ead5e972142d94">face_index</a>= f;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414             <span class="comment">/* might support other forms of diagonal splits later on such as</span>
<a name="l00415"></a>00415 <span class="comment">             * split by shortest diagonal.*/</span>
<a name="l00416"></a>00416             verts[0][0]=0;
<a name="l00417"></a>00417             verts[1][0]=1;
<a name="l00418"></a>00418             verts[2][0]=2;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420             verts[0][1]=0;
<a name="l00421"></a>00421             verts[1][1]=2;
<a name="l00422"></a>00422             verts[2][1]=3;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424             nr_tris= mface[f].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>!=0 ? 2 : 1;
<a name="l00425"></a>00425             <span class="keywordflow">for</span> (t= 0; t&lt;nr_tris; t++) {
<a name="l00426"></a>00426                 data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#acb3e054a8732864cee3042e55a12e1ab">i0</a> = verts[0][t];
<a name="l00427"></a>00427                 data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#abd25bab02fbeec4b246f370482ae0bad">i1</a> = verts[1][t];
<a name="l00428"></a>00428                 data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a4a2b6a6d8284b8abab26d0eebc97bec0">i2</a> = verts[2][t];
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                 <a class="code" href="../../d5/d58/object__bake_8c.html#a90555f52b1a4ef1ec78a47d16ade518a">bake_rasterize</a>(&amp;bake_rast, mtfate-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#acb3e054a8732864cee3042e55a12e1ab">i0</a>], mtfate-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#abd25bab02fbeec4b246f370482ae0bad">i1</a>], mtfate-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a4a2b6a6d8284b8abab26d0eebc97bec0">i2</a>]);
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433             bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a2781d42e205c76712c49c7f9ff9f0b23">baked_faces</a>++;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435             <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#af87cef6e6c46bb15c85b9bbf05a952b3">do_update</a>)
<a name="l00436"></a>00436                 *bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#af87cef6e6c46bb15c85b9bbf05a952b3">do_update</a>= 1;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438             <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad7f29b6919577fb0876d64c43087e326">progress</a>)
<a name="l00439"></a>00439                 *bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad7f29b6919577fb0876d64c43087e326">progress</a>= ((float)bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad31ef669bc096503612f2ef97844fa9d">baked_objects</a> + (<span class="keywordtype">float</span>)bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a2781d42e205c76712c49c7f9ff9f0b23">baked_faces</a> / tot_face) / bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a12dd53d73f81a07754596ed0047f1ff8">tot_obj</a>;
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (applyBakeData)
<a name="l00443"></a>00443             applyBakeData(data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">bake_data</a>);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (freeBakeData)
<a name="l00446"></a>00446             freeBakeData(data.<a class="code" href="../../d2/db2/structMResolvePixelData.html#a5688e5a16368fd0d9261d7792ac273a2">bake_data</a>);
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="../../d5/d58/object__bake_8c.html#af06641cd0fc9a437fa2a0260719a278a">00450</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#af06641cd0fc9a437fa2a0260719a278a">interp_bilinear_quad_data</a>(<span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[4][3], <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> res[3])
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <span class="keywordtype">float</span> vec[3];
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(res, data[0]);
<a name="l00455"></a>00455     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(res, (1-u)*(1-v));
<a name="l00456"></a>00456     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, data[1]);
<a name="l00457"></a>00457     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, u*(1-v)); <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(res, vec);
<a name="l00458"></a>00458     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, data[2]);
<a name="l00459"></a>00459     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, u*v); <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(res, vec);
<a name="l00460"></a>00460     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, data[3]);
<a name="l00461"></a>00461     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, (1-u)*v); <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(res, vec);
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a8e9f5497c4e2d5ecc13a33e4387c7007">00464</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a8e9f5497c4e2d5ecc13a33e4387c7007">interp_barycentric_tri_data</a>(<span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[3][3], <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> res[3])
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466     <span class="keywordtype">float</span> vec[3];
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(res, data[0]);
<a name="l00469"></a>00469     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(res, u);
<a name="l00470"></a>00470     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, data[1]);
<a name="l00471"></a>00471     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, v); <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(res, vec);
<a name="l00472"></a>00472     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, data[2]);
<a name="l00473"></a>00473     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, 1.0f-u-v); <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(res, vec);
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="comment">/* mode = 0: interpolate normals,</span>
<a name="l00477"></a>00477 <span class="comment"> * mode = 1: interpolate coord */</span>
<a name="l00478"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a87f47be967032fc570cc43a2189b488f">00478</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a87f47be967032fc570cc43a2189b488f">interp_bilinear_grid</a>(<a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *grid, <span class="keywordtype">int</span> grid_size, <span class="keywordtype">float</span> crn_x, <span class="keywordtype">float</span> crn_y, <span class="keywordtype">int</span> mode, <span class="keywordtype">float</span> res[3])
<a name="l00479"></a>00479 {
<a name="l00480"></a>00480     <span class="keywordtype">int</span> x0, x1, y0, y1;
<a name="l00481"></a>00481     <span class="keywordtype">float</span> u, v;
<a name="l00482"></a>00482     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[4][3];
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     x0= (int) crn_x;
<a name="l00485"></a>00485     x1= x0&gt;=(grid_size-1) ? (grid_size-1) : (x0+1);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     y0= (int) crn_y;
<a name="l00488"></a>00488     y1= y0&gt;=(grid_size-1) ? (grid_size-1) : (y0+1);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     u= crn_x-x0;
<a name="l00491"></a>00491     v= crn_y-y0;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (mode == 0) {
<a name="l00494"></a>00494         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[0], grid[y0 * grid_size + x0].no);
<a name="l00495"></a>00495         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[1], grid[y0 * grid_size + x1].no);
<a name="l00496"></a>00496         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[2], grid[y1 * grid_size + x1].no);
<a name="l00497"></a>00497         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[3], grid[y1 * grid_size + x0].no);
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <span class="keywordflow">else</span> {
<a name="l00500"></a>00500         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[0], grid[y0 * grid_size + x0].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l00501"></a>00501         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[1], grid[y0 * grid_size + x1].co);
<a name="l00502"></a>00502         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[2], grid[y1 * grid_size + x1].co);
<a name="l00503"></a>00503         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data[3], grid[y1 * grid_size + x0].co);
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <a class="code" href="../../d5/d58/object__bake_8c.html#af06641cd0fc9a437fa2a0260719a278a">interp_bilinear_quad_data</a>(data, u, v, res);
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ab623684b94ab63ca83fd6c33e0a4c89d">00509</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ab623684b94ab63ca83fd6c33e0a4c89d">get_ccgdm_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lodm, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *hidm, <span class="keyword">const</span> <span class="keywordtype">int</span> *origindex,  <span class="keyword">const</span> <span class="keywordtype">int</span> lvl, <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">float</span> u, <span class="keyword">const</span> <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> n[3])
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> mface;
<a name="l00512"></a>00512     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **grid_data;
<a name="l00513"></a>00513     <span class="keywordtype">float</span> crn_x, crn_y;
<a name="l00514"></a>00514     <span class="keywordtype">int</span> grid_size, S, face_side;
<a name="l00515"></a>00515     <span class="keywordtype">int</span> *grid_offset, g_index;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     lodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a5e9f5a12578811093d3747ea03e86945">getTessFace</a>(lodm, face_index, &amp;mface);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     grid_size= hidm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(hidm);
<a name="l00520"></a>00520     grid_data= hidm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(hidm);
<a name="l00521"></a>00521     grid_offset= hidm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5a69ae7361f77bef729afa2ec720488">getGridOffset</a>(hidm);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     face_side= (grid_size&lt;&lt;1)-1;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (lvl==0) {
<a name="l00526"></a>00526         g_index= grid_offset[face_index];
<a name="l00527"></a>00527         S= <a class="code" href="../../d1/d37/BKE__multires_8h.html#a534b5f4e07113cd6979371d7c0e8a6ab">mdisp_rot_face_to_crn</a>(mface.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3, face_side, u*(face_side-1), v*(face_side-1), &amp;crn_x, &amp;crn_y);
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     <span class="keywordflow">else</span> {
<a name="l00530"></a>00530         <span class="keywordtype">int</span> side= (1 &lt;&lt; (lvl-1)) + 1;
<a name="l00531"></a>00531         <span class="keywordtype">int</span> grid_index= origindex[face_index];
<a name="l00532"></a>00532         <span class="keywordtype">int</span> loc_offs= face_index % (1&lt;&lt;(2*lvl));
<a name="l00533"></a>00533         <span class="keywordtype">int</span> cell_index= loc_offs % ((side-1)*(side-1));
<a name="l00534"></a>00534         <span class="keywordtype">int</span> cell_side= grid_size / (side-1);
<a name="l00535"></a>00535         <span class="keywordtype">int</span> row= cell_index / (side-1);
<a name="l00536"></a>00536         <span class="keywordtype">int</span> col= cell_index % (side-1);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         S= face_index / (1&lt;&lt;(2*(lvl-1))) - grid_offset[grid_index];
<a name="l00539"></a>00539         g_index= grid_offset[grid_index];
<a name="l00540"></a>00540 
<a name="l00541"></a>00541         crn_y= (row * cell_side) + u * cell_side;
<a name="l00542"></a>00542         crn_x= (col * cell_side) + v * cell_side;
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(crn_x, 0.0f, grid_size);
<a name="l00546"></a>00546     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(crn_y, 0.0f, grid_size);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (n != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00549"></a>00549         <a class="code" href="../../d5/d58/object__bake_8c.html#a87f47be967032fc570cc43a2189b488f">interp_bilinear_grid</a>(grid_data[g_index + S], grid_size, crn_x, crn_y, 0, n);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (co != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00552"></a>00552         <a class="code" href="../../d5/d58/object__bake_8c.html#a87f47be967032fc570cc43a2189b488f">interp_bilinear_grid</a>(grid_data[g_index + S], grid_size, crn_x, crn_y, 1, co);
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 <span class="comment">/* mode = 0: interpolate normals,</span>
<a name="l00556"></a>00556 <span class="comment"> * mode = 1: interpolate coord */</span>
<a name="l00557"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ae892ff78b179b1372d56a632b8f39ce4">00557</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ae892ff78b179b1372d56a632b8f39ce4">interp_bilinear_mface</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface, <span class="keyword">const</span> <span class="keywordtype">float</span> u, <span class="keyword">const</span> <span class="keywordtype">float</span> v, <span class="keyword">const</span> <span class="keywordtype">int</span> mode, <span class="keywordtype">float</span> res[3])
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[4][3];
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (mode == 0) {
<a name="l00562"></a>00562         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, data[0]);
<a name="l00563"></a>00563         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, data[1]);
<a name="l00564"></a>00564         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, data[2]);
<a name="l00565"></a>00565         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, data[3]);
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567     <span class="keywordflow">else</span> {
<a name="l00568"></a>00568         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, data[0]);
<a name="l00569"></a>00569         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, data[1]);
<a name="l00570"></a>00570         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, data[2]);
<a name="l00571"></a>00571         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, data[3]);
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <a class="code" href="../../d5/d58/object__bake_8c.html#af06641cd0fc9a437fa2a0260719a278a">interp_bilinear_quad_data</a>(data, u, v, res);
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 <span class="comment">/* mode = 0: interpolate normals,</span>
<a name="l00578"></a>00578 <span class="comment"> * mode = 1: interpolate coord */</span>
<a name="l00579"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ab73d4891c2a1b496261b8ae92cca5b01">00579</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ab73d4891c2a1b496261b8ae92cca5b01">interp_barycentric_mface</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface, <span class="keyword">const</span> <span class="keywordtype">float</span> u, <span class="keyword">const</span> <span class="keywordtype">float</span> v, <span class="keyword">const</span> <span class="keywordtype">int</span> mode, <span class="keywordtype">float</span> res[3])
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[3][3];
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="keywordflow">if</span> (mode == 0) {
<a name="l00584"></a>00584         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, data[0]);
<a name="l00585"></a>00585         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, data[1]);
<a name="l00586"></a>00586         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, data[2]);
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588     <span class="keywordflow">else</span> {
<a name="l00589"></a>00589         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, data[0]);
<a name="l00590"></a>00590         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, data[1]);
<a name="l00591"></a>00591         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, data[2]);
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <a class="code" href="../../d5/d58/object__bake_8c.html#a8e9f5497c4e2d5ecc13a33e4387c7007">interp_barycentric_tri_data</a>(data, u, v, res);
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="../../d5/d58/object__bake_8c.html#aa48b51a1f7383eb4b9f76a0420e3dfde">00597</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d5/d58/object__bake_8c.html#aa48b51a1f7383eb4b9f76a0420e3dfde">init_heights_data</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599     <a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a> *height_data;
<a name="l00600"></a>00600     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00601"></a>00601     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lodm= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     height_data= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a>), <span class="stringliteral">&quot;MultiresBake heightData&quot;</span>);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#aa0e4ee6881f697ed9c7a3e05ea835174">ima</a>= ima;
<a name="l00606"></a>00606     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">heights</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, <span class="stringliteral">&quot;MultiresBake heights&quot;</span>);
<a name="l00607"></a>00607     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#ae4e5d393fb345bef4c24d6e8c917a7db">height_max</a>= -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00608"></a>00608     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a9be18f2b933b2236a0f769226e617020">height_min</a>= <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">if</span> (!bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a3ba5134558cc6e551ba0f33e9f190c09">use_lores_mesh</a>) {
<a name="l00611"></a>00611         <a class="code" href="../../dd/d1e/structSubsurfModifierData.html">SubsurfModifierData</a> smd= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l00612"></a>00612         <span class="keywordtype">int</span> ss_lvl= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad1ffe8c56145dc7ae55763221c67483f">tot_lvl</a> - bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#aa3d3898095b29abd4e4f12eee38c8fca">lvl</a>;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ss_lvl, 0, 6);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#a64dfc0dbc8ce587b1e52733070241363">levels</a>= smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#ae33b8e5900f6cf266e869afb917f32ee">renderLevels</a>= ss_lvl;
<a name="l00617"></a>00617         smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#a855e94b53a58822910cd3f6826e72d2d">flags</a>|= <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ac6b7c4d55e26c3c444a936564f87bff0a49eca173d91020c659dbdef8b0124039">eSubsurfModifierFlag_SubsurfUv</a>;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a489d2c607d370f8410e867119e8dd364">simple</a>)
<a name="l00620"></a>00620             smd.<a class="code" href="../../dd/d1e/structSubsurfModifierData.html#ac73fe5bff5b1eb4f16b894077e7cd074">subdivType</a>= <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ac71f32bc6bc13b67e1623716119ea688">ME_SIMPLE_SUBSURF</a>;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>= <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a57ccebcc6ff96fae9584945985e6d916">subsurf_make_derived_from_derived</a>(bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>, &amp;smd, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, 0);
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a8ef686b8b6bf23ddbdf66994a2f12eb6">origindex</a>= lodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(lodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)height_data;
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a9f0546a4126fba949ca38f8a5d587fb4">00630</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d5/d58/object__bake_8c.html#a9f0546a4126fba949ca38f8a5d587fb4">init_normal_data</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ima))
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632     <a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a> *normal_data;
<a name="l00633"></a>00633     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lodm= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     normal_data= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a>), <span class="stringliteral">&quot;MultiresBake normalData&quot;</span>);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     normal_data-&gt;<a class="code" href="../../d4/ddd/structMNormalBakeData.html#ad648598c9756cfaa931b72297a43ca81">origindex</a>= lodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(lodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)normal_data;
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a8a8eda167739ff24d4f50ea024899018">00642</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a8a8eda167739ff24d4f50ea024899018">free_normal_data</a>(<span class="keywordtype">void</span> *bake_data)
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644     <a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a> *normal_data= (<a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a>*)bake_data;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(normal_data);
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a0180ae8dbdb938d1d7512d2263ccf3c0">00649</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a0180ae8dbdb938d1d7512d2263ccf3c0">apply_heights_data</a>(<span class="keywordtype">void</span> *bake_data)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651     <a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a> *height_data= (<a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a>*)bake_data;
<a name="l00652"></a>00652     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#aa0e4ee6881f697ed9c7a3e05ea835174">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00653"></a>00653     <span class="keywordtype">int</span> x, y, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00654"></a>00654     <span class="keywordtype">float</span> height, *heights= height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">heights</a>;
<a name="l00655"></a>00655     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>= height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a9be18f2b933b2236a0f769226e617020">height_min</a>, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#ae4e5d393fb345bef4c24d6e8c917a7db">height_max</a>;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     <span class="keywordflow">for</span> (x= 0; x&lt;ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>; x++) {
<a name="l00658"></a>00658         <span class="keywordflow">for</span> (y =0; y&lt;ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; y++) {
<a name="l00659"></a>00659             i= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*y + x;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661             <span class="keywordflow">if</span> (((<span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>)[i] != <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2205ba007ff3e14a265b05a4270a944d">FILTER_MASK_USED</a>)
<a name="l00662"></a>00662                 <span class="keywordflow">continue</span>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00665"></a>00665                 <span class="keywordtype">float</span> *rrgbf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + i*4;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>-min &gt; 1e-5f) height= (heights[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>)/(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>-min);
<a name="l00668"></a>00668                 <span class="keywordflow">else</span> height= 0;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670                 rrgbf[0]=rrgbf[1]=rrgbf[2]= height;
<a name="l00671"></a>00671             }
<a name="l00672"></a>00672             <span class="keywordflow">else</span> {
<a name="l00673"></a>00673                 <span class="keywordtype">char</span> *rrgb= (<span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + i*4;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>-min &gt; 1e-5f) height= (heights[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>)/(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>-min);
<a name="l00676"></a>00676                 <span class="keywordflow">else</span> height= 0;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                 rrgb[0]=rrgb[1]=rrgb[2]= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(height);
<a name="l00679"></a>00679             }
<a name="l00680"></a>00680         }
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ac2069aafb64b9d71df9b98d1ab901fa5">00686</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ac2069aafb64b9d71df9b98d1ab901fa5">free_heights_data</a>(<span class="keywordtype">void</span> *bake_data)
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688     <a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a> *height_data= (<a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a>*)bake_data;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>)
<a name="l00691"></a>00691         height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">heights</a>);
<a name="l00694"></a>00694     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(height_data);
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 <span class="comment">/* MultiresBake callback for heights baking</span>
<a name="l00698"></a>00698 <span class="comment"> * general idea:</span>
<a name="l00699"></a>00699 <span class="comment"> *   - find coord of point with specified UV in hi-res mesh (let&#39;s call it p1)</span>
<a name="l00700"></a>00700 <span class="comment"> *   - find coord of point and normal with specified UV in lo-res mesh (or subdivided lo-res</span>
<a name="l00701"></a>00701 <span class="comment"> *     mesh to make texture smoother) let&#39;s call this point p0 and n.</span>
<a name="l00702"></a>00702 <span class="comment"> *   - height wound be dot(n, p1-p0) */</span>
<a name="l00703"></a><a class="code" href="../../d5/d58/object__bake_8c.html#aa645b2cdc47a669a3fe2eb2c797b37f6">00703</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#aa645b2cdc47a669a3fe2eb2c797b37f6">apply_heights_callback</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lores_dm, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *hires_dm, <span class="keyword">const</span> <span class="keywordtype">void</span> *bake_data,
<a name="l00704"></a>00704                                    <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">int</span> lvl, <span class="keyword">const</span> <span class="keywordtype">float</span> st[2],
<a name="l00705"></a>00705                                    <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(tangmat[3][3]), <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;lores_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l00708"></a>00708     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> mface;
<a name="l00709"></a>00709     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l00710"></a>00710     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00711"></a>00711     <a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a> *height_data= (<a class="code" href="../../d3/d89/structMHeightBakeData.html">MHeightBakeData</a>*)bake_data;
<a name="l00712"></a>00712     <span class="keywordtype">float</span> uv[2], *st0, *st1, *st2, *st3;
<a name="l00713"></a>00713     <span class="keywordtype">int</span> pixel= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*y + x;
<a name="l00714"></a>00714     <span class="keywordtype">float</span> vec[3], p0[3], p1[3], n[3], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     lores_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a5e9f5a12578811093d3747ea03e86945">getTessFace</a>(lores_dm, face_index, &amp;mface);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     st0= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0];
<a name="l00719"></a>00719     st1= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1];
<a name="l00720"></a>00720     st2= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (mface.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00723"></a>00723         st3= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3];
<a name="l00724"></a>00724         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aa3a0b3c83afe874d2639015f794fb01c">resolve_quad_uv</a>(uv, st, st0, st1, st2, st3);
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726     <span class="keywordflow">else</span>
<a name="l00727"></a>00727         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3b21d6ce6bebb39febe24bb62ba150f5">resolve_tri_uv</a>(uv, st, st0, st1, st2);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[0], 0.0f, 1.0f);
<a name="l00730"></a>00730     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[1], 0.0f, 1.0f);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <a class="code" href="../../d5/d58/object__bake_8c.html#ab623684b94ab63ca83fd6c33e0a4c89d">get_ccgdm_data</a>(lores_dm, hires_dm, height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a8ef686b8b6bf23ddbdf66994a2f12eb6">origindex</a>, lvl, face_index, uv[0], uv[1], p1, 0);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>) {
<a name="l00735"></a>00735         <a class="code" href="../../d5/d58/object__bake_8c.html#ab623684b94ab63ca83fd6c33e0a4c89d">get_ccgdm_data</a>(lores_dm, height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a0c61fe1266b70642445990190e00e8f9">ssdm</a>, height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a8ef686b8b6bf23ddbdf66994a2f12eb6">origindex</a>, 0, face_index, uv[0], uv[1], p0, n);
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737     <span class="keywordflow">else</span> {
<a name="l00738"></a>00738         lores_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a5e9f5a12578811093d3747ea03e86945">getTessFace</a>(lores_dm, face_index, &amp;mface);
<a name="l00739"></a>00739 
<a name="l00740"></a>00740         <span class="keywordflow">if</span> (mface.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00741"></a>00741             <a class="code" href="../../d5/d58/object__bake_8c.html#ae892ff78b179b1372d56a632b8f39ce4">interp_bilinear_mface</a>(lores_dm, &amp;mface, uv[0], uv[1], 1, p0);
<a name="l00742"></a>00742             <a class="code" href="../../d5/d58/object__bake_8c.html#ae892ff78b179b1372d56a632b8f39ce4">interp_bilinear_mface</a>(lores_dm, &amp;mface, uv[0], uv[1], 0, n);
<a name="l00743"></a>00743         }
<a name="l00744"></a>00744         <span class="keywordflow">else</span> {
<a name="l00745"></a>00745             <a class="code" href="../../d5/d58/object__bake_8c.html#ab73d4891c2a1b496261b8ae92cca5b01">interp_barycentric_mface</a>(lores_dm, &amp;mface, uv[0], uv[1], 1, p0);
<a name="l00746"></a>00746             <a class="code" href="../../d5/d58/object__bake_8c.html#ab73d4891c2a1b496261b8ae92cca5b01">interp_barycentric_mface</a>(lores_dm, &amp;mface, uv[0], uv[1], 0, n);
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, p1, p0);
<a name="l00751"></a>00751     len= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, vec);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#adc173ca730f7d7e108e53d06007f9bbd">heights</a>[pixel]= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (len&lt;height_data-&gt;height_min) height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#a9be18f2b933b2236a0f769226e617020">height_min</a>= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00755"></a>00755     <span class="keywordflow">if</span> (len&gt;height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#ae4e5d393fb345bef4c24d6e8c917a7db">height_max</a>) height_data-&gt;<a class="code" href="../../d3/d89/structMHeightBakeData.html#ae4e5d393fb345bef4c24d6e8c917a7db">height_max</a>= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00758"></a>00758         <span class="keywordtype">float</span> *rrgbf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + pixel*4;
<a name="l00759"></a>00759         rrgbf[3]= 1.0f;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763     <span class="keywordflow">else</span> {
<a name="l00764"></a>00764         <span class="keywordtype">char</span> *rrgb= (<span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + pixel*4;
<a name="l00765"></a>00765         rrgb[3]= 255;
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="comment">/* MultiresBake callback for normals&#39; baking</span>
<a name="l00770"></a>00770 <span class="comment"> * general idea:</span>
<a name="l00771"></a>00771 <span class="comment"> *   - find coord and normal of point with specified UV in hi-res mesh</span>
<a name="l00772"></a>00772 <span class="comment"> *   - multiply it by tangmat</span>
<a name="l00773"></a>00773 <span class="comment"> *   - vector in color space would be norm(vec) /2 + (0.5, 0.5, 0.5) */</span>
<a name="l00774"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a6d5fd0ae0b590436c2edb5f8e18b3683">00774</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a6d5fd0ae0b590436c2edb5f8e18b3683">apply_tangmat_callback</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lores_dm, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *hires_dm, <span class="keyword">const</span> <span class="keywordtype">void</span> *bake_data,
<a name="l00775"></a>00775                                    <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">int</span> lvl, <span class="keyword">const</span> <span class="keywordtype">float</span> st[2],
<a name="l00776"></a>00776                                    <span class="keywordtype">float</span> tangmat[3][3], <span class="keyword">const</span> <span class="keywordtype">int</span> x, <span class="keyword">const</span> <span class="keywordtype">int</span> y)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;lores_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l00779"></a>00779     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> mface;
<a name="l00780"></a>00780     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l00781"></a>00781     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00782"></a>00782     <a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a> *normal_data= (<a class="code" href="../../d4/ddd/structMNormalBakeData.html">MNormalBakeData</a>*)bake_data;
<a name="l00783"></a>00783     <span class="keywordtype">float</span> uv[2], *st0, *st1, *st2, *st3;
<a name="l00784"></a>00784     <span class="keywordtype">int</span> pixel= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*y + x;
<a name="l00785"></a>00785     <span class="keywordtype">float</span> n[3], vec[3], tmp[3]= {0.5, 0.5, 0.5};
<a name="l00786"></a>00786 
<a name="l00787"></a>00787     lores_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a5e9f5a12578811093d3747ea03e86945">getTessFace</a>(lores_dm, face_index, &amp;mface);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     st0= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0];
<a name="l00790"></a>00790     st1= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1];
<a name="l00791"></a>00791     st2= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (mface.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00794"></a>00794         st3= mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3];
<a name="l00795"></a>00795         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aa3a0b3c83afe874d2639015f794fb01c">resolve_quad_uv</a>(uv, st, st0, st1, st2, st3);
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797     <span class="keywordflow">else</span>
<a name="l00798"></a>00798         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3b21d6ce6bebb39febe24bb62ba150f5">resolve_tri_uv</a>(uv, st, st0, st1, st2);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[0], 0.0f, 1.0f);
<a name="l00801"></a>00801     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[1], 0.0f, 1.0f);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <a class="code" href="../../d5/d58/object__bake_8c.html#ab623684b94ab63ca83fd6c33e0a4c89d">get_ccgdm_data</a>(lores_dm, hires_dm, normal_data-&gt;<a class="code" href="../../d4/ddd/structMNormalBakeData.html#ad648598c9756cfaa931b72297a43ca81">origindex</a>, lvl, face_index, uv[0], uv[1], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, n);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a56f9b5ad5a4e2ee9c6fc9800cf19a66b">mul_v3_m3v3</a>(vec, tangmat, n);
<a name="l00806"></a>00806     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l00807"></a>00807     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, 0.5);
<a name="l00808"></a>00808     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, tmp);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00811"></a>00811         <span class="keywordtype">float</span> *rrgbf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + pixel*4;
<a name="l00812"></a>00812         rrgbf[0]= vec[0];
<a name="l00813"></a>00813         rrgbf[1]= vec[1];
<a name="l00814"></a>00814         rrgbf[2]= vec[2];
<a name="l00815"></a>00815         rrgbf[3]= 1.0f;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     <span class="keywordflow">else</span> {
<a name="l00820"></a>00820         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rrgb= (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + pixel*4;
<a name="l00821"></a>00821         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a9b3bb8bb3331550782244e732cd1d349">rgb_float_to_uchar</a>(rrgb, vec);
<a name="l00822"></a>00822         rrgb[3]= 255;
<a name="l00823"></a>00823     }
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a30a4bc99643e95015ed26b10c46c44e0">00826</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a30a4bc99643e95015ed26b10c46c44e0">count_images</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828     <span class="keywordtype">int</span> a, totface;
<a name="l00829"></a>00829     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>;
<a name="l00830"></a>00830     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00833"></a>00833     bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a692a1bb523a2d93985545ce3ed584bb3">tot_image</a>= 0;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="keywordflow">for</span> (a= 0; a&lt;totface; a++)
<a name="l00838"></a>00838         mtface[a].tpage-&gt;id.<a class="code" href="../../da/d7f/structMTFace.html#acacfa01617190acb5fbc1d8ca1454c70">flag</a>&amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     for (a= 0; a&lt;totface; a++) {
<a name="l00841"></a>00841         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= mtface[a].<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l00842"></a>00842         <span class="keywordflow">if</span> ((ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a>&amp;<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>)==0) {
<a name="l00843"></a>00843             <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a45c2880c1c8f58f11583cf0ddcc06697">BLI_genericNodeN</a>(ima);
<a name="l00844"></a>00844             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>, data);
<a name="l00845"></a>00845             bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a692a1bb523a2d93985545ce3ed584bb3">tot_image</a>++;
<a name="l00846"></a>00846             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a>|= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848     }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="keywordflow">for</span> (a= 0; a&lt;totface; a++)
<a name="l00851"></a>00851         mtface[a].tpage-&gt;id.<a class="code" href="../../da/d7f/structMTFace.html#acacfa01617190acb5fbc1d8ca1454c70">flag</a>&amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
<a name="l00854"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a9dc31a05be4890cb30d508b0e3b21df5">00854</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a9dc31a05be4890cb30d508b0e3b21df5">bake_images</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#aaa63f127f8b967960d824c4cf6e93ca0">link</a>;
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">for</span> (link= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; link; link= link-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l00859"></a>00859         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= (<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a>*)link-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>;
<a name="l00860"></a>00860         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         <span class="keywordflow">if</span> (ibuf-&gt;x&gt;0 &amp;&amp; ibuf-&gt;y&gt;0) {
<a name="l00863"></a>00863             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(ibuf-&gt;y*ibuf-&gt;x, <span class="stringliteral">&quot;MultiresBake imbuf mask&quot;</span>);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865             <span class="keywordflow">switch</span>(bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a2aebe060d0ff56962bae8dd1e2a7a241">mode</a>) {
<a name="l00866"></a>00866                 <span class="keywordflow">case</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a25121784d1440eec23c9901cf8476820">RE_BAKE_NORMALS</a>:
<a name="l00867"></a>00867                     <a class="code" href="../../d5/d58/object__bake_8c.html#a2420729dd71720f1c81b1dfa61628999">do_multires_bake</a>(bkr, ima, <a class="code" href="../../d5/d58/object__bake_8c.html#a6d5fd0ae0b590436c2edb5f8e18b3683">apply_tangmat_callback</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#a9f0546a4126fba949ca38f8a5d587fb4">init_normal_data</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#a8a8eda167739ff24d4f50ea024899018">free_normal_data</a>);
<a name="l00868"></a>00868                     <span class="keywordflow">break</span>;
<a name="l00869"></a>00869                 <span class="keywordflow">case</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ada2e4a24643a6fef3c1968967a0fc71b">RE_BAKE_DISPLACEMENT</a>:
<a name="l00870"></a>00870                     <a class="code" href="../../d5/d58/object__bake_8c.html#a2420729dd71720f1c81b1dfa61628999">do_multires_bake</a>(bkr, ima, <a class="code" href="../../d5/d58/object__bake_8c.html#aa645b2cdc47a669a3fe2eb2c797b37f6">apply_heights_callback</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#aa48b51a1f7383eb4b9f76a0420e3dfde">init_heights_data</a>,
<a name="l00871"></a>00871                                      <a class="code" href="../../d5/d58/object__bake_8c.html#a0180ae8dbdb938d1d7512d2263ccf3c0">apply_heights_data</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#ac2069aafb64b9d71df9b98d1ab901fa5">free_heights_data</a>);
<a name="l00872"></a>00872                     <span class="keywordflow">break</span>;
<a name="l00873"></a>00873             }
<a name="l00874"></a>00874         }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a>|= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878 }
<a name="l00879"></a>00879 
<a name="l00880"></a><a class="code" href="../../d5/d58/object__bake_8c.html#adcf5b3d58716df40709c4f70ca71958f">00880</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#adcf5b3d58716df40709c4f70ca71958f">finish_images</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr)
<a name="l00881"></a>00881 {
<a name="l00882"></a>00882     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#aaa63f127f8b967960d824c4cf6e93ca0">link</a>;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884     <span class="keywordflow">for</span> (link= bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; link; link= link-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a5e24b2a72895050a8c968e55b8dce1e3">next</a>) {
<a name="l00885"></a>00885         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= (<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a>*)link-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>;
<a name="l00886"></a>00886         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="keywordflow">if</span> (ibuf-&gt;x&lt;=0 || ibuf-&gt;y&lt;=0)
<a name="l00889"></a>00889             <span class="keywordflow">continue</span>;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#ae0c935b8fca81c6419848a186c191c03">RE_bake_ibuf_filter</a>(ibuf, (<span class="keywordtype">char</span> *)ibuf-&gt;userdata, bkr-&gt;<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ac7fb89794d4ac44b7feb4d4eb365fc15">bake_filter</a>);
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         ibuf-&gt;userflags|= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (ibuf-&gt;rect_float)
<a name="l00896"></a>00896             ibuf-&gt;userflags|= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898         <span class="keywordflow">if</span> (ibuf-&gt;mipmap[0]) {
<a name="l00899"></a>00899             ibuf-&gt;userflags|= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l00900"></a>00900             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a6f8bb9e85153806a1ffe7c27e8a284b6">imb_freemipmapImBuf</a>(ibuf);
<a name="l00901"></a>00901         }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903         <span class="keywordflow">if</span> (ibuf-&gt;userdata) {
<a name="l00904"></a>00904             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ibuf-&gt;userdata);
<a name="l00905"></a>00905             ibuf-&gt;userdata= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00906"></a>00906         }
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00910"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ad5e6f47b175ae2806db90fd5079a9501">00910</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ad5e6f47b175ae2806db90fd5079a9501">multiresbake_start</a>(<a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> *bkr)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912     <a class="code" href="../../d5/d58/object__bake_8c.html#a30a4bc99643e95015ed26b10c46c44e0">count_images</a>(bkr);
<a name="l00913"></a>00913     <a class="code" href="../../d5/d58/object__bake_8c.html#a9dc31a05be4890cb30d508b0e3b21df5">bake_images</a>(bkr);
<a name="l00914"></a>00914     <a class="code" href="../../d5/d58/object__bake_8c.html#adcf5b3d58716df40709c4f70ca71958f">finish_images</a>(bkr);
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a213788981236cd24d27f7129a551d189">00917</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a213788981236cd24d27f7129a551d189">multiresbake_check</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00920"></a>00920     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00921"></a>00921     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00922"></a>00922     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd;
<a name="l00923"></a>00923     <span class="keywordtype">int</span> ok= 1, a;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a>*, base, selected_editable_bases) {
<a name="l00926"></a>00926         ob= base-&gt;object;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00929"></a>00929             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Basking of multires data only works with active object which is a mesh&quot;</span>);
<a name="l00930"></a>00930 
<a name="l00931"></a>00931             ok= 0;
<a name="l00932"></a>00932             <span class="keywordflow">break</span>;
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935         me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00936"></a>00936         mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 0);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938         <span class="comment">/* Multi-resolution should be and be last in the stack */</span>
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (ok &amp;&amp; mmd) {
<a name="l00940"></a>00940             <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942             ok= mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1471c3c37841cbfe33f8be4783bcf95b">totlvl</a>&gt;0;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944             <span class="keywordflow">for</span> (md = (<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a>*)mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a1086b878eeabc64e06962eee740bd75e">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>; md &amp;&amp; ok; md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l00945"></a>00945                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>)) {
<a name="l00946"></a>00946                     ok= 0;
<a name="l00947"></a>00947                 }
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949         }
<a name="l00950"></a>00950         <span class="keywordflow">else</span> ok= 0;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (!ok) {
<a name="l00953"></a>00953             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Multires data baking requires multi-resolution object&quot;</span>);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955             <span class="keywordflow">break</span>;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958         <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a33e1a6e421ec6271ac147aea17092ec1">mtpoly</a>) {
<a name="l00959"></a>00959             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Mesh should be unwrapped before multires data baking&quot;</span>);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961             ok= 0;
<a name="l00962"></a>00962         }
<a name="l00963"></a>00963         <span class="keywordflow">else</span> {
<a name="l00964"></a>00964             a = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>;
<a name="l00965"></a>00965             <span class="keywordflow">while</span> (ok &amp;&amp; a--) {
<a name="l00966"></a>00966                 <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a33e1a6e421ec6271ac147aea17092ec1">mtpoly</a>[a].<a class="code" href="../../de/d88/structMTexPoly.html#acd90db38c741566c1f6adcdf59799b46">tpage</a>;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968                 <span class="keywordflow">if</span> (!ima) {
<a name="l00969"></a>00969                     <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;You should have active texture to use multires baker&quot;</span>);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971                     ok= 0;
<a name="l00972"></a>00972                 }
<a name="l00973"></a>00973                 <span class="keywordflow">else</span> {
<a name="l00974"></a>00974                     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976                     <span class="keywordflow">if</span> (!ibuf) {
<a name="l00977"></a>00977                         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Baking should happend to image with image buffer&quot;</span>);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979                         ok= 0;
<a name="l00980"></a>00980                     }
<a name="l00981"></a>00981                     <span class="keywordflow">else</span> {
<a name="l00982"></a>00982                         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00983"></a>00983                             ok= 0;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>==0 || ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>==4))
<a name="l00986"></a>00986                             ok= 0;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                         <span class="keywordflow">if</span> (!ok)
<a name="l00989"></a>00989                             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Baking to unsupported image type&quot;</span>);
<a name="l00990"></a>00990                     }
<a name="l00991"></a>00991                 }
<a name="l00992"></a>00992             }
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995         <span class="keywordflow">if</span> (!ok)
<a name="l00996"></a>00996             <span class="keywordflow">break</span>;
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="keywordflow">return</span> ok;
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a><a class="code" href="../../d5/d58/object__bake_8c.html#af972c1f2afd5bf14ef9b40c90e8755d2">01003</a> <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d5/d58/object__bake_8c.html#af972c1f2afd5bf14ef9b40c90e8755d2">multiresbake_create_loresdm</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> *lvl)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l01006"></a>01006     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 0);
<a name="l01007"></a>01007     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     *lvl= mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (*lvl==0) {
<a name="l01012"></a>01012         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tmp_dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01013"></a>01013         dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(tmp_dm);
<a name="l01014"></a>01014         tmp_dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(tmp_dm);
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016     <span class="keywordflow">else</span> {
<a name="l01017"></a>01017         <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> tmp_mmd= *mmd;
<a name="l01018"></a>01018         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *cddm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020         tmp_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>= *lvl;
<a name="l01021"></a>01021         tmp_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>= *lvl;
<a name="l01022"></a>01022         dm= <a class="code" href="../../d1/d37/BKE__multires_8h.html#a2bc39adcf1c2a2c78ca9c59be60b8d0f">multires_dm_create_from_derived</a>(&amp;tmp_mmd, 1, cddm, ob, 0);
<a name="l01023"></a>01023         cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l01024"></a>01024     }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <span class="keywordflow">return</span> dm;
<a name="l01027"></a>01027 }
<a name="l01028"></a>01028 
<a name="l01029"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a5cbc3fadc380f4cf3233c653cfc92ddc">01029</a> <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d5/d58/object__bake_8c.html#a5cbc3fadc380f4cf3233c653cfc92ddc">multiresbake_create_hiresdm</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> *lvl, <span class="keywordtype">int</span> *simple)
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01032"></a>01032     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 0);
<a name="l01033"></a>01033     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> tmp_mmd= *mmd;
<a name="l01034"></a>01034     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *cddm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01035"></a>01035     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     *lvl= mmd-&gt;totlvl;
<a name="l01038"></a>01038     *simple= mmd-&gt;simple;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     tmp_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a816e0ca5629d18ea4d1caf55cc76e8e5">lvl</a>= mmd-&gt;totlvl;
<a name="l01041"></a>01041     tmp_mmd.<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>= mmd-&gt;totlvl;
<a name="l01042"></a>01042     dm= <a class="code" href="../../d1/d37/BKE__multires_8h.html#a2bc39adcf1c2a2c78ca9c59be60b8d0f">multires_dm_create_from_derived</a>(&amp;tmp_mmd, 1, cddm, ob, 0);
<a name="l01043"></a>01043     cddm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(cddm);
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">return</span> dm;
<a name="l01046"></a>01046 }
<a name="l01047"></a>01047 
<a name="l01048"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a02cda2d0a817f0030e09b0681e982048">01048</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a02cda2d0a817f0030e09b0681e982048">clear_images</a>(<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface, <span class="keywordtype">int</span> totface)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050     <span class="keywordtype">int</span> a;
<a name="l01051"></a>01051     <span class="keyword">const</span> <span class="keywordtype">float</span> vec_alpha[4]= {0.0f, 0.0f, 0.0f, 0.0f};
<a name="l01052"></a>01052     <span class="keyword">const</span> <span class="keywordtype">float</span> vec_solid[4]= {0.0f, 0.0f, 0.0f, 1.0f};
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keywordflow">for</span> (a= 0; a&lt;totface; a++)
<a name="l01055"></a>01055         mtface[a].tpage-&gt;id.<a class="code" href="../../da/d7f/structMTFace.html#acacfa01617190acb5fbc1d8ca1454c70">flag</a>&amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     for (a= 0; a&lt;totface; a++) {
<a name="l01058"></a>01058         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= mtface[a].<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060         <span class="keywordflow">if</span> ((ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a>&amp;<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>)==0) {
<a name="l01061"></a>01061             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063             <a class="code" href="../../dd/d38/iff_8h.html#ae67a3a18923ca91dc1b9835bc35df35c">IMB_rectfill</a>(ibuf, (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>) ? vec_alpha : vec_solid);
<a name="l01064"></a>01064             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a>|= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="keywordflow">for</span> (a= 0; a&lt;totface; a++)
<a name="l01069"></a>01069         mtface[a].tpage-&gt;id.<a class="code" href="../../da/d7f/structMTFace.html#acacfa01617190acb5fbc1d8ca1454c70">flag</a>&amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l01070"></a>01070 }
<a name="l01071"></a>01071 
<a name="l01072"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a683895c8918809414d24ded448900fe7">01072</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a683895c8918809414d24ded448900fe7">multiresbake_image_exec_locked</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01073"></a>01073 {
<a name="l01074"></a>01074     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01075"></a>01075     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01076"></a>01076     <span class="keywordtype">int</span> objects_baked= 0;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d58/object__bake_8c.html#a213788981236cd24d27f7129a551d189">multiresbake_check</a>(C, op))
<a name="l01079"></a>01079         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a>&amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a14571df5abb1ae871ad447e5cff5b967">R_BAKE_CLEAR</a>) {  <span class="comment">/* clear images */</span>
<a name="l01082"></a>01082         <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a>*, base, selected_editable_bases) {
<a name="l01083"></a>01083             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085             ob= base-&gt;object;
<a name="l01086"></a>01086             me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088             <a class="code" href="../../d5/d58/object__bake_8c.html#a02cda2d0a817f0030e09b0681e982048">clear_images</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l01089"></a>01089         }
<a name="l01090"></a>01090         <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a>*, base, selected_editable_bases) {
<a name="l01094"></a>01094         <a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> bkr= {0};
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         ob= base-&gt;object;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098         <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100         <span class="comment">/* copy data stored in job descriptor */</span>
<a name="l01101"></a>01101         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ac7fb89794d4ac44b7feb4d4eb365fc15">bake_filter</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6ad7d51845798984f1050c4314062829">bake_filter</a>;
<a name="l01102"></a>01102         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a2aebe060d0ff56962bae8dd1e2a7a241">mode</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>;
<a name="l01103"></a>01103         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a3ba5134558cc6e551ba0f33e9f190c09">use_lores_mesh</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a>&amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af72dada0a81a3053dfa2e7801dc27a5d">R_BAKE_LORES_MESH</a>;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105         <span class="comment">/* create low-resolution DM (to bake to) and hi-resolution DM (to bake from) */</span>
<a name="l01106"></a>01106         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>= <a class="code" href="../../d5/d58/object__bake_8c.html#af972c1f2afd5bf14ef9b40c90e8755d2">multiresbake_create_loresdm</a>(scene, ob, &amp;bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#aa3d3898095b29abd4e4f12eee38c8fca">lvl</a>);
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="keywordflow">if</span> (!bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>)
<a name="l01109"></a>01109             <span class="keywordflow">continue</span>;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a23c8bf1e11c2edb294ed090f20a9d1a3">hires_dm</a>= <a class="code" href="../../d5/d58/object__bake_8c.html#a5cbc3fadc380f4cf3233c653cfc92ddc">multiresbake_create_hiresdm</a>(scene, ob, &amp;bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad1ffe8c56145dc7ae55763221c67483f">tot_lvl</a>, &amp;bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a489d2c607d370f8410e867119e8dd364">simple</a>);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113         <a class="code" href="../../d5/d58/object__bake_8c.html#ad5e6f47b175ae2806db90fd5079a9501">multiresbake_start</a>(&amp;bkr);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>);
<a name="l01118"></a>01118         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a23c8bf1e11c2edb294ed090f20a9d1a3">hires_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a23c8bf1e11c2edb294ed090f20a9d1a3">hires_dm</a>);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120         objects_baked++;
<a name="l01121"></a>01121     }
<a name="l01122"></a>01122     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="keywordflow">if</span> (!objects_baked)
<a name="l01125"></a>01125         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No objects found to bake from&quot;</span>);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="comment">/* Multiresbake adopted for job-system executing */</span>
<a name="l01131"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a94457e0fb8b74596965aaef4a10f645c">01131</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a94457e0fb8b74596965aaef4a10f645c">init_multiresbake_job</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a> *bkj)
<a name="l01132"></a>01132 {
<a name="l01133"></a>01133     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01134"></a>01134     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">/* backup scene settings, so their changing in UI would take no effect on baker */</span>
<a name="l01137"></a>01137     bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a1658bc45e82913466656a099afd992cc">bake_filter</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6ad7d51845798984f1050c4314062829">bake_filter</a>;
<a name="l01138"></a>01138     bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#ac5eb1c746110a7b2825d75a40a42b575">mode</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>;
<a name="l01139"></a>01139     bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a336231d63e78621bffea17b152d9dbeb">use_lores_mesh</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a>&amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af72dada0a81a3053dfa2e7801dc27a5d">R_BAKE_LORES_MESH</a>;
<a name="l01140"></a>01140     bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#acdafcd8056ea7dff90c44c8c83436b7c">bake_clear</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a>&amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a14571df5abb1ae871ad447e5cff5b967">R_BAKE_CLEAR</a>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a>*, base, selected_editable_bases) {
<a name="l01143"></a>01143         <a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01144"></a>01144         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *lores_dm;
<a name="l01145"></a>01145         <span class="keywordtype">int</span> lvl;
<a name="l01146"></a>01146         ob= base-&gt;object;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         <a class="code" href="../../d1/d37/BKE__multires_8h.html#aa38882489eede6dbd6100a7ff3135d08">multires_force_update</a>(ob);
<a name="l01149"></a>01149 
<a name="l01150"></a>01150         lores_dm = <a class="code" href="../../d5/d58/object__bake_8c.html#af972c1f2afd5bf14ef9b40c90e8755d2">multiresbake_create_loresdm</a>(scene, ob, &amp;lvl);
<a name="l01151"></a>01151         <span class="keywordflow">if</span> (!lores_dm)
<a name="l01152"></a>01152             <span class="keywordflow">continue</span>;
<a name="l01153"></a>01153 
<a name="l01154"></a>01154         data= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a>), <span class="stringliteral">&quot;multiresBaker derivedMesh_data&quot;</span>);
<a name="l01155"></a>01155         data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a> = lores_dm;
<a name="l01156"></a>01156         data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa4db35dbdd3ef579e487328a93f30ca2">lvl</a> = lvl;
<a name="l01157"></a>01157         data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a77c0acbcb33f08e1fe73b26bfa2ffa0b">hires_dm</a> = <a class="code" href="../../d5/d58/object__bake_8c.html#a5cbc3fadc380f4cf3233c653cfc92ddc">multiresbake_create_hiresdm</a>(scene, ob, &amp;data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa90d95a70e16d80691eed485693df98a">tot_lvl</a>, &amp;data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#ade952de13884fe5643ba070f0d94ae8a">simple</a>);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>, data);
<a name="l01160"></a>01160     }
<a name="l01161"></a>01161     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a10b9d083ff2c93c0b7f64b2bc70710bd">01164</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a10b9d083ff2c93c0b7f64b2bc70710bd">multiresbake_startjob</a>(<span class="keywordtype">void</span> *bkv, <span class="keywordtype">short</span> *stop, <span class="keywordtype">short</span> *do_update, <span class="keywordtype">float</span> *progress)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166     <a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01167"></a>01167     <a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a> *bkj= bkv;
<a name="l01168"></a>01168     <span class="keywordtype">int</span> baked_objects= 0, tot_obj;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     tot_obj= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="keywordflow">if</span> (bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#acdafcd8056ea7dff90c44c8c83436b7c">bake_clear</a>) {  <span class="comment">/* clear images */</span>
<a name="l01173"></a>01173         <span class="keywordflow">for</span> (data= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; data; data= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a3ea1d2f22048227afca085e7ac4a2d02">next</a>) {
<a name="l01174"></a>01174             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a>;
<a name="l01175"></a>01175             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177             <a class="code" href="../../d5/d58/object__bake_8c.html#a02cda2d0a817f0030e09b0681e982048">clear_images</a>(mtface, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm));
<a name="l01178"></a>01178         }
<a name="l01179"></a>01179     }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">for</span> (data= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; data; data= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a3ea1d2f22048227afca085e7ac4a2d02">next</a>) {
<a name="l01182"></a>01182         <a class="code" href="../../d7/d42/structMultiresBakeRender.html">MultiresBakeRender</a> bkr= {0};
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         <span class="comment">/* copy data stored in job descriptor */</span>
<a name="l01185"></a>01185         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ac7fb89794d4ac44b7feb4d4eb365fc15">bake_filter</a>= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a1658bc45e82913466656a099afd992cc">bake_filter</a>;
<a name="l01186"></a>01186         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a2aebe060d0ff56962bae8dd1e2a7a241">mode</a>= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#ac5eb1c746110a7b2825d75a40a42b575">mode</a>;
<a name="l01187"></a>01187         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a3ba5134558cc6e551ba0f33e9f190c09">use_lores_mesh</a>= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a336231d63e78621bffea17b152d9dbeb">use_lores_mesh</a>;
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <span class="comment">/* create low-resolution DM (to bake to) and hi-resolution DM (to bake from) */</span>
<a name="l01190"></a>01190         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a53878445f3156aa224c1d24a1c06af51">lores_dm</a>= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a>;
<a name="l01191"></a>01191         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a23c8bf1e11c2edb294ed090f20a9d1a3">hires_dm</a>= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a77c0acbcb33f08e1fe73b26bfa2ffa0b">hires_dm</a>;
<a name="l01192"></a>01192         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad1ffe8c56145dc7ae55763221c67483f">tot_lvl</a>= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa90d95a70e16d80691eed485693df98a">tot_lvl</a>;
<a name="l01193"></a>01193         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#aa3d3898095b29abd4e4f12eee38c8fca">lvl</a>= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#aa4db35dbdd3ef579e487328a93f30ca2">lvl</a>;
<a name="l01194"></a>01194         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a489d2c607d370f8410e867119e8dd364">simple</a>= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#ade952de13884fe5643ba070f0d94ae8a">simple</a>;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196         <span class="comment">/* needed for proper progress bar */</span>
<a name="l01197"></a>01197         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a12dd53d73f81a07754596ed0047f1ff8">tot_obj</a>= tot_obj;
<a name="l01198"></a>01198         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad31ef669bc096503612f2ef97844fa9d">baked_objects</a>= baked_objects;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a48252a9488c21a9f6c3cc3b1a81d1671">stop</a>= stop;
<a name="l01201"></a>01201         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#af87cef6e6c46bb15c85b9bbf05a952b3">do_update</a>= do_update;
<a name="l01202"></a>01202         bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#ad7f29b6919577fb0876d64c43087e326">progress</a>= progress;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         <a class="code" href="../../d5/d58/object__bake_8c.html#ad5e6f47b175ae2806db90fd5079a9501">multiresbake_start</a>(&amp;bkr);
<a name="l01205"></a>01205 
<a name="l01206"></a>01206         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;bkr.<a class="code" href="../../d7/d42/structMultiresBakeRender.html#a594f6ecda05b93e19519811ba20c8dea">image</a>);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         baked_objects++;
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a895ca4323b70ecbd535ed417c6aaf6d4">01212</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a895ca4323b70ecbd535ed417c6aaf6d4">multiresbake_freejob</a>(<span class="keywordtype">void</span> *bkv)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a> *bkj= bkv;
<a name="l01215"></a>01215     <a class="code" href="../../dc/d63/structMultiresBakerJobData.html">MultiresBakerJobData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01216"></a>01216 
<a name="l01217"></a>01217     data= bkj-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01218"></a>01218     <span class="keywordflow">while</span> (data) {
<a name="l01219"></a>01219         next= data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a3ea1d2f22048227afca085e7ac4a2d02">next</a>;
<a name="l01220"></a>01220         data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a871692be2789f23957b1a16f1e411d5c">lores_dm</a>);
<a name="l01221"></a>01221         data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a77c0acbcb33f08e1fe73b26bfa2ffa0b">hires_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(data-&gt;<a class="code" href="../../dc/d63/structMultiresBakerJobData.html#a77c0acbcb33f08e1fe73b26bfa2ffa0b">hires_dm</a>);
<a name="l01222"></a>01222         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data);
<a name="l01223"></a>01223         data= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bkj);
<a name="l01227"></a>01227 }
<a name="l01228"></a>01228 
<a name="l01229"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ab747c702c5dfc76bc9e7204cf8671b7b">01229</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ab747c702c5dfc76bc9e7204cf8671b7b">multiresbake_image_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01232"></a>01232     <a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a> *bkr;
<a name="l01233"></a>01233     <a class="code" href="../../df/da1/structwmJob.html">wmJob</a> *steve;
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d58/object__bake_8c.html#a213788981236cd24d27f7129a551d189">multiresbake_check</a>(C, op))
<a name="l01236"></a>01236         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     bkr= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d52/structMultiresBakeJob.html">MultiresBakeJob</a>), <span class="stringliteral">&quot;MultiresBakeJob data&quot;</span>);
<a name="l01239"></a>01239     <a class="code" href="../../d5/d58/object__bake_8c.html#a94457e0fb8b74596965aaef4a10f645c">init_multiresbake_job</a>(C, bkr);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241     <span class="keywordflow">if</span> (!bkr-&gt;<a class="code" href="../../d0/d52/structMultiresBakeJob.html#a4ad999cf804554d0ebe450c6518e5e18">data</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01242"></a>01242         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No objects found to bake from&quot;</span>);
<a name="l01243"></a>01243         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <span class="comment">/* setup job */</span>
<a name="l01247"></a>01247     steve= <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a03e66c0464fe9538f2be29d10983a54b">WM_jobs_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), scene, <span class="stringliteral">&quot;Multires Bake&quot;</span>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a9a92e41811d7810f88def86200440764">WM_JOB_EXCL_RENDER</a>|<a class="code" href="../../d4/d7f/WM__api_8h.html#ab70a81093eef580938844093749fc236">WM_JOB_PRIORITY</a>|<a class="code" href="../../d4/d7f/WM__api_8h.html#a465c1325f2e6a043e462d7cb9af39731">WM_JOB_PROGRESS</a>);
<a name="l01248"></a>01248     <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a32861c1bffe82b79764b704b38ef0751">WM_jobs_customdata</a>(steve, bkr, <a class="code" href="../../d5/d58/object__bake_8c.html#a895ca4323b70ecbd535ed417c6aaf6d4">multiresbake_freejob</a>);
<a name="l01249"></a>01249     <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a61b5493e2cc31b7445290f3bd26be5ef">WM_jobs_timer</a>(steve, 0.2, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a>, 0); <span class="comment">/* TODO - only draw bake image, can we enforce this */</span>
<a name="l01250"></a>01250     <a class="code" href="../../d6/ddf/wm__jobs_8c.html#ad483f8df6cb0321204a4f98c645db4ba">WM_jobs_callbacks</a>(steve, <a class="code" href="../../d5/d58/object__bake_8c.html#a10b9d083ff2c93c0b7f64b2bc70710bd">multiresbake_startjob</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 0;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254     <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a6b58050bebd06f6dcf195967da599bf0">WM_jobs_start</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), steve);
<a name="l01255"></a>01255     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257     <span class="comment">/* add modal handler for ESC */</span>
<a name="l01258"></a>01258     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01261"></a>01261 }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <span class="comment">/* ****************** render BAKING ********************** */</span>
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="comment">/* threaded break test */</span>
<a name="l01266"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a1bd59aee3c15b50d3c11222baea3e228">01266</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a1bd59aee3c15b50d3c11222baea3e228">thread_break</a>(<span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(arg))
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268     <span class="keywordflow">return</span> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek;
<a name="l01269"></a>01269 }
<a name="l01270"></a>01270 
<a name="l01271"></a><a class="code" href="../../dd/da9/structBakeRender.html">01271</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> {
<a name="l01272"></a><a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">01272</a>     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>;
<a name="l01273"></a><a class="code" href="../../dd/da9/structBakeRender.html#aaeaa94c6c46988de1d125d355203ebd4">01273</a>     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *<a class="code" href="../../dd/da9/structBakeRender.html#aaeaa94c6c46988de1d125d355203ebd4">main</a>;
<a name="l01274"></a><a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">01274</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>;
<a name="l01275"></a><a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">01275</a>     <span class="keyword">struct </span><a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>;
<a name="l01276"></a><a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">01276</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>, <a class="code" href="../../dd/da9/structBakeRender.html#a103bc6d363b72b0a68cf3bc37b5b94e9">ready</a>;
<a name="l01277"></a>01277 
<a name="l01278"></a><a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">01278</a>     <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *<a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">reports</a>;
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="../../dd/da9/structBakeRender.html#a1f6f43af512d9bdc5772319756e09bf2">01280</a>     <span class="keywordtype">short</span> *<a class="code" href="../../dd/da9/structBakeRender.html#a1f6f43af512d9bdc5772319756e09bf2">stop</a>;
<a name="l01281"></a><a class="code" href="../../dd/da9/structBakeRender.html#afab9934b573c07670ee18bca8625d5ac">01281</a>     <span class="keywordtype">short</span> *<a class="code" href="../../dd/da9/structBakeRender.html#afab9934b573c07670ee18bca8625d5ac">do_update</a>;
<a name="l01282"></a><a class="code" href="../../dd/da9/structBakeRender.html#a406231b9e027a3570a718db5881f757a">01282</a>     <span class="keywordtype">float</span> *<a class="code" href="../../dd/da9/structBakeRender.html#a406231b9e027a3570a718db5881f757a">progress</a>;
<a name="l01283"></a>01283     
<a name="l01284"></a><a class="code" href="../../dd/da9/structBakeRender.html#a0806963e1799402b409452b138df49ef">01284</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../dd/da9/structBakeRender.html#a0806963e1799402b409452b138df49ef">threads</a>;
<a name="l01285"></a>01285 
<a name="l01286"></a>01286     <span class="comment">/* backup */</span>
<a name="l01287"></a><a class="code" href="../../dd/da9/structBakeRender.html#aaca38f7fef87ee79b4699fa0451f4516">01287</a>     <span class="keywordtype">short</span> <a class="code" href="../../dd/da9/structBakeRender.html#aaca38f7fef87ee79b4699fa0451f4516">prev_wo_amb_occ</a>;
<a name="l01288"></a><a class="code" href="../../dd/da9/structBakeRender.html#a7287705148ce26b636e34eb85746e079">01288</a>     <span class="keywordtype">short</span> <a class="code" href="../../dd/da9/structBakeRender.html#a7287705148ce26b636e34eb85746e079">prev_r_raytrace</a>;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <span class="comment">/* for redrawing */</span>
<a name="l01291"></a><a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">01291</a>     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *<a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">sa</a>;
<a name="l01292"></a>01292 } <a class="code" href="../../d5/d58/object__bake_8c.html#a5328d15ebe0c03874ce05f083bb6fee4">BakeRender</a>;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294 <span class="comment">/* use by exec and invoke */</span>
<a name="l01295"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a8fadcf646bbcfdd57ceb92040857c32e">01295</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a8fadcf646bbcfdd57ceb92040857c32e">test_bake_internal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports)
<a name="l01296"></a>01296 {
<a name="l01297"></a>01297     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01298"></a>01298 
<a name="l01299"></a>01299     <span class="keywordflow">if</span> ((scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae8cc7a82e2038d57460767a266af07d0">R_BAKE_TO_ACTIVE</a>) &amp;&amp; <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C)==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01300"></a>01300         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active object&quot;</span>);
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a> &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01303"></a>01303         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No world set up&quot;</span>);
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305     <span class="keywordflow">else</span> {
<a name="l01306"></a>01306         <span class="keywordflow">return</span> 1;
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     <span class="keywordflow">return</span> 0;
<a name="l01310"></a>01310 }
<a name="l01311"></a>01311 
<a name="l01312"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a33bcfed9adfeb4110ebc60415913ba79">01312</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a33bcfed9adfeb4110ebc60415913ba79">init_bake_internal</a>(<a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr, <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l01313"></a>01313 {
<a name="l01314"></a>01314     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     <span class="comment">/* get editmode results */</span>
<a name="l01317"></a>01317     <a class="code" href="../../da/d7a/ED__object_8h.html#a3dc41f10c2da040464140768d2898865">ED_object_exit_editmode</a>(C, 0);  <span class="comment">/* 0 = does not exit editmode */</span>
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">sa</a>= <a class="code" href="../../d7/da3/BKE__screen_8h.html#a006ecc44025fbc313f083a7acf4b58d6">BKE_screen_find_big_area</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C), <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>, 10); <span class="comment">/* can be NULL */</span>
<a name="l01320"></a>01320     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aaeaa94c6c46988de1d125d355203ebd4">main</a>= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01321"></a>01321     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>= scene;
<a name="l01322"></a>01322     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>= (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae8cc7a82e2038d57460767a266af07d0">R_BAKE_TO_ACTIVE</a>) ? <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01323"></a>01323     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aa539d2c227f40725b93fe2df94a76bd1">RE_NewRender</a>(<span class="stringliteral">&quot;_Bake View_&quot;</span>);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a>) {
<a name="l01326"></a>01326         <span class="comment">/* If raytracing or AO is disabled, switch it on temporarily for baking. */</span>
<a name="l01327"></a>01327         bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aaca38f7fef87ee79b4699fa0451f4516">prev_wo_amb_occ</a> = (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>) != 0;
<a name="l01328"></a>01328         scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> |= <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>;
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a> || bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>) {
<a name="l01331"></a>01331         bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7287705148ce26b636e34eb85746e079">prev_r_raytrace</a> = (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) != 0;
<a name="l01332"></a>01332         scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>;
<a name="l01333"></a>01333     }
<a name="l01334"></a>01334 }
<a name="l01335"></a>01335 
<a name="l01336"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a430b761bbdc9b762622540cbd1612dda">01336</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a430b761bbdc9b762622540cbd1612dda">finish_bake_internal</a>(<a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr)
<a name="l01337"></a>01337 {
<a name="l01338"></a>01338     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b3a3e3c89e9a1cf1dfe2f410be89067">RE_Database_Free</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>);
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     <span class="comment">/* restore raytrace and AO */</span>
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a>)
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aaca38f7fef87ee79b4699fa0451f4516">prev_wo_amb_occ</a> == 0)
<a name="l01343"></a>01343             bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp;= ~<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>;
<a name="l01344"></a>01344 
<a name="l01345"></a>01345     <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a> || bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>)
<a name="l01346"></a>01346         <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7287705148ce26b636e34eb85746e079">prev_r_raytrace</a> == 0)
<a name="l01347"></a>01347             bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>;
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>==<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a22a20dca745d66bef2924f70b5042fb6">BAKE_RESULT_OK</a>) {
<a name="l01350"></a>01350         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l01351"></a>01351         <span class="comment">/* force OpenGL reload and mipmap recalc */</span>
<a name="l01352"></a>01352         <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l01353"></a>01353             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>) {
<a name="l01354"></a>01354                 <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01355"></a>01355                 <span class="keywordflow">if</span> (ibuf) {
<a name="l01356"></a>01356                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>) {
<a name="l01357"></a>01357                         <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(ima);
<a name="l01358"></a>01358                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a6f8bb9e85153806a1ffe7c27e8a284b6">imb_freemipmapImBuf</a>(ibuf);
<a name="l01359"></a>01359                     }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361                     <span class="comment">/* freed when baking is done, but if its canceled we need to free here */</span>
<a name="l01362"></a>01362                     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>) {
<a name="l01363"></a>01363                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>);
<a name="l01364"></a>01364                         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01365"></a>01365                     }
<a name="l01366"></a>01366                 }
<a name="l01367"></a>01367             }
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369     }
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a23494280e00252560020af7d494efb56">01372</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d5/d58/object__bake_8c.html#a23494280e00252560020af7d494efb56">do_bake_render</a>(<span class="keywordtype">void</span> *bake_v)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374     <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr= bake_v;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>= <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a98dd9b22b319528b0386bc906f3991ef">RE_bake_shade_all_selected</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a406231b9e027a3570a718db5881f757a">progress</a>);
<a name="l01377"></a>01377     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a103bc6d363b72b0a68cf3bc37b5b94e9">ready</a>= 1;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01380"></a>01380 }
<a name="l01381"></a>01381 
<a name="l01382"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a5fd0d9b80a559e3712460d57e9e63c49">01382</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a5fd0d9b80a559e3712460d57e9e63c49">bake_startjob</a>(<span class="keywordtype">void</span> *bkv, <span class="keywordtype">short</span> *stop, <span class="keywordtype">short</span> *do_update, <span class="keywordtype">float</span> *progress)
<a name="l01383"></a>01383 {
<a name="l01384"></a>01384     <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr= bkv;
<a name="l01385"></a>01385     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a7756e569555dafd499261391353f60ca">scene</a>;
<a name="l01386"></a>01386     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aaeaa94c6c46988de1d125d355203ebd4">main</a>;
<a name="l01387"></a>01387 
<a name="l01388"></a>01388     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a1f6f43af512d9bdc5772319756e09bf2">stop</a>= stop;
<a name="l01389"></a>01389     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#afab9934b573c07670ee18bca8625d5ac">do_update</a>= do_update;
<a name="l01390"></a>01390     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a406231b9e027a3570a718db5881f757a">progress</a>= progress;
<a name="l01391"></a>01391 
<a name="l01392"></a>01392     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a451b3e40039deba9d40c62e1bde98eac">RE_test_break_cb</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#a1bd59aee3c15b50d3c11222baea3e228">thread_break</a>);
<a name="l01393"></a>01393     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 0;   <span class="comment">/* blender_test_break uses this global */</span>
<a name="l01394"></a>01394 
<a name="l01395"></a>01395     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a494aaa76640cd85e88dd1aa8dde17130">RE_Database_Baking</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, bmain, scene, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a506dd867fc58506c37c1e56f6b134056">lay</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397     <span class="comment">/* baking itself is threaded, cannot use test_break in threads. we also update optional imagewindow */</span>
<a name="l01398"></a>01398     bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>= <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a98dd9b22b319528b0386bc906f3991ef">RE_bake_shade_all_selected</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a3eb99b4de315530ab79f06fd35ffcbc8">actob</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#afab9934b573c07670ee18bca8625d5ac">do_update</a>, bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a406231b9e027a3570a718db5881f757a">progress</a>);
<a name="l01399"></a>01399 }
<a name="l01400"></a>01400 
<a name="l01401"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ae7a4fd6be212f809650d08ad2ab9301d">01401</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ae7a4fd6be212f809650d08ad2ab9301d">bake_update</a>(<span class="keywordtype">void</span> *bkv)
<a name="l01402"></a>01402 {
<a name="l01403"></a>01403     <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr= bkv;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">sa</a> &amp;&amp; bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a>==<a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>) { <span class="comment">/* in case the user changed while baking */</span>
<a name="l01406"></a>01406         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima= bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#a8184dfe63a2f4bd305254208668d8d62">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01407"></a>01407         <span class="keywordflow">if</span> (sima)
<a name="l01408"></a>01408             sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>= <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#ad3ada77a2863152abd3ac70579bceb80">RE_bake_shade_get_image</a>();
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410 }
<a name="l01411"></a>01411 
<a name="l01412"></a><a class="code" href="../../d5/d58/object__bake_8c.html#ae9167a6e43a53dfe40bde44f4ef72a74">01412</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#ae9167a6e43a53dfe40bde44f4ef72a74">bake_freejob</a>(<span class="keywordtype">void</span> *bkv)
<a name="l01413"></a>01413 {
<a name="l01414"></a>01414     <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr= bkv;
<a name="l01415"></a>01415     <a class="code" href="../../d5/d58/object__bake_8c.html#a430b761bbdc9b762622540cbd1612dda">finish_bake_internal</a>(bkr);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>==<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a5a0f4ed9840888f020055a3372d3f5a9">BAKE_RESULT_NO_OBJECTS</a>)
<a name="l01418"></a>01418         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No objects or images found to bake to&quot;</span>);
<a name="l01419"></a>01419     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>==<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a8574095205f51a754117a707431ea9fc">BAKE_RESULT_FEEDBACK_LOOP</a>)
<a name="l01420"></a>01420         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Feedback loop detected&quot;</span>);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bkr);
<a name="l01423"></a>01423     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering = 0;
<a name="l01424"></a>01424 }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 <span class="comment">/* catch esc */</span>
<a name="l01427"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a5415f8df6e1b8b0a3ecf6e6a61185bad">01427</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a5415f8df6e1b8b0a3ecf6e6a61185bad">objects_bake_render_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op), <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429     <span class="comment">/* no running blender, remove handler and pass through */</span>
<a name="l01430"></a>01430     <span class="keywordflow">if</span> (0==<a class="code" href="../../d6/ddf/wm__jobs_8c.html#ac173761e5d2abe3fef0c66bed8c471fd">WM_jobs_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C)))
<a name="l01431"></a>01431         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>|<a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="comment">/* running render */</span>
<a name="l01434"></a>01434     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l01435"></a>01435         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#abe3de76b73fb856d283d4da41ad109e8">ESCKEY</a>:
<a name="l01436"></a>01436             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01437"></a>01437             <span class="keywordflow">break</span>;
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l01440"></a>01440 }
<a name="l01441"></a>01441 
<a name="l01442"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a1b5675d2dcec4cf5a941d85ee1ddb0af">01442</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a1b5675d2dcec4cf5a941d85ee1ddb0af">is_multires_bake</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l01443"></a>01443 {
<a name="l01444"></a>01444     <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a25121784d1440eec23c9901cf8476820">RE_BAKE_NORMALS</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ada2e4a24643a6fef3c1968967a0fc71b">RE_BAKE_DISPLACEMENT</a>))
<a name="l01445"></a>01445         <span class="keywordflow">return</span> scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa32f730169f6bfa4ea55f68c800c8976">R_BAKE_MULTIRES</a>;
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     <span class="keywordflow">return</span> 0;
<a name="l01448"></a>01448 }
<a name="l01449"></a>01449 
<a name="l01450"></a><a class="code" href="../../d5/d58/object__bake_8c.html#a1aba25557a7a71133ffd28cfdfce68ad">01450</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#a1aba25557a7a71133ffd28cfdfce68ad">objects_bake_render_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(_event))
<a name="l01451"></a>01451 {
<a name="l01452"></a>01452     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01453"></a>01453     <span class="keywordtype">int</span> result= <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d58/object__bake_8c.html#a1b5675d2dcec4cf5a941d85ee1ddb0af">is_multires_bake</a>(scene)) {
<a name="l01456"></a>01456         result= <a class="code" href="../../d5/d58/object__bake_8c.html#ab747c702c5dfc76bc9e7204cf8671b7b">multiresbake_image_exec</a>(C, op);
<a name="l01457"></a>01457     }
<a name="l01458"></a>01458     <span class="keywordflow">else</span> {
<a name="l01459"></a>01459         <span class="comment">/* only one render job at a time */</span>
<a name="l01460"></a>01460         <span class="keywordflow">if</span> (<a class="code" href="../../d6/ddf/wm__jobs_8c.html#ac173761e5d2abe3fef0c66bed8c471fd">WM_jobs_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), scene))
<a name="l01461"></a>01461             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01462"></a>01462 
<a name="l01463"></a>01463         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d58/object__bake_8c.html#a8fadcf646bbcfdd57ceb92040857c32e">test_bake_internal</a>(C, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>)==0) {
<a name="l01464"></a>01464             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01465"></a>01465         }
<a name="l01466"></a>01466         <span class="keywordflow">else</span> {
<a name="l01467"></a>01467             <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> *bkr= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a>), <span class="stringliteral">&quot;render bake&quot;</span>);
<a name="l01468"></a>01468             <a class="code" href="../../df/da1/structwmJob.html">wmJob</a> *steve;
<a name="l01469"></a>01469 
<a name="l01470"></a>01470             <a class="code" href="../../d5/d58/object__bake_8c.html#a33bcfed9adfeb4110ebc60415913ba79">init_bake_internal</a>(bkr, C);
<a name="l01471"></a>01471             bkr-&gt;<a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">reports</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>;
<a name="l01472"></a>01472 
<a name="l01473"></a>01473             <span class="comment">/* setup job */</span>
<a name="l01474"></a>01474             steve= <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a03e66c0464fe9538f2be29d10983a54b">WM_jobs_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), scene, <span class="stringliteral">&quot;Texture Bake&quot;</span>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a9a92e41811d7810f88def86200440764">WM_JOB_EXCL_RENDER</a>|<a class="code" href="../../d4/d7f/WM__api_8h.html#ab70a81093eef580938844093749fc236">WM_JOB_PRIORITY</a>|<a class="code" href="../../d4/d7f/WM__api_8h.html#a465c1325f2e6a043e462d7cb9af39731">WM_JOB_PROGRESS</a>);
<a name="l01475"></a>01475             <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a32861c1bffe82b79764b704b38ef0751">WM_jobs_customdata</a>(steve, bkr, <a class="code" href="../../d5/d58/object__bake_8c.html#ae9167a6e43a53dfe40bde44f4ef72a74">bake_freejob</a>);
<a name="l01476"></a>01476             <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a61b5493e2cc31b7445290f3bd26be5ef">WM_jobs_timer</a>(steve, 0.2, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a>, 0); <span class="comment">/* TODO - only draw bake image, can we enforce this */</span>
<a name="l01477"></a>01477             <a class="code" href="../../d6/ddf/wm__jobs_8c.html#ad483f8df6cb0321204a4f98c645db4ba">WM_jobs_callbacks</a>(steve, <a class="code" href="../../d5/d58/object__bake_8c.html#a5fd0d9b80a559e3712460d57e9e63c49">bake_startjob</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#ae7a4fd6be212f809650d08ad2ab9301d">bake_update</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479             <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 0;
<a name="l01480"></a>01480             <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering = 1;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482             <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a6b58050bebd06f6dcf195967da599bf0">WM_jobs_start</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), steve);
<a name="l01483"></a>01483 
<a name="l01484"></a>01484             <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l01485"></a>01485 
<a name="l01486"></a>01486             <span class="comment">/* add modal handler for ESC */</span>
<a name="l01487"></a>01487             <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l01488"></a>01488         }
<a name="l01489"></a>01489 
<a name="l01490"></a>01490         result= <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01491"></a>01491     }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a21c633af64cda80da26a4a5cdf168925">ND_RENDER_RESULT</a>, scene);
<a name="l01494"></a>01494 
<a name="l01495"></a>01495     <span class="keywordflow">return</span> result;
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 
<a name="l01499"></a><a class="code" href="../../d5/d58/object__bake_8c.html#afb5452d2d040dedff01b56b5e3e8a469">01499</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/d58/object__bake_8c.html#afb5452d2d040dedff01b56b5e3e8a469">bake_image_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01500"></a>01500 {
<a name="l01501"></a>01501     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01502"></a>01502     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01503"></a>01503     <span class="keywordtype">int</span> result= <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d58/object__bake_8c.html#a1b5675d2dcec4cf5a941d85ee1ddb0af">is_multires_bake</a>(scene)) {
<a name="l01506"></a>01506         result= <a class="code" href="../../d5/d58/object__bake_8c.html#a683895c8918809414d24ded448900fe7">multiresbake_image_exec_locked</a>(C, op);
<a name="l01507"></a>01507     }
<a name="l01508"></a>01508     <span class="keywordflow">else</span> {
<a name="l01509"></a>01509         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d58/object__bake_8c.html#a8fadcf646bbcfdd57ceb92040857c32e">test_bake_internal</a>(C, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>)==0) {
<a name="l01510"></a>01510             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01511"></a>01511         }
<a name="l01512"></a>01512         <span class="keywordflow">else</span> {
<a name="l01513"></a>01513             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01514"></a>01514             <a class="code" href="../../dd/da9/structBakeRender.html">BakeRender</a> bkr= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01515"></a>01515 
<a name="l01516"></a>01516             <a class="code" href="../../d5/d58/object__bake_8c.html#a33bcfed9adfeb4110ebc60415913ba79">init_bake_internal</a>(&amp;bkr, C);
<a name="l01517"></a>01517             bkr.<a class="code" href="../../dd/da9/structBakeRender.html#aa68d533f283832d6ea05ceb2f3e85619">reports</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a451b3e40039deba9d40c62e1bde98eac">RE_test_break_cb</a>(bkr.<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/d58/object__bake_8c.html#a1bd59aee3c15b50d3c11222baea3e228">thread_break</a>);
<a name="l01520"></a>01520             <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 0;   <span class="comment">/* blender_test_break uses this global */</span>
<a name="l01521"></a>01521 
<a name="l01522"></a>01522             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a494aaa76640cd85e88dd1aa8dde17130">RE_Database_Baking</a>(bkr.<a class="code" href="../../dd/da9/structBakeRender.html#a3b38afdcff3442598713a62dd8508095">re</a>, bmain, scene, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a506dd867fc58506c37c1e56f6b134056">lay</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4a91a25d74bbbdeccfa32513acbfde28">bake_mode</a>, (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a5af2fa5d427f5c99a21dc98b5cc4e91c">bake_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae8cc7a82e2038d57460767a266af07d0">R_BAKE_TO_ACTIVE</a>)? <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524             <span class="comment">/* baking itself is threaded, cannot use test_break in threads  */</span>
<a name="l01525"></a>01525             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../d5/d58/object__bake_8c.html#a23494280e00252560020af7d494efb56">do_bake_render</a>, 1);
<a name="l01526"></a>01526             bkr.<a class="code" href="../../dd/da9/structBakeRender.html#a103bc6d363b72b0a68cf3bc37b5b94e9">ready</a>= 0;
<a name="l01527"></a>01527             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;bkr);
<a name="l01528"></a>01528 
<a name="l01529"></a>01529             <span class="keywordflow">while</span> (bkr.<a class="code" href="../../dd/da9/structBakeRender.html#a103bc6d363b72b0a68cf3bc37b5b94e9">ready</a>==0) {
<a name="l01530"></a>01530                 <a class="code" href="../../df/d73/time_8c.html#a43667128024aa660ab9adfbd5df9e88a">PIL_sleep_ms</a>(50);
<a name="l01531"></a>01531                 <span class="keywordflow">if</span> (bkr.<a class="code" href="../../dd/da9/structBakeRender.html#a103bc6d363b72b0a68cf3bc37b5b94e9">ready</a>)
<a name="l01532"></a>01532                     <span class="keywordflow">break</span>;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                 <span class="comment">/* used to redraw in 2.4x but this is just for exec in 2.5 */</span>
<a name="l01535"></a>01535                 <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background)
<a name="l01536"></a>01536                     <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1ad141f46f0fb24cf83ba80060bacdf7">blender_test_break</a>();
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l01539"></a>01539 
<a name="l01540"></a>01540             <span class="keywordflow">if</span> (bkr.<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>==<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a5a0f4ed9840888f020055a3372d3f5a9">BAKE_RESULT_NO_OBJECTS</a>)
<a name="l01541"></a>01541                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No valid images found to bake to&quot;</span>);
<a name="l01542"></a>01542             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bkr.<a class="code" href="../../dd/da9/structBakeRender.html#aba012679edd492f71ea5dfab3e2509c0">result</a>==<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a8574095205f51a754117a707431ea9fc">BAKE_RESULT_FEEDBACK_LOOP</a>)
<a name="l01543"></a>01543                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Feedback loop detected&quot;</span>);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545             <a class="code" href="../../d5/d58/object__bake_8c.html#a430b761bbdc9b762622540cbd1612dda">finish_bake_internal</a>(&amp;bkr);
<a name="l01546"></a>01546 
<a name="l01547"></a>01547             result= <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01548"></a>01548         }
<a name="l01549"></a>01549     }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a21c633af64cda80da26a4a5cdf168925">ND_RENDER_RESULT</a>, scene);
<a name="l01552"></a>01552 
<a name="l01553"></a>01553     <span class="keywordflow">return</span> result;
<a name="l01554"></a>01554 }
<a name="l01555"></a>01555 
<a name="l01556"></a><a class="code" href="../../d3/d80/object__intern_8h.html#aa8b2ba589d166f33123768cfa9cc06e1">01556</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d58/object__bake_8c.html#aa8b2ba589d166f33123768cfa9cc06e1">OBJECT_OT_bake_image</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01557"></a>01557 {
<a name="l01558"></a>01558     <span class="comment">/* identifiers */</span>
<a name="l01559"></a>01559     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Bake&quot;</span>;
<a name="l01560"></a>01560     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Bake image textures of selected objects&quot;</span>;
<a name="l01561"></a>01561     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;OBJECT_OT_bake_image&quot;</span>;
<a name="l01562"></a>01562 
<a name="l01563"></a>01563     <span class="comment">/* api callbacks */</span>
<a name="l01564"></a>01564     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d5/d58/object__bake_8c.html#afb5452d2d040dedff01b56b5e3e8a469">bake_image_exec</a>;
<a name="l01565"></a>01565     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d5/d58/object__bake_8c.html#a1aba25557a7a71133ffd28cfdfce68ad">objects_bake_render_invoke</a>;
<a name="l01566"></a>01566     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d5/d58/object__bake_8c.html#a5415f8df6e1b8b0a3ecf6e6a61185bad">objects_bake_render_modal</a>;
<a name="l01567"></a>01567 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:37 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
