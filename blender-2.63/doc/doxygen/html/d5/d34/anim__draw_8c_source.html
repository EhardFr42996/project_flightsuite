<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: anim_draw.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">anim_draw.c</div>  </div>
</div>
<div class="contents">
<a href="../../d5/d34/anim__draw_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2008 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * </span>
<a name="l00022"></a>00022 <span class="comment"> * Contributor(s): Joshua Leung</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d59/BLO__sys__types_8h.html">BLO_sys_types.h</a>&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/de6/BKE__nla_8h.html">BKE_nla.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d6f/ED__anim__api_8h.html">ED_anim_api.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d10/ED__keyframes__edit_8h.html">ED_keyframes_edit.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d1e/UI__interface_8h.html">UI_interface.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">/* *************************************************** */</span>
<a name="l00055"></a>00055 <span class="comment">/* TIME CODE FORMATTING */</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">/* Generate timecode/frame number string and store in the supplied string </span>
<a name="l00058"></a>00058 <span class="comment"> *  - buffer: must be at least 13 chars long </span>
<a name="l00059"></a>00059 <span class="comment"> *  - power: special setting for View2D grid drawing, </span>
<a name="l00060"></a>00060 <span class="comment"> *    used to specify how detailed we need to be</span>
<a name="l00061"></a>00061 <span class="comment"> *  - timecodes: boolean specifying whether timecodes or</span>
<a name="l00062"></a>00062 <span class="comment"> *    frame numbers get drawn</span>
<a name="l00063"></a>00063 <span class="comment"> *  - cfra: time in frames or seconds, consistent with the values shown by timecodes</span>
<a name="l00064"></a>00064 <span class="comment"> */</span>
<a name="l00065"></a>00065 <span class="comment">// TODO: have this in kernel instead under scene?</span>
<a name="l00066"></a><a class="code" href="../../df/d6f/ED__anim__api_8h.html#ac682025564d5228552d40a1284c84e0a">00066</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a7f9bfdff6ea19a9500c1c2fa28e7a681">ANIM_timecode_string_from_frame</a> (<span class="keywordtype">char</span> *<a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">int</span> power, <span class="keywordtype">short</span> timecodes, <span class="keywordtype">float</span> cfra)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="keywordflow">if</span> (timecodes) {
<a name="l00069"></a>00069         <span class="keywordtype">int</span> hours=0, minutes=0, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>=0, frames=0;
<a name="l00070"></a>00070         <span class="keywordtype">float</span> raw_seconds= cfra;
<a name="l00071"></a>00071         <span class="keywordtype">char</span> neg[2]= {<span class="charliteral">&#39;\0&#39;</span>};
<a name="l00072"></a>00072         
<a name="l00073"></a>00073         <span class="comment">/* get cframes */</span>
<a name="l00074"></a>00074         <span class="keywordflow">if</span> (cfra &lt; 0) {
<a name="l00075"></a>00075             <span class="comment">/* correction for negative cfraues */</span>
<a name="l00076"></a>00076             neg[0]= <span class="charliteral">&#39;-&#39;</span>;
<a name="l00077"></a>00077             cfra = -cfra;
<a name="l00078"></a>00078         }
<a name="l00079"></a>00079         <span class="keywordflow">if</span> (cfra &gt;= 3600) {
<a name="l00080"></a>00080             <span class="comment">/* hours */</span>
<a name="l00081"></a>00081             <span class="comment">/* XXX should we only display a single digit for hours since clips are </span>
<a name="l00082"></a>00082 <span class="comment">             *     VERY UNLIKELY to be more than 1-2 hours max? However, that would </span>
<a name="l00083"></a>00083 <span class="comment">             *     go against conventions...</span>
<a name="l00084"></a>00084 <span class="comment">             */</span>
<a name="l00085"></a>00085             hours= (int)cfra / 3600;
<a name="l00086"></a>00086             cfra= (float)fmod(cfra, 3600);
<a name="l00087"></a>00087         }
<a name="l00088"></a>00088         <span class="keywordflow">if</span> (cfra &gt;= 60) {
<a name="l00089"></a>00089             <span class="comment">/* minutes */</span>
<a name="l00090"></a>00090             minutes= (int)cfra / 60;
<a name="l00091"></a>00091             cfra= (float)fmod(cfra, 60);
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093         <span class="keywordflow">if</span> (power &lt;= 0) {
<a name="l00094"></a>00094             <span class="comment">/* seconds + frames</span>
<a name="l00095"></a>00095 <span class="comment">             *  Frames are derived from &#39;fraction&#39; of second. We need to perform some additional rounding</span>
<a name="l00096"></a>00096 <span class="comment">             *  to cope with &#39;half&#39; frames, etc., which should be fine in most cases</span>
<a name="l00097"></a>00097 <span class="comment">             */</span>
<a name="l00098"></a>00098             <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>= (int)cfra;
<a name="l00099"></a>00099             frames= (int)floor( (((<span class="keywordtype">double</span>)cfra - (double)<a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>) * <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac92ca5ab87034a348decad7ee8d4bd1b">FPS</a>) + 0.5 );
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101         <span class="keywordflow">else</span> {
<a name="l00102"></a>00102             <span class="comment">/* seconds (with pixel offset rounding) */</span>
<a name="l00103"></a>00103             <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>= (int)floor(cfra + 0.375f);
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         
<a name="l00106"></a>00106         <span class="keywordflow">switch</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.timecode_style) {
<a name="l00107"></a>00107             <span class="keywordflow">case</span> <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a9ccb02599f4648b9218ce7fa6eb34afa">USER_TIMECODE_MINIMAL</a>: 
<a name="l00108"></a>00108             {
<a name="l00109"></a>00109                 <span class="comment">/*  - In general, minutes and seconds should be shown, as most clips will be</span>
<a name="l00110"></a>00110 <span class="comment">                 *    within this length. Hours will only be included if relevant.</span>
<a name="l00111"></a>00111 <span class="comment">                 *  - Only show frames when zoomed in enough for them to be relevant </span>
<a name="l00112"></a>00112 <span class="comment">                 *    (using separator of &#39;+&#39; for frames).</span>
<a name="l00113"></a>00113 <span class="comment">                 *    When showing frames, use slightly different display to avoid confusion with mm:ss format</span>
<a name="l00114"></a>00114 <span class="comment">                 */</span>
<a name="l00115"></a>00115                 <span class="keywordflow">if</span> (power &lt;= 0) {
<a name="l00116"></a>00116                     <span class="comment">/* include &quot;frames&quot; in display */</span>
<a name="l00117"></a>00117                     <span class="keywordflow">if</span> (hours) sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%02d+%02d&quot;</span>, neg, hours, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00118"></a>00118                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (minutes) sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d+%02d&quot;</span>, neg, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00119"></a>00119                     <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%s%d+%02d&quot;</span>, neg, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00120"></a>00120                 }
<a name="l00121"></a>00121                 <span class="keywordflow">else</span> {
<a name="l00122"></a>00122                     <span class="comment">/* don&#39;t include &#39;frames&#39; in display */</span>
<a name="l00123"></a>00123                     <span class="keywordflow">if</span> (hours) sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%02d&quot;</span>, neg, hours, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>);
<a name="l00124"></a>00124                     <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d&quot;</span>, neg, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>);
<a name="l00125"></a>00125                 }
<a name="l00126"></a>00126             }
<a name="l00127"></a>00127                 <span class="keywordflow">break</span>;
<a name="l00128"></a>00128                 
<a name="l00129"></a>00129             <span class="keywordflow">case</span> <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a30bda48c21ddd7b8052bb65feabbff1e">USER_TIMECODE_SMPTE_MSF</a>:
<a name="l00130"></a>00130             {
<a name="l00131"></a>00131                 <span class="comment">/* reduced SMPTE format that always shows minutes, seconds, frames. Hours only shown as needed. */</span>
<a name="l00132"></a>00132                 <span class="keywordflow">if</span> (hours) sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%02d:%02d&quot;</span>, neg, hours, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00133"></a>00133                 <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%02d&quot;</span>, neg, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00134"></a>00134             }
<a name="l00135"></a>00135                 <span class="keywordflow">break</span>;
<a name="l00136"></a>00136             
<a name="l00137"></a>00137             <span class="keywordflow">case</span> <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a6e88fe7d0afb6acf9ed766e73581695e">USER_TIMECODE_MILLISECONDS</a>:
<a name="l00138"></a>00138             {
<a name="l00139"></a>00139                 <span class="comment">/* reduced SMPTE. Instead of frames, milliseconds are shown */</span>
<a name="l00140"></a>00140                 <span class="keywordtype">int</span> ms_dp= (power &lt;= 0) ? (1 - power) : 1; <span class="comment">/* precision of decimal part */</span>
<a name="l00141"></a>00141                 <span class="keywordtype">int</span> s_pad= ms_dp+3; <span class="comment">/* to get 2 digit whole-number part for seconds display (i.e. 3 is for 2 digits + radix, on top of full length) */</span>
<a name="l00142"></a>00142                 
<a name="l00143"></a>00143                 <span class="keywordflow">if</span> (hours) sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%0*.*f&quot;</span>, neg, hours, minutes, s_pad, ms_dp, cfra);
<a name="l00144"></a>00144                 <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%s%02d:%0*.*f&quot;</span>, neg, minutes, s_pad,  ms_dp, cfra);
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146                 <span class="keywordflow">break</span>;
<a name="l00147"></a>00147                 
<a name="l00148"></a>00148             <span class="keywordflow">case</span> <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a952d379fb4389473b309653cfad0d0bb">USER_TIMECODE_SECONDS_ONLY</a>:
<a name="l00149"></a>00149             {
<a name="l00150"></a>00150                 <span class="comment">/* only show the original seconds display */</span>
<a name="l00151"></a>00151                 <span class="comment">/* round to whole numbers if power is &gt;= 1 (i.e. scale is coarse) */</span>
<a name="l00152"></a>00152                 <span class="keywordflow">if</span> (power &lt;= 0) sprintf(str, <span class="stringliteral">&quot;%.*f&quot;</span>, 1-power, raw_seconds);
<a name="l00153"></a>00153                 <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>)floor(raw_seconds + 0.375f));
<a name="l00154"></a>00154             }
<a name="l00155"></a>00155                 <span class="keywordflow">break</span>;
<a name="l00156"></a>00156             
<a name="l00157"></a>00157             <span class="keywordflow">case</span> <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#aef384f95f702e6209afc6a227ec1c572">USER_TIMECODE_SMPTE_FULL</a>:
<a name="l00158"></a>00158             <span class="keywordflow">default</span>:
<a name="l00159"></a>00159             {
<a name="l00160"></a>00160                 <span class="comment">/* full SMPTE format */</span>
<a name="l00161"></a>00161                 sprintf(str, <span class="stringliteral">&quot;%s%02d:%02d:%02d:%02d&quot;</span>, neg, hours, minutes, <a class="code" href="../../d1/d13/namespaceTNT.html#a8543f1b2361a96f1c80e0fb796199937">seconds</a>, frames);
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163                 <span class="keywordflow">break</span>;
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166     <span class="keywordflow">else</span> {
<a name="l00167"></a>00167         <span class="comment">/* round to whole numbers if power is &gt;= 1 (i.e. scale is coarse) */</span>
<a name="l00168"></a>00168         <span class="keywordflow">if</span> (power &lt;= 0) sprintf(str, <span class="stringliteral">&quot;%.*f&quot;</span>, 1-power, cfra);
<a name="l00169"></a>00169         <span class="keywordflow">else</span> sprintf(str, <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>)floor(cfra + 0.375f));
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171 } 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="comment">/* *************************************************** */</span>
<a name="l00174"></a>00174 <span class="comment">/* CURRENT FRAME DRAWING */</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">/* Draw current frame number in a little green box beside the current frame indicator */</span>
<a name="l00177"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#a3c806ecbebf10a304a4cd96c38be2c1a">00177</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a3c806ecbebf10a304a4cd96c38be2c1a">draw_cfra_number</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <span class="keywordtype">float</span> cfra, <span class="keywordtype">short</span> time)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179     <span class="keywordtype">float</span> xscale, yscale, x, y;
<a name="l00180"></a>00180     <span class="keywordtype">char</span> numstr[32] = <span class="stringliteral">&quot;    t&quot;</span>;  <span class="comment">/* t is the character to start replacing from */</span>
<a name="l00181"></a>00181     <span class="keywordtype">short</span> slen;
<a name="l00182"></a>00182     
<a name="l00183"></a>00183     <span class="comment">/* because the frame number text is subject to the same scaling as the contents of the view */</span>
<a name="l00184"></a>00184     <a class="code" href="../../d5/d63/UI__view2d_8h.html#adf67fa69e0c6db6c298cdb0c948a2a36">UI_view2d_getscale</a>(v2d, &amp;xscale, &amp;yscale);
<a name="l00185"></a>00185     glScalef(1.0f/xscale, 1.0f, 1.0f);
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     <span class="comment">/* get timecode string </span>
<a name="l00188"></a>00188 <span class="comment">     *  - padding on str-buf passed so that it doesn&#39;t sit on the frame indicator</span>
<a name="l00189"></a>00189 <span class="comment">     *  - power = 0, gives &#39;standard&#39; behavior for time</span>
<a name="l00190"></a>00190 <span class="comment">     *    but power = 1 is required for frames (to get integer frames)</span>
<a name="l00191"></a>00191 <span class="comment">     */</span>
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (time)
<a name="l00193"></a>00193         <a class="code" href="../../d5/d34/anim__draw_8c.html#a7f9bfdff6ea19a9500c1c2fa28e7a681">ANIM_timecode_string_from_frame</a>(&amp;numstr[4], scene, 0, time, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aefa061405601f279a16dc095034378ea">FRA2TIME</a>(cfra));
<a name="l00194"></a>00194     <span class="keywordflow">else</span>    
<a name="l00195"></a>00195         <a class="code" href="../../d5/d34/anim__draw_8c.html#a7f9bfdff6ea19a9500c1c2fa28e7a681">ANIM_timecode_string_from_frame</a>(&amp;numstr[4], scene, 1, time, cfra);
<a name="l00196"></a>00196     slen= (short)<a class="code" href="../../d8/d1e/UI__interface_8h.html#a4bc308293a0e08f38e7a0984fdedf872">UI_GetStringWidth</a>(numstr) - 1;
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     <span class="comment">/* get starting coordinates for drawing */</span>
<a name="l00199"></a>00199     x= cfra * xscale;
<a name="l00200"></a>00200     y= 18;
<a name="l00201"></a>00201     
<a name="l00202"></a>00202     <span class="comment">/* draw green box around/behind text */</span>
<a name="l00203"></a>00203     <a class="code" href="../../de/d96/UI__resources_8h.html#a56c7a350537a25b88d0532488032aef6">UI_ThemeColorShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a870b9670ad42559e568856f62e9487bc">TH_CFRAME</a>, 0);
<a name="l00204"></a>00204     glRectf(x, y,  x+slen,  y+15);
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     <span class="comment">/* draw current frame number - black text */</span>
<a name="l00207"></a>00207     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531ade800b14585ec3bc83905fe667484c4b">TH_TEXT</a>);
<a name="l00208"></a>00208     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a2712564246b0177fb64d88224864eeec">UI_DrawString</a>(x-5, y+3, numstr);
<a name="l00209"></a>00209     
<a name="l00210"></a>00210     <span class="comment">/* restore view transform */</span>
<a name="l00211"></a>00211     glScalef(xscale, 1.0, 1.0);
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* General call for drawing current frame indicator in animation editor */</span>
<a name="l00215"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#a7e099dbf38bf29ee4f7666aecc23723f">00215</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a7e099dbf38bf29ee4f7666aecc23723f">ANIM_draw_cfra</a> (<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <span class="keywordtype">short</span> <a class="code" href="../../db/d04/structtReorderChannelIsland.html#a7fcd4d4a2f68115e7797f5dcf0be73df">flag</a>)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00218"></a>00218     <span class="keywordtype">float</span> vec[2];
<a name="l00219"></a>00219     
<a name="l00220"></a>00220     <span class="comment">/* Draw a light green line to indicate current frame */</span>
<a name="l00221"></a>00221     vec[0]= (float)(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> * scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4399e01a91c6ca3e1259887c82ea0972">framelen</a>);
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a870b9670ad42559e568856f62e9487bc">TH_CFRAME</a>);
<a name="l00224"></a>00224     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a70ad55be767ca0a42c9150d24618e4caa5d9f5299cc9ab5b910b2e0f525166397">DRAWCFRA_WIDE</a>)
<a name="l00225"></a>00225         glLineWidth(3.0);
<a name="l00226"></a>00226     <span class="keywordflow">else</span>
<a name="l00227"></a>00227         glLineWidth(2.0);
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     glBegin(GL_LINE_STRIP);
<a name="l00230"></a>00230         vec[1]= v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>-500.0f;   <span class="comment">/* XXX arbitrary... want it go to bottom */</span>
<a name="l00231"></a>00231         glVertex2fv(vec);
<a name="l00232"></a>00232         
<a name="l00233"></a>00233         vec[1]= v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l00234"></a>00234         glVertex2fv(vec);
<a name="l00235"></a>00235     glEnd();
<a name="l00236"></a>00236     
<a name="l00237"></a>00237     glLineWidth(1.0);
<a name="l00238"></a>00238     
<a name="l00239"></a>00239     <span class="comment">/* Draw current frame number in a little box */</span>
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a70ad55be767ca0a42c9150d24618e4caab77894fd1657b4ec11bfcd36373f6d69">DRAWCFRA_SHOW_NUMBOX</a>) {
<a name="l00241"></a>00241         <a class="code" href="../../d5/d63/UI__view2d_8h.html#a2828fe07ae5b5c25bc561098e7aabfee">UI_view2d_view_orthoSpecial</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C), v2d, 1);
<a name="l00242"></a>00242         <a class="code" href="../../d5/d34/anim__draw_8c.html#a3c806ecbebf10a304a4cd96c38be2c1a">draw_cfra_number</a>(scene, v2d, vec[0], (flag &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a70ad55be767ca0a42c9150d24618e4caae71810fdd96f3ec02a8f11c4f6da0ba3">DRAWCFRA_UNIT_SECONDS</a>));
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="comment">/* *************************************************** */</span>
<a name="l00247"></a>00247 <span class="comment">/* PREVIEW RANGE &#39;CURTAINS&#39; */</span>
<a name="l00248"></a>00248 <span class="comment">/* Note: &#39;Preview Range&#39; tools are defined in anim_ops.c */</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">/* Draw preview range &#39;curtains&#39; for highlighting where the animation data is */</span>
<a name="l00251"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#a04ef2a331b555e99ea5fcdf5c287b4b6">00251</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a04ef2a331b555e99ea5fcdf5c287b4b6">ANIM_draw_previewrange</a> (<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00254"></a>00254     
<a name="l00255"></a>00255     <span class="comment">/* only draw this if preview range is set */</span>
<a name="l00256"></a>00256     <span class="keywordflow">if</span> (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af72a23d842a89879f64a610daf4076a4">PRVRANGEON</a>) {
<a name="l00257"></a>00257         glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
<a name="l00258"></a>00258         glEnable(GL_BLEND);
<a name="l00259"></a>00259         glColor4f(0.0f, 0.0f, 0.0f, 0.4f);
<a name="l00260"></a>00260         
<a name="l00261"></a>00261         <span class="comment">/* only draw two separate &#39;curtains&#39; if there&#39;s no overlap between them */</span>
<a name="l00262"></a>00262         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a46f444644a762bb20f43197274c1b3f2">PSFRA</a> &lt; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#afd077e3f9ae593b4d1bac88ea876e047">PEFRA</a>) {
<a name="l00263"></a>00263             glRectf(v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, (<span class="keywordtype">float</span>)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a46f444644a762bb20f43197274c1b3f2">PSFRA</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>);
<a name="l00264"></a>00264             glRectf((<span class="keywordtype">float</span>)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#afd077e3f9ae593b4d1bac88ea876e047">PEFRA</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>); 
<a name="l00265"></a>00265         } 
<a name="l00266"></a>00266         <span class="keywordflow">else</span> {
<a name="l00267"></a>00267             glRectf(v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>);
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269         
<a name="l00270"></a>00270         glDisable(GL_BLEND);
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 <span class="comment">/* *************************************************** */</span>
<a name="l00275"></a>00275 <span class="comment">/* NLA-MAPPING UTILITIES (required for drawing and also editing keyframes)  */</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">/* Obtain the AnimData block providing NLA-mapping for the given channel (if applicable) */</span>
<a name="l00278"></a>00278 <span class="comment">// TODO: do not supply return this if the animdata tells us that there is no mapping to perform</span>
<a name="l00279"></a><a class="code" href="../../df/d6f/ED__anim__api_8h.html#ab750ecd754e9b8c04edfbb57bb414bf4">00279</a> <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *<a class="code" href="../../d5/d34/anim__draw_8c.html#a37ad7a1d679ae57a5492066d63bb9c72">ANIM_nla_mapping_get</a>(<a class="code" href="../../d6/dca/structbAnimContext.html">bAnimContext</a> *ac, <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> *ale)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281     <span class="comment">/* sanity checks */</span>
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (ac == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00283"></a>00283         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00284"></a>00284     
<a name="l00285"></a>00285     <span class="comment">/* abort if rendering - we may get some race condition issues... */</span>
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00287"></a>00287     
<a name="l00288"></a>00288     <span class="comment">/* handling depends on the type of animation-context we&#39;ve got */</span>
<a name="l00289"></a>00289     <span class="keywordflow">if</span> (ale)
<a name="l00290"></a>00290         <span class="keywordflow">return</span> ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a>;
<a name="l00291"></a>00291     <span class="keywordflow">else</span>
<a name="l00292"></a>00292         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">/* ------------------- */</span>
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="comment">/* helper function for ANIM_nla_mapping_apply_fcurve() -&gt; &quot;restore&quot;, i.e. mapping points back to action-time */</span>
<a name="l00298"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#aefd6e169b73c238caa3fe65f442beb97">00298</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#aefd6e169b73c238caa3fe65f442beb97">bezt_nlamapping_restore</a>(<a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a> *ked, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt)
<a name="l00299"></a>00299 {
<a name="l00300"></a>00300     <span class="comment">/* AnimData block providing scaling is stored in &#39;data&#39;, only_keys option is stored in i1 */</span>
<a name="l00301"></a>00301     <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *)ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#a501b1376c86503e0138fcd41e59df925">data</a>;
<a name="l00302"></a>00302     <span class="keywordtype">short</span> only_keys= (<span class="keywordtype">short</span>)ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a>;
<a name="l00303"></a>00303     
<a name="l00304"></a>00304     <span class="comment">/* adjust BezTriple handles only if allowed to */</span>
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (only_keys == 0) {
<a name="l00306"></a>00306         bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>);
<a name="l00307"></a>00307         bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>);
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>);
<a name="l00311"></a>00311     
<a name="l00312"></a>00312     <span class="keywordflow">return</span> 0;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="comment">/* helper function for ANIM_nla_mapping_apply_fcurve() -&gt; &quot;apply&quot;, i.e. mapping points to NLA-mapped global time */</span>
<a name="l00316"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#a3b0fa990fc965d98c858ec79675deedf">00316</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a3b0fa990fc965d98c858ec79675deedf">bezt_nlamapping_apply</a>(<a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a> *ked, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <span class="comment">/* AnimData block providing scaling is stored in &#39;data&#39;, only_keys option is stored in i1 */</span>
<a name="l00319"></a>00319     <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a>*)ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#a501b1376c86503e0138fcd41e59df925">data</a>;
<a name="l00320"></a>00320     <span class="keywordtype">short</span> only_keys= (<span class="keywordtype">short</span>)ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a>;
<a name="l00321"></a>00321     
<a name="l00322"></a>00322     <span class="comment">/* adjust BezTriple handles only if allowed to */</span>
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (only_keys == 0) {
<a name="l00324"></a>00324         bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>);
<a name="l00325"></a>00325         bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>);
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327     
<a name="l00328"></a>00328     bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0], <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>);
<a name="l00329"></a>00329     
<a name="l00330"></a>00330     <span class="keywordflow">return</span> 0;
<a name="l00331"></a>00331 }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment">/* Apply/Unapply NLA mapping to all keyframes in the nominated F-Curve </span>
<a name="l00335"></a>00335 <span class="comment"> *  - restore = whether to map points back to non-mapped time </span>
<a name="l00336"></a>00336 <span class="comment"> *  - only_keys = whether to only adjust the location of the center point of beztriples</span>
<a name="l00337"></a>00337 <span class="comment"> */</span>
<a name="l00338"></a><a class="code" href="../../df/d6f/ED__anim__api_8h.html#a8df700b1b69d05b336972dd161de4a69">00338</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#af3391f209e37113f866e6bc3d15bcf97">ANIM_nla_mapping_apply_fcurve</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">short</span> restore, <span class="keywordtype">short</span> only_keys)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a> ked= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l00341"></a>00341     <a class="code" href="../../d7/d10/ED__keyframes__edit_8h.html#a1de51656b7a1d10c00977eefd746cb44">KeyframeEditFunc</a> map_cb;
<a name="l00342"></a>00342     
<a name="l00343"></a>00343     <span class="comment">/* init edit data </span>
<a name="l00344"></a>00344 <span class="comment">     *  - AnimData is stored in &#39;data&#39;</span>
<a name="l00345"></a>00345 <span class="comment">     *  - only_keys is stored in &#39;i1&#39;</span>
<a name="l00346"></a>00346 <span class="comment">     */</span>
<a name="l00347"></a>00347     ked.<a class="code" href="../../d5/d01/structKeyframeEditData.html#a501b1376c86503e0138fcd41e59df925">data</a>= (<span class="keywordtype">void</span> *)adt;
<a name="l00348"></a>00348     ked.<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a>= (int)only_keys;
<a name="l00349"></a>00349     
<a name="l00350"></a>00350     <span class="comment">/* get editing callback */</span>
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (restore)
<a name="l00352"></a>00352         map_cb= <a class="code" href="../../d5/d34/anim__draw_8c.html#aefd6e169b73c238caa3fe65f442beb97">bezt_nlamapping_restore</a>;
<a name="l00353"></a>00353     <span class="keywordflow">else</span>
<a name="l00354"></a>00354         map_cb= <a class="code" href="../../d5/d34/anim__draw_8c.html#a3b0fa990fc965d98c858ec79675deedf">bezt_nlamapping_apply</a>;
<a name="l00355"></a>00355     
<a name="l00356"></a>00356     <span class="comment">/* apply to F-Curve */</span>
<a name="l00357"></a>00357     <a class="code" href="../../db/d71/keyframes__edit_8c.html#acc5f398b98ef3107626e8c507091d544">ANIM_fcurve_keyframes_loop</a>(&amp;ked, fcu, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, map_cb, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="comment">/* *************************************************** */</span>
<a name="l00361"></a>00361 <span class="comment">/* UNITS CONVERSION MAPPING (required for drawing and editing keyframes) */</span>
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">/* Get unit conversion factor for given ID + F-Curve */</span>
<a name="l00364"></a><a class="code" href="../../df/d6f/ED__anim__api_8h.html#a5c640cb9152c62b57ffaf1f70a082d17">00364</a> <span class="keywordtype">float</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#aed88dfeee22ce670a97eed98a1ec09d8">ANIM_unit_mapping_get_factor</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">short</span> restore)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="comment">/* sanity checks */</span>
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &amp;&amp; fcu &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>) {
<a name="l00368"></a>00368         <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr, id_ptr;
<a name="l00369"></a>00369         <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l00370"></a>00370         
<a name="l00371"></a>00371         <span class="comment">/* get RNA property that F-Curve affects */</span>
<a name="l00372"></a>00372         <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(<span class="keywordtype">id</span>, &amp;id_ptr);
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a003cb660a44918af456e10e005495f86">RNA_path_resolve</a>(&amp;id_ptr, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, &amp;ptr, &amp;prop)) {
<a name="l00374"></a>00374             <span class="comment">/* rotations: radians &lt;-&gt; degrees? */</span>
<a name="l00375"></a>00375             <span class="keywordflow">if</span> (<a class="code" href="../../de/d7e/RNA__types_8h.html#a949f2f7bae19c6fda0a6f60c640fa903">RNA_SUBTYPE_UNIT</a>(<a class="code" href="../../d3/d10/rna__access_8c.html#ac2188d2835e07f6dd15491f6764cae78">RNA_property_subtype</a>(prop)) == <a class="code" href="../../de/d7e/RNA__types_8h.html#a8d7527997daaefd04aad47358e7b7565a20e09b2da481f2141dab749c16696c7b">PROP_UNIT_ROTATION</a>) {
<a name="l00376"></a>00376                 <span class="comment">/* if the radians flag is not set, default to using degrees which need conversions */</span>
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> ((scene) &amp;&amp; (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a625e6bf28916a42a46f8e0335de620d5">system_rotation</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a998000dd92f6ff432f58c203ecb8d1b7">USER_UNIT_ROT_RADIANS</a>) == 0) {
<a name="l00378"></a>00378                     <span class="keywordflow">if</span> (restore)
<a name="l00379"></a>00379                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>(1.0f);  <span class="comment">/* degrees to radians */</span>
<a name="l00380"></a>00380                     <span class="keywordflow">else</span>
<a name="l00381"></a>00381                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a95c550a7b3c9b2628d20aef44bc12b56">RAD2DEGF</a>(1.0f);  <span class="comment">/* radians to degrees */</span>
<a name="l00382"></a>00382                 }
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384             
<a name="l00385"></a>00385             <span class="comment">// TODO: other rotation types here as necessary</span>
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     
<a name="l00389"></a>00389     <span class="comment">/* no mapping needs to occur... */</span>
<a name="l00390"></a>00390     <span class="keywordflow">return</span> 1.0f;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="comment">/* ----------------------- */</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="comment">/* helper function for ANIM_unit_mapping_apply_fcurve -&gt; mapping callback for unit mapping */</span>
<a name="l00396"></a><a class="code" href="../../d5/d34/anim__draw_8c.html#a7e7ab3556a8512beb556a9a0faa29800">00396</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a7e7ab3556a8512beb556a9a0faa29800">bezt_unit_mapping_apply</a> (<a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a> *ked, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <span class="comment">/* mapping factor is stored in f1, flags are stored in i1 */</span>
<a name="l00399"></a>00399     <span class="keywordtype">short</span> only_keys= (ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a> &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#af8d3a9243f537152cd4a74368ed8646fa4d225778e53bab1cc9ecee1748198b01">ANIM_UNITCONV_ONLYKEYS</a>);
<a name="l00400"></a>00400     <span class="keywordtype">short</span> sel_vs= (ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a> &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#af8d3a9243f537152cd4a74368ed8646fa84973676f381ff72c791597ce7562dc8">ANIM_UNITCONV_SELVERTS</a>);
<a name="l00401"></a>00401     <span class="keywordtype">float</span> fac= ked-&gt;<a class="code" href="../../d5/d01/structKeyframeEditData.html#a1444ccfbecc1ce0317e003838ccc261d">f1</a>;
<a name="l00402"></a>00402     
<a name="l00403"></a>00403     <span class="comment">/* adjust BezTriple handles only if allowed to */</span>
<a name="l00404"></a>00404     <span class="keywordflow">if</span> (only_keys == 0) {
<a name="l00405"></a>00405         <span class="keywordflow">if</span> ((sel_vs==0) || (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad1188a435612de53bc858987af3c7acd">f1</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>)) 
<a name="l00406"></a>00406             bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1] *= fac;
<a name="l00407"></a>00407         <span class="keywordflow">if</span> ((sel_vs==0) || (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a426bd73dcd72de3539ed00b02646bac1">f3</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>)) 
<a name="l00408"></a>00408             bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1] *= fac;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     
<a name="l00411"></a>00411     <span class="keywordflow">if</span> ((sel_vs == 0) || (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>))
<a name="l00412"></a>00412         bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] *= fac;
<a name="l00413"></a>00413     
<a name="l00414"></a>00414     <span class="keywordflow">return</span> 0;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">/* Apply/Unapply units conversions to keyframes */</span>
<a name="l00418"></a><a class="code" href="../../df/d6f/ED__anim__api_8h.html#aca6f9169cd6992159fd26a13fc4d62cb">00418</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d34/anim__draw_8c.html#a75bfcc3b028bc0b703acd3de0c046c65">ANIM_unit_mapping_apply_fcurve</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">short</span> <a class="code" href="../../db/d04/structtReorderChannelIsland.html#a7fcd4d4a2f68115e7797f5dcf0be73df">flag</a>)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a> ked;
<a name="l00421"></a>00421     <a class="code" href="../../d7/d10/ED__keyframes__edit_8h.html#a1de51656b7a1d10c00977eefd746cb44">KeyframeEditFunc</a> sel_cb;
<a name="l00422"></a>00422     <span class="keywordtype">float</span> fac;
<a name="l00423"></a>00423     
<a name="l00424"></a>00424     <span class="comment">/* abort if rendering - we may get some race condition issues... */</span>
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering) <span class="keywordflow">return</span>;
<a name="l00426"></a>00426     
<a name="l00427"></a>00427     <span class="comment">/* calculate mapping factor, and abort if nothing to change */</span>
<a name="l00428"></a>00428     fac= <a class="code" href="../../d5/d34/anim__draw_8c.html#aed88dfeee22ce670a97eed98a1ec09d8">ANIM_unit_mapping_get_factor</a>(scene, <span class="keywordtype">id</span>, fcu, (flag &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#af8d3a9243f537152cd4a74368ed8646faebcc08454a0e723f7e0b2765c4762af0">ANIM_UNITCONV_RESTORE</a>));
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (fac == 1.0f)
<a name="l00430"></a>00430         <span class="keywordflow">return</span>;
<a name="l00431"></a>00431     
<a name="l00432"></a>00432     <span class="comment">/* init edit data </span>
<a name="l00433"></a>00433 <span class="comment">     *  - mapping factor is stored in f1</span>
<a name="l00434"></a>00434 <span class="comment">     *  - flags are stored in &#39;i1&#39;</span>
<a name="l00435"></a>00435 <span class="comment">     */</span>
<a name="l00436"></a>00436     memset(&amp;ked, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d01/structKeyframeEditData.html">KeyframeEditData</a>));
<a name="l00437"></a>00437     ked.<a class="code" href="../../d5/d01/structKeyframeEditData.html#a1444ccfbecc1ce0317e003838ccc261d">f1</a>= (float)fac;
<a name="l00438"></a>00438     ked.<a class="code" href="../../d5/d01/structKeyframeEditData.html#ae7333f659ba9d2b9924524225d64a27a">i1</a>= (int)flag;
<a name="l00439"></a>00439     
<a name="l00440"></a>00440     <span class="comment">/* only selected? */</span>
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../df/d6f/ED__anim__api_8h.html#af8d3a9243f537152cd4a74368ed8646fa49f0d06c161db3b7fc333135f462898e">ANIM_UNITCONV_ONLYSEL</a>)
<a name="l00442"></a>00442         sel_cb= <a class="code" href="../../db/d71/keyframes__edit_8c.html#ad8d50a9387bd9e246565328e381e1026">ANIM_editkeyframes_ok</a>(<a class="code" href="../../d7/d10/ED__keyframes__edit_8h.html#a8e98b37d6c08d1ff6782cda85ede7f39aa3a47676c0cdcc866536e24fe737afdb">BEZT_OK_SELECTED</a>);
<a name="l00443"></a>00443     <span class="keywordflow">else</span>
<a name="l00444"></a>00444         sel_cb= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00445"></a>00445     
<a name="l00446"></a>00446     <span class="comment">/* apply to F-Curve */</span>
<a name="l00447"></a>00447     <a class="code" href="../../db/d71/keyframes__edit_8c.html#acc5f398b98ef3107626e8c507091d544">ANIM_fcurve_keyframes_loop</a>(&amp;ked, fcu, sel_cb, <a class="code" href="../../d5/d34/anim__draw_8c.html#a7e7ab3556a8512beb556a9a0faa29800">bezt_unit_mapping_apply</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00448"></a>00448     
<a name="l00449"></a>00449     <span class="comment">// FIXME: loop here for samples should be generalised</span>
<a name="l00450"></a>00450     <span class="comment">// TODO: only sel?</span>
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) {
<a name="l00452"></a>00452         <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *fpt;
<a name="l00453"></a>00453         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00454"></a>00454         
<a name="l00455"></a>00455         <span class="keywordflow">for</span> (i=0, fpt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>; i &lt; fcu-&gt;totvert; i++, fpt++) {
<a name="l00456"></a>00456             <span class="comment">/* apply unit mapping */</span>
<a name="l00457"></a>00457             fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1] *= fac;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">/* *************************************************** */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:53:55 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
