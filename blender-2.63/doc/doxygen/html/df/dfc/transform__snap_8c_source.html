<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: transform_snap.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">transform_snap.c</div>  </div>
</div>
<div class="contents">
<a href="../../df/dfc/transform__snap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Martin Poirier</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span> <span class="comment">// Temporary, for snapping to other unselected meshes</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d5d/DNA__space__types_8h.html">DNA_space_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/da4/DNA__screen__types_8h.html">DNA_screen_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html">DNA_view3d_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html">DNA_windowmanager_types.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">//#include &quot;BDR_drawobject.h&quot;</span>
<a name="l00057"></a>00057 <span class="comment">//</span>
<a name="l00058"></a>00058 <span class="comment">//#include &quot;editmesh.h&quot;</span>
<a name="l00059"></a>00059 <span class="comment">//#include &quot;BIF_editsima.h&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="comment">//#include &quot;BIF_mywindow.h&quot;</span>
<a name="l00062"></a>00062 <span class="comment">//#include &quot;BIF_screen.h&quot;</span>
<a name="l00063"></a>00063 <span class="comment">//#include &quot;BIF_editsima.h&quot;</span>
<a name="l00064"></a>00064 <span class="comment">//#include &quot;BIF_drawimage.h&quot;</span>
<a name="l00065"></a>00065 <span class="comment">//#include &quot;BIF_editmesh.h&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span> <span class="comment">/* for duplis */</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d98/ED__armature_8h.html">ED_armature.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d53/ED__image_8h.html">ED_image.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d25/ED__uvedit_8h.html">ED_uvedit.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d80/transform_8h.html">transform.h</a>&quot;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">//#include &quot;blendef.h&quot; /* for selection modes */</span>
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#ae2fba757b54543df3d4b27763fae487d">00091</a> <span class="preprocessor">#define USE_BVH_FACE_SNAP</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a>00093 <span class="comment">/********************* PROTOTYPES ***********************/</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a5ad5bac4b214d51edb1aaa854a71ffe5">setSnappingCallback</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t);
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a86fbb4ec663727a8c1794e82e9366203">ApplySnapTranslation</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> vec[3]);
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a82500fcb1e30ab3e993503283c33c9c5">ApplySnapRotation</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *vec);
<a name="l00099"></a>00099 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a53b32033813475dd0e66d749c5a08eff">ApplySnapResize</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> vec[2]);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/* static void CalcSnapGrid(TransInfo *t, float *vec); */</span>
<a name="l00102"></a>00102 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a0fcc0a20a9f399afbd02e174c1653d9e">CalcSnapGeometry</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *vec);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t);
<a name="l00105"></a>00105 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a0c8576de5573ec5bfbe5ba4f98bc3c0f">TargetSnapCenter</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t);
<a name="l00106"></a>00106 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a8e7c1630ae295926f6d7cf70d8a7a357">TargetSnapClosest</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t);
<a name="l00107"></a>00107 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a39c1db7f493c6eeb7c8c78ac5328eeaf">TargetSnapActive</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a4405f9dc3dbb34e79f2715c3a0013948">RotationBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3]);
<a name="l00110"></a>00110 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a1ac1aaec6c66f834d4ebd313e31813ef">TranslationBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3]);
<a name="l00111"></a>00111 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a093ad0135f9f68378181272ae0bdae47">ResizeBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3]);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">/****************** IMPLEMENTATIONS *********************/</span>
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="preprocessor">#if 0</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#a35dfa99ea59bb679d3cb870911937dd0">BIF_snappingSupported</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119     <span class="keywordtype">int</span> status = 0;
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     <span class="keywordflow">if</span> (obedit == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) <span class="comment">/* only support object mesh, armature, curves */</span>
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123         status = 1;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     <span class="keywordflow">return</span> status;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00130"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a2dc72e8226ea318be3cf3534fb446059">00130</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d80/transform_8h.html#a2dc72e8226ea318be3cf3534fb446059">validSnap</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <span class="keywordflow">return</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>)) == (<a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>) ||
<a name="l00133"></a>00133             (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>|<a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>)) == (<a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>|<a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>);
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a100b72df2d040fe428a40fd71c0e2e8b">00136</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d80/transform_8h.html#a100b72df2d040fe428a40fd71c0e2e8b">activeSnap</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138     <span class="keywordflow">return</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ad0f3dbc77a3e6acefdb107c8ac244e69">modifiers</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a73e5c7c6238faf4462f864974093e60d">MOD_SNAP</a>|<a class="code" href="../../d2/d80/transform_8h.html#adc896c2472a2c2ee0479aa7c2b81fd00">MOD_SNAP_INVERT</a>)) == <a class="code" href="../../d2/d80/transform_8h.html#a73e5c7c6238faf4462f864974093e60d">MOD_SNAP</a> || (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ad0f3dbc77a3e6acefdb107c8ac244e69">modifiers</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a73e5c7c6238faf4462f864974093e60d">MOD_SNAP</a>|<a class="code" href="../../d2/d80/transform_8h.html#adc896c2472a2c2ee0479aa7c2b81fd00">MOD_SNAP_INVERT</a>)) == <a class="code" href="../../d2/d80/transform_8h.html#adc896c2472a2c2ee0479aa7c2b81fd00">MOD_SNAP_INVERT</a>;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a78ee7b9fe39b07585a236950789cf97a">00141</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a78ee7b9fe39b07585a236950789cf97a">drawSnapping</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d80/transform_8h.html#a2dc72e8226ea318be3cf3534fb446059">validSnap</a>(t) &amp;&amp; <a class="code" href="../../d2/d80/transform_8h.html#a100b72df2d040fe428a40fd71c0e2e8b">activeSnap</a>(t))
<a name="l00144"></a>00144         {
<a name="l00145"></a>00145         
<a name="l00146"></a>00146         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col[4], selectedCol[4], activeCol[4];
<a name="l00147"></a>00147         <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a56cb220b76a5a0ace472c22380906297">TH_TRANSFORM</a>, col);
<a name="l00148"></a>00148         col[3]= 128;
<a name="l00149"></a>00149         
<a name="l00150"></a>00150         <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531acf22ebe596e9394104b732b077cbec7a">TH_SELECT</a>, selectedCol);
<a name="l00151"></a>00151         selectedCol[3]= 128;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531af47479527035752070059cf6669daf09">TH_ACTIVE</a>, activeCol);
<a name="l00154"></a>00154         activeCol[3]= 192;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l00157"></a>00157             <a class="code" href="../../d9/d88/structTransSnapPoint.html">TransSnapPoint</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00158"></a>00158             <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l00159"></a>00159             <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l00160"></a>00160             <span class="keywordtype">float</span> imat[4][4];
<a name="l00161"></a>00161             <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00162"></a>00162             
<a name="l00163"></a>00163             glDisable(GL_DEPTH_TEST);
<a name="l00164"></a>00164     
<a name="l00165"></a>00165             size = 2.5f * <a class="code" href="../../de/d96/UI__resources_8h.html#ad9772e3578b739880ada62a6d21f4349">UI_GetThemeValuef</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a6c88c69347ab72b259eb7fcc8885327b">TH_VERTEX_SIZE</a>);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169             <span class="keywordflow">for</span> (p = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; p; p = p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a7f49ce400df346868238ecc84a921590">next</a>) {
<a name="l00170"></a>00170                 <span class="keywordflow">if</span> (p == t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a>) {
<a name="l00171"></a>00171                     glColor4ubv(selectedCol);
<a name="l00172"></a>00172                 }
<a name="l00173"></a>00173                 <span class="keywordflow">else</span> {
<a name="l00174"></a>00174                     glColor4ubv(col);
<a name="l00175"></a>00175                 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1fabc18d6380d34e0e2e66c162bdc284">drawcircball</a>(GL_LINE_LOOP, p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a30591915dcd6397b4288aad2009777f7">co</a>, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6e321972f49ac4f4e1f04b7fc3671d35">ED_view3d_pixel_size</a>(rv3d, p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a30591915dcd6397b4288aad2009777f7">co</a>) * size * 0.75f, imat);
<a name="l00178"></a>00178             }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180             <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>) {
<a name="l00181"></a>00181                 glColor4ubv(activeCol);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1fabc18d6380d34e0e2e66c162bdc284">drawcircball</a>(GL_LINE_LOOP, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6e321972f49ac4f4e1f04b7fc3671d35">ED_view3d_pixel_size</a>(rv3d, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>) * size, imat);
<a name="l00184"></a>00184             }
<a name="l00185"></a>00185             
<a name="l00186"></a>00186             <span class="comment">/* draw normal if needed */</span>
<a name="l00187"></a>00187             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d80/transform_8h.html#af9056bbc363d6f96ec806e4e778a1915">usingSnappingNormal</a>(t) &amp;&amp; <a class="code" href="../../d2/d80/transform_8h.html#a07755415ce0a1fc12fe2c9f379714018">validSnappingNormal</a>(t))
<a name="l00188"></a>00188             {
<a name="l00189"></a>00189                 glColor4ubv(activeCol);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                 glBegin(GL_LINES);
<a name="l00192"></a>00192                     glVertex3f(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[0], t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[1], t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[2]);
<a name="l00193"></a>00193                     glVertex3f( t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[0] + t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[0],
<a name="l00194"></a>00194                                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[1] + t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[1],
<a name="l00195"></a>00195                                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[2] + t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[2]);
<a name="l00196"></a>00196                 glEnd();
<a name="l00197"></a>00197             }
<a name="l00198"></a>00198             
<a name="l00199"></a>00199             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>)
<a name="l00200"></a>00200                 glEnable(GL_DEPTH_TEST);
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a>==<a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>) {
<a name="l00203"></a>00203             <span class="comment">/* This will not draw, and Im nor sure why - campbell */</span>
<a name="l00204"></a>00204 <span class="preprocessor">#if 0</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>            <span class="keywordtype">float</span> xuser_asp, yuser_asp;
<a name="l00206"></a>00206             <span class="keywordtype">int</span> wi, hi;
<a name="l00207"></a>00207             <span class="keywordtype">float</span> w, h;
<a name="l00208"></a>00208             
<a name="l00209"></a>00209             calc_image_view(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.sima, <span class="charliteral">&#39;f&#39;</span>);   <span class="comment">// float</span>
<a name="l00210"></a>00210             myortho2(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.v2d-&gt;cur.xmin, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.v2d-&gt;cur.xmax, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.v2d-&gt;cur.ymin, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.v2d-&gt;cur.ymax);
<a name="l00211"></a>00211             glLoadIdentity();
<a name="l00212"></a>00212             
<a name="l00213"></a>00213             <a class="code" href="../../de/d53/ED__image_8h.html#ab50505a62fe0f93b9735c90f41a1cfa7">ED_space_image_aspect</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab9a6bdecb3b6d03618728ab2126f3177">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;xuser_aspx, &amp;yuser_asp);
<a name="l00214"></a>00214             ED_space_image_width(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab9a6bdecb3b6d03618728ab2126f3177">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;wi, &amp;hi);
<a name="l00215"></a>00215             w = (((float)wi)/256.0f)*<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.sima-&gt;zoom * xuser_asp;
<a name="l00216"></a>00216             h = (((<span class="keywordtype">float</span>)hi)/256.0f)*<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.sima-&gt;zoom * yuser_asp;
<a name="l00217"></a>00217             
<a name="l00218"></a>00218             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0xFFFFFF);
<a name="l00219"></a>00219             glTranslatef(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[0], t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[1], 0.0f);
<a name="l00220"></a>00220             
<a name="l00221"></a>00221             <span class="comment">//glRectf(0,0,1,1);</span>
<a name="l00222"></a>00222             
<a name="l00223"></a>00223             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l00224"></a>00224             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0x0);
<a name="l00225"></a>00225             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(-0.020/w, 0, -0.1/w, 0);
<a name="l00226"></a>00226             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(0.1/w, 0, .020/w, 0);
<a name="l00227"></a>00227             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(0, -0.020/h, 0, -0.1/h);
<a name="l00228"></a>00228             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(0, 0.1/h, 0, 0.020/h);
<a name="l00229"></a>00229             
<a name="l00230"></a>00230             glTranslatef(-t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[0], -t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[1], 0.0f);
<a name="l00231"></a>00231             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l00232"></a>00232 <span class="preprocessor">#endif</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>            
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a12690d2c29d2ad0c103fca443cc01509">00238</a> <span class="keywordtype">int</span>  <a class="code" href="../../d2/d80/transform_8h.html#a54d3efc9a40c6a2888af12b69ed0d221">handleSnapping</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     <span class="keywordtype">int</span> status = 0;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="preprocessor">#if 0 // XXX need a proper selector for all snap mode</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/df2/ED__transform_8h.html#a35dfa99ea59bb679d3cb870911937dd0">BIF_snappingSupported</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>) &amp;&amp; event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a67d5864c4d46748f0c7ee7a4fc30561d">TABKEY</a> &amp;&amp; event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a284c581e97d510de46fd27af4557c7d9">shift</a>)
<a name="l00244"></a>00244     {
<a name="l00245"></a>00245         <span class="comment">/* toggle snap and reinit */</span>
<a name="l00246"></a>00246         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> ^= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3b43ed19c4ceb5efbb2d20215536819d">SCE_SNAP</a>;
<a name="l00247"></a>00247         <a class="code" href="../../d2/d80/transform_8h.html#aee40fe7cf86f9060724395c6fb86bba8">initSnapping</a>(t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00248"></a>00248         status = 1;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 <span class="preprocessor">#endif</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>)
<a name="l00252"></a>00252     {
<a name="l00253"></a>00253         status |= <a class="code" href="../../d2/d80/transform_8h.html#af0417ae19d25a0a9bdc0f7eb44afdcda">updateSelectedSnapPoint</a>(t);
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     
<a name="l00256"></a>00256     <span class="keywordflow">return</span> status;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a11e7a047064bfaa9193ea9f69974fdfc">00259</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a11e7a047064bfaa9193ea9f69974fdfc">applyProject</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="comment">/* XXX FLICKER IN OBJECT MODE */</span>
<a name="l00262"></a>00262     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a>) &amp;&amp; <a class="code" href="../../d2/d80/transform_8h.html#a100b72df2d040fe428a40fd71c0e2e8b">activeSnap</a>(t) &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a1990c83884ffae79ea451e8449fbd447">T_NO_PROJECT</a>) == 0)
<a name="l00263"></a>00263     {
<a name="l00264"></a>00264         <a class="code" href="../../d6/dc0/structTransData.html">TransData</a> *td = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ac75a26569a9563ad153f8a4c8fe19592">data</a>;
<a name="l00265"></a>00265         <span class="keywordtype">float</span> tvec[3];
<a name="l00266"></a>00266         <span class="keywordtype">float</span> imat[4][4];
<a name="l00267"></a>00267         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00268"></a>00268     
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00270"></a>00270             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00271"></a>00271             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00272"></a>00272         }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         <span class="keywordflow">for</span> (i = 0 ; i &lt; t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a89ea08ffb986abd2ca1ba41326f1a79c">total</a>; i++, td++) {
<a name="l00275"></a>00275             <span class="keywordtype">float</span> iloc[3], loc[3], no[3];
<a name="l00276"></a>00276             <span class="keywordtype">float</span> mval[2];
<a name="l00277"></a>00277             <span class="keywordtype">int</span> dist = 1000;
<a name="l00278"></a>00278             
<a name="l00279"></a>00279             <span class="keywordflow">if</span> (td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a8637c70841473236542100fc2232f56b">TD_NOACTION</a>)
<a name="l00280"></a>00280                 <span class="keywordflow">break</span>;
<a name="l00281"></a>00281             
<a name="l00282"></a>00282             <span class="keywordflow">if</span> (td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a537c7c46c9c0113cb3db76014255ea7b">TD_SKIP</a>)
<a name="l00283"></a>00283                 <span class="keywordflow">continue</span>;
<a name="l00284"></a>00284             
<a name="l00285"></a>00285             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(iloc, td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a38440ac891ed6817c930a0cd74812395">loc</a>);
<a name="l00286"></a>00286             <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>))
<a name="l00287"></a>00287             {
<a name="l00288"></a>00288                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00289"></a>00289                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, iloc);
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#abed71c72d5c3083041d52ad25630270e">T_OBJECT</a>) {
<a name="l00292"></a>00292                 td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#af3c5ebbf4c13acb3bf57e935a210aeea">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1bed6d05de7a141e9271fd0985b25a9c">recalc</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a189b3a96923b2425ee7c0990c0b3fd20">OB_RECALC_OB</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#acd3a68b1b095992c7f50c74a480549bd">OB_RECALC_TIME</a>;
<a name="l00293"></a>00293                 <a class="code" href="../../df/dac/BKE__object_8h.html#aa3a62a478e6c8cc25d8d49fd0eb25c21">object_handle_update</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#adb9e829dc854299fef6de4fe815fca8f">scene</a>, td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#af3c5ebbf4c13acb3bf57e935a210aeea">ob</a>);
<a name="l00294"></a>00294                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(iloc, td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#af3c5ebbf4c13acb3bf57e935a210aeea">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296             
<a name="l00297"></a>00297             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#af20708c74cee9dd6a964e68911246ef8">project_float</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#abc0cd6ba2b602243fcbdee0a4f77e3b3">ar</a>, iloc, mval);
<a name="l00298"></a>00298             
<a name="l00299"></a>00299             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df2/ED__transform_8h.html#a3b77e32e5b612263713c027cb1935c3c">snapObjectsTransform</a>(t, mval, &amp;dist, loc, no, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a>))
<a name="l00300"></a>00300             {
<a name="l00301"></a>00301 <span class="comment">//              if (t-&gt;flag &amp; (T_EDIT|T_POSE)) {</span>
<a name="l00302"></a>00302 <span class="comment">//                  mul_m4_v3(imat, loc);</span>
<a name="l00303"></a>00303 <span class="comment">//              }</span>
<a name="l00304"></a>00304 <span class="comment">//              </span>
<a name="l00305"></a>00305                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(tvec, loc, iloc);
<a name="l00306"></a>00306                 
<a name="l00307"></a>00307                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a08f2830dcbc5091bcbff063cb0fc3cd4">smtx</a>, tvec);
<a name="l00308"></a>00308                 
<a name="l00309"></a>00309                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a38440ac891ed6817c930a0cd74812395">loc</a>, tvec);
<a name="l00310"></a>00310             }
<a name="l00311"></a>00311             
<a name="l00312"></a>00312             <span class="comment">//XXX constraintTransLim(t, td);</span>
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a11dd25226a3aa484eedc0790bf8c4456">00317</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a11dd25226a3aa484eedc0790bf8c4456">applySnapping</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *vec)
<a name="l00318"></a>00318 {
<a name="l00319"></a>00319     <span class="comment">/* project is not applied this way */</span>
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a>)
<a name="l00321"></a>00321         <span class="keywordflow">return</span>;
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a69b30472ad3e51de221f35d2417bdf2c">SNAP_FORCED</a>)
<a name="l00324"></a>00324     {
<a name="l00325"></a>00325         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a>(t);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a>(t, vec);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af850ee3baef7ae11d5d983c559c47760">SCE_SNAP_MODE_INCREMENT</a>) &amp;&amp; <a class="code" href="../../d2/d80/transform_8h.html#a100b72df2d040fe428a40fd71c0e2e8b">activeSnap</a>(t)) {
<a name="l00330"></a>00330         <span class="keywordtype">double</span> current = <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l00331"></a>00331         
<a name="l00332"></a>00332         <span class="comment">// Time base quirky code to go around findnearest slowness</span>
<a name="l00333"></a>00333         <span class="comment">/* !TODO! add exception for object mode, no need to slow it down then */</span>
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (current - t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aaa1d683d4907d8d7b405bb588d6b49b1">last</a>  &gt;= 0.01)
<a name="l00335"></a>00335         {
<a name="l00336"></a>00336             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab6e305ac9d5869a20ac5fd1c20cbb5bf">calcSnap</a>(t, vec);
<a name="l00337"></a>00337             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a>(t);
<a name="l00338"></a>00338     
<a name="l00339"></a>00339             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aaa1d683d4907d8d7b405bb588d6b49b1">last</a> = current;
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d80/transform_8h.html#a2dc72e8226ea318be3cf3534fb446059">validSnap</a>(t))
<a name="l00342"></a>00342         {
<a name="l00343"></a>00343             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a>(t, vec);
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#ae5bbf26a2cd501e506cdd6c64928fb21">00348</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#ae5bbf26a2cd501e506cdd6c64928fb21">resetSnapping</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> = 0;
<a name="l00351"></a>00351     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab187f2dd5bf2fa2269bc7c843a96d935">align</a> = 0;
<a name="l00352"></a>00352     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a> = 0;
<a name="l00353"></a>00353     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> = 0;
<a name="l00354"></a>00354     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a> = 0;
<a name="l00355"></a>00355     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> = 0;
<a name="l00356"></a>00356     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aaa1d683d4907d8d7b405bb588d6b49b1">last</a> = 0;
<a name="l00357"></a>00357     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[0] = 0;
<a name="l00360"></a>00360     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[1] = 0;
<a name="l00361"></a>00361     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>[2] = 0;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#af9056bbc363d6f96ec806e4e778a1915">00364</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d80/transform_8h.html#af9056bbc363d6f96ec806e4e778a1915">usingSnappingNormal</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="keywordflow">return</span> t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab187f2dd5bf2fa2269bc7c843a96d935">align</a>;
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a07755415ce0a1fc12fe2c9f379714018">00369</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d80/transform_8h.html#a07755415ce0a1fc12fe2c9f379714018">validSnappingNormal</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d80/transform_8h.html#a2dc72e8226ea318be3cf3534fb446059">validSnap</a>(t))
<a name="l00372"></a>00372     {
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>) &gt; 0)
<a name="l00374"></a>00374         {
<a name="l00375"></a>00375             <span class="keywordflow">return</span> 1;
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378     
<a name="l00379"></a>00379     <span class="keywordflow">return</span> 0;
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#adc9ea9f973e3eacfb8e34726aea1563d">00382</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#adc9ea9f973e3eacfb8e34726aea1563d">initSnappingMode</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>;
<a name="l00385"></a>00385     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>;
<a name="l00386"></a>00386     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#adb9e829dc854299fef6de4fe815fca8f">scene</a>;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="comment">/* force project off when not supported */</span>
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a949506996d3839db0ad369c30374fa6a">snap_mode</a> != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a40f93d2a2b12ccca7295d1194dfd5351">SCE_SNAP_MODE_FACE</a>) {
<a name="l00390"></a>00390         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a> = 0;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a949506996d3839db0ad369c30374fa6a">snap_mode</a>;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a> || t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>) &amp;&amp; <span class="comment">// Only 3D view or UV</span>
<a name="l00396"></a>00396             (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#af49c29e9c2b4b7085969054af006a5ee">T_CAMERA</a>) == 0) { <span class="comment">// Not with camera selected in camera view</span>
<a name="l00397"></a>00397         <a class="code" href="../../df/dfc/transform__snap_8c.html#a5ad5bac4b214d51edb1aaa854a71ffe5">setSnappingCallback</a>(t);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="comment">/* Edit mode */</span>
<a name="l00400"></a>00400         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <span class="comment">// A snapping function actually exist</span>
<a name="l00401"></a>00401             (obedit != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) ) <span class="comment">// Temporary limited to edit mode meshes, armature, curves</span>
<a name="l00402"></a>00402         {
<a name="l00403"></a>00403             <span class="comment">/* Exclude editmesh if using proportional edit */</span>
<a name="l00404"></a>00404             <span class="keywordflow">if</span> ((obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a8aec81a91aedfb0ec425f1e9c41da2a2">T_PROP_EDIT</a>)) {
<a name="l00405"></a>00405                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a> = <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a5e7183a683a758ffbf9f90f7a9c8453d">SNAP_NOT_OBEDIT</a>;
<a name="l00406"></a>00406             }
<a name="l00407"></a>00407             <span class="keywordflow">else</span> {
<a name="l00408"></a>00408                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a> = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac03cea1d4148ff7a812132115a94ab03">snap_self</a> ? <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6ac561f86496b884c472e17aed3938496a">SNAP_ALL</a> : <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a5e7183a683a758ffbf9f90f7a9c8453d">SNAP_NOT_OBEDIT</a>;
<a name="l00409"></a>00409             }
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411         <span class="comment">/* Particles edit mode*/</span>
<a name="l00412"></a>00412         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <span class="comment">// A snapping function actually exist</span>
<a name="l00413"></a>00413             (obedit == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a> &amp;&amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a>-&gt;object &amp;&amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a>-&gt;object-&gt;mode &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a20027b5f4381f062402af134bcefe889">OB_MODE_PARTICLE_EDIT</a> ))
<a name="l00414"></a>00414         {
<a name="l00415"></a>00415             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a> = <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6ac561f86496b884c472e17aed3938496a">SNAP_ALL</a>;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417         <span class="comment">/* Object mode */</span>
<a name="l00418"></a>00418         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <span class="comment">// A snapping function actually exist</span>
<a name="l00419"></a>00419             (obedit == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ) <span class="comment">// Object Mode</span>
<a name="l00420"></a>00420         {
<a name="l00421"></a>00421             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a> = <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a176ad989ffd3255e4b46fc34d7d81de3">SNAP_NOT_SELECTED</a>;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         <span class="keywordflow">else</span> {
<a name="l00424"></a>00424             <span class="comment">/* Grid if snap is not possible */</span>
<a name="l00425"></a>00425             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af850ee3baef7ae11d5d983c559c47760">SCE_SNAP_MODE_INCREMENT</a>;
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="keywordflow">else</span> {
<a name="l00429"></a>00429         <span class="comment">/* Always grid outside of 3D view */</span>
<a name="l00430"></a>00430         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af850ee3baef7ae11d5d983c559c47760">SCE_SNAP_MODE_INCREMENT</a>;
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#ac0c9a6d3047694e3a577103910fefbd6">00434</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#aee40fe7cf86f9060724395c6fb86bba8">initSnapping</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>;
<a name="l00437"></a>00437     <span class="keywordtype">short</span> snap_target = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a26a0786ac49243627e5b506d35ca6c88">snap_target</a>;
<a name="l00438"></a>00438     
<a name="l00439"></a>00439     <a class="code" href="../../d2/d80/transform_8h.html#ae5bbf26a2cd501e506cdd6c64928fb21">resetSnapping</a>(t);
<a name="l00440"></a>00440     
<a name="l00441"></a>00441     <span class="comment">/* if snap property exists */</span>
<a name="l00442"></a>00442     <span class="keywordflow">if</span> (op &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap&quot;</span>) &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap&quot;</span>))
<a name="l00443"></a>00443     {
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap&quot;</span>))
<a name="l00445"></a>00445         {
<a name="l00446"></a>00446             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ad0f3dbc77a3e6acefdb107c8ac244e69">modifiers</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a73e5c7c6238faf4462f864974093e60d">MOD_SNAP</a>;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_target&quot;</span>))
<a name="l00449"></a>00449             {
<a name="l00450"></a>00450                 snap_target = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_target&quot;</span>);
<a name="l00451"></a>00451             }
<a name="l00452"></a>00452             
<a name="l00453"></a>00453             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a6134701e8798d50496b725c9cb1b6868">RNA_struct_property_is_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_point&quot;</span>))
<a name="l00454"></a>00454             {
<a name="l00455"></a>00455                 <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_point&quot;</span>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l00456"></a>00456                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a69b30472ad3e51de221f35d2417bdf2c">SNAP_FORCED</a>|<a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>;
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458             
<a name="l00459"></a>00459             <span class="comment">/* snap align only defined in specific cases */</span>
<a name="l00460"></a>00460             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_align&quot;</span>))
<a name="l00461"></a>00461             {
<a name="l00462"></a>00462                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab187f2dd5bf2fa2269bc7c843a96d935">align</a> = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_align&quot;</span>);
<a name="l00463"></a>00463                 <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;snap_normal&quot;</span>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>);
<a name="l00464"></a>00464                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>);
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;use_snap_project&quot;</span>))
<a name="l00468"></a>00468             {
<a name="l00469"></a>00469                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a> = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;use_snap_project&quot;</span>);
<a name="l00470"></a>00470             }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;use_snap_self&quot;</span>))
<a name="l00473"></a>00473             {
<a name="l00474"></a>00474                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac03cea1d4148ff7a812132115a94ab03">snap_self</a> = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;use_snap_self&quot;</span>);
<a name="l00475"></a>00475             }
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <span class="comment">/* use scene defaults only when transform is modal */</span>
<a name="l00479"></a>00479     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a14a5f9214badde85a38e6382a04575e8">T_MODAL</a>) {
<a name="l00480"></a>00480         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>)) {
<a name="l00481"></a>00481             <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3b43ed19c4ceb5efbb2d20215536819d">SCE_SNAP</a>) {
<a name="l00482"></a>00482                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ad0f3dbc77a3e6acefdb107c8ac244e69">modifiers</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a73e5c7c6238faf4462f864974093e60d">MOD_SNAP</a>;
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab187f2dd5bf2fa2269bc7c843a96d935">align</a> = ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac03ba7304752102cb717748a2d7f5bb1">SCE_SNAP_ROTATE</a>) == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac03ba7304752102cb717748a2d7f5bb1">SCE_SNAP_ROTATE</a>);
<a name="l00486"></a>00486             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a08de1b70b2b62effb5cd3e2db85e9549">project</a> = ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac8a9bdaeeb4f9f1692ca6cab3e068006">SCE_SNAP_PROJECT</a>) == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac8a9bdaeeb4f9f1692ca6cab3e068006">SCE_SNAP_PROJECT</a>);
<a name="l00487"></a>00487             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac03cea1d4148ff7a812132115a94ab03">snap_self</a> = !((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a94961d1ec756debefb3a0e41038fb3e9">SCE_SNAP_NO_SELF</a>) == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a94961d1ec756debefb3a0e41038fb3e9">SCE_SNAP_NO_SELF</a>);
<a name="l00488"></a>00488             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aa31aaa93b2f798bf1d8b9140a5a23414">peel</a> = ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac8a9bdaeeb4f9f1692ca6cab3e068006">SCE_SNAP_PROJECT</a>) == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac8a9bdaeeb4f9f1692ca6cab3e068006">SCE_SNAP_PROJECT</a>);
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491     
<a name="l00492"></a>00492     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> = snap_target;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <a class="code" href="../../df/dfc/transform__snap_8c.html#adc9ea9f973e3eacfb8e34726aea1563d">initSnappingMode</a>(t);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a5ad5bac4b214d51edb1aaa854a71ffe5">00497</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a5ad5bac4b214d51edb1aaa854a71ffe5">setSnappingCallback</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab6e305ac9d5869a20ac5fd1c20cbb5bf">calcSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a0fcc0a20a9f399afbd02e174c1653d9e">CalcSnapGeometry</a>;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">switch</span>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a>)
<a name="l00502"></a>00502     {
<a name="l00503"></a>00503         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a25476ec1cb957a2fe8eac6e7e1efac34">SCE_SNAP_TARGET_CLOSEST</a>:
<a name="l00504"></a>00504             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a8e7c1630ae295926f6d7cf70d8a7a357">TargetSnapClosest</a>;
<a name="l00505"></a>00505             <span class="keywordflow">break</span>;
<a name="l00506"></a>00506         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6d6492b976fc3e24c1babc3b1f1b11c7">SCE_SNAP_TARGET_CENTER</a>:
<a name="l00507"></a>00507             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a0c8576de5573ec5bfbe5ba4f98bc3c0f">TargetSnapCenter</a>;
<a name="l00508"></a>00508             <span class="keywordflow">break</span>;
<a name="l00509"></a>00509         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa248d77793c4a36fcb72f765a996829b">SCE_SNAP_TARGET_MEDIAN</a>:
<a name="l00510"></a>00510             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>;
<a name="l00511"></a>00511             <span class="keywordflow">break</span>;
<a name="l00512"></a>00512         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a48d733ee8a9dbbcad7225bdb54b21ba8">SCE_SNAP_TARGET_ACTIVE</a>:
<a name="l00513"></a>00513             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a39c1db7f493c6eeb7c8c78ac5328eeaf">TargetSnapActive</a>;
<a name="l00514"></a>00514             <span class="keywordflow">break</span>;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="keywordflow">switch</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab1c1f995b48bb6b0986d2dda3349cae6">mode</a>)
<a name="l00519"></a>00519     {
<a name="l00520"></a>00520     <span class="keywordflow">case</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#aa57e16cd48de3b9a989056ff8df26f84ac6708d3325ae542bd46d599286c1cf90">TFM_TRANSLATION</a>:
<a name="l00521"></a>00521         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a86fbb4ec663727a8c1794e82e9366203">ApplySnapTranslation</a>;
<a name="l00522"></a>00522         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a1ac1aaec6c66f834d4ebd313e31813ef">TranslationBetween</a>;
<a name="l00523"></a>00523         <span class="keywordflow">break</span>;
<a name="l00524"></a>00524     <span class="keywordflow">case</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#aa57e16cd48de3b9a989056ff8df26f84a507ca8d0d38d73e72777c15a79491cc1">TFM_ROTATION</a>:
<a name="l00525"></a>00525         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a82500fcb1e30ab3e993503283c33c9c5">ApplySnapRotation</a>;
<a name="l00526"></a>00526         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a4405f9dc3dbb34e79f2715c3a0013948">RotationBetween</a>;
<a name="l00527"></a>00527         
<a name="l00528"></a>00528         <span class="comment">// Can&#39;t do TARGET_CENTER with rotation, use TARGET_MEDIAN instead</span>
<a name="l00529"></a>00529         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6d6492b976fc3e24c1babc3b1f1b11c7">SCE_SNAP_TARGET_CENTER</a>) {
<a name="l00530"></a>00530             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa248d77793c4a36fcb72f765a996829b">SCE_SNAP_TARGET_MEDIAN</a>;
<a name="l00531"></a>00531             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>;
<a name="l00532"></a>00532         }
<a name="l00533"></a>00533         <span class="keywordflow">break</span>;
<a name="l00534"></a>00534     <span class="keywordflow">case</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#aa57e16cd48de3b9a989056ff8df26f84a002f81b26542b400faa00b3e7209fbbf">TFM_RESIZE</a>:
<a name="l00535"></a>00535         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a53b32033813475dd0e66d749c5a08eff">ApplySnapResize</a>;
<a name="l00536"></a>00536         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a093ad0135f9f68378181272ae0bdae47">ResizeBetween</a>;
<a name="l00537"></a>00537         
<a name="l00538"></a>00538         <span class="comment">// Can&#39;t do TARGET_CENTER with resize, use TARGET_MEDIAN instead</span>
<a name="l00539"></a>00539         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6d6492b976fc3e24c1babc3b1f1b11c7">SCE_SNAP_TARGET_CENTER</a>) {
<a name="l00540"></a>00540             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa248d77793c4a36fcb72f765a996829b">SCE_SNAP_TARGET_MEDIAN</a>;
<a name="l00541"></a>00541             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>;
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543         <span class="keywordflow">break</span>;
<a name="l00544"></a>00544     <span class="keywordflow">default</span>:
<a name="l00545"></a>00545         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ac9c68296b7d5ecc1fb04367b7d3774fc">applySnap</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00546"></a>00546         <span class="keywordflow">break</span>;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a3d07ad420101d5689bd0699345c7a3c8">00550</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a3d07ad420101d5689bd0699345c7a3c8">addSnapPoint</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00551"></a>00551 {
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>) {
<a name="l00553"></a>00553         <a class="code" href="../../d9/d88/structTransSnapPoint.html">TransSnapPoint</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d88/structTransSnapPoint.html">TransSnapPoint</a>), <span class="stringliteral">&quot;SnapPoint&quot;</span>);
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a> = <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a30591915dcd6397b4288aad2009777f7">co</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>, p);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>;
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#af0417ae19d25a0a9bdc0f7eb44afdcda">00565</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d80/transform_8h.html#af0417ae19d25a0a9bdc0f7eb44afdcda">updateSelectedSnapPoint</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <span class="keywordtype">int</span> status = 0;
<a name="l00568"></a>00568     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>) {
<a name="l00569"></a>00569         <a class="code" href="../../d9/d88/structTransSnapPoint.html">TransSnapPoint</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, *closest_p = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00570"></a>00570         <span class="keywordtype">int</span> closest_dist = 0;
<a name="l00571"></a>00571         <span class="keywordtype">int</span> screen_loc[2];
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <span class="keywordflow">for</span> ( p = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; p; p = p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a7f49ce400df346868238ecc84a921590">next</a> ) {
<a name="l00574"></a>00574             <span class="keywordtype">int</span> dx, dy;
<a name="l00575"></a>00575             <span class="keywordtype">int</span> dist;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#abc0cd6ba2b602243fcbdee0a4f77e3b3">ar</a>, p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a30591915dcd6397b4288aad2009777f7">co</a>, screen_loc);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579             dx = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[0] - screen_loc[0];
<a name="l00580"></a>00580             dy = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[1] - screen_loc[1];
<a name="l00581"></a>00581 
<a name="l00582"></a>00582             dist = dx * dx + dy * dy;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584             <span class="keywordflow">if</span> (dist &lt; 100 &amp;&amp; (closest_p == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || closest_dist &gt; dist)) {
<a name="l00585"></a>00585                 closest_p = <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00586"></a>00586                 closest_dist = dist;
<a name="l00587"></a>00587             }
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="keywordflow">if</span> (closest_p) {
<a name="l00591"></a>00591             status = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a> == closest_p ? 0 : 1;
<a name="l00592"></a>00592             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a> = closest_p;
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keywordflow">return</span> status;
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a619e3c1e6d1bfd8e49ea6219ad720a4b">00599</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a619e3c1e6d1bfd8e49ea6219ad720a4b">removeSnapPoint</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>) {
<a name="l00602"></a>00602         <a class="code" href="../../d2/d80/transform_8h.html#af0417ae19d25a0a9bdc0f7eb44afdcda">updateSelectedSnapPoint</a>(t);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a>) {
<a name="l00605"></a>00605             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a>);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607             <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00608"></a>00608                 t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp;= ~<a class="code" href="../../d2/d80/transform_8h.html#a4ebd7d73fcb02401f57d863d9953c227">MULTI_POINTS</a>;
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a300927b07351c9f27f6b5233a26e286a">selectedPoint</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#afa90e60621414f2795c1f0d36b9d4a7c">00617</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#afa90e60621414f2795c1f0d36b9d4a7c">getSnapPoint</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> vec[3])
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00620"></a>00620         <a class="code" href="../../d9/d88/structTransSnapPoint.html">TransSnapPoint</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00621"></a>00621         <span class="keywordtype">int</span> total = 0;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         vec[0] = vec[1] = vec[2] = 0;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="keywordflow">for</span> (p = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a39ac16efa6d85a9f19d473e342439204">points</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; p; p = p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a7f49ce400df346868238ecc84a921590">next</a>, total++) {
<a name="l00626"></a>00626             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, p-&gt;<a class="code" href="../../d9/d88/structTransSnapPoint.html#a30591915dcd6397b4288aad2009777f7">co</a>);
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>) {
<a name="l00630"></a>00630             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l00631"></a>00631             total++;
<a name="l00632"></a>00632         }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, 1.0f / total);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     <span class="keywordflow">else</span> {
<a name="l00637"></a>00637         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a>00641 <span class="comment">/********************** APPLY **************************/</span>
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a86fbb4ec663727a8c1794e82e9366203">00643</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a86fbb4ec663727a8c1794e82e9366203">ApplySnapTranslation</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> vec[3])
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <span class="keywordtype">float</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>[3];
<a name="l00646"></a>00646     <a class="code" href="../../d2/d80/transform_8h.html#afa90e60621414f2795c1f0d36b9d4a7c">getSnapPoint</a>(t, point);
<a name="l00647"></a>00647     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, point, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>);
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a82500fcb1e30ab3e993503283c33c9c5">00650</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a82500fcb1e30ab3e993503283c33c9c5">ApplySnapRotation</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *value)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a25476ec1cb957a2fe8eac6e7e1efac34">SCE_SNAP_TARGET_CLOSEST</a>) {
<a name="l00653"></a>00653         *value = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a>;
<a name="l00654"></a>00654     }
<a name="l00655"></a>00655     <span class="keywordflow">else</span> {
<a name="l00656"></a>00656         <span class="keywordtype">float</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>[3];
<a name="l00657"></a>00657         <a class="code" href="../../d2/d80/transform_8h.html#afa90e60621414f2795c1f0d36b9d4a7c">getSnapPoint</a>(t, point);
<a name="l00658"></a>00658         *value = <a class="code" href="../../df/dfc/transform__snap_8c.html#a4405f9dc3dbb34e79f2715c3a0013948">RotationBetween</a>(t, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, point);
<a name="l00659"></a>00659     }
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a0ae7546d3f8c516d053d8ea4abe29c35">00662</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a53b32033813475dd0e66d749c5a08eff">ApplySnapResize</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> vec[3])
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a25476ec1cb957a2fe8eac6e7e1efac34">SCE_SNAP_TARGET_CLOSEST</a>) {
<a name="l00665"></a>00665         vec[0] = vec[1] = vec[2] = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a>;
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     <span class="keywordflow">else</span> {
<a name="l00668"></a>00668         <span class="keywordtype">float</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>[3];
<a name="l00669"></a>00669         <a class="code" href="../../d2/d80/transform_8h.html#afa90e60621414f2795c1f0d36b9d4a7c">getSnapPoint</a>(t, point);
<a name="l00670"></a>00670         vec[0] = vec[1] = vec[2] = <a class="code" href="../../df/dfc/transform__snap_8c.html#a093ad0135f9f68378181272ae0bdae47">ResizeBetween</a>(t, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, point);
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="comment">/********************** DISTANCE **************************/</span>
<a name="l00675"></a>00675 
<a name="l00676"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a5dec4a8960795a9522b0c95d925f7dc0">00676</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a1ac1aaec6c66f834d4ebd313e31813ef">TranslationBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(t), <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3])
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(p1, p2);
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a4405f9dc3dbb34e79f2715c3a0013948">00681</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a4405f9dc3dbb34e79f2715c3a0013948">RotationBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3])
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683     <span class="keywordtype">float</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, start[3], end[3], center[3];
<a name="l00684"></a>00684     
<a name="l00685"></a>00685     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(center, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a4ca0d151bd334842aca43a2ad7f37979">center</a>);  
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00687"></a>00687         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00688"></a>00688         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, center);
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(start, p1, center);
<a name="l00692"></a>00692     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(end, p2, center);   
<a name="l00693"></a>00693         
<a name="l00694"></a>00694     <span class="comment">// Angle around a constraint axis (error prone, will need debug)</span>
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a3566387acaf08e61db7bee28ec44b310">applyRot</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a2663c010254d765613faa19d22fab949">mode</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#abe6ad7a39946029ddf0363bd1a202b6e">CON_APPLY</a>)) {
<a name="l00696"></a>00696         <span class="keywordtype">float</span> axis[3], tmp[3];
<a name="l00697"></a>00697         
<a name="l00698"></a>00698         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a3566387acaf08e61db7bee28ec44b310">applyRot</a>(t, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, axis, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(tmp, end, axis);
<a name="l00701"></a>00701         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(end, end, tmp);
<a name="l00702"></a>00702         
<a name="l00703"></a>00703         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(tmp, start, axis);
<a name="l00704"></a>00704         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(start, start, tmp);
<a name="l00705"></a>00705         
<a name="l00706"></a>00706         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(end);
<a name="l00707"></a>00707         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(start);
<a name="l00708"></a>00708         
<a name="l00709"></a>00709         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(tmp, start, end);
<a name="l00710"></a>00710         
<a name="l00711"></a>00711         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(tmp, axis) &lt; 0.0f)
<a name="l00712"></a>00712             angle = -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(start, end));
<a name="l00713"></a>00713         <span class="keywordflow">else</span>    
<a name="l00714"></a>00714             angle = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(start, end));
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716     <span class="keywordflow">else</span> {
<a name="l00717"></a>00717         <span class="keywordtype">float</span> mtx[3][3];
<a name="l00718"></a>00718         
<a name="l00719"></a>00719         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mtx, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#accf066e930422d8cb76021727eae2340">viewmat</a>);
<a name="l00720"></a>00720 
<a name="l00721"></a>00721         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(mtx, end);
<a name="l00722"></a>00722         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(mtx, start);
<a name="l00723"></a>00723         
<a name="l00724"></a>00724         angle = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(start[1],start[0]) - <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(end[1],end[0]);
<a name="l00725"></a>00725     }
<a name="l00726"></a>00726     
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (angle &gt; (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) {
<a name="l00728"></a>00728         angle = angle - 2 * (float)M_PI;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &lt; -((<span class="keywordtype">float</span>)M_PI)) {
<a name="l00731"></a>00731         angle = 2.0f * (float)M_PI + angle;
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733     
<a name="l00734"></a>00734     <span class="keywordflow">return</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a093ad0135f9f68378181272ae0bdae47">00737</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a093ad0135f9f68378181272ae0bdae47">ResizeBetween</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3])
<a name="l00738"></a>00738 {
<a name="l00739"></a>00739     <span class="keywordtype">float</span> d1[3], d2[3], center[3], len_d1;
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(center, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a4ca0d151bd334842aca43a2ad7f37979">center</a>);  
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00743"></a>00743         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00744"></a>00744         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, center);
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d1, p1, center);
<a name="l00748"></a>00748     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d2, p2, center);
<a name="l00749"></a>00749     
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a3566387acaf08e61db7bee28ec44b310">applyRot</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a2663c010254d765613faa19d22fab949">mode</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#abe6ad7a39946029ddf0363bd1a202b6e">CON_APPLY</a>)) {
<a name="l00751"></a>00751         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a4f72472a94f75b49129c81eb7be62fb6">pmtx</a>, d1);
<a name="l00752"></a>00752         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#add55067f78d8b531ffcd1f94a9d7420e">con</a>.<a class="code" href="../../d9/d35/structTransCon.html#a4f72472a94f75b49129c81eb7be62fb6">pmtx</a>, d2);
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754     
<a name="l00755"></a>00755     len_d1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(d1);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="keywordflow">return</span> len_d1 != 0.0f ? <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(d2) / len_d1 : 1;
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 <span class="comment">/********************** CALC **************************/</span>
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a9b446da2cfa76c6985ad4de72dd38665">00762</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a26aa3564d15ae9e56cce569a324df5da">UNUSED_FUNCTION</a>(<a class="code" href="../../df/dfc/transform__snap_8c.html#a9b446da2cfa76c6985ad4de72dd38665">CalcSnapGrid</a>)(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(vec))
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764     <a class="code" href="../../d2/d80/transform_8h.html#a5ae0f08d5e92b014ee45716e3d1ce322">snapGridAction</a>(t, t-&gt;tsnap.snapPoint, <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5433fd626bd95e39ac785f372d3d2b32">BIG_GEARS</a>);
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a75929d946cd68e9444d574779123eb94">00767</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a0fcc0a20a9f399afbd02e174c1653d9e">CalcSnapGeometry</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(vec))
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>)
<a name="l00770"></a>00770     {
<a name="l00771"></a>00771         <span class="keywordtype">float</span> loc[3];
<a name="l00772"></a>00772         <span class="keywordtype">float</span> no[3];
<a name="l00773"></a>00773         <span class="keywordtype">float</span> mval[2];
<a name="l00774"></a>00774         <span class="keywordtype">int</span> found = 0;
<a name="l00775"></a>00775         <span class="keywordtype">int</span> dist = <a class="code" href="../../d8/df2/ED__transform_8h.html#aa979e15e313e62cff0fae8bcb909a0e5">SNAP_MIN_DISTANCE</a>; <span class="comment">// Use a user defined value here</span>
<a name="l00776"></a>00776         
<a name="l00777"></a>00777         mval[0] = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[0];
<a name="l00778"></a>00778         mval[1] = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[1];
<a name="l00779"></a>00779         
<a name="l00780"></a>00780         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a89ff43c63602329141d5bd8d276c28f1">SCE_SNAP_MODE_VOLUME</a>)
<a name="l00781"></a>00781         {
<a name="l00782"></a>00782             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> depth_peels;
<a name="l00783"></a>00783             <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *p1, *p2;
<a name="l00784"></a>00784             <span class="keywordtype">float</span> *last_p = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00785"></a>00785             <span class="keywordtype">float</span> max_dist = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00786"></a>00786             <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3] = {0.0f, 0.0f, 0.0f};
<a name="l00787"></a>00787             
<a name="l00788"></a>00788             depth_peels.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = depth_peels.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00789"></a>00789             
<a name="l00790"></a>00790             <a class="code" href="../../d8/df2/ED__transform_8h.html#a2b429ac137ee95a3ff5466ee85464f17">peelObjectsTransForm</a>(t, &amp;depth_peels, mval, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a>);
<a name="l00791"></a>00791             
<a name="l00792"></a>00792 <span class="comment">//          if (LAST_SNAP_POINT_VALID)</span>
<a name="l00793"></a>00793 <span class="comment">//          {</span>
<a name="l00794"></a>00794 <span class="comment">//              last_p = LAST_SNAP_POINT;</span>
<a name="l00795"></a>00795 <span class="comment">//          }</span>
<a name="l00796"></a>00796 <span class="comment">//          else</span>
<a name="l00797"></a>00797 <span class="comment">//          {</span>
<a name="l00798"></a>00798                 last_p = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>;
<a name="l00799"></a>00799 <span class="comment">//          }</span>
<a name="l00800"></a>00800             
<a name="l00801"></a>00801             
<a name="l00802"></a>00802             <span class="keywordflow">for</span> (p1 = depth_peels.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; p1; p1 = p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>)
<a name="l00803"></a>00803             {
<a name="l00804"></a>00804                 <span class="keywordflow">if</span> (p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a10d3b8cfc94a991db14d0b08fb11170c">flag</a> == 0)
<a name="l00805"></a>00805                 {
<a name="l00806"></a>00806                     <span class="keywordtype">float</span> vec[3];
<a name="l00807"></a>00807                     <span class="keywordtype">float</span> new_dist;
<a name="l00808"></a>00808                     
<a name="l00809"></a>00809                     p2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00810"></a>00810                     p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a10d3b8cfc94a991db14d0b08fb11170c">flag</a> = 1;
<a name="l00811"></a>00811         
<a name="l00812"></a>00812                     <span class="comment">/* if peeling objects, take the first and last from each object */</span>          
<a name="l00813"></a>00813                     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a028ef4069c952a4242cbda17cd0992d5">settings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a753542d0c510180f622f335a359c9b43">snap_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3209cdecda291bffd6dda5813ec001aa">SCE_SNAP_PEEL_OBJECT</a>)
<a name="l00814"></a>00814                     {
<a name="l00815"></a>00815                         <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *peel;
<a name="l00816"></a>00816                         <span class="keywordflow">for</span> (peel = p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>; peel; peel = peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>)
<a name="l00817"></a>00817                         {
<a name="l00818"></a>00818                             <span class="keywordflow">if</span> (peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#ab27fa26b1db7ae44426808550703698e">ob</a> == p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#ab27fa26b1db7ae44426808550703698e">ob</a>)
<a name="l00819"></a>00819                             {
<a name="l00820"></a>00820                                 peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a10d3b8cfc94a991db14d0b08fb11170c">flag</a> = 1;
<a name="l00821"></a>00821                                 p2 = peel;
<a name="l00822"></a>00822                             }
<a name="l00823"></a>00823                         }
<a name="l00824"></a>00824                     }
<a name="l00825"></a>00825                     <span class="comment">/* otherwise, pair first with second and so on */</span>
<a name="l00826"></a>00826                     <span class="keywordflow">else</span> {
<a name="l00827"></a>00827                         <span class="keywordflow">for</span> (p2 = p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>; p2 &amp;&amp; p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#ab27fa26b1db7ae44426808550703698e">ob</a> != p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#ab27fa26b1db7ae44426808550703698e">ob</a>; p2 = p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>)
<a name="l00828"></a>00828                         {
<a name="l00829"></a>00829                             <span class="comment">/* nothing to do here */</span>
<a name="l00830"></a>00830                         }
<a name="l00831"></a>00831                     }
<a name="l00832"></a>00832                     
<a name="l00833"></a>00833                     <span class="keywordflow">if</span> (p2) {
<a name="l00834"></a>00834                         p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a10d3b8cfc94a991db14d0b08fb11170c">flag</a> = 1;
<a name="l00835"></a>00835                         
<a name="l00836"></a>00836                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(vec, p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3565c05ede5e16e29fea08032e7d3d33">p</a>, p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3565c05ede5e16e29fea08032e7d3d33">p</a>);
<a name="l00837"></a>00837                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, 0.5f);
<a name="l00838"></a>00838                     }
<a name="l00839"></a>00839                     <span class="keywordflow">else</span> {
<a name="l00840"></a>00840                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3565c05ede5e16e29fea08032e7d3d33">p</a>);
<a name="l00841"></a>00841                     }
<a name="l00842"></a>00842                     
<a name="l00843"></a>00843                     <span class="keywordflow">if</span> (last_p == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00844"></a>00844                     {
<a name="l00845"></a>00845                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, vec);
<a name="l00846"></a>00846                         max_dist = 0;
<a name="l00847"></a>00847                         <span class="keywordflow">break</span>;
<a name="l00848"></a>00848                     }
<a name="l00849"></a>00849                     
<a name="l00850"></a>00850                     new_dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(last_p, vec);
<a name="l00851"></a>00851                     
<a name="l00852"></a>00852                     <span class="keywordflow">if</span> (new_dist &lt; max_dist) {
<a name="l00853"></a>00853                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, vec);
<a name="l00854"></a>00854                         max_dist = new_dist;
<a name="l00855"></a>00855                     }
<a name="l00856"></a>00856                 }
<a name="l00857"></a>00857             }
<a name="l00858"></a>00858             
<a name="l00859"></a>00859             <span class="keywordflow">if</span> (max_dist != <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>)
<a name="l00860"></a>00860             {
<a name="l00861"></a>00861                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, p);
<a name="l00862"></a>00862                 <span class="comment">/* XXX, is there a correct normal in this case ???, for now just z up */</span>
<a name="l00863"></a>00863                 no[0]= 0.0;
<a name="l00864"></a>00864                 no[1]= 0.0;
<a name="l00865"></a>00865                 no[2]= 1.0;
<a name="l00866"></a>00866                 found = 1;
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868             
<a name="l00869"></a>00869             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;depth_peels);
<a name="l00870"></a>00870         }
<a name="l00871"></a>00871         <span class="keywordflow">else</span> {
<a name="l00872"></a>00872             found = <a class="code" href="../../d8/df2/ED__transform_8h.html#a3b77e32e5b612263713c027cb1935c3c">snapObjectsTransform</a>(t, mval, &amp;dist, loc, no, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a48a76f00e3fa1ccf7ef58d278f70cd6d">modeSelect</a>);
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         
<a name="l00875"></a>00875         <span class="keywordflow">if</span> (found == 1) {
<a name="l00876"></a>00876             <span class="keywordtype">float</span> tangent[3];
<a name="l00877"></a>00877             
<a name="l00878"></a>00878             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(tangent, loc, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l00879"></a>00879             tangent[2] = 0; 
<a name="l00880"></a>00880             
<a name="l00881"></a>00881             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(tangent, tangent) &gt; 0)
<a name="l00882"></a>00882             {
<a name="l00883"></a>00883                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a5b42237a9699fc5f84aa40f5b985420f">snapTangent</a>, tangent);
<a name="l00884"></a>00884             }
<a name="l00885"></a>00885             
<a name="l00886"></a>00886             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>, loc);
<a name="l00887"></a>00887             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a289dd16440b0bf0e30f652f56bfe41ae">snapNormal</a>, no);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |=  <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>;
<a name="l00890"></a>00890         }
<a name="l00891"></a>00891         <span class="keywordflow">else</span> {
<a name="l00892"></a>00892             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp;= ~<a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>;
<a name="l00893"></a>00893         }
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a> &amp;&amp; t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00896"></a>00896         <span class="comment">/* same as above but for UV&#39;s */</span>
<a name="l00897"></a>00897         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= <a class="code" href="../../de/d53/ED__image_8h.html#a8ad18e26f8f83222010f6781a1f51a7c">ED_space_image</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab9a6bdecb3b6d03618728ab2126f3177">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l00898"></a>00898         <span class="keywordtype">float</span> aspx, aspy, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2];
<a name="l00899"></a>00899         
<a name="l00900"></a>00900         <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#abc0cd6ba2b602243fcbdee0a4f77e3b3">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[0], t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a2024d266b0b3ddbba689808bafa40df7">mval</a>[1], co, co+1);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d25/ED__uvedit_8h.html#a5a413a53d39b03378d707ed3f7e76a4c">ED_uvedit_nearest_uv</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#adb9e829dc854299fef6de4fe815fca8f">scene</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>, ima, co, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>))
<a name="l00903"></a>00903         {
<a name="l00904"></a>00904             <a class="code" href="../../de/d53/ED__image_8h.html#aad1989be279911287243afb19ac98dee">ED_space_image_uv_aspect</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab9a6bdecb3b6d03618728ab2126f3177">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, &amp;aspx, &amp;aspy);
<a name="l00905"></a>00905             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[0] *= aspx;
<a name="l00906"></a>00906             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>[1] *= aspy;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |=  <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>;
<a name="l00909"></a>00909         }
<a name="l00910"></a>00910         <span class="keywordflow">else</span> {
<a name="l00911"></a>00911             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp;= ~<a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>;
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913     }
<a name="l00914"></a>00914 }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 <span class="comment">/********************** TARGET **************************/</span>
<a name="l00917"></a>00917 
<a name="l00918"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a0c8576de5573ec5bfbe5ba4f98bc3c0f">00918</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a0c8576de5573ec5bfbe5ba4f98bc3c0f">TargetSnapCenter</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00919"></a>00919 {
<a name="l00920"></a>00920     <span class="comment">// Only need to calculate once</span>
<a name="l00921"></a>00921     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>) == 0)
<a name="l00922"></a>00922     {
<a name="l00923"></a>00923         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a4ca0d151bd334842aca43a2ad7f37979">center</a>); 
<a name="l00924"></a>00924         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00925"></a>00925             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00926"></a>00926             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>);
<a name="l00927"></a>00927         }
<a name="l00928"></a>00928         
<a name="l00929"></a>00929         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>;     
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a39c1db7f493c6eeb7c8c78ac5328eeaf">00933</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a39c1db7f493c6eeb7c8c78ac5328eeaf">TargetSnapActive</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935     <span class="comment">// Only need to calculate once</span>
<a name="l00936"></a>00936     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>) == 0)
<a name="l00937"></a>00937     {
<a name="l00938"></a>00938         <a class="code" href="../../d6/dc0/structTransData.html">TransData</a> *td = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00939"></a>00939         <a class="code" href="../../d6/dc0/structTransData.html">TransData</a> *active_td = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00940"></a>00940         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942         <span class="keywordflow">for</span> (td = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ac75a26569a9563ad153f8a4c8fe19592">data</a>, i = 0 ; i &lt; t-&gt;total &amp;&amp; td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#ac19089bd84ac958c5fc948be6795e1f4">TD_SELECTED</a> ; i++, td++)
<a name="l00943"></a>00943         {
<a name="l00944"></a>00944             <span class="keywordflow">if</span> (td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#ae81df3135feb4622fe16d2de23c3d990">TD_ACTIVE</a>)
<a name="l00945"></a>00945             {
<a name="l00946"></a>00946                 active_td = td;
<a name="l00947"></a>00947                 <span class="keywordflow">break</span>;
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949         }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951         <span class="keywordflow">if</span> (active_td)
<a name="l00952"></a>00952         {   
<a name="l00953"></a>00953             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, active_td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a9e939d37bfce48120fdb7ee832fe2284">center</a>);
<a name="l00954"></a>00954                 
<a name="l00955"></a>00955             <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00956"></a>00956                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00957"></a>00957                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>);
<a name="l00958"></a>00958             }
<a name="l00959"></a>00959             
<a name="l00960"></a>00960             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>;
<a name="l00961"></a>00961         }
<a name="l00962"></a>00962         <span class="comment">/* No active, default to median */</span>
<a name="l00963"></a>00963         <span class="keywordflow">else</span> {
<a name="l00964"></a>00964             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a0f89b83c8f464de7f99d5f43c6dc0271">target</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa248d77793c4a36fcb72f765a996829b">SCE_SNAP_TARGET_MEDIAN</a>;
<a name="l00965"></a>00965             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a25a3e1e1445c5bb52fe15980b2633d4c">targetSnap</a> = <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>;
<a name="l00966"></a>00966             <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>(t);
<a name="l00967"></a>00967         }       
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00971"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">00971</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a745007313c741f6657861ae9cca1e8be">TargetSnapMedian</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973     <span class="comment">// Only need to calculate once</span>
<a name="l00974"></a>00974     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>) == 0)
<a name="l00975"></a>00975     {
<a name="l00976"></a>00976         <a class="code" href="../../d6/dc0/structTransData.html">TransData</a> *td = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00977"></a>00977         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>[0] = 0;
<a name="l00980"></a>00980         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>[1] = 0;
<a name="l00981"></a>00981         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>[2] = 0;
<a name="l00982"></a>00982         
<a name="l00983"></a>00983         <span class="keywordflow">for</span> (td = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ac75a26569a9563ad153f8a4c8fe19592">data</a>, i = 0 ; i &lt; t-&gt;total &amp;&amp; td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#ac19089bd84ac958c5fc948be6795e1f4">TD_SELECTED</a> ; i++, td++)
<a name="l00984"></a>00984         {
<a name="l00985"></a>00985             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a9e939d37bfce48120fdb7ee832fe2284">center</a>);
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987         
<a name="l00988"></a>00988         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, 1.0 / i);
<a name="l00989"></a>00989         
<a name="l00990"></a>00990         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l00991"></a>00991             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l00992"></a>00992             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>);
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994         
<a name="l00995"></a>00995         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>;     
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a8e7c1630ae295926f6d7cf70d8a7a357">00999</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a8e7c1630ae295926f6d7cf70d8a7a357">TargetSnapClosest</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t)
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001     <span class="comment">// Only valid if a snap point has been selected</span>
<a name="l01002"></a>01002     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a77843154083be2c7297716dd00db012f">POINT_INIT</a>)
<a name="l01003"></a>01003     {
<a name="l01004"></a>01004         <a class="code" href="../../d6/dc0/structTransData.html">TransData</a> *closest = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *td = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01005"></a>01005         
<a name="l01006"></a>01006         <span class="comment">/* Object mode */</span>
<a name="l01007"></a>01007         <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#abed71c72d5c3083041d52ad25630270e">T_OBJECT</a>)
<a name="l01008"></a>01008         {
<a name="l01009"></a>01009             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01010"></a>01010             <span class="keywordflow">for</span> (td = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ac75a26569a9563ad153f8a4c8fe19592">data</a>, i = 0 ; i &lt; t-&gt;total &amp;&amp; td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#ac19089bd84ac958c5fc948be6795e1f4">TD_SELECTED</a> ; i++, td++)
<a name="l01011"></a>01011             {
<a name="l01012"></a>01012                 <span class="keyword">struct </span><a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *bb = <a class="code" href="../../df/dac/BKE__object_8h.html#a06d0e9b4ebc3a7cf0f99a8916f90a851">object_get_boundbox</a>(td-&gt;ob);
<a name="l01013"></a>01013                 
<a name="l01014"></a>01014                 <span class="comment">/* use boundbox if possible */</span>
<a name="l01015"></a>01015                 <span class="keywordflow">if</span> (bb)
<a name="l01016"></a>01016                 {
<a name="l01017"></a>01017                     <span class="keywordtype">int</span> j;
<a name="l01018"></a>01018                     
<a name="l01019"></a>01019                     <span class="keywordflow">for</span> (j = 0; j &lt; 8; j++) {
<a name="l01020"></a>01020                         <span class="keywordtype">float</span> loc[3];
<a name="l01021"></a>01021                         <span class="keywordtype">float</span> dist;
<a name="l01022"></a>01022                         
<a name="l01023"></a>01023                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, bb-&gt;<a class="code" href="../../d3/d8a/structBoundBox.html#ad1955c11c5a6c98f2c8b714c20337fb3">vec</a>[j]);
<a name="l01024"></a>01024                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(td-&gt;ext-&gt;obmat, loc);
<a name="l01025"></a>01025                         
<a name="l01026"></a>01026                         dist = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a>(t, loc, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l01027"></a>01027                         
<a name="l01028"></a>01028                         <span class="keywordflow">if</span> (closest == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dist) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a>)) {
<a name="l01029"></a>01029                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, loc);
<a name="l01030"></a>01030                             closest = td;
<a name="l01031"></a>01031                             t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a> = dist; 
<a name="l01032"></a>01032                         }
<a name="l01033"></a>01033                     }
<a name="l01034"></a>01034                 }
<a name="l01035"></a>01035                 <span class="comment">/* use element center otherwise */</span>
<a name="l01036"></a>01036                 <span class="keywordflow">else</span> {
<a name="l01037"></a>01037                     <span class="keywordtype">float</span> loc[3];
<a name="l01038"></a>01038                     <span class="keywordtype">float</span> dist;
<a name="l01039"></a>01039                     
<a name="l01040"></a>01040                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, td-&gt;center);
<a name="l01041"></a>01041                     
<a name="l01042"></a>01042                     dist = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a>(t, loc, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l01043"></a>01043                     
<a name="l01044"></a>01044                     <span class="keywordflow">if</span> (closest == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dist) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a>))
<a name="l01045"></a>01045                     {
<a name="l01046"></a>01046                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, loc);
<a name="l01047"></a>01047                         closest = td;
<a name="l01048"></a>01048                         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a> = dist; 
<a name="l01049"></a>01049                     }
<a name="l01050"></a>01050                 }
<a name="l01051"></a>01051             }
<a name="l01052"></a>01052         }
<a name="l01053"></a>01053         <span class="keywordflow">else</span> {
<a name="l01054"></a>01054             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01055"></a>01055             <span class="keywordflow">for</span> (td = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ac75a26569a9563ad153f8a4c8fe19592">data</a>, i = 0 ; i &lt; t-&gt;total &amp;&amp; td-&gt;<a class="code" href="../../d6/dc0/structTransData.html#a5aa009eca4e2750ba23d1c505f5b1cb5">flag</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#ac19089bd84ac958c5fc948be6795e1f4">TD_SELECTED</a> ; i++, td++) {
<a name="l01056"></a>01056                 <span class="keywordtype">float</span> loc[3];
<a name="l01057"></a>01057                 <span class="keywordtype">float</span> dist;
<a name="l01058"></a>01058                 
<a name="l01059"></a>01059                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, td-&gt;center);
<a name="l01060"></a>01060                 
<a name="l01061"></a>01061                 <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a9b2befec7ca57a06b493ba86b754caa6">flag</a> &amp; (<a class="code" href="../../d2/d80/transform_8h.html#a246046d89b8b7707a9eee55d84b8ecba">T_EDIT</a>|<a class="code" href="../../d2/d80/transform_8h.html#a3ff300f116681287e7d8cd85df543c31">T_POSE</a>)) {
<a name="l01062"></a>01062                     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>?t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>:t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#aefcd6d2b51a3fa9ab4479e0f84928c57">poseobj</a>;
<a name="l01063"></a>01063                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, loc);
<a name="l01064"></a>01064                 }
<a name="l01065"></a>01065                 
<a name="l01066"></a>01066                 dist = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ab56b3ecf4e6898f4710cb953781da72b">distance</a>(t, loc, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a89392ddc768372165988217445c0396f">snapPoint</a>);
<a name="l01067"></a>01067                 
<a name="l01068"></a>01068                 <span class="keywordflow">if</span> (closest == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dist) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a>))
<a name="l01069"></a>01069                 {
<a name="l01070"></a>01070                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#aced78ac89474d686554ab3120209cb0c">snapTarget</a>, loc);
<a name="l01071"></a>01071                     closest = td;
<a name="l01072"></a>01072                     t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a074e2cc12423e69c2080bd6fbb2a02a8">dist</a> = dist; 
<a name="l01073"></a>01073                 }
<a name="l01074"></a>01074             }
<a name="l01075"></a>01075         }
<a name="l01076"></a>01076         
<a name="l01077"></a>01077         t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#ae2ee0ab947e445ea9924426cddacc32c">status</a> |= <a class="code" href="../../d2/d80/transform_8h.html#a461e8e5a79baaa8d050ebe3149b7cdec">TARGET_INIT</a>;
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 <span class="comment">/*================================================================*/</span>
<a name="l01081"></a>01081 <span class="preprocessor">#ifndef USE_BVH_FACE_SNAP</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> snapFace(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> v1co[3], <span class="keywordtype">float</span> v2co[3], <span class="keywordtype">float</span> v3co[3], <span class="keywordtype">float</span> *v4co, <span class="keywordtype">float</span> mval[2], <span class="keywordtype">float</span> ray_start[3], <span class="keywordtype">float</span> ray_start_local[3], <span class="keywordtype">float</span> ray_normal_local[3], <span class="keywordtype">float</span> obmat[][4], <span class="keywordtype">float</span> timat[][3], <span class="keywordtype">float</span> loc[3], <span class="keywordtype">float</span> no[3], <span class="keywordtype">int</span> *dist, <span class="keywordtype">float</span> *depth)
<a name="l01083"></a>01083 {
<a name="l01084"></a>01084     <span class="keywordtype">float</span> lambda;
<a name="l01085"></a>01085     <span class="keywordtype">int</span> result;
<a name="l01086"></a>01086     <span class="keywordtype">int</span> retval = 0;
<a name="l01087"></a>01087     
<a name="l01088"></a>01088     result = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8c89d506d78d26912d4f29deb9d11588">isect_ray_tri_threshold_v3</a>(ray_start_local, ray_normal_local, v1co, v2co, v3co, &amp;lambda, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.001);
<a name="l01089"></a>01089     
<a name="l01090"></a>01090     <span class="keywordflow">if</span> (result) {
<a name="l01091"></a>01091         <span class="keywordtype">float</span> location[3], normal[3];
<a name="l01092"></a>01092         <span class="keywordtype">float</span> <a class="code" href="../../dc/de7/rayobject__vbvh_8cpp.html#ae47a935fc48f1b53ebf1d7bab772119d">intersect</a>[3];
<a name="l01093"></a>01093         <span class="keywordtype">float</span> new_depth;
<a name="l01094"></a>01094         <span class="keywordtype">int</span> screen_loc[2];
<a name="l01095"></a>01095         <span class="keywordtype">int</span> new_dist;
<a name="l01096"></a>01096         
<a name="l01097"></a>01097         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(intersect, ray_normal_local);
<a name="l01098"></a>01098         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(intersect, lambda);
<a name="l01099"></a>01099         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(intersect, ray_start_local);
<a name="l01100"></a>01100         
<a name="l01101"></a>01101         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(location, intersect);
<a name="l01102"></a>01102         
<a name="l01103"></a>01103         <span class="keywordflow">if</span> (v4co)
<a name="l01104"></a>01104             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( normal,v1co, v2co, v3co, v4co);
<a name="l01105"></a>01105         <span class="keywordflow">else</span>
<a name="l01106"></a>01106             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( normal,v1co, v2co, v3co);
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, location);
<a name="l01109"></a>01109         
<a name="l01110"></a>01110         new_depth = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(location, ray_start);                  
<a name="l01111"></a>01111         
<a name="l01112"></a>01112         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(ar, location, screen_loc);
<a name="l01113"></a>01113         new_dist = <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[0] - (<span class="keywordtype">int</span>)mval[0]) + <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[1] - (<span class="keywordtype">int</span>)mval[1]);
<a name="l01114"></a>01114         
<a name="l01115"></a>01115         <span class="keywordflow">if</span> (new_dist &lt;= *dist &amp;&amp; new_depth &lt; *depth) 
<a name="l01116"></a>01116         {
<a name="l01117"></a>01117             *depth = new_depth;
<a name="l01118"></a>01118             retval = 1;
<a name="l01119"></a>01119             
<a name="l01120"></a>01120             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, location);
<a name="l01121"></a>01121             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(no, normal);
<a name="l01122"></a>01122             
<a name="l01123"></a>01123             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, no);
<a name="l01124"></a>01124             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(no);
<a name="l01125"></a>01125 
<a name="l01126"></a>01126             *dist = new_dist;
<a name="l01127"></a>01127         } 
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129     
<a name="l01130"></a>01130     <span class="keywordflow">return</span> retval;
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 <span class="preprocessor">#endif</span>
<a name="l01133"></a>01133 <span class="preprocessor"></span>
<a name="l01134"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#af9af37c670730220675d8b03b9fb98e0">01134</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#af9af37c670730220675d8b03b9fb98e0">snapEdge</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> v1co[3], <span class="keywordtype">short</span> v1no[3], <span class="keywordtype">float</span> v2co[3], <span class="keywordtype">short</span> v2no[3], <span class="keywordtype">float</span> obmat[][4], <span class="keywordtype">float</span> timat[][3],
<a name="l01135"></a>01135                     <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start_local[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal_local[3], <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01136"></a>01136                     <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> *r_depth)
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138     <span class="keywordtype">float</span> intersect[3] = {0, 0, 0}, ray_end[3], dvec[3];
<a name="l01139"></a>01139     <span class="keywordtype">int</span> result;
<a name="l01140"></a>01140     <span class="keywordtype">int</span> retval = 0;
<a name="l01141"></a>01141     
<a name="l01142"></a>01142     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_end, ray_normal_local);
<a name="l01143"></a>01143     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ray_end, 2000);
<a name="l01144"></a>01144     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(ray_end, ray_start_local, ray_end);
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     result = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a60ead4f3b5813794f90d67f9d2ee1bfa">isect_line_line_v3</a>(v1co, v2co, ray_start_local, ray_end, intersect, dvec); <span class="comment">/* dvec used but we don&#39;t care about result */</span>
<a name="l01147"></a>01147     
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (result)
<a name="l01149"></a>01149     {
<a name="l01150"></a>01150         <span class="keywordtype">float</span> edge_loc[3], <a class="code" href="../../d3/d8a/structBoundBox.html#ad1955c11c5a6c98f2c8b714c20337fb3">vec</a>[3];
<a name="l01151"></a>01151         <span class="keywordtype">float</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a0ea807db9b245d41852d0326d715cc0b">mul</a>;
<a name="l01152"></a>01152     
<a name="l01153"></a>01153         <span class="comment">/* check for behind ray_start */</span>
<a name="l01154"></a>01154         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec, intersect, ray_start_local);
<a name="l01155"></a>01155         
<a name="l01156"></a>01156         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge_loc, v1co, v2co);
<a name="l01157"></a>01157         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, intersect, v2co);
<a name="l01158"></a>01158         
<a name="l01159"></a>01159         mul = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, edge_loc) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(edge_loc, edge_loc);
<a name="l01160"></a>01160         
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (mul &gt; 1) {
<a name="l01162"></a>01162             mul = 1;
<a name="l01163"></a>01163             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(intersect, v1co);
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mul &lt; 0) {
<a name="l01166"></a>01166             mul = 0;
<a name="l01167"></a>01167             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(intersect, v2co);
<a name="l01168"></a>01168         }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ray_normal_local, dvec) &gt; 0)
<a name="l01171"></a>01171         {
<a name="l01172"></a>01172             <span class="keywordtype">float</span> location[3];
<a name="l01173"></a>01173             <span class="keywordtype">float</span> new_depth;
<a name="l01174"></a>01174             <span class="keywordtype">int</span> screen_loc[2];
<a name="l01175"></a>01175             <span class="keywordtype">int</span> new_dist;
<a name="l01176"></a>01176             
<a name="l01177"></a>01177             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(location, intersect);
<a name="l01178"></a>01178             
<a name="l01179"></a>01179             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, location);
<a name="l01180"></a>01180             
<a name="l01181"></a>01181             new_depth = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(location, ray_start);                  
<a name="l01182"></a>01182             
<a name="l01183"></a>01183             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(ar, location, screen_loc);
<a name="l01184"></a>01184             new_dist = <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[0] - (<span class="keywordtype">int</span>)mval[0]) + <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[1] - (<span class="keywordtype">int</span>)mval[1]);
<a name="l01185"></a>01185             
<a name="l01186"></a>01186             <span class="comment">/* 10% threshold if edge is closer but a bit further</span>
<a name="l01187"></a>01187 <span class="comment">             * this takes care of series of connected edges a bit slanted w.r.t the viewport</span>
<a name="l01188"></a>01188 <span class="comment">             * otherwise, it would stick to the verts of the closest edge and not slide along merrily </span>
<a name="l01189"></a>01189 <span class="comment">             * */</span>
<a name="l01190"></a>01190             <span class="keywordflow">if</span> (new_dist &lt;= *r_dist &amp;&amp; new_depth &lt; *r_depth * 1.001f)
<a name="l01191"></a>01191             {
<a name="l01192"></a>01192                 <span class="keywordtype">float</span> n1[3], n2[3];
<a name="l01193"></a>01193                 
<a name="l01194"></a>01194                 *r_depth = new_depth;
<a name="l01195"></a>01195                 retval = 1;
<a name="l01196"></a>01196                 
<a name="l01197"></a>01197                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge_loc, v1co, v2co);
<a name="l01198"></a>01198                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, intersect, v2co);
<a name="l01199"></a>01199                 
<a name="l01200"></a>01200                 mul = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, edge_loc) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(edge_loc, edge_loc);
<a name="l01201"></a>01201                 
<a name="l01202"></a>01202                 <span class="keywordflow">if</span> (r_no)
<a name="l01203"></a>01203                 {
<a name="l01204"></a>01204                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(n1, v1no);                     
<a name="l01205"></a>01205                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(n2, v2no);
<a name="l01206"></a>01206                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(r_no, n2, n1, mul);
<a name="l01207"></a>01207                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, r_no);
<a name="l01208"></a>01208                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_no);
<a name="l01209"></a>01209                 }           
<a name="l01210"></a>01210 
<a name="l01211"></a>01211                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(r_loc, location);
<a name="l01212"></a>01212                 
<a name="l01213"></a>01213                 *r_dist = new_dist;
<a name="l01214"></a>01214             } 
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217     
<a name="l01218"></a>01218     <span class="keywordflow">return</span> retval;
<a name="l01219"></a>01219 }
<a name="l01220"></a>01220 
<a name="l01221"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">01221</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> vco[3], <span class="keywordtype">short</span> vno[3], <span class="keywordtype">float</span> obmat[][4], <span class="keywordtype">float</span> timat[][3],
<a name="l01222"></a>01222                       <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start_local[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal_local[3], <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01223"></a>01223                       <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> *r_depth)
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225     <span class="keywordtype">int</span> retval = 0;
<a name="l01226"></a>01226     <span class="keywordtype">float</span> dvec[3];
<a name="l01227"></a>01227     
<a name="l01228"></a>01228     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec, vco, ray_start_local);
<a name="l01229"></a>01229     
<a name="l01230"></a>01230     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ray_normal_local, dvec) &gt; 0)
<a name="l01231"></a>01231     {
<a name="l01232"></a>01232         <span class="keywordtype">float</span> location[3];
<a name="l01233"></a>01233         <span class="keywordtype">float</span> new_depth;
<a name="l01234"></a>01234         <span class="keywordtype">int</span> screen_loc[2];
<a name="l01235"></a>01235         <span class="keywordtype">int</span> new_dist;
<a name="l01236"></a>01236         
<a name="l01237"></a>01237         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(location, vco);
<a name="l01238"></a>01238         
<a name="l01239"></a>01239         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, location);
<a name="l01240"></a>01240         
<a name="l01241"></a>01241         new_depth = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(location, ray_start);
<a name="l01242"></a>01242         
<a name="l01243"></a>01243         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(ar, location, screen_loc);
<a name="l01244"></a>01244         new_dist = <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[0] - (<span class="keywordtype">int</span>)mval[0]) + <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(screen_loc[1] - (<span class="keywordtype">int</span>)mval[1]);
<a name="l01245"></a>01245         
<a name="l01246"></a>01246         <span class="keywordflow">if</span> (new_dist &lt;= *r_dist &amp;&amp; new_depth &lt; *r_depth)
<a name="l01247"></a>01247         {
<a name="l01248"></a>01248             *r_depth = new_depth;
<a name="l01249"></a>01249             retval = 1;
<a name="l01250"></a>01250             
<a name="l01251"></a>01251             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(r_loc, location);
<a name="l01252"></a>01252             
<a name="l01253"></a>01253             <span class="keywordflow">if</span> (r_no)
<a name="l01254"></a>01254             {
<a name="l01255"></a>01255                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(r_no, vno);
<a name="l01256"></a>01256                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, r_no);
<a name="l01257"></a>01257                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_no);
<a name="l01258"></a>01258             }
<a name="l01259"></a>01259 
<a name="l01260"></a>01260             *r_dist = new_dist;
<a name="l01261"></a>01261         } 
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263     
<a name="l01264"></a>01264     <span class="keywordflow">return</span> retval;
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
<a name="l01267"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a2f924b23896d41023dfe3ead0a9f6519">01267</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a2f924b23896d41023dfe3ead0a9f6519">snapArmature</a>(<span class="keywordtype">short</span> snap_mode, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <span class="keywordtype">float</span> obmat[][4],
<a name="l01268"></a>01268                         <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal[3], <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01269"></a>01269                         <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(r_no), <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> *r_depth)
<a name="l01270"></a>01270 {
<a name="l01271"></a>01271     <span class="keywordtype">float</span> imat[4][4];
<a name="l01272"></a>01272     <span class="keywordtype">float</span> ray_start_local[3], ray_normal_local[3];
<a name="l01273"></a>01273     <span class="keywordtype">int</span> retval = 0;
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, obmat);
<a name="l01276"></a>01276 
<a name="l01277"></a>01277     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_start_local, ray_start);
<a name="l01278"></a>01278     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_normal_local, ray_normal);
<a name="l01279"></a>01279     
<a name="l01280"></a>01280     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, ray_start_local);
<a name="l01281"></a>01281     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(imat, ray_normal_local);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>)
<a name="l01284"></a>01284     {
<a name="l01285"></a>01285         <a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *eBone;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         <span class="keywordflow">for</span> (eBone=arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eBone; eBone=eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a3625b4b7daa42dbfde160d0d8129e57b">next</a>) {
<a name="l01288"></a>01288             <span class="keywordflow">if</span> (eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#ad092772299e0a064c852e488eedaea61">layer</a> &amp; arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a>) {
<a name="l01289"></a>01289                 <span class="comment">/* skip hidden or moving (selected) bones */</span>
<a name="l01290"></a>01290                 <span class="keywordflow">if</span> ((eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a6c7db9597e20d97ea4ae61eaacdc41fe">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a5dcf60e8cd1c7c56a906d7a01fc01327">BONE_HIDDEN_A</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a0349b6b0b0156b6fb460e29f870bb443">BONE_ROOTSEL</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50abd540848fbcdcaf33141f6ce27766114">BONE_TIPSEL</a>))==0) {
<a name="l01291"></a>01291                     <span class="keywordflow">switch</span> (snap_mode)
<a name="l01292"></a>01292                     {
<a name="l01293"></a>01293                         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad013bec1ba6895fc29378822742d2359">SCE_SNAP_MODE_VERTEX</a>:
<a name="l01294"></a>01294                             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(ar, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01295"></a>01295                             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(ar, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01296"></a>01296                             <span class="keywordflow">break</span>;
<a name="l01297"></a>01297                         <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aeb9874bea7be38ad81fbe2e200f93dff">SCE_SNAP_MODE_EDGE</a>:
<a name="l01298"></a>01298                             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#af9af37c670730220675d8b03b9fb98e0">snapEdge</a>(ar, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#afb155f521bdb5d856ec84d95cd430861">head</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, eBone-&gt;<a class="code" href="../../da/d29/structEditBone.html#a390914096213eba14510d2043f85a27f">tail</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01299"></a>01299                             <span class="keywordflow">break</span>;
<a name="l01300"></a>01300                     }
<a name="l01301"></a>01301                 }
<a name="l01302"></a>01302             }
<a name="l01303"></a>01303         }
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01306"></a>01306         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01307"></a>01307         <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01308"></a>01308         
<a name="l01309"></a>01309         <span class="keywordflow">for</span> (pchan= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01310"></a>01310             bone= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l01311"></a>01311             <span class="comment">/* skip hidden bones */</span>
<a name="l01312"></a>01312             <span class="keywordflow">if</span> (bone &amp;&amp; !(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ab23a8cde9f34efaef713308cc72166de">BONE_HIDDEN_P</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ae8339bbfbb2e25d7a8cf01cde3312edd">BONE_HIDDEN_PG</a>))) {
<a name="l01313"></a>01313                 <span class="keywordtype">float</span> *head_vec = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>;
<a name="l01314"></a>01314                 <span class="keywordtype">float</span> *tail_vec = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>;
<a name="l01315"></a>01315                 
<a name="l01316"></a>01316                 <span class="keywordflow">switch</span> (snap_mode)
<a name="l01317"></a>01317                 {
<a name="l01318"></a>01318                     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad013bec1ba6895fc29378822742d2359">SCE_SNAP_MODE_VERTEX</a>:
<a name="l01319"></a>01319                         retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(ar, head_vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01320"></a>01320                         retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(ar, tail_vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01321"></a>01321                         <span class="keywordflow">break</span>;
<a name="l01322"></a>01322                     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aeb9874bea7be38ad81fbe2e200f93dff">SCE_SNAP_MODE_EDGE</a>:
<a name="l01323"></a>01323                         retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#af9af37c670730220675d8b03b9fb98e0">snapEdge</a>(ar, head_vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tail_vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ray_start, ray_start_local, ray_normal_local, mval, r_loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, r_dist, r_depth);
<a name="l01324"></a>01324                         <span class="keywordflow">break</span>;
<a name="l01325"></a>01325                 }
<a name="l01326"></a>01326             }
<a name="l01327"></a>01327         }
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="keywordflow">return</span> retval;
<a name="l01331"></a>01331 }
<a name="l01332"></a>01332 
<a name="l01333"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#aa20043177d148e9d2de0ce4fa79352f5">01333</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#aa20043177d148e9d2de0ce4fa79352f5">snapDerivedMesh</a>(<span class="keywordtype">short</span> snap_mode, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">float</span> obmat[][4],
<a name="l01334"></a>01334                            <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal[3], <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01335"></a>01335                            <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> *r_depth)
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337     <span class="keywordtype">int</span> retval = 0;
<a name="l01338"></a>01338     <span class="keywordtype">int</span> totvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01339"></a>01339     <span class="keywordtype">int</span> totface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (totvert &gt; 0) {
<a name="l01342"></a>01342         <span class="keywordtype">float</span> imat[4][4];
<a name="l01343"></a>01343         <span class="keywordtype">float</span> timat[3][3]; <span class="comment">/* transpose inverse matrix for normals */</span>
<a name="l01344"></a>01344         <span class="keywordtype">float</span> ray_start_local[3], ray_normal_local[3];
<a name="l01345"></a>01345         <span class="keywordtype">int</span> test = 1;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, obmat);
<a name="l01348"></a>01348 
<a name="l01349"></a>01349         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(timat, imat);
<a name="l01350"></a>01350         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(timat);
<a name="l01351"></a>01351         
<a name="l01352"></a>01352         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_start_local, ray_start);
<a name="l01353"></a>01353         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_normal_local, ray_normal);
<a name="l01354"></a>01354         
<a name="l01355"></a>01355         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, ray_start_local);
<a name="l01356"></a>01356         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(imat, ray_normal_local);
<a name="l01357"></a>01357         
<a name="l01358"></a>01358         
<a name="l01359"></a>01359         <span class="comment">/* If number of vert is more than an arbitrary limit, </span>
<a name="l01360"></a>01360 <span class="comment">         * test against boundbox first</span>
<a name="l01361"></a>01361 <span class="comment">         * */</span>
<a name="l01362"></a>01362         <span class="keywordflow">if</span> (totface &gt; 16) {
<a name="l01363"></a>01363             <span class="keyword">struct </span><a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *bb = <a class="code" href="../../df/dac/BKE__object_8h.html#a06d0e9b4ebc3a7cf0f99a8916f90a851">object_get_boundbox</a>(ob);
<a name="l01364"></a>01364             test = <a class="code" href="../../df/dac/BKE__object_8h.html#a01a294585747ddb80377245d19987153">ray_hit_boundbox</a>(bb, ray_start_local, ray_normal_local);
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366         
<a name="l01367"></a>01367         <span class="keywordflow">if</span> (test == 1) {
<a name="l01368"></a>01368             
<a name="l01369"></a>01369             <span class="keywordflow">switch</span> (snap_mode)
<a name="l01370"></a>01370             {
<a name="l01371"></a>01371                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a40f93d2a2b12ccca7295d1194dfd5351">SCE_SNAP_MODE_FACE</a>:
<a name="l01372"></a>01372                 { 
<a name="l01373"></a>01373 <span class="preprocessor">#ifdef USE_BVH_FACE_SNAP                // Added for durian</span>
<a name="l01374"></a>01374 <span class="preprocessor"></span>                    <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> hit;
<a name="l01375"></a>01375                     <a class="code" href="../../d2/d80/structBVHTreeFromMesh.html">BVHTreeFromMesh</a> treeData;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377                     <span class="comment">/* local scale in normal direction */</span>
<a name="l01378"></a>01378                     <span class="keywordtype">float</span> local_scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(ray_normal_local);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380                     treeData.<a class="code" href="../../d2/d80/structBVHTreeFromMesh.html#a8e682aa21240c122b33a6c47fd8d89fb">em_evil</a>= em;
<a name="l01381"></a>01381                     <a class="code" href="../../d2/d65/BKE__bvhutils_8h.html#ae7524e15c626888b530bfface6a393ae">bvhtree_from_mesh_faces</a>(&amp;treeData, dm, 0.0f, 4, 6);
<a name="l01382"></a>01382 
<a name="l01383"></a>01383                     hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = -1;
<a name="l01384"></a>01384                     hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> = *r_depth * (*r_depth == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> ? 1.0f : local_scale);
<a name="l01385"></a>01385 
<a name="l01386"></a>01386                     <span class="keywordflow">if</span> (treeData.<a class="code" href="../../d2/d80/structBVHTreeFromMesh.html#ac99e3605d29760b3752a8633e08c5970">tree</a> &amp;&amp; <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a961a896017037e95a717e06943983f44">BLI_bvhtree_ray_cast</a>(treeData.<a class="code" href="../../d2/d80/structBVHTreeFromMesh.html#ac99e3605d29760b3752a8633e08c5970">tree</a>, ray_start_local, ray_normal_local, 0.0f, &amp;hit, treeData.<a class="code" href="../../d2/d80/structBVHTreeFromMesh.html#a1df60aad3c3389c43359a2d5d9f34c85">raycast_callback</a>, &amp;treeData) != -1)
<a name="l01387"></a>01387                     {
<a name="l01388"></a>01388                         <span class="keywordflow">if</span> (hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>/local_scale &lt;= *r_depth) {
<a name="l01389"></a>01389                             *r_depth= hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>/local_scale;
<a name="l01390"></a>01390                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(r_loc, hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a09784a75454e77df7414ef1c47582bda">co</a>);
<a name="l01391"></a>01391                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(r_no, hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#ac70dc405955f2cbc18e60f2df021e673">no</a>);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393                             <span class="comment">/* back to worldspace */</span>
<a name="l01394"></a>01394                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, r_loc);
<a name="l01395"></a>01395                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(r_no, hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#ac70dc405955f2cbc18e60f2df021e673">no</a>);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, r_no);
<a name="l01398"></a>01398                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_no);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400                             retval |= 1;
<a name="l01401"></a>01401                         }
<a name="l01402"></a>01402                     }
<a name="l01403"></a>01403                     <span class="keywordflow">break</span>;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 <span class="preprocessor">#else</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span>                    <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01407"></a>01407                     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *faces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01408"></a>01408                     <span class="keywordtype">int</span> *index_array = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01409"></a>01409                     <span class="keywordtype">int</span> index = 0;
<a name="l01410"></a>01410                     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01411"></a>01411                     
<a name="l01412"></a>01412                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01413"></a>01413                     {
<a name="l01414"></a>01414                         index_array = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01415"></a>01415                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aa97a3443500c36b7a92a1e2970370561">EDBM_index_arrays_init</a>(em, 0, 0, 1);
<a name="l01416"></a>01416                     }
<a name="l01417"></a>01417                     
<a name="l01418"></a>01418                     <span class="keywordflow">for</span> ( i = 0; i &lt; totface; i++) {
<a name="l01419"></a>01419                         <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *efa = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01420"></a>01420                         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = faces + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01421"></a>01421                         
<a name="l01422"></a>01422                         test = 1; <span class="comment">/* reset for every face */</span>
<a name="l01423"></a>01423                     
<a name="l01424"></a>01424                         <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01425"></a>01425                         {
<a name="l01426"></a>01426                             <span class="keywordflow">if</span> (index_array) {
<a name="l01427"></a>01427                                 index = index_array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01428"></a>01428                             }
<a name="l01429"></a>01429                             <span class="keywordflow">else</span> {
<a name="l01430"></a>01430                                 index = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01431"></a>01431                             }
<a name="l01432"></a>01432                             
<a name="l01433"></a>01433                             <span class="keywordflow">if</span> (index == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9c45061d42a9d82ed1a425e2b997c200">ORIGINDEX_NONE</a>) {
<a name="l01434"></a>01434                                 test = 0;
<a name="l01435"></a>01435                             }
<a name="l01436"></a>01436                             <span class="keywordflow">else</span> {
<a name="l01437"></a>01437                                 efa = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a79834f648f43a4b01046a46de38fbcec">EDBM_face_at_index</a>(em, index);
<a name="l01438"></a>01438                                 
<a name="l01439"></a>01439                                 <span class="keywordflow">if</span> (efa &amp;&amp; <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(efa, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a0f4942a13726e12780bb5a0c07219953">BM_ELEM_HIDDEN</a>))
<a name="l01440"></a>01440                                 {
<a name="l01441"></a>01441                                     test = 0;
<a name="l01442"></a>01442                                 }
<a name="l01443"></a>01443                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (efa) {
<a name="l01444"></a>01444                                     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l01445"></a>01445                                     <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l;
<a name="l01446"></a>01446                                     
<a name="l01447"></a>01447                                     l = <a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#aba8c82365003c5fcbb34bbcb4e50f8f6" title="Iterator New.">BM_iter_new</a>(&amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1faf52ecdfb30814f26ead38881b29c7375">BM_LOOPS_OF_FACE</a>, efa);
<a name="l01448"></a>01448                                     <span class="keywordflow">for</span> ( ; l; l=<a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#a0fc839bb30650592541b47e20669a995" title="Iterator Step.">BM_iter_step</a>(&amp;iter)) {
<a name="l01449"></a>01449                                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(l-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a2da088cf339e17dafd9f5e7ee0bf3771">v</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a6afc5d1391fd30b47036817b139a85ed">BM_ELEM_SELECT</a>)) {
<a name="l01450"></a>01450                                             test = 0;
<a name="l01451"></a>01451                                             <span class="keywordflow">break</span>;
<a name="l01452"></a>01452                                         }
<a name="l01453"></a>01453                                     }
<a name="l01454"></a>01454                                 }
<a name="l01455"></a>01455                             }
<a name="l01456"></a>01456                         }
<a name="l01457"></a>01457                         
<a name="l01458"></a>01458                         
<a name="l01459"></a>01459                         <span class="keywordflow">if</span> (test)
<a name="l01460"></a>01460                         {
<a name="l01461"></a>01461                             <span class="keywordtype">int</span> result;
<a name="l01462"></a>01462                             <span class="keywordtype">float</span> *v4co = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01463"></a>01463                             
<a name="l01464"></a>01464                             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01465"></a>01465                             {
<a name="l01466"></a>01466                                 v4co = verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01467"></a>01467                             }
<a name="l01468"></a>01468                             
<a name="l01469"></a>01469                             result = snapFace(ar, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v4co, mval, ray_start, ray_start_local, ray_normal_local, obmat, timat, loc, no, dist, depth);
<a name="l01470"></a>01470                             retval |= result;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472                             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; result == 0)
<a name="l01473"></a>01473                             {
<a name="l01474"></a>01474                                 retval |= snapFace(ar, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mval, ray_start, ray_start_local, ray_normal_local, obmat, timat, loc, no, dist, depth);
<a name="l01475"></a>01475                             }
<a name="l01476"></a>01476                         }
<a name="l01477"></a>01477                     }
<a name="l01478"></a>01478                     
<a name="l01479"></a>01479                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01480"></a>01480                     {
<a name="l01481"></a>01481                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ade6a9b6920d5141b0102b60995a5b91f">EDBM_index_arrays_free</a>(em);
<a name="l01482"></a>01482                     }
<a name="l01483"></a>01483 <span class="preprocessor">#endif</span>
<a name="l01484"></a>01484 <span class="preprocessor"></span>                    <span class="keywordflow">break</span>;
<a name="l01485"></a>01485                 }
<a name="l01486"></a>01486                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad013bec1ba6895fc29378822742d2359">SCE_SNAP_MODE_VERTEX</a>:
<a name="l01487"></a>01487                 {
<a name="l01488"></a>01488                     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01489"></a>01489                     <span class="keywordtype">int</span> *index_array = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01490"></a>01490                     <span class="keywordtype">int</span> index = 0;
<a name="l01491"></a>01491                     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01492"></a>01492                     
<a name="l01493"></a>01493                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01494"></a>01494                     {
<a name="l01495"></a>01495                         index_array = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01496"></a>01496                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aa97a3443500c36b7a92a1e2970370561">EDBM_index_arrays_init</a>(em, 1, 0, 0);
<a name="l01497"></a>01497                     }
<a name="l01498"></a>01498                     
<a name="l01499"></a>01499                     <span class="keywordflow">for</span> ( i = 0; i &lt; totvert; i++) {
<a name="l01500"></a>01500                         <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01501"></a>01501                         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v = verts + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01502"></a>01502                         
<a name="l01503"></a>01503                         test = 1; <span class="comment">/* reset for every vert */</span>
<a name="l01504"></a>01504                     
<a name="l01505"></a>01505                         <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01506"></a>01506                             <span class="keywordflow">if</span> (index_array) {
<a name="l01507"></a>01507                                 index = index_array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01508"></a>01508                             }
<a name="l01509"></a>01509                             <span class="keywordflow">else</span> {
<a name="l01510"></a>01510                                 index = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01511"></a>01511                             }
<a name="l01512"></a>01512                             
<a name="l01513"></a>01513                             <span class="keywordflow">if</span> (index == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9c45061d42a9d82ed1a425e2b997c200">ORIGINDEX_NONE</a>) {
<a name="l01514"></a>01514                                 test = 0;
<a name="l01515"></a>01515                             }
<a name="l01516"></a>01516                             <span class="keywordflow">else</span> {
<a name="l01517"></a>01517                                 eve = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a63e064e5e9c88cbdb131a3c55d1e6c26">EDBM_vert_at_index</a>(em, index);
<a name="l01518"></a>01518                                 
<a name="l01519"></a>01519                                 <span class="keywordflow">if</span> (eve &amp;&amp; (<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(eve, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a0f4942a13726e12780bb5a0c07219953">BM_ELEM_HIDDEN</a>) || <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(eve, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a6afc5d1391fd30b47036817b139a85ed">BM_ELEM_SELECT</a>)))
<a name="l01520"></a>01520                                 {
<a name="l01521"></a>01521                                     test = 0;
<a name="l01522"></a>01522                                 }
<a name="l01523"></a>01523                             }
<a name="l01524"></a>01524                         }
<a name="l01525"></a>01525                         
<a name="l01526"></a>01526                         
<a name="l01527"></a>01527                         <span class="keywordflow">if</span> (test)
<a name="l01528"></a>01528                         {
<a name="l01529"></a>01529                             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a2824f8d785ac6dc2ef8b161022bebd6a">snapVertex</a>(ar, v-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>, obmat, timat, ray_start, ray_start_local, ray_normal_local, mval, r_loc, r_no, r_dist, r_depth);
<a name="l01530"></a>01530                         }
<a name="l01531"></a>01531                     }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01534"></a>01534                     {
<a name="l01535"></a>01535                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ade6a9b6920d5141b0102b60995a5b91f">EDBM_index_arrays_free</a>(em);
<a name="l01536"></a>01536                     }
<a name="l01537"></a>01537                     <span class="keywordflow">break</span>;
<a name="l01538"></a>01538                 }
<a name="l01539"></a>01539                 <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aeb9874bea7be38ad81fbe2e200f93dff">SCE_SNAP_MODE_EDGE</a>:
<a name="l01540"></a>01540                 {
<a name="l01541"></a>01541                     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01542"></a>01542                     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *edges = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5b98f2e9b75d92be2854b7ab25e5521">getEdgeArray</a>(dm);
<a name="l01543"></a>01543                     <span class="keywordtype">int</span> totedge = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm);
<a name="l01544"></a>01544                     <span class="keywordtype">int</span> *index_array = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01545"></a>01545                     <span class="keywordtype">int</span> index = 0;
<a name="l01546"></a>01546                     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01547"></a>01547                     
<a name="l01548"></a>01548                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01549"></a>01549                     {
<a name="l01550"></a>01550                         index_array = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9afc810992214e6dac919ab7a522bd0a">getEdgeDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01551"></a>01551                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aa97a3443500c36b7a92a1e2970370561">EDBM_index_arrays_init</a>(em, 0, 1, 0);
<a name="l01552"></a>01552                     }
<a name="l01553"></a>01553                     
<a name="l01554"></a>01554                     <span class="keywordflow">for</span> ( i = 0; i &lt; totedge; i++) {
<a name="l01555"></a>01555                         <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *eed = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01556"></a>01556                         <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *e = edges + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01557"></a>01557                         
<a name="l01558"></a>01558                         test = 1; <span class="comment">/* reset for every vert */</span>
<a name="l01559"></a>01559                     
<a name="l01560"></a>01560                         <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01561"></a>01561                         {
<a name="l01562"></a>01562                             <span class="keywordflow">if</span> (index_array) {
<a name="l01563"></a>01563                                 index = index_array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01564"></a>01564                             }
<a name="l01565"></a>01565                             <span class="keywordflow">else</span> {
<a name="l01566"></a>01566                                 index = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01567"></a>01567                             }
<a name="l01568"></a>01568                             
<a name="l01569"></a>01569                             <span class="keywordflow">if</span> (index == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9c45061d42a9d82ed1a425e2b997c200">ORIGINDEX_NONE</a>) {
<a name="l01570"></a>01570                                 test = 0;
<a name="l01571"></a>01571                             }
<a name="l01572"></a>01572                             <span class="keywordflow">else</span> {
<a name="l01573"></a>01573                                 eed = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a84b498997c52686a55d7ea755d1e6bc3">EDBM_edge_at_index</a>(em, index);
<a name="l01574"></a>01574                                 
<a name="l01575"></a>01575                                 <span class="keywordflow">if</span> (eed &amp;&amp; (<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(eed, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a0f4942a13726e12780bb5a0c07219953">BM_ELEM_HIDDEN</a>) ||
<a name="l01576"></a>01576                                     <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(eed-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab6378c5ea7e85917c389a1dfdff790ea">v1</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a6afc5d1391fd30b47036817b139a85ed">BM_ELEM_SELECT</a>) || 
<a name="l01577"></a>01577                                     <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a94748f531b63177f476a182c01fb43b1">BM_elem_flag_test</a>(eed-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#a00090f09abd0ef12bcf279cb0c41c0ca">v2</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a6afc5d1391fd30b47036817b139a85ed">BM_ELEM_SELECT</a>)))
<a name="l01578"></a>01578                                 {
<a name="l01579"></a>01579                                     test = 0;
<a name="l01580"></a>01580                                 }
<a name="l01581"></a>01581                             }
<a name="l01582"></a>01582                         }
<a name="l01583"></a>01583                         
<a name="l01584"></a>01584                         
<a name="l01585"></a>01585                         <span class="keywordflow">if</span> (test)
<a name="l01586"></a>01586                         {
<a name="l01587"></a>01587                             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#af9af37c670730220675d8b03b9fb98e0">snapEdge</a>(ar, verts[e-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[e-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>, verts[e-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[e-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>, obmat, timat, ray_start, ray_start_local, ray_normal_local, mval, r_loc, r_no, r_dist, r_depth);
<a name="l01588"></a>01588                         }
<a name="l01589"></a>01589                     }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591                     <span class="keywordflow">if</span> (em != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01592"></a>01592                     {
<a name="l01593"></a>01593                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ade6a9b6920d5141b0102b60995a5b91f">EDBM_index_arrays_free</a>(em);
<a name="l01594"></a>01594                     }
<a name="l01595"></a>01595                     <span class="keywordflow">break</span>;
<a name="l01596"></a>01596                 }
<a name="l01597"></a>01597             }
<a name="l01598"></a>01598         }
<a name="l01599"></a>01599     }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="keywordflow">return</span> retval;
<a name="l01602"></a>01602 } 
<a name="l01603"></a>01603 
<a name="l01604"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">01604</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">snapObject</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> editobject, <span class="keywordtype">float</span> obmat[][4],
<a name="l01605"></a>01605                       <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal[3], <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01606"></a>01606                       <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> *r_depth)
<a name="l01607"></a>01607 {
<a name="l01608"></a>01608     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l01609"></a>01609     <span class="keywordtype">int</span> retval = 0;
<a name="l01610"></a>01610     
<a name="l01611"></a>01611     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01612"></a>01612         <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em;
<a name="l01613"></a>01613         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l01614"></a>01614         
<a name="l01615"></a>01615         <span class="keywordflow">if</span> (editobject) {
<a name="l01616"></a>01616             em = <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(ob);
<a name="l01617"></a>01617             <span class="comment">/* dm = editbmesh_get_derived_cage(scene, ob, em, CD_MASK_BAREMESH); */</span>
<a name="l01618"></a>01618             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad219e8b9311146ba070bcd1e98622a1d">editbmesh_get_derived_base</a>(ob, em); <span class="comment">/* limitation, em &amp; dm MUST have the same number of faces */</span>
<a name="l01619"></a>01619         }
<a name="l01620"></a>01620         <span class="keywordflow">else</span> {
<a name="l01621"></a>01621             em = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01622"></a>01622             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01623"></a>01623         }
<a name="l01624"></a>01624         
<a name="l01625"></a>01625         retval = <a class="code" href="../../df/dfc/transform__snap_8c.html#aa20043177d148e9d2de0ce4fa79352f5">snapDerivedMesh</a>(ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a949506996d3839db0ad369c30374fa6a">snap_mode</a>, ar, ob, dm, em, obmat, ray_start, ray_normal, mval, r_loc, r_no, r_dist, r_depth);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01628"></a>01628     }
<a name="l01629"></a>01629     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) {
<a name="l01630"></a>01630         retval = <a class="code" href="../../df/dfc/transform__snap_8c.html#a2f924b23896d41023dfe3ead0a9f6519">snapArmature</a>(ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a949506996d3839db0ad369c30374fa6a">snap_mode</a>, ar, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, obmat, ray_start, ray_normal, mval, r_loc, r_no, r_dist, r_depth);
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632     
<a name="l01633"></a>01633     <span class="keywordflow">return</span> retval;
<a name="l01634"></a>01634 }
<a name="l01635"></a>01635 
<a name="l01636"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a28e40047df0af5d5677d0180d191a525">01636</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a28e40047df0af5d5677d0180d191a525">snapObjects</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l01637"></a>01637                        <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01638"></a>01638 {
<a name="l01639"></a>01639     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l01640"></a>01640     <span class="keywordtype">float</span> depth = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l01641"></a>01641     <span class="keywordtype">int</span> retval = 0;
<a name="l01642"></a>01642     <span class="keywordtype">float</span> ray_start[3], ray_normal[3];
<a name="l01643"></a>01643     
<a name="l01644"></a>01644     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a5b0879983400f47e848161769a969367">ED_view3d_win_to_ray</a>(ar, v3d, mval, ray_start, ray_normal);
<a name="l01645"></a>01645 
<a name="l01646"></a>01646     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6ac561f86496b884c472e17aed3938496a">SNAP_ALL</a> &amp;&amp; obedit) {
<a name="l01647"></a>01647         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = obedit;
<a name="l01648"></a>01648 
<a name="l01649"></a>01649         retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">snapObject</a>(scene, ar, ob, 1, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, r_loc, r_no, r_dist, &amp;depth);
<a name="l01650"></a>01650     }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652     <span class="comment">/* Need an exception for particle edit because the base is flagged with BA_HAS_RECALC_DATA</span>
<a name="l01653"></a>01653 <span class="comment">     * which makes the loop skip it, even the derived mesh will never change</span>
<a name="l01654"></a>01654 <span class="comment">     *</span>
<a name="l01655"></a>01655 <span class="comment">     * To solve that problem, we do it first as an exception. </span>
<a name="l01656"></a>01656 <span class="comment">     * */</span>
<a name="l01657"></a>01657     base= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a>;
<a name="l01658"></a>01658     <span class="keywordflow">if</span> (base &amp;&amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> &amp;&amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a20027b5f4381f062402af134bcefe889">OB_MODE_PARTICLE_EDIT</a>) {
<a name="l01659"></a>01659         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l01660"></a>01660         retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">snapObject</a>(scene, ar, ob, 0, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, r_loc, r_no, r_dist, &amp;depth);
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="keywordflow">for</span> ( base = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8e4d7097454ad5b3dfde455bf35b6450">FIRSTBASE</a>; base != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a> ) {
<a name="l01664"></a>01664         <span class="keywordflow">if</span> ( (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aff2236024b04121faf34e7b829cfd81d">BASE_VISIBLE</a>(v3d, base)) &amp;&amp;
<a name="l01665"></a>01665              (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; (<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a4b034936ce7db58d3fe8d26de6d2d18d">BA_HAS_RECALC_OB</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a22f3a5a4c8436ea6892a7ebd1e8f3a56">BA_HAS_RECALC_DATA</a>)) == 0 &amp;&amp;
<a name="l01666"></a>01666 
<a name="l01667"></a>01667              (  (mode == <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a176ad989ffd3255e4b46fc34d7d81de3">SNAP_NOT_SELECTED</a> &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; (<a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#abd8be106ef4ef20b1be3b4532e8f7397">BA_WAS_SEL</a>)) == 0) ||
<a name="l01668"></a>01668                 (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(mode, <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6ac561f86496b884c472e17aed3938496a">SNAP_ALL</a>, <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a5e7183a683a758ffbf9f90f7a9c8453d">SNAP_NOT_OBEDIT</a>) &amp;&amp; base != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a71a9117cf3b8db805eb031926bff279a">BASACT</a>))  )
<a name="l01669"></a>01669         {
<a name="l01670"></a>01670             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l01671"></a>01671             
<a name="l01672"></a>01672             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l01673"></a>01673                 <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dupli_ob;
<a name="l01674"></a>01674                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(scene, ob);
<a name="l01675"></a>01675                 
<a name="l01676"></a>01676                 <span class="keywordflow">for</span> (dupli_ob = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dupli_ob; dupli_ob = dupli_ob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>)
<a name="l01677"></a>01677                 {
<a name="l01678"></a>01678                     <a class="code" href="../../de/de7/structObject.html">Object</a> *dob = dupli_ob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>;
<a name="l01679"></a>01679                     
<a name="l01680"></a>01680                     retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">snapObject</a>(scene, ar, dob, 0, dupli_ob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>, ray_start, ray_normal, mval, r_loc, r_no, r_dist, &amp;depth);
<a name="l01681"></a>01681                 }
<a name="l01682"></a>01682                 
<a name="l01683"></a>01683                 <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb);
<a name="l01684"></a>01684             }
<a name="l01685"></a>01685             
<a name="l01686"></a>01686             retval |= <a class="code" href="../../df/dfc/transform__snap_8c.html#a776cca115268a43dbac3d9912f33abd7">snapObject</a>(scene, ar, ob, 0, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, r_loc, r_no, r_dist, &amp;depth);
<a name="l01687"></a>01687         }
<a name="l01688"></a>01688     }
<a name="l01689"></a>01689     
<a name="l01690"></a>01690     <span class="keywordflow">return</span> retval;
<a name="l01691"></a>01691 }
<a name="l01692"></a>01692 
<a name="l01693"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a94972717cbf2b715b9fb6c4aadde62dd">01693</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#a3b77e32e5b612263713c027cb1935c3c">snapObjectsTransform</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01694"></a>01694 {
<a name="l01695"></a>01695     <span class="keywordflow">return</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a28e40047df0af5d5677d0180d191a525">snapObjects</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#adb9e829dc854299fef6de4fe815fca8f">scene</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a1ba2869af8ef8e20c97973db7e77c3a8">view</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#abc0cd6ba2b602243fcbdee0a4f77e3b3">ar</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>, mval, r_dist, r_loc, r_no, mode);
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a99a542f706d983f473b00c826d0db8e3">01698</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#aa21730b18d1d1c696f950521e9138511">snapObjectsContext</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <span class="keywordtype">int</span> *r_dist, <span class="keywordtype">float</span> r_loc[3], <span class="keywordtype">float</span> r_no[3], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01699"></a>01699 {
<a name="l01700"></a>01700     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa = <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l01701"></a>01701     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="keywordflow">return</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a28e40047df0af5d5677d0180d191a525">snapObjects</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C), v3d, <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C), mval, r_dist, r_loc, r_no, mode);
<a name="l01704"></a>01704 }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706 <span class="comment">/******************** PEELING *********************************/</span>
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 
<a name="l01709"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a25fb8746c6f8320aea9f86b98aa773f7">01709</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a25fb8746c6f8320aea9f86b98aa773f7">cmpPeel</a>(<span class="keywordtype">void</span> *arg1, <span class="keywordtype">void</span> *arg2)
<a name="l01710"></a>01710 {
<a name="l01711"></a>01711     <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *p1 = arg1;
<a name="l01712"></a>01712     <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *p2 = arg2;
<a name="l01713"></a>01713     <span class="keywordtype">int</span> val = 0;
<a name="l01714"></a>01714     
<a name="l01715"></a>01715     <span class="keywordflow">if</span> (p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a> &lt; p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a>) {
<a name="l01716"></a>01716         val = -1;
<a name="l01717"></a>01717     }
<a name="l01718"></a>01718     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p1-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a> &gt; p2-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a>) {
<a name="l01719"></a>01719         val = 1;
<a name="l01720"></a>01720     }
<a name="l01721"></a>01721     
<a name="l01722"></a>01722     <span class="keywordflow">return</span> val;
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#ae181a5f74b6f85e4deaf37e2b772c4ba">01725</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#ae181a5f74b6f85e4deaf37e2b772c4ba">removeDoublesPeel</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels)
<a name="l01726"></a>01726 {
<a name="l01727"></a>01727     <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *peel;
<a name="l01728"></a>01728     
<a name="l01729"></a>01729     <span class="keywordflow">for</span> (peel = depth_peels-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; peel; peel = peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>)
<a name="l01730"></a>01730     {
<a name="l01731"></a>01731         <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *next_peel = peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733         <span class="keywordflow">if</span> (next_peel &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a> - next_peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a>) &lt; 0.0015f) {
<a name="l01734"></a>01734             peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a> = next_peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>;
<a name="l01735"></a>01735             
<a name="l01736"></a>01736             <span class="keywordflow">if</span> (next_peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>) {
<a name="l01737"></a>01737                 next_peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3e68f22298301121d828809e34130627">next</a>-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#af03227a952e5e47396c8ea144a011607">prev</a> = peel;
<a name="l01738"></a>01738             }
<a name="l01739"></a>01739             
<a name="l01740"></a>01740             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(next_peel);
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742     }
<a name="l01743"></a>01743 }
<a name="l01744"></a>01744 
<a name="l01745"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a042d150958b46ceba7067fb1b7b671bc">01745</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a042d150958b46ceba7067fb1b7b671bc">addDepthPeel</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels, <span class="keywordtype">float</span> depth, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keywordtype">float</span> no[3], <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01746"></a>01746 {
<a name="l01747"></a>01747     <a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a> *peel = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d2e/structDepthPeel.html">DepthPeel</a>), <span class="stringliteral">&quot;DepthPeel&quot;</span>);
<a name="l01748"></a>01748     
<a name="l01749"></a>01749     peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a5077f8ba2702bbbc2ab20de0e4b167d9">depth</a> = depth;
<a name="l01750"></a>01750     peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#ab27fa26b1db7ae44426808550703698e">ob</a> = ob;
<a name="l01751"></a>01751     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a3565c05ede5e16e29fea08032e7d3d33">p</a>, p);
<a name="l01752"></a>01752     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#af7bc3b49992f10675fbd63c81b3b6d4f">no</a>, no);
<a name="l01753"></a>01753     
<a name="l01754"></a>01754     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(depth_peels, peel);
<a name="l01755"></a>01755     
<a name="l01756"></a>01756     peel-&gt;<a class="code" href="../../dd/d2e/structDepthPeel.html#a10d3b8cfc94a991db14d0b08fb11170c">flag</a> = 0;
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01759"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">01759</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">peelDerivedMesh</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">float</span> obmat[][4],
<a name="l01760"></a>01760                            <span class="keyword">const</span> <span class="keywordtype">float</span> ray_start[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ray_normal[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(mval[2]),
<a name="l01761"></a>01761                            <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763     <span class="keywordtype">int</span> retval = 0;
<a name="l01764"></a>01764     <span class="keywordtype">int</span> totvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01765"></a>01765     <span class="keywordtype">int</span> totface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01766"></a>01766     
<a name="l01767"></a>01767     <span class="keywordflow">if</span> (totvert &gt; 0) {
<a name="l01768"></a>01768         <span class="keywordtype">float</span> imat[4][4];
<a name="l01769"></a>01769         <span class="keywordtype">float</span> timat[3][3]; <span class="comment">/* transpose inverse matrix for normals */</span>
<a name="l01770"></a>01770         <span class="keywordtype">float</span> ray_start_local[3], ray_normal_local[3];
<a name="l01771"></a>01771         <span class="keywordtype">int</span> test = 1;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, obmat);
<a name="l01774"></a>01774 
<a name="l01775"></a>01775         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(timat, imat);
<a name="l01776"></a>01776         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(timat);
<a name="l01777"></a>01777         
<a name="l01778"></a>01778         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_start_local, ray_start);
<a name="l01779"></a>01779         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ray_normal_local, ray_normal);
<a name="l01780"></a>01780         
<a name="l01781"></a>01781         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, ray_start_local);
<a name="l01782"></a>01782         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(imat, ray_normal_local);
<a name="l01783"></a>01783         
<a name="l01784"></a>01784         
<a name="l01785"></a>01785         <span class="comment">/* If number of vert is more than an arbitrary limit, </span>
<a name="l01786"></a>01786 <span class="comment">         * test against boundbox first</span>
<a name="l01787"></a>01787 <span class="comment">         * */</span>
<a name="l01788"></a>01788         <span class="keywordflow">if</span> (totface &gt; 16) {
<a name="l01789"></a>01789             <span class="keyword">struct </span><a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *bb = <a class="code" href="../../df/dac/BKE__object_8h.html#a06d0e9b4ebc3a7cf0f99a8916f90a851">object_get_boundbox</a>(ob);
<a name="l01790"></a>01790             test = <a class="code" href="../../df/dac/BKE__object_8h.html#a01a294585747ddb80377245d19987153">ray_hit_boundbox</a>(bb, ray_start_local, ray_normal_local);
<a name="l01791"></a>01791         }
<a name="l01792"></a>01792         
<a name="l01793"></a>01793         <span class="keywordflow">if</span> (test == 1) {
<a name="l01794"></a>01794             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01795"></a>01795             <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *faces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01796"></a>01796             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01797"></a>01797             
<a name="l01798"></a>01798             <span class="keywordflow">for</span> ( i = 0; i &lt; totface; i++) {
<a name="l01799"></a>01799                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = faces + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01800"></a>01800                 <span class="keywordtype">float</span> lambda;
<a name="l01801"></a>01801                 <span class="keywordtype">int</span> result;
<a name="l01802"></a>01802                 
<a name="l01803"></a>01803                 
<a name="l01804"></a>01804                 result = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8c89d506d78d26912d4f29deb9d11588">isect_ray_tri_threshold_v3</a>(ray_start_local, ray_normal_local, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, &amp;lambda, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.001);
<a name="l01805"></a>01805                 
<a name="l01806"></a>01806                 <span class="keywordflow">if</span> (result) {
<a name="l01807"></a>01807                     <span class="keywordtype">float</span> location[3], normal[3];
<a name="l01808"></a>01808                     <span class="keywordtype">float</span> intersect[3];
<a name="l01809"></a>01809                     <span class="keywordtype">float</span> new_depth;
<a name="l01810"></a>01810                     
<a name="l01811"></a>01811                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(intersect, ray_normal_local);
<a name="l01812"></a>01812                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(intersect, lambda);
<a name="l01813"></a>01813                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(intersect, ray_start_local);
<a name="l01814"></a>01814                     
<a name="l01815"></a>01815                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(location, intersect);
<a name="l01816"></a>01816                     
<a name="l01817"></a>01817                     <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01818"></a>01818                         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( normal,verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01819"></a>01819                     <span class="keywordflow">else</span>
<a name="l01820"></a>01820                         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( normal,verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01821"></a>01821 
<a name="l01822"></a>01822                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, location);
<a name="l01823"></a>01823                     
<a name="l01824"></a>01824                     new_depth = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(location, ray_start);                  
<a name="l01825"></a>01825                     
<a name="l01826"></a>01826                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, normal);
<a name="l01827"></a>01827                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(normal);
<a name="l01828"></a>01828 
<a name="l01829"></a>01829                     <a class="code" href="../../df/dfc/transform__snap_8c.html#a042d150958b46ceba7067fb1b7b671bc">addDepthPeel</a>(depth_peels, new_depth, location, normal, ob);
<a name="l01830"></a>01830                 }
<a name="l01831"></a>01831         
<a name="l01832"></a>01832                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; result == 0) {
<a name="l01833"></a>01833                     result = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8c89d506d78d26912d4f29deb9d11588">isect_ray_tri_threshold_v3</a>(ray_start_local, ray_normal_local, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, &amp;lambda, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.001);
<a name="l01834"></a>01834                     
<a name="l01835"></a>01835                     <span class="keywordflow">if</span> (result) {
<a name="l01836"></a>01836                         <span class="keywordtype">float</span> location[3], normal[3];
<a name="l01837"></a>01837                         <span class="keywordtype">float</span> intersect[3];
<a name="l01838"></a>01838                         <span class="keywordtype">float</span> new_depth;
<a name="l01839"></a>01839                         
<a name="l01840"></a>01840                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(intersect, ray_normal_local);
<a name="l01841"></a>01841                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(intersect, lambda);
<a name="l01842"></a>01842                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(intersect, ray_start_local);
<a name="l01843"></a>01843                         
<a name="l01844"></a>01844                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(location, intersect);
<a name="l01845"></a>01845                         
<a name="l01846"></a>01846                         <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01847"></a>01847                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( normal,verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01848"></a>01848                         <span class="keywordflow">else</span>
<a name="l01849"></a>01849                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( normal,verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, verts[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01850"></a>01850 
<a name="l01851"></a>01851                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obmat, location);
<a name="l01852"></a>01852                         
<a name="l01853"></a>01853                         new_depth = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(location, ray_start);                  
<a name="l01854"></a>01854                         
<a name="l01855"></a>01855                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(timat, normal);
<a name="l01856"></a>01856                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(normal);
<a name="l01857"></a>01857     
<a name="l01858"></a>01858                         <a class="code" href="../../df/dfc/transform__snap_8c.html#a042d150958b46ceba7067fb1b7b671bc">addDepthPeel</a>(depth_peels, new_depth, location, normal, ob);
<a name="l01859"></a>01859                     } 
<a name="l01860"></a>01860                 }
<a name="l01861"></a>01861             }
<a name="l01862"></a>01862         }
<a name="l01863"></a>01863     }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <span class="keywordflow">return</span> retval;
<a name="l01866"></a>01866 } 
<a name="l01867"></a>01867 
<a name="l01868"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a15df1ee02f3f736c5d2ed07c33f49708">01868</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a15df1ee02f3f736c5d2ed07c33f49708">peelObjects</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01869"></a>01869 {
<a name="l01870"></a>01870     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l01871"></a>01871     <span class="keywordtype">int</span> retval = 0;
<a name="l01872"></a>01872     <span class="keywordtype">float</span> ray_start[3], ray_normal[3];
<a name="l01873"></a>01873     
<a name="l01874"></a>01874     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a5b0879983400f47e848161769a969367">ED_view3d_win_to_ray</a>(ar, v3d, mval, ray_start, ray_normal);
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l01877"></a>01877         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af4d876834a14c05afefb98c69828d366">BASE_SELECTABLE</a>(v3d, base)) {
<a name="l01878"></a>01878             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l01879"></a>01879 
<a name="l01880"></a>01880             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l01881"></a>01881                 <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dupli_ob;
<a name="l01882"></a>01882                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(scene, ob);
<a name="l01883"></a>01883                 
<a name="l01884"></a>01884                 <span class="keywordflow">for</span> (dupli_ob = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dupli_ob; dupli_ob = dupli_ob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>)
<a name="l01885"></a>01885                 {
<a name="l01886"></a>01886                     <a class="code" href="../../de/de7/structObject.html">Object</a> *dob = dupli_ob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>;
<a name="l01887"></a>01887                     
<a name="l01888"></a>01888                     <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01889"></a>01889                         <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em;
<a name="l01890"></a>01890                         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01891"></a>01891                         <span class="keywordtype">int</span> val;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893                         <span class="keywordflow">if</span> (dob != obedit) {
<a name="l01894"></a>01894                             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, dob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01895"></a>01895                             
<a name="l01896"></a>01896                             val = <a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">peelDerivedMesh</a>(dob, dm, dob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, depth_peels);
<a name="l01897"></a>01897                         }
<a name="l01898"></a>01898                         <span class="keywordflow">else</span> {
<a name="l01899"></a>01899                             em = <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(dob);
<a name="l01900"></a>01900                             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aadc7033561fddea210085209cea4dfa1">editbmesh_get_derived_cage</a>(scene, obedit, em, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01901"></a>01901                             
<a name="l01902"></a>01902                             val = <a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">peelDerivedMesh</a>(dob, dm, dob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, depth_peels);
<a name="l01903"></a>01903                         }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905                         retval = retval || val;
<a name="l01906"></a>01906                         
<a name="l01907"></a>01907                         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01908"></a>01908                     }
<a name="l01909"></a>01909                 }
<a name="l01910"></a>01910                 
<a name="l01911"></a>01911                 <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb);
<a name="l01912"></a>01912             }
<a name="l01913"></a>01913             
<a name="l01914"></a>01914             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01915"></a>01915                 <span class="keywordtype">int</span> val = 0;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917                 <span class="keywordflow">if</span> (ob != obedit &amp;&amp; ((mode == <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a176ad989ffd3255e4b46fc34d7d81de3">SNAP_NOT_SELECTED</a> &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; (<a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#abd8be106ef4ef20b1be3b4532e8f7397">BA_WAS_SEL</a>)) == 0) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(mode, <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6ac561f86496b884c472e17aed3938496a">SNAP_ALL</a>, <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a5e7183a683a758ffbf9f90f7a9c8453d">SNAP_NOT_OBEDIT</a>))) {
<a name="l01918"></a>01918                     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01919"></a>01919                     
<a name="l01920"></a>01920                     val = <a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">peelDerivedMesh</a>(ob, dm, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, depth_peels);
<a name="l01921"></a>01921                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01922"></a>01922                 }
<a name="l01923"></a>01923                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob == obedit &amp;&amp; mode != <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6a5e7183a683a758ffbf9f90f7a9c8453d">SNAP_NOT_OBEDIT</a>) {
<a name="l01924"></a>01924                     <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em = <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(ob);
<a name="l01925"></a>01925                     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aadc7033561fddea210085209cea4dfa1">editbmesh_get_derived_cage</a>(scene, obedit, em, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01926"></a>01926                     
<a name="l01927"></a>01927                     val = <a class="code" href="../../df/dfc/transform__snap_8c.html#add40938f5939b23dd998912f8d313d4a">peelDerivedMesh</a>(ob, dm, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, ray_start, ray_normal, mval, depth_peels);
<a name="l01928"></a>01928                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01929"></a>01929                 }
<a name="l01930"></a>01930                     
<a name="l01931"></a>01931                 retval = retval || val;
<a name="l01932"></a>01932                 
<a name="l01933"></a>01933             }
<a name="l01934"></a>01934         }
<a name="l01935"></a>01935     }
<a name="l01936"></a>01936     
<a name="l01937"></a>01937     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa842d1a72dc3dc49faa64be1b066797a">BLI_sortlist</a>(depth_peels, <a class="code" href="../../df/dfc/transform__snap_8c.html#a25fb8746c6f8320aea9f86b98aa773f7">cmpPeel</a>);
<a name="l01938"></a>01938     <a class="code" href="../../df/dfc/transform__snap_8c.html#ae181a5f74b6f85e4deaf37e2b772c4ba">removeDoublesPeel</a>(depth_peels);
<a name="l01939"></a>01939     
<a name="l01940"></a>01940     <span class="keywordflow">return</span> retval;
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a43453e7f3db2b8d9f26f45f13ad90870">01943</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#a2b429ac137ee95a3ff5466ee85464f17">peelObjectsTransForm</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01944"></a>01944 {
<a name="l01945"></a>01945     <span class="keywordflow">return</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a15df1ee02f3f736c5d2ed07c33f49708">peelObjects</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#adb9e829dc854299fef6de4fe815fca8f">scene</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a1ba2869af8ef8e20c97973db7e77c3a8">view</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#abc0cd6ba2b602243fcbdee0a4f77e3b3">ar</a>, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a391b0d885429735b87c73369c9fd068d">obedit</a>, depth_peels, mval, mode);
<a name="l01946"></a>01946 }
<a name="l01947"></a>01947 
<a name="l01948"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a596728a9bae9a4345eb77d6d07d31426">01948</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/df2/ED__transform_8h.html#a5e191e2e04336664acce7a6692b4056f">peelObjectsContext</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *depth_peels, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <a class="code" href="../../d8/df2/ED__transform_8h.html#ad6af205d4643f7a9ff2ed777d3b858f6">SnapMode</a> mode)
<a name="l01949"></a>01949 {
<a name="l01950"></a>01950     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa = <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l01951"></a>01951     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01952"></a>01952 
<a name="l01953"></a>01953     <span class="keywordflow">return</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a15df1ee02f3f736c5d2ed07c33f49708">peelObjects</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C), v3d, <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C), depth_peels, mval, mode);
<a name="l01954"></a>01954 }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956 <span class="comment">/*================================================================*/</span>
<a name="l01957"></a>01957 
<a name="l01958"></a>01958 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a8927f7b843b7b2e46b15c0200628dfb4">applyGrid</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *val, <span class="keywordtype">int</span> max_index, <span class="keywordtype">float</span> fac[3], <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efd">GearsType</a> action);
<a name="l01959"></a>01959 
<a name="l01960"></a>01960 
<a name="l01961"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a5ae0f08d5e92b014ee45716e3d1ce322">01961</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#a5ae0f08d5e92b014ee45716e3d1ce322">snapGridAction</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *val, <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efd">GearsType</a> action)
<a name="l01962"></a>01962 {
<a name="l01963"></a>01963     <span class="keywordtype">float</span> fac[3];
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     fac[<a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda8b41dc107e386de3894c87a62791e803">NO_GEARS</a>]    = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a09adad6d7b12a7a1b1df808d3915edb5">snap</a>[0];
<a name="l01966"></a>01966     fac[<a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5433fd626bd95e39ac785f372d3d2b32">BIG_GEARS</a>]   = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a09adad6d7b12a7a1b1df808d3915edb5">snap</a>[1];
<a name="l01967"></a>01967     fac[<a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5af81cf4aac019828a35e83cbee5e039">SMALL_GEARS</a>] = t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a09adad6d7b12a7a1b1df808d3915edb5">snap</a>[2];
<a name="l01968"></a>01968     
<a name="l01969"></a>01969     <a class="code" href="../../df/dfc/transform__snap_8c.html#a8927f7b843b7b2e46b15c0200628dfb4">applyGrid</a>(t, val, t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6db8bfb6453b1574dedf7ec132b9d2f0">idx_max</a>, fac, action);
<a name="l01970"></a>01970 }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 
<a name="l01973"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#ab91a317295131088f61a723357966c52">01973</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d80/transform_8h.html#ab91a317295131088f61a723357966c52">snapGrid</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *val)
<a name="l01974"></a>01974 {
<a name="l01975"></a>01975     <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efd">GearsType</a> action;
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     <span class="comment">// Only do something if using Snap to Grid</span>
<a name="l01978"></a>01978     <span class="keywordflow">if</span> (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a6b095e2878426665c2a2806a267d3c30">tsnap</a>.<a class="code" href="../../db/dff/structTransSnap.html#a780bf5053a02cb383c491a9c2beb0b7c">mode</a> != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af850ee3baef7ae11d5d983c559c47760">SCE_SNAP_MODE_INCREMENT</a>)
<a name="l01979"></a>01979         <span class="keywordflow">return</span>;
<a name="l01980"></a>01980 
<a name="l01981"></a>01981     action = <a class="code" href="../../d2/d80/transform_8h.html#a100b72df2d040fe428a40fd71c0e2e8b">activeSnap</a>(t) ? <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5433fd626bd95e39ac785f372d3d2b32">BIG_GEARS</a> : <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda8b41dc107e386de3894c87a62791e803">NO_GEARS</a>;
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <span class="keywordflow">if</span> (action == <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5433fd626bd95e39ac785f372d3d2b32">BIG_GEARS</a> &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ad0f3dbc77a3e6acefdb107c8ac244e69">modifiers</a> &amp; <a class="code" href="../../d2/d80/transform_8h.html#a633502031ac3c394e58ca6f0d16b3799">MOD_PRECISION</a>)) {
<a name="l01984"></a>01984         action = <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efda5af81cf4aac019828a35e83cbee5e039">SMALL_GEARS</a>;
<a name="l01985"></a>01985     }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     <a class="code" href="../../d2/d80/transform_8h.html#a5ae0f08d5e92b014ee45716e3d1ce322">snapGridAction</a>(t, val, action);
<a name="l01988"></a>01988 }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990 
<a name="l01991"></a><a class="code" href="../../df/dfc/transform__snap_8c.html#a8927f7b843b7b2e46b15c0200628dfb4">01991</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dfc/transform__snap_8c.html#a8927f7b843b7b2e46b15c0200628dfb4">applyGrid</a>(<a class="code" href="../../db/d6b/structTransInfo.html">TransInfo</a> *t, <span class="keywordtype">float</span> *val, <span class="keywordtype">int</span> max_index, <span class="keywordtype">float</span> fac[3], <a class="code" href="../../d2/d80/transform_8h.html#a50d2d9736a41817b649cc5201ad66efd">GearsType</a> action)
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01994"></a>01994     <span class="keywordtype">float</span> asp[3] = {1.0f, 1.0f, 1.0f}; <span class="comment">// TODO: Remove hard coded limit here (3)</span>
<a name="l01995"></a>01995 
<a name="l01996"></a>01996     <span class="keywordflow">if</span> (max_index &gt; 2) {
<a name="l01997"></a>01997         printf(<span class="stringliteral">&quot;applyGrid: invalid index %d, clamping\n&quot;</span>, max_index);
<a name="l01998"></a>01998         max_index= 2;
<a name="l01999"></a>01999     }
<a name="l02000"></a>02000 
<a name="l02001"></a>02001     <span class="comment">// Early bailing out if no need to snap</span>
<a name="l02002"></a>02002     <span class="keywordflow">if</span> (fac[action] == 0.0f)
<a name="l02003"></a>02003         <span class="keywordflow">return</span>;
<a name="l02004"></a>02004     
<a name="l02005"></a>02005     <span class="comment">/* evil hack - snapping needs to be adapted for image aspect ratio */</span>
<a name="l02006"></a>02006     <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#a212c46ebfd66c3f2d699e98e48a09e52">spacetype</a>==<a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>) &amp;&amp; (t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab1c1f995b48bb6b0986d2dda3349cae6">mode</a>==<a class="code" href="../../d8/df2/ED__transform_8h.html#aa57e16cd48de3b9a989056ff8df26f84ac6708d3325ae542bd46d599286c1cf90">TFM_TRANSLATION</a>)) {
<a name="l02007"></a>02007         <a class="code" href="../../de/d53/ED__image_8h.html#aad1989be279911287243afb19ac98dee">ED_space_image_uv_aspect</a>(t-&gt;<a class="code" href="../../db/d6b/structTransInfo.html#ab9a6bdecb3b6d03618728ab2126f3177">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, asp, asp+1);
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009 
<a name="l02010"></a>02010     <span class="keywordflow">for</span> (i=0; i&lt;=max_index; i++) {
<a name="l02011"></a>02011         val[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= fac[action]*asp[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*(float)floor(val[i]/(fac[action]*asp[i]) +0.5f);
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:55:00 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
