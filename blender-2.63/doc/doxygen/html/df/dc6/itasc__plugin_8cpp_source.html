<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: itasc_plugin.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">itasc_plugin.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../df/dc6/itasc__plugin_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Original author: Benoit Bolsee</span>
<a name="l00024"></a>00024 <span class="comment"> * Contributor(s): </span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">// iTaSC headers</span>
<a name="l00039"></a>00039 <span class="preprocessor">#ifdef WITH_IK_ITASC</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d0/d94/Armature_8hpp.html">Armature.hpp</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d2e/MovingFrame_8hpp.html">MovingFrame.hpp</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d92/CopyPose_8hpp.html">CopyPose.hpp</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d81/WSDLSSolver_8hpp.html">WSDLSSolver.hpp</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d57/WDLSSolver_8hpp.html">WDLSSolver.hpp</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../db/de8/Scene_8hpp.html">Scene.hpp</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d1e/Cache_8hpp.html">Cache.hpp</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d98/Distance_8hpp.html">Distance.hpp</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#endif</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dd6/BIK__api_8h.html">BIK_api.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d2a/DNA__action__types_8h.html">DNA_action_types.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00068"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">00068</a> };
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/de6/itasc__plugin_8h.html">itasc_plugin.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">// default parameters</span>
<a name="l00073"></a>00073 <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">DefIKParam</a>;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">// in case of animation mode, feedback and timestep is fixed</span>
<a name="l00076"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a3e6bbaf7f8a599c8e18c302f9dcf10d4">00076</a> <span class="preprocessor">#define ANIM_TIMESTEP   1.0</span>
<a name="l00077"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a393e44dcaf57fe234175215deeb68e33">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define ANIM_FEEDBACK   0.8</span>
<a name="l00078"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a3c0a95b242593f2a11aca18a53f47f10">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define ANIM_QMAX       0.52</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">// Structure pointed by bPose.ikdata</span>
<a name="l00082"></a>00082 <span class="comment">// It contains everything needed to simulate the armatures</span>
<a name="l00083"></a>00083 <span class="comment">// There can be several simulation islands independent to each other</span>
<a name="l00084"></a><a class="code" href="../../db/d29/structIK__Data.html">00084</a> <span class="keyword">struct </span><a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>
<a name="l00085"></a>00085 {
<a name="l00086"></a><a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">00086</a>     <span class="keyword">struct </span><a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* <a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>;
<a name="l00087"></a>00087 };
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ae72edf492db315ad02943cb9feac1c8e">00089</a> <span class="keyword">typedef</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ae72edf492db315ad02943cb9feac1c8e">Vector3</a>[3];
<a name="l00090"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ac251bf6d199ec30912c87ad22f3f2bf5">00090</a> <span class="keyword">typedef</span> <span class="keywordtype">float</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ac251bf6d199ec30912c87ad22f3f2bf5">Vector4</a>[4];
<a name="l00091"></a>00091 <span class="keyword">struct </span><a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>;
<a name="l00092"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a57b7a4288cf70eaaeb72570bf8f6d861">00092</a> <span class="keyword">typedef</span> void (*<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a57b7a4288cf70eaaeb72570bf8f6d861">ErrorCallback</a>)(<span class="keyword">const</span> <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nvalues, <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="comment">// one structure for each target in the scene</span>
<a name="l00095"></a><a class="code" href="../../d1/d57/structIK__Target.html">00095</a> <span class="keyword">struct </span><a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>
<a name="l00096"></a>00096 {
<a name="l00097"></a><a class="code" href="../../d1/d57/structIK__Target.html#a5dea933c516062d9ae6e1c4e634b9c1a">00097</a>     <span class="keyword">struct </span><a class="code" href="../../d9/d27/structScene.html">Scene</a>            *<a class="code" href="../../d1/d57/structIK__Target.html#a5dea933c516062d9ae6e1c4e634b9c1a">blscene</a>;
<a name="l00098"></a><a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">00098</a>     <a class="code" href="../../d4/dc0/classiTaSC_1_1MovingFrame.html">iTaSC::MovingFrame</a>*     <a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>;
<a name="l00099"></a><a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">00099</a>     <a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html">iTaSC::ConstraintSet</a>*   <a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>;
<a name="l00100"></a><a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">00100</a>     <span class="keyword">struct </span><a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a>*     <a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>;
<a name="l00101"></a><a class="code" href="../../d1/d57/structIK__Target.html#a7c57f040f2169958beb6a61051feb644">00101</a>     <span class="keyword">struct </span><a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*    <a class="code" href="../../d1/d57/structIK__Target.html#a7c57f040f2169958beb6a61051feb644">rootChannel</a>;
<a name="l00102"></a><a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">00102</a>     <a class="code" href="../../de/de7/structObject.html">Object</a>*                 <a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>;          <span class="comment">//for auto IK</span>
<a name="l00103"></a><a class="code" href="../../d1/d57/structIK__Target.html#ae0ef60c0964c9bff1bb4a32c46019fcc">00103</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a57b7a4288cf70eaaeb72570bf8f6d861">ErrorCallback</a>           <a class="code" href="../../d1/d57/structIK__Target.html#ae0ef60c0964c9bff1bb4a32c46019fcc">errorCallback</a>;
<a name="l00104"></a><a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">00104</a>     std::string             <a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>;
<a name="l00105"></a><a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">00105</a>     std::string             <a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a>;
<a name="l00106"></a><a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">00106</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          <a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a>;
<a name="l00107"></a><a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">00107</a>     <span class="keywordtype">short</span>                   <a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>;        <span class="comment">//index in IK channel array of channel on which this target is defined</span>
<a name="l00108"></a><a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">00108</a>     <span class="keywordtype">short</span>                   <a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">ee</a>;             <span class="comment">//end effector number</span>
<a name="l00109"></a><a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">00109</a>     <span class="keywordtype">bool</span>                    <a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a>;     <span class="comment">//true when simulation mode is used (update feedback)</span>
<a name="l00110"></a><a class="code" href="../../d1/d57/structIK__Target.html#ab32a86fb4a7008478645551fc2fa6009">00110</a>     <span class="keywordtype">bool</span>                    <a class="code" href="../../d1/d57/structIK__Target.html#ab32a86fb4a7008478645551fc2fa6009">eeBlend</a>;        <span class="comment">//end effector affected by enforce blending</span>
<a name="l00111"></a><a class="code" href="../../d1/d57/structIK__Target.html#af016dc6cd40942bc33d5a97d54d7ea78">00111</a>     <span class="keywordtype">float</span>                   <a class="code" href="../../d1/d57/structIK__Target.html#af016dc6cd40942bc33d5a97d54d7ea78">eeRest</a>[4][4];   <span class="comment">//end effector initial pose relative to armature</span>
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d1/d57/structIK__Target.html#a8ca68d9189914874d6558141231c15a8">00113</a>     <a class="code" href="../../d1/d57/structIK__Target.html#a8ca68d9189914874d6558141231c15a8">IK_Target</a>() {
<a name="l00114"></a>00114         <a class="code" href="../../d1/d57/structIK__Target.html#a5dea933c516062d9ae6e1c4e634b9c1a">blscene</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00115"></a>00115         <a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00116"></a>00116         <a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00117"></a>00117         <a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00118"></a>00118         <a class="code" href="../../d1/d57/structIK__Target.html#a7c57f040f2169958beb6a61051feb644">rootChannel</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00119"></a>00119         <a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00120"></a>00120         <a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> = 0;
<a name="l00121"></a>00121         <a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a> = 0;
<a name="l00122"></a>00122         <a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">ee</a> = 0;
<a name="l00123"></a>00123         <a class="code" href="../../d1/d57/structIK__Target.html#ab32a86fb4a7008478645551fc2fa6009">eeBlend</a> = <span class="keyword">true</span>;
<a name="l00124"></a>00124         <a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a> = <span class="keyword">true</span>;
<a name="l00125"></a>00125         <a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>.reserve(32);
<a name="l00126"></a>00126         <a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a>.reserve(32);
<a name="l00127"></a>00127     }
<a name="l00128"></a><a class="code" href="../../d1/d57/structIK__Target.html#a46820a73a12ce709a53ed32253205e4d">00128</a>     <a class="code" href="../../d1/d57/structIK__Target.html#a46820a73a12ce709a53ed32253205e4d">~IK_Target</a>() {
<a name="l00129"></a>00129         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>)
<a name="l00130"></a>00130             <span class="keyword">delete</span> <a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>;
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>)
<a name="l00132"></a>00132             <span class="keyword">delete</span> <a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>;
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134 };
<a name="l00135"></a>00135 
<a name="l00136"></a><a class="code" href="../../d5/db2/structIK__Channel.html">00136</a> <span class="keyword">struct </span><a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a> {
<a name="l00137"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">00137</a>     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*   <a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;      <span class="comment">// channel where we must copy matrix back</span>
<a name="l00138"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">00138</a>     <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a>      <a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">frame</a>;      <span class="comment">// frame of the bone relative to object base, not armature base</span>
<a name="l00139"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">00139</a>     std::string     <a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>;       <span class="comment">// segment name of the joint from which we get the bone tail</span>
<a name="l00140"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a8b938221aaf0f4bcfbc2bf01f7325b2e">00140</a>     std::string     <a class="code" href="../../d5/db2/structIK__Channel.html#a8b938221aaf0f4bcfbc2bf01f7325b2e">head</a>;       <span class="comment">// segment name of the joint from which we get the bone head</span>
<a name="l00141"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">00141</a>     <span class="keywordtype">int</span>             <a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">parent</a>;     <span class="comment">// index in this array of the parent channel</span>
<a name="l00142"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">00142</a>     <span class="keywordtype">short</span>           <a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a>;  <span class="comment">// type of joint, combination of IK_SegmentFlag</span>
<a name="l00143"></a><a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">00143</a>     <span class="keywordtype">char</span>            <a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;       <span class="comment">// number of joint angles for this channel</span>
<a name="l00144"></a><a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">00144</a>     <span class="keywordtype">char</span>            <a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a>; <span class="comment">// set to 1 when jointValue has been computed</span>
<a name="l00145"></a>00145     <span class="comment">// for joint constraint</span>
<a name="l00146"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a1743c1732a292f025b508908cbe2a6af">00146</a>     <a class="code" href="../../de/de7/structObject.html">Object</a>*         <a class="code" href="../../d5/db2/structIK__Channel.html#a1743c1732a292f025b508908cbe2a6af">owner</a>;              <span class="comment">// for pose and IK param</span>
<a name="l00147"></a><a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">00147</a>     <span class="keywordtype">double</span>          <a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[4];      <span class="comment">// computed joint value</span>
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../d5/db2/structIK__Channel.html#a8062d2ac481bb512a5cae5963de73d38">00149</a>     <a class="code" href="../../d5/db2/structIK__Channel.html#a8062d2ac481bb512a5cae5963de73d38">IK_Channel</a>() {
<a name="l00150"></a>00150         <a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00151"></a>00151         <a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">parent</a> = -1;
<a name="l00152"></a>00152         <a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = 0;
<a name="l00153"></a>00153         <a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 0;
<a name="l00154"></a>00154         <a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a> = 0;
<a name="l00155"></a>00155         <a class="code" href="../../d5/db2/structIK__Channel.html#a1743c1732a292f025b508908cbe2a6af">owner</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00156"></a>00156         <a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[0] = 0.0;
<a name="l00157"></a>00157         <a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[1] = 0.0;
<a name="l00158"></a>00158         <a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[2] = 0.0;
<a name="l00159"></a>00159         <a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[3] = 0.0;
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161 };
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="../../d5/d66/structIK__Scene.html">00163</a> <span class="keyword">struct </span><a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>
<a name="l00164"></a>00164 {
<a name="l00165"></a><a class="code" href="../../d5/d66/structIK__Scene.html#ac6776ca86124d581d5f640d259ffbd30">00165</a>     <span class="keyword">struct </span><a class="code" href="../../d9/d27/structScene.html">Scene</a>        *<a class="code" href="../../d5/d66/structIK__Scene.html#ac6776ca86124d581d5f640d259ffbd30">blscene</a>;
<a name="l00166"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">00166</a>     <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>*           <a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a>;
<a name="l00167"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a97dfce0a7d8210e45c4f68488795fd0e">00167</a>     <span class="keywordtype">int</span>                 <a class="code" href="../../d5/d66/structIK__Scene.html#a97dfce0a7d8210e45c4f68488795fd0e">numchan</a>;    <span class="comment">// number of channel in pchan</span>
<a name="l00168"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a0f2470d55ce054710ff22d3cdfde2cdd">00168</a>     <span class="keywordtype">int</span>                 <a class="code" href="../../d5/d66/structIK__Scene.html#a0f2470d55ce054710ff22d3cdfde2cdd">numjoint</a>;   <span class="comment">// number of joint in jointArray</span>
<a name="l00169"></a>00169     <span class="comment">// array of bone information, one per channel in the tree</span>
<a name="l00170"></a><a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">00170</a>     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>*         <a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>;
<a name="l00171"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">00171</a>     <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html">iTaSC::Armature</a>*    <a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>;
<a name="l00172"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">00172</a>     <a class="code" href="../../d8/dcf/classiTaSC_1_1Cache.html">iTaSC::Cache</a>*       <a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a>;
<a name="l00173"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">00173</a>     <a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html">iTaSC::Scene</a>*       <a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>;
<a name="l00174"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a6a788f465a457c3823cdcdf96d833d13">00174</a>     <a class="code" href="../../d4/dc0/classiTaSC_1_1MovingFrame.html">iTaSC::MovingFrame</a>* <a class="code" href="../../d5/d66/structIK__Scene.html#a6a788f465a457c3823cdcdf96d833d13">base</a>;       <span class="comment">// armature base object</span>
<a name="l00175"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">00175</a>     <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a>          <a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a>;  <span class="comment">// frame of armature base relative to blArmature</span>
<a name="l00176"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">00176</a>     <a class="code" href="../../db/d00/classKDL_1_1JntArray.html" title="This class represents an fixed size array containing joint values of a KDL::Chain.">KDL::JntArray</a>       <a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>; <span class="comment">// buffer for storing temporary joint array</span>
<a name="l00177"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">00177</a>     <a class="code" href="../../db/d64/classiTaSC_1_1Solver.html">iTaSC::Solver</a>*      <a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">solver</a>;
<a name="l00178"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">00178</a>     <a class="code" href="../../de/de7/structObject.html">Object</a>*             <a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>;
<a name="l00179"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">00179</a>     <span class="keyword">struct </span><a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a>* <a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">polarConstraint</a>;
<a name="l00180"></a><a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">00180</a>     std::vector&lt;IK_Target*&gt;     <a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>;
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="../../d5/d66/structIK__Scene.html#ab482a491a21488db9eda3d5d211d0f9e">00182</a>     <a class="code" href="../../d5/d66/structIK__Scene.html#ab482a491a21488db9eda3d5d211d0f9e">IK_Scene</a>() {
<a name="l00183"></a>00183         <a class="code" href="../../d5/d66/structIK__Scene.html#ac6776ca86124d581d5f640d259ffbd30">blscene</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00184"></a>00184         <a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00185"></a>00185         <a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00186"></a>00186         <a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00187"></a>00187         <a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00188"></a>00188         <a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00189"></a>00189         <a class="code" href="../../d5/d66/structIK__Scene.html#a6a788f465a457c3823cdcdf96d833d13">base</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00190"></a>00190         <a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">solver</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00191"></a>00191         <a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00192"></a>00192         <a class="code" href="../../d5/d66/structIK__Scene.html#a97dfce0a7d8210e45c4f68488795fd0e">numchan</a> = 0;
<a name="l00193"></a>00193         <a class="code" href="../../d5/d66/structIK__Scene.html#a0f2470d55ce054710ff22d3cdfde2cdd">numjoint</a> = 0;
<a name="l00194"></a>00194         <a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">polarConstraint</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="../../d5/d66/structIK__Scene.html#a5c81a5ebe2df3d6f86c0a0a3ec2d1a0b">00197</a>     <a class="code" href="../../d5/d66/structIK__Scene.html#a5c81a5ebe2df3d6f86c0a0a3ec2d1a0b">~IK_Scene</a>() {
<a name="l00198"></a>00198         <span class="comment">// delete scene first</span>
<a name="l00199"></a>00199         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>)
<a name="l00200"></a>00200             <span class="keyword">delete</span> <a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>;
<a name="l00201"></a>00201         <span class="keywordflow">for</span> (std::vector&lt;IK_Target*&gt;::iterator it = <a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>.begin();    it != <a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>.end(); ++it)
<a name="l00202"></a>00202             <span class="keyword">delete</span> (*it);
<a name="l00203"></a>00203         <a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>.clear();
<a name="l00204"></a>00204         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>)
<a name="l00205"></a>00205             <span class="keyword">delete</span> [] <a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>;
<a name="l00206"></a>00206         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">solver</a>)
<a name="l00207"></a>00207             <span class="keyword">delete</span> <a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">solver</a>;
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>)
<a name="l00209"></a>00209             <span class="keyword">delete</span> <a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>;
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#a6a788f465a457c3823cdcdf96d833d13">base</a>)
<a name="l00211"></a>00211             <span class="keyword">delete</span> <a class="code" href="../../d5/d66/structIK__Scene.html#a6a788f465a457c3823cdcdf96d833d13">base</a>;
<a name="l00212"></a>00212         <span class="comment">// delete cache last</span>
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a>)
<a name="l00214"></a>00214             <span class="keyword">delete</span> <a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a>;
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216 };
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">// type of IK joint, can be combined to list the joints corresponding to a bone</span>
<a name="l00219"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1b">00219</a> <span class="keyword">enum</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1b">IK_SegmentFlag</a> {
<a name="l00220"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">00220</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a> = 1,
<a name="l00221"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">00221</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a> = 2,
<a name="l00222"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">00222</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a> = 4,
<a name="l00223"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">00223</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a> = 8,
<a name="l00224"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">00224</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a> = 16,
<a name="l00225"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">00225</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a> = 32,
<a name="l00226"></a>00226 };
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118d">00228</a> <span class="keyword">enum</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118d">IK_SegmentAxis</a> {
<a name="l00229"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da128300e03ded8f1055769a0d439e9ffb">00229</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da128300e03ded8f1055769a0d439e9ffb">IK_X</a> = 0,
<a name="l00230"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dac78c8909dbd7e2b76b3e40face98f6a7">00230</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dac78c8909dbd7e2b76b3e40face98f6a7">IK_Y</a> = 1,
<a name="l00231"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118daf89476f163eaafc9ffd20a1731fb01da">00231</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118daf89476f163eaafc9ffd20a1731fb01da">IK_Z</a> = 2,
<a name="l00232"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da89937c662fb8bbe41d8f61c30c22f2bf">00232</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118da89937c662fb8bbe41d8f61c30c22f2bf">IK_TRANS_X</a> = 3,
<a name="l00233"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dadd53fa5ff654b6d4f5f8490ccae7e54f">00233</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dadd53fa5ff654b6d4f5f8490ccae7e54f">IK_TRANS_Y</a> = 4,
<a name="l00234"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dae3e7bf77ad18beb6c2bac1ca58c84b11">00234</a>     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#abf6c2e42bee9792479264fcb4665118dae3e7bf77ad18beb6c2bac1ca58c84b11">IK_TRANS_Z</a> = 5
<a name="l00235"></a>00235 };
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ad66a00387fb35ca8db8d17804b250fb0">00237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ad66a00387fb35ca8db8d17804b250fb0">initialize_chain</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan_tip, <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *curchan, *pchan_root=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *chanlist[256], **oldchan;
<a name="l00240"></a>00240     <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree;
<a name="l00241"></a>00241     <a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a> *target;
<a name="l00242"></a>00242     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00243"></a>00243     <span class="keywordtype">int</span> a, t, segcount= 0, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, newsize, *oldparent, parent, rootbone, treecount;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     data=(<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00246"></a>00246     
<a name="l00247"></a>00247     <span class="comment">/* exclude tip from chain? */</span>
<a name="l00248"></a>00248     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dae3a865a72db654ff3b3a0528179d699a">CONSTRAINT_IK_TIP</a>))
<a name="l00249"></a>00249         pchan_tip= pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l00250"></a>00250     
<a name="l00251"></a>00251     rootbone = data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#afb10d502fbc8bf3fce8f2994e355be56">rootbone</a>;
<a name="l00252"></a>00252     <span class="comment">/* Find the chain&#39;s root &amp; count the segments needed */</span>
<a name="l00253"></a>00253     for (curchan = pchan_tip; curchan; curchan=curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00254"></a>00254         pchan_root = curchan;
<a name="l00255"></a>00255         
<a name="l00256"></a>00256         <span class="keywordflow">if</span> (++segcount &gt; 255)       <span class="comment">// 255 is weak</span>
<a name="l00257"></a>00257             <span class="keywordflow">break</span>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (segcount==rootbone) {
<a name="l00260"></a>00260             <span class="comment">// reached this end of the chain but if the chain is overlapping with a </span>
<a name="l00261"></a>00261             <span class="comment">// previous one, we must go back up to the root of the other chain</span>
<a name="l00262"></a>00262             <span class="keywordflow">if</span> ((curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>) &amp;&amp; curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00263"></a>00263                 rootbone++;
<a name="l00264"></a>00264                 <span class="keywordflow">continue</span>;
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266             <span class="keywordflow">break</span>; 
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00270"></a>00270             <span class="comment">// Oh oh, there is already a chain starting from this channel and our chain is longer... </span>
<a name="l00271"></a>00271             <span class="comment">// Should handle this by moving the previous chain up to the beginning of our chain</span>
<a name="l00272"></a>00272             <span class="comment">// For now we just stop here</span>
<a name="l00273"></a>00273             <span class="keywordflow">break</span>;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (!segcount) <span class="keywordflow">return</span> 0;
<a name="l00276"></a>00276     <span class="comment">// we reached a limit and still not the end of a previous chain, quit</span>
<a name="l00277"></a>00277     <span class="keywordflow">if</span> ((pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>) &amp;&amp; pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> 0;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="comment">// now that we know how many segment we have, set the flag</span>
<a name="l00280"></a>00280     <span class="keywordflow">for</span> (rootbone = segcount, segcount = 0, curchan = pchan_tip; segcount &lt; rootbone; segcount++, curchan=curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00281"></a>00281         chanlist[segcount]=curchan;
<a name="l00282"></a>00282         curchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="comment">/* setup the chain data */</span>
<a name="l00286"></a>00286     <span class="comment">/* create a target */</span>
<a name="l00287"></a>00287     target= (<a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a>), <span class="stringliteral">&quot;posetarget&quot;</span>);
<a name="l00288"></a>00288     target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#aab192287f5ea3cb51de939ede88302c4">con</a>= con;
<a name="l00289"></a>00289     <span class="comment">// by contruction there can be only one tree per channel and each channel can be part of at most one tree.</span>
<a name="l00290"></a>00290     tree = (<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>*)pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (tree==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00293"></a>00293         <span class="comment">/* make new tree */</span>
<a name="l00294"></a>00294         tree= (<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>), <span class="stringliteral">&quot;posetree&quot;</span>);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>= data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a3d450bd6c2b940c3528daf2cedec7cd3">iterations</a>;
<a name="l00297"></a>00297         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>= segcount;
<a name="l00298"></a>00298         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> = (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dac50fe615c0c820802234e6496ed59435">CONSTRAINT_IK_STRETCH</a>);
<a name="l00299"></a>00299         
<a name="l00300"></a>00300         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>**)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(segcount*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*), <span class="stringliteral">&quot;ik tree pchan&quot;</span>);
<a name="l00301"></a>00301         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>= (<span class="keywordtype">int</span>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(segcount*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ik tree parent&quot;</span>);
<a name="l00302"></a>00302         <span class="keywordflow">for</span> (a=0; a&lt;segcount; a++) {
<a name="l00303"></a>00303             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]= chanlist[segcount-a-1];
<a name="l00304"></a>00304             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a]= a-1;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306         target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>= segcount-1;
<a name="l00307"></a>00307         
<a name="l00308"></a>00308         <span class="comment">/* AND! link the tree to the root */</span>
<a name="l00309"></a>00309         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l00310"></a>00310         <span class="comment">// new tree</span>
<a name="l00311"></a>00311         treecount = 1;
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313     <span class="keywordflow">else</span> {
<a name="l00314"></a>00314         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a3d450bd6c2b940c3528daf2cedec7cd3">iterations</a>, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a27e65281c56ad19bf5a80db5ff9c26cf">iterations</a>);
<a name="l00315"></a>00315         tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a>= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; !(data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5dac50fe615c0c820802234e6496ed59435">CONSTRAINT_IK_STRETCH</a>);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="comment">/* skip common pose channels and add remaining*/</span>
<a name="l00318"></a>00318         <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(segcount, tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00319"></a>00319         a = t = 0;
<a name="l00320"></a>00320         <span class="keywordflow">while</span> (a&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> &amp;&amp; t&lt;tree-&gt;totchannel) {
<a name="l00321"></a>00321             <span class="comment">// locate first matching channel</span>
<a name="l00322"></a>00322             <span class="keywordflow">for</span> (;t&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> &amp;&amp; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[t]!=chanlist[segcount-a-1];t++);
<a name="l00323"></a>00323             <span class="keywordflow">if</span> (t&gt;=tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>)
<a name="l00324"></a>00324                 <span class="keywordflow">break</span>;
<a name="l00325"></a>00325             <span class="keywordflow">for</span> (; a&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> &amp;&amp; t&lt;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> &amp;&amp; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[t]==chanlist[segcount-a-1]; a++, t++);
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         segcount= segcount-a;
<a name="l00329"></a>00329         target-&gt;<a class="code" href="../../d0/db4/structPoseTarget.html#ad636cbf61d39471c475bd97fa90388ca">tip</a>= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> + segcount - 1;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (segcount &gt; 0) {
<a name="l00332"></a>00332             <span class="keywordflow">for</span> (parent = a - 1; parent &lt; tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>; parent++)
<a name="l00333"></a>00333                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[parent] == chanlist[segcount-1]-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>)
<a name="l00334"></a>00334                     <span class="keywordflow">break</span>;
<a name="l00335"></a>00335             
<a name="l00336"></a>00336             <span class="comment">/* shouldn&#39;t happen, but could with dependency cycles */</span>
<a name="l00337"></a>00337             <span class="keywordflow">if</span> (parent == tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>)
<a name="l00338"></a>00338                 parent = a - 1;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340             <span class="comment">/* resize array */</span>
<a name="l00341"></a>00341             newsize= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> + segcount;
<a name="l00342"></a>00342             oldchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>;
<a name="l00343"></a>00343             oldparent= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>**)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(newsize*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*), <span class="stringliteral">&quot;ik tree pchan&quot;</span>);
<a name="l00346"></a>00346             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>= (<span class="keywordtype">int</span>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(newsize*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ik tree parent&quot;</span>);
<a name="l00347"></a>00347             memcpy(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>, oldchan, <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00348"></a>00348             memcpy(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>, oldparent, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>);
<a name="l00349"></a>00349             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(oldchan);
<a name="l00350"></a>00350             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(oldparent);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352             <span class="comment">/* add new pose channels at the end, in reverse order */</span>
<a name="l00353"></a>00353             <span class="keywordflow">for</span> (a=0; a&lt;segcount; a++) {
<a name="l00354"></a>00354                 tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a]= chanlist[segcount-a-1];
<a name="l00355"></a>00355                 tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a]= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>+a-1;
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>]= parent;
<a name="l00358"></a>00358             
<a name="l00359"></a>00359             tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>= newsize;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         <span class="comment">// reusing tree</span>
<a name="l00362"></a>00362         treecount = 0;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">/* add target to the tree */</span>
<a name="l00366"></a>00366     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>, target);
<a name="l00367"></a>00367     <span class="comment">/* mark root channel having an IK tree */</span>
<a name="l00368"></a>00368     pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a109821706241e25864cface202adbe0c">POSE_IKTREE</a>;
<a name="l00369"></a>00369     <span class="keywordflow">return</span> treecount;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aaceb1fa99434d30211fe3c94c749f959">00372</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aaceb1fa99434d30211fe3c94c749f959">is_cartesian_constraint</a>(<a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con)
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374     <span class="comment">//bKinematicConstraint* data=(bKinematicConstraint*)con-&gt;data;</span>
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a8d2c148d91968d4ba54c0dab7544c6e9">00379</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a8d2c148d91968d4ba54c0dab7544c6e9">constraint_valid</a>(<a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con)
<a name="l00380"></a>00380 {
<a name="l00381"></a>00381     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>* <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>=(<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ad7b9c9e543f98e483728044e9627fb14">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5daa615284f990351c298b824ea793e3b41">CONSTRAINT_IK_AUTO</a>)
<a name="l00384"></a>00384         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00385"></a>00385     <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efdac624d1811979843b913fe2a7c3833c53">CONSTRAINT_DISABLE</a>)
<a name="l00386"></a>00386         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aaceb1fa99434d30211fe3c94c749f959">is_cartesian_constraint</a>(con)) {
<a name="l00388"></a>00388         <span class="comment">/* cartesian space constraint */</span>
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a40d06e4dc4d012bd48f578721cffbe5b">tar</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l00390"></a>00390             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a40d06e4dc4d012bd48f578721cffbe5b">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a> &amp;&amp; data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ae1995de4033715d3d3c571f70f92d344">subtarget</a>[0]==0) 
<a name="l00392"></a>00392             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4cdfbea4714dd59568084c3394b30961">00397</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4cdfbea4714dd59568084c3394b30961">initialize_scene</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan_tip)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l00400"></a>00400     <span class="keywordtype">int</span> treecount;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <span class="comment">/* find all IK constraints and validate them */</span>
<a name="l00403"></a>00403     treecount = 0;
<a name="l00404"></a>00404     <span class="keywordflow">for</span> (con= (<a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *)pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con= (<a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *)con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a>==<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a>) {
<a name="l00406"></a>00406             <span class="keywordflow">if</span> (<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a8d2c148d91968d4ba54c0dab7544c6e9">constraint_valid</a>(con))
<a name="l00407"></a>00407                 treecount += <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ad66a00387fb35ca8db8d17804b250fb0">initialize_chain</a>(ob, pchan_tip, con);
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">return</span> treecount;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a1e11539815ee950e870f1ac4d346661d">00413</a> <span class="keyword">static</span> <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a1e11539815ee950e870f1ac4d346661d">get_ikdata</a>(<a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>)
<a name="l00416"></a>00416         <span class="keywordflow">return</span> (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l00417"></a>00417     pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>), <span class="stringliteral">&quot;iTaSC ikdata&quot;</span>);
<a name="l00418"></a>00418     <span class="comment">// here init ikdata if needed</span>
<a name="l00419"></a>00419     <span class="comment">// now that we have scene, make sure the default param are initialized</span>
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (!DefIKParam.<a class="code" href="../../d5/d18/structbItasc.html#a745709b5e54bb0581a987bc4ae9eccba">iksolver</a>)
<a name="l00421"></a>00421         <a class="code" href="../../d8/df5/BKE__action_8h.html#aeab4dd60c6f8b36ba69bbf0d102d6c93">init_pose_itasc</a>(&amp;DefIKParam);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="keywordflow">return</span> (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l00424"></a>00424 }
<a name="l00425"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">00425</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">EulerAngleFromMatrix</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, <span class="keywordtype">int</span> axis)
<a name="l00426"></a>00426 {
<a name="l00427"></a>00427     <span class="keywordtype">double</span> t = <a class="code" href="../../d0/dbc/namespaceKDL.html#a58fe67505327001d5466e97c2f5333b3">KDL::sqrt</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0) + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1)*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1));
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (t &gt; 16.0*<a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">KDL::epsilon</a>) {
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (axis == 0) <span class="keywordflow">return</span> -<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,2), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,2));
<a name="l00431"></a>00431         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (axis == 1) <span class="keywordflow">return</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2), t);
<a name="l00432"></a>00432         <span class="keywordflow">else</span> <span class="keywordflow">return</span> -<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0));
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <span class="keywordflow">else</span> {
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (axis == 0) <span class="keywordflow">return</span> -<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,1), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,1));
<a name="l00436"></a>00436         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (axis == 1) <span class="keywordflow">return</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2), t);
<a name="l00437"></a>00437         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0.0f;
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">00441</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">ComputeTwist</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     <span class="comment">// qy and qw are the y and w components of the quaternion from R</span>
<a name="l00444"></a>00444     <span class="keywordtype">double</span> qy = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2) - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,0);
<a name="l00445"></a>00445     <span class="keywordtype">double</span> qw = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0) + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,1) + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,2) + 1;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordtype">double</span> tau = 2*<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(qy, qw);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="keywordflow">return</span> tau;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a0c80045de468a8c83a0e3b06be61de62">00452</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a0c80045de468a8c83a0e3b06be61de62">RemoveEulerAngleFromMatrix</a>(<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, <span class="keywordtype">double</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, <span class="keywordtype">int</span> axis)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454     <span class="comment">// compute twist parameter</span>
<a name="l00455"></a>00455     <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> <a class="code" href="../../d2/d6c/mball_8c.html#a0acb682b8260ab1c60b918599864e2e5">T</a>;
<a name="l00456"></a>00456     <span class="keywordflow">switch</span> (axis) {
<a name="l00457"></a>00457     <span class="keywordflow">case</span> 0:
<a name="l00458"></a>00458         T = <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#aa91e54a80dbba2b1741e73d944f83dd4" title="The Rot... static functions give the value of the appropriate rotation matrix back.">KDL::Rotation::RotX</a>(-angle);
<a name="l00459"></a>00459         <span class="keywordflow">break</span>;
<a name="l00460"></a>00460     <span class="keywordflow">case</span> 1:
<a name="l00461"></a>00461         T = <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#affcd5e7f323fd376c60f2e899e5e74f1" title="The Rot... static functions give the value of the appropriate rotation matrix back.">KDL::Rotation::RotY</a>(-angle);
<a name="l00462"></a>00462         <span class="keywordflow">break</span>;
<a name="l00463"></a>00463     <span class="keywordflow">case</span> 2:
<a name="l00464"></a>00464         T = <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a5c7cc27354b3d553c919e839d7b84dbf" title="The Rot... static functions give the value of the appropriate rotation matrix back.">KDL::Rotation::RotZ</a>(-angle);
<a name="l00465"></a>00465         <span class="keywordflow">break</span>;
<a name="l00466"></a>00466     <span class="keywordflow">default</span>:
<a name="l00467"></a>00467         <span class="keywordflow">return</span>;
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469     <span class="comment">// remove angle</span>
<a name="l00470"></a>00470     R = R*<a class="code" href="../../d2/d6c/mball_8c.html#a0acb682b8260ab1c60b918599864e2e5">T</a>;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="preprocessor">#if 0</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> GetEulerXZY(<span class="keyword">const</span> <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, <span class="keywordtype">double</span>&amp; X,<span class="keywordtype">double</span>&amp; Z,<span class="keywordtype">double</span>&amp; Y)
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1)) &gt; 1.0 - <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">KDL::epsilon</a> ) {
<a name="l00477"></a>00477         X = -<a class="code" href="../../d0/dbc/namespaceKDL.html#a26d8ca57d3f08fc3ae0c00b3fc7b2d94">KDL::sign</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1)) * <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,2), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,0));
<a name="l00478"></a>00478         Z = -<a class="code" href="../../d0/dbc/namespaceKDL.html#a26d8ca57d3f08fc3ae0c00b3fc7b2d94">KDL::sign</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1)) * <a class="code" href="../../d0/dbc/namespaceKDL.html#a8deb2bd8c8926513a18283b4af0de0fd" title="the value of pi">KDL::PI</a> / 2;
<a name="l00479"></a>00479         Y = 0.0;
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481     <span class="keywordflow">else</span> {
<a name="l00482"></a>00482         X = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,1), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,1));
<a name="l00483"></a>00483         Z = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1), <a class="code" href="../../d0/dbc/namespaceKDL.html#a58fe67505327001d5466e97c2f5333b3">KDL::sqrt</a>( <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0)) + <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2))));
<a name="l00484"></a>00484         Y = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0));
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="keyword">static</span> <span class="keywordtype">void</span> GetEulerXYZ(<span class="keyword">const</span> <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; R, <span class="keywordtype">double</span>&amp; X,<span class="keywordtype">double</span>&amp; Y,<span class="keywordtype">double</span>&amp; Z)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2)) &gt; 1.0 - <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">KDL::epsilon</a> ) {
<a name="l00491"></a>00491         X = <a class="code" href="../../d0/dbc/namespaceKDL.html#a26d8ca57d3f08fc3ae0c00b3fc7b2d94">KDL::sign</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2)) * <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,0), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,1));
<a name="l00492"></a>00492         Y = <a class="code" href="../../d0/dbc/namespaceKDL.html#a26d8ca57d3f08fc3ae0c00b3fc7b2d94">KDL::sign</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2)) * <a class="code" href="../../d0/dbc/namespaceKDL.html#a8deb2bd8c8926513a18283b4af0de0fd" title="the value of pi">KDL::PI</a> / 2;
<a name="l00493"></a>00493         Z = 0.0;
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="keywordflow">else</span> {
<a name="l00496"></a>00496         X = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(1,2), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(2,2));
<a name="l00497"></a>00497         Y = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,2), <a class="code" href="../../d0/dbc/namespaceKDL.html#a58fe67505327001d5466e97c2f5333b3">KDL::sqrt</a>( <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0)) + <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1))));
<a name="l00498"></a>00498         Z = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">KDL::atan2</a>(-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,1), <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>(0,0));
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 <span class="preprocessor">#endif</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>
<a name="l00503"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a984962598641c1d76fcf367492439a2b">00503</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a984962598641c1d76fcf367492439a2b">GetJointRotation</a>(<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a>&amp; boneRot, <span class="keywordtype">int</span> <a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a>, <span class="keywordtype">double</span>* rot)
<a name="l00504"></a>00504 {
<a name="l00505"></a>00505     <span class="keywordflow">switch</span> (type &amp; ~<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)
<a name="l00506"></a>00506     {
<a name="l00507"></a>00507     <span class="keywordflow">default</span>:
<a name="l00508"></a>00508         <span class="comment">// fixed bone, no joint</span>
<a name="l00509"></a>00509         <span class="keywordflow">break</span>;
<a name="l00510"></a>00510     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>:
<a name="l00511"></a>00511         <span class="comment">// RX only, get the X rotation</span>
<a name="l00512"></a>00512         rot[0] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">EulerAngleFromMatrix</a>(boneRot, 0);
<a name="l00513"></a>00513         <span class="keywordflow">break</span>;
<a name="l00514"></a>00514     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00515"></a>00515         <span class="comment">// RY only, get the Y rotation</span>
<a name="l00516"></a>00516         rot[0] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">ComputeTwist</a>(boneRot);
<a name="l00517"></a>00517         <span class="keywordflow">break</span>;
<a name="l00518"></a>00518     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00519"></a>00519         <span class="comment">// RZ only, get the Z rotation</span>
<a name="l00520"></a>00520         rot[0] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">EulerAngleFromMatrix</a>(boneRot, 2);
<a name="l00521"></a>00521         <span class="keywordflow">break</span>;
<a name="l00522"></a>00522     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00523"></a>00523         rot[1] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">ComputeTwist</a>(boneRot);
<a name="l00524"></a>00524         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a0c80045de468a8c83a0e3b06be61de62">RemoveEulerAngleFromMatrix</a>(boneRot, rot[1], 1);
<a name="l00525"></a>00525         rot[0] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">EulerAngleFromMatrix</a>(boneRot, 0);
<a name="l00526"></a>00526         <span class="keywordflow">break</span>;
<a name="l00527"></a>00527     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>:
<a name="l00528"></a>00528         <span class="comment">// RX+RZ</span>
<a name="l00529"></a>00529         boneRot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a71cc4ac51143b749cc9028b038cbfa9a">GetXZRot</a>().GetValue(rot);
<a name="l00530"></a>00530         <span class="keywordflow">break</span>;
<a name="l00531"></a>00531     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00532"></a>00532         <span class="comment">// RZ+RY</span>
<a name="l00533"></a>00533         rot[1] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">ComputeTwist</a>(boneRot);
<a name="l00534"></a>00534         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a0c80045de468a8c83a0e3b06be61de62">RemoveEulerAngleFromMatrix</a>(boneRot, rot[1], 1);
<a name="l00535"></a>00535         rot[0] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af47dfc38a69b791fd94829baa46c3f71">EulerAngleFromMatrix</a>(boneRot, 2);
<a name="l00536"></a>00536         <span class="keywordflow">break</span>;
<a name="l00537"></a>00537     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00538"></a>00538         rot[2] = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9fa7089b0438563444d46b03bf50f1b8">ComputeTwist</a>(boneRot);
<a name="l00539"></a>00539         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a0c80045de468a8c83a0e3b06be61de62">RemoveEulerAngleFromMatrix</a>(boneRot, rot[2], 1);
<a name="l00540"></a>00540         boneRot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a71cc4ac51143b749cc9028b038cbfa9a">GetXZRot</a>().GetValue(rot);
<a name="l00541"></a>00541         <span class="keywordflow">break</span>;
<a name="l00542"></a>00542     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a>:
<a name="l00543"></a>00543         boneRot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#aa3ce2fd7bcd7063497febc76110cc5b2">GetRot</a>().GetValue(rot);
<a name="l00544"></a>00544         <span class="keywordflow">break</span>;
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2529dcf9a927e15241c49d91227a11a1">00548</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2529dcf9a927e15241c49d91227a11a1">target_callback</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>&amp; timestamp, <span class="keyword">const</span> <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">iTaSC::Frame</a>&amp; current, <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">iTaSC::Frame</a>&amp; <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, <span class="keywordtype">void</span> *param)
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550     <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* target = (<a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>*)param;
<a name="l00551"></a>00551     <span class="comment">// compute next target position</span>
<a name="l00552"></a>00552     <span class="comment">// get target matrix from constraint.</span>
<a name="l00553"></a>00553     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a>* constraint = (<a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a>*)target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>;
<a name="l00554"></a>00554     <span class="keywordtype">float</span> tarmat[4][4];
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#aff661b9b70a11e24803d8f9ccb46bcba">get_constraint_target_matrix</a>(target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a5dea933c516062d9ae6e1c4e634b9c1a">blscene</a>, constraint, 0, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#adfb54b57e8687ce7b32072d253bfde5ca80fce2faf62ad6f0acce0e3319b4b6c8">CONSTRAINT_OBTYPE_OBJECT</a>, target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>, tarmat, 1.0);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="comment">// rootmat contains the target pose in world coordinate</span>
<a name="l00559"></a>00559     <span class="comment">// if enforce is != 1.0, blend the target position with the end effector position</span>
<a name="l00560"></a>00560     <span class="comment">// if the armature was in rest position. This information is available in eeRest</span>
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (constraint-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> != 1.0f &amp;&amp; target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ab32a86fb4a7008478645551fc2fa6009">eeBlend</a>) {
<a name="l00562"></a>00562         <span class="comment">// eeRest is relative to the reference frame of the IK root</span>
<a name="l00563"></a>00563         <span class="comment">// get this frame in world reference</span>
<a name="l00564"></a>00564         <span class="keywordtype">float</span> restmat[4][4];
<a name="l00565"></a>00565         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>* pchan = target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a7c57f040f2169958beb6a61051feb644">rootChannel</a>;
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00567"></a>00567             pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l00568"></a>00568             <span class="keywordtype">float</span> chanmat[4][4];
<a name="l00569"></a>00569             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(chanmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00570"></a>00570             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(chanmat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00571"></a>00571             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(restmat, target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, chanmat, target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af016dc6cd40942bc33d5a97d54d7ea78">eeRest</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00572"></a>00572         } 
<a name="l00573"></a>00573         <span class="keywordflow">else</span> {
<a name="l00574"></a>00574             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(restmat, target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, target-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af016dc6cd40942bc33d5a97d54d7ea78">eeRest</a>);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         <span class="comment">// blend the target</span>
<a name="l00577"></a>00577         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a3d5bcb56397fadbf6966427875962a01">blend_m4_m4m4</a>(tarmat, restmat, tarmat, constraint-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a>);
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579     next.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#ae82408bfd49b9ac38e95db306ff44161">setValue</a>(&amp;tarmat[0][0]);
<a name="l00580"></a>00580     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2c1680d5b097436f09e74be7fe7e2355">00583</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2c1680d5b097436f09e74be7fe7e2355">base_callback</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>&amp; timestamp, <span class="keyword">const</span> <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">iTaSC::Frame</a>&amp; current, <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">iTaSC::Frame</a>&amp; <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, <span class="keywordtype">void</span> *param)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585     <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene = (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>*)param;
<a name="l00586"></a>00586     <span class="comment">// compute next armature base pose</span>
<a name="l00587"></a>00587     <span class="comment">// algorithm: </span>
<a name="l00588"></a>00588     <span class="comment">// ikscene-&gt;pchan[0] is the root channel of the tree</span>
<a name="l00589"></a>00589     <span class="comment">// if it has a parent, get the pose matrix from it and replace [3] by parent pchan-&gt;tail</span>
<a name="l00590"></a>00590     <span class="comment">// then multiply by the armature matrix to get ikscene-&gt;armature base position</span>
<a name="l00591"></a>00591     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>* pchan = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>[0].<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;
<a name="l00592"></a>00592     <span class="keywordtype">float</span> rootmat[4][4];
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l00594"></a>00594         pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l00595"></a>00595         <span class="keywordtype">float</span> chanmat[4][4];
<a name="l00596"></a>00596         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(chanmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00597"></a>00597         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(chanmat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00598"></a>00598         <span class="comment">// save the base as a frame too so that we can compute deformation</span>
<a name="l00599"></a>00599         <span class="comment">// after simulation</span>
<a name="l00600"></a>00600         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a>.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#ae82408bfd49b9ac38e95db306ff44161">setValue</a>(&amp;chanmat[0][0]);
<a name="l00601"></a>00601         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rootmat, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, chanmat);
<a name="l00602"></a>00602     } 
<a name="l00603"></a>00603     <span class="keywordflow">else</span> {
<a name="l00604"></a>00604         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rootmat, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00605"></a>00605         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a> = <a class="code" href="../../d8/d76/namespaceiTaSC.html#a465a261ab4b279a8a5e0b96140721e72">iTaSC::F_identity</a>;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607     next.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#ae82408bfd49b9ac38e95db306ff44161">setValue</a>(&amp;rootmat[0][0]);
<a name="l00608"></a>00608     <span class="comment">// if there is a polar target (only during solving otherwise we don&#39;t have end efffector)</span>
<a name="l00609"></a>00609     <span class="keywordflow">if</span> (ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">polarConstraint</a> &amp;&amp; timestamp.<a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html#afdea5d634c6bf39e09e4e265ebbdd0b8">update</a>) {
<a name="l00610"></a>00610         <span class="comment">// compute additional rotation of base frame so that armature follows the polar target</span>
<a name="l00611"></a>00611         <span class="keywordtype">float</span> imat[4][4];       <span class="comment">// IK tree base inverse matrix</span>
<a name="l00612"></a>00612         <span class="keywordtype">float</span> polemat[4][4];    <span class="comment">// polar target in IK tree base frame</span>
<a name="l00613"></a>00613         <span class="keywordtype">float</span> goalmat[4][4];    <span class="comment">// target in IK tree base frame</span>
<a name="l00614"></a>00614         <span class="keywordtype">float</span> mat[4][4];        <span class="comment">// temp matrix</span>
<a name="l00615"></a>00615         <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>* poledata = (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">polarConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, rootmat);
<a name="l00618"></a>00618         <span class="comment">// polar constraint imply only one target</span>
<a name="l00619"></a>00619         <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a> *iktarget = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>[0];
<a name="l00620"></a>00620         <span class="comment">// root channel from which we take the bone initial orientation</span>
<a name="l00621"></a>00621         <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a> &amp;rootchan = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>[0];
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         <span class="comment">// get polar target matrix in world space</span>
<a name="l00624"></a>00624         <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#aff661b9b70a11e24803d8f9ccb46bcba">get_constraint_target_matrix</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ac6776ca86124d581d5f640d259ffbd30">blscene</a>, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a5bd193ab348b70eb8000481e0a451c9f">polarConstraint</a>, 1, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#adfb54b57e8687ce7b32072d253bfde5ca80fce2faf62ad6f0acce0e3319b4b6c8">CONSTRAINT_OBTYPE_OBJECT</a>, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>, mat, 1.0);
<a name="l00625"></a>00625         <span class="comment">// convert to armature space</span>
<a name="l00626"></a>00626         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(polemat, imat, mat);
<a name="l00627"></a>00627         <span class="comment">// get the target in world space (was computed before as target object are defined before base object)</span>
<a name="l00628"></a>00628         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>-&gt;<a class="code" href="../../d9/d27/classiTaSC_1_1Object.html#a3b6d34c5485e1efce22083ff87af5192">getPose</a>().<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a04b4fbf9486c2ffb3919913165e09adb">getValue</a>(mat[0]);
<a name="l00629"></a>00629         <span class="comment">// convert to armature space</span>
<a name="l00630"></a>00630         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(goalmat, imat, mat);
<a name="l00631"></a>00631         <span class="comment">// take position of target, polar target, end effector, in armature space</span>
<a name="l00632"></a>00632         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> goalpos(goalmat[3]);
<a name="l00633"></a>00633         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> polepos(polemat[3]);
<a name="l00634"></a>00634         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> endpos = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a4754282aef29138a5af0dd16ce9b0abd">getPose</a>(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">ee</a>).p;
<a name="l00635"></a>00635         <span class="comment">// get root bone orientation</span>
<a name="l00636"></a>00636         <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a> rootframe;
<a name="l00637"></a>00637         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a3e4fc4e1d7b75a4d37c6a9ea3a783130">getRelativeFrame</a>(rootframe, rootchan.<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>);
<a name="l00638"></a>00638         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> rootx = rootframe.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>.UnitX();
<a name="l00639"></a>00639         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> rootz = rootframe.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>.UnitZ();
<a name="l00640"></a>00640         <span class="comment">// and compute root bone head</span>
<a name="l00641"></a>00641         <span class="keywordtype">double</span> q_rest[3], q[3], <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00642"></a>00642         <span class="keyword">const</span> <a class="code" href="../../de/d91/classKDL_1_1Joint.html" title="This class encapsulates a simple joint, that is with one parameterized degree of freedom and with sca...">KDL::Joint</a>* joint;
<a name="l00643"></a>00643         <span class="keyword">const</span> <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a>* tip;
<a name="l00644"></a>00644         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a72337865eb9b2743cbdc8091d00f2dca">getSegment</a>(rootchan.<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>, 3, joint, q_rest[0], q[0], tip);
<a name="l00645"></a>00645         length = (joint-&gt;<a class="code" href="../../de/d91/classKDL_1_1Joint.html#af5732628e105954144f1e225683414ee">getType</a>() == <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea5118e6fc6a5deee920b1378a17d7c29c">KDL::Joint::TransY</a>) ? q[0] : tip-&gt;<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#abc00c3817f7baa985b67077479617866" title="origine of the Frame">p</a>(1);
<a name="l00646"></a>00646         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> rootpos = rootframe.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#abc00c3817f7baa985b67077479617866" title="origine of the Frame">p</a> - length*rootframe.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>.UnitY();
<a name="l00647"></a>00647 
<a name="l00648"></a>00648         <span class="comment">// compute main directions </span>
<a name="l00649"></a>00649         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> dir = <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(endpos - rootpos);
<a name="l00650"></a>00650         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> poledir = <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(goalpos-rootpos);
<a name="l00651"></a>00651         <span class="comment">// compute up directions</span>
<a name="l00652"></a>00652         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> poleup = <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(polepos-rootpos);
<a name="l00653"></a>00653         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> up = rootx*<a class="code" href="../../d0/dbc/namespaceKDL.html#a29285f37f3f7b3acbcd49679c1ecf8bc">KDL::cos</a>(poledata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ab6b072b23e2bc6baf1be71d99ace2a3d">poleangle</a>) + rootz*<a class="code" href="../../d0/dbc/namespaceKDL.html#ab2f2e04e696c94ab195d538a190fa065">KDL::sin</a>(poledata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#ab6b072b23e2bc6baf1be71d99ace2a3d">poleangle</a>);
<a name="l00654"></a>00654         <span class="comment">// from which we build rotation matrix</span>
<a name="l00655"></a>00655         <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> endrot, polerot;
<a name="l00656"></a>00656         <span class="comment">// for the armature, using the root bone orientation</span>
<a name="l00657"></a>00657         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> x = <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(dir*up);
<a name="l00658"></a>00658         endrot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a0b767aa6a0822c84f47c9bea02ca3b6b" title="Access to the underlying unitvectors of the rotation matrix.">UnitX</a>(x);
<a name="l00659"></a>00659         endrot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#ac387e9c4cb7f9b9202113061cd6913ef" title="Access to the underlying unitvectors of the rotation matrix.">UnitY</a>(<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(x*dir));
<a name="l00660"></a>00660         endrot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a7228bb8b91d3af29dc4518026119612d" title="Access to the underlying unitvectors of the rotation matrix.">UnitZ</a>(-dir);
<a name="l00661"></a>00661         <span class="comment">// for the polar target </span>
<a name="l00662"></a>00662         x = <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(poledir*poleup);
<a name="l00663"></a>00663         polerot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a0b767aa6a0822c84f47c9bea02ca3b6b" title="Access to the underlying unitvectors of the rotation matrix.">UnitX</a>(x);
<a name="l00664"></a>00664         polerot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#ac387e9c4cb7f9b9202113061cd6913ef" title="Access to the underlying unitvectors of the rotation matrix.">UnitY</a>(<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a1761943400301f0737322af28ae30368">KDL::Normalize</a>(x*poledir));
<a name="l00665"></a>00665         polerot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a7228bb8b91d3af29dc4518026119612d" title="Access to the underlying unitvectors of the rotation matrix.">UnitZ</a>(-poledir);
<a name="l00666"></a>00666         <span class="comment">// the difference between the two is the rotation we want to apply</span>
<a name="l00667"></a>00667         <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> result(polerot*endrot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a306d548385d991c3b018b4839cc9c69b" title="Gives back the inverse rotation matrix of *this.">Inverse</a>());
<a name="l00668"></a>00668         <span class="comment">// apply on base frame as this is an artificial additional rotation</span>
<a name="l00669"></a>00669         next.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a> = next.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>*result;
<a name="l00670"></a>00670         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a>.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a> = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a>.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>*result;
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4a49011b14a30a1eea6a419c2d7ca795">00675</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4a49011b14a30a1eea6a419c2d7ca795">copypose_callback</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>&amp; timestamp, <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* <span class="keyword">const</span> _values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _nvalues, <span class="keywordtype">void</span>* _param)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677     <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget =(<a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>*)_param;
<a name="l00678"></a>00678     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *condata = (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *)iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00679"></a>00679     <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values = _values;
<a name="l00680"></a>00680     <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*) iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">// we need default parameters</span>
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (!ikparam) 
<a name="l00684"></a>00684         ikparam = &amp;<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">DefIKParam</a>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>) {
<a name="l00687"></a>00687         <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a1840b8e171009040b836a9bbf46044e7">iTaSC::CopyPose::CTL_POSITION</a>) {
<a name="l00688"></a>00688             values-&gt;alpha = 0.0;
<a name="l00689"></a>00689             values-&gt;action = <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>;
<a name="l00690"></a>00690             values++;
<a name="l00691"></a>00691         }
<a name="l00692"></a>00692         <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ab253d49bbc8e172f61512177c90f68a2">iTaSC::CopyPose::CTL_ROTATION</a>) {
<a name="l00693"></a>00693             values-&gt;alpha = 0.0;
<a name="l00694"></a>00694             values-&gt;action = <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>;
<a name="l00695"></a>00695             values++;
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698     <span class="keywordflow">else</span> {
<a name="l00699"></a>00699         <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a1840b8e171009040b836a9bbf46044e7">iTaSC::CopyPose::CTL_POSITION</a>) {
<a name="l00700"></a>00700             <span class="comment">// update error</span>
<a name="l00701"></a>00701             values-&gt;alpha = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a>;
<a name="l00702"></a>00702             values-&gt;action = <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>|<a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a6a4054f7082a6e199d25560940408859">iTaSC::ACT_FEEDBACK</a>;
<a name="l00703"></a>00703             values-&gt;feedback = (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a>) ? ikparam-&gt;feedback : <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a393e44dcaf57fe234175215deeb68e33">ANIM_FEEDBACK</a>;
<a name="l00704"></a>00704             values++;
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ab253d49bbc8e172f61512177c90f68a2">iTaSC::CopyPose::CTL_ROTATION</a>) {
<a name="l00707"></a>00707             <span class="comment">// update error</span>
<a name="l00708"></a>00708             values-&gt;alpha = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a9107cfb0638ca19451f437441612ecd9">orientweight</a>;
<a name="l00709"></a>00709             values-&gt;action = <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>|<a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a6a4054f7082a6e199d25560940408859">iTaSC::ACT_FEEDBACK</a>;
<a name="l00710"></a>00710             values-&gt;feedback = (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a>) ? ikparam-&gt;feedback : <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a393e44dcaf57fe234175215deeb68e33">ANIM_FEEDBACK</a>;
<a name="l00711"></a>00711             values++;
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a99965d7d4420d94679f52f558dd18156">00717</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a99965d7d4420d94679f52f558dd18156">copypose_error</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nvalues, <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719     <a class="code" href="../../dd/d1b/structiTaSC_1_1ConstraintSingleValue.html">iTaSC::ConstraintSingleValue</a>* value;
<a name="l00720"></a>00720     <span class="keywordtype">double</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l00721"></a>00721     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a1840b8e171009040b836a9bbf46044e7">iTaSC::CopyPose::CTL_POSITION</a>) {
<a name="l00724"></a>00724         <span class="comment">// update error</span>
<a name="l00725"></a>00725         <span class="keywordflow">for</span> (i=0, error=0.0, value=values-&gt;<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a9c40994e8b076cccd653ac2b4d1a31a7">values</a>; i&lt;values-&gt;number; ++i, ++value)
<a name="l00726"></a>00726             error += <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(value-&gt;<a class="code" href="../../dd/d1b/structiTaSC_1_1ConstraintSingleValue.html#a7755180dbc09eb1e4e89113f2133db81">y</a> - value-&gt;<a class="code" href="../../dd/d1b/structiTaSC_1_1ConstraintSingleValue.html#a5f64820dfa3cffd4433177ef1a998556">yd</a>);
<a name="l00727"></a>00727         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a7b37e24e24b1a5e39e3a32e971025b53">lin_error</a> = (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#a58fe67505327001d5466e97c2f5333b3">KDL::sqrt</a>(error);
<a name="l00728"></a>00728         values++;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ab253d49bbc8e172f61512177c90f68a2">iTaSC::CopyPose::CTL_ROTATION</a>) {
<a name="l00731"></a>00731         <span class="comment">// update error</span>
<a name="l00732"></a>00732         <span class="keywordflow">for</span> (i=0, error=0.0, value=values-&gt;<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a9c40994e8b076cccd653ac2b4d1a31a7">values</a>; i&lt;values-&gt;number; ++i, ++value)
<a name="l00733"></a>00733             error += <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">KDL::sqr</a>(value-&gt;<a class="code" href="../../dd/d1b/structiTaSC_1_1ConstraintSingleValue.html#a7755180dbc09eb1e4e89113f2133db81">y</a> - value-&gt;<a class="code" href="../../dd/d1b/structiTaSC_1_1ConstraintSingleValue.html#a5f64820dfa3cffd4433177ef1a998556">yd</a>);
<a name="l00734"></a>00734         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a75fe4e289223c54264cb38a546adcaea">rot_error</a> = (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#a58fe67505327001d5466e97c2f5333b3">KDL::sqrt</a>(error);
<a name="l00735"></a>00735         values++;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af653c20b853eb92b5f452a2e92b7ba6e">00739</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af653c20b853eb92b5f452a2e92b7ba6e">distance_callback</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>&amp; timestamp, <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* <span class="keyword">const</span> _values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _nvalues, <span class="keywordtype">void</span>* _param)
<a name="l00740"></a>00740 {
<a name="l00741"></a>00741     <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget =(<a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>*)_param;
<a name="l00742"></a>00742     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *condata = (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *)iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l00743"></a>00743     <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values = _values;
<a name="l00744"></a>00744     <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*) iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l00745"></a>00745     <span class="comment">// we need default parameters</span>
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (!ikparam) 
<a name="l00747"></a>00747         ikparam = &amp;<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">DefIKParam</a>;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="comment">// update weight according to mode</span>
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>) {
<a name="l00751"></a>00751         values-&gt;alpha = 0.0;
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753     <span class="keywordflow">else</span> {
<a name="l00754"></a>00754         <span class="keywordflow">switch</span> (condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a83c8fe0a6dc210b99d6e9593ce60b016">mode</a>) {
<a name="l00755"></a>00755         <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a2ed82593b16970a388e7295b9c46f435a2ac920db4a6457b9615ba1018978550b">LIMITDIST_INSIDE</a>:
<a name="l00756"></a>00756             values-&gt;alpha = (values-&gt;values[0].y &gt; condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a617e02afc0d2e0d5ff56ad625bfc7d0a">dist</a>) ? condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a> : 0.0;
<a name="l00757"></a>00757             <span class="keywordflow">break</span>;
<a name="l00758"></a>00758         <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a2ed82593b16970a388e7295b9c46f435a853087af7cf7b0cfcf619fac2e44162e">LIMITDIST_OUTSIDE</a>:
<a name="l00759"></a>00759             values-&gt;alpha = (values-&gt;values[0].y &lt; condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a617e02afc0d2e0d5ff56ad625bfc7d0a">dist</a>) ? condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a> : 0.0;
<a name="l00760"></a>00760             <span class="keywordflow">break</span>;
<a name="l00761"></a>00761         <span class="keywordflow">default</span>:
<a name="l00762"></a>00762             values-&gt;alpha = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a94763884fb93e57a4a80596528af859e">weight</a>;
<a name="l00763"></a>00763             <span class="keywordflow">break</span>;
<a name="l00764"></a>00764         }   
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (!timestamp.<a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html#aa1cc8fb8aba8d525fcbdeb29551959b6">substep</a>) {
<a name="l00766"></a>00766             <span class="comment">// only update value on first timestep</span>
<a name="l00767"></a>00767             <span class="keywordflow">switch</span> (condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a83c8fe0a6dc210b99d6e9593ce60b016">mode</a>) {
<a name="l00768"></a>00768             <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a2ed82593b16970a388e7295b9c46f435a2ac920db4a6457b9615ba1018978550b">LIMITDIST_INSIDE</a>:
<a name="l00769"></a>00769                 values-&gt;values[0].yd = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a617e02afc0d2e0d5ff56ad625bfc7d0a">dist</a>*0.95;
<a name="l00770"></a>00770                 <span class="keywordflow">break</span>;
<a name="l00771"></a>00771             <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a2ed82593b16970a388e7295b9c46f435a853087af7cf7b0cfcf619fac2e44162e">LIMITDIST_OUTSIDE</a>:
<a name="l00772"></a>00772                 values-&gt;values[0].yd = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a617e02afc0d2e0d5ff56ad625bfc7d0a">dist</a>*1.05;
<a name="l00773"></a>00773                 <span class="keywordflow">break</span>;
<a name="l00774"></a>00774             <span class="keywordflow">default</span>:
<a name="l00775"></a>00775                 values-&gt;values[0].yd = condata-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#a617e02afc0d2e0d5ff56ad625bfc7d0a">dist</a>;
<a name="l00776"></a>00776                 <span class="keywordflow">break</span>;
<a name="l00777"></a>00777             }
<a name="l00778"></a>00778             values-&gt;values[0].action = <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a827f5dae378d65d40a925ebb7a11bd8a">iTaSC::ACT_VALUE</a>|<a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a6a4054f7082a6e199d25560940408859">iTaSC::ACT_FEEDBACK</a>;
<a name="l00779"></a>00779             values-&gt;feedback = (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a>) ? ikparam-&gt;feedback : <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a393e44dcaf57fe234175215deeb68e33">ANIM_FEEDBACK</a>;
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     values-&gt;action |= <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>;
<a name="l00783"></a>00783     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a125126876f885122a501ce041196df3b">00786</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a125126876f885122a501ce041196df3b">distance_error</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _nvalues, <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788     iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a7b37e24e24b1a5e39e3a32e971025b53">lin_error</a> = (float)(values-&gt;<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a9c40994e8b076cccd653ac2b4d1a31a7">values</a>[0].y - values-&gt;<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a9c40994e8b076cccd653ac2b4d1a31a7">values</a>[0].yd);
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">00791</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>&amp; timestamp, <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* <span class="keyword">const</span> _values, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> _nvalues, <span class="keywordtype">void</span>* _param)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>* ikchan = (<a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>*)_param;
<a name="l00794"></a>00794     <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*)ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a1743c1732a292f025b508908cbe2a6af">owner</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l00795"></a>00795     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>* chan = ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;
<a name="l00796"></a>00796     <span class="keywordtype">int</span> dof;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="comment">// a channel can be splitted into multiple joints, so we get called multiple</span>
<a name="l00799"></a>00799     <span class="comment">// times for one channel (this callback is only for 1 joint in the armature)</span>
<a name="l00800"></a>00800     <span class="comment">// the IK_JointTarget structure is shared between multiple joint constraint</span>
<a name="l00801"></a>00801     <span class="comment">// and the target joint values is computed only once, remember this in jointValid</span>
<a name="l00802"></a>00802     <span class="comment">// Don&#39;t forget to reset it before each frame</span>
<a name="l00803"></a>00803     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a>) {
<a name="l00804"></a>00804         <span class="keywordtype">float</span> rmat[3][3];
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (chan-&gt;rotmode &gt; 0) {
<a name="l00807"></a>00807             <span class="comment">/* euler rotations (will cause gimble lock, but this can be alleviated a bit with rotation orders) */</span>
<a name="l00808"></a>00808             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa6973857a6a1d26c0155bb21f4b6de01">eulO_to_mat3</a>( rmat,chan-&gt;eul, chan-&gt;rotmode);
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan-&gt;rotmode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l00811"></a>00811             <span class="comment">/* axis-angle - stored in quaternion data, but not really that great for 3D-changing orientations */</span>
<a name="l00812"></a>00812             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa804c4cef742fd7a1dd820bf0128ad4a">axis_angle_to_mat3</a>( rmat,&amp;chan-&gt;quat[1], chan-&gt;quat[0]);
<a name="l00813"></a>00813         }
<a name="l00814"></a>00814         <span class="keywordflow">else</span> {
<a name="l00815"></a>00815             <span class="comment">/* quats are normalised before use to eliminate scaling issues */</span>
<a name="l00816"></a>00816             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(chan-&gt;quat);
<a name="l00817"></a>00817             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ae0343d0ff2af81f054d3916277409507">quat_to_mat3</a>( rmat,chan-&gt;quat);
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819         <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> jointRot(
<a name="l00820"></a>00820             rmat[0][0], rmat[1][0], rmat[2][0],
<a name="l00821"></a>00821             rmat[0][1], rmat[1][1], rmat[2][1],
<a name="l00822"></a>00822             rmat[0][2], rmat[1][2], rmat[2][2]);
<a name="l00823"></a>00823         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a984962598641c1d76fcf367492439a2b">GetJointRotation</a>(jointRot, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a>, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>);
<a name="l00824"></a>00824         ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a> = 1;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826     <span class="comment">// determine which part of jointValue is used for this joint</span>
<a name="l00827"></a>00827     <span class="comment">// closely related to the way the joints are defined</span>
<a name="l00828"></a>00828     <span class="keywordflow">switch</span> (ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> &amp; ~<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)
<a name="l00829"></a>00829     {
<a name="l00830"></a>00830     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>:
<a name="l00831"></a>00831     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00832"></a>00832     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00833"></a>00833         dof = 0;
<a name="l00834"></a>00834         <span class="keywordflow">break</span>;
<a name="l00835"></a>00835     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00836"></a>00836         <span class="comment">// X + Y</span>
<a name="l00837"></a>00837         dof = (_values[0].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a72e317d1356c2c2cc54371e2babe87df">id</a> == <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ad84120eb9bdf6b2257532a0443266f96a439c9f49eb1772110af3a528aad68615">iTaSC::Armature::ID_JOINT_RX</a>) ? 0 : 1;
<a name="l00838"></a>00838         <span class="keywordflow">break</span>;
<a name="l00839"></a>00839     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>:
<a name="l00840"></a>00840         <span class="comment">// XZ</span>
<a name="l00841"></a>00841         dof = 0;
<a name="l00842"></a>00842         <span class="keywordflow">break</span>;
<a name="l00843"></a>00843     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00844"></a>00844         <span class="comment">// Z + Y</span>
<a name="l00845"></a>00845         dof = (_values[0].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a72e317d1356c2c2cc54371e2babe87df">id</a> == <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ad84120eb9bdf6b2257532a0443266f96ae25282c7b0d4a6b4f4c4e6f3d6154112">iTaSC::Armature::ID_JOINT_RZ</a>) ? 0 : 1;
<a name="l00846"></a>00846         <span class="keywordflow">break</span>;
<a name="l00847"></a>00847     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00848"></a>00848         <span class="comment">// XZ + Y</span>
<a name="l00849"></a>00849         dof = (_values[0].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a72e317d1356c2c2cc54371e2babe87df">id</a> == <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ad84120eb9bdf6b2257532a0443266f96a0806743274f8ef6dc6c01d2f6b2ca018">iTaSC::Armature::ID_JOINT_RY</a>) ? 2 : 0;
<a name="l00850"></a>00850         <span class="keywordflow">break</span>;
<a name="l00851"></a>00851     <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a>:
<a name="l00852"></a>00852         dof = 0;
<a name="l00853"></a>00853         <span class="keywordflow">break</span>;
<a name="l00854"></a>00854     <span class="keywordflow">default</span>:
<a name="l00855"></a>00855         dof = -1;
<a name="l00856"></a>00856         <span class="keywordflow">break</span>;
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (dof &gt;= 0) {
<a name="l00859"></a>00859         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;_nvalues; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++, dof++) {
<a name="l00860"></a>00860             _values[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#a9c40994e8b076cccd653ac2b4d1a31a7">values</a>[0].yd = ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af2e724e45646a34a09075ccad517b438">jointValue</a>[dof];
<a name="l00861"></a>00861             _values[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#afb85ca77f351279f76a5e4da42a9965e">alpha</a> = chan-&gt;ikrotweight;
<a name="l00862"></a>00862             _values[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html#aaf312316882f9056ca55ad776f87c8e3">feedback</a> = ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a8093c970abead813f5e379ad21807365">feedback</a>;
<a name="l00863"></a>00863         }
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="comment">// build array of joint corresponding to IK chain</span>
<a name="l00869"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a20b973ffc077230e8e802bd7ca872cb7">00869</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a20b973ffc077230e8e802bd7ca872cb7">convert_channels</a>(<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a> *ikscene, <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree)
<a name="l00870"></a>00870 {
<a name="l00871"></a>00871     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a> *ikchan;
<a name="l00872"></a>00872     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l00873"></a>00873     <span class="keywordtype">int</span> a, <a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a>, njoint;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     njoint = 0;
<a name="l00876"></a>00876     <span class="keywordflow">for</span> (a=0, ikchan = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; a&lt;ikscene-&gt;numchan; ++a, ++ikchan) {
<a name="l00877"></a>00877         pchan= tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a];
<a name="l00878"></a>00878         ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a> = pchan;
<a name="l00879"></a>00879         ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">parent</a> = (a&gt;0) ? tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a] : -1;
<a name="l00880"></a>00880         ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a1743c1732a292f025b508908cbe2a6af">owner</a> = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>;
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         <span class="comment">/* set DoF flag */</span>
<a name="l00883"></a>00883         flag = 0;
<a name="l00884"></a>00884         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2adc4ecbea32802d8aa298e2ed2b5211ae">BONE_IK_NO_XDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a4e55b43d7180c82640050d2e9b03082f">BONE_IK_NO_XDOF_TEMP</a>) &amp;&amp; 
<a name="l00885"></a>00885             (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>) || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[0]&lt;0.f || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[0]&gt;0.f))
<a name="l00886"></a>00886             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>;
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2ab3f5e5869916e0ca2fb6186eb8041c08">BONE_IK_NO_YDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a2f52ff63ac04beb67f460392d4fce30f">BONE_IK_NO_YDOF_TEMP</a>) &amp;&amp;
<a name="l00888"></a>00888             (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2aaab5d511784c6381cd75b6f7e4df6118">BONE_IK_YLIMIT</a>) || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[1]&lt;0.f || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[1]&gt;0.f))
<a name="l00889"></a>00889             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a59809ed69fd1b2cd42584c396d07fc39">BONE_IK_NO_ZDOF</a>) &amp;&amp; !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a9f079be3942201545eb1797efaa56bdf">BONE_IK_NO_ZDOF_TEMP</a>) &amp;&amp;
<a name="l00891"></a>00891             (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>) || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[2]&lt;0.f || pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[2]&gt;0.f))
<a name="l00892"></a>00892             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>;
<a name="l00893"></a>00893         
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#ad71719922bc67525f5e453e54437b661">stretch</a> &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a> &gt; 0.0)) {
<a name="l00895"></a>00895             flag |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>;
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897         <span class="comment">/*</span>
<a name="l00898"></a>00898 <span class="comment">         * Logic to create the segments:</span>
<a name="l00899"></a>00899 <span class="comment">         * RX,RY,RZ = rotational joints with no length</span>
<a name="l00900"></a>00900 <span class="comment">         * RY(tip) = rotational joints with a fixed length arm = (0,length,0)</span>
<a name="l00901"></a>00901 <span class="comment">         * TY = translational joint on Y axis</span>
<a name="l00902"></a>00902 <span class="comment">         * F(pos) = fixed joint with an arm at position pos</span>
<a name="l00903"></a>00903 <span class="comment">         * Conversion rule of the above flags:</span>
<a name="l00904"></a>00904 <span class="comment">         * -   ==&gt; F(tip)</span>
<a name="l00905"></a>00905 <span class="comment">         * X   ==&gt; RX(tip)</span>
<a name="l00906"></a>00906 <span class="comment">         * Y   ==&gt; RY(tip)</span>
<a name="l00907"></a>00907 <span class="comment">         * Z   ==&gt; RZ(tip)</span>
<a name="l00908"></a>00908 <span class="comment">         * XY  ==&gt; RX+RY(tip)</span>
<a name="l00909"></a>00909 <span class="comment">         * XZ  ==&gt; RX+RZ(tip)</span>
<a name="l00910"></a>00910 <span class="comment">         * YZ  ==&gt; RZ+RY(tip)</span>
<a name="l00911"></a>00911 <span class="comment">         * XYZ ==&gt; full spherical unless there are limits, in which case RX+RZ+RY(tip)</span>
<a name="l00912"></a>00912 <span class="comment">         * In case of stretch, tip=(0,0,0) and there is an additional TY joint</span>
<a name="l00913"></a>00913 <span class="comment">         * The frame at last of these joints represents the tail of the bone.</span>
<a name="l00914"></a>00914 <span class="comment">         * The head is computed by a reverse translation on Y axis of the bone length</span>
<a name="l00915"></a>00915 <span class="comment">         * or in case of TY joint, by the frame at previous joint.</span>
<a name="l00916"></a>00916 <span class="comment">         * In case of separation of bones, there is an additional F(head) joint</span>
<a name="l00917"></a>00917 <span class="comment">         *</span>
<a name="l00918"></a>00918 <span class="comment">         * Computing rest pose and length is complicated: the solver works in world space</span>
<a name="l00919"></a>00919 <span class="comment">         * Here is the logic:</span>
<a name="l00920"></a>00920 <span class="comment">         * rest position is computed only from bone-&gt;bone_mat.</span>
<a name="l00921"></a>00921 <span class="comment">         * bone length is computed from bone-&gt;length multiplied by the scaling factor of</span>
<a name="l00922"></a>00922 <span class="comment">         * the armature. Non-uniform scaling will give bad result!</span>
<a name="l00923"></a>00923 <span class="comment">         */</span>
<a name="l00924"></a>00924         <span class="keywordflow">switch</span> (flag &amp; (<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>))
<a name="l00925"></a>00925         {
<a name="l00926"></a>00926         <span class="keywordflow">default</span>:
<a name="l00927"></a>00927             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = 0;
<a name="l00928"></a>00928             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 0;
<a name="l00929"></a>00929             <span class="keywordflow">break</span>;
<a name="l00930"></a>00930         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>:
<a name="l00931"></a>00931             <span class="comment">// RX only, get the X rotation</span>
<a name="l00932"></a>00932             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>;
<a name="l00933"></a>00933             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 1;
<a name="l00934"></a>00934             <span class="keywordflow">break</span>;
<a name="l00935"></a>00935         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00936"></a>00936             <span class="comment">// RY only, get the Y rotation</span>
<a name="l00937"></a>00937             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00938"></a>00938             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 1;
<a name="l00939"></a>00939             <span class="keywordflow">break</span>;
<a name="l00940"></a>00940         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00941"></a>00941             <span class="comment">// RZ only, get the Zz rotation</span>
<a name="l00942"></a>00942             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>;
<a name="l00943"></a>00943             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 1;
<a name="l00944"></a>00944             <span class="keywordflow">break</span>;
<a name="l00945"></a>00945         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l00946"></a>00946             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00947"></a>00947             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 2;
<a name="l00948"></a>00948             <span class="keywordflow">break</span>;
<a name="l00949"></a>00949         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00950"></a>00950             <span class="comment">// RX+RZ</span>
<a name="l00951"></a>00951             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>;
<a name="l00952"></a>00952             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 2;
<a name="l00953"></a>00953             <span class="keywordflow">break</span>;
<a name="l00954"></a>00954         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00955"></a>00955             <span class="comment">// RZ+RY</span>
<a name="l00956"></a>00956             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00957"></a>00957             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 2;
<a name="l00958"></a>00958             <span class="keywordflow">break</span>;
<a name="l00959"></a>00959         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l00960"></a>00960             <span class="comment">// spherical joint</span>
<a name="l00961"></a>00961             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2aaab5d511784c6381cd75b6f7e4df6118">BONE_IK_YLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>))
<a name="l00962"></a>00962                 <span class="comment">// decompose in a Swing+RotY joint</span>
<a name="l00963"></a>00963                 ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>;
<a name="l00964"></a>00964             <span class="keywordflow">else</span>
<a name="l00965"></a>00965                 ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a>;
<a name="l00966"></a>00966             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a> = 3;
<a name="l00967"></a>00967             <span class="keywordflow">break</span>;
<a name="l00968"></a>00968         }
<a name="l00969"></a>00969         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>) {
<a name="l00970"></a>00970             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> |= <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>;
<a name="l00971"></a>00971             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>++;
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973         njoint += ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975     <span class="comment">// njoint is the joint coordinate, create the Joint Array</span>
<a name="l00976"></a>00976     ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>.<a class="code" href="../../db/d00/classKDL_1_1JntArray.html#a4ea82246fd0aa8badff28deb24c2e629">resize</a>(njoint);
<a name="l00977"></a>00977     ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a0f2470d55ce054710ff22d3cdfde2cdd">numjoint</a> = njoint;
<a name="l00978"></a>00978     <span class="keywordflow">return</span> njoint;
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 <span class="comment">// compute array of joint value corresponding to current pose</span>
<a name="l00982"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4872bf7df3d3fa8ea9629146e0348386">00982</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4872bf7df3d3fa8ea9629146e0348386">convert_pose</a>(<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a> *ikscene)
<a name="l00983"></a>00983 {
<a name="l00984"></a>00984     <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> boneRot;
<a name="l00985"></a>00985     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l00986"></a>00986     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a> *ikchan;
<a name="l00987"></a>00987     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l00988"></a>00988     <span class="keywordtype">float</span> rmat[4][4];   <span class="comment">// rest pose of bone with parent taken into account</span>
<a name="l00989"></a>00989     <span class="keywordtype">float</span> bmat[4][4];   <span class="comment">// difference</span>
<a name="l00990"></a>00990     <span class="keywordtype">float</span> scale;
<a name="l00991"></a>00991     <span class="keywordtype">double</span> *<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>;
<a name="l00992"></a>00992     <span class="keywordtype">int</span> a, joint;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     <span class="comment">// assume uniform scaling and take Y scale as general scale for the armature</span>
<a name="l00995"></a>00995     scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[1]);
<a name="l00996"></a>00996     rot = &amp;ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>(0);
<a name="l00997"></a>00997     <span class="keywordflow">for</span> (joint=a=0, ikchan = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; a&lt;ikscene-&gt;numchan &amp;&amp; joint&lt;ikscene-&gt;numjoint; ++a, ++ikchan) {
<a name="l00998"></a>00998         pchan= ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;
<a name="l00999"></a>00999         bone= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l01000"></a>01000         
<a name="l01001"></a>01001         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l01002"></a>01002             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(bmat);
<a name="l01003"></a>01003             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aea2f0520d37780e0a116c46e342a01fe">mul_m4_m4m3</a>(bmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l01004"></a>01004         }
<a name="l01005"></a>01005         <span class="keywordflow">else</span> {
<a name="l01006"></a>01006             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(bmat, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01007"></a>01007         }
<a name="l01008"></a>01008         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rmat, bmat);
<a name="l01009"></a>01009         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(bmat, rmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01010"></a>01010         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(bmat);
<a name="l01011"></a>01011         boneRot.<a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html#a2988c2410636d1df3474ca1a888b0a52">setValue</a>(bmat[0]);
<a name="l01012"></a>01012         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a984962598641c1d76fcf367492439a2b">GetJointRotation</a>(boneRot, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a>, rot);
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>) {
<a name="l01014"></a>01014             <span class="comment">// compute actual length </span>
<a name="l01015"></a>01015             rot[ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>-1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>) * scale;
<a name="l01016"></a>01016         } 
<a name="l01017"></a>01017         rot += ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;
<a name="l01018"></a>01018         joint += ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020 }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022 <span class="comment">// compute array of joint value corresponding to current pose</span>
<a name="l01023"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a72d85e12758803edd66d12f9417ed2b2">01023</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df5/BKE__action_8h.html#a4fd8f1724c534f7777be90116365ddfd">rest_pose</a>(<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a> *ikscene)
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01026"></a>01026     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a> *ikchan;
<a name="l01027"></a>01027     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01028"></a>01028     <span class="keywordtype">float</span> scale;
<a name="l01029"></a>01029     <span class="keywordtype">double</span> *<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>;
<a name="l01030"></a>01030     <span class="keywordtype">int</span> a, joint;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <span class="comment">// assume uniform scaling and take Y scale as general scale for the armature</span>
<a name="l01033"></a>01033     scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[1]);
<a name="l01034"></a>01034     <span class="comment">// rest pose is 0 </span>
<a name="l01035"></a>01035     <a class="code" href="../../d4/d44/frames_8inl.html#a73e913de2016bccf9ec44e18dce273b1">SetToZero</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>);
<a name="l01036"></a>01036     <span class="comment">// except for transY joints</span>
<a name="l01037"></a>01037     rot = &amp;ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>(0);
<a name="l01038"></a>01038     <span class="keywordflow">for</span> (joint=a=0, ikchan = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; a&lt;ikscene-&gt;numchan &amp;&amp; joint&lt;ikscene-&gt;numjoint; ++a, ++ikchan) {
<a name="l01039"></a>01039         pchan= ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;
<a name="l01040"></a>01040         bone= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="keywordflow">if</span> (ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5e39008c9393c1ca9eaa679bf859bff9">jointType</a> &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)
<a name="l01043"></a>01043             rot[ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>-1] = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>*scale;
<a name="l01044"></a>01044         rot += ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;
<a name="l01045"></a>01045         joint += ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#af569436b595cd0b3860a4c9b59b7c5f8">ndof</a>;
<a name="l01046"></a>01046     }
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01049"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a240ba87e062ebcd513d68f9991ca6c37">01049</a> <span class="keyword">static</span> <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a240ba87e062ebcd513d68f9991ca6c37">convert_tree</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *blscene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l01050"></a>01050 {
<a name="l01051"></a>01051     <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree = (<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>*)pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01052"></a>01052     <a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a> *target;
<a name="l01053"></a>01053     <a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *condata;
<a name="l01054"></a>01054     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *polarcon;
<a name="l01055"></a>01055     <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a> *ikparam;
<a name="l01056"></a>01056     <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html">iTaSC::Armature</a>* arm;
<a name="l01057"></a>01057     <a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html">iTaSC::Scene</a>* scene;
<a name="l01058"></a>01058     <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene;
<a name="l01059"></a>01059     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>* ikchan;
<a name="l01060"></a>01060     <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a> initPose;
<a name="l01061"></a>01061     <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> boneRot;
<a name="l01062"></a>01062     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01063"></a>01063     <span class="keywordtype">int</span> a, numtarget;
<a name="l01064"></a>01064     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> t;
<a name="l01065"></a>01065     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l01066"></a>01066     <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>, ingame;
<a name="l01067"></a>01067     <span class="keywordtype">double</span> *<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a> == 0)
<a name="l01070"></a>01070         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072     ikscene = <span class="keyword">new</span> <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>;
<a name="l01073"></a>01073     ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ac6776ca86124d581d5f640d259ffbd30">blscene</a> = blscene;
<a name="l01074"></a>01074     arm = <span class="keyword">new</span> <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html">iTaSC::Armature</a>();
<a name="l01075"></a>01075     scene = <span class="keyword">new</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae7ebc72be193c28268c4ade0df2485d3">iTaSC::Scene</a>();
<a name="l01076"></a>01076     ikscene-&gt;channels = <span class="keyword">new</span> <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>];
<a name="l01077"></a>01077     ikscene-&gt;numchan = tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#aac5041813aec6a9f83aede61dd8ade0e">totchannel</a>;
<a name="l01078"></a>01078     ikscene-&gt;armature = arm;
<a name="l01079"></a>01079     ikscene-&gt;scene = scene;
<a name="l01080"></a>01080     ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l01081"></a>01081     ingame = (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da73ccacdc673d969588a95c3b5676dc5a">POSE_GAME_ENGINE</a>);
<a name="l01082"></a>01082     <span class="keywordflow">if</span> (!ikparam) {
<a name="l01083"></a>01083         <span class="comment">// you must have our own copy</span>
<a name="l01084"></a>01084         ikparam = &amp;<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">DefIKParam</a>;
<a name="l01085"></a>01085     }
<a name="l01086"></a>01086     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ingame) {
<a name="l01087"></a>01087         <span class="comment">// tweak the param when in game to have efficient stepping</span>
<a name="l01088"></a>01088         <span class="comment">// using fixed substep is not effecient since frames in the GE are often</span>
<a name="l01089"></a>01089         <span class="comment">// shorter than in animation =&gt; move to auto step automatically and set</span>
<a name="l01090"></a>01090         <span class="comment">// the target substep duration via min/max</span>
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (!(ikparam-&gt;flag &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811a6b39df95d371f6131b640edabf6c8f8a">ITASC_AUTO_STEP</a>)) {
<a name="l01092"></a>01092             <span class="keywordtype">float</span> timestep = blscene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11e6b08a8678f04813637f658e867193">frs_sec_base</a>/blscene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a071df993e13c05fc37e6f9a82c0679f5">frs_sec</a>;
<a name="l01093"></a>01093             <span class="keywordflow">if</span> (ikparam-&gt;numstep &gt; 0)
<a name="l01094"></a>01094                 timestep /= ikparam-&gt;numstep;
<a name="l01095"></a>01095             <span class="comment">// with equal min and max, the algorythm will take this step and the indicative substep most of the time</span>
<a name="l01096"></a>01096             ikparam-&gt;minstep = ikparam-&gt;maxstep = timestep;
<a name="l01097"></a>01097             ikparam-&gt;flag |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811a6b39df95d371f6131b640edabf6c8f8a">ITASC_AUTO_STEP</a>;
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100     <span class="keywordflow">if</span> ((ikparam-&gt;flag &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811ac29cac956ec7d28c77ca1c5684773bbc">ITASC_SIMULATION</a>) &amp;&amp; !ingame)
<a name="l01101"></a>01101         <span class="comment">// no cache in animation mode</span>
<a name="l01102"></a>01102         ikscene-&gt;cache = <span class="keyword">new</span> <a class="code" href="../../d8/dcf/classiTaSC_1_1Cache.html">iTaSC::Cache</a>();
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="keywordflow">switch</span> (ikparam-&gt;solver) {
<a name="l01105"></a>01105     <span class="keywordflow">case</span> <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a0a85f1213c45e0da1bae86352357bcc9ac3b1ad87b81ba6681ba5b4f89ae7a209">ITASC_SOLVER_SDLS</a>:
<a name="l01106"></a>01106         ikscene-&gt;solver = <span class="keyword">new</span> <a class="code" href="../../d7/d96/classiTaSC_1_1WSDLSSolver.html">iTaSC::WSDLSSolver</a>();
<a name="l01107"></a>01107         <span class="keywordflow">break</span>;
<a name="l01108"></a>01108     <span class="keywordflow">case</span> <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a0a85f1213c45e0da1bae86352357bcc9ad41069f27bbe9654f8dbb827950169ee">ITASC_SOLVER_DLS</a>:
<a name="l01109"></a>01109         ikscene-&gt;solver = <span class="keyword">new</span> <a class="code" href="../../db/d50/classiTaSC_1_1WDLSSolver.html">iTaSC::WDLSSolver</a>();
<a name="l01110"></a>01110         <span class="keywordflow">break</span>;
<a name="l01111"></a>01111     <span class="keywordflow">default</span>:
<a name="l01112"></a>01112         <span class="keyword">delete</span> ikscene;
<a name="l01113"></a>01113         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01114"></a>01114     }
<a name="l01115"></a>01115     ikscene-&gt;blArmature = ob;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     std::string  joint;
<a name="l01118"></a>01118     std::string  root(<span class="stringliteral">&quot;root&quot;</span>);
<a name="l01119"></a>01119     std::string  parent;
<a name="l01120"></a>01120     std::vector&lt;double&gt; weights;
<a name="l01121"></a>01121     <span class="keywordtype">double</span> weight[3];
<a name="l01122"></a>01122     <span class="comment">// assume uniform scaling and take Y scale as general scale for the armature</span>
<a name="l01123"></a>01123     <span class="keywordtype">float</span> scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[1]);
<a name="l01124"></a>01124     <span class="comment">// build the array of joints corresponding to the IK chain</span>
<a name="l01125"></a>01125     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a20b973ffc077230e8e802bd7ca872cb7">convert_channels</a>(ikscene, tree);
<a name="l01126"></a>01126     <span class="keywordflow">if</span> (ingame) {
<a name="l01127"></a>01127         <span class="comment">// in the GE, set the initial joint angle to match the current pose</span>
<a name="l01128"></a>01128         <span class="comment">// this will update the jointArray in ikscene</span>
<a name="l01129"></a>01129         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4872bf7df3d3fa8ea9629146e0348386">convert_pose</a>(ikscene);
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131     <span class="keywordflow">else</span> {
<a name="l01132"></a>01132         <span class="comment">// in Blender, the rest pose is always 0 for joints</span>
<a name="l01133"></a>01133         <a class="code" href="../../d8/df5/BKE__action_8h.html#a4fd8f1724c534f7777be90116365ddfd">rest_pose</a>(ikscene);
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135     <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a> = &amp;ikscene-&gt;jointArray(0);
<a name="l01136"></a>01136     <span class="keywordflow">for</span> (a=0, ikchan = ikscene-&gt;channels; a&lt;tree-&gt;totchannel; ++a, ++ikchan) {
<a name="l01137"></a>01137         pchan= ikchan-&gt;pchan;
<a name="l01138"></a>01138         bone= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140         <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a> tip(<a class="code" href="../../d8/d76/namespaceiTaSC.html#a465a261ab4b279a8a5e0b96140721e72">iTaSC::F_identity</a>);
<a name="l01141"></a>01141         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ae72edf492db315ad02943cb9feac1c8e">Vector3</a> *fl = bone-&gt;bone_mat;
<a name="l01142"></a>01142         <a class="code" href="../../d0/d4e/classKDL_1_1Rotation.html" title="represents rotations in 3 dimensional space.">KDL::Rotation</a> brot(
<a name="l01143"></a>01143                            fl[0][0], fl[1][0], fl[2][0],
<a name="l01144"></a>01144                            fl[0][1], fl[1][1], fl[2][1],
<a name="l01145"></a>01145                            fl[0][2], fl[1][2], fl[2][2]);
<a name="l01146"></a>01146         <a class="code" href="../../db/d60/classKDL_1_1Vector.html" title="A concrete implementation of a 3 dimensional vector class.">KDL::Vector</a> bpos(bone-&gt;head[0], bone-&gt;head[1], bone-&gt;head[2]);
<a name="l01147"></a>01147         bpos = bpos*scale;
<a name="l01148"></a>01148         <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a> head(brot, bpos);
<a name="l01149"></a>01149         
<a name="l01150"></a>01150         <span class="comment">// rest pose length of the bone taking scaling into account</span>
<a name="l01151"></a>01151         <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>= bone-&gt;length*scale;
<a name="l01152"></a>01152         parent = (a &gt; 0) ? ikscene-&gt;channels[tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a]].tail : root;
<a name="l01153"></a>01153         <span class="comment">// first the fixed segment to the bone head</span>
<a name="l01154"></a>01154         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (head.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#abc00c3817f7baa985b67077479617866" title="origine of the Frame">p</a>.Norm() &gt; <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">KDL::epsilon</a> || head.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a367668b3344ccfd50410ccc1ed30fa6f" title="Orientation of the Frame.">M</a>.GetRot().Norm() &gt; <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">KDL::epsilon</a>) {
<a name="l01155"></a>01155             joint = bone-&gt;name;
<a name="l01156"></a>01156             joint += <span class="stringliteral">&quot;:H&quot;</span>;
<a name="l01157"></a>01157             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea4c8d7947a02e72496641ea3bac5c7b84">KDL::Joint::None</a>, 0.0, head);
<a name="l01158"></a>01158             parent = joint;
<a name="l01159"></a>01159         }
<a name="l01160"></a>01160         <span class="keywordflow">if</span> (!(ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)) {
<a name="l01161"></a>01161             <span class="comment">// fixed length, put it in tip</span>
<a name="l01162"></a>01162             tip.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#abc00c3817f7baa985b67077479617866" title="origine of the Frame">p</a>[1] = <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164         joint = bone-&gt;name;
<a name="l01165"></a>01165         weight[0] = (1.0-pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[0]);
<a name="l01166"></a>01166         weight[1] = (1.0-pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[1]);
<a name="l01167"></a>01167         weight[2] = (1.0-pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3f0b722fb54efa2297481ff3c306f394">stiffness</a>[2]);
<a name="l01168"></a>01168         <span class="keywordflow">switch</span> (ikchan-&gt;jointType &amp; ~<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)
<a name="l01169"></a>01169         {
<a name="l01170"></a>01170         <span class="keywordflow">case</span> 0:
<a name="l01171"></a>01171             <span class="comment">// fixed bone</span>
<a name="l01172"></a>01172             <span class="keywordflow">if</span> (!(ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)) {
<a name="l01173"></a>01173                 joint += <span class="stringliteral">&quot;:F&quot;</span>;
<a name="l01174"></a>01174                 ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea4c8d7947a02e72496641ea3bac5c7b84">KDL::Joint::None</a>, 0.0, tip);
<a name="l01175"></a>01175             }
<a name="l01176"></a>01176             <span class="keywordflow">break</span>;
<a name="l01177"></a>01177         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>:
<a name="l01178"></a>01178             <span class="comment">// RX only, get the X rotation</span>
<a name="l01179"></a>01179             joint += <span class="stringliteral">&quot;:RX&quot;</span>;
<a name="l01180"></a>01180             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea87b4021f0c0b1d9e8e21c7eb222a9f75">KDL::Joint::RotX</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0], tip);
<a name="l01181"></a>01181             weights.push_back(weight[0]);
<a name="l01182"></a>01182             <span class="keywordflow">break</span>;
<a name="l01183"></a>01183         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l01184"></a>01184             <span class="comment">// RY only, get the Y rotation</span>
<a name="l01185"></a>01185             joint += <span class="stringliteral">&quot;:RY&quot;</span>;
<a name="l01186"></a>01186             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea82ced6110c39092f0073540c041275e2">KDL::Joint::RotY</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0], tip);
<a name="l01187"></a>01187             weights.push_back(weight[1]);
<a name="l01188"></a>01188             <span class="keywordflow">break</span>;
<a name="l01189"></a>01189         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l01190"></a>01190             <span class="comment">// RZ only, get the Zz rotation</span>
<a name="l01191"></a>01191             joint += <span class="stringliteral">&quot;:RZ&quot;</span>;
<a name="l01192"></a>01192             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544eac218b252dc3dbaa7468cb23634e2392f">KDL::Joint::RotZ</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0], tip);
<a name="l01193"></a>01193             weights.push_back(weight[2]);
<a name="l01194"></a>01194             <span class="keywordflow">break</span>;
<a name="l01195"></a>01195         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l01196"></a>01196             joint += <span class="stringliteral">&quot;:RX&quot;</span>;
<a name="l01197"></a>01197             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea87b4021f0c0b1d9e8e21c7eb222a9f75">KDL::Joint::RotX</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0]);
<a name="l01198"></a>01198             weights.push_back(weight[0]);
<a name="l01199"></a>01199             <span class="keywordflow">if</span> (ret) {
<a name="l01200"></a>01200                 parent = joint;
<a name="l01201"></a>01201                 joint = bone-&gt;name;
<a name="l01202"></a>01202                 joint += <span class="stringliteral">&quot;:RY&quot;</span>;
<a name="l01203"></a>01203                 ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea82ced6110c39092f0073540c041275e2">KDL::Joint::RotY</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[1], tip);
<a name="l01204"></a>01204                 weights.push_back(weight[1]);
<a name="l01205"></a>01205             }
<a name="l01206"></a>01206             <span class="keywordflow">break</span>;
<a name="l01207"></a>01207         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>:
<a name="l01208"></a>01208             joint += <span class="stringliteral">&quot;:SW&quot;</span>;
<a name="l01209"></a>01209             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544eaef74701ff352a73a9cc271556e9a821d">KDL::Joint::Swing</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0], tip);
<a name="l01210"></a>01210             weights.push_back(weight[0]);
<a name="l01211"></a>01211             weights.push_back(weight[2]);
<a name="l01212"></a>01212             <span class="keywordflow">break</span>;
<a name="l01213"></a>01213         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>:
<a name="l01214"></a>01214             <span class="comment">// RZ+RY</span>
<a name="l01215"></a>01215             joint += <span class="stringliteral">&quot;:RZ&quot;</span>;
<a name="l01216"></a>01216             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544eac218b252dc3dbaa7468cb23634e2392f">KDL::Joint::RotZ</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0]);
<a name="l01217"></a>01217             weights.push_back(weight[2]);
<a name="l01218"></a>01218             <span class="keywordflow">if</span> (ret) {
<a name="l01219"></a>01219                 parent = joint;
<a name="l01220"></a>01220                 joint = bone-&gt;name;
<a name="l01221"></a>01221                 joint += <span class="stringliteral">&quot;:RY&quot;</span>;
<a name="l01222"></a>01222                 ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea82ced6110c39092f0073540c041275e2">KDL::Joint::RotY</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[1], tip);
<a name="l01223"></a>01223                 weights.push_back(weight[1]);
<a name="l01224"></a>01224             }
<a name="l01225"></a>01225             <span class="keywordflow">break</span>;
<a name="l01226"></a>01226         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>|<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>:
<a name="l01227"></a>01227             <span class="comment">// decompose in a Swing+RotY joint</span>
<a name="l01228"></a>01228             joint += <span class="stringliteral">&quot;:SW&quot;</span>;
<a name="l01229"></a>01229             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544eaef74701ff352a73a9cc271556e9a821d">KDL::Joint::Swing</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0]);
<a name="l01230"></a>01230             weights.push_back(weight[0]);
<a name="l01231"></a>01231             weights.push_back(weight[2]);
<a name="l01232"></a>01232             <span class="keywordflow">if</span> (ret) {
<a name="l01233"></a>01233                 parent = joint;
<a name="l01234"></a>01234                 joint = bone-&gt;name;
<a name="l01235"></a>01235                 joint += <span class="stringliteral">&quot;:RY&quot;</span>;
<a name="l01236"></a>01236                 ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea82ced6110c39092f0073540c041275e2">KDL::Joint::RotY</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[2], tip);
<a name="l01237"></a>01237                 weights.push_back(weight[1]);
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239             <span class="keywordflow">break</span>;
<a name="l01240"></a>01240         <span class="keywordflow">case</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a>:
<a name="l01241"></a>01241             joint += <span class="stringliteral">&quot;:SJ&quot;</span>;
<a name="l01242"></a>01242             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea1c1d369014ad8c0a0ffec60286449f74">KDL::Joint::Sphere</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[0], tip);
<a name="l01243"></a>01243             weights.push_back(weight[0]);
<a name="l01244"></a>01244             weights.push_back(weight[1]);
<a name="l01245"></a>01245             weights.push_back(weight[2]);
<a name="l01246"></a>01246             <span class="keywordflow">break</span>;
<a name="l01247"></a>01247         }
<a name="l01248"></a>01248         <span class="keywordflow">if</span> (ret &amp;&amp; (ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1bade9e58f9d3a4482083d9b6afa53ca9bc">IK_TRANSY</a>)) {
<a name="l01249"></a>01249             parent = joint;
<a name="l01250"></a>01250             joint = bone-&gt;name;
<a name="l01251"></a>01251             joint += <span class="stringliteral">&quot;:TY&quot;</span>;
<a name="l01252"></a>01252             ret = arm-&gt;addSegment(joint, parent, <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea5118e6fc6a5deee920b1378a17d7c29c">KDL::Joint::TransY</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[ikchan-&gt;ndof-1]);
<a name="l01253"></a>01253             <span class="keywordtype">float</span> ikstretch = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a>*pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9921be913e17f25f22c03924bbad7d71">ikstretch</a>;
<a name="l01254"></a>01254             weight[1] = (1.0-<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(1.0-ikstretch, 0.99));
<a name="l01255"></a>01255             weights.push_back(weight[1]);
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257         <span class="keywordflow">if</span> (!ret)
<a name="l01258"></a>01258             <span class="comment">// error making the armature??</span>
<a name="l01259"></a>01259             <span class="keywordflow">break</span>;
<a name="l01260"></a>01260         <span class="comment">// joint points to the segment that correspond to the bone per say</span>
<a name="l01261"></a>01261         ikchan-&gt;tail = joint;
<a name="l01262"></a>01262         ikchan-&gt;head = parent;
<a name="l01263"></a>01263         <span class="comment">// in case of error</span>
<a name="l01264"></a>01264         ret = <span class="keyword">false</span>;
<a name="l01265"></a>01265         <span class="keywordflow">if</span> ((ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba95c45665f8e1991a86f91ef449a23ebd">IK_XDOF</a>) &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>))) {
<a name="l01266"></a>01266             joint = bone-&gt;name;
<a name="l01267"></a>01267             joint += <span class="stringliteral">&quot;:RX&quot;</span>;
<a name="l01268"></a>01268             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>) {
<a name="l01269"></a>01269                 <span class="keywordflow">if</span> (arm-&gt;addLimitConstraint(joint, 0, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[0], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[0]) &lt; 0)
<a name="l01270"></a>01270                     <span class="keywordflow">break</span>;
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>) {
<a name="l01273"></a>01273                 <span class="keywordflow">if</span> (arm-&gt;addConstraint(joint, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>, ikchan, <span class="keyword">false</span>, <span class="keyword">false</span>) &lt; 0)
<a name="l01274"></a>01274                     <span class="keywordflow">break</span>;
<a name="l01275"></a>01275             }
<a name="l01276"></a>01276         }
<a name="l01277"></a>01277         <span class="keywordflow">if</span> ((ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1baabccf9895e61feb10f94b62f93e015e1">IK_YDOF</a>) &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2aaab5d511784c6381cd75b6f7e4df6118">BONE_IK_YLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>))) {
<a name="l01278"></a>01278             joint = bone-&gt;name;
<a name="l01279"></a>01279             joint += <span class="stringliteral">&quot;:RY&quot;</span>;
<a name="l01280"></a>01280             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2aaab5d511784c6381cd75b6f7e4df6118">BONE_IK_YLIMIT</a>) {
<a name="l01281"></a>01281                 <span class="keywordflow">if</span> (arm-&gt;addLimitConstraint(joint, 0, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[1], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[1]) &lt; 0)
<a name="l01282"></a>01282                     <span class="keywordflow">break</span>;
<a name="l01283"></a>01283             }
<a name="l01284"></a>01284             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>) {
<a name="l01285"></a>01285                 <span class="keywordflow">if</span> (arm-&gt;addConstraint(joint, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>, ikchan, <span class="keyword">false</span>, <span class="keyword">false</span>) &lt; 0)
<a name="l01286"></a>01286                     <span class="keywordflow">break</span>;
<a name="l01287"></a>01287             }
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289         <span class="keywordflow">if</span> ((ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba0ed5d2e5a9fa8cb8bddd021e5ff809ff">IK_ZDOF</a>) &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>))) {
<a name="l01290"></a>01290             joint = bone-&gt;name;
<a name="l01291"></a>01291             joint += <span class="stringliteral">&quot;:RZ&quot;</span>;
<a name="l01292"></a>01292             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>) {
<a name="l01293"></a>01293                 <span class="keywordflow">if</span> (arm-&gt;addLimitConstraint(joint, 0, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[2], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[2]) &lt; 0)
<a name="l01294"></a>01294                     <span class="keywordflow">break</span>;
<a name="l01295"></a>01295             }
<a name="l01296"></a>01296             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>) {
<a name="l01297"></a>01297                 <span class="keywordflow">if</span> (arm-&gt;addConstraint(joint, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>, ikchan, <span class="keyword">false</span>, <span class="keyword">false</span>) &lt; 0)
<a name="l01298"></a>01298                     <span class="keywordflow">break</span>;
<a name="l01299"></a>01299             }
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301         <span class="keywordflow">if</span> ((ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba3022a8855fa0d6981e148b92ba092f8d">IK_SWING</a>) &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>))) {
<a name="l01302"></a>01302             joint = bone-&gt;name;
<a name="l01303"></a>01303             joint += <span class="stringliteral">&quot;:SW&quot;</span>;
<a name="l01304"></a>01304             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a350d6c5f7bd2312b331c0ec365707f8d">BONE_IK_XLIMIT</a>) {
<a name="l01305"></a>01305                 <span class="keywordflow">if</span> (arm-&gt;addLimitConstraint(joint, 0, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[0], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[0]) &lt; 0)
<a name="l01306"></a>01306                     <span class="keywordflow">break</span>;
<a name="l01307"></a>01307             }
<a name="l01308"></a>01308             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a006f6ec03756fcc0adab56c860dcb5c3">BONE_IK_ZLIMIT</a>) {
<a name="l01309"></a>01309                 <span class="keywordflow">if</span> (arm-&gt;addLimitConstraint(joint, 1, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a2b5b827016a19c9a839d1f06b3e6ca68">limitmin</a>[2], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a04689447b807d93a11d9c96c6446a892">limitmax</a>[2]) &lt; 0)
<a name="l01310"></a>01310                     <span class="keywordflow">break</span>;
<a name="l01311"></a>01311             }
<a name="l01312"></a>01312             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>) {
<a name="l01313"></a>01313                 <span class="keywordflow">if</span> (arm-&gt;addConstraint(joint, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>, ikchan, <span class="keyword">false</span>, <span class="keyword">false</span>) &lt; 0)
<a name="l01314"></a>01314                     <span class="keywordflow">break</span>;
<a name="l01315"></a>01315             }
<a name="l01316"></a>01316         }
<a name="l01317"></a>01317         <span class="keywordflow">if</span> ((ikchan-&gt;jointType &amp; <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7d8ed4938d862f03bc6c8e7b9c18be1ba10cef6ced9929e56c53301a0e262f32b">IK_REVOLUTE</a>) &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a32f7786f7d6a6e9ec2bf7ed96d705335">ikflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a92cd826639e3f56ccd271b281f1f2cc2a89759db0765d0433074b26fe462ef8c2">BONE_IK_ROTCTL</a>)) {
<a name="l01318"></a>01318             joint = bone-&gt;name;
<a name="l01319"></a>01319             joint += <span class="stringliteral">&quot;:SJ&quot;</span>;
<a name="l01320"></a>01320             <span class="keywordflow">if</span> (arm-&gt;addConstraint(joint, <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a7aff55990c3a1e5f71048808b2378409">joint_callback</a>, ikchan, <span class="keyword">false</span>, <span class="keyword">false</span>) &lt; 0)
<a name="l01321"></a>01321                 <span class="keywordflow">break</span>;
<a name="l01322"></a>01322         }
<a name="l01323"></a>01323         <span class="comment">//  no error, so restore</span>
<a name="l01324"></a>01324         ret = <span class="keyword">true</span>;
<a name="l01325"></a>01325         <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a> += ikchan-&gt;ndof;
<a name="l01326"></a>01326     }
<a name="l01327"></a>01327     <span class="keywordflow">if</span> (!ret) {
<a name="l01328"></a>01328         <span class="keyword">delete</span> ikscene;
<a name="l01329"></a>01329         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01330"></a>01330     }
<a name="l01331"></a>01331     <span class="comment">// for each target, we need to add an end effector in the armature</span>
<a name="l01332"></a>01332     <span class="keywordflow">for</span> (numtarget=0, polarcon=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ret = <span class="keyword">true</span>, target=(<a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a>*)tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; target; target=(<a class="code" href="../../d0/db4/structPoseTarget.html">PoseTarget</a>*)target-&gt;next) {
<a name="l01333"></a>01333         condata= (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)target-&gt;con-&gt;data;
<a name="l01334"></a>01334         pchan = tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[target-&gt;tip];
<a name="l01335"></a>01335 
<a name="l01336"></a>01336         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aaceb1fa99434d30211fe3c94c749f959">is_cartesian_constraint</a>(target-&gt;con)) {
<a name="l01337"></a>01337             <span class="comment">// add the end effector</span>
<a name="l01338"></a>01338             <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget = <span class="keyword">new</span> <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>();
<a name="l01339"></a>01339             ikscene-&gt;targets.push_back(iktarget);
<a name="l01340"></a>01340             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">ee</a> = arm-&gt;addEndEffector(ikscene-&gt;channels[target-&gt;tip].tail);
<a name="l01341"></a>01341             <span class="keywordflow">if</span> (iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae27c0c8ca9738cce3cd32d4bb52e1c0a">ee</a> == -1) {
<a name="l01342"></a>01342                 ret = <span class="keyword">false</span>;
<a name="l01343"></a>01343                 <span class="keywordflow">break</span>;
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345             <span class="comment">// initialize all the fields that we can set at this time</span>
<a name="l01346"></a>01346             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a> = target-&gt;con;
<a name="l01347"></a>01347             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a> = target-&gt;tip;
<a name="l01348"></a>01348             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af4344625f6536f3889aa8a0416e483b3">simulation</a> = (ikparam-&gt;flag &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811ac29cac956ec7d28c77ca1c5684773bbc">ITASC_SIMULATION</a>);
<a name="l01349"></a>01349             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a7c57f040f2169958beb6a61051feb644">rootChannel</a> = ikscene-&gt;channels[0].pchan;
<a name="l01350"></a>01350             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#afadaa21d33535bce4a08e035b16260b7">owner</a> = ob;
<a name="l01351"></a>01351             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>;
<a name="l01352"></a>01352             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a> += <span class="stringliteral">&quot;:T:&quot;</span>;
<a name="l01353"></a>01353             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a> += target-&gt;con-&gt;name;
<a name="l01354"></a>01354             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>;
<a name="l01355"></a>01355             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a> += <span class="stringliteral">&quot;:C:&quot;</span>;
<a name="l01356"></a>01356             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a> += target-&gt;con-&gt;name;
<a name="l01357"></a>01357             numtarget++;
<a name="l01358"></a>01358             <span class="keywordflow">if</span> (condata-&gt;poletar)
<a name="l01359"></a>01359                 <span class="comment">// this constraint has a polar target</span>
<a name="l01360"></a>01360                 polarcon = target-&gt;con;
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     <span class="comment">// deal with polar target if any</span>
<a name="l01364"></a>01364     <span class="keywordflow">if</span> (numtarget == 1 &amp;&amp; polarcon) {
<a name="l01365"></a>01365         ikscene-&gt;polarConstraint = polarcon;
<a name="l01366"></a>01366     }
<a name="l01367"></a>01367     <span class="comment">// we can now add the armature</span>
<a name="l01368"></a>01368     <span class="comment">// the armature is based on a moving frame. </span>
<a name="l01369"></a>01369     <span class="comment">// initialize with the correct position in case there is no cache</span>
<a name="l01370"></a>01370     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2c1680d5b097436f09e74be7fe7e2355">base_callback</a>(<a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>(), <a class="code" href="../../d8/d76/namespaceiTaSC.html#a465a261ab4b279a8a5e0b96140721e72">iTaSC::F_identity</a>, initPose, ikscene);
<a name="l01371"></a>01371     ikscene-&gt;base = <span class="keyword">new</span> <a class="code" href="../../d4/dc0/classiTaSC_1_1MovingFrame.html">iTaSC::MovingFrame</a>(initPose);
<a name="l01372"></a>01372     ikscene-&gt;base-&gt;setCallback(<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2c1680d5b097436f09e74be7fe7e2355">base_callback</a>, ikscene);
<a name="l01373"></a>01373     std::string armname;
<a name="l01374"></a>01374     armname = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>;
<a name="l01375"></a>01375     armname += <span class="stringliteral">&quot;:B&quot;</span>;
<a name="l01376"></a>01376     ret = scene-&gt;addObject(armname, ikscene-&gt;base);
<a name="l01377"></a>01377     armname = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>;
<a name="l01378"></a>01378     armname += <span class="stringliteral">&quot;:AR&quot;</span>;
<a name="l01379"></a>01379     <span class="keywordflow">if</span> (ret)
<a name="l01380"></a>01380         ret = scene-&gt;addObject(armname, ikscene-&gt;armature, ikscene-&gt;base);
<a name="l01381"></a>01381     <span class="keywordflow">if</span> (!ret) {
<a name="l01382"></a>01382         <span class="keyword">delete</span> ikscene;
<a name="l01383"></a>01383         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01384"></a>01384     }
<a name="l01385"></a>01385     <span class="comment">// set the weight</span>
<a name="l01386"></a>01386     <a class="code" href="../../da/d26/eigen__types_8hpp.html#aca3a13c479502f0b1e9cb117c2b85f76">e_matrix</a>&amp; Wq = arm-&gt;getWq();
<a name="l01387"></a>01387     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(Wq.cols() == (int)weights.size());
<a name="l01388"></a>01388     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> q=0; q&lt;Wq.cols(); q++)
<a name="l01389"></a>01389         Wq(q,q)=weights[q];
<a name="l01390"></a>01390     <span class="comment">// get the inverse rest pose frame of the base to compute relative rest pose of end effectors</span>
<a name="l01391"></a>01391     <span class="comment">// this is needed to handle the enforce parameter</span>
<a name="l01392"></a>01392     <span class="comment">// ikscene-&gt;pchan[0] is the root channel of the tree</span>
<a name="l01393"></a>01393     <span class="comment">// if it has no parent, then it&#39;s just the identify Frame</span>
<a name="l01394"></a>01394     <span class="keywordtype">float</span> invBaseFrame[4][4];
<a name="l01395"></a>01395     pchan = ikscene-&gt;channels[0].pchan;
<a name="l01396"></a>01396     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l01397"></a>01397         <span class="comment">// it has a parent, get the pose matrix from it </span>
<a name="l01398"></a>01398         <span class="keywordtype">float</span> baseFrame[4][4];
<a name="l01399"></a>01399         pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;  
<a name="l01400"></a>01400         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(baseFrame, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01401"></a>01401         <span class="comment">// move to the tail and scale to get rest pose of armature base</span>
<a name="l01402"></a>01402         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(baseFrame[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l01403"></a>01403         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(invBaseFrame, baseFrame);
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405     <span class="keywordflow">else</span> {
<a name="l01406"></a>01406         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(invBaseFrame);
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408     <span class="comment">// finally add the constraint</span>
<a name="l01409"></a>01409     <span class="keywordflow">for</span> (t=0; t&lt;ikscene-&gt;targets.size(); t++) {
<a name="l01410"></a>01410         <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget = ikscene-&gt;targets[t];
<a name="l01411"></a>01411         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a5dea933c516062d9ae6e1c4e634b9c1a">blscene</a> = blscene;
<a name="l01412"></a>01412         condata= (<a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a>*)iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l01413"></a>01413         pchan = tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>];
<a name="l01414"></a>01414         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> controltype, bonecnt;
<a name="l01415"></a>01415         <span class="keywordtype">double</span> bonelen;
<a name="l01416"></a>01416         <span class="keywordtype">float</span> mat[4][4];
<a name="l01417"></a>01417 
<a name="l01418"></a>01418         <span class="comment">// add the end effector</span>
<a name="l01419"></a>01419         <span class="comment">// estimate the average bone length, used to clamp feedback error</span>
<a name="l01420"></a>01420         for (bonecnt=0, bonelen=0.f, a=iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>; a&gt;=0; a=tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>[a], bonecnt++)
<a name="l01421"></a>01421             bonelen += scale*tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>[a]-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l01422"></a>01422         bonelen /= bonecnt;     
<a name="l01423"></a>01423 
<a name="l01424"></a>01424         <span class="comment">// store the rest pose of the end effector to compute enforce target</span>
<a name="l01425"></a>01425         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01426"></a>01426         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l01427"></a>01427         <span class="comment">// get the rest pose relative to the armature base</span>
<a name="l01428"></a>01428         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#af016dc6cd40942bc33d5a97d54d7ea78">eeRest</a>, invBaseFrame, mat);
<a name="l01429"></a>01429         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ab32a86fb4a7008478645551fc2fa6009">eeBlend</a> = (!ikscene-&gt;polarConstraint &amp;&amp; condata-&gt;type==<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a43ffcba0a3cf59e6603321856a38b071a1ff09193535d2dec4ed60beb3fe5b202">CONSTRAINT_IK_COPYPOSE</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01430"></a>01430         <span class="comment">// use target_callback to make sure the initPose includes enforce coefficient</span>
<a name="l01431"></a>01431         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2529dcf9a927e15241c49d91227a11a1">target_callback</a>(<a class="code" href="../../d0/d55/structiTaSC_1_1Timestamp.html">iTaSC::Timestamp</a>(), <a class="code" href="../../d8/d76/namespaceiTaSC.html#a465a261ab4b279a8a5e0b96140721e72">iTaSC::F_identity</a>, initPose, iktarget);
<a name="l01432"></a>01432         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a> = <span class="keyword">new</span> <a class="code" href="../../d4/dc0/classiTaSC_1_1MovingFrame.html">iTaSC::MovingFrame</a>(initPose);
<a name="l01433"></a>01433         iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>-&gt;<a class="code" href="../../d4/dc0/classiTaSC_1_1MovingFrame.html#a6613f51e87c6ac8092e5e40a47dee0b6">setCallback</a>(<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2529dcf9a927e15241c49d91227a11a1">target_callback</a>, iktarget);
<a name="l01434"></a>01434         ret = scene-&gt;addObject(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae7d8ee02359d589dad6f5fd3b5d8bec0">target</a>);
<a name="l01435"></a>01435         <span class="keywordflow">if</span> (!ret)
<a name="l01436"></a>01436             <span class="keywordflow">break</span>;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438         <span class="keywordflow">switch</span> (condata-&gt;type) {
<a name="l01439"></a>01439         <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a43ffcba0a3cf59e6603321856a38b071a1ff09193535d2dec4ed60beb3fe5b202">CONSTRAINT_IK_COPYPOSE</a>:
<a name="l01440"></a>01440             controltype = 0;
<a name="l01441"></a>01441             <span class="keywordflow">if</span> (condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da0251808fa77e7c319acdfdfa82960545">CONSTRAINT_IK_ROT</a>) {
<a name="l01442"></a>01442                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da0754fa975b4743f7d68434b6da28ad44">CONSTRAINT_IK_NO_ROT_X</a>))
<a name="l01443"></a>01443                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a741ddc3adee43928ae933f2f6e7bdf90">iTaSC::CopyPose::CTL_ROTATIONX</a>;
<a name="l01444"></a>01444                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da715bf91e49e0c6ec69800a4adec20dd0">CONSTRAINT_IK_NO_ROT_Y</a>))
<a name="l01445"></a>01445                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ac8f99fd7e76569a475419b9a51663019">iTaSC::CopyPose::CTL_ROTATIONY</a>;
<a name="l01446"></a>01446                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da87a9f467a7eb8d3819e6ba68bd71daa4">CONSTRAINT_IK_NO_ROT_Z</a>))
<a name="l01447"></a>01447                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a621a858ce58a24a245d418bc5f33fcb4">iTaSC::CopyPose::CTL_ROTATIONZ</a>;
<a name="l01448"></a>01448             }
<a name="l01449"></a>01449             <span class="keywordflow">if</span> (condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da75642965ec8713397d0e81cb9fa4f5d4">CONSTRAINT_IK_POS</a>) {
<a name="l01450"></a>01450                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da87a9e3624f944a4c00f9909994e6230d">CONSTRAINT_IK_NO_POS_X</a>))
<a name="l01451"></a>01451                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0accd38964e38bd7d592b126ed700273dc">iTaSC::CopyPose::CTL_POSITIONX</a>;
<a name="l01452"></a>01452                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da38322b3de4ca48da8dae6aafee25eb4f">CONSTRAINT_IK_NO_POS_Y</a>))
<a name="l01453"></a>01453                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ac5a2de6a1dca359c7b6804cbece155ed">iTaSC::CopyPose::CTL_POSITIONY</a>;
<a name="l01454"></a>01454                 <span class="keywordflow">if</span> (!(condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da1d8c427864ffe5715ca1dc43be021dc2">CONSTRAINT_IK_NO_POS_Z</a>))
<a name="l01455"></a>01455                     controltype |= <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a545876da03edd7993376342211d65857">iTaSC::CopyPose::CTL_POSITIONZ</a>;
<a name="l01456"></a>01456             }
<a name="l01457"></a>01457             <span class="keywordflow">if</span> (controltype) {
<a name="l01458"></a>01458                 iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a> = <span class="keyword">new</span> <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html">iTaSC::CopyPose</a>(controltype, controltype, bonelen);
<a name="l01459"></a>01459                 <span class="comment">// set the gain</span>
<a name="l01460"></a>01460                 <span class="keywordflow">if</span> (controltype &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0a1840b8e171009040b836a9bbf46044e7">iTaSC::CopyPose::CTL_POSITION</a>)
<a name="l01461"></a>01461                     iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a148d1f445dc7e6d117ceae1a231ed1ed">setControlParameter</a>(<a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#af67f856d165ca1ab62be8b065b1599e1ad4e94ed9af9b45934408bb87830ba04f">iTaSC::CopyPose::ID_POSITION</a>, <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>, condata-&gt;weight);
<a name="l01462"></a>01462                 <span class="keywordflow">if</span> (controltype &amp; <a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#aca507ce4dcd43ec33be3ac5715d3acd0ab253d49bbc8e172f61512177c90f68a2">iTaSC::CopyPose::CTL_ROTATION</a>)
<a name="l01463"></a>01463                     iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a148d1f445dc7e6d117ceae1a231ed1ed">setControlParameter</a>(<a class="code" href="../../d4/de3/classiTaSC_1_1CopyPose.html#af67f856d165ca1ab62be8b065b1599e1a7eec3a3a45c4c5bffda9962699b184ab">iTaSC::CopyPose::ID_ROTATION</a>, <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776ad25c52f978cb292fbec2d5cd2803ee89">iTaSC::ACT_ALPHA</a>, condata-&gt;orientweight);
<a name="l01464"></a>01464                 iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a69b584277b7e961ccc55f863b8b7f1e8">registerCallback</a>(<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4a49011b14a30a1eea6a419c2d7ca795">copypose_callback</a>, iktarget);
<a name="l01465"></a>01465                 iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae0ef60c0964c9bff1bb4a32c46019fcc">errorCallback</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a99965d7d4420d94679f52f558dd18156">copypose_error</a>;
<a name="l01466"></a>01466                 iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2f77d06e4bfa72354010bfda0983444c">controlType</a> = controltype;
<a name="l01467"></a>01467                 <span class="comment">// add the constraint</span>
<a name="l01468"></a>01468                 <span class="keywordflow">if</span> (condata-&gt;flag &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a151d60aa5af580c422f4b8a2f855af5da1228bf5c4a060483b9f987ca1d29b25b">CONSTRAINT_IK_TARGETAXIS</a>)
<a name="l01469"></a>01469                     ret = scene-&gt;addConstraintSet(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a>, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>, armname, <span class="stringliteral">&quot;&quot;</span>, ikscene-&gt;channels[iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>].tail);
<a name="l01470"></a>01470                 <span class="keywordflow">else</span>
<a name="l01471"></a>01471                     ret = scene-&gt;addConstraintSet(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a>, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>, armname, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>, ikscene-&gt;channels[iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>].tail);
<a name="l01472"></a>01472             }
<a name="l01473"></a>01473             <span class="keywordflow">break</span>;
<a name="l01474"></a>01474         <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a43ffcba0a3cf59e6603321856a38b071a677da30ef4c330c359f2aaf6292a6f42">CONSTRAINT_IK_DISTANCE</a>:
<a name="l01475"></a>01475             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a> = <span class="keyword">new</span> <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a97638ab45770a5bc48ade363ac887c91">iTaSC::Distance</a>(bonelen);
<a name="l01476"></a>01476             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a148d1f445dc7e6d117ceae1a231ed1ed">setControlParameter</a>(<a class="code" href="../../d4/d1b/classiTaSC_1_1Distance.html#a6e033c83f1db3c357cb46706f719f85ca58fda2c26fbcbabf3ceb542ba805202c">iTaSC::Distance::ID_DISTANCE</a>, <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a827f5dae378d65d40a925ebb7a11bd8a">iTaSC::ACT_VALUE</a>, condata-&gt;dist);
<a name="l01477"></a>01477             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a69b584277b7e961ccc55f863b8b7f1e8">registerCallback</a>(<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#af653c20b853eb92b5f452a2e92b7ba6e">distance_callback</a>, iktarget);
<a name="l01478"></a>01478             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae0ef60c0964c9bff1bb4a32c46019fcc">errorCallback</a> = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a125126876f885122a501ce041196df3b">distance_error</a>;
<a name="l01479"></a>01479             <span class="comment">// we can update the weight on each substep</span>
<a name="l01480"></a>01480             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#a667016064e6910f94f8e00a7eb44062c">substep</a>(<span class="keyword">true</span>);
<a name="l01481"></a>01481             <span class="comment">// add the constraint</span>
<a name="l01482"></a>01482             ret = scene-&gt;addConstraintSet(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a54d6d5c59c3c9459c68f4f1d4791aa70">constraintName</a>, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>, armname, iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a2af51638910ae6875f338cd0d043f01e">targetName</a>, ikscene-&gt;channels[iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#aee13c3499dcc95a385221aed1fb288f4">channel</a>].tail);
<a name="l01483"></a>01483             <span class="keywordflow">break</span>;
<a name="l01484"></a>01484         }
<a name="l01485"></a>01485         <span class="keywordflow">if</span> (!ret)
<a name="l01486"></a>01486             <span class="keywordflow">break</span>;
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (!ret ||
<a name="l01489"></a>01489         !scene-&gt;addCache(ikscene-&gt;cache) ||
<a name="l01490"></a>01490         !scene-&gt;addSolver(ikscene-&gt;solver) ||
<a name="l01491"></a>01491         !scene-&gt;initialize()) {
<a name="l01492"></a>01492         <span class="keyword">delete</span> ikscene;
<a name="l01493"></a>01493         ikscene = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01494"></a>01494     }
<a name="l01495"></a>01495     <span class="keywordflow">return</span> ikscene;
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 
<a name="l01498"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a757e04f585c01b9a91847c45ea8c2cb5">01498</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a757e04f585c01b9a91847c45ea8c2cb5">create_scene</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01499"></a>01499 {
<a name="l01500"></a>01500     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01501"></a>01501 
<a name="l01502"></a>01502     <span class="comment">// create the IK scene</span>
<a name="l01503"></a>01503     <span class="keywordflow">for</span> (pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01504"></a>01504         <span class="comment">// by construction there is only one tree</span>
<a name="l01505"></a>01505         <a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a> *tree = (<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>*)pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01506"></a>01506         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (tree) {
<a name="l01507"></a>01507             <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* ikdata = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a1e11539815ee950e870f1ac4d346661d">get_ikdata</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01508"></a>01508             <span class="comment">// convert tree in iTaSC::Scene</span>
<a name="l01509"></a>01509             <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene = <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a240ba87e062ebcd513d68f9991ca6c37">convert_tree</a>(scene, ob, pchan);
<a name="l01510"></a>01510             <span class="keywordflow">if</span> (ikscene) {
<a name="l01511"></a>01511                 ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a> = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>;
<a name="l01512"></a>01512                 ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a> = ikscene;
<a name="l01513"></a>01513             }
<a name="l01514"></a>01514             <span class="comment">// delete the trees once we are done</span>
<a name="l01515"></a>01515             <span class="keywordflow">while</span>(tree) {
<a name="l01516"></a>01516                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>, tree);
<a name="l01517"></a>01517                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a3d3abc017d6c27f9689f444910d3e4f6">targets</a>);
<a name="l01518"></a>01518                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a53485586f1e9692196a03515f38640ef">pchan</a>);
<a name="l01519"></a>01519                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a7f94d99560e135779b8e890ba7d871bf">parent</a>);
<a name="l01520"></a>01520                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d1/d20/structPoseTree.html#a0c891748f460e16bd864d5a5d7c6d5f8">basis_change</a>);
<a name="l01521"></a>01521                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree);
<a name="l01522"></a>01522                 tree = (<a class="code" href="../../d1/d20/structPoseTree.html">PoseTree</a>*)pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a416338ec6145ec77f78c2eb60f3415d3">iktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01523"></a>01523             }
<a name="l01524"></a>01524         }
<a name="l01525"></a>01525     }
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 
<a name="l01528"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#adda11e906cd7e4cfffcce2f5f7dfa94b">01528</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#adda11e906cd7e4cfffcce2f5f7dfa94b">init_scene</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01529"></a>01529 {
<a name="l01530"></a>01530     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>) {
<a name="l01531"></a>01531         <span class="keywordflow">for</span> (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* scene = ((<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>)-&gt;first;
<a name="l01532"></a>01532             scene != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01533"></a>01533             scene = scene-&gt;next) {
<a name="l01534"></a>01534             scene-&gt;channels[0].pchan-&gt;flag |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a109821706241e25864cface202adbe0c">POSE_IKTREE</a>;
<a name="l01535"></a>01535         }
<a name="l01536"></a>01536     }
<a name="l01537"></a>01537 }
<a name="l01538"></a>01538 
<a name="l01539"></a><a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aff93d5c13ebb1828a2c5ee3dfd9c536a">01539</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aff93d5c13ebb1828a2c5ee3dfd9c536a">execute_scene</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a>* blscene, <a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene, <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam, <span class="keywordtype">float</span> ctime, <span class="keywordtype">float</span> frtime)
<a name="l01540"></a>01540 {
<a name="l01541"></a>01541     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01542"></a>01542     <a class="code" href="../../d5/db2/structIK__Channel.html">IK_Channel</a>* ikchan;
<a name="l01543"></a>01543     <span class="keywordflow">if</span> (ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#ac59ef277dafaf02c7bd1953d78ae9e18">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811ac29cac956ec7d28c77ca1c5684773bbc">ITASC_SIMULATION</a>) {
<a name="l01544"></a>01544         <span class="keywordflow">for</span> (i=0, ikchan=ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; i&lt;ikscene-&gt;numchan; i++, ++ikchan) {
<a name="l01545"></a>01545             <span class="comment">// In simulation mode we don&#39;t allow external contraint to change our bones, mark the channel done</span>
<a name="l01546"></a>01546             <span class="comment">// also tell Blender that this channel is part of IK tree (cleared on each where_is_pose()</span>
<a name="l01547"></a>01547             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>);
<a name="l01548"></a>01548             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a> = 0;
<a name="l01549"></a>01549         }
<a name="l01550"></a>01550     }
<a name="l01551"></a>01551     <span class="keywordflow">else</span> {
<a name="l01552"></a>01552         <span class="comment">// in animation mode, we must get the bone position from action and constraints</span>
<a name="l01553"></a>01553         <span class="keywordflow">for</span> (i=0, ikchan=ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; i&lt;ikscene-&gt;numchan; i++, ++ikchan) {
<a name="l01554"></a>01554             <span class="keywordflow">if</span> (!(ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>))
<a name="l01555"></a>01555                 <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(blscene, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a002b4aa92d19842b99515c6b6048c289">blArmature</a>, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>, ctime, 1);
<a name="l01556"></a>01556             <span class="comment">// tell blender that this channel was controlled by IK, it&#39;s cleared on each where_is_pose()</span>
<a name="l01557"></a>01557             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= (<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>);
<a name="l01558"></a>01558             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#ae21b26ff0e5aefbfd970bc98f0a42dff">jointValid</a> = 0;
<a name="l01559"></a>01559         }
<a name="l01560"></a>01560     }
<a name="l01561"></a>01561     <span class="comment">// only run execute the scene if at least one of our target is enabled</span>
<a name="l01562"></a>01562     <span class="keywordflow">for</span> (i=ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>.size(); i &gt; 0; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01563"></a>01563         <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>[i-1];
<a name="l01564"></a>01564         <span class="keywordflow">if</span> (!(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>))
<a name="l01565"></a>01565             <span class="keywordflow">break</span>;
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567     <span class="keywordflow">if</span> (i == 0 &amp;&amp; ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d7/d5b/classiTaSC_1_1ControlledObject.html#a83f2755e735c16763499a0216fadbd40">getNrOfConstraints</a>() == 0)
<a name="l01568"></a>01568         <span class="comment">// all constraint disabled</span>
<a name="l01569"></a>01569         <span class="keywordflow">return</span>;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571     <span class="comment">// compute timestep</span>
<a name="l01572"></a>01572     <span class="keywordtype">double</span> timestamp = ctime * frtime + 2147483.648;
<a name="l01573"></a>01573     <span class="keywordtype">double</span> timestep = frtime;
<a name="l01574"></a>01574     <span class="keywordtype">bool</span> reiterate = (ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#ac59ef277dafaf02c7bd1953d78ae9e18">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811a1a8d0b51ff44d57790f2abaf0106b8c1">ITASC_REITERATION</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l01575"></a>01575     <span class="keywordtype">int</span> numstep = (ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#ac59ef277dafaf02c7bd1953d78ae9e18">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811a6b39df95d371f6131b640edabf6c8f8a">ITASC_AUTO_STEP</a>) ? 0 : ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a9b65482bd207ff81f86c1c521afeb108">numstep</a>;
<a name="l01576"></a>01576     <span class="keywordtype">bool</span> simulation = <span class="keyword">true</span>;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#ac59ef277dafaf02c7bd1953d78ae9e18">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811ac29cac956ec7d28c77ca1c5684773bbc">ITASC_SIMULATION</a>) {
<a name="l01579"></a>01579         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a28586300e60385b7cf2f349e0743abb5">solver</a>-&gt;<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#add098489e843815a6269a1ae2e7d398b">setParam</a>(<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#a49b6b16c75c07fa810e1cac57b706972a8aab9d0a0bf176a7ea4b4c0b4946acbf">iTaSC::Solver::DLS_QMAX</a>, ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a998d6d1119a9b4e268a1c640ba9cef1c">maxvel</a>);
<a name="l01580"></a>01580     } 
<a name="l01581"></a>01581     <span class="keywordflow">else</span> {
<a name="l01582"></a>01582         <span class="comment">// in animation mode we start from the pose after action and constraint</span>
<a name="l01583"></a>01583         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4872bf7df3d3fa8ea9629146e0348386">convert_pose</a>(ikscene);
<a name="l01584"></a>01584         ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#aabf8a1a8fca915913b73bc9320795aa9">setJointArray</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a380e6dad88467c1bb94441a5af7e0a03">jointArray</a>);
<a name="l01585"></a>01585         <span class="comment">// and we don&#39;t handle velocity</span>
<a name="l01586"></a>01586         reiterate = <span class="keyword">true</span>;
<a name="l01587"></a>01587         simulation = <span class="keyword">false</span>;
<a name="l01588"></a>01588         <span class="comment">// time is virtual, so take fixed value for velocity parameters (see itasc_update_param)</span>
<a name="l01589"></a>01589         <span class="comment">// and choose 1s timestep to allow having velocity parameters in radiant </span>
<a name="l01590"></a>01590         timestep = 1.0;
<a name="l01591"></a>01591         <span class="comment">// use auto setup to let the solver test the variation of the joints</span>
<a name="l01592"></a>01592         numstep = 0;
<a name="l01593"></a>01593     }
<a name="l01594"></a>01594         
<a name="l01595"></a>01595     <span class="keywordflow">if</span> (ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a> &amp;&amp; !reiterate &amp;&amp; simulation) {
<a name="l01596"></a>01596         <a class="code" href="../../d8/d76/namespaceiTaSC.html#a7e56bc652945f4479a528453b72679f3">iTaSC::CacheTS</a> sts, cts;
<a name="l01597"></a>01597         sts = cts = (<a class="code" href="../../d8/d76/namespaceiTaSC.html#a7e56bc652945f4479a528453b72679f3">iTaSC::CacheTS</a>)(timestamp*1000.0+0.5);
<a name="l01598"></a>01598         <span class="keywordflow">if</span> (ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a6f286a78fdee27883443f58bdb882d6f">cache</a>-&gt;<a class="code" href="../../d8/dcf/classiTaSC_1_1Cache.html#ad3bc83ca636c5e76f255dd765a6f310f">getPreviousCacheItem</a>(ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>, 0, &amp;cts) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || cts == 0) {
<a name="l01599"></a>01599             <span class="comment">// the cache is empty before this time, reiterate</span>
<a name="l01600"></a>01600             <span class="keywordflow">if</span> (ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#ac59ef277dafaf02c7bd1953d78ae9e18">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811aef3ccac32e1726f51c5e1aa29d96ecc3">ITASC_INITIAL_REITERATION</a>)
<a name="l01601"></a>01601                 reiterate = <span class="keyword">true</span>;
<a name="l01602"></a>01602         }
<a name="l01603"></a>01603         <span class="keywordflow">else</span> {
<a name="l01604"></a>01604             <span class="comment">// can take the cache as a start point.</span>
<a name="l01605"></a>01605             sts -= cts;
<a name="l01606"></a>01606             timestep = sts/1000.0;
<a name="l01607"></a>01607         }
<a name="l01608"></a>01608     }
<a name="l01609"></a>01609     <span class="comment">// don&#39;t cache if we are reiterating because we don&#39;t want to distroy the cache unnecessarily</span>
<a name="l01610"></a>01610     ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>-&gt;<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a92c7a5d90a7bfd5071733f8629c1d035">update</a>(timestamp, timestep, numstep, <span class="keyword">false</span>, !reiterate, simulation);
<a name="l01611"></a>01611     <span class="keywordflow">if</span> (reiterate) {
<a name="l01612"></a>01612         <span class="comment">// how many times do we reiterate?</span>
<a name="l01613"></a>01613         <span class="keywordflow">for</span> (i=0; i&lt;ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a9c11576eba42bf8330272081c2d1729b">numiter</a>; i++) {
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ac504db9aae4df97e6490ebbd84272130">getMaxJointChange</a>() &lt; ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a64edae7b0a6a744e61f358b0259d97f1">precision</a> ||
<a name="l01615"></a>01615                 ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#aa9a52ec69aad74b9638c654181218248">getMaxEndEffectorChange</a>() &lt; ikparam-&gt;<a class="code" href="../../d5/d18/structbItasc.html#a64edae7b0a6a744e61f358b0259d97f1">precision</a>)
<a name="l01616"></a>01616                 <span class="keywordflow">break</span>;
<a name="l01617"></a>01617             ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>-&gt;<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a92c7a5d90a7bfd5071733f8629c1d035">update</a>(timestamp, timestep, numstep, <span class="keyword">true</span>, <span class="keyword">false</span>, simulation);
<a name="l01618"></a>01618         }
<a name="l01619"></a>01619         <span class="keywordflow">if</span> (simulation) {
<a name="l01620"></a>01620             <span class="comment">// one more fake iteration to cache</span>
<a name="l01621"></a>01621             ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a923aabbf5628a34de3594436510da414">scene</a>-&gt;<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a92c7a5d90a7bfd5071733f8629c1d035">update</a>(timestamp, 0.0, 1, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l01622"></a>01622         }
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624     <span class="comment">// compute constraint error</span>
<a name="l01625"></a>01625     <span class="keywordflow">for</span> (i=ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>.size(); i &gt; 0; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01626"></a>01626         <a class="code" href="../../d1/d57/structIK__Target.html">IK_Target</a>* iktarget = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#ab03d1e3261ad2ecbf6f91f8e7896dcb4">targets</a>[i-1];
<a name="l01627"></a>01627         <span class="keywordflow">if</span> (!(iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ad0447f38e77128f256d8ab2970f963de">blenderConstraint</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>)) {
<a name="l01628"></a>01628             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nvalues;
<a name="l01629"></a>01629             <span class="keyword">const</span> <a class="code" href="../../d0/d49/structiTaSC_1_1ConstraintValues.html">iTaSC::ConstraintValues</a>* values;
<a name="l01630"></a>01630             values = iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#a9e9b3d07c57adaf4eab5500b69320825">constraint</a>-&gt;<a class="code" href="../../d8/df4/classiTaSC_1_1ConstraintSet.html#afeaf9b6a287dd52e8603139d04057193">getControlParameters</a>(&amp;nvalues);
<a name="l01631"></a>01631             iktarget-&gt;<a class="code" href="../../d1/d57/structIK__Target.html#ae0ef60c0964c9bff1bb4a32c46019fcc">errorCallback</a>(values, nvalues, iktarget);
<a name="l01632"></a>01632         }
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634     <span class="comment">// Apply result to bone:</span>
<a name="l01635"></a>01635     <span class="comment">// walk the ikscene-&gt;channels</span>
<a name="l01636"></a>01636     <span class="comment">// for each, get the Frame of the joint corresponding to the bone relative to its parent</span>
<a name="l01637"></a>01637     <span class="comment">// combine the parent and the joint frame to get the frame relative to armature</span>
<a name="l01638"></a>01638     <span class="comment">// a backward translation of the bone length gives the head</span>
<a name="l01639"></a>01639     <span class="comment">// if TY, compute the scale as the ratio of the joint length with rest pose length</span>
<a name="l01640"></a>01640     <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html">iTaSC::Armature</a>* arm = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a7209b7df5162909cb5f0c7703157c421">armature</a>;
<a name="l01641"></a>01641     <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a> frame;
<a name="l01642"></a>01642     <span class="keywordtype">double</span> q_rest[3], q[3];
<a name="l01643"></a>01643     <span class="keyword">const</span> <a class="code" href="../../de/d91/classKDL_1_1Joint.html" title="This class encapsulates a simple joint, that is with one parameterized degree of freedom and with sca...">KDL::Joint</a>* joint;
<a name="l01644"></a>01644     <span class="keyword">const</span> <a class="code" href="../../d8/d7e/classKDL_1_1Frame.html" title="represents a frame transformation in 3D space (rotation + translation)">KDL::Frame</a>* tip;
<a name="l01645"></a>01645     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>* pchan;
<a name="l01646"></a>01646     <span class="keywordtype">float</span> scale;
<a name="l01647"></a>01647     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l01648"></a>01648     <span class="keywordtype">float</span> yaxis[3];
<a name="l01649"></a>01649     <span class="keywordflow">for</span> (i=0, ikchan=ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>; i&lt;ikscene-&gt;numchan; ++i, ++ikchan) {
<a name="l01650"></a>01650         <span class="keywordflow">if</span> (i == 0) {
<a name="l01651"></a>01651             <span class="keywordflow">if</span> (!arm-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a3e4fc4e1d7b75a4d37c6a9ea3a783130">getRelativeFrame</a>(frame, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>))
<a name="l01652"></a>01652                 <span class="keywordflow">break</span>;
<a name="l01653"></a>01653             <span class="comment">// this frame is relative to base, make it relative to object</span>
<a name="l01654"></a>01654             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">frame</a> = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a082b3af7933ba01f5b0573e5feadca5e">baseFrame</a> * frame;
<a name="l01655"></a>01655         } 
<a name="l01656"></a>01656         <span class="keywordflow">else</span> {
<a name="l01657"></a>01657             <span class="keywordflow">if</span> (!arm-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a3e4fc4e1d7b75a4d37c6a9ea3a783130">getRelativeFrame</a>(frame, ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>, ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>[ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">parent</a>].<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>))
<a name="l01658"></a>01658                 <span class="keywordflow">break</span>;
<a name="l01659"></a>01659             <span class="comment">// combine with parent frame to get frame relative to object</span>
<a name="l01660"></a>01660             ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">frame</a> = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#afe60511a514b9cbc96ded1b95212f230">channels</a>[ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a0fe86d6727a5c6de1691f4b843929d23">parent</a>].<a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">frame</a> * frame;
<a name="l01661"></a>01661         }
<a name="l01662"></a>01662         <span class="comment">// ikchan-&gt;frame is the tail frame relative to object</span>
<a name="l01663"></a>01663         <span class="comment">// get bone length</span>
<a name="l01664"></a>01664         <span class="keywordflow">if</span> (!arm-&gt;<a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#a72337865eb9b2743cbdc8091d00f2dca">getSegment</a>(ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a5139426ca01488f7c9237a9b97cd9d66">tail</a>, 3, joint, q_rest[0], q[0], tip))
<a name="l01665"></a>01665             <span class="keywordflow">break</span>;
<a name="l01666"></a>01666         <span class="keywordflow">if</span> (joint-&gt;<a class="code" href="../../de/d91/classKDL_1_1Joint.html#af5732628e105954144f1e225683414ee">getType</a>() == <a class="code" href="../../de/d91/classKDL_1_1Joint.html#ad05f78142c8b73c3977f038a7a2c544ea5118e6fc6a5deee920b1378a17d7c29c">KDL::Joint::TransY</a>) {
<a name="l01667"></a>01667             <span class="comment">// stretch bones have a TY joint, compute the scale</span>
<a name="l01668"></a>01668             scale = (float)(q[0]/q_rest[0]);
<a name="l01669"></a>01669             <span class="comment">// the length is the joint itself</span>
<a name="l01670"></a>01670             length = (float)q[0];
<a name="l01671"></a>01671         } 
<a name="l01672"></a>01672         <span class="keywordflow">else</span> {
<a name="l01673"></a>01673             scale = 1.0f;
<a name="l01674"></a>01674             <span class="comment">// for fixed bone, the length is in the tip (always along Y axis)</span>
<a name="l01675"></a>01675             length = tip-&gt;<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#abc00c3817f7baa985b67077479617866" title="origine of the Frame">p</a>(1);
<a name="l01676"></a>01676         }
<a name="l01677"></a>01677         <span class="comment">// ready to compute the pose mat</span>
<a name="l01678"></a>01678         pchan = ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a31b9e9348e2682382e7bbb6076305860">pchan</a>;
<a name="l01679"></a>01679         <span class="comment">// tail mat</span>
<a name="l01680"></a>01680         ikchan-&gt;<a class="code" href="../../d5/db2/structIK__Channel.html#a78e415de6934dbf6f7f0374fc44c3e00">frame</a>.<a class="code" href="../../d8/d7e/classKDL_1_1Frame.html#a04b4fbf9486c2ffb3919913165e09adb">getValue</a>(&amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0][0]);
<a name="l01681"></a>01681         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l01682"></a>01682         <span class="comment">// shift to head</span>
<a name="l01683"></a>01683         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(yaxis, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l01684"></a>01684         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(yaxis, length);
<a name="l01685"></a>01685         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], yaxis);
<a name="l01686"></a>01686         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l01687"></a>01687         <span class="comment">// add scale</span>
<a name="l01688"></a>01688         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0], scale);
<a name="l01689"></a>01689         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1], scale);
<a name="l01690"></a>01690         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[2], scale);
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692     <span class="keywordflow">if</span> (i&lt;ikscene-&gt;numchan) {
<a name="l01693"></a>01693         <span class="comment">// big problem</span>
<a name="l01694"></a>01694         ;
<a name="l01695"></a>01695     }
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698 <span class="comment">//---------------------------------------------------</span>
<a name="l01699"></a>01699 <span class="comment">// plugin interface</span>
<a name="l01700"></a>01700 <span class="comment">//</span>
<a name="l01701"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#ae19d25514f47aad607a55491dfb6bba7">01701</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aa798c9519f2f58e0d02fbb65dabc142d">itasc_initialize_tree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> ctime)
<a name="l01702"></a>01702 {
<a name="l01703"></a>01703     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01704"></a>01704     <span class="keywordtype">int</span> count = 0;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da6a993a8c5630134f94de6f73c56e0882">POSE_WAS_REBUILT</a>)) {
<a name="l01707"></a>01707         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#adda11e906cd7e4cfffcce2f5f7dfa94b">init_scene</a>(ob);
<a name="l01708"></a>01708         <span class="keywordflow">return</span>;
<a name="l01709"></a>01709     }
<a name="l01710"></a>01710     <span class="comment">// first remove old scene</span>
<a name="l01711"></a>01711     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2abc8ceb2853c9763483ffeae499a2b5">itasc_clear_data</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01712"></a>01712     <span class="comment">// we should handle all the constraint and mark them all disabled</span>
<a name="l01713"></a>01713     <span class="comment">// for blender but we&#39;ll start with the IK constraint alone</span>
<a name="l01714"></a>01714     <span class="keywordflow">for</span> (pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01715"></a>01715         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#abf27c9382f3dd90c6a03b2e8fd69d1fc">constflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#aa054ea9cc32895cc3299d8e9331ab3e8a946cee8332ffabf5684e8a57f5ba5a5d">PCHAN_HAS_IK</a>)
<a name="l01716"></a>01716             count += <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a4cdfbea4714dd59568084c3394b30961">initialize_scene</a>(ob, pchan);
<a name="l01717"></a>01717     }
<a name="l01718"></a>01718     <span class="comment">// if at least one tree, create the scenes from the PoseTree stored in the channels </span>
<a name="l01719"></a>01719     <span class="keywordflow">if</span> (count)
<a name="l01720"></a>01720         <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a757e04f585c01b9a91847c45ea8c2cb5">create_scene</a>(scene, ob);
<a name="l01721"></a>01721     <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a56addfc75c2c4660bd7ab2e2d290298d">itasc_update_param</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01722"></a>01722     <span class="comment">// make sure we don&#39;t rebuilt until the user changes something important</span>
<a name="l01723"></a>01723     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp;= ~<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da6a993a8c5630134f94de6f73c56e0882">POSE_WAS_REBUILT</a>;
<a name="l01724"></a>01724 }
<a name="l01725"></a>01725 
<a name="l01726"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#a9c67460d52c5e15610456f5190797057">01726</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a9c67460d52c5e15610456f5190797057">itasc_execute_tree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,  <span class="keyword">struct</span> <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> ctime)
<a name="l01727"></a>01727 {
<a name="l01728"></a>01728     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>) {
<a name="l01729"></a>01729         <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* ikdata = (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l01730"></a>01730         <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*) ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l01731"></a>01731         <span class="comment">// we need default parameters</span>
<a name="l01732"></a>01732         <span class="keywordflow">if</span> (!ikparam) ikparam = &amp;<a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a09eae21572f3962d3f292c65930efc93">DefIKParam</a>;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734         <span class="keywordflow">for</span> (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>; ikscene; ikscene = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a>) {
<a name="l01735"></a>01735             <span class="keywordflow">if</span> (ikscene-&gt;channels[0].pchan == pchan) {
<a name="l01736"></a>01736                 <span class="keywordtype">float</span> timestep = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11e6b08a8678f04813637f658e867193">frs_sec_base</a>/scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a071df993e13c05fc37e6f9a82c0679f5">frs_sec</a>;
<a name="l01737"></a>01737                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da73ccacdc673d969588a95c3b5676dc5a">POSE_GAME_ENGINE</a>) {
<a name="l01738"></a>01738                     timestep = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a37988713276a7d4e6a85b5f5e995f979">ctime</a>;
<a name="l01739"></a>01739                     <span class="comment">// limit the timestep to avoid excessive number of iteration</span>
<a name="l01740"></a>01740                     <span class="keywordflow">if</span> (timestep &gt; 0.2f)
<a name="l01741"></a>01741                         timestep = 0.2f;
<a name="l01742"></a>01742                 }
<a name="l01743"></a>01743                 <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#aff93d5c13ebb1828a2c5ee3dfd9c536a">execute_scene</a>(scene, ikscene, ikparam, ctime, timestep);
<a name="l01744"></a>01744                 <span class="keywordflow">break</span>;
<a name="l01745"></a>01745             }
<a name="l01746"></a>01746         }
<a name="l01747"></a>01747     }
<a name="l01748"></a>01748 }
<a name="l01749"></a>01749 
<a name="l01750"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#a976c2b034e4bd24e130a0a581af1245f">01750</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a976c2b034e4bd24e130a0a581af1245f">itasc_release_tree</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,  <span class="keywordtype">float</span> ctime)
<a name="l01751"></a>01751 {
<a name="l01752"></a>01752     <span class="comment">// not used for iTaSC</span>
<a name="l01753"></a>01753 }
<a name="l01754"></a>01754 
<a name="l01755"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#a2abc8ceb2853c9763483ffeae499a2b5">01755</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a2abc8ceb2853c9763483ffeae499a2b5">itasc_clear_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose)
<a name="l01756"></a>01756 {
<a name="l01757"></a>01757     <span class="keywordflow">if</span> (pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>) {
<a name="l01758"></a>01758         <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* ikdata = (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l01759"></a>01759         for (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* scene = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>; scene; scene = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>) {
<a name="l01760"></a>01760             ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a> = scene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a>;
<a name="l01761"></a>01761             <span class="keyword">delete</span> scene;
<a name="l01762"></a>01762         }
<a name="l01763"></a>01763         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ikdata);
<a name="l01764"></a>01764         pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01765"></a>01765     }
<a name="l01766"></a>01766 }
<a name="l01767"></a>01767 
<a name="l01768"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#a17c20813f055997727acf88690738d16">01768</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a17c20813f055997727acf88690738d16">itasc_clear_cache</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose)
<a name="l01769"></a>01769 {
<a name="l01770"></a>01770     <span class="keywordflow">if</span> (pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>) {
<a name="l01771"></a>01771         <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* ikdata = (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l01772"></a>01772         for (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* scene = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>; scene; scene = scene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a>) {
<a name="l01773"></a>01773             <span class="keywordflow">if</span> (scene-&gt;cache)
<a name="l01774"></a>01774                 <span class="comment">// clear all cache but leaving the timestamp 0 (=rest pose)</span>
<a name="l01775"></a>01775                 scene-&gt;cache-&gt;clearCacheFrom(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01776"></a>01776         }
<a name="l01777"></a>01777     }
<a name="l01778"></a>01778 }
<a name="l01779"></a>01779 
<a name="l01780"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#a56addfc75c2c4660bd7ab2e2d290298d">01780</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#a56addfc75c2c4660bd7ab2e2d290298d">itasc_update_param</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose)
<a name="l01781"></a>01781 {
<a name="l01782"></a>01782     <span class="keywordflow">if</span> (pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a> &amp;&amp; pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>) {
<a name="l01783"></a>01783         <a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>* ikdata = (<a class="code" href="../../db/d29/structIK__Data.html">IK_Data</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a127dfa027eebf5284fa8635babc4606e">ikdata</a>;
<a name="l01784"></a>01784         <a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>* ikparam = (<a class="code" href="../../d5/d18/structbItasc.html">bItasc</a>*)pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a2c700562036f72cc3bfa089c1dbef380">ikparam</a>;
<a name="l01785"></a>01785         <span class="keywordflow">for</span> (<a class="code" href="../../d5/d66/structIK__Scene.html">IK_Scene</a>* ikscene = ikdata-&gt;<a class="code" href="../../db/d29/structIK__Data.html#a23e0160e4684405adb8ea8faf8a52479">first</a>; ikscene; ikscene = ikscene-&gt;<a class="code" href="../../d5/d66/structIK__Scene.html#a4b456bfe3f1385cb8210ef30e886851f">next</a>) {
<a name="l01786"></a>01786             <span class="keywordtype">double</span> armlength = ikscene-&gt;armature-&gt;getArmLength();
<a name="l01787"></a>01787             ikscene-&gt;solver-&gt;setParam(<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#a49b6b16c75c07fa810e1cac57b706972adc4904be0f2d6c7aca534e5c4c4c72bc">iTaSC::Solver::DLS_LAMBDA_MAX</a>, ikparam-&gt;dampmax*armlength);
<a name="l01788"></a>01788             ikscene-&gt;solver-&gt;setParam(<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#a49b6b16c75c07fa810e1cac57b706972a0f56aa5f3db3c053324303eb7c5ff182">iTaSC::Solver::DLS_EPSILON</a>, ikparam-&gt;dampeps*armlength);
<a name="l01789"></a>01789             <span class="keywordflow">if</span> (ikparam-&gt;flag &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a8e95e717d7fd1ca9aa53d1520a194811ac29cac956ec7d28c77ca1c5684773bbc">ITASC_SIMULATION</a>) {
<a name="l01790"></a>01790                 ikscene-&gt;scene-&gt;setParam(<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a7098c4f07a18db3a1e6ed0b229fa5a95a7edeb4922f4f70650cfec2abada21195">iTaSC::Scene::MIN_TIMESTEP</a>, ikparam-&gt;minstep);
<a name="l01791"></a>01791                 ikscene-&gt;scene-&gt;setParam(<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a7098c4f07a18db3a1e6ed0b229fa5a95acf20017f4154925975c3496ff9d8c31b">iTaSC::Scene::MAX_TIMESTEP</a>, ikparam-&gt;maxstep);
<a name="l01792"></a>01792                 ikscene-&gt;solver-&gt;setParam(<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#a49b6b16c75c07fa810e1cac57b706972a8aab9d0a0bf176a7ea4b4c0b4946acbf">iTaSC::Solver::DLS_QMAX</a>, ikparam-&gt;maxvel);
<a name="l01793"></a>01793                 ikscene-&gt;armature-&gt;setControlParameter(<a class="code" href="../../d4/d60/ControlledObject_8hpp.html#a7869cb9f4cb8314e39774b7aeeeb23b4">CONSTRAINT_ID_ALL</a>, <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ad84120eb9bdf6b2257532a0443266f96ae0bd2e2a466b2d88a2fba93401f7b737">iTaSC::Armature::ID_JOINT</a>, <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a6a4054f7082a6e199d25560940408859">iTaSC::ACT_FEEDBACK</a>, ikparam-&gt;feedback);
<a name="l01794"></a>01794             }
<a name="l01795"></a>01795             <span class="keywordflow">else</span> {
<a name="l01796"></a>01796                 <span class="comment">// in animation mode timestep is 1s by convention =&gt; </span>
<a name="l01797"></a>01797                 <span class="comment">// qmax becomes radiant and feedback becomes fraction of error gap corrected in one iteration</span>
<a name="l01798"></a>01798                 ikscene-&gt;scene-&gt;setParam(<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a7098c4f07a18db3a1e6ed0b229fa5a95a7edeb4922f4f70650cfec2abada21195">iTaSC::Scene::MIN_TIMESTEP</a>, 1.0);
<a name="l01799"></a>01799                 ikscene-&gt;scene-&gt;setParam(<a class="code" href="../../d2/d35/classiTaSC_1_1Scene.html#a7098c4f07a18db3a1e6ed0b229fa5a95acf20017f4154925975c3496ff9d8c31b">iTaSC::Scene::MAX_TIMESTEP</a>, 1.0);
<a name="l01800"></a>01800                 ikscene-&gt;solver-&gt;setParam(<a class="code" href="../../db/d64/classiTaSC_1_1Solver.html#a49b6b16c75c07fa810e1cac57b706972a8aab9d0a0bf176a7ea4b4c0b4946acbf">iTaSC::Solver::DLS_QMAX</a>, 0.52);
<a name="l01801"></a>01801                 ikscene-&gt;armature-&gt;setControlParameter(<a class="code" href="../../d4/d60/ControlledObject_8hpp.html#a7869cb9f4cb8314e39774b7aeeeb23b4">CONSTRAINT_ID_ALL</a>, <a class="code" href="../../d5/d24/classiTaSC_1_1Armature.html#ad84120eb9bdf6b2257532a0443266f96ae0bd2e2a466b2d88a2fba93401f7b737">iTaSC::Armature::ID_JOINT</a>, <a class="code" href="../../d8/d76/namespaceiTaSC.html#afe5e5c0a0b38b6e57bb9b302e67c6776a6a4054f7082a6e199d25560940408859">iTaSC::ACT_FEEDBACK</a>, 0.8);
<a name="l01802"></a>01802             }
<a name="l01803"></a>01803         }
<a name="l01804"></a>01804     }
<a name="l01805"></a>01805 }
<a name="l01806"></a>01806 
<a name="l01807"></a><a class="code" href="../../d1/de6/itasc__plugin_8h.html#ad42a6139bf4bc0cc501fc04df2efbec7">01807</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dc6/itasc__plugin_8cpp.html#ad42a6139bf4bc0cc501fc04df2efbec7">itasc_test_constraint</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">struct</span> <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *cons)
<a name="l01808"></a>01808 {
<a name="l01809"></a>01809     <span class="keyword">struct </span><a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = (<span class="keyword">struct </span><a class="code" href="../../d4/d5b/structbKinematicConstraint.html">bKinematicConstraint</a> *)cons-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     <span class="comment">/* only for IK constraint */</span>
<a name="l01812"></a>01812     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (cons-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a> != <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a> || data == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01813"></a>01813         <span class="keywordflow">return</span>;
<a name="l01814"></a>01814 
<a name="l01815"></a>01815     <span class="keywordflow">switch</span> (data-&gt;<a class="code" href="../../d4/d5b/structbKinematicConstraint.html#afcb8de4ada99cea3a0a92a873c6b75b3">type</a>) {
<a name="l01816"></a>01816     <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a43ffcba0a3cf59e6603321856a38b071a1ff09193535d2dec4ed60beb3fe5b202">CONSTRAINT_IK_COPYPOSE</a>:
<a name="l01817"></a>01817     <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a43ffcba0a3cf59e6603321856a38b071a677da30ef4c330c359f2aaf6292a6f42">CONSTRAINT_IK_DISTANCE</a>:
<a name="l01818"></a>01818         <span class="comment">/* cartesian space constraint */</span>
<a name="l01819"></a>01819         <span class="keywordflow">break</span>;
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:26 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
