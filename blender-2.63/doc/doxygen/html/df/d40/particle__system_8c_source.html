<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: particle_system.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">particle_system.c</div>  </div>
</div>
<div class="contents">
<a href="../../df/d40/particle__system_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2007 by Janne Karhu.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Raul Fernandez Hernandez (Farsthary), Stephen Swhitehorn.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * Adaptive time step</span>
<a name="l00026"></a>00026 <span class="comment"> * Copyright 2011 AutoCRC</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#ifdef _OPENMP</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;omp.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dbb/DNA__boid__types_8h.html">DNA_boid_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html">DNA_particle_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html">DNA_modifier_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d60/DNA__object__force_8h.html">DNA_object_force.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d88/DNA__curve__types_8h.html">DNA_curve_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d5e/DNA__ipo__types_8h.html">DNA_ipo_types.h</a>&quot;</span> <span class="comment">// XXX old animation system stuff... to be removed!</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d43/DNA__listBase_8h.html" title="These structs are the foundation for all linked lists in the library system.">DNA_listBase.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dfb/BLI__edgehash_8h.html" title="A general unordered 2-int pair hash table ADT.">BLI_edgehash.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d49/BLI__jitter_8h.html">BLI_jitter.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dd3/BLI__kdtree_8h.html" title="A kd-tree for nearest neighbor search.">BLI_kdtree.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html">BLI_kdopbvh.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d31/BLI__linklist_8h.html" title="Routines for working with singly linked lists of &#39;links&#39; - pointers to other data.">BLI_linklist.h</a>&quot;</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db3/BKE__boids_8h.html">BKE_boids.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/de6/BKE__collision_8h.html">BKE_collision.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d65/BKE__effect_8h.html">BKE_effect.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dca/BKE__particle_8h.html">BKE_particle.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d17/BKE__cloth_8h.html">BKE_cloth.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8f/BKE__lattice_8h.html">BKE_lattice.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d45/BKE__pointcache_8h.html">BKE_pointcache.h</a>&quot;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d65/BKE__bvhutils_8h.html">BKE_bvhutils.h</a>&quot;</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d49/RE__shader__ext_8h.html">RE_shader_ext.h</a>&quot;</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/* fluid sim particle import */</span>
<a name="l00102"></a>00102 <span class="preprocessor">#ifdef WITH_MOD_FLUID</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html">DNA_object_fluidsim.h</a>&quot;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db4/LBM__fluidsim_8h.html">LBM_fluidsim.h</a>&quot;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &lt;zlib.h&gt;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#endif // WITH_MOD_FLUID</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a>00110 <span class="comment">/************************************************/</span>
<a name="l00111"></a>00111 <span class="comment">/*          Reacting to system events           */</span>
<a name="l00112"></a>00112 <span class="comment">/************************************************/</span>
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab9b7f2f019ed51a160ed256b6aadc9f4">00114</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ab9b7f2f019ed51a160ed256b6aadc9f4">particles_are_dynamic</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)
<a name="l00117"></a>00117         <span class="keywordflow">return</span> 0;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>)
<a name="l00120"></a>00120         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a65497cba4ef74badceb76706e2b0a526">PSYS_HAIR_DYNAMICS</a>;
<a name="l00121"></a>00121     <span class="keywordflow">else</span>
<a name="l00122"></a>00122         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ab3449550f098a61b95dcfd28117f9b34">PART_PHYS_NEWTON</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a>);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">00125</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">psys_get_current_display_percentage</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span> ((psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a86a9ed5baa3079474b611e98979c0928">renderdata</a> &amp;&amp; !<a class="code" href="../../df/d40/particle__system_8c.html#ab9b7f2f019ed51a160ed256b6aadc9f4">particles_are_dynamic</a>(psys)) ||  <span class="comment">/* non-dynamic particles can be rendered fully */</span>
<a name="l00130"></a>00130         (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aea3bf72ac907f8262f7c895af2435f0f">child_nbr</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>)  ||    <span class="comment">/* display percentage applies to children */</span>
<a name="l00131"></a>00131         (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>))  <span class="comment">/* baking is always done with full amount */</span>
<a name="l00132"></a>00132     {
<a name="l00133"></a>00133         <span class="keywordflow">return</span> 100;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae487721b04b5b6187f39a9e768d4630b">disp</a>;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="../../df/d40/particle__system_8c.html#a51344d20e820314d05f85fb5a6e3b6bd">00139</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#a51344d20e820314d05f85fb5a6e3b6bd">tot_particles</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (pid &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>)
<a name="l00142"></a>00142         <span class="keywordflow">return</span> pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a>;
<a name="l00143"></a>00143     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93c2418e9c7c39a31da98a0ccbf31363">PART_DISTR_GRID</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>)
<a name="l00144"></a>00144         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a0c3ea53c984c9b48c2fb8d7474e108d5">grid_res</a> * psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a0c3ea53c984c9b48c2fb8d7474e108d5">grid_res</a> * psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a0c3ea53c984c9b48c2fb8d7474e108d5">grid_res</a> - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>;
<a name="l00145"></a>00145     <span class="keywordflow">else</span>
<a name="l00146"></a>00146         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a987ea41fe09e95054533124966636aca">totpart</a> - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../df/d40/particle__system_8c.html#a9255cfd6fa1f04a38f9abbda29e3d642">00149</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a686244657da3b6f9c17f52070e5cd4b4">psys_reset</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> mode)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(mode, <a class="code" href="../../db/dca/BKE__particle_8h.html#aac0cee343bc36395e4bec4851c8f0ab3">PSYS_RESET_ALL</a>, <a class="code" href="../../db/dca/BKE__particle_8h.html#ad7b0cdc78a3e750210512f0bd4837845">PSYS_RESET_DEPSGRAPH</a>)) {
<a name="l00154"></a>00154         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dca/BKE__particle_8h.html#aac0cee343bc36395e4bec4851c8f0ab3">PSYS_RESET_ALL</a> || !(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad70fdae16497470d0b08a332f4021b7b">PSYS_EDITED</a>)) {
<a name="l00155"></a>00155             <span class="comment">/* don&#39;t free if not absolutely necessary */</span>
<a name="l00156"></a>00156             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> != <a class="code" href="../../df/d40/particle__system_8c.html#a51344d20e820314d05f85fb5a6e3b6bd">tot_particles</a>(psys, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00157"></a>00157                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a7aef9aa152ab500fc7fa6a777e4aa0bb">psys_free_particles</a>(psys);
<a name="l00158"></a>00158                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>= 0;
<a name="l00159"></a>00159             }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a>= 0;
<a name="l00162"></a>00162             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~(<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>) {
<a name="l00165"></a>00165                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>);
<a name="l00166"></a>00166                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00167"></a>00167                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00168"></a>00168             }
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dca/BKE__particle_8h.html#a8a3147d568795fdb59169e7e6325bad4">PSYS_RESET_CACHE_MISS</a>) {
<a name="l00172"></a>00172         <span class="comment">/* set all particles to be skipped */</span>
<a name="l00173"></a>00173         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l00174"></a>00174             pa-&gt;flag |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">/* reset children */</span>
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>) {
<a name="l00179"></a>00179         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>);
<a name="l00180"></a>00180         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>= 0;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="comment">/* reset path cache */</span>
<a name="l00186"></a>00186     <a class="code" href="../../db/dca/BKE__particle_8h.html#ac3a5caa58c093a03ce64938258f62d93">psys_free_path_cache</a>(psys, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="comment">/* reset point cache */</span>
<a name="l00189"></a>00189     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>) {
<a name="l00192"></a>00192         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>);
<a name="l00193"></a>00193         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> = 0;
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="../../df/d40/particle__system_8c.html#aef983187092ea570b9af5b7336c019f7">00199</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aef983187092ea570b9af5b7336c019f7">realloc_particles</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> new_totpart)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l00202"></a>00202     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l00203"></a>00203     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *newpars = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00204"></a>00204     <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *newboids = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00205"></a>00205     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l00206"></a>00206     <span class="keywordtype">int</span> totpart, totsaved = 0;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (new_totpart&lt;0) {
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93c2418e9c7c39a31da98a0ccbf31363">PART_DISTR_GRID</a>  &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l00210"></a>00210             totpart= part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a0c3ea53c984c9b48c2fb8d7474e108d5">grid_res</a>;
<a name="l00211"></a>00211             totpart*=totpart*totpart;
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         <span class="keywordflow">else</span>
<a name="l00214"></a>00214             totpart=part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a987ea41fe09e95054533124966636aca">totpart</a>;
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216     <span class="keywordflow">else</span>
<a name="l00217"></a>00217         totpart=new_totpart;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (totpart != psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>) {
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>) {
<a name="l00221"></a>00221             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>);
<a name="l00222"></a>00222             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00223"></a>00223             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (totpart) {
<a name="l00227"></a>00227             newpars= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totpart*<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a>), <span class="stringliteral">&quot;particles&quot;</span>);
<a name="l00228"></a>00228             <span class="keywordflow">if</span> (newpars == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00229"></a>00229                 <span class="keywordflow">return</span>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>) {
<a name="l00232"></a>00232                 newboids= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totpart*<span class="keyword">sizeof</span>(<a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a>), <span class="stringliteral">&quot;boid particles&quot;</span>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234                 <span class="keywordflow">if</span> (newboids == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00235"></a>00235                      <span class="comment">/* allocation error! */</span>
<a name="l00236"></a>00236                     <span class="keywordflow">if</span> (newpars)
<a name="l00237"></a>00237                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(newpars);
<a name="l00238"></a>00238                     <span class="keywordflow">return</span>;
<a name="l00239"></a>00239                 }
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242     
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>) {
<a name="l00244"></a>00244             totsaved=<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>,totpart);
<a name="l00245"></a>00245             <span class="comment">/*save old pars*/</span>
<a name="l00246"></a>00246             <span class="keywordflow">if</span> (totsaved) {
<a name="l00247"></a>00247                 memcpy(newpars,psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>,totsaved*<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a>));
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>)
<a name="l00250"></a>00250                     memcpy(newboids, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>, totsaved*<span class="keyword">sizeof</span>(<a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a>));
<a name="l00251"></a>00251             }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#aa3c5aa86180461633245493c22458c92">keys</a>)
<a name="l00254"></a>00254                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#aa3c5aa86180461633245493c22458c92">keys</a>);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>)
<a name="l00257"></a>00257                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259             <span class="keywordflow">for</span> (<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=0, pa=newpars; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>&lt;totsaved; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>++, pa++) {
<a name="l00260"></a>00260                 <span class="keywordflow">if</span> (pa-&gt;keys) {
<a name="l00261"></a>00261                     pa-&gt;keys= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00262"></a>00262                     pa-&gt;totkey= 0;
<a name="l00263"></a>00263                 }
<a name="l00264"></a>00264             }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266             <span class="keywordflow">for</span> (<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=totsaved, pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>+totsaved; p&lt;psys-&gt;totpart; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>++, pa++)
<a name="l00267"></a>00267                 <span class="keywordflow">if</span> (pa-&gt;hair) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pa-&gt;hair);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>);
<a name="l00270"></a>00270             <a class="code" href="../../db/dca/BKE__particle_8h.html#ac6b0f2bf9fba3a6722c26a397ebe7710">psys_free_pdd</a>(psys);
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272         
<a name="l00273"></a>00273         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>=newpars;
<a name="l00274"></a>00274         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>=totpart;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (newboids) {
<a name="l00277"></a>00277             <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l00278"></a>00278                 pa-&gt;boid = newboids++;
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>) {
<a name="l00283"></a>00283         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>);
<a name="l00284"></a>00284         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00285"></a>00285         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>=0;
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="../../df/d40/particle__system_8c.html#a4fad4daacc8bd731ed2d457d2e480034">00289</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#a4fad4daacc8bd731ed2d457d2e480034">get_psys_child_number</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <span class="keywordtype">int</span> nbr;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>)
<a name="l00294"></a>00294         <span class="keywordflow">return</span> 0;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a86a9ed5baa3079474b611e98979c0928">renderdata</a>)
<a name="l00297"></a>00297         nbr= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a2929a430557778d28964ff5ed106928e">ren_child_nbr</a>;
<a name="l00298"></a>00298     <span class="keywordflow">else</span>
<a name="l00299"></a>00299         nbr= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aea3bf72ac907f8262f7c895af2435f0f">child_nbr</a>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     <span class="keywordflow">return</span> <a class="code" href="../../d8/d53/BKE__scene_8h.html#a58d08c0421cb2decdec707e313ab26ed">get_render_child_particle_number</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>, nbr);
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a><a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">00304</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(<span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>*<a class="code" href="../../df/d40/particle__system_8c.html#a4fad4daacc8bd731ed2d457d2e480034">get_psys_child_number</a>(scene, psys);
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a><a class="code" href="../../df/d40/particle__system_8c.html#aec30ea727db93241762526a7123a932d">00309</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aec30ea727db93241762526a7123a932d">alloc_child_particles</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> tot)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>) {
<a name="l00312"></a>00312         <span class="comment">/* only re-allocate if we have to */</span>
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a> == tot) {
<a name="l00314"></a>00314             memset(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>, 0, tot*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a>));
<a name="l00315"></a>00315             <span class="keywordflow">return</span>;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>);
<a name="l00319"></a>00319         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00320"></a>00320         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>=0;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>) {
<a name="l00324"></a>00324         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>= tot;
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>)
<a name="l00326"></a>00326             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a>), <span class="stringliteral">&quot;child_particles&quot;</span>);
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/************************************************/</span>
<a name="l00331"></a>00331 <span class="comment">/*          Distribution                        */</span>
<a name="l00332"></a>00332 <span class="comment">/************************************************/</span>
<a name="l00333"></a>00333 
<a name="l00334"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab7e0a1113a52227fa2ab12603ee4bee8">00334</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a26715032d0452cc6788be0bded9d9d09">psys_calc_dmcache</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336     <span class="comment">/* use for building derived mesh mapping info:</span>
<a name="l00337"></a>00337 <span class="comment">     *</span>
<a name="l00338"></a>00338 <span class="comment">     * node: the allocated links - total derived mesh element count </span>
<a name="l00339"></a>00339 <span class="comment">     * nodearray: the array of nodes aligned with the base mesh&#39;s elements, so</span>
<a name="l00340"></a>00340 <span class="comment">     *            each original elements can reference its derived elements</span>
<a name="l00341"></a>00341 <span class="comment">     */</span>
<a name="l00342"></a>00342     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= (<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00343"></a>00343     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l00344"></a>00344     
<a name="l00345"></a>00345     <span class="comment">/* CACHE LOCATIONS */</span>
<a name="l00346"></a>00346     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab759ebc0e7d00291ab54b0ace0e118c1">deformedOnly</a>) {
<a name="l00347"></a>00347         <span class="comment">/* Will use later to speed up subsurf/derivedmesh */</span>
<a name="l00348"></a>00348         <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node, *nodedmelem, **nodearray;
<a name="l00349"></a>00349         <span class="keywordtype">int</span> totdmelem, <a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, *origindex;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l00352"></a>00352             totdmelem= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00353"></a>00353             totelem= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00354"></a>00354             origindex= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         <span class="keywordflow">else</span> { <span class="comment">/* FROM_FACE/FROM_VOLUME */</span>
<a name="l00357"></a>00357             totdmelem= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00358"></a>00358             totelem= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>;
<a name="l00359"></a>00359             origindex= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361     
<a name="l00362"></a>00362         nodedmelem= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a>)*totdmelem, <span class="stringliteral">&quot;psys node elems&quot;</span>);
<a name="l00363"></a>00363         nodearray= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *)*totelem, <span class="stringliteral">&quot;psys node array&quot;</span>);
<a name="l00364"></a>00364         
<a name="l00365"></a>00365         <span class="keywordflow">for</span> (i=0, node=nodedmelem; i&lt;totdmelem; i++, origindex++, node++) {
<a name="l00366"></a>00366             node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(i);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368             <span class="keywordflow">if</span> (*origindex != -1) {
<a name="l00369"></a>00369                 <span class="keywordflow">if</span> (nodearray[*origindex]) {
<a name="l00370"></a>00370                     <span class="comment">/* prepend */</span>
<a name="l00371"></a>00371                     node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a> = nodearray[*origindex];
<a name="l00372"></a>00372                     nodearray[*origindex]= node;
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374                 <span class="keywordflow">else</span>
<a name="l00375"></a>00375                     nodearray[*origindex]= node;
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378         
<a name="l00379"></a>00379         <span class="comment">/* cache the verts/faces! */</span>
<a name="l00380"></a>00380         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l00381"></a>00381             <span class="keywordflow">if</span> (pa-&gt;num &lt; 0) {
<a name="l00382"></a>00382                 pa-&gt;num_dmcache = -1;
<a name="l00383"></a>00383                 <span class="keywordflow">continue</span>;
<a name="l00384"></a>00384             }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l00387"></a>00387                 <span class="keywordflow">if</span> (nodearray[pa-&gt;num])
<a name="l00388"></a>00388                     pa-&gt;num_dmcache= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(nodearray[pa-&gt;num]-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>);
<a name="l00389"></a>00389             }
<a name="l00390"></a>00390             <span class="keywordflow">else</span> { <span class="comment">/* FROM_FACE/FROM_VOLUME */</span>
<a name="l00391"></a>00391                 <span class="comment">/* Note that sometimes the pa-&gt;num is over the nodearray size, this is bad, maybe there is a better place to fix this,</span>
<a name="l00392"></a>00392 <span class="comment">                 * but for now passing NULL is OK. every face will be searched for the particle so its slower - Campbell */</span>
<a name="l00393"></a>00393                 pa-&gt;num_dmcache= <a class="code" href="../../db/dca/BKE__particle_8h.html#a5b4869b75bc450f9e25d56e74b00ae48">psys_particle_dm_face_lookup</a>(ob, dm, pa-&gt;num, pa-&gt;fuv, pa-&gt;num &lt; totelem ? nodearray[pa-&gt;num] : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nodearray);
<a name="l00398"></a>00398         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nodedmelem);
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400     <span class="keywordflow">else</span> {
<a name="l00401"></a>00401         <span class="comment">/* TODO PARTICLE, make the following line unnecessary, each function</span>
<a name="l00402"></a>00402 <span class="comment">         * should know to use the num or num_dmcache, set the num_dmcache to</span>
<a name="l00403"></a>00403 <span class="comment">         * an invalid value, just in case */</span>
<a name="l00404"></a>00404         
<a name="l00405"></a>00405         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l00406"></a>00406             pa-&gt;num_dmcache = -1;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a><a class="code" href="../../df/d40/particle__system_8c.html#acdebafd5ba1e222bb0db5d9e33d7afc3">00410</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#acdebafd5ba1e222bb0db5d9e33d7afc3">distribute_simple_children</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *finaldm, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412     <a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a> *cpa = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00413"></a>00413     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00414"></a>00414     <span class="keywordtype">int</span> child_nbr= <a class="code" href="../../df/d40/particle__system_8c.html#a4fad4daacc8bd731ed2d457d2e480034">get_psys_child_number</a>(scene, psys);
<a name="l00415"></a>00415     <span class="keywordtype">int</span> totpart= <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(scene, psys);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <a class="code" href="../../df/d40/particle__system_8c.html#aec30ea727db93241762526a7123a932d">alloc_child_particles</a>(psys, totpart);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     cpa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>;
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (i=0; i&lt;child_nbr; i++) {
<a name="l00421"></a>00421         <span class="keywordflow">for</span> (p=0; p&lt;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>; p++,cpa++) {
<a name="l00422"></a>00422             <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>=2.0;
<a name="l00423"></a>00423             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ab2c1496d7cac367b2e04cf9f908e9580">parent</a>=<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00424"></a>00424                     
<a name="l00425"></a>00425             <span class="comment">/* create even spherical distribution inside unit sphere */</span>
<a name="l00426"></a>00426             <span class="keywordflow">while</span> (length&gt;=1.0f) {
<a name="l00427"></a>00427                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[0]=2.0f*<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-1.0f;
<a name="l00428"></a>00428                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[1]=2.0f*<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-1.0f;
<a name="l00429"></a>00429                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[2]=2.0f*<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-1.0f;
<a name="l00430"></a>00430                 length=<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>);
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>=-1;
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="comment">/* dmcache must be updated for parent particles if children from faces is used */</span>
<a name="l00437"></a>00437     <a class="code" href="../../db/dca/BKE__particle_8h.html#a26715032d0452cc6788be0bded9d9d09">psys_calc_dmcache</a>(ob, finaldm, psys);
<a name="l00438"></a>00438 }
<a name="l00439"></a><a class="code" href="../../df/d40/particle__system_8c.html#af6fd3410e2d4538aa884bc7838f7ae9f">00439</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#af6fd3410e2d4538aa884bc7838f7ae9f">distribute_grid</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00442"></a>00442     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], delta[3], d;
<a name="l00443"></a>00443     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv, *mvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm,0);
<a name="l00444"></a>00444     <span class="keywordtype">int</span> totvert=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm), from=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>;
<a name="l00445"></a>00445     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, res=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a0c3ea53c984c9b48c2fb8d7474e108d5">grid_res</a>, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[3], axis;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     mv=mvert;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="comment">/* find bounding box of dm */</span>
<a name="l00450"></a>00450     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(min, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00451"></a>00451     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(max, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00452"></a>00452     mv++;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="keywordflow">for</span> (i=1; i&lt;totvert; i++, mv++) {
<a name="l00455"></a>00455         min[0]=<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(min[0],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0]);
<a name="l00456"></a>00456         min[1]=<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(min[1],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1]);
<a name="l00457"></a>00457         min[2]=<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(min[2],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2]);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         max[0]=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(max[0],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0]);
<a name="l00460"></a>00460         max[1]=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(max[1],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1]);
<a name="l00461"></a>00461         max[2]=<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(max[2],mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2]);
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(delta, max, min);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="comment">/* determine major axis */</span>
<a name="l00467"></a>00467     axis = (delta[0]&gt;=delta[1]) ? 0 : ((delta[1]&gt;=delta[2]) ? 1 : 2);
<a name="l00468"></a>00468      
<a name="l00469"></a>00469     d = delta[axis]/(float)res;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[axis] = res;
<a name="l00472"></a>00472     <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+1)%3] = (<span class="keywordtype">int</span>)ceil(delta[(axis+1)%3]/d);
<a name="l00473"></a>00473     <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+2)%3] = (<span class="keywordtype">int</span>)ceil(delta[(axis+2)%3]/d);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <span class="comment">/* float errors grrr.. */</span>
<a name="l00476"></a>00476     <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+1)%3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+1)%3],res);
<a name="l00477"></a>00477     <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+2)%3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[(axis+2)%3],res);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     size[0] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(size[0], 1);
<a name="l00480"></a>00480     size[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(size[1], 1);
<a name="l00481"></a>00481     size[2] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(size[2], 1);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="comment">/* no full offset for flat/thin objects */</span>
<a name="l00484"></a>00484     min[0]+= d &lt; delta[0] ? d/2.f : delta[0]/2.f;
<a name="l00485"></a>00485     min[1]+= d &lt; delta[1] ? d/2.f : delta[1]/2.f;
<a name="l00486"></a>00486     min[2]+= d &lt; delta[2] ? d/2.f : delta[2]/2.f;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="keywordflow">for</span> (i=0,p=0,pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; i&lt;res; i++) {
<a name="l00489"></a>00489         <span class="keywordflow">for</span> (j=0; j&lt;res; j++) {
<a name="l00490"></a>00490             <span class="keywordflow">for</span> (k=0; k&lt;res; k++,p++,pa++) {
<a name="l00491"></a>00491                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[0] = min[0] + (float)i*d;
<a name="l00492"></a>00492                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[1] = min[1] + (float)j*d;
<a name="l00493"></a>00493                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[2] = min[2] + (float)k*d;
<a name="l00494"></a>00494                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00495"></a>00495                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> = 0; <span class="comment">/* abused in volume calculation */</span>
<a name="l00496"></a>00496             }
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="comment">/* enable particles near verts/edges/faces/inside surface */</span>
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l00502"></a>00502         <span class="keywordtype">float</span> vec[3];
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         min[0] -= d/2.0f;
<a name="l00507"></a>00507         min[1] -= d/2.0f;
<a name="l00508"></a>00508         min[2] -= d/2.0f;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="keywordflow">for</span> (i=0,mv=mvert; i&lt;totvert; i++,mv++) {
<a name="l00511"></a>00511             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec,mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,min);
<a name="l00512"></a>00512             vec[0]/=delta[0];
<a name="l00513"></a>00513             vec[1]/=delta[1];
<a name="l00514"></a>00514             vec[2]/=delta[2];
<a name="l00515"></a>00515             (pa +((int)(vec[0]*(size[0]-1))*res
<a name="l00516"></a>00516                 +(<span class="keywordtype">int</span>)(vec[1]*(size[1]-1)))*res
<a name="l00517"></a>00517                 +(<span class="keywordtype">int</span>)(vec[2]*(size[2]-1)))-&gt;flag &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(from,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>)) {
<a name="l00521"></a>00521         <span class="keywordtype">float</span> co1[3], co2[3];
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *mface_array;
<a name="l00524"></a>00524         <span class="keywordtype">float</span> v1[3], v2[3], v3[3], v4[4], lambda;
<a name="l00525"></a>00525         <span class="keywordtype">int</span> a, a1, a2, a0mul, a1mul, a2mul, totface;
<a name="l00526"></a>00526         <span class="keywordtype">int</span> amax= from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a> ? 3 : 1;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         totface=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00529"></a>00529         mface=mface_array=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l00530"></a>00530         
<a name="l00531"></a>00531         <span class="keywordflow">for</span> (a=0; a&lt;amax; a++) {
<a name="l00532"></a>00532             <span class="keywordflow">if</span> (a==0) { a0mul=res*res; a1mul=res; a2mul=1; }
<a name="l00533"></a>00533             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a==1) { a0mul=res; a1mul=1; a2mul=res*res; }
<a name="l00534"></a>00534             <span class="keywordflow">else</span> { a0mul=1; a1mul=res*res; a2mul=res; }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536             <span class="keywordflow">for</span> (a1=0; a1&lt;size[(a+1)%3]; a1++) {
<a name="l00537"></a>00537                 <span class="keywordflow">for</span> (a2=0; a2&lt;size[(a+2)%3]; a2++) {
<a name="l00538"></a>00538                     mface= mface_array;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540                     pa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + a1*a1mul + a2*a2mul;
<a name="l00541"></a>00541                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co1, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>);
<a name="l00542"></a>00542                     co1[a] -= d &lt; delta[a] ? d/2.f : delta[a]/2.f;
<a name="l00543"></a>00543                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co2, co1);
<a name="l00544"></a>00544                     co2[a] += delta[a] + 0.001f*d;
<a name="l00545"></a>00545                     co1[a] -= 0.001f*d;
<a name="l00546"></a>00546                     
<a name="l00547"></a>00547                     <span class="comment">/* lets intersect the faces */</span>
<a name="l00548"></a>00548                     <span class="keywordflow">for</span> (i=0; i&lt;totface; i++,mface++) {
<a name="l00549"></a>00549                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00550"></a>00550                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00551"></a>00551                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v3, mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a02070e89ddf56dc3d463aa88ce4b767d">isect_axial_line_tri_v3</a>(a, co1, co2, v2, v3, v1, &amp;lambda)) {
<a name="l00554"></a>00554                             <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>)
<a name="l00555"></a>00555                                 (pa+(int)(lambda*size[a])*a0mul)-&gt;flag &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00556"></a>00556                             <span class="keywordflow">else</span> <span class="comment">/* store number of intersections */</span>
<a name="l00557"></a>00557                                 (pa+(int)(lambda*size[a])*a0mul)-&gt;hair_index++;
<a name="l00558"></a>00558                         }
<a name="l00559"></a>00559                         
<a name="l00560"></a>00560                         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00561"></a>00561                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v4, mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a02070e89ddf56dc3d463aa88ce4b767d">isect_axial_line_tri_v3</a>(a, co1, co2, v4, v1, v3, &amp;lambda)) {
<a name="l00564"></a>00564                                 <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>)
<a name="l00565"></a>00565                                     (pa+(int)(lambda*size[a])*a0mul)-&gt;flag &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00566"></a>00566                                 <span class="keywordflow">else</span>
<a name="l00567"></a>00567                                     (pa+(<span class="keywordtype">int</span>)(lambda*size[a])*a0mul)-&gt;hair_index++;
<a name="l00568"></a>00568                             }
<a name="l00569"></a>00569                         }
<a name="l00570"></a>00570                     }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572                     <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>) {
<a name="l00573"></a>00573                         <span class="keywordtype">int</span> in=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a>%2;
<a name="l00574"></a>00574                         <span class="keywordflow">if</span> (in) pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a>++;
<a name="l00575"></a>00575                         <span class="keywordflow">for</span> (i=0; i&lt;size[0]; i++) {
<a name="l00576"></a>00576                             <span class="keywordflow">if</span> (in || (pa+i*a0mul)-&gt;hair_index%2)
<a name="l00577"></a>00577                                 (pa+i*a0mul)-&gt;flag &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00578"></a>00578                             <span class="comment">/* odd intersections == in-&gt;out / out-&gt;in */</span>
<a name="l00579"></a>00579                             <span class="comment">/* even intersections -&gt; in stays same */</span>
<a name="l00580"></a>00580                             in=(in + (pa+i*a0mul)-&gt;hair_index) % 2;
<a name="l00581"></a>00581                         }
<a name="l00582"></a>00582                     }
<a name="l00583"></a>00583                 }
<a name="l00584"></a>00584             }
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5af147419f5f11cc170d144f56fd55bb">PART_GRID_HEXAGONAL</a>) {
<a name="l00589"></a>00589         <span class="keywordflow">for</span> (i=0,p=0,pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; i&lt;res; i++) {
<a name="l00590"></a>00590             <span class="keywordflow">for</span> (j=0; j&lt;res; j++) {
<a name="l00591"></a>00591                 <span class="keywordflow">for</span> (k=0; k&lt;res; k++,p++,pa++) {
<a name="l00592"></a>00592                     <span class="keywordflow">if</span> (j%2)
<a name="l00593"></a>00593                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[0] += d/2.f;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595                     <span class="keywordflow">if</span> (k%2) {
<a name="l00596"></a>00596                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[0] += d/2.f;
<a name="l00597"></a>00597                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[1] += d/2.f;
<a name="l00598"></a>00598                     }
<a name="l00599"></a>00599                 }
<a name="l00600"></a>00600             }
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5e3a2df6c93a5a431c3935fec14b9049">PART_GRID_INVERT</a>) {
<a name="l00605"></a>00605         <span class="keywordflow">for</span> (i=0; i&lt;size[0]; i++) {
<a name="l00606"></a>00606             <span class="keywordflow">for</span> (j=0; j&lt;size[1]; j++) {
<a name="l00607"></a>00607                 pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + res*(i*res + j);
<a name="l00608"></a>00608                 <span class="keywordflow">for</span> (k=0; k&lt;size[2]; k++, pa++) {
<a name="l00609"></a>00609                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> ^= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l00610"></a>00610                 }
<a name="l00611"></a>00611             }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa3c7bb6985514be4bd3f75b6e27784ee">grid_rand</a> &gt; 0.f) {
<a name="l00616"></a>00616         <span class="keywordtype">float</span> rfac = d * psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa3c7bb6985514be4bd3f75b6e27784ee">grid_rand</a>;
<a name="l00617"></a>00617         <span class="keywordflow">for</span> (p=0,pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; p&lt;psys-&gt;totpart; p++,pa++) {
<a name="l00618"></a>00618             <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>)
<a name="l00619"></a>00619                 <span class="keywordflow">continue</span>;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[0] += rfac * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 31) - 0.5f);
<a name="l00622"></a>00622             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[1] += rfac * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 32) - 0.5f);
<a name="l00623"></a>00623             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[2] += rfac * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 33) - 0.5f);
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="comment">/* modified copy from rayshade.c */</span>
<a name="l00629"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae62551304367cda4f5dab63162e7f5d6">00629</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ae62551304367cda4f5dab63162e7f5d6">hammersley_create</a>(<span class="keywordtype">float</span> *out, <span class="keywordtype">int</span> n, <span class="keywordtype">int</span> seed, <span class="keywordtype">float</span> amount)
<a name="l00630"></a>00630 {
<a name="l00631"></a>00631     <a class="code" href="../../d0/d3e/structRNG.html">RNG</a> *rng;
<a name="l00632"></a>00632     <span class="keywordtype">double</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, t, <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>[2];
<a name="l00633"></a>00633     <span class="keywordtype">int</span> k, kk;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     rng = <a class="code" href="../../d3/d88/BLI__rand_8h.html#adf17633489552c8dd24245b3a9e02ea4">rng_new</a>(31415926 + n + seed);
<a name="l00636"></a>00636     offs[0]= <a class="code" href="../../d3/d88/BLI__rand_8h.html#aef30caecf44f55b171746cff9e6aa216">rng_getDouble</a>(rng) + (double)amount;
<a name="l00637"></a>00637     offs[1]= <a class="code" href="../../d3/d88/BLI__rand_8h.html#aef30caecf44f55b171746cff9e6aa216">rng_getDouble</a>(rng) + (double)amount;
<a name="l00638"></a>00638     <a class="code" href="../../d3/d88/BLI__rand_8h.html#af2fb0bfbfbf970240b7a1dcaa3130196">rng_free</a>(rng);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="keywordflow">for</span> (k = 0; k &lt; n; k++) {
<a name="l00641"></a>00641         t = 0;
<a name="l00642"></a>00642         <span class="keywordflow">for</span> (p = 0.5, kk = k; kk; p *= 0.5, kk &gt;&gt;= 1)
<a name="l00643"></a>00643             <span class="keywordflow">if</span> (kk &amp; 1) <span class="comment">/* kk mod 2 = 1 */</span>
<a name="l00644"></a>00644                 t += <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         out[2*k + 0]= fmod((<span class="keywordtype">double</span>)k/(<span class="keywordtype">double</span>)n + offs[0], 1.0);
<a name="l00647"></a>00647         out[2*k + 1]= fmod(t + offs[1], 1.0);
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/* modified copy from effect.c */</span>
<a name="l00652"></a><a class="code" href="../../df/d40/particle__system_8c.html#a0655333dde9d84cf56b5aa3096c11ece">00652</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a0655333dde9d84cf56b5aa3096c11ece">init_mv_jit</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>, <span class="keywordtype">int</span> num, <span class="keywordtype">int</span> seed2, <span class="keywordtype">float</span> amount)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <a class="code" href="../../d0/d3e/structRNG.html">RNG</a> *rng;
<a name="l00655"></a>00655     <span class="keywordtype">float</span> *jit2, x, rad1, rad2, rad3;
<a name="l00656"></a>00656     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, num2;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (num==0) <span class="keywordflow">return</span>;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     rad1= (float)(1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>((<span class="keywordtype">float</span>)num));
<a name="l00661"></a>00661     rad2= (float)(1.0f/((<span class="keywordtype">float</span>)num));
<a name="l00662"></a>00662     rad3= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>((<span class="keywordtype">float</span>)num)/((<span class="keywordtype">float</span>)num);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     rng = <a class="code" href="../../d3/d88/BLI__rand_8h.html#adf17633489552c8dd24245b3a9e02ea4">rng_new</a>(31415926 + num + seed2);
<a name="l00665"></a>00665     x= 0;
<a name="l00666"></a>00666         num2 = 2 * num;
<a name="l00667"></a>00667     <span class="keywordflow">for</span> (i=0; i&lt;num2; i+=2) {
<a name="l00668"></a>00668     
<a name="l00669"></a>00669         jit[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= x + amount*rad1*(0.5f - <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(rng));
<a name="l00670"></a>00670         jit[i+1]= i/(2.0f*num) + amount*rad1*(0.5f - <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(rng));
<a name="l00671"></a>00671         
<a name="l00672"></a>00672         jit[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-= (float)floor(jit[i]);
<a name="l00673"></a>00673         jit[i+1]-= (float)floor(jit[i+1]);
<a name="l00674"></a>00674         
<a name="l00675"></a>00675         x+= rad3;
<a name="l00676"></a>00676         x -= (float)floor(x);
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     jit2= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(12 + 2*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*num, <span class="stringliteral">&quot;initjit&quot;</span>);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">for</span> (i=0 ; i&lt;4 ; i++) {
<a name="l00682"></a>00682         <a class="code" href="../../d5/d49/BLI__jitter_8h.html#a213b6b3a55fe35b94e6840229d479696">BLI_jitterate1</a>(jit, jit2, num, rad1);
<a name="l00683"></a>00683         <a class="code" href="../../d5/d49/BLI__jitter_8h.html#a213b6b3a55fe35b94e6840229d479696">BLI_jitterate1</a>(jit, jit2, num, rad1);
<a name="l00684"></a>00684         <a class="code" href="../../d5/d49/BLI__jitter_8h.html#a8a80bf257d88cd8c95002bcfa8a124f0">BLI_jitterate2</a>(jit, jit2, num, rad2);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(jit2);
<a name="l00687"></a>00687     <a class="code" href="../../d3/d88/BLI__rand_8h.html#af2fb0bfbfbf970240b7a1dcaa3130196">rng_free</a>(rng);
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">00690</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(<span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">int</span> quad, <span class="keywordtype">float</span> *w)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <span class="keywordtype">float</span> vert[4][3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (!quad) {
<a name="l00695"></a>00695         <span class="keywordflow">if</span> (u+v &gt; 1.0f)
<a name="l00696"></a>00696             v= 1.0f-v;
<a name="l00697"></a>00697         <span class="keywordflow">else</span>
<a name="l00698"></a>00698             u= 1.0f-u;
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     vert[0][0]= 0.0f; vert[0][1]= 0.0f; vert[0][2]= 0.0f;
<a name="l00702"></a>00702     vert[1][0]= 1.0f; vert[1][1]= 0.0f; vert[1][2]= 0.0f;
<a name="l00703"></a>00703     vert[2][0]= 1.0f; vert[2][1]= 1.0f; vert[2][2]= 0.0f;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     co[0]= u;
<a name="l00706"></a>00706     co[1]= v;
<a name="l00707"></a>00707     co[2]= 0.0f;
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (quad) {
<a name="l00710"></a>00710         vert[3][0]= 0.0f; vert[3][1]= 1.0f; vert[3][2]= 0.0f;
<a name="l00711"></a>00711         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9ad37845c890fd4002636cd5a5145b8d">interp_weights_poly_v3</a>( w,vert, 4, co);
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713     <span class="keywordflow">else</span> {
<a name="l00714"></a>00714         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9ad37845c890fd4002636cd5a5145b8d">interp_weights_poly_v3</a>( w,vert, 3, co);
<a name="l00715"></a>00715         w[3]= 0.0f;
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 <span class="comment">/* Find the index in &quot;sum&quot; array before &quot;value&quot; is crossed. */</span>
<a name="l00720"></a><a class="code" href="../../df/d40/particle__system_8c.html#a28a067ad02d6090f3e24030c8da13d3d">00720</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#a28a067ad02d6090f3e24030c8da13d3d">distribute_binary_search</a>(<span class="keywordtype">float</span> *<a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>, <span class="keywordtype">int</span> n, <span class="keywordtype">float</span> value)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722     <span class="keywordtype">int</span> mid, low=0, high=n;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (value == 0.f)
<a name="l00725"></a>00725         <span class="keywordflow">return</span> 0;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordflow">while</span> (low &lt;= high) {
<a name="l00728"></a>00728         mid= (low + high)/2;
<a name="l00729"></a>00729         
<a name="l00730"></a>00730         <span class="keywordflow">if</span> (sum[mid] &lt; value &amp;&amp; value &lt;= sum[mid+1])
<a name="l00731"></a>00731             <span class="keywordflow">return</span> mid;
<a name="l00732"></a>00732         
<a name="l00733"></a>00733         <span class="keywordflow">if</span> (sum[mid] &gt;= value)
<a name="l00734"></a>00734             high= mid - 1;
<a name="l00735"></a>00735         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sum[mid] &lt; value)
<a name="l00736"></a>00736             low= mid + 1;
<a name="l00737"></a>00737         <span class="keywordflow">else</span>
<a name="l00738"></a>00738             <span class="keywordflow">return</span> mid;
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">return</span> low;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="comment">/* the max number if calls to rng_* funcs within psys_thread_distribute_particle</span>
<a name="l00745"></a>00745 <span class="comment"> * be sure to keep up to date if this changes */</span>
<a name="l00746"></a><a class="code" href="../../df/d40/particle__system_8c.html#a1a2e651987eb2b5aa3b06c1903d66f10">00746</a> <span class="preprocessor">#define PSYS_RND_DIST_SKIP 2</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span>
<a name="l00748"></a>00748 <span class="comment">/* note: this function must be thread safe, for from == PART_FROM_CHILD */</span>
<a name="l00749"></a><a class="code" href="../../df/d40/particle__system_8c.html#a0552217f5fb389851ba464fff3be517b">00749</a> <span class="preprocessor">#define ONLY_WORKING_WITH_PA_VERTS 0</span>
<a name="l00750"></a><a class="code" href="../../df/d40/particle__system_8c.html#af167ed52672a06324bc857e236bb6099">00750</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#af167ed52672a06324bc857e236bb6099">distribute_threads_exec</a>(<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../df/d68/classthread.html">thread</a>, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a> *cpa, <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752     <a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a> *ctx= thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>;
<a name="l00753"></a>00753     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l00754"></a>00754     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>;
<a name="l00755"></a>00755     <span class="keywordtype">float</span> *v1, *v2, *v3, *v4, nor[3], orco1[3], co1[3], co2[3], nor1[3];
<a name="l00756"></a>00756     <span class="keywordtype">float</span> cur_d, min_d, randu, randv;
<a name="l00757"></a>00757     <span class="keywordtype">int</span> from= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ad75aded14ce530ec4542fabd33a85cf6">from</a>;
<a name="l00758"></a>00758     <span class="keywordtype">int</span> cfrom= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a8ac7e6543a8d228f4f55d48b31a078a0">cfrom</a>;
<a name="l00759"></a>00759     <span class="keywordtype">int</span> distr= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a75b03abad91c9c3b0bb6f259b5745ae1">distr</a>;
<a name="l00760"></a>00760     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../dc/de7/rayobject__vbvh_8cpp.html#ae47a935fc48f1b53ebf1d7bab772119d">intersect</a>, tot;
<a name="l00761"></a>00761     <span class="keywordtype">int</span> rng_skip_tot= <a class="code" href="../../df/d40/particle__system_8c.html#a1a2e651987eb2b5aa3b06c1903d66f10">PSYS_RND_DIST_SKIP</a>; <span class="comment">/* count how many rng_* calls wont need skipping */</span>
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l00764"></a>00764         <span class="comment">/* TODO_PARTICLE - use original index */</span>
<a name="l00765"></a>00765         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>];
<a name="l00766"></a>00766         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[0] = 1.0f;
<a name="l00767"></a>00767         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[1] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[2] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>[3] = 0.0;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="preprocessor">#if ONLY_WORKING_WITH_PA_VERTS</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>) {
<a name="l00771"></a>00771             <a class="code" href="../../d8/d5e/structKDTreeNearest.html">KDTreeNearest</a> ptn[3];
<a name="l00772"></a>00772             <span class="keywordtype">int</span> w, maxw;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774             <a class="code" href="../../db/dca/BKE__particle_8h.html#a1be7be1e92f5a4afbbf0c36702c3d87d">psys_particle_on_dm</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>,from,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#abd27ee5e6b3a527ab7110c3b95c45a7e">num_dmcache</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>,co1,0,0,0,orco1,0);
<a name="l00775"></a>00775             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;orco1, 1, 1);
<a name="l00776"></a>00776             maxw = <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a10606aea7ae93856150fa5449e2f48aa">BLI_kdtree_find_n_nearest</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>,3,orco1,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,ptn);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778             <span class="keywordflow">for</span> (w=0; w&lt;maxw; w++) {
<a name="l00779"></a>00779                 pa-&gt;verts[w]=ptn-&gt;num;
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781         }
<a name="l00782"></a>00782 <span class="preprocessor">#endif</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>    }
<a name="l00784"></a>00784     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a> || from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>) {
<a name="l00785"></a>00785         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a> = i = ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>];
<a name="l00788"></a>00788         mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm,i,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l00789"></a>00789         
<a name="l00790"></a>00790         <span class="keywordflow">switch</span>(distr) {
<a name="l00791"></a>00791         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a76c24af3e61b9d908298b0febc6511c4">PART_DISTR_JIT</a>:
<a name="l00792"></a>00792             <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a9f156ba1ecc70aa44c63cdfc768ee878">jitlevel</a> == 1) {
<a name="l00793"></a>00793                 <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l00794"></a>00794                     <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(0.5f, 0.5f, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>);
<a name="l00795"></a>00795                 <span class="keywordflow">else</span>
<a name="l00796"></a>00796                     <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(0.33333f, 0.33333f, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>);
<a name="l00797"></a>00797             }
<a name="l00798"></a>00798             <span class="keywordflow">else</span> {
<a name="l00799"></a>00799                 ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = fmod(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>[i],(<span class="keywordtype">float</span>)ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a9f156ba1ecc70aa44c63cdfc768ee878">jitlevel</a>);
<a name="l00800"></a>00800                 <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>[2*(<span class="keywordtype">int</span>)ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>[i]], ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>[2*(<span class="keywordtype">int</span>)ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>[i]+1], mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>);
<a name="l00801"></a>00801                 ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]++;
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803             <span class="keywordflow">break</span>;
<a name="l00804"></a>00804         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a91c64c15008ec147d653014e1e103660">PART_DISTR_RAND</a>:
<a name="l00805"></a>00805             randu= <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>);
<a name="l00806"></a>00806             randv= <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>);
<a name="l00807"></a>00807             rng_skip_tot -= 2;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(randu, randv, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>);
<a name="l00810"></a>00810             <span class="keywordflow">break</span>;
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>= 0.0f;
<a name="l00813"></a>00813         
<a name="l00814"></a>00814         <span class="comment">/* experimental */</span>
<a name="l00815"></a>00815         <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>) {
<a name="l00816"></a>00816             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818             tot=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820             <a class="code" href="../../db/dca/BKE__particle_8h.html#a949cbdd85b5c98945248d86737f5e2d9">psys_interpolate_face</a>(mvert,mface,0,0,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,co1,nor,0,0,0,0);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l00823"></a>00823             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(nor,-100.0);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co2,co1,nor);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827             min_d=2.0;
<a name="l00828"></a>00828             intersect=0;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830             <span class="keywordflow">for</span> (i=0,mface=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>); i&lt;tot; i++,mface++) {
<a name="l00831"></a>00831                 <span class="keywordflow">if</span> (i==pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>) <span class="keywordflow">continue</span>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833                 v1=mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00834"></a>00834                 v2=mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00835"></a>00835                 v3=mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00836"></a>00836 
<a name="l00837"></a>00837                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(co1, co2, v2, v3, v1, &amp;cur_d, 0)) {
<a name="l00838"></a>00838                     <span class="keywordflow">if</span> (cur_d&lt;min_d) {
<a name="l00839"></a>00839                         min_d=cur_d;
<a name="l00840"></a>00840                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>=cur_d*50.0f; <span class="comment">/* to the middle of volume */</span>
<a name="l00841"></a>00841                         intersect=1;
<a name="l00842"></a>00842                     }
<a name="l00843"></a>00843                 }
<a name="l00844"></a>00844                 <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00845"></a>00845                     v4=mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(co1, co2, v4, v1, v3, &amp;cur_d, 0)) {
<a name="l00848"></a>00848                         <span class="keywordflow">if</span> (cur_d&lt;min_d) {
<a name="l00849"></a>00849                             min_d=cur_d;
<a name="l00850"></a>00850                             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>=cur_d*50.0f; <span class="comment">/* to the middle of volume */</span>
<a name="l00851"></a>00851                             intersect=1;
<a name="l00852"></a>00852                         }
<a name="l00853"></a>00853                     }
<a name="l00854"></a>00854                 }
<a name="l00855"></a>00855             }
<a name="l00856"></a>00856             <span class="keywordflow">if</span> (intersect==0)
<a name="l00857"></a>00857                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>=0.0;
<a name="l00858"></a>00858             <span class="keywordflow">else</span> <span class="keywordflow">switch</span>(distr) {
<a name="l00859"></a>00859                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a76c24af3e61b9d908298b0febc6511c4">PART_DISTR_JIT</a>:
<a name="l00860"></a>00860                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>*= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>[p%(2*ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a9f156ba1ecc70aa44c63cdfc768ee878">jitlevel</a>)];
<a name="l00861"></a>00861                     <span class="keywordflow">break</span>;
<a name="l00862"></a>00862                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a91c64c15008ec147d653014e1e103660">PART_DISTR_RAND</a>:
<a name="l00863"></a>00863                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>*=<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>();
<a name="l00864"></a>00864                     <span class="keywordflow">break</span>;
<a name="l00865"></a>00865             }
<a name="l00866"></a>00866         }
<a name="l00867"></a>00867     }
<a name="l00868"></a>00868     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>) {
<a name="l00869"></a>00869         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>[p] &lt; 0) {
<a name="l00872"></a>00872             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>=0;
<a name="l00873"></a>00873             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[0]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[1]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[2]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[3]=0.0f;
<a name="l00874"></a>00874             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[0]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[1]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[2]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[3]=0;
<a name="l00875"></a>00875             <span class="keywordflow">return</span>;
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878         mf= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm, ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>[p], <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         randu= <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>);
<a name="l00881"></a>00881         randv= <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>);
<a name="l00882"></a>00882         rng_skip_tot -= 2;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884         <a class="code" href="../../df/d40/particle__system_8c.html#ad0aa73b2f429d1ac5b1d5216fcbf342c">psys_uv_to_w</a>(randu, randv, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>);
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a> = ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>];
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>) {
<a name="l00889"></a>00889             <a class="code" href="../../d8/d5e/structKDTreeNearest.html">KDTreeNearest</a> ptn[10];
<a name="l00890"></a>00890             <span class="keywordtype">int</span> w,maxw;<span class="comment">//, do_seams;</span>
<a name="l00891"></a>00891             <span class="keywordtype">float</span> maxd <span class="comment">/*, mind,dd */</span>, totw= 0.0f;
<a name="l00892"></a>00892             <span class="keywordtype">int</span> parent[10];
<a name="l00893"></a>00893             <span class="keywordtype">float</span> pweight[10];
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             <a class="code" href="../../db/dca/BKE__particle_8h.html#a1be7be1e92f5a4afbbf0c36702c3d87d">psys_particle_on_dm</a>(dm,cfrom,cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>,<a class="code" href="../../db/dca/BKE__particle_8h.html#ac984be3edf343c7fbc2c73b49d0048b4">DMCACHE_ISCHILD</a>,cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>,cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a60ac3dbb770e8bb819a8de45749dfe2a">foffset</a>,co1,nor1,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,orco1,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00896"></a>00896             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;orco1, 1, 1);
<a name="l00897"></a>00897             maxw = <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a10606aea7ae93856150fa5449e2f48aa">BLI_kdtree_find_n_nearest</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>,4,orco1,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,ptn);
<a name="l00898"></a>00898 
<a name="l00899"></a>00899             maxd=ptn[maxw-1].<a class="code" href="../../d8/d5e/structKDTreeNearest.html#a77b2e35999cece1d30f60e7864ac6059">dist</a>;
<a name="l00900"></a>00900             <span class="comment">/* mind=ptn[0].dist; */</span> <span class="comment">/* UNUSED */</span>
<a name="l00901"></a>00901             
<a name="l00902"></a>00902             <span class="comment">/* the weights here could be done better */</span>
<a name="l00903"></a>00903             <span class="keywordflow">for</span> (w=0; w&lt;maxw; w++) {
<a name="l00904"></a>00904                 parent[w]=ptn[w].<a class="code" href="../../d8/d5e/structKDTreeNearest.html#aa2903383acdfa6c474e7cf804e1d71c7">index</a>;
<a name="l00905"></a>00905                 pweight[w]=(float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(2.0,(<span class="keywordtype">double</span>)(-6.0f*ptn[w].<a class="code" href="../../d8/d5e/structKDTreeNearest.html#a77b2e35999cece1d30f60e7864ac6059">dist</a>/maxd));
<a name="l00906"></a>00906             }
<a name="l00907"></a>00907             <span class="keywordflow">for</span> (;w&lt;10; w++) {
<a name="l00908"></a>00908                 parent[w]=-1;
<a name="l00909"></a>00909                 pweight[w]=0.0f;
<a name="l00910"></a>00910             }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912             <span class="keywordflow">for</span> (w=0,i=0; w&lt;maxw &amp;&amp; i&lt;4; w++) {
<a name="l00913"></a>00913                 <span class="keywordflow">if</span> (parent[w]&gt;=0) {
<a name="l00914"></a>00914                     cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]=parent[w];
<a name="l00915"></a>00915                     cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a26ee9d21a455ded095002579aaac095d">w</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]=pweight[w];
<a name="l00916"></a>00916                     totw+=pweight[w];
<a name="l00917"></a>00917                     i++;
<a name="l00918"></a>00918                 }
<a name="l00919"></a>00919             }
<a name="l00920"></a>00920             <span class="keywordflow">for</span> (;i&lt;4; i++) {
<a name="l00921"></a>00921                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]=-1;
<a name="l00922"></a>00922                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a26ee9d21a455ded095002579aaac095d">w</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]=0.0f;
<a name="l00923"></a>00923             }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925             <span class="keywordflow">if</span> (totw&gt;0.0f) <span class="keywordflow">for</span> (w=0; w&lt;4; w++)
<a name="l00926"></a>00926                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a26ee9d21a455ded095002579aaac095d">w</a>[w]/=totw;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928             cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ab2c1496d7cac367b2e04cf9f908e9580">parent</a>=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[0];
<a name="l00929"></a>00929         }
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordflow">if</span> (rng_skip_tot &gt; 0) <span class="comment">/* should never be below zero */</span>
<a name="l00933"></a>00933         <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7d4d05d04fc393eb93be2cbe6066f51d">rng_skip</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>, rng_skip_tot);
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a><a class="code" href="../../df/d40/particle__system_8c.html#a4d2b3badf33c43b98a86af83c9cec581">00936</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../df/d40/particle__system_8c.html#a4d2b3badf33c43b98a86af83c9cec581">distribute_threads_exec_cb</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../df/d68/classthread.html">thread</a>= (<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a>*)data;
<a name="l00939"></a>00939     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l00940"></a>00940     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa;
<a name="l00941"></a>00941     <a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a> *cpa;
<a name="l00942"></a>00942     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, totpart;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     <span class="keywordflow">if</span> (thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ad75aded14ce530ec4542fabd33a85cf6">from</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>) {
<a name="l00945"></a>00945         totpart= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>;
<a name="l00946"></a>00946         cpa= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948         <span class="keywordflow">for</span> (p=0; p&lt;totpart; p++, cpa++) {
<a name="l00949"></a>00949             <span class="keywordflow">if</span> (thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a6a1cd1e1fc8722a32aa3fee8e3d12b7f">skip</a>) <span class="comment">/* simplification skip */</span>
<a name="l00950"></a>00950                 <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7d4d05d04fc393eb93be2cbe6066f51d">rng_skip</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>, <a class="code" href="../../df/d40/particle__system_8c.html#a1a2e651987eb2b5aa3b06c1903d66f10">PSYS_RND_DIST_SKIP</a> * thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a6a1cd1e1fc8722a32aa3fee8e3d12b7f">skip</a>[p]);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952             <span class="keywordflow">if</span> ((p+thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a34e2fd2c169bc6b029395beb7b2184be">num</a>) % thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a> == 0)
<a name="l00953"></a>00953                 <a class="code" href="../../df/d40/particle__system_8c.html#af167ed52672a06324bc857e236bb6099">distribute_threads_exec</a>(thread, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, cpa, p);
<a name="l00954"></a>00954             <span class="keywordflow">else</span> <span class="comment">/* thread skip */</span>
<a name="l00955"></a>00955                 <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7d4d05d04fc393eb93be2cbe6066f51d">rng_skip</a>(thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>, <a class="code" href="../../df/d40/particle__system_8c.html#a1a2e651987eb2b5aa3b06c1903d66f10">PSYS_RND_DIST_SKIP</a>);
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958     <span class="keywordflow">else</span> {
<a name="l00959"></a>00959         totpart= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l00960"></a>00960         pa= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a34e2fd2c169bc6b029395beb7b2184be">num</a>;
<a name="l00961"></a>00961         <span class="keywordflow">for</span> (p=thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a34e2fd2c169bc6b029395beb7b2184be">num</a>; p&lt;totpart; p+=thread-&gt;tot, pa+=thread-&gt;<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>)
<a name="l00962"></a>00962             <a class="code" href="../../df/d40/particle__system_8c.html#af167ed52672a06324bc857e236bb6099">distribute_threads_exec</a>(thread, pa, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, p);
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <span class="keywordflow">return</span> 0;
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 <span class="comment">/* not thread safe, but qsort doesn&#39;t take userdata argument */</span>
<a name="l00969"></a><a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">00969</a> <span class="keyword">static</span> <span class="keywordtype">int</span> *<a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00970"></a><a class="code" href="../../df/d40/particle__system_8c.html#a4ddefa6ed4be1af2e7538b8cc96a17a9">00970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#a4ddefa6ed4be1af2e7538b8cc96a17a9">distribute_compare_orig_index</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *p1, <span class="keyword">const</span> <span class="keywordtype">void</span> *p2)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972     <span class="keywordtype">int</span> index1 = <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a>[*(<span class="keyword">const</span> <span class="keywordtype">int</span>*)p1];
<a name="l00973"></a>00973     <span class="keywordtype">int</span> index2 = <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a>[*(<span class="keyword">const</span> <span class="keywordtype">int</span>*)p2];
<a name="l00974"></a>00974 
<a name="l00975"></a>00975     <span class="keywordflow">if</span> (index1 &lt; index2)
<a name="l00976"></a>00976         <span class="keywordflow">return</span> -1;
<a name="l00977"></a>00977     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (index1 == index2) {
<a name="l00978"></a>00978         <span class="comment">/* this pointer comparison appears to make qsort stable for glibc,</span>
<a name="l00979"></a>00979 <span class="comment">         * and apparently on solaris too, makes the renders reproducible */</span>
<a name="l00980"></a>00980         <span class="keywordflow">if</span> (p1 &lt; p2)
<a name="l00981"></a>00981             <span class="keywordflow">return</span> -1;
<a name="l00982"></a>00982         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p1 == p2)
<a name="l00983"></a>00983             <span class="keywordflow">return</span> 0;
<a name="l00984"></a>00984         <span class="keywordflow">else</span>
<a name="l00985"></a>00985             <span class="keywordflow">return</span> 1;
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987     <span class="keywordflow">else</span>
<a name="l00988"></a>00988         <span class="keywordflow">return</span> 1;
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l00991"></a><a class="code" href="../../df/d40/particle__system_8c.html#aec9964bdfefeac143628110b3a67f94c">00991</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aec9964bdfefeac143628110b3a67f94c">distribute_invalid</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> from)
<a name="l00992"></a>00992 {
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>) {
<a name="l00994"></a>00994         <a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a> *cpa;
<a name="l00995"></a>00995         <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, totchild = <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(scene, psys);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a> &amp;&amp; totchild) {
<a name="l00998"></a>00998             <span class="keywordflow">for</span> (p=0,cpa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>; p&lt;totchild; p++,cpa++) {
<a name="l00999"></a>00999                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[0]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[1]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[2]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>[3]= 0.0;
<a name="l01000"></a>01000                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a60ac3dbb770e8bb819a8de45749dfe2a">foffset</a>= 0.0f;
<a name="l01001"></a>01001                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ab2c1496d7cac367b2e04cf9f908e9580">parent</a>=0;
<a name="l01002"></a>01002                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[0]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[1]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[2]=cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ac5fa0e3844d2e5bf2059e00ab432e08c">pa</a>[3]=0;
<a name="l01003"></a>01003                 cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>= -1;
<a name="l01004"></a>01004             }
<a name="l01005"></a>01005         }
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007     <span class="keywordflow">else</span> {
<a name="l01008"></a>01008         <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l01009"></a>01009         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l01010"></a>01010             pa-&gt;fuv[0]=pa-&gt;fuv[1]=pa-&gt;fuv[2]= pa-&gt;fuv[3]= 0.0;
<a name="l01011"></a>01011             pa-&gt;foffset= 0.0f;
<a name="l01012"></a>01012             pa-&gt;num= -1;
<a name="l01013"></a>01013         }
<a name="l01014"></a>01014     }
<a name="l01015"></a>01015 }
<a name="l01016"></a>01016 
<a name="l01017"></a>01017 <span class="comment">/* Creates a distribution of coordinates on a DerivedMesh   */</span>
<a name="l01018"></a>01018 <span class="comment">/* This is to denote functionality that does not yet work with mesh - only derived mesh */</span>
<a name="l01019"></a><a class="code" href="../../df/d40/particle__system_8c.html#af8b8589ca7628c59fe9eda740519ce81">01019</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#af8b8589ca7628c59fe9eda740519ce81">distribute_threads_init_data</a>(<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *finaldm, <span class="keywordtype">int</span> from)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021     <a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a> *ctx= threads[0].<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>;
<a name="l01022"></a>01022     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l01023"></a>01023     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01024"></a>01024     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa=0, *tpars= 0;
<a name="l01025"></a>01025     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part;
<a name="l01026"></a>01026     <a class="code" href="../../d2/dd6/structParticleSeam.html">ParticleSeam</a> *seams= 0;
<a name="l01027"></a>01027     <a class="code" href="../../da/da8/structKDTree.html">KDTree</a> *tree=0;
<a name="l01028"></a>01028     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01029"></a>01029     <span class="keywordtype">float</span> *<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01030"></a>01030     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, seed, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=0, totthread= threads[0].<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>;
<a name="l01031"></a>01031     <span class="keywordtype">int</span> cfrom=0;
<a name="l01032"></a>01032     <span class="keywordtype">int</span> <a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>=0, totpart, *particle_element=0, children=0, totseam=0;
<a name="l01033"></a>01033     <span class="keywordtype">int</span> jitlevel= 1, distr;
<a name="l01034"></a>01034     <span class="keywordtype">float</span> *element_weight=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,*element_sum=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,*jitter_offset=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *vweight=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01035"></a>01035     <span class="keywordtype">float</span> cur, maxweight=0.0, tweight, totweight, inv_totweight, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], nor[3], orco[3], ornor[3];
<a name="l01036"></a>01036     
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, psys, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>))
<a name="l01038"></a>01038         <span class="keywordflow">return</span> 0;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l01041"></a>01041     totpart=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (totpart==0)
<a name="l01043"></a>01043         <span class="keywordflow">return</span> 0;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (!finaldm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab759ebc0e7d00291ab54b0ace0e118c1">deformedOnly</a> &amp;&amp; !finaldm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(finaldm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>)) {
<a name="l01046"></a>01046         printf(<span class="stringliteral">&quot;Can&#39;t create particles with the current modifier stack, disable destructive modifiers\n&quot;</span>);
<a name="l01047"></a>01047 <span class="comment">// XXX      error(&quot;Can&#39;t paint with the current modifier stack, disable destructive modifiers&quot;);</span>
<a name="l01048"></a>01048         <span class="keywordflow">return</span> 0;
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="comment">/* First handle special cases */</span>
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>) {
<a name="l01053"></a>01053         <span class="comment">/* Simple children */</span>
<a name="l01054"></a>01054         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7abd73329b3203429f5cc4e4782b7296">PART_CHILD_FACES</a>) {
<a name="l01055"></a>01055             <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(31415926 + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a> + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab0981f9288c042d438465a190f1ae85c">child_seed</a>);
<a name="l01056"></a>01056             <a class="code" href="../../df/d40/particle__system_8c.html#acdebafd5ba1e222bb0db5d9e33d7afc3">distribute_simple_children</a>(scene, ob, finaldm, psys);
<a name="l01057"></a>01057             <span class="keywordflow">return</span> 0;
<a name="l01058"></a>01058         }
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060     <span class="keywordflow">else</span> {
<a name="l01061"></a>01061         <span class="comment">/* Grid distribution */</span>
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93c2418e9c7c39a31da98a0ccbf31363">PART_DISTR_GRID</a> &amp;&amp; from != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01063"></a>01063             <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(31415926 + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>);
<a name="l01064"></a>01064             dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, ob);
<a name="l01065"></a>01065             <a class="code" href="../../df/d40/particle__system_8c.html#af6fd3410e2d4538aa884bc7838f7ae9f">distribute_grid</a>(dm,psys);
<a name="l01066"></a>01066             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01067"></a>01067             <span class="keywordflow">return</span> 0;
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069     }
<a name="l01070"></a>01070     
<a name="l01071"></a>01071     <span class="comment">/* Create trees and original coordinates if needed */</span>
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>) {
<a name="l01073"></a>01073         distr=<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a91c64c15008ec147d653014e1e103660">PART_DISTR_RAND</a>;
<a name="l01074"></a>01074         <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(31415926 + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a> + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab0981f9288c042d438465a190f1ae85c">child_seed</a>);
<a name="l01075"></a>01075         dm= finaldm;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="comment">/* BMESH ONLY */</span>
<a name="l01078"></a>01078         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(dm);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080         children=1;
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         tree=<a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aee4ccfd7db96a8b1ee06174e581a7d9d">BLI_kdtree_new</a>(totpart);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084         <span class="keywordflow">for</span> (p=0,pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; p&lt;totpart; p++,pa++) {
<a name="l01085"></a>01085             <a class="code" href="../../db/dca/BKE__particle_8h.html#a1be7be1e92f5a4afbbf0c36702c3d87d">psys_particle_on_dm</a>(dm,part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#abd27ee5e6b3a527ab7110c3b95c45a7e">num_dmcache</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>,co,nor,0,0,orco,ornor);
<a name="l01086"></a>01086             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;orco, 1, 1);
<a name="l01087"></a>01087             <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a23d67a64dfd26f5f2818d92a4580dccb">BLI_kdtree_insert</a>(tree, p, orco, ornor);
<a name="l01088"></a>01088         }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a38e3a059e408f7c3164f4e0ef5ab3b7a">BLI_kdtree_balance</a>(tree);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         totpart = <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(scene, psys);
<a name="l01093"></a>01093         cfrom = from = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>;
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095     <span class="keywordflow">else</span> {
<a name="l01096"></a>01096         distr = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a>;
<a name="l01097"></a>01097         <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(31415926 + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>);
<a name="l01098"></a>01098         
<a name="l01099"></a>01099         dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, ob);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101         <span class="comment">/* BMESH ONLY, for verts we don&#39;t care about tessfaces */</span>
<a name="l01102"></a>01102         <span class="keywordflow">if</span> (from != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01103"></a>01103             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(dm);
<a name="l01104"></a>01104         }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="comment">/* we need orco for consistent distributions */</span>
<a name="l01107"></a>01107         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1d5e2eb6e1a26961b60f0cac4a7411bc">DM_add_vert_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a397c869231e123f1bf2b24d7a9642258">get_mesh_orco_verts</a>(ob));
<a name="l01108"></a>01108 
<a name="l01109"></a>01109         <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01110"></a>01110             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l01111"></a>01111             float (*orcodata)[3]= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01112"></a>01112             <span class="keywordtype">int</span> totvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114             tree=<a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aee4ccfd7db96a8b1ee06174e581a7d9d">BLI_kdtree_new</a>(totvert);
<a name="l01115"></a>01115 
<a name="l01116"></a>01116             <span class="keywordflow">for</span> (p=0; p&lt;totvert; p++) {
<a name="l01117"></a>01117                 <span class="keywordflow">if</span> (orcodata) {
<a name="l01118"></a>01118                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co,orcodata[p]);
<a name="l01119"></a>01119                     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;co, 1, 1);
<a name="l01120"></a>01120                 }
<a name="l01121"></a>01121                 <span class="keywordflow">else</span>
<a name="l01122"></a>01122                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co,mv[p].co);
<a name="l01123"></a>01123                 <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a23d67a64dfd26f5f2818d92a4580dccb">BLI_kdtree_insert</a>(tree,p,co,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01124"></a>01124             }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126             <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a38e3a059e408f7c3164f4e0ef5ab3b7a">BLI_kdtree_balance</a>(tree);
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128     }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="comment">/* Get total number of emission elements and allocate needed arrays */</span>
<a name="l01131"></a>01131     totelem = (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) ? dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm) : dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <span class="keywordflow">if</span> (totelem == 0) {
<a name="l01134"></a>01134         <a class="code" href="../../df/d40/particle__system_8c.html#aec9964bdfefeac143628110b3a67f94c">distribute_invalid</a>(scene, psys, children ? <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a> : 0);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01137"></a>01137             fprintf(stderr,<span class="stringliteral">&quot;Particle distribution error: Nothing to emit from!\n&quot;</span>);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139         <span class="keywordflow">if</span> (dm != finaldm) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01140"></a>01140 
<a name="l01141"></a>01141         <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aa2320bf47d28237bc6933a090b3eb51b">BLI_kdtree_free</a>(tree);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143         <span class="keywordflow">return</span> 0;
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     element_weight  = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totelem, <span class="stringliteral">&quot;particle_distribution_weights&quot;</span>);
<a name="l01147"></a>01147     particle_element= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*totpart, <span class="stringliteral">&quot;particle_distribution_indexes&quot;</span>);
<a name="l01148"></a>01148     element_sum     = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(totelem+1), <span class="stringliteral">&quot;particle_distribution_sum&quot;</span>);
<a name="l01149"></a>01149     jitter_offset   = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totelem, <span class="stringliteral">&quot;particle_distribution_jitoff&quot;</span>);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151     <span class="comment">/* Calculate weights from face areas */</span>
<a name="l01152"></a>01152     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a36511d912291f8d1302ac2e9552f6805">PART_EDISTR</a> || children) &amp;&amp; from != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01153"></a>01153         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v1, *v2, *v3, *v4;
<a name="l01154"></a>01154         <span class="keywordtype">float</span> totarea=0.f, co1[3], co2[3], co3[3], co4[3];
<a name="l01155"></a>01155         float (*orcodata)[3];
<a name="l01156"></a>01156         
<a name="l01157"></a>01157         orcodata= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++) {
<a name="l01160"></a>01160             <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm,i,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162             <span class="keywordflow">if</span> (orcodata) {
<a name="l01163"></a>01163                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co1, orcodata[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]);
<a name="l01164"></a>01164                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co2, orcodata[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]);
<a name="l01165"></a>01165                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co3, orcodata[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]);
<a name="l01166"></a>01166                 <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;co1, 1, 1);
<a name="l01167"></a>01167                 <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;co2, 1, 1);
<a name="l01168"></a>01168                 <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;co3, 1, 1);
<a name="l01169"></a>01169                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01170"></a>01170                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co4, orcodata[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]);
<a name="l01171"></a>01171                     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>((<a class="code" href="../../da/d29/structMesh.html">Mesh</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, &amp;co4, 1, 1);
<a name="l01172"></a>01172                 }
<a name="l01173"></a>01173             }
<a name="l01174"></a>01174             <span class="keywordflow">else</span> {
<a name="l01175"></a>01175                 v1= (<a class="code" href="../../d8/de5/structMVert.html">MVert</a>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm,mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l01176"></a>01176                 v2= (<a class="code" href="../../d8/de5/structMVert.html">MVert</a>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm,mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l01177"></a>01177                 v3= (<a class="code" href="../../d8/de5/structMVert.html">MVert</a>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm,mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l01178"></a>01178                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co1, v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01179"></a>01179                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co2, v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01180"></a>01180                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co3, v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01182"></a>01182                     v4= (<a class="code" href="../../d8/de5/structMVert.html">MVert</a>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm,mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l01183"></a>01183                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co4, v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01184"></a>01184                 }
<a name="l01185"></a>01185             }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187             cur = mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7051e542338c420d180a6c728a3952a8">area_quad_v3</a>(co1, co2, co3, co4) : <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(co1, co2, co3);
<a name="l01188"></a>01188             
<a name="l01189"></a>01189             <span class="keywordflow">if</span> (cur &gt; maxweight)
<a name="l01190"></a>01190                 maxweight = cur;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192             element_weight[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cur;
<a name="l01193"></a>01193             totarea += cur;
<a name="l01194"></a>01194         }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++)
<a name="l01197"></a>01197             element_weight[i] /= totarea;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199         maxweight /= totarea;
<a name="l01200"></a>01200     }
<a name="l01201"></a>01201     <span class="keywordflow">else</span> {
<a name="l01202"></a>01202         <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>=1.0f/(float)(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totelem,totpart));
<a name="l01203"></a>01203         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++)
<a name="l01204"></a>01204             element_weight[i]=min;
<a name="l01205"></a>01205         maxweight=<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>;
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="comment">/* Calculate weights from vgroup */</span>
<a name="l01209"></a>01209     vweight = <a class="code" href="../../db/dca/BKE__particle_8h.html#a9157eacea741adb34086107bd1ecdd0b">psys_cache_vgroup</a>(dm,psys,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa1ab7fc56cc92ec740d60822347a239a">PSYS_VG_DENSITY</a>);
<a name="l01210"></a>01210 
<a name="l01211"></a>01211     <span class="keywordflow">if</span> (vweight) {
<a name="l01212"></a>01212         <span class="keywordflow">if</span> (from==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01213"></a>01213             <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++)
<a name="l01214"></a>01214                 element_weight[i]*=vweight[i];
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216         <span class="keywordflow">else</span> { <span class="comment">/* PART_FROM_FACE / PART_FROM_VOLUME */</span>
<a name="l01217"></a>01217             <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++) {
<a name="l01218"></a>01218                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm,i,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l01219"></a>01219                 tweight = vweight[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>] + vweight[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>] + vweight[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l01220"></a>01220                 
<a name="l01221"></a>01221                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01222"></a>01222                     tweight += vweight[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l01223"></a>01223                     tweight /= 4.0f;
<a name="l01224"></a>01224                 }
<a name="l01225"></a>01225                 <span class="keywordflow">else</span> {
<a name="l01226"></a>01226                     tweight /= 3.0f;
<a name="l01227"></a>01227                 }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 element_weight[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*=tweight;
<a name="l01230"></a>01230             }
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vweight);
<a name="l01233"></a>01233     }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="comment">/* Calculate total weight of all elements */</span>
<a name="l01236"></a>01236     totweight= 0.0f;
<a name="l01237"></a>01237     <span class="keywordflow">for</span> (i=0;i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++)
<a name="l01238"></a>01238         totweight += element_weight[i];
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     inv_totweight = (totweight &gt; 0.f ? 1.f/totweight : 0.f);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <span class="comment">/* Calculate cumulative weights */</span>
<a name="l01243"></a>01243     element_sum[0]= 0.0f;
<a name="l01244"></a>01244     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>; i++)
<a name="l01245"></a>01245         element_sum[i+1]= element_sum[i] + element_weight[i] * inv_totweight;
<a name="l01246"></a>01246     
<a name="l01247"></a>01247     <span class="comment">/* Finally assign elements to particles */</span>
<a name="l01248"></a>01248     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aac208239c664b8a7512c92b78715e70a">PART_TRAND</a>) || (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a9616146ad4b902b8c9dfc72358aabc81">simplify_flag</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ade84a7c4f7af987dad0d7a8779fd9254">PART_SIMPLIFY_ENABLE</a>)) {
<a name="l01249"></a>01249         <span class="keywordtype">float</span> pos;
<a name="l01250"></a>01250 
<a name="l01251"></a>01251         <span class="keywordflow">for</span> (p=0; p&lt;totpart; p++) {
<a name="l01252"></a>01252             <span class="comment">/* In theory element_sum[totelem] should be 1.0, but due to float errors this is not necessarily always true, so scale pos accordingly. */</span>
<a name="l01253"></a>01253             pos= <a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>() * element_sum[<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>];
<a name="l01254"></a>01254             particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]= <a class="code" href="../../df/d40/particle__system_8c.html#a28a067ad02d6090f3e24030c8da13d3d">distribute_binary_search</a>(element_sum, totelem, pos);
<a name="l01255"></a>01255             particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totelem-1, particle_element[p]);
<a name="l01256"></a>01256             jitter_offset[particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]]= pos;
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     <span class="keywordflow">else</span> {
<a name="l01260"></a>01260         <span class="keywordtype">double</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, pos;
<a name="l01261"></a>01261         
<a name="l01262"></a>01262         step= (totpart &lt; 2) ? 0.5 : 1.0/(<span class="keywordtype">double</span>)totpart;
<a name="l01263"></a>01263         pos= 1e-6; <span class="comment">/* tiny offset to avoid zero weight face */</span>
<a name="l01264"></a>01264         i= 0;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266         <span class="keywordflow">for</span> (p=0; p&lt;totpart; p++, pos+=<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>) {
<a name="l01267"></a>01267             <span class="keywordflow">while</span> ((i &lt; totelem) &amp;&amp; (pos &gt; element_sum[i+1]))
<a name="l01268"></a>01268                 i++;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270             particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totelem-1, i);
<a name="l01271"></a>01271 
<a name="l01272"></a>01272             <span class="comment">/* avoid zero weight face */</span>
<a name="l01273"></a>01273             <span class="keywordflow">if</span> (p == totpart-1 &amp;&amp; element_weight[particle_element[p]] == 0.0f)
<a name="l01274"></a>01274                 particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]= particle_element[p-1];
<a name="l01275"></a>01275 
<a name="l01276"></a>01276             jitter_offset[particle_element[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]]= pos;
<a name="l01277"></a>01277         }
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(element_sum);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     <span class="comment">/* For hair, sort by origindex (allows optimization&#39;s in rendering), */</span>
<a name="l01283"></a>01283     <span class="comment">/* however with virtual parents the children need to be in random order. */</span>
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; !(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7abd73329b3203429f5cc4e4782b7296">PART_CHILD_FACES</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a969d559e04ce0c077311ce8eae033240">parents</a>!=0.0f)) {
<a name="l01285"></a>01285         <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         <span class="keywordflow">if</span> (from == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l01288"></a>01288             <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>)
<a name="l01289"></a>01289                 <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a>= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01290"></a>01290         }
<a name="l01291"></a>01291         <span class="keywordflow">else</span> {
<a name="l01292"></a>01292             <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a>)
<a name="l01293"></a>01293                 <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a>= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01294"></a>01294         }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296         <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a>) {
<a name="l01297"></a>01297             qsort(particle_element, totpart, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <a class="code" href="../../df/d40/particle__system_8c.html#a4ddefa6ed4be1af2e7538b8cc96a17a9">distribute_compare_orig_index</a>);
<a name="l01298"></a>01298             <a class="code" href="../../df/d40/particle__system_8c.html#a6f77b1edfe547a84ec3fbfa9bbf4699a">COMPARE_ORIG_INDEX</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01299"></a>01299         }
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     <span class="comment">/* Create jittering if needed */</span>
<a name="l01303"></a>01303     <span class="keywordflow">if</span> (distr==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a76c24af3e61b9d908298b0febc6511c4">PART_DISTR_JIT</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(from,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>)) {
<a name="l01304"></a>01304         jitlevel= part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a5dd1fe2683cf88f0a85ea9776bd910e3">userjit</a>;
<a name="l01305"></a>01305         
<a name="l01306"></a>01306         <span class="keywordflow">if</span> (jitlevel == 0) {
<a name="l01307"></a>01307             jitlevel= totpart/<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>;
<a name="l01308"></a>01308             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a36511d912291f8d1302ac2e9552f6805">PART_EDISTR</a>) jitlevel*= 2; <span class="comment">/* looks better in general, not very scietific */</span>
<a name="l01309"></a>01309             <span class="keywordflow">if</span> (jitlevel&lt;3) jitlevel= 3;
<a name="l01310"></a>01310         }
<a name="l01311"></a>01311         
<a name="l01312"></a>01312         jit= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((2+ jitlevel*2)*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;jit&quot;</span>);
<a name="l01313"></a>01313 
<a name="l01314"></a>01314         <span class="comment">/* for small amounts of particles we use regular jitter since it looks</span>
<a name="l01315"></a>01315 <span class="comment">         * a bit better, for larger amounts we switch to hammersley sequence </span>
<a name="l01316"></a>01316 <span class="comment">         * because it is much faster */</span>
<a name="l01317"></a>01317         <span class="keywordflow">if</span> (jitlevel &lt; 25)
<a name="l01318"></a>01318             <a class="code" href="../../df/d40/particle__system_8c.html#a0655333dde9d84cf56b5aa3096c11ece">init_mv_jit</a>(jit, jitlevel, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a2207406d1fb41e7d049cf86ca68bc99b">jitfac</a>);
<a name="l01319"></a>01319         <span class="keywordflow">else</span>
<a name="l01320"></a>01320             <a class="code" href="../../df/d40/particle__system_8c.html#ae62551304367cda4f5dab63162e7f5d6">hammersley_create</a>(jit, jitlevel+1, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a2207406d1fb41e7d049cf86ca68bc99b">jitfac</a>);
<a name="l01321"></a>01321         <a class="code" href="../../d3/d88/BLI__rand_8h.html#ac2f28f8410100a0a1a6d72e04c6eb956">BLI_array_randomize</a>(jit, 2*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), jitlevel, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>); <span class="comment">/* for custom jit or even distribution */</span>
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324     <span class="comment">/* Setup things for threaded distribution */</span>
<a name="l01325"></a>01325     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>= tree;
<a name="l01326"></a>01326     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5cbf3866c012ddd26af3edbf56aff7d5">seams</a>= seams;
<a name="l01327"></a>01327     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a06a77f2d2a8110435ad22f89f448cad3">totseam</a>= totseam;
<a name="l01328"></a>01328     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>= psys;
<a name="l01329"></a>01329     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>= particle_element;
<a name="l01330"></a>01330     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>= <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>;
<a name="l01331"></a>01331     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a9f156ba1ecc70aa44c63cdfc768ee878">jitlevel</a>= jitlevel;
<a name="l01332"></a>01332     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>= jitter_offset;
<a name="l01333"></a>01333     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a66d889cfe01311ad292b0444e804d372">weight</a>= element_weight;
<a name="l01334"></a>01334     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#abe15802e6ca698cf5d48340a3de49dc7">maxweight</a>= maxweight;
<a name="l01335"></a>01335     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ad75aded14ce530ec4542fabd33a85cf6">from</a>= (children)? <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>: from;
<a name="l01336"></a>01336     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a8ac7e6543a8d228f4f55d48b31a078a0">cfrom</a>= cfrom;
<a name="l01337"></a>01337     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a75b03abad91c9c3b0bb6f259b5745ae1">distr</a>= distr;
<a name="l01338"></a>01338     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>= dm;
<a name="l01339"></a>01339     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a0fd755401b6e06493ad03439c5c24232">tpars</a>= tpars;
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (children) {
<a name="l01342"></a>01342         totpart= <a class="code" href="../../db/dca/BKE__particle_8h.html#a26e696ca199673cc1f7577fdef72ec48">psys_render_simplify_distribution</a>(ctx, totpart);
<a name="l01343"></a>01343         <a class="code" href="../../df/d40/particle__system_8c.html#aec30ea727db93241762526a7123a932d">alloc_child_particles</a>(psys, totpart);
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346     <span class="keywordflow">if</span> (!children || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a> &lt; 10000)
<a name="l01347"></a>01347         totthread= 1;
<a name="l01348"></a>01348     
<a name="l01349"></a>01349     seed= 31415926 + ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>;
<a name="l01350"></a>01350     <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++) {
<a name="l01351"></a>01351         threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d89/structParticleThread.html#a68963bd0a1ecf38b752d8b470ef20b6f">rng</a>= <a class="code" href="../../d3/d88/BLI__rand_8h.html#adf17633489552c8dd24245b3a9e02ea4">rng_new</a>(seed);
<a name="l01352"></a>01352         threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>= totthread;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <span class="keywordflow">return</span> 1;
<a name="l01356"></a>01356 }
<a name="l01357"></a>01357 
<a name="l01358"></a><a class="code" href="../../df/d40/particle__system_8c.html#a781f2b1c9fb233e38396f8f66562b587">01358</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a781f2b1c9fb233e38396f8f66562b587">distribute_particles_on_dm</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> from)
<a name="l01359"></a>01359 {
<a name="l01360"></a>01360     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *finaldm = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>;
<a name="l01361"></a>01361     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01362"></a>01362     <a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *pthreads;
<a name="l01363"></a>01363     <a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a> *ctx;
<a name="l01364"></a>01364     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totthread;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366     pthreads= <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ed6caa3db80057d50e1d65d59bf2cdc">psys_threads_create</a>(sim);
<a name="l01367"></a>01367 
<a name="l01368"></a>01368     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d40/particle__system_8c.html#af8b8589ca7628c59fe9eda740519ce81">distribute_threads_init_data</a>(pthreads, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, finaldm, from)) {
<a name="l01369"></a>01369         <a class="code" href="../../db/dca/BKE__particle_8h.html#ae26faf807823501d39c2e973c79b40f6">psys_threads_free</a>(pthreads);
<a name="l01370"></a>01370         <span class="keywordflow">return</span>;
<a name="l01371"></a>01371     }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373     totthread= pthreads[0].<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>;
<a name="l01374"></a>01374     <span class="keywordflow">if</span> (totthread &gt; 1) {
<a name="l01375"></a>01375         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../df/d40/particle__system_8c.html#a4d2b3badf33c43b98a86af83c9cec581">distribute_threads_exec_cb</a>, totthread);
<a name="l01376"></a>01376 
<a name="l01377"></a>01377         <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++)
<a name="l01378"></a>01378             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;pthreads[i]);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l01381"></a>01381     }
<a name="l01382"></a>01382     <span class="keywordflow">else</span>
<a name="l01383"></a>01383         <a class="code" href="../../df/d40/particle__system_8c.html#a4d2b3badf33c43b98a86af83c9cec581">distribute_threads_exec_cb</a>(&amp;pthreads[0]);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385     <a class="code" href="../../db/dca/BKE__particle_8h.html#a26715032d0452cc6788be0bded9d9d09">psys_calc_dmcache</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, finaldm, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     ctx= pthreads[0].<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>;
<a name="l01388"></a>01388     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a> != finaldm)
<a name="l01389"></a>01389         ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391     <a class="code" href="../../db/dca/BKE__particle_8h.html#ae26faf807823501d39c2e973c79b40f6">psys_threads_free</a>(pthreads);
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 <span class="comment">/* ready for future use, to emit particles without geometry */</span>
<a name="l01395"></a><a class="code" href="../../df/d40/particle__system_8c.html#aaeafaf703284eba7560fe1ed132a87fc">01395</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aaeafaf703284eba7560fe1ed132a87fc">distribute_particles_on_shape</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(from))
<a name="l01396"></a>01396 {
<a name="l01397"></a>01397     <a class="code" href="../../df/d40/particle__system_8c.html#aec9964bdfefeac143628110b3a67f94c">distribute_invalid</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, 0);
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     fprintf(stderr,<span class="stringliteral">&quot;Shape emission not yet possible!\n&quot;</span>);
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a><a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">01402</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">distribute_particles</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> from)
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404     <a class="code" href="../../db/dca/BKE__particle_8h.html#ad77e9f5ef58b936399236ce0e3c7d10c">PARTICLE_PSMD</a>;
<a name="l01405"></a>01405     <span class="keywordtype">int</span> distr_error=0;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <span class="keywordflow">if</span> (psmd) {
<a name="l01408"></a>01408         <span class="keywordflow">if</span> (psmd-&gt;dm)
<a name="l01409"></a>01409             <a class="code" href="../../df/d40/particle__system_8c.html#a781f2b1c9fb233e38396f8f66562b587">distribute_particles_on_dm</a>(sim, from);
<a name="l01410"></a>01410         <span class="keywordflow">else</span>
<a name="l01411"></a>01411             distr_error=1;
<a name="l01412"></a>01412     }
<a name="l01413"></a>01413     <span class="keywordflow">else</span>
<a name="l01414"></a>01414         <a class="code" href="../../df/d40/particle__system_8c.html#aaeafaf703284eba7560fe1ed132a87fc">distribute_particles_on_shape</a>(sim, from);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     <span class="keywordflow">if</span> (distr_error) {
<a name="l01417"></a>01417         <a class="code" href="../../df/d40/particle__system_8c.html#aec9964bdfefeac143628110b3a67f94c">distribute_invalid</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, from);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         fprintf(stderr,<span class="stringliteral">&quot;Particle distribution error!\n&quot;</span>);
<a name="l01420"></a>01420     }
<a name="l01421"></a>01421 }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423 <span class="comment">/* threaded child particle distribution and path caching */</span>
<a name="l01424"></a><a class="code" href="../../df/d40/particle__system_8c.html#a0362a883870d2216705d43cf14d1e878">01424</a> <a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../db/dca/BKE__particle_8h.html#a4ed6caa3db80057d50e1d65d59bf2cdc">psys_threads_create</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426     <a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01427"></a>01427     <a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a> *ctx;
<a name="l01428"></a>01428     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totthread;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430     <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a821a3940a952444838528ee450075408">R_FIXED_THREADS</a>)
<a name="l01431"></a>01431         totthread= sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>;
<a name="l01432"></a>01432     <span class="keywordflow">else</span>
<a name="l01433"></a>01433         totthread= <a class="code" href="../../df/dbb/BLI__threads_8h.html#a7c7ea80a0fb6cafac205997f51079745">BLI_system_thread_count</a>();
<a name="l01434"></a>01434     
<a name="l01435"></a>01435     threads= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a>)*totthread, <span class="stringliteral">&quot;ParticleThread&quot;</span>);
<a name="l01436"></a>01436     ctx= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a>), <span class="stringliteral">&quot;ParticleThreadContext&quot;</span>);
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a> = *sim;
<a name="l01439"></a>01439     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a3972fe22d4f7e79238a2bbe8c570d2e9">dm</a>= ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>;
<a name="l01440"></a>01440     ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a34a77075de1f25a53bddd2454c6f0881">ma</a>= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8d022766b802cfbac21330d486f89469">omat</a>);
<a name="l01441"></a>01441 
<a name="l01442"></a>01442     memset(threads, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a>)*totthread);
<a name="l01443"></a>01443 
<a name="l01444"></a>01444     <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++) {
<a name="l01445"></a>01445         threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>= ctx;
<a name="l01446"></a>01446         threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d89/structParticleThread.html#a34e2fd2c169bc6b029395beb7b2184be">num</a>= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01447"></a>01447         threads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>= totthread;
<a name="l01448"></a>01448     }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     <span class="keywordflow">return</span> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae26faf807823501d39c2e973c79b40f6">01453</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#ae26faf807823501d39c2e973c79b40f6">psys_threads_free</a>(<a class="code" href="../../da/d89/structParticleThread.html">ParticleThread</a> *<a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>)
<a name="l01454"></a>01454 {
<a name="l01455"></a>01455     <a class="code" href="../../d7/d49/structParticleThreadContext.html">ParticleThreadContext</a> *ctx= threads[0].<a class="code" href="../../da/d89/structParticleThread.html#a341eb71917266dbd23c6e6324b56014f">ctx</a>;
<a name="l01456"></a>01456     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totthread= threads[0].<a class="code" href="../../da/d89/structParticleThread.html#a98a23429b8b7a20ee6f423dccacffea3">tot</a>;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458     <span class="comment">/* path caching */</span>
<a name="l01459"></a>01459     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ad4dcfd7984d304b5c6b794f4e05881e5">vg_length</a>)
<a name="l01460"></a>01460         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ad4dcfd7984d304b5c6b794f4e05881e5">vg_length</a>);
<a name="l01461"></a>01461     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae054aadf07b4100b08165769408f2095">vg_clump</a>)
<a name="l01462"></a>01462         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae054aadf07b4100b08165769408f2095">vg_clump</a>);
<a name="l01463"></a>01463     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ade86b3bdb0f90bcf4fc420556cab1ecd">vg_kink</a>)
<a name="l01464"></a>01464         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ade86b3bdb0f90bcf4fc420556cab1ecd">vg_kink</a>);
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#af77fe2fc89c85bf755b095097632913a">vg_rough1</a>)
<a name="l01466"></a>01466         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#af77fe2fc89c85bf755b095097632913a">vg_rough1</a>);
<a name="l01467"></a>01467     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae9f1999587332e66673ed233a8556c51">vg_rough2</a>)
<a name="l01468"></a>01468         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae9f1999587332e66673ed233a8556c51">vg_rough2</a>);
<a name="l01469"></a>01469     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5877ace6a03a3293e86d524d03dd6000">vg_roughe</a>)
<a name="l01470"></a>01470         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5877ace6a03a3293e86d524d03dd6000">vg_roughe</a>);
<a name="l01471"></a>01471 
<a name="l01472"></a>01472     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>) {
<a name="l01473"></a>01473         <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>);
<a name="l01474"></a>01474         ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5d51238baca8e72d30bee817beb583b2">sim</a>.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01475"></a>01475     }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477     <span class="comment">/* distribution */</span>
<a name="l01478"></a>01478     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a463987cd0162926371e679c9eb3fdf7b">jit</a>);
<a name="l01479"></a>01479     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ae709e3c9407c10788e869db99985f699">jitoff</a>);
<a name="l01480"></a>01480     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a66d889cfe01311ad292b0444e804d372">weight</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a66d889cfe01311ad292b0444e804d372">weight</a>);
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#ac8be5752bbf893873a4a36717c07f0a9">index</a>);
<a name="l01482"></a>01482     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a6a1cd1e1fc8722a32aa3fee8e3d12b7f">skip</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a6a1cd1e1fc8722a32aa3fee8e3d12b7f">skip</a>);
<a name="l01483"></a>01483     <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5cbf3866c012ddd26af3edbf56aff7d5">seams</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#a5cbf3866c012ddd26af3edbf56aff7d5">seams</a>);
<a name="l01484"></a>01484     <span class="comment">//if (ctx-&gt;vertpart) MEM_freeN(ctx-&gt;vertpart);</span>
<a name="l01485"></a>01485     <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aa2320bf47d28237bc6933a090b3eb51b">BLI_kdtree_free</a>(ctx-&gt;<a class="code" href="../../d7/d49/structParticleThreadContext.html#acff12e73badfe1c767f13469ea8527ae">tree</a>);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="comment">/* threads */</span>
<a name="l01488"></a>01488     <span class="keywordflow">for</span> (i=0; i&lt;totthread; i++) {
<a name="l01489"></a>01489         <span class="keywordflow">if</span> (threads[i].rng)
<a name="l01490"></a>01490             <a class="code" href="../../d3/d88/BLI__rand_8h.html#af2fb0bfbfbf970240b7a1dcaa3130196">rng_free</a>(threads[i].rng);
<a name="l01491"></a>01491         <span class="keywordflow">if</span> (threads[i].rng_path)
<a name="l01492"></a>01492             <a class="code" href="../../d3/d88/BLI__rand_8h.html#af2fb0bfbfbf970240b7a1dcaa3130196">rng_free</a>(threads[i].rng_path);
<a name="l01493"></a>01493     }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ctx);
<a name="l01496"></a>01496     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(threads);
<a name="l01497"></a>01497 }
<a name="l01498"></a>01498 
<a name="l01499"></a>01499 <span class="comment">/* set particle parameters that don&#39;t change during particle&#39;s life */</span>
<a name="l01500"></a><a class="code" href="../../df/d40/particle__system_8c.html#a84d3741b94691f30e52471c828a1c871">01500</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#ae08a4d71b659c7ad45f171de4c060074">initialize_particle</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01503"></a>01503     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l01504"></a>01504     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> ptex;
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad2b156b6908626c14f063e15712fe427">PART_FLUID</a>) {
<a name="l01509"></a>01509         <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a062f12754b4471c3cba41200a3407e85">PAMAP_INIT</a>, 0.f);
<a name="l01510"></a>01510         
<a name="l01511"></a>01511         <span class="keywordflow">if</span> (ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#a0629135bb55e30fa1a059382f4708b88">exist</a> &lt; <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p+125))
<a name="l01512"></a>01512             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> = (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) ? 0.f : part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a> + (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aaad187f6e55e19af7964ef74ef2f7b41">end</a> - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a>)*ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#a3ed6a299427fdf9f3bce39a9b8238e30">time</a>;
<a name="l01515"></a>01515     }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> = 0;
<a name="l01518"></a>01518     <span class="comment">/* we can&#39;t reset to -1 anymore since we&#39;ve figured out correct index in distribute_particles */</span>
<a name="l01519"></a>01519     <span class="comment">/* usage other than straight after distribute has to handle this index by itself - jahka*/</span>
<a name="l01520"></a>01520     <span class="comment">//pa-&gt;num_dmcache = DMCACHE_NOTFOUND; /* assume we don&#39;t have a derived mesh face */</span>
<a name="l01521"></a>01521 }
<a name="l01522"></a><a class="code" href="../../df/d40/particle__system_8c.html#add4524669eb21d40d95fc9af2d71aaac">01522</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#add4524669eb21d40d95fc9af2d71aaac">initialize_all_particles</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l01523"></a>01523 {
<a name="l01524"></a>01524     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01525"></a>01525     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a> = 0;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l01530"></a>01530         <span class="keywordflow">if</span> ((pa-&gt;flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>)==0)
<a name="l01531"></a>01531             <a class="code" href="../../db/dca/BKE__particle_8h.html#ae08a4d71b659c7ad45f171de4c060074">initialize_particle</a>(sim, pa, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (pa-&gt;flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>)
<a name="l01534"></a>01534             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>++;
<a name="l01535"></a>01535     }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="comment">/* Free unexisting particles. */</span>
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a> == psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>) {
<a name="l01539"></a>01539         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>)
<a name="l01540"></a>01540             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>);
<a name="l01541"></a>01541 
<a name="l01542"></a>01542         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>);
<a name="l01543"></a>01543         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01544"></a>01544         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a> = 0;
<a name="l01545"></a>01545     }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>) {
<a name="l01548"></a>01548         <span class="keywordtype">int</span> newtotpart = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>;
<a name="l01549"></a>01549         <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *npa, *newpars;
<a name="l01550"></a>01550         
<a name="l01551"></a>01551         npa = newpars = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(newtotpart * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a>), <span class="stringliteral">&quot;particles&quot;</span>);
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         <span class="keywordflow">for</span> (<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=0, pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>&lt;newtotpart; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>++, pa++, npa++) {
<a name="l01554"></a>01554             <span class="keywordflow">while</span> (pa-&gt;flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>)
<a name="l01555"></a>01555                 pa++;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557             memcpy(npa, pa, <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a>));
<a name="l01558"></a>01558         }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>)
<a name="l01561"></a>01561             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>);
<a name="l01562"></a>01562         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>);
<a name="l01563"></a>01563         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> = newpars;
<a name="l01564"></a>01564         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> -= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a>;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>) {
<a name="l01567"></a>01567             <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *newboids = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a>), <span class="stringliteral">&quot;boid particles&quot;</span>);
<a name="l01568"></a>01568 
<a name="l01569"></a>01569             <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l01570"></a>01570                 pa-&gt;boid = newboids++;
<a name="l01571"></a>01571 
<a name="l01572"></a>01572         }
<a name="l01573"></a>01573     }
<a name="l01574"></a>01574 }
<a name="l01575"></a>01575 
<a name="l01576"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad484aef3a7b06cbd0a8c7790115425ea">01576</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ad484aef3a7b06cbd0a8c7790115425ea">get_angular_velocity_vector</a>(<span class="keywordtype">short</span> avemode, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">float</span> *vec)
<a name="l01577"></a>01577 {
<a name="l01578"></a>01578     <span class="keywordflow">switch</span>(avemode) {
<a name="l01579"></a>01579         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aac9f9ad3e203936ab6e2888e9ccbbb15">PART_AVE_VELOCITY</a>:
<a name="l01580"></a>01580             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01581"></a>01581             <span class="keywordflow">break</span>;  
<a name="l01582"></a>01582         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acf672289946f5a36e5ed97d20441182d">PART_AVE_HORIZONTAL</a>:
<a name="l01583"></a>01583         {
<a name="l01584"></a>01584             <span class="keywordtype">float</span> zvec[3];
<a name="l01585"></a>01585             zvec[0] = zvec[1] = 0;
<a name="l01586"></a>01586             zvec[2] = 1.f;
<a name="l01587"></a>01587             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vec, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, zvec);
<a name="l01588"></a>01588             <span class="keywordflow">break</span>;
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad4c4dec792dfb046fea2c3a4a2685920">PART_AVE_VERTICAL</a>:
<a name="l01591"></a>01591         {
<a name="l01592"></a>01592             <span class="keywordtype">float</span> zvec[3], temp[3];
<a name="l01593"></a>01593             zvec[0] = zvec[1] = 0;
<a name="l01594"></a>01594             zvec[2] = 1.f;
<a name="l01595"></a>01595             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(temp, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, zvec);
<a name="l01596"></a>01596             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vec, temp, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01597"></a>01597             <span class="keywordflow">break</span>;
<a name="l01598"></a>01598         }
<a name="l01599"></a>01599         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a59121bb8f9b803daa2596db85d860212">PART_AVE_GLOBAL_X</a>:
<a name="l01600"></a>01600             vec[0] = 1.f;
<a name="l01601"></a>01601             vec[1] = vec[2] = 0;
<a name="l01602"></a>01602             <span class="keywordflow">break</span>;
<a name="l01603"></a>01603         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aafcdbbe8d78b340c668ef694dfc0dbf9">PART_AVE_GLOBAL_Y</a>:
<a name="l01604"></a>01604             vec[1] = 1.f;
<a name="l01605"></a>01605             vec[0] = vec[2] = 0;
<a name="l01606"></a>01606             <span class="keywordflow">break</span>;
<a name="l01607"></a>01607         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#adedaee6cbe10abe4dcd07d04e6374c13">PART_AVE_GLOBAL_Z</a>:
<a name="l01608"></a>01608             vec[2] = 1.f;
<a name="l01609"></a>01609             vec[0] = vec[1] = 0;
<a name="l01610"></a>01610             <span class="keywordflow">break</span>;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01614"></a><a class="code" href="../../df/d40/particle__system_8c.html#a0eb3a7f17e0029ca839edfdb44becc3c">01614</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#ab4ee739d6be654f66e3fe5b3019a3cb5">psys_get_birth_coordinates</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">float</span> dtime, <span class="keywordtype">float</span> cfra)
<a name="l01615"></a>01615 {
<a name="l01616"></a>01616     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l01617"></a>01617     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01618"></a>01618     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part;
<a name="l01619"></a>01619     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> ptex;
<a name="l01620"></a>01620     <span class="keywordtype">float</span> fac, phasefac, nor[3]={0,0,0},loc[3],vel[3]={0.0,0.0,0.0},<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[4],q2[4];
<a name="l01621"></a>01621     <span class="keywordtype">float</span> r_vel[3],r_ave[3],r_rot[4],vec[3],p_vel[3]={0.0,0.0,0.0};
<a name="l01622"></a>01622     <span class="keywordtype">float</span> x_vec[3]={1.0,0.0,0.0}, utan[3]={0.0,1.0,0.0}, vtan[3]={0.0,0.0,1.0}, rot_vec[3]={0.0,0.0,0.0};
<a name="l01623"></a>01623     <span class="keywordtype">float</span> q_phase[4];
<a name="l01624"></a>01624     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = pa - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l01625"></a>01625     part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="comment">/* get birth location from object       */</span>
<a name="l01628"></a>01628     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7b28dbe654d16c1a7dce4fee926b2e9">tanfac</a> != 0.f)
<a name="l01629"></a>01629         <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#abd27ee5e6b3a527ab7110c3b95c45a7e">num_dmcache</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>,loc,nor,utan,vtan,0,0);
<a name="l01630"></a>01630     <span class="keywordflow">else</span>
<a name="l01631"></a>01631         <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#abd27ee5e6b3a527ab7110c3b95c45a7e">num_dmcache</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>,loc,nor,0,0,0,0);
<a name="l01632"></a>01632         
<a name="l01633"></a>01633     <span class="comment">/* get possible textural influence */</span>
<a name="l01634"></a>01634     <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a72090225225fa27308559a8ad7d974c0">PAMAP_IVEL</a>, cfra);
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     <span class="comment">/* particles live in global space so    */</span>
<a name="l01637"></a>01637     <span class="comment">/* let&#39;s convert:                       */</span>
<a name="l01638"></a>01638     <span class="comment">/* -location                            */</span>
<a name="l01639"></a>01639     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, loc);
<a name="l01640"></a>01640         
<a name="l01641"></a>01641     <span class="comment">/* -normal                              */</span>
<a name="l01642"></a>01642     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, nor);
<a name="l01643"></a>01643     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="comment">/* -tangent                             */</span>
<a name="l01646"></a>01646     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7b28dbe654d16c1a7dce4fee926b2e9">tanfac</a>!=0.0f) {
<a name="l01647"></a>01647         <span class="comment">//float phase=vg_rot?2.0f*(psys_particle_value_from_verts(sim-&gt;psmd-&gt;dm,part-&gt;from,pa,vg_rot)-0.5f):0.0f;</span>
<a name="l01648"></a>01648         <span class="keywordtype">float</span> phase=0.0f;
<a name="l01649"></a>01649         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vtan,-<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a15b0ee8fdbdde87d11784fbb976b5cac">tanphase</a>+phase)));
<a name="l01650"></a>01650         fac= -<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a15b0ee8fdbdde87d11784fbb976b5cac">tanphase</a>+phase));
<a name="l01651"></a>01651         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vtan, utan, fac);
<a name="l01652"></a>01652 
<a name="l01653"></a>01653         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>,vtan);
<a name="l01654"></a>01654 
<a name="l01655"></a>01655         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(utan, nor);
<a name="l01656"></a>01656         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(utan,<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vtan,nor));
<a name="l01657"></a>01657         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vtan, utan);
<a name="l01658"></a>01658             
<a name="l01659"></a>01659         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vtan);
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661         
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="comment">/* -velocity (boids need this even if there&#39;s no random velocity) */</span>
<a name="l01664"></a>01664     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a782119199a6589d6d41d32ecbe93868a">randfac</a> != 0.0f || (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>)) {
<a name="l01665"></a>01665         r_vel[0] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 10) - 0.5f);
<a name="l01666"></a>01666         r_vel[1] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 11) - 0.5f);
<a name="l01667"></a>01667         r_vel[2] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 12) - 0.5f);
<a name="l01668"></a>01668 
<a name="l01669"></a>01669         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, r_vel);
<a name="l01670"></a>01670         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_vel);
<a name="l01671"></a>01671     }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673     <span class="comment">/* -angular velocity                    */</span>
<a name="l01674"></a>01674     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#afff2b6bb2e99908069674099186d1cbe">PART_AVE_RAND</a>) {
<a name="l01675"></a>01675         r_ave[0] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 13) - 0.5f);
<a name="l01676"></a>01676         r_ave[1] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 14) - 0.5f);
<a name="l01677"></a>01677         r_ave[2] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 15) - 0.5f);
<a name="l01678"></a>01678 
<a name="l01679"></a>01679         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>,r_ave);
<a name="l01680"></a>01680         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_ave);
<a name="l01681"></a>01681     }
<a name="l01682"></a>01682         
<a name="l01683"></a>01683     <span class="comment">/* -rotation                            */</span>
<a name="l01684"></a>01684     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#af15175028a50d97e25daabd1b0a45815">randrotfac</a> != 0.0f) {
<a name="l01685"></a>01685         r_rot[0] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 16) - 0.5f);
<a name="l01686"></a>01686         r_rot[1] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 17) - 0.5f);
<a name="l01687"></a>01687         r_rot[2] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 18) - 0.5f);
<a name="l01688"></a>01688         r_rot[3] = 2.0f * (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 19) - 0.5f);
<a name="l01689"></a>01689         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(r_rot);
<a name="l01690"></a>01690 
<a name="l01691"></a>01691         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad76b90158227d13beb93cf29952f78a9">mat4_to_quat</a>(<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01692"></a>01692         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(r_rot,r_rot,<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>);
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>) {
<a name="l01696"></a>01696         <span class="keywordtype">float</span> dvec[3], q[4], mat[3][3];
<a name="l01697"></a>01697 
<a name="l01698"></a>01698         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>,loc);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700         <span class="comment">/* boids don&#39;t get any initial velocity  */</span>
<a name="l01701"></a>01701         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01702"></a>01702 
<a name="l01703"></a>01703         <span class="comment">/* boids store direction in ave */</span>
<a name="l01704"></a>01704         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(nor[2])==1.0f) {
<a name="l01705"></a>01705             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, loc, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l01706"></a>01706             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l01707"></a>01707         }
<a name="l01708"></a>01708         <span class="keywordflow">else</span> {
<a name="l01709"></a>01709             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, nor);
<a name="l01710"></a>01710         }
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         <span class="comment">/* calculate rotation matrix */</span>
<a name="l01713"></a>01713         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(dvec, r_vel, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l01714"></a>01714         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(mat[0], state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, dvec);
<a name="l01715"></a>01715         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(mat[0]);
<a name="l01716"></a>01716         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(mat[2], r_vel);
<a name="l01717"></a>01717         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(mat[2]);
<a name="l01718"></a>01718         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(mat[1], mat[2], mat[0]);
<a name="l01719"></a>01719         
<a name="l01720"></a>01720         <span class="comment">/* apply rotation */</span>
<a name="l01721"></a>01721         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a386b66d3598a9637999aa7bb91a1619c">mat3_to_quat_is_ok</a>( q,mat);
<a name="l01722"></a>01722         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, q);
<a name="l01723"></a>01723     }
<a name="l01724"></a>01724     <span class="keywordflow">else</span> {
<a name="l01725"></a>01725         <span class="comment">/* conversion done so now we apply new: */</span>
<a name="l01726"></a>01726         <span class="comment">/* -velocity from:                      */</span>
<a name="l01727"></a>01727 
<a name="l01728"></a>01728         <span class="comment">/*      *reactions                      */</span>
<a name="l01729"></a>01729         <span class="keywordflow">if</span> (dtime &gt; 0.f) {
<a name="l01730"></a>01730             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vel, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733         <span class="comment">/*      *emitter velocity               */</span>
<a name="l01734"></a>01734         <span class="keywordflow">if</span> (dtime != 0.f &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae46430cdacfa2c8c6802c562e0d94150">obfac</a> != 0.f) {
<a name="l01735"></a>01735             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vel, loc, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l01736"></a>01736             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vel, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae46430cdacfa2c8c6802c562e0d94150">obfac</a>/dtime);
<a name="l01737"></a>01737         }
<a name="l01738"></a>01738         
<a name="l01739"></a>01739         <span class="comment">/*      *emitter normal                 */</span>
<a name="l01740"></a>01740         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a564477f1059ae042b0a3d9eebf68163c">normfac</a> != 0.f)
<a name="l01741"></a>01741             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, nor, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a564477f1059ae042b0a3d9eebf68163c">normfac</a>);
<a name="l01742"></a>01742         
<a name="l01743"></a>01743         <span class="comment">/*      *emitter tangent                */</span>
<a name="l01744"></a>01744         <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7b28dbe654d16c1a7dce4fee926b2e9">tanfac</a> != 0.f)
<a name="l01745"></a>01745             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, vtan, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7b28dbe654d16c1a7dce4fee926b2e9">tanfac</a>);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747         <span class="comment">/*      *emitter object orientation     */</span>
<a name="l01748"></a>01748         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[0] != 0.f) {
<a name="l01749"></a>01749             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(vec, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[0]);
<a name="l01750"></a>01750             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, vec, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[0]);
<a name="l01751"></a>01751         }
<a name="l01752"></a>01752         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[1] != 0.f) {
<a name="l01753"></a>01753             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(vec, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[1]);
<a name="l01754"></a>01754             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, vec, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[1]);
<a name="l01755"></a>01755         }
<a name="l01756"></a>01756         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[2] != 0.f) {
<a name="l01757"></a>01757             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(vec, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[2]);
<a name="l01758"></a>01758             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, vec, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac4479a803f98df6858d3bb217a947b39">ob_vel</a>[2]);
<a name="l01759"></a>01759         }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761         <span class="comment">/*      *texture                        */</span>
<a name="l01762"></a>01762         <span class="comment">/* TODO */</span>
<a name="l01763"></a>01763 
<a name="l01764"></a>01764         <span class="comment">/*      *random                         */</span>
<a name="l01765"></a>01765         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a782119199a6589d6d41d32ecbe93868a">randfac</a> != 0.f)
<a name="l01766"></a>01766             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, r_vel, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a782119199a6589d6d41d32ecbe93868a">randfac</a>);
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="comment">/*      *particle                       */</span>
<a name="l01769"></a>01769         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a70ed6311b7a81ba16bfa2529b7377c9d">partfac</a> != 0.f)
<a name="l01770"></a>01770             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vel, p_vel, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a70ed6311b7a81ba16bfa2529b7377c9d">partfac</a>);
<a name="l01771"></a>01771         
<a name="l01772"></a>01772         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, vel, ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#a4642a643c8c1ddf372e626acfbbaa8d6">ivel</a>);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774         <span class="comment">/* -location from emitter               */</span>
<a name="l01775"></a>01775         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>,loc);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777         <span class="comment">/* -rotation                            */</span>
<a name="l01778"></a>01778         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a66672ccf9e1308f3ba8c6b6f55fd2a8c">unit_qt</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad27b4fdd7271a1de7e2fe38051c3ca44">rotmode</a>) {
<a name="l01781"></a>01781             <span class="comment">/* create vector into which rotation is aligned */</span>
<a name="l01782"></a>01782             <span class="keywordflow">switch</span>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad27b4fdd7271a1de7e2fe38051c3ca44">rotmode</a>) {
<a name="l01783"></a>01783                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa595412976aa3732f7373d944a7dc2a9">PART_ROT_NOR</a>:
<a name="l01784"></a>01784                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rot_vec, nor);
<a name="l01785"></a>01785                     <span class="keywordflow">break</span>;
<a name="l01786"></a>01786                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acf117996b37af9e17bc18dca3e09b6ea">PART_ROT_VEL</a>:
<a name="l01787"></a>01787                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rot_vec, vel);
<a name="l01788"></a>01788                     <span class="keywordflow">break</span>;
<a name="l01789"></a>01789                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3c1c143e7bbdf9b78ad1f28b57cdfbcf">PART_ROT_GLOB_X</a>:
<a name="l01790"></a>01790                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a79be006950425d1c672fb6df53f0d577">PART_ROT_GLOB_Y</a>:
<a name="l01791"></a>01791                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a46c812e2a4d1f225f42105926e7d631b">PART_ROT_GLOB_Z</a>:
<a name="l01792"></a>01792                     rot_vec[part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad27b4fdd7271a1de7e2fe38051c3ca44">rotmode</a> - <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3c1c143e7bbdf9b78ad1f28b57cdfbcf">PART_ROT_GLOB_X</a>] = 1.0f;
<a name="l01793"></a>01793                     <span class="keywordflow">break</span>;
<a name="l01794"></a>01794                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7cdbec9321205fe315351579bdb10f81">PART_ROT_OB_X</a>:
<a name="l01795"></a>01795                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a9f464a49f576d74cadf902285c1ae77a">PART_ROT_OB_Y</a>:
<a name="l01796"></a>01796                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a83e3e01a03918c633d623e395c4ff515">PART_ROT_OB_Z</a>:
<a name="l01797"></a>01797                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rot_vec, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad27b4fdd7271a1de7e2fe38051c3ca44">rotmode</a> - <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7cdbec9321205fe315351579bdb10f81">PART_ROT_OB_X</a>]);
<a name="l01798"></a>01798                     <span class="keywordflow">break</span>;
<a name="l01799"></a>01799             }
<a name="l01800"></a>01800             
<a name="l01801"></a>01801             <span class="comment">/* create rotation quat */</span>
<a name="l01802"></a>01802             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(rot_vec);
<a name="l01803"></a>01803             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#afb9156556a1562b1debeb6d586859524">vec_to_quat</a>( q2,rot_vec, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a3a0ed013002b178c9387599704a33991">OB_POSX</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a71f4ff65774e1fb89e9326d6506e1580">OB_POSZ</a>);
<a name="l01804"></a>01804 
<a name="l01805"></a>01805             <span class="comment">/* randomize rotation quat */</span>
<a name="l01806"></a>01806             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#af15175028a50d97e25daabd1b0a45815">randrotfac</a>!=0.0f)
<a name="l01807"></a>01807                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aabc8b501c8bcfe8a37ecfc39661b07d9">interp_qt_qtqt</a>(<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>, q2, r_rot, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#af15175028a50d97e25daabd1b0a45815">randrotfac</a>);
<a name="l01808"></a>01808             <span class="keywordflow">else</span>
<a name="l01809"></a>01809                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>,q2);
<a name="l01810"></a>01810 
<a name="l01811"></a>01811             <span class="comment">/* rotation phase */</span>
<a name="l01812"></a>01812             phasefac = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a44a4ae92c686d7890fb3a8d37d14e9af">phasefac</a>;
<a name="l01813"></a>01813             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a9f48486d125fa4aab4df4c511d5bb3aa">randphasefac</a> != 0.0f)
<a name="l01814"></a>01814                 phasefac += part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a9f48486d125fa4aab4df4c511d5bb3aa">randphasefac</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 20);
<a name="l01815"></a>01815             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a31e0d088e5faae71dd3e9e4232f7c2a5">axis_angle_to_quat</a>( q_phase,x_vec, phasefac*(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l01816"></a>01816 
<a name="l01817"></a>01817             <span class="comment">/* combine base rotation &amp; phase */</span>
<a name="l01818"></a>01818             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>, q_phase);
<a name="l01819"></a>01819         }
<a name="l01820"></a>01820 
<a name="l01821"></a>01821         <span class="comment">/* -angular velocity                    */</span>
<a name="l01822"></a>01822 
<a name="l01823"></a>01823         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l01824"></a>01824 
<a name="l01825"></a>01825         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a>) {
<a name="l01826"></a>01826             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#afff2b6bb2e99908069674099186d1cbe">PART_AVE_RAND</a>)
<a name="l01827"></a>01827                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, r_ave);
<a name="l01828"></a>01828             <span class="keywordflow">else</span>
<a name="l01829"></a>01829                 <a class="code" href="../../df/d40/particle__system_8c.html#ad484aef3a7b06cbd0a8c7790115425ea">get_angular_velocity_vector</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a>, state, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l01830"></a>01830 
<a name="l01831"></a>01831             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l01832"></a>01832             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad26b38930a1c5771dcb93f5b33b67b68">avefac</a>);
<a name="l01833"></a>01833         }
<a name="l01834"></a>01834     }
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 <span class="comment">/* sets particle to the emitter surface with initial velocity &amp; rotation */</span>
<a name="l01837"></a><a class="code" href="../../df/d40/particle__system_8c.html#af8fd4fcc5eb3285f10fa52eac69086d9">01837</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <span class="keywordtype">float</span> dtime, <span class="keywordtype">float</span> cfra)
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l01840"></a>01840     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01841"></a>01841     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part;
<a name="l01842"></a>01842     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> ptex;
<a name="l01843"></a>01843     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = pa - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l01844"></a>01844     part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l01845"></a>01845     
<a name="l01846"></a>01846     <span class="comment">/* get precise emitter matrix if particle is born */</span>
<a name="l01847"></a>01847     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>!=<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; dtime &gt; 0.f &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &lt; cfra &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &gt;= sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>) {
<a name="l01848"></a>01848         <span class="comment">/* we have to force RECALC_ANIM here since where_is_objec_time only does drivers */</span>
<a name="l01849"></a>01849         <span class="keywordflow">while</span> (ob) {
<a name="l01850"></a>01850             <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8a1bce4262e3f1016c7b92e1ac709e4bec">ADT_RECALC_ANIM</a>);
<a name="l01851"></a>01851             ob = ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>;
<a name="l01852"></a>01852         }
<a name="l01853"></a>01853         ob = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l01854"></a>01854         <a class="code" href="../../df/dac/BKE__object_8h.html#a041216c9db7724b51417887b9e31f5d3">where_is_object_time</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, ob, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1da5a9997318b0cdcc2b56e1c131632c">PSYS_OB_ANIM_RESTORE</a>;
<a name="l01857"></a>01857     }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859     <a class="code" href="../../db/dca/BKE__particle_8h.html#ab4ee739d6be654f66e3fe5b3019a3cb5">psys_get_birth_coordinates</a>(sim, pa, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, dtime, cfra);
<a name="l01860"></a>01860 
<a name="l01861"></a>01861     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>) {
<a name="l01862"></a>01862         <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *bpa = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864         <span class="comment">/* and gravity in r_ve */</span>
<a name="l01865"></a>01865         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#aeeea22650c1c05b64bc5e5059eb3a21e">gravity</a>[0] = bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#aeeea22650c1c05b64bc5e5059eb3a21e">gravity</a>[1] = 0.0f;
<a name="l01866"></a>01866         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#aeeea22650c1c05b64bc5e5059eb3a21e">gravity</a>[2] = -1.0f;
<a name="l01867"></a>01867         <span class="keywordflow">if</span> ((sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#ae4c1524b30f9e72a87543f428be1549c">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a508bb80abc11d94db2661ef7f6d0cc00">PHYS_GLOBAL_GRAVITY</a>) &amp;&amp;
<a name="l01868"></a>01868             (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>[2] != 0.0f))
<a name="l01869"></a>01869         {
<a name="l01870"></a>01870             bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#aeeea22650c1c05b64bc5e5059eb3a21e">gravity</a>[2] = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>[2];
<a name="l01871"></a>01871         }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#ac045a5e0dfdfeb549a63787aefa936a4">health</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>-&gt;<a class="code" href="../../dd/d94/structBoidSettings.html#af3d9c956fba77b1a044e64fd0a7a7b43">health</a>;
<a name="l01874"></a>01874         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#aa6e9ec5ae35d37d8eaeb2030269a5a13">mode</a> = <a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a67b995c918295f7eebf7d4f722d0d33caecdede0fc57a42852850e386ec3b1332">eBoidMode_InAir</a>;
<a name="l01875"></a>01875         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#a3c303ccbbed483fbce3087c8c8bc0762">state_id</a> = ((<a class="code" href="../../db/dfa/structBoidState.html">BoidState</a>*)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>-&gt;<a class="code" href="../../dd/d94/structBoidSettings.html#a632b0e4786d070f07183c7659cac4444">states</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;id;
<a name="l01876"></a>01876         bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#addcc89fe10cc192afc457a671d8e6b14">acc</a>[0]=bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#addcc89fe10cc192afc457a671d8e6b14">acc</a>[1]=bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#addcc89fe10cc192afc457a671d8e6b14">acc</a>[2]=0.0f;
<a name="l01877"></a>01877     }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 
<a name="l01880"></a>01880     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) {
<a name="l01881"></a>01881         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a> = 100.0f;
<a name="l01882"></a>01882     }
<a name="l01883"></a>01883     <span class="keywordflow">else</span> {
<a name="l01884"></a>01884         <span class="comment">/* get possible textural influence */</span>
<a name="l01885"></a>01885         <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a528997cd7d0e4382186e6492f96fe640">PAMAP_LIFE</a>, cfra);
<a name="l01886"></a>01886 
<a name="l01887"></a>01887         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad24d73f074832de37255a2f3cb1c16d0">lifetime</a> * ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#ae271d21e01e610b88ffde174e2e0a9f7">life</a>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97d9032ef1f58ee39e773e2828ed0490">randlife</a> != 0.0f)
<a name="l01890"></a>01890             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97d9032ef1f58ee39e773e2828ed0490">randlife</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 21);
<a name="l01891"></a>01891     }
<a name="l01892"></a>01892 
<a name="l01893"></a>01893     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> + pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a>;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895     <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a> &amp;&amp; sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a> &amp;&amp;
<a name="l01896"></a>01896         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01897"></a>01897         <span class="keywordtype">float</span> dietime = <a class="code" href="../../db/dca/BKE__particle_8h.html#a793ff5279bc1527da313af75f37e4a62">psys_get_dietime_from_cache</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>, p);
<a name="l01898"></a>01898         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>, dietime);
<a name="l01899"></a>01899     }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &gt; cfra)
<a name="l01902"></a>01902         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae26eb239d67b64da7b2afef89052c50d">PARS_UNBORN</a>;
<a name="l01903"></a>01903     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> &lt;= cfra)
<a name="l01904"></a>01904         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a9f632cd1991990d1c11a712993d733dd">PARS_DEAD</a>;
<a name="l01905"></a>01905     <span class="keywordflow">else</span>
<a name="l01906"></a>01906         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>;
<a name="l01907"></a>01907 
<a name="l01908"></a>01908     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = cfra;
<a name="l01909"></a>01909 }
<a name="l01910"></a><a class="code" href="../../df/d40/particle__system_8c.html#aaccab291bfa9cca97a0921409bac1c37">01910</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aaccab291bfa9cca97a0921409bac1c37">reset_all_particles</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> dtime, <span class="keywordtype">float</span> cfra, <span class="keywordtype">int</span> from)
<a name="l01911"></a>01911 {
<a name="l01912"></a>01912     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa;
<a name="l01913"></a>01913     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, totpart=sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l01914"></a>01914     
<a name="l01915"></a>01915     <span class="keywordflow">for</span> (p=from, pa=sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>+from; p&lt;totpart; p++, pa++)
<a name="l01916"></a>01916         <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, dtime, cfra);
<a name="l01917"></a>01917 }
<a name="l01918"></a>01918 <span class="comment">/************************************************/</span>
<a name="l01919"></a>01919 <span class="comment">/*          Particle targets                    */</span>
<a name="l01920"></a>01920 <span class="comment">/************************************************/</span>
<a name="l01921"></a><a class="code" href="../../df/d40/particle__system_8c.html#af9828514683acee5d845b22457d63462">01921</a> <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *<a class="code" href="../../db/dca/BKE__particle_8h.html#a3c8c6e6b538826e4392822afe850c00f">psys_get_target_system</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt)
<a name="l01922"></a>01922 {
<a name="l01923"></a>01923     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925     <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a> == ob)
<a name="l01926"></a>01926         psys = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>, pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a9ca544004c18942653f7d48882ca03f4">psys</a>-1);
<a name="l01927"></a>01927     <span class="keywordflow">else</span>
<a name="l01928"></a>01928         psys = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>, pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a9ca544004c18942653f7d48882ca03f4">psys</a>-1);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     <span class="keywordflow">if</span> (psys)
<a name="l01931"></a>01931         pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a4151fd293475ace4bd1bc4182640938b">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8fe764e602e4c1149516dd10f21308a4">PTARGET_VALID</a>;
<a name="l01932"></a>01932     <span class="keywordflow">else</span>
<a name="l01933"></a>01933         pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a4151fd293475ace4bd1bc4182640938b">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8fe764e602e4c1149516dd10f21308a4">PTARGET_VALID</a>;
<a name="l01934"></a>01934 
<a name="l01935"></a>01935     <span class="keywordflow">return</span> psys;
<a name="l01936"></a>01936 }
<a name="l01937"></a>01937 <span class="comment">/************************************************/</span>
<a name="l01938"></a>01938 <span class="comment">/*          Keyed particles                     */</span>
<a name="l01939"></a>01939 <span class="comment">/************************************************/</span>
<a name="l01940"></a>01940 <span class="comment">/* Counts valid keyed targets */</span>
<a name="l01941"></a><a class="code" href="../../df/d40/particle__system_8c.html#a5d201ca1fe2ef5c27b8ca5c7f6bd838b">01941</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a367eaf7149486c4f3ef97ffc0d61b48e">psys_count_keyed_targets</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l01942"></a>01942 {
<a name="l01943"></a>01943     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, *kpsys;
<a name="l01944"></a>01944     <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01945"></a>01945     <span class="keywordtype">int</span> keys_valid = 1;
<a name="l01946"></a>01946     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a> = 0;
<a name="l01947"></a>01947 
<a name="l01948"></a>01948     <span class="keywordflow">for</span> (; pt; pt=pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a>) {
<a name="l01949"></a>01949         kpsys = <a class="code" href="../../db/dca/BKE__particle_8h.html#a3c8c6e6b538826e4392822afe850c00f">psys_get_target_system</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, pt);
<a name="l01950"></a>01950 
<a name="l01951"></a>01951         <span class="keywordflow">if</span> (kpsys &amp;&amp; kpsys-&gt;totpart) {
<a name="l01952"></a>01952             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a> += keys_valid;
<a name="l01953"></a>01953             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af17f09839f78b445bff834dbeb4e8a1b">PSYS_KEYED_TIMING</a> &amp;&amp; pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#ad208939f99b74450bb906125ecd3a571">duration</a> != 0.0f)
<a name="l01954"></a>01954                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a> += 1;
<a name="l01955"></a>01955         }
<a name="l01956"></a>01956         <span class="keywordflow">else</span> {
<a name="l01957"></a>01957             keys_valid = 0;
<a name="l01958"></a>01958         }
<a name="l01959"></a>01959     }
<a name="l01960"></a>01960 
<a name="l01961"></a>01961     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a> *= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af17f09839f78b445bff834dbeb4e8a1b">PSYS_KEYED_TIMING</a> ? 1 : psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#af141cb5b81744839bd929fa75780654c">keyed_loops</a>;
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 
<a name="l01964"></a><a class="code" href="../../df/d40/particle__system_8c.html#a9f494756830a547aee46374cf4fb9153">01964</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a9f494756830a547aee46374cf4fb9153">set_keyed_keys</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l01965"></a>01965 {
<a name="l01966"></a>01966     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l01967"></a>01967     <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> ksim= {0};
<a name="l01968"></a>01968     <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt;
<a name="l01969"></a>01969     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l01970"></a>01970     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *key;
<a name="l01971"></a>01971     <span class="keywordtype">int</span> totpart = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>, k, totkeys = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a>;
<a name="l01972"></a>01972     <span class="keywordtype">int</span> keyed_flag = 0;
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>= sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>;
<a name="l01975"></a>01975     
<a name="l01976"></a>01976     <span class="comment">/* no proper targets so let&#39;s clear and bail out */</span>
<a name="l01977"></a>01977     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acef49744834313117c45690264d06cbc">totkeyed</a>==0) {
<a name="l01978"></a>01978         <a class="code" href="../../db/dca/BKE__particle_8h.html#a8325d53f262b836a28783e7fa06c6adf">free_keyed_keys</a>(psys);
<a name="l01979"></a>01979         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l01980"></a>01980         <span class="keywordflow">return</span>;
<a name="l01981"></a>01981     }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <span class="keywordflow">if</span> (totpart &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a> != totkeys) {
<a name="l01984"></a>01984         <a class="code" href="../../db/dca/BKE__particle_8h.html#a8325d53f262b836a28783e7fa06c6adf">free_keyed_keys</a>(psys);
<a name="l01985"></a>01985         
<a name="l01986"></a>01986         key = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totpart*totkeys*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a>), <span class="stringliteral">&quot;Keyed keys&quot;</span>);
<a name="l01987"></a>01987         
<a name="l01988"></a>01988         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l01989"></a>01989             pa-&gt;keys = key;
<a name="l01990"></a>01990             pa-&gt;totkey = totkeys;
<a name="l01991"></a>01991             key += totkeys;
<a name="l01992"></a>01992         }
<a name="l01993"></a>01993     }
<a name="l01994"></a>01994     
<a name="l01995"></a>01995     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l01996"></a>01996 
<a name="l01997"></a>01997 
<a name="l01998"></a>01998     pt = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01999"></a>01999     <span class="keywordflow">for</span> (k=0; k&lt;totkeys; k++) {
<a name="l02000"></a>02000         ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a> = pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a> ? pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a> : sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l02001"></a>02001         ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>, pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a9ca544004c18942653f7d48882ca03f4">psys</a> - 1);
<a name="l02002"></a>02002         keyed_flag = (ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>);
<a name="l02003"></a>02003         ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l02004"></a>02004 
<a name="l02005"></a>02005         <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l02006"></a>02006             key = pa-&gt;keys + k;
<a name="l02007"></a>02007             key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = -1.0; <span class="comment">/* use current time */</span>
<a name="l02008"></a>02008 
<a name="l02009"></a>02009             <a class="code" href="../../db/dca/BKE__particle_8h.html#a954cd827b2145d733493e4fd5f33ab9f">psys_get_particle_state</a>(&amp;ksim, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>%ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>, key, 1);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af17f09839f78b445bff834dbeb4e8a1b">PSYS_KEYED_TIMING</a>) {
<a name="l02012"></a>02012                 key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = pa-&gt;time + pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a5d450d65380a6db079de89431c8a437a">time</a>;
<a name="l02013"></a>02013                 <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#ad208939f99b74450bb906125ecd3a571">duration</a> != 0.0f &amp;&amp; k+1 &lt; totkeys) {
<a name="l02014"></a>02014                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a5b76b44a0cc1f11cb6b8a552d0e89724">copy_particle_key</a>(key+1, key, 1);
<a name="l02015"></a>02015                     (key+1)-&gt;time = pa-&gt;time + pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a5d450d65380a6db079de89431c8a437a">time</a> + pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#ad208939f99b74450bb906125ecd3a571">duration</a>;
<a name="l02016"></a>02016                 }
<a name="l02017"></a>02017             }
<a name="l02018"></a>02018             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (totkeys &gt; 1)
<a name="l02019"></a>02019                 key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = pa-&gt;time + (float)k / (<span class="keywordtype">float</span>)(totkeys - 1) * pa-&gt;lifetime;
<a name="l02020"></a>02020             <span class="keywordflow">else</span>
<a name="l02021"></a>02021                 key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = pa-&gt;time;
<a name="l02022"></a>02022         }
<a name="l02023"></a>02023 
<a name="l02024"></a>02024         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af17f09839f78b445bff834dbeb4e8a1b">PSYS_KEYED_TIMING</a> &amp;&amp; pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#ad208939f99b74450bb906125ecd3a571">duration</a>!=0.0f)
<a name="l02025"></a>02025             k++;
<a name="l02026"></a>02026 
<a name="l02027"></a>02027         ksim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= keyed_flag;
<a name="l02028"></a>02028 
<a name="l02029"></a>02029         pt = (pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a> &amp;&amp; pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a>-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a4151fd293475ace4bd1bc4182640938b">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8fe764e602e4c1149516dd10f21308a4">PTARGET_VALID</a>)? pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a> : psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031 
<a name="l02032"></a>02032     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="comment">/************************************************/</span>
<a name="l02036"></a>02036 <span class="comment">/*          Point Cache                         */</span>
<a name="l02037"></a>02037 <span class="comment">/************************************************/</span>
<a name="l02038"></a><a class="code" href="../../df/d40/particle__system_8c.html#ac55242ebf90d39d68b47ab4c48dbb141">02038</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#aac4e8f186d54a552936b89431ce86c04">psys_make_temp_pointcache</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l02039"></a>02039 {
<a name="l02040"></a>02040     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a> &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02043"></a>02043         <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> pid;
<a name="l02044"></a>02044         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(&amp;pid, ob, psys);
<a name="l02045"></a>02045         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l02046"></a>02046         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a7b90fef9414cf9e322a23f6011c16440">BKE_ptcache_disk_to_mem</a>(&amp;pid);
<a name="l02047"></a>02047         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l02048"></a>02048     }
<a name="l02049"></a>02049 }
<a name="l02050"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad0c2de08fc7877137e6d8e2c203b7a28">02050</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ad0c2de08fc7877137e6d8e2c203b7a28">psys_clear_temp_pointcache</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l02051"></a>02051 {
<a name="l02052"></a>02052     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>)
<a name="l02053"></a>02053         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a21cc23638085a6c85ca20cf220b50754">BKE_ptcache_free_mem</a>(&amp;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>);
<a name="l02054"></a>02054 }
<a name="l02055"></a><a class="code" href="../../df/d40/particle__system_8c.html#a660f5bd1c605f9ccacb06d88fec2c89d">02055</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a4eb47a384d089ddb5b3c91ae3e8ae07a">psys_get_pointcache_start_end</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> *sfra, <span class="keywordtype">int</span> *efra)
<a name="l02056"></a>02056 {
<a name="l02057"></a>02057     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l02058"></a>02058 
<a name="l02059"></a>02059     *sfra = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1, (<span class="keywordtype">int</span>)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a>);
<a name="l02060"></a>02060     *efra = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>((<span class="keywordtype">int</span>)(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aaad187f6e55e19af7964ef74ef2f7b41">end</a> + part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad24d73f074832de37255a2f3cb1c16d0">lifetime</a> + 1.0f), scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>);
<a name="l02061"></a>02061 }
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 <span class="comment">/************************************************/</span>
<a name="l02064"></a>02064 <span class="comment">/*          Effectors                           */</span>
<a name="l02065"></a>02065 <span class="comment">/************************************************/</span>
<a name="l02066"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab65474e5e6875eaa766b038cf3422934">02066</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ab65474e5e6875eaa766b038cf3422934">psys_update_particle_bvhtree</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">float</span> cfra)
<a name="l02067"></a>02067 {
<a name="l02068"></a>02068     <span class="keywordflow">if</span> (psys) {
<a name="l02069"></a>02069         <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l02070"></a>02070         <span class="keywordtype">int</span> totpart = 0;
<a name="l02071"></a>02071 
<a name="l02072"></a>02072         <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac6dd233d4b7140cb774fdf7e59ff83be">bvhtree_frame</a> != cfra) {
<a name="l02073"></a>02073             <a class="code" href="../../db/dca/BKE__particle_8h.html#a3f8993c95b4edac4705866d967b2ed51">LOOP_SHOWN_PARTICLES</a> {
<a name="l02074"></a>02074                 totpart++;
<a name="l02075"></a>02075             }
<a name="l02076"></a>02076             
<a name="l02077"></a>02077             <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a7f17e6306b5a1a4025ea0775631461de">BLI_bvhtree_free</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a>);
<a name="l02078"></a>02078             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a> = <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a606a445825afda3db873f4b585f51f5b">BLI_bvhtree_new</a>(totpart, 0.0, 4, 6);
<a name="l02079"></a>02079 
<a name="l02080"></a>02080             <a class="code" href="../../db/dca/BKE__particle_8h.html#a3f8993c95b4edac4705866d967b2ed51">LOOP_SHOWN_PARTICLES</a> {
<a name="l02081"></a>02081                 <span class="keywordflow">if</span> (pa-&gt;alive == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>) {
<a name="l02082"></a>02082                     <span class="keywordflow">if</span> (pa-&gt;state.time == cfra)
<a name="l02083"></a>02083                         <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a5457bfc4e6d161a7c16366a415557f06">BLI_bvhtree_insert</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a>, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, pa-&gt;prev_state.co, 1);
<a name="l02084"></a>02084                     <span class="keywordflow">else</span>
<a name="l02085"></a>02085                         <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a5457bfc4e6d161a7c16366a415557f06">BLI_bvhtree_insert</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a>, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, pa-&gt;state.co, 1);
<a name="l02086"></a>02086                 }
<a name="l02087"></a>02087             }
<a name="l02088"></a>02088             <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a59fe8fa2e2aa5b7c170fdbb10eb979f8">BLI_bvhtree_balance</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a8002f8acdbcdb23dfc28598368a1292f">bvhtree</a>);
<a name="l02089"></a>02089 
<a name="l02090"></a>02090             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac6dd233d4b7140cb774fdf7e59ff83be">bvhtree_frame</a> = cfra;
<a name="l02091"></a>02091         }
<a name="l02092"></a>02092     }
<a name="l02093"></a>02093 }
<a name="l02094"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab2a7ab4377aa68ff03b781dac732064f">02094</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#aa570fc2652464faaab8b8edbe67fe176">psys_update_particle_tree</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">float</span> cfra)
<a name="l02095"></a>02095 {
<a name="l02096"></a>02096     <span class="keywordflow">if</span> (psys) {
<a name="l02097"></a>02097         <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l02098"></a>02098         <span class="keywordtype">int</span> totpart = 0;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100         <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a08777ab363e331e3681f65555590fa9f">tree_frame</a> != cfra) {
<a name="l02101"></a>02101             <a class="code" href="../../db/dca/BKE__particle_8h.html#a3f8993c95b4edac4705866d967b2ed51">LOOP_SHOWN_PARTICLES</a> {
<a name="l02102"></a>02102                 totpart++;
<a name="l02103"></a>02103             }
<a name="l02104"></a>02104 
<a name="l02105"></a>02105             <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aa2320bf47d28237bc6933a090b3eb51b">BLI_kdtree_free</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a>);
<a name="l02106"></a>02106             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a> = <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#aee4ccfd7db96a8b1ee06174e581a7d9d">BLI_kdtree_new</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>);
<a name="l02107"></a>02107 
<a name="l02108"></a>02108             <a class="code" href="../../db/dca/BKE__particle_8h.html#a3f8993c95b4edac4705866d967b2ed51">LOOP_SHOWN_PARTICLES</a> {
<a name="l02109"></a>02109                 <span class="keywordflow">if</span> (pa-&gt;alive == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>) {
<a name="l02110"></a>02110                     <span class="keywordflow">if</span> (pa-&gt;state.time == cfra)
<a name="l02111"></a>02111                         <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a23d67a64dfd26f5f2818d92a4580dccb">BLI_kdtree_insert</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a>, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, pa-&gt;prev_state.co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02112"></a>02112                     <span class="keywordflow">else</span>
<a name="l02113"></a>02113                         <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a23d67a64dfd26f5f2818d92a4580dccb">BLI_kdtree_insert</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a>, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, pa-&gt;state.co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02114"></a>02114                 }
<a name="l02115"></a>02115             }
<a name="l02116"></a>02116             <a class="code" href="../../d6/dd3/BLI__kdtree_8h.html#a38e3a059e408f7c3164f4e0ef5ab3b7a">BLI_kdtree_balance</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#abdfe77a522a61ab1e124508fa0956d6e">tree</a>);
<a name="l02117"></a>02117 
<a name="l02118"></a>02118             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a08777ab363e331e3681f65555590fa9f">tree_frame</a> = cfra;
<a name="l02119"></a>02119         }
<a name="l02120"></a>02120     }
<a name="l02121"></a>02121 }
<a name="l02122"></a>02122 
<a name="l02123"></a><a class="code" href="../../df/d40/particle__system_8c.html#aa9b2d7bc7dcda6cfced08e18adbf2acb">02123</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aa9b2d7bc7dcda6cfced08e18adbf2acb">psys_update_effectors</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l02124"></a>02124 {
<a name="l02125"></a>02125     <a class="code" href="../../dc/d65/BKE__effect_8h.html#a7da5e7ad353e025440f05a9adbd7032d">pdEndEffectors</a>(&amp;sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a530bbae7c2226da0cdfc6c52878cf547">effectors</a>);
<a name="l02126"></a>02126     sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a530bbae7c2226da0cdfc6c52878cf547">effectors</a> = <a class="code" href="../../dc/d65/BKE__effect_8h.html#a6ebcd51628cbb20d3556d779e0b506fe">pdInitEffectors</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>);
<a name="l02127"></a>02127     <a class="code" href="../../db/dca/BKE__particle_8h.html#a30e5b9ee6de4d7eafa1fdd0b44a16024">precalc_guides</a>(sim, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a530bbae7c2226da0cdfc6c52878cf547">effectors</a>);
<a name="l02128"></a>02128 }
<a name="l02129"></a>02129 
<a name="l02130"></a><a class="code" href="../../df/d40/particle__system_8c.html#a4f0a0056be95b47aa6ed6e21c6a95c6a">02130</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a4f0a0056be95b47aa6ed6e21c6a95c6a">integrate_particle</a>(<a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <span class="keywordtype">float</span> dtime, <span class="keywordtype">float</span> *external_acceleration, <span class="keywordtype">void</span> (*force_func)(<span class="keywordtype">void</span> *forcedata, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">float</span> *force, <span class="keywordtype">float</span> *impulse), <span class="keywordtype">void</span> *forcedata)
<a name="l02131"></a>02131 {
<a name="l02132"></a>02132     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> states[5];
<a name="l02133"></a>02133     <span class="keywordtype">float</span> force[3],acceleration[3],impulse[3],dx[4][3],dv[4][3],oldpos[3];
<a name="l02134"></a>02134     <span class="keywordtype">float</span> pa_mass= (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aae27f1431f3ccc5ba02b8cfa88230b94">PART_SIZEMASS</a> ? part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a406439e194f0d56f66fa3627b13b58ab">mass</a> * pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> : part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a406439e194f0d56f66fa3627b13b58ab">mass</a>);
<a name="l02135"></a>02135     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, steps=1;
<a name="l02136"></a>02136     <span class="keywordtype">int</span> integrator = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a85b23532b5a0495b891992a00886a3d4">integrator</a>;
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(oldpos, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02139"></a>02139     
<a name="l02140"></a>02140     <span class="comment">/* Verlet integration behaves strangely with moving emitters, so do first step with euler. */</span>
<a name="l02141"></a>02141     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> &lt; 0.f &amp;&amp; integrator == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a181ba4bdb31b706ae9ed64abbe500116">PART_INT_VERLET</a>)
<a name="l02142"></a>02142         integrator = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7c7db7a5a4f1a8d86a24fb0f92756cc7">PART_INT_EULER</a>;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="keywordflow">switch</span>(integrator) {
<a name="l02145"></a>02145         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7c7db7a5a4f1a8d86a24fb0f92756cc7">PART_INT_EULER</a>:
<a name="l02146"></a>02146             steps=1;
<a name="l02147"></a>02147             <span class="keywordflow">break</span>;
<a name="l02148"></a>02148         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3184d256aaa33ca99c1b0705b36f1b39">PART_INT_MIDPOINT</a>:
<a name="l02149"></a>02149             steps=2;
<a name="l02150"></a>02150             <span class="keywordflow">break</span>;
<a name="l02151"></a>02151         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af9f441cd78b148839757c46a1dff4b4f">PART_INT_RK4</a>:
<a name="l02152"></a>02152             steps=4;
<a name="l02153"></a>02153             <span class="keywordflow">break</span>;
<a name="l02154"></a>02154         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a181ba4bdb31b706ae9ed64abbe500116">PART_INT_VERLET</a>:
<a name="l02155"></a>02155             steps=1;
<a name="l02156"></a>02156             <span class="keywordflow">break</span>;
<a name="l02157"></a>02157     }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <a class="code" href="../../db/dca/BKE__particle_8h.html#a5b76b44a0cc1f11cb6b8a552d0e89724">copy_particle_key</a>(states, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, 1);
<a name="l02160"></a>02160 
<a name="l02161"></a>02161     states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = 0.f;
<a name="l02162"></a>02162 
<a name="l02163"></a>02163     <span class="keywordflow">for</span> (i=0; i&lt;steps; i++) {
<a name="l02164"></a>02164         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(force);
<a name="l02165"></a>02165         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(impulse);
<a name="l02166"></a>02166 
<a name="l02167"></a>02167         force_func(forcedata, states+i, force, impulse);
<a name="l02168"></a>02168 
<a name="l02169"></a>02169         <span class="comment">/* force to acceleration*/</span>
<a name="l02170"></a>02170         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(acceleration, force, 1.0f/pa_mass);
<a name="l02171"></a>02171 
<a name="l02172"></a>02172         <span class="keywordflow">if</span> (external_acceleration)
<a name="l02173"></a>02173             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(acceleration, external_acceleration);
<a name="l02174"></a>02174         
<a name="l02175"></a>02175         <span class="comment">/* calculate next state */</span>
<a name="l02176"></a>02176         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(states[i].vel, impulse);
<a name="l02177"></a>02177 
<a name="l02178"></a>02178         <span class="keywordflow">switch</span>(integrator) {
<a name="l02179"></a>02179             <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7c7db7a5a4f1a8d86a24fb0f92756cc7">PART_INT_EULER</a>:
<a name="l02180"></a>02180                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dtime);
<a name="l02181"></a>02181                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, acceleration, dtime);
<a name="l02182"></a>02182                 <span class="keywordflow">break</span>;
<a name="l02183"></a>02183             <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3184d256aaa33ca99c1b0705b36f1b39">PART_INT_MIDPOINT</a>:
<a name="l02184"></a>02184                 <span class="keywordflow">if</span> (i==0) {
<a name="l02185"></a>02185                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dtime*0.5f);
<a name="l02186"></a>02186                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[1].vel, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, acceleration, dtime*0.5f);
<a name="l02187"></a>02187                     states[1].<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dtime*0.5f;
<a name="l02188"></a>02188                     <span class="comment">/*fra=sim-&gt;psys-&gt;cfra+0.5f*dfra;*/</span>
<a name="l02189"></a>02189                 }
<a name="l02190"></a>02190                 <span class="keywordflow">else</span> {
<a name="l02191"></a>02191                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states[1].<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dtime);
<a name="l02192"></a>02192                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, acceleration, dtime);
<a name="l02193"></a>02193                 }
<a name="l02194"></a>02194                 <span class="keywordflow">break</span>;
<a name="l02195"></a>02195             <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af9f441cd78b148839757c46a1dff4b4f">PART_INT_RK4</a>:
<a name="l02196"></a>02196                 <span class="keywordflow">switch</span>(i) {
<a name="l02197"></a>02197                     <span class="keywordflow">case</span> 0:
<a name="l02198"></a>02198                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dx[0], states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02199"></a>02199                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dx[0], dtime);
<a name="l02200"></a>02200                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dv[0], acceleration);
<a name="l02201"></a>02201                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dv[0], dtime);
<a name="l02202"></a>02202 
<a name="l02203"></a>02203                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[0], 0.5f);
<a name="l02204"></a>02204                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[1].vel, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[0], 0.5f);
<a name="l02205"></a>02205                         states[1].<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dtime*0.5f;
<a name="l02206"></a>02206                         <span class="comment">/*fra=sim-&gt;psys-&gt;cfra+0.5f*dfra;*/</span>
<a name="l02207"></a>02207                         <span class="keywordflow">break</span>;
<a name="l02208"></a>02208                     <span class="keywordflow">case</span> 1:
<a name="l02209"></a>02209                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(dx[1], states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[0], 0.5f);
<a name="l02210"></a>02210                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dx[1], dtime);
<a name="l02211"></a>02211                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dv[1], acceleration);
<a name="l02212"></a>02212                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dv[1], dtime);
<a name="l02213"></a>02213 
<a name="l02214"></a>02214                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[2].co, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[1], 0.5f);
<a name="l02215"></a>02215                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(states[2].vel, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[1], 0.5f);
<a name="l02216"></a>02216                         states[2].<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dtime*0.5f;
<a name="l02217"></a>02217                         <span class="keywordflow">break</span>;
<a name="l02218"></a>02218                     <span class="keywordflow">case</span> 2:
<a name="l02219"></a>02219                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(dx[2], states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[1], 0.5f);
<a name="l02220"></a>02220                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dx[2], dtime);
<a name="l02221"></a>02221                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dv[2], acceleration);
<a name="l02222"></a>02222                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dv[2], dtime);
<a name="l02223"></a>02223 
<a name="l02224"></a>02224                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(states[3].co, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[2]);
<a name="l02225"></a>02225                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(states[3].vel, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[2]);
<a name="l02226"></a>02226                         states[3].<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dtime;
<a name="l02227"></a>02227                         <span class="comment">/*fra=cfra;*/</span>
<a name="l02228"></a>02228                         <span class="keywordflow">break</span>;
<a name="l02229"></a>02229                     <span class="keywordflow">case</span> 3:
<a name="l02230"></a>02230                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(dx[3], states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[2]);
<a name="l02231"></a>02231                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dx[3], dtime);
<a name="l02232"></a>02232                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dv[3], acceleration);
<a name="l02233"></a>02233                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dv[3], dtime);
<a name="l02234"></a>02234 
<a name="l02235"></a>02235                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[0], 1.0f/6.0f);
<a name="l02236"></a>02236                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[1], 1.0f/3.0f);
<a name="l02237"></a>02237                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[2], 1.0f/3.0f);
<a name="l02238"></a>02238                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, dx[3], 1.0f/6.0f);
<a name="l02239"></a>02239 
<a name="l02240"></a>02240                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, states-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[0], 1.0f/6.0f);
<a name="l02241"></a>02241                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[1], 1.0f/3.0f);
<a name="l02242"></a>02242                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[2], 1.0f/3.0f);
<a name="l02243"></a>02243                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dv[3], 1.0f/6.0f);
<a name="l02244"></a>02244                 }
<a name="l02245"></a>02245                 <span class="keywordflow">break</span>;
<a name="l02246"></a>02246             <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a181ba4bdb31b706ae9ed64abbe500116">PART_INT_VERLET</a>:   <span class="comment">/* Verlet integration */</span>
<a name="l02247"></a>02247                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, acceleration, dtime);
<a name="l02248"></a>02248                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, dtime);
<a name="l02249"></a>02249 
<a name="l02250"></a>02250                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, oldpos);
<a name="l02251"></a>02251                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, 1.0f/dtime);
<a name="l02252"></a>02252                 <span class="keywordflow">break</span>;
<a name="l02253"></a>02253         }
<a name="l02254"></a>02254     }
<a name="l02255"></a>02255 }
<a name="l02256"></a>02256 
<a name="l02257"></a>02257 <span class="comment">/*********************************************************************************************************</span>
<a name="l02258"></a>02258 <span class="comment"> *                    SPH fluid physics </span>
<a name="l02259"></a>02259 <span class="comment"> *</span>
<a name="l02260"></a>02260 <span class="comment"> * In theory, there could be unlimited implementation of SPH simulators</span>
<a name="l02261"></a>02261 <span class="comment"> *</span>
<a name="l02262"></a>02262 <span class="comment"> * This code uses in some parts adapted algorithms from the pseudo code as outlined in the Research paper:</span>
<a name="l02263"></a>02263 <span class="comment"> *</span>
<a name="l02264"></a>02264 <span class="comment"> * Titled: Particle-based Viscoelastic Fluid Simulation.</span>
<a name="l02265"></a>02265 <span class="comment"> * Authors: Simon Clavet, Philippe Beaudoin and Pierre Poulin</span>
<a name="l02266"></a>02266 <span class="comment"> * Website: http://www.iro.umontreal.ca/labs/infographie/papers/Clavet-2005-PVFS/</span>
<a name="l02267"></a>02267 <span class="comment"> *</span>
<a name="l02268"></a>02268 <span class="comment"> * Presented at Siggraph, (2005)</span>
<a name="l02269"></a>02269 <span class="comment"> *</span>
<a name="l02270"></a>02270 <span class="comment"> * ********************************************************************************************************/</span>
<a name="l02271"></a><a class="code" href="../../df/d40/particle__system_8c.html#a9c1ba0d9f4672ebea8a75a680d5c3a94">02271</a> <span class="preprocessor">#define PSYS_FLUID_SPRINGS_INITIAL_SIZE 256</span>
<a name="l02272"></a><a class="code" href="../../df/d40/particle__system_8c.html#a9a4592989a440543cde016d6538fed99">02272</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> *<a class="code" href="../../df/d40/particle__system_8c.html#a9a4592989a440543cde016d6538fed99">sph_spring_add</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> *spring)
<a name="l02273"></a>02273 {
<a name="l02274"></a>02274     <span class="comment">/* Are more refs required? */</span>
<a name="l02275"></a>02275     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> == 0 || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02276"></a>02276         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> = <a class="code" href="../../df/d40/particle__system_8c.html#a9c1ba0d9f4672ebea8a75a680d5c3a94">PSYS_FLUID_SPRINGS_INITIAL_SIZE</a>;
<a name="l02277"></a>02277         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = (<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>), <span class="stringliteral">&quot;Particle Fluid Springs&quot;</span>);
<a name="l02278"></a>02278     }
<a name="l02279"></a>02279     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> == psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a>) {
<a name="l02280"></a>02280         <span class="comment">/* Double the number of refs allocated */</span>
<a name="l02281"></a>02281         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> *= 2;
<a name="l02282"></a>02282         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = (<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>));
<a name="l02283"></a>02283     }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285     memcpy(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>, spring, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>));
<a name="l02286"></a>02286     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>++;
<a name="l02287"></a>02287 
<a name="l02288"></a>02288     <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> - 1;
<a name="l02289"></a>02289 }
<a name="l02290"></a><a class="code" href="../../df/d40/particle__system_8c.html#a681844b363b57b8c4284133a8e7cf79d">02290</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a681844b363b57b8c4284133a8e7cf79d">sph_spring_delete</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> j)
<a name="l02291"></a>02291 {
<a name="l02292"></a>02292     <span class="keywordflow">if</span> (j != psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> - 1)
<a name="l02293"></a>02293         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>[j] = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>[psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> - 1];
<a name="l02294"></a>02294 
<a name="l02295"></a>02295     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>--;
<a name="l02296"></a>02296 
<a name="l02297"></a>02297     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> &lt; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a>/2 &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> &gt; <a class="code" href="../../df/d40/particle__system_8c.html#a9c1ba0d9f4672ebea8a75a680d5c3a94">PSYS_FLUID_SPRINGS_INITIAL_SIZE</a>) {
<a name="l02298"></a>02298         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> /= 2;
<a name="l02299"></a>02299         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = (<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>,  psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a>));
<a name="l02300"></a>02300     }
<a name="l02301"></a>02301 }
<a name="l02302"></a><a class="code" href="../../df/d40/particle__system_8c.html#aa0f5bd222ef8e3b9d9776705b09d2c7e">02302</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aa0f5bd222ef8e3b9d9776705b09d2c7e">sph_springs_modify</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">float</span> dtime)
<a name="l02303"></a>02303 {
<a name="l02304"></a>02304     <a class="code" href="../../dc/dec/structSPHFluidSettings.html">SPHFluidSettings</a> *fluid = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>;
<a name="l02305"></a>02305     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa1, *pa2;
<a name="l02306"></a>02306     <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> *spring = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>;
<a name="l02307"></a>02307     
<a name="l02308"></a>02308     <span class="keywordtype">float</span> h, d, Rij[3], rij, Lij;
<a name="l02309"></a>02309     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02310"></a>02310 
<a name="l02311"></a>02311     <span class="keywordtype">float</span> yield_ratio = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#afb71873140a34fb9f23f0df84c695e02">yield_ratio</a>;
<a name="l02312"></a>02312     <span class="keywordtype">float</span> plasticity = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#aaa124eaea3771050852377fb7016c998">plasticity_constant</a>;
<a name="l02313"></a>02313     <span class="comment">/* scale things according to dtime */</span>
<a name="l02314"></a>02314     <span class="keywordtype">float</span> timefix = 25.f * dtime;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316     <span class="keywordflow">if</span> ((fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a52543435c6331404504cf2e8ff560dab">SPH_VISCOELASTIC_SPRINGS</a>)==0 || fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a741e28e1248ae13c22a4005957ac91af">spring_k</a> == 0.f)
<a name="l02317"></a>02317         <span class="keywordflow">return</span>;
<a name="l02318"></a>02318 
<a name="l02319"></a>02319     <span class="comment">/* Loop through the springs */</span>
<a name="l02320"></a>02320     <span class="keywordflow">for</span> (i=0; i&lt;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>; i++, spring++) {
<a name="l02321"></a>02321         pa1 = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[0];
<a name="l02322"></a>02322         pa2 = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[1];
<a name="l02323"></a>02323 
<a name="l02324"></a>02324         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(Rij, pa2-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa1-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02325"></a>02325         rij = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(Rij);
<a name="l02326"></a>02326 
<a name="l02327"></a>02327         <span class="comment">/* adjust rest length */</span>
<a name="l02328"></a>02328         Lij = spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a>;
<a name="l02329"></a>02329         d = yield_ratio * timefix * Lij;
<a name="l02330"></a>02330 
<a name="l02331"></a>02331         <span class="keywordflow">if</span> (rij &gt; Lij + d) <span class="comment">// Stretch</span>
<a name="l02332"></a>02332             spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a> += plasticity * (rij - Lij - d) * timefix;
<a name="l02333"></a>02333         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rij &lt; Lij - d) <span class="comment">// Compress</span>
<a name="l02334"></a>02334             spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a> -= plasticity * (Lij - d - rij) * timefix;
<a name="l02335"></a>02335 
<a name="l02336"></a>02336         h = 4.f*pa1-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>;
<a name="l02337"></a>02337 
<a name="l02338"></a>02338         <span class="keywordflow">if</span> (spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a> &gt; h)
<a name="l02339"></a>02339             spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a16f94b64add511655763180807f0dd38">delete_flag</a> = 1;
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341 
<a name="l02342"></a>02342     <span class="comment">/* Loop through springs backwaqrds - for efficient delete function */</span>
<a name="l02343"></a>02343     <span class="keywordflow">for</span> (i=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>-1; i &gt;= 0; i--) {
<a name="l02344"></a>02344         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>[i].<a class="code" href="../../d5/da1/structParticleSpring.html#a16f94b64add511655763180807f0dd38">delete_flag</a>)
<a name="l02345"></a>02345             <a class="code" href="../../df/d40/particle__system_8c.html#a681844b363b57b8c4284133a8e7cf79d">sph_spring_delete</a>(psys, i);
<a name="l02346"></a>02346     }
<a name="l02347"></a>02347 }
<a name="l02348"></a><a class="code" href="../../df/d40/particle__system_8c.html#a7d4f41de4bd8544105ffe32645785341">02348</a> <span class="keyword">static</span> <a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *<a class="code" href="../../df/d40/particle__system_8c.html#a7d4f41de4bd8544105ffe32645785341">sph_springhash_build</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l02349"></a>02349 {
<a name="l02350"></a>02350     <a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *springhash = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02351"></a>02351     <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> *spring;
<a name="l02352"></a>02352     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l02353"></a>02353 
<a name="l02354"></a>02354     springhash = <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#aa74e7b101fe3c5b8acf0f169efdf0cfb">BLI_edgehash_new</a>();
<a name="l02355"></a>02355 
<a name="l02356"></a>02356     <span class="keywordflow">for</span> (i=0, spring=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>; i&lt;psys-&gt;tot_fluidsprings; i++, spring++)
<a name="l02357"></a>02357         <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a2e0f4e2b0d6efaccac6f6d7c595955eb">BLI_edgehash_insert</a>(springhash, spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[0], spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[1], <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(i+1));
<a name="l02358"></a>02358 
<a name="l02359"></a>02359     <span class="keywordflow">return</span> springhash;
<a name="l02360"></a>02360 }
<a name="l02361"></a>02361 
<a name="l02362"></a><a class="code" href="../../df/d40/particle__system_8c.html#a5961f3a543231e6a64ad2dcf139bd596">02362</a> <span class="preprocessor">#define SPH_NEIGHBORS 512</span>
<a name="l02363"></a><a class="code" href="../../d0/db0/structSPHNeighbor.html">02363</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/db0/structSPHNeighbor.html">SPHNeighbor</a>
<a name="l02364"></a>02364 {
<a name="l02365"></a><a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">02365</a>     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a>;
<a name="l02366"></a><a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">02366</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a>;
<a name="l02367"></a>02367 } <a class="code" href="../../df/d40/particle__system_8c.html#a00498570aee7b391d020e90cdac54438">SPHNeighbor</a>;
<a name="l02368"></a><a class="code" href="../../db/df1/structSPHRangeData.html">02368</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/df1/structSPHRangeData.html">SPHRangeData</a>
<a name="l02369"></a>02369 {
<a name="l02370"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">02370</a>     <a class="code" href="../../d0/db0/structSPHNeighbor.html">SPHNeighbor</a> <a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>[<a class="code" href="../../df/d40/particle__system_8c.html#a5961f3a543231e6a64ad2dcf139bd596">SPH_NEIGHBORS</a>];
<a name="l02371"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">02371</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>;
<a name="l02372"></a>02372 
<a name="l02373"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a48724f620e602eb46711b2b7ecf043fb">02373</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/df1/structSPHRangeData.html#a6feac6b665b3c5e600358c0de7ac5e13">density</a>, <a class="code" href="../../db/df1/structSPHRangeData.html#a48724f620e602eb46711b2b7ecf043fb">near_density</a>;
<a name="l02374"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a79d9ede14df24de73e893d2553784cd6">02374</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/df1/structSPHRangeData.html#a79d9ede14df24de73e893d2553784cd6">h</a>;
<a name="l02375"></a>02375 
<a name="l02376"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a98e69cd5423173bf6eb05d6949a94828">02376</a>     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *<a class="code" href="../../db/df1/structSPHRangeData.html#a98e69cd5423173bf6eb05d6949a94828">npsys</a>;
<a name="l02377"></a><a class="code" href="../../db/df1/structSPHRangeData.html#aa32aaedfa45ffdcc250d7bb9bf778be9">02377</a>     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *<a class="code" href="../../db/df1/structSPHRangeData.html#aa32aaedfa45ffdcc250d7bb9bf778be9">pa</a>;
<a name="l02378"></a>02378 
<a name="l02379"></a><a class="code" href="../../db/df1/structSPHRangeData.html#adf5ec0400c2e7fa71569bc824eb612f5">02379</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/df1/structSPHRangeData.html#adf5ec0400c2e7fa71569bc824eb612f5">massfac</a>;
<a name="l02380"></a><a class="code" href="../../db/df1/structSPHRangeData.html#a78cf175a2d1b2abb7dd414b2357ecfea">02380</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/df1/structSPHRangeData.html#a78cf175a2d1b2abb7dd414b2357ecfea">use_size</a>;
<a name="l02381"></a>02381 } <a class="code" href="../../df/d40/particle__system_8c.html#a67d985d42b0a697fc86931adea8ceded">SPHRangeData</a>;
<a name="l02382"></a>02382 
<a name="l02383"></a><a class="code" href="../../d2/d3d/structSPHData.html">02383</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> {
<a name="l02384"></a><a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">02384</a>     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *<a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">psys</a>[10];
<a name="l02385"></a><a class="code" href="../../d2/d3d/structSPHData.html#a32a823040b805a4ace99b5f78724ad45">02385</a>     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *<a class="code" href="../../d2/d3d/structSPHData.html#a32a823040b805a4ace99b5f78724ad45">pa</a>;
<a name="l02386"></a><a class="code" href="../../d2/d3d/structSPHData.html#aa7d4120254c289d81c85e9c949e9ab7a">02386</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3d/structSPHData.html#aa7d4120254c289d81c85e9c949e9ab7a">mass</a>;
<a name="l02387"></a><a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">02387</a>     <a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a>;
<a name="l02388"></a><a class="code" href="../../d2/d3d/structSPHData.html#a77268da77fb81e060a805f813f57e572">02388</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3d/structSPHData.html#a77268da77fb81e060a805f813f57e572">gravity</a>;
<a name="l02389"></a>02389     <span class="comment">/* Average distance to neighbors (other particles in the support domain),</span>
<a name="l02390"></a>02390 <span class="comment">     * for calculating the Courant number (adaptive time step). */</span>
<a name="l02391"></a><a class="code" href="../../d2/d3d/structSPHData.html#a9f2fb08ecb8a73a03289e5e912be3224">02391</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d3d/structSPHData.html#a9f2fb08ecb8a73a03289e5e912be3224">pass</a>;
<a name="l02392"></a><a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">02392</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">element_size</a>;
<a name="l02393"></a><a class="code" href="../../d2/d3d/structSPHData.html#a99187c1365972dd9b9c7050139d520a2">02393</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3d/structSPHData.html#a99187c1365972dd9b9c7050139d520a2">flow</a>[3];
<a name="l02394"></a>02394 
<a name="l02395"></a>02395     <span class="comment">/* Integrator callbacks. This allows different SPH implementations. */</span>
<a name="l02396"></a><a class="code" href="../../d2/d3d/structSPHData.html#abd8be10c5d537db75a4863e217db91d0">02396</a>     void (*<a class="code" href="../../d2/d3d/structSPHData.html#abd8be10c5d537db75a4863e217db91d0">force_cb</a>) (<span class="keywordtype">void</span> *sphdata_v, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">float</span> *force, <span class="keywordtype">float</span> *impulse);
<a name="l02397"></a><a class="code" href="../../d2/d3d/structSPHData.html#ac3289a75a184d0f19ef2cd458f6fa99d">02397</a>     void (*<a class="code" href="../../d2/d3d/structSPHData.html#ac3289a75a184d0f19ef2cd458f6fa99d">density_cb</a>) (<span class="keywordtype">void</span> *rangedata_v, <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> squared_dist);
<a name="l02398"></a>02398 } <a class="code" href="../../df/d40/particle__system_8c.html#a61c3ac05d75f980be9e739e2153974be">SPHData</a>;
<a name="l02399"></a>02399 
<a name="l02400"></a><a class="code" href="../../df/d40/particle__system_8c.html#a7f7ce88ecc50ba1a67e684d04d1ad02d">02400</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a7f7ce88ecc50ba1a67e684d04d1ad02d">sph_density_accum_cb</a>(<span class="keywordtype">void</span> *userdata, <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> squared_dist)
<a name="l02401"></a>02401 {
<a name="l02402"></a>02402     <a class="code" href="../../db/df1/structSPHRangeData.html">SPHRangeData</a> *pfr = (<a class="code" href="../../db/df1/structSPHRangeData.html">SPHRangeData</a> *)userdata;
<a name="l02403"></a>02403     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *npa = pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a98e69cd5423173bf6eb05d6949a94828">npsys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + index;
<a name="l02404"></a>02404     <span class="keywordtype">float</span> q;
<a name="l02405"></a>02405     <span class="keywordtype">float</span> dist;
<a name="l02406"></a>02406 
<a name="l02407"></a>02407     <span class="keywordflow">if</span> (npa == pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#aa32aaedfa45ffdcc250d7bb9bf778be9">pa</a> || squared_dist &lt; FLT_EPSILON)
<a name="l02408"></a>02408         <span class="keywordflow">return</span>;
<a name="l02409"></a>02409 
<a name="l02410"></a>02410     <span class="comment">/* Ugh! One particle has too many neighbors! If some aren&#39;t taken into</span>
<a name="l02411"></a>02411 <span class="comment">     * account, the forces will be biased by the tree search order. This</span>
<a name="l02412"></a>02412 <span class="comment">     * effectively adds enery to the system, and results in a churning motion.</span>
<a name="l02413"></a>02413 <span class="comment">     * But, we have to stop somewhere, and it&#39;s not the end of the world.</span>
<a name="l02414"></a>02414 <span class="comment">     *  - jahka and z0r</span>
<a name="l02415"></a>02415 <span class="comment">     */</span>
<a name="l02416"></a>02416     <span class="keywordflow">if</span> (pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a> &gt;= <a class="code" href="../../df/d40/particle__system_8c.html#a5961f3a543231e6a64ad2dcf139bd596">SPH_NEIGHBORS</a>)
<a name="l02417"></a>02417         <span class="keywordflow">return</span>;
<a name="l02418"></a>02418 
<a name="l02419"></a>02419     pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>[pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>].<a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a> = index;
<a name="l02420"></a>02420     pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>[pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>].<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a> = pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a98e69cd5423173bf6eb05d6949a94828">npsys</a>;
<a name="l02421"></a>02421     pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>++;
<a name="l02422"></a>02422 
<a name="l02423"></a>02423     dist = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(squared_dist);
<a name="l02424"></a>02424     q = (1.f - dist/pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a79d9ede14df24de73e893d2553784cd6">h</a>) * pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#adf5ec0400c2e7fa71569bc824eb612f5">massfac</a>;
<a name="l02425"></a>02425 
<a name="l02426"></a>02426     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a78cf175a2d1b2abb7dd414b2357ecfea">use_size</a>)
<a name="l02427"></a>02427         q *= npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>;
<a name="l02428"></a>02428 
<a name="l02429"></a>02429     pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a6feac6b665b3c5e600358c0de7ac5e13">density</a> += q*q;
<a name="l02430"></a>02430     pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a48724f620e602eb46711b2b7ecf043fb">near_density</a> += q*q*q;
<a name="l02431"></a>02431 }
<a name="l02432"></a>02432 
<a name="l02433"></a>02433 <span class="comment">/*</span>
<a name="l02434"></a>02434 <span class="comment"> * Find the Courant number for an SPH particle (used for adaptive time step).</span>
<a name="l02435"></a>02435 <span class="comment"> */</span>
<a name="l02436"></a><a class="code" href="../../df/d40/particle__system_8c.html#a4aa47bfb8c4b0405439f3695e7a74d0c">02436</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a4aa47bfb8c4b0405439f3695e7a74d0c">sph_particle_courant</a>(<a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata, <a class="code" href="../../db/df1/structSPHRangeData.html">SPHRangeData</a> *pfr)
<a name="l02437"></a>02437 {
<a name="l02438"></a>02438     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, *npa;
<a name="l02439"></a>02439     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02440"></a>02440     <span class="keywordtype">float</span> flow[3], offset[3], dist;
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     flow[0] = flow[1] = flow[2] = 0.0f;
<a name="l02443"></a>02443     dist = 0.0f;
<a name="l02444"></a>02444     <span class="keywordflow">if</span> (pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a> &gt; 0) {
<a name="l02445"></a>02445         pa = pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#aa32aaedfa45ffdcc250d7bb9bf778be9">pa</a>;
<a name="l02446"></a>02446         <span class="keywordflow">for</span> (i=0; i &lt; pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>; i++) {
<a name="l02447"></a>02447             npa = pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a>;
<a name="l02448"></a>02448             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(offset, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02449"></a>02449             dist += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(offset);
<a name="l02450"></a>02450             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(flow, npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02451"></a>02451         }
<a name="l02452"></a>02452         dist += sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">psys</a>[0]-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3c862176cec0f6d154b586c95cb3eef9">radius</a>; <span class="comment">// TODO: remove this? - z0r</span>
<a name="l02453"></a>02453         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">element_size</a> = dist / pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>;
<a name="l02454"></a>02454         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a99187c1365972dd9b9c7050139d520a2">flow</a>, flow, 1.0f / pfr-&gt;<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>);
<a name="l02455"></a>02455     }
<a name="l02456"></a>02456     <span class="keywordflow">else</span> {
<a name="l02457"></a>02457         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">element_size</a> = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5e9e29217f6ec61105a4520ec5942225">MAXFLOAT</a>;
<a name="l02458"></a>02458         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a99187c1365972dd9b9c7050139d520a2">flow</a>, flow);
<a name="l02459"></a>02459     }
<a name="l02460"></a>02460 }
<a name="l02461"></a><a class="code" href="../../df/d40/particle__system_8c.html#a31d8e97a43f9c59c9db6b8f0f88fe892">02461</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a31d8e97a43f9c59c9db6b8f0f88fe892">sph_force_cb</a>(<span class="keywordtype">void</span> *sphdata_v, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">float</span> *force, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(impulse))
<a name="l02462"></a>02462 {
<a name="l02463"></a>02463     <a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata = (<a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *)sphdata_v;
<a name="l02464"></a>02464     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> **psys = sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">psys</a>;
<a name="l02465"></a>02465     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa = sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a32a823040b805a4ace99b5f78724ad45">pa</a>;
<a name="l02466"></a>02466     <a class="code" href="../../dc/dec/structSPHFluidSettings.html">SPHFluidSettings</a> *fluid = psys[0]-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>;
<a name="l02467"></a>02467     <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> *spring = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02468"></a>02468     <a class="code" href="../../db/df1/structSPHRangeData.html">SPHRangeData</a> pfr;
<a name="l02469"></a>02469     <a class="code" href="../../d0/db0/structSPHNeighbor.html">SPHNeighbor</a> *pfn;
<a name="l02470"></a>02470     <span class="keywordtype">float</span> mass = sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#aa7d4120254c289d81c85e9c949e9ab7a">mass</a>;
<a name="l02471"></a>02471     <span class="keywordtype">float</span> *gravity = sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a77268da77fb81e060a805f813f57e572">gravity</a>;
<a name="l02472"></a>02472     <a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *springhash = sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a>;
<a name="l02473"></a>02473 
<a name="l02474"></a>02474     <span class="keywordtype">float</span> q, u, rij, dv[3];
<a name="l02475"></a>02475     <span class="keywordtype">float</span> pressure, near_pressure;
<a name="l02476"></a>02476 
<a name="l02477"></a>02477     <span class="keywordtype">float</span> visc = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a1260d04b9f6de9be921a6fe51f4c2161">viscosity_omega</a>;
<a name="l02478"></a>02478     <span class="keywordtype">float</span> stiff_visc = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a638fd519a54ce0f1e80403096053cf10">viscosity_beta</a> * (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8d0765504fa2fc04012e5b6f5579beb7">SPH_FAC_VISCOSITY</a> ? fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a1260d04b9f6de9be921a6fe51f4c2161">viscosity_omega</a> : 1.f);
<a name="l02479"></a>02479 
<a name="l02480"></a>02480     <span class="keywordtype">float</span> inv_mass = 1.0f/mass;
<a name="l02481"></a>02481     <span class="keywordtype">float</span> spring_constant = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a741e28e1248ae13c22a4005957ac91af">spring_k</a>;
<a name="l02482"></a>02482     
<a name="l02483"></a>02483     <span class="keywordtype">float</span> h = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3c862176cec0f6d154b586c95cb3eef9">radius</a> * (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a73860b1cccbd3d53f68d5866349a22b5">SPH_FAC_RADIUS</a> ? 4.f*pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> : 1.f); <span class="comment">/* 4.0 seems to be a pretty good value */</span>
<a name="l02484"></a>02484     <span class="keywordtype">float</span> rest_density = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a02ffbdbc2fd53c6a07ff4d15b7b5cf2d">rest_density</a> * (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a807a2c378806c6f97fe123fa241be237">SPH_FAC_DENSITY</a> ? 4.77f : 1.f); <span class="comment">/* 4.77 is an experimentally determined density factor */</span>
<a name="l02485"></a>02485     <span class="keywordtype">float</span> rest_length = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a1735770145f57a726145c62e4febdd32">rest_length</a> * (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a998a03e8c54b5f2f64e39bb7d72dffeb">SPH_FAC_REST_LENGTH</a> ? 2.588f * pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> : 1.f);
<a name="l02486"></a>02486 
<a name="l02487"></a>02487     <span class="keywordtype">float</span> stiffness = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#ae8c9e7bb63f9b3df64315bf1251e63fb">stiffness_k</a>;
<a name="l02488"></a>02488     <span class="keywordtype">float</span> stiffness_near_fac = fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a6f50b5b42b1ba89370dfb018ce5520a3">stiffness_knear</a> * (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93aa7174a2fa964091451ea4b416638d">SPH_FAC_REPULSION</a> ? fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#ae8c9e7bb63f9b3df64315bf1251e63fb">stiffness_k</a> : 1.f);
<a name="l02489"></a>02489 
<a name="l02490"></a>02490     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *npa;
<a name="l02491"></a>02491     <span class="keywordtype">float</span> vec[3];
<a name="l02492"></a>02492     <span class="keywordtype">float</span> vel[3];
<a name="l02493"></a>02493     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];
<a name="l02494"></a>02494 
<a name="l02495"></a>02495     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, spring_index, index = pa - psys[0]-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l02496"></a>02496 
<a name="l02497"></a>02497     pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a> = 0;
<a name="l02498"></a>02498     pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a6feac6b665b3c5e600358c0de7ac5e13">density</a> = pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a48724f620e602eb46711b2b7ecf043fb">near_density</a> = 0.f;
<a name="l02499"></a>02499     pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a79d9ede14df24de73e893d2553784cd6">h</a> = h;
<a name="l02500"></a>02500     pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#aa32aaedfa45ffdcc250d7bb9bf778be9">pa</a> = pa;
<a name="l02501"></a>02501 
<a name="l02502"></a>02502     <span class="keywordflow">for</span> (i=0; i&lt;10 &amp;&amp; psys[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; i++) {
<a name="l02503"></a>02503         pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a98e69cd5423173bf6eb05d6949a94828">npsys</a> = psys[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02504"></a>02504         pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#adf5ec0400c2e7fa71569bc824eb612f5">massfac</a> = psys[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;part-&gt;mass*inv_mass;
<a name="l02505"></a>02505         pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a78cf175a2d1b2abb7dd414b2357ecfea">use_size</a> = psys[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;part-&gt;flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aae27f1431f3ccc5ba02b8cfa88230b94">PART_SIZEMASS</a>;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507         <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a0507c49cfb4ed1bddfd85f64683bcfd0">BLI_bvhtree_range_query</a>(psys[i]-&gt;bvhtree, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, h, sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ac3289a75a184d0f19ef2cd458f6fa99d">density_cb</a>, &amp;pfr);
<a name="l02508"></a>02508     }
<a name="l02509"></a>02509 
<a name="l02510"></a>02510     pressure =  stiffness * (pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a6feac6b665b3c5e600358c0de7ac5e13">density</a> - rest_density);
<a name="l02511"></a>02511     near_pressure = stiffness_near_fac * pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a48724f620e602eb46711b2b7ecf043fb">near_density</a>;
<a name="l02512"></a>02512 
<a name="l02513"></a>02513     pfn = pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a549e886f59e97937c1a685849b280e0f">neighbors</a>;
<a name="l02514"></a>02514     <span class="keywordflow">for</span> (i=0; i&lt;pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a0f3b8ba4068503bf646a10650a86ea2f">tot_neighbors</a>; i++, pfn++) {
<a name="l02515"></a>02515         npa = pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a>;
<a name="l02516"></a>02516 
<a name="l02517"></a>02517         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(co, npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>);
<a name="l02518"></a>02518 
<a name="l02519"></a>02519         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, co, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02520"></a>02520         rij = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         q = (1.f - rij/h) * pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a406439e194f0d56f66fa3627b13b58ab">mass</a> * inv_mass;
<a name="l02523"></a>02523 
<a name="l02524"></a>02524         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aae27f1431f3ccc5ba02b8cfa88230b94">PART_SIZEMASS</a>)
<a name="l02525"></a>02525             q *= npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>;
<a name="l02526"></a>02526 
<a name="l02527"></a>02527         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vel, npa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02528"></a>02528 
<a name="l02529"></a>02529         <span class="comment">/* Double Density Relaxation */</span>
<a name="l02530"></a>02530         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, vec, -(pressure + near_pressure*q)*q);
<a name="l02531"></a>02531 
<a name="l02532"></a>02532         <span class="comment">/* Viscosity */</span>
<a name="l02533"></a>02533         <span class="keywordflow">if</span> (visc &gt; 0.f  || stiff_visc &gt; 0.f) {      
<a name="l02534"></a>02534             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dv, vel, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02535"></a>02535             u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, dv);
<a name="l02536"></a>02536 
<a name="l02537"></a>02537             <span class="keywordflow">if</span> (u &lt; 0.f &amp;&amp; visc &gt; 0.f)
<a name="l02538"></a>02538                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, vec, 0.5f * q * visc * u );
<a name="l02539"></a>02539 
<a name="l02540"></a>02540             <span class="keywordflow">if</span> (u &gt; 0.f &amp;&amp; stiff_visc &gt; 0.f)
<a name="l02541"></a>02541                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, vec, 0.5f * q * stiff_visc * u );
<a name="l02542"></a>02542         }
<a name="l02543"></a>02543 
<a name="l02544"></a>02544         <span class="keywordflow">if</span> (spring_constant &gt; 0.f) {
<a name="l02545"></a>02545             <span class="comment">/* Viscoelastic spring force */</span>
<a name="l02546"></a>02546             <span class="keywordflow">if</span> (pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#a2af59b2edce1ca903f30e071ed95f4c3">psys</a> == psys[0] &amp;&amp; fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a52543435c6331404504cf2e8ff560dab">SPH_VISCOELASTIC_SPRINGS</a> &amp;&amp; springhash) {
<a name="l02547"></a>02547                 <span class="comment">/* BLI_edgehash_lookup appears to be thread-safe. - z0r */</span>
<a name="l02548"></a>02548                 spring_index = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(<a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a22081636d4bd43fb323bea9b10b6c67a">BLI_edgehash_lookup</a>(springhash, index, pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a>));
<a name="l02549"></a>02549 
<a name="l02550"></a>02550                 <span class="keywordflow">if</span> (spring_index) {
<a name="l02551"></a>02551                     spring = psys[0]-&gt;fluid_springs + spring_index - 1;
<a name="l02552"></a>02552 
<a name="l02553"></a>02553                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, vec, -10.f * spring_constant * (1.f - rij/h) * (spring-&gt;<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a> - rij));
<a name="l02554"></a>02554                 }
<a name="l02555"></a>02555                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a7f01f3fe95eb6ba125f6b36ab6c616df">spring_frames</a> == 0 || (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>-pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>) &lt;= fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a7f01f3fe95eb6ba125f6b36ab6c616df">spring_frames</a>) {
<a name="l02556"></a>02556                     <a class="code" href="../../d5/da1/structParticleSpring.html">ParticleSpring</a> temp_spring;
<a name="l02557"></a>02557                     temp_spring.<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[0] = index;
<a name="l02558"></a>02558                     temp_spring.<a class="code" href="../../d5/da1/structParticleSpring.html#a492dab318ac9e6666cbee4b22dca7372">particle_index</a>[1] = pfn-&gt;<a class="code" href="../../d0/db0/structSPHNeighbor.html#ae4c909aecf9b3a3fb171cddb9ed511c9">index</a>;
<a name="l02559"></a>02559                     temp_spring.<a class="code" href="../../d5/da1/structParticleSpring.html#a2f07c73937424b455573812e7ba344ff">rest_length</a> = (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a381f24cd9bcadde04183712b30984eea">SPH_CURRENT_REST_LENGTH</a>) ? rij : rest_length;
<a name="l02560"></a>02560                     temp_spring.<a class="code" href="../../d5/da1/structParticleSpring.html#a16f94b64add511655763180807f0dd38">delete_flag</a> = 0;
<a name="l02561"></a>02561 
<a name="l02562"></a>02562                     <span class="comment">/* sph_spring_add is not thread-safe. - z0r */</span>
<a name="l02563"></a>02563 <span class="preprocessor">                    #pragma omp critical</span>
<a name="l02564"></a>02564 <span class="preprocessor"></span>                    <a class="code" href="../../df/d40/particle__system_8c.html#a9a4592989a440543cde016d6538fed99">sph_spring_add</a>(psys[0], &amp;temp_spring);
<a name="l02565"></a>02565                 }
<a name="l02566"></a>02566             }
<a name="l02567"></a>02567             <span class="keywordflow">else</span> {<span class="comment">/* PART_SPRING_HOOKES - Hooke&#39;s spring force */</span>
<a name="l02568"></a>02568                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, vec, -10.f * spring_constant * (1.f - rij/h) * (rest_length - rij));
<a name="l02569"></a>02569             }
<a name="l02570"></a>02570         }
<a name="l02571"></a>02571     }
<a name="l02572"></a>02572     
<a name="l02573"></a>02573     <span class="comment">/* Artificial buoyancy force in negative gravity direction  */</span>
<a name="l02574"></a>02574     <span class="keywordflow">if</span> (fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3bdcb3d8df6f6018da1e99b15d00cb75">buoyancy</a> &gt; 0.f &amp;&amp; gravity)
<a name="l02575"></a>02575         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, gravity, fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3bdcb3d8df6f6018da1e99b15d00cb75">buoyancy</a> * (pfr.<a class="code" href="../../db/df1/structSPHRangeData.html#a6feac6b665b3c5e600358c0de7ac5e13">density</a>-rest_density));
<a name="l02576"></a>02576 
<a name="l02577"></a>02577     <span class="keywordflow">if</span> (sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a9f2fb08ecb8a73a03289e5e912be3224">pass</a> == 0 &amp;&amp; psys[0]-&gt;part-&gt;time_flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3668a7bcb08c9f9af95dd5a2d4b1867b">PART_TIME_AUTOSF</a>)
<a name="l02578"></a>02578         <a class="code" href="../../df/d40/particle__system_8c.html#a4aa47bfb8c4b0405439f3695e7a74d0c">sph_particle_courant</a>(sphdata, &amp;pfr);
<a name="l02579"></a>02579     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a9f2fb08ecb8a73a03289e5e912be3224">pass</a>++;
<a name="l02580"></a>02580 }
<a name="l02581"></a>02581 
<a name="l02582"></a><a class="code" href="../../df/d40/particle__system_8c.html#a192d0078854b03b3da322863a3511625">02582</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a192d0078854b03b3da322863a3511625">sph_solver_init</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata)
<a name="l02583"></a>02583 {
<a name="l02584"></a>02584     <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt;
<a name="l02585"></a>02585     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02586"></a>02586 
<a name="l02587"></a>02587     <span class="comment">// Add other coupled particle systems.</span>
<a name="l02588"></a>02588     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">psys</a>[0] = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l02589"></a>02589     <span class="keywordflow">for</span> (i=1, pt=sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; i&lt;10; i++, pt=(pt?pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a>:<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l02590"></a>02590         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a3aa0679805ed624d11cba227722080dc">psys</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = pt ? <a class="code" href="../../db/dca/BKE__particle_8h.html#a3c8c6e6b538826e4392822afe850c00f">psys_get_target_system</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, pt) : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02591"></a>02591 
<a name="l02592"></a>02592     <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a8ff92112d1b6398bf65d970965c12db8">psys_uses_gravity</a>(sim))
<a name="l02593"></a>02593         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a77268da77fb81e060a805f813f57e572">gravity</a> = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>;
<a name="l02594"></a>02594     <span class="keywordflow">else</span>
<a name="l02595"></a>02595         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a77268da77fb81e060a805f813f57e572">gravity</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02596"></a>02596     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a> = <a class="code" href="../../df/d40/particle__system_8c.html#a7d4f41de4bd8544105ffe32645785341">sph_springhash_build</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l02597"></a>02597 
<a name="l02598"></a>02598     <span class="comment">// These per-particle values should be overridden later, but just for</span>
<a name="l02599"></a>02599     <span class="comment">// completeness we give them default values now.</span>
<a name="l02600"></a>02600     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a32a823040b805a4ace99b5f78724ad45">pa</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02601"></a>02601     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#aa7d4120254c289d81c85e9c949e9ab7a">mass</a> = 1.0f;
<a name="l02602"></a>02602 
<a name="l02603"></a>02603     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#abd8be10c5d537db75a4863e217db91d0">force_cb</a> = <a class="code" href="../../df/d40/particle__system_8c.html#a31d8e97a43f9c59c9db6b8f0f88fe892">sph_force_cb</a>;
<a name="l02604"></a>02604     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ac3289a75a184d0f19ef2cd458f6fa99d">density_cb</a> = <a class="code" href="../../df/d40/particle__system_8c.html#a7f7ce88ecc50ba1a67e684d04d1ad02d">sph_density_accum_cb</a>;
<a name="l02605"></a>02605 }
<a name="l02606"></a>02606 
<a name="l02607"></a><a class="code" href="../../df/d40/particle__system_8c.html#a17dc0037b3f3136aad7e688d5e63cbaf">02607</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a17dc0037b3f3136aad7e688d5e63cbaf">sph_solver_finalise</a>(<a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata)
<a name="l02608"></a>02608 {
<a name="l02609"></a>02609     <span class="keywordflow">if</span> (sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a>) {
<a name="l02610"></a>02610         <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a14b3a8c9081b5a9c40edd7294856c45c">BLI_edgehash_free</a>(sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02611"></a>02611         sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#ad59db948aefc47de7b468f68c8bfa673">eh</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02612"></a>02612     }
<a name="l02613"></a>02613 }
<a name="l02614"></a>02614 
<a name="l02615"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab2855e2e7cd57a96ad2fc3a7a0061775">02615</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ab2855e2e7cd57a96ad2fc3a7a0061775">sph_integrate</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <span class="keywordtype">float</span> dfra, <a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata)
<a name="l02616"></a>02616 {
<a name="l02617"></a>02617     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l02618"></a>02618     <span class="comment">// float timestep = psys_get_timestep(sim); // UNUSED</span>
<a name="l02619"></a>02619     <span class="keywordtype">float</span> pa_mass = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a406439e194f0d56f66fa3627b13b58ab">mass</a> * (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aae27f1431f3ccc5ba02b8cfa88230b94">PART_SIZEMASS</a> ? pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> : 1.f);
<a name="l02620"></a>02620     <span class="keywordtype">float</span> dtime = dfra*<a class="code" href="../../db/dca/BKE__particle_8h.html#a75c75a40fcacfa5cb9e05638d6e823ad">psys_get_timestep</a>(sim);
<a name="l02621"></a>02621     <span class="comment">// int steps = 1; // UNUSED</span>
<a name="l02622"></a>02622     <span class="keywordtype">float</span> effector_acceleration[3];
<a name="l02623"></a>02623 
<a name="l02624"></a>02624     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a32a823040b805a4ace99b5f78724ad45">pa</a> = pa;
<a name="l02625"></a>02625     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#aa7d4120254c289d81c85e9c949e9ab7a">mass</a> = pa_mass;
<a name="l02626"></a>02626     sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a9f2fb08ecb8a73a03289e5e912be3224">pass</a> = 0;
<a name="l02627"></a>02627     <span class="comment">//sphdata.element_size and sphdata.flow are set in the callback.</span>
<a name="l02628"></a>02628 
<a name="l02629"></a>02629     <span class="comment">/* restore previous state and treat gravity &amp; effectors as external acceleration*/</span>
<a name="l02630"></a>02630     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(effector_acceleration, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02631"></a>02631     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(effector_acceleration, 1.f/dtime);
<a name="l02632"></a>02632 
<a name="l02633"></a>02633     <a class="code" href="../../db/dca/BKE__particle_8h.html#a5b76b44a0cc1f11cb6b8a552d0e89724">copy_particle_key</a>(&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>, 0);
<a name="l02634"></a>02634 
<a name="l02635"></a>02635     <a class="code" href="../../df/d40/particle__system_8c.html#a4f0a0056be95b47aa6ed6e21c6a95c6a">integrate_particle</a>(part, pa, dtime, effector_acceleration, sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#abd8be10c5d537db75a4863e217db91d0">force_cb</a>, sphdata);
<a name="l02636"></a>02636 }
<a name="l02637"></a>02637 
<a name="l02638"></a>02638 <span class="comment">/************************************************/</span>
<a name="l02639"></a>02639 <span class="comment">/*          Basic physics                       */</span>
<a name="l02640"></a>02640 <span class="comment">/************************************************/</span>
<a name="l02641"></a><a class="code" href="../../d2/dac/structEfData.html">02641</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/dac/structEfData.html">EfData</a>
<a name="l02642"></a>02642 {
<a name="l02643"></a><a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">02643</a>     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> <a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>;
<a name="l02644"></a><a class="code" href="../../d2/dac/structEfData.html#afc5785414af37de0da055af8887d3fe7">02644</a>     <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *<a class="code" href="../../d2/dac/structEfData.html#afc5785414af37de0da055af8887d3fe7">sim</a>;
<a name="l02645"></a><a class="code" href="../../d2/dac/structEfData.html#a34738cbb5b8769643a23cd08394525b2">02645</a>     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *<a class="code" href="../../d2/dac/structEfData.html#a34738cbb5b8769643a23cd08394525b2">pa</a>;
<a name="l02646"></a>02646 } <a class="code" href="../../df/d40/particle__system_8c.html#aec567ed7d8b77e201ccb65ae78f7a2a9">EfData</a>;
<a name="l02647"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab13ffc6b1bc929377c9518cac7a112b6">02647</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ab13ffc6b1bc929377c9518cac7a112b6">basic_force_cb</a>(<span class="keywordtype">void</span> *efdata_v, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *state, <span class="keywordtype">float</span> *force, <span class="keywordtype">float</span> *impulse)
<a name="l02648"></a>02648 {
<a name="l02649"></a>02649     <a class="code" href="../../d2/dac/structEfData.html">EfData</a> *efdata = (<a class="code" href="../../d2/dac/structEfData.html">EfData</a> *)efdata_v;
<a name="l02650"></a>02650     <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim = efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#afc5785414af37de0da055af8887d3fe7">sim</a>;
<a name="l02651"></a>02651     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l02652"></a>02652     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa = efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#a34738cbb5b8769643a23cd08394525b2">pa</a>;
<a name="l02653"></a>02653     <a class="code" href="../../db/d29/structEffectedPoint.html">EffectedPoint</a> epoint;
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     <span class="comment">/* add effectors */</span>
<a name="l02656"></a>02656     <a class="code" href="../../dc/d65/BKE__effect_8h.html#ae9109fc44dd1583fda8a8e5a293e2783">pd_point_from_particle</a>(efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#afc5785414af37de0da055af8887d3fe7">sim</a>, efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#a34738cbb5b8769643a23cd08394525b2">pa</a>, state, &amp;epoint);
<a name="l02657"></a>02657     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> || part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>-&gt;<a class="code" href="../../db/d19/structEffectorWeights.html#ab8552155eb24fe6e17ac245856934f8a">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1a5b0c9d1266597e782a5bb765b1d59f">EFF_WEIGHT_DO_HAIR</a>)
<a name="l02658"></a>02658         <a class="code" href="../../dc/d65/BKE__effect_8h.html#a4099ac2ecd7e48764e8e741bf2aade72">pdDoEffectors</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a530bbae7c2226da0cdfc6c52878cf547">effectors</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>, &amp;epoint, force, impulse);
<a name="l02659"></a>02659 
<a name="l02660"></a>02660     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(force, efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>.<a class="code" href="../../d8/d60/structParticleTexture.html#abe839f635a645858db02d670e1021093">field</a>);
<a name="l02661"></a>02661     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(impulse, efdata-&gt;<a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>.<a class="code" href="../../d8/d60/structParticleTexture.html#abe839f635a645858db02d670e1021093">field</a>);
<a name="l02662"></a>02662 
<a name="l02663"></a>02663     <span class="comment">/* calculate air-particle interaction */</span>
<a name="l02664"></a>02664     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afc22a44ce2914118caa62d17829f7028">dragfac</a> != 0.0f)
<a name="l02665"></a>02665         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(force, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, -part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afc22a44ce2914118caa62d17829f7028">dragfac</a> * pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> * pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>));
<a name="l02666"></a>02666 
<a name="l02667"></a>02667     <span class="comment">/* brownian force */</span>
<a name="l02668"></a>02668     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a5956b642946e5df3a69929ecf8e69160">brownfac</a> != 0.0f) {
<a name="l02669"></a>02669         force[0] += (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f) * part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a5956b642946e5df3a69929ecf8e69160">brownfac</a>;
<a name="l02670"></a>02670         force[1] += (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f) * part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a5956b642946e5df3a69929ecf8e69160">brownfac</a>;
<a name="l02671"></a>02671         force[2] += (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f) * part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a5956b642946e5df3a69929ecf8e69160">brownfac</a>;
<a name="l02672"></a>02672     }
<a name="l02673"></a>02673 }
<a name="l02674"></a>02674 <span class="comment">/* gathers all forces that effect particles and calculates a new state for the particle */</span>
<a name="l02675"></a><a class="code" href="../../df/d40/particle__system_8c.html#a46999aed187684f17527b6c3dc71ad41">02675</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a46999aed187684f17527b6c3dc71ad41">basic_integrate</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">float</span> dfra, <span class="keywordtype">float</span> cfra)
<a name="l02676"></a>02676 {
<a name="l02677"></a>02677     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l02678"></a>02678     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l02679"></a>02679     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> tkey;
<a name="l02680"></a>02680     <span class="keywordtype">float</span> dtime=dfra*<a class="code" href="../../db/dca/BKE__particle_8h.html#a75c75a40fcacfa5cb9e05638d6e823ad">psys_get_timestep</a>(sim), time;
<a name="l02681"></a>02681     <span class="keywordtype">float</span> *gravity = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, gr[3];
<a name="l02682"></a>02682     <a class="code" href="../../d2/dac/structEfData.html">EfData</a> efdata;
<a name="l02683"></a>02683 
<a name="l02684"></a>02684     <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;efdata.<a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7227b9f03214c92909732d3230f1d0e8">PAMAP_PHYSICS</a>, cfra);
<a name="l02685"></a>02685 
<a name="l02686"></a>02686     efdata.<a class="code" href="../../d2/dac/structEfData.html#a34738cbb5b8769643a23cd08394525b2">pa</a> = pa;
<a name="l02687"></a>02687     efdata.<a class="code" href="../../d2/dac/structEfData.html#afc5785414af37de0da055af8887d3fe7">sim</a> = sim;
<a name="l02688"></a>02688 
<a name="l02689"></a>02689     <span class="comment">/* add global acceleration (gravitation) */</span>
<a name="l02690"></a>02690     <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a8ff92112d1b6398bf65d970965c12db8">psys_uses_gravity</a>(sim) &amp;&amp;
<a name="l02691"></a>02691         <span class="comment">/* normal gravity is too strong for hair so it&#39;s disabled by default */</span>
<a name="l02692"></a>02692         (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> || part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>-&gt;<a class="code" href="../../db/d19/structEffectorWeights.html#ab8552155eb24fe6e17ac245856934f8a">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1a5b0c9d1266597e782a5bb765b1d59f">EFF_WEIGHT_DO_HAIR</a>))
<a name="l02693"></a>02693     {
<a name="l02694"></a>02694         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(gr);
<a name="l02695"></a>02695         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(gr, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>-&gt;<a class="code" href="../../db/d19/structEffectorWeights.html#af1e527b00a665e3ac926d0aa7c54b9d0">global_gravity</a> * efdata.<a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>.<a class="code" href="../../d8/d60/structParticleTexture.html#aa09ef77bf1704117ad1bc130382ebaa5">gravity</a>);
<a name="l02696"></a>02696         gravity = gr;
<a name="l02697"></a>02697     }
<a name="l02698"></a>02698 
<a name="l02699"></a>02699     <span class="comment">/* maintain angular velocity */</span>
<a name="l02700"></a>02700     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l02701"></a>02701 
<a name="l02702"></a>02702     <a class="code" href="../../df/d40/particle__system_8c.html#a4f0a0056be95b47aa6ed6e21c6a95c6a">integrate_particle</a>(part, pa, dtime, gravity, <a class="code" href="../../df/d40/particle__system_8c.html#ab13ffc6b1bc929377c9518cac7a112b6">basic_force_cb</a>, &amp;efdata);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704     <span class="comment">/* damp affects final velocity */</span>
<a name="l02705"></a>02705     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac6bff08377a8829ab2758f0fc071505b">dampfac</a> != 0.f)
<a name="l02706"></a>02706         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, 1.f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ac6bff08377a8829ab2758f0fc071505b">dampfac</a> * efdata.<a class="code" href="../../d2/dac/structEfData.html#a2e7b0b0b39ca0ffad2b86d068a6be447">ptex</a>.<a class="code" href="../../d8/d60/structParticleTexture.html#a5daa7d5257f6af0e58a5bcd20a3ddf4d">damp</a> * 25.f * dtime);
<a name="l02707"></a>02707 
<a name="l02708"></a>02708     <span class="comment">//copy_v3_v3(pa-&gt;state.ave, states-&gt;ave);</span>
<a name="l02709"></a>02709 
<a name="l02710"></a>02710     <span class="comment">/* finally we do guides */</span>
<a name="l02711"></a>02711     time=(cfra-pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>)/pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a>;
<a name="l02712"></a>02712     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(time, 0.0f, 1.0f);
<a name="l02713"></a>02713 
<a name="l02714"></a>02714     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tkey.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02715"></a>02715     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tkey.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02716"></a>02716     tkey.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>;
<a name="l02717"></a>02717 
<a name="l02718"></a>02718     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) {
<a name="l02719"></a>02719         <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#abf9e500f8d7aa3e72cdf94e78d9f1b35">do_guides</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a530bbae7c2226da0cdfc6c52878cf547">effectors</a>, &amp;tkey, p, time)) {
<a name="l02720"></a>02720             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>,tkey.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02721"></a>02721             <span class="comment">/* guides don&#39;t produce valid velocity */</span>
<a name="l02722"></a>02722             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, tkey.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02723"></a>02723             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>,1.0f/dtime);
<a name="l02724"></a>02724             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>=tkey.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>;
<a name="l02725"></a>02725         }
<a name="l02726"></a>02726     }
<a name="l02727"></a>02727 }
<a name="l02728"></a><a class="code" href="../../df/d40/particle__system_8c.html#a6835f63573f5d96a041def3c73e3e540">02728</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a6835f63573f5d96a041def3c73e3e540">basic_rotate</a>(<a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <span class="keywordtype">float</span> dfra, <span class="keywordtype">float</span> timestep)
<a name="l02729"></a>02729 {
<a name="l02730"></a>02730     <span class="keywordtype">float</span> rotfac, rot1[4], rot2[4]={1.0,0.0,0.0,0.0}, dtime=dfra*timestep;
<a name="l02731"></a>02731 
<a name="l02732"></a>02732     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acb1eead271635dccefc77a7126e214a2">PART_ROTATIONS</a>)==0) {
<a name="l02733"></a>02733         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[0]=1.0f;
<a name="l02734"></a>02734         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[1]=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[2]=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[3]=0;
<a name="l02735"></a>02735         <span class="keywordflow">return</span>;
<a name="l02736"></a>02736     }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad0717fb365b30da8ad2381fd9a688a4c">PART_ROT_DYN</a>)==0 &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aac9f9ad3e203936ab6e2888e9ccbbb15">PART_AVE_VELOCITY</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acf672289946f5a36e5ed97d20441182d">PART_AVE_HORIZONTAL</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad4c4dec792dfb046fea2c3a4a2685920">PART_AVE_VERTICAL</a>)) {
<a name="l02739"></a>02739         <span class="keywordtype">float</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l02740"></a>02740         <span class="keywordtype">float</span> len1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02741"></a>02741         <span class="keywordtype">float</span> len2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02742"></a>02742         <span class="keywordtype">float</span> vec[3];
<a name="l02743"></a>02743 
<a name="l02744"></a>02744         <span class="keywordflow">if</span> (len1==0.0f || len2==0.0f)
<a name="l02745"></a>02745             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[0] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[1] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[2] = 0.0f;
<a name="l02746"></a>02746         <span class="keywordflow">else</span> {
<a name="l02747"></a>02747             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02748"></a>02748             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l02749"></a>02749             angle = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>) / (len1 * len2);
<a name="l02750"></a>02750             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(angle) / dtime);
<a name="l02751"></a>02751         }
<a name="l02752"></a>02752 
<a name="l02753"></a>02753         <a class="code" href="../../df/d40/particle__system_8c.html#ad484aef3a7b06cbd0a8c7790115425ea">get_angular_velocity_vector</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a>, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, vec);
<a name="l02754"></a>02754         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a31e0d088e5faae71dd3e9e4232f7c2a5">axis_angle_to_quat</a>(rot2, vec, dtime*part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad26b38930a1c5771dcb93f5b33b67b68">avefac</a>);
<a name="l02755"></a>02755     }
<a name="l02756"></a>02756 
<a name="l02757"></a>02757     rotfac = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l02758"></a>02758     <span class="keywordflow">if</span> (rotfac == 0.0f) { <span class="comment">/* unit_qt(in VecRotToQuat) doesn&#39;t give unit quat [1,0,0,0]?? */</span>
<a name="l02759"></a>02759         rot1[0]=1.0f;
<a name="l02760"></a>02760         rot1[1]=rot1[2]=rot1[3]=0;
<a name="l02761"></a>02761     }
<a name="l02762"></a>02762     <span class="keywordflow">else</span> {
<a name="l02763"></a>02763         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a31e0d088e5faae71dd3e9e4232f7c2a5">axis_angle_to_quat</a>(rot1,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>,rotfac*dtime);
<a name="l02764"></a>02764     }
<a name="l02765"></a>02765     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>,rot1,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l02766"></a>02766     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>,rot2,pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l02767"></a>02767 
<a name="l02768"></a>02768     <span class="comment">/* keep rotation quat in good health */</span>
<a name="l02769"></a>02769     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l02770"></a>02770 }
<a name="l02771"></a>02771 
<a name="l02772"></a>02772 <span class="comment">/************************************************/</span>
<a name="l02773"></a>02773 <span class="comment">/*          Collisions                          */</span>
<a name="l02774"></a>02774 <span class="comment">/************************************************/</span>
<a name="l02775"></a><a class="code" href="../../df/d40/particle__system_8c.html#a07a352d4fe89db18644bfeb8c634b66f">02775</a> <span class="preprocessor">#define COLLISION_MAX_COLLISIONS    10</span>
<a name="l02776"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad646e7c4bd5998b2abcbe0c15c0bbea4">02776</a> <span class="preprocessor"></span><span class="preprocessor">#define COLLISION_MIN_RADIUS 0.001f</span>
<a name="l02777"></a><a class="code" href="../../df/d40/particle__system_8c.html#afff275792de68f639084d96ae3d08d7c">02777</a> <span class="preprocessor"></span><span class="preprocessor">#define COLLISION_MIN_DISTANCE 0.0001f</span>
<a name="l02778"></a><a class="code" href="../../df/d40/particle__system_8c.html#a1a344e1c05c0e648af3265ce29e39331">02778</a> <span class="preprocessor"></span><span class="preprocessor">#define COLLISION_ZERO 0.00001f</span>
<a name="l02779"></a><a class="code" href="../../df/d40/particle__system_8c.html#abf0099dd42cbf736cf5beff1f6696f6c">02779</a> <span class="preprocessor"></span><span class="keyword">typedef</span> float (*<a class="code" href="../../df/d40/particle__system_8c.html#abf0099dd42cbf736cf5beff1f6696f6c">NRDistanceFunc</a>)(<span class="keywordtype">float</span> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *nor);
<a name="l02780"></a><a class="code" href="../../df/d40/particle__system_8c.html#a78bd26ab1f7e45bcb25322e331a2e96d">02780</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#a78bd26ab1f7e45bcb25322e331a2e96d">nr_signed_distance_to_plane</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *nor)
<a name="l02781"></a>02781 {
<a name="l02782"></a>02782     <span class="keywordtype">float</span> p0[3], e1[3], e2[3], d;
<a name="l02783"></a>02783 
<a name="l02784"></a>02784     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02785"></a>02785     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a3b27a6eb87d4837c6698bb11489f4807">x2</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02786"></a>02786     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(p0, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02787"></a>02787 
<a name="l02788"></a>02788     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(nor, e1, e2);
<a name="l02789"></a>02789     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02790"></a>02790 
<a name="l02791"></a>02791     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(p0, nor);
<a name="l02792"></a>02792 
<a name="l02793"></a>02793     <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> == -1) {
<a name="l02794"></a>02794         <span class="keywordflow">if</span> (d &lt; 0.f)
<a name="l02795"></a>02795             pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> = 1;
<a name="l02796"></a>02796         <span class="keywordflow">else</span>
<a name="l02797"></a>02797             pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> = 0;
<a name="l02798"></a>02798     }
<a name="l02799"></a>02799 
<a name="l02800"></a>02800     <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> == 1) {
<a name="l02801"></a>02801         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(nor);
<a name="l02802"></a>02802         d = -d;
<a name="l02803"></a>02803     }
<a name="l02804"></a>02804 
<a name="l02805"></a>02805     <span class="keywordflow">return</span> d - radius;
<a name="l02806"></a>02806 }
<a name="l02807"></a><a class="code" href="../../df/d40/particle__system_8c.html#a22181ac9986881b5a8abe41284be3da3">02807</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#a22181ac9986881b5a8abe41284be3da3">nr_distance_to_edge</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(nor))
<a name="l02808"></a>02808 {
<a name="l02809"></a>02809     <span class="keywordtype">float</span> v0[3], v1[3], v2[3], c[3];
<a name="l02810"></a>02810 
<a name="l02811"></a>02811     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v0, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02812"></a>02812     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02813"></a>02813     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v2, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>);
<a name="l02814"></a>02814 
<a name="l02815"></a>02815     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(c, v1, v2);
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(c)/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(v0)) - radius;
<a name="l02818"></a>02818 }
<a name="l02819"></a><a class="code" href="../../df/d40/particle__system_8c.html#a095441914230c5e60199fb5e8e4cc22f">02819</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#a095441914230c5e60199fb5e8e4cc22f">nr_distance_to_vert</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(nor))
<a name="l02820"></a>02820 {
<a name="l02821"></a>02821     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>) - radius;
<a name="l02822"></a>02822 }
<a name="l02823"></a><a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">02823</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(<a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> fac, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col)
<a name="l02824"></a>02824 {
<a name="l02825"></a>02825     <span class="comment">/* t is the current time for newton rhapson */</span>
<a name="l02826"></a>02826     <span class="comment">/* fac is the starting factor for current collision iteration */</span>
<a name="l02827"></a>02827     <span class="comment">/* the col-&gt;fac&#39;s are factors for the particle subframe step start and end during collision modifier step */</span>
<a name="l02828"></a>02828     <span class="keywordtype">float</span> f = fac + t*(1.f-fac);
<a name="l02829"></a>02829     <span class="keywordtype">float</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a0ea807db9b245d41852d0326d715cc0b">mul</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a4f1fe5055cbee62b90b77c0ecfab9396">fac1</a> + f * (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#adc06ac4c1c894982d8e6e7f0588ccedc">fac2</a>-col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a4f1fe5055cbee62b90b77c0ecfab9396">fac1</a>);
<a name="l02830"></a>02830     <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> &gt; 0) {
<a name="l02831"></a>02831         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[0], pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0], mul);
<a name="l02832"></a>02832 
<a name="l02833"></a>02833         <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> &gt; 1) {
<a name="l02834"></a>02834             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[1], pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[1], mul);
<a name="l02835"></a>02835 
<a name="l02836"></a>02836             <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> &gt; 2)
<a name="l02837"></a>02837                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a3b27a6eb87d4837c6698bb11489f4807">x2</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[2], pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[2], mul);
<a name="l02838"></a>02838         }
<a name="l02839"></a>02839     }
<a name="l02840"></a>02840 }
<a name="l02841"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae43df2978b543fa6ebd1b3e47a2a333d">02841</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ae43df2978b543fa6ebd1b3e47a2a333d">collision_point_velocity</a>(<a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce)
<a name="l02842"></a>02842 {
<a name="l02843"></a>02843     <span class="keywordtype">float</span> v[3];
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0]);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847     <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> &gt; 1) {
<a name="l02848"></a>02848         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[1], pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0]);
<a name="l02849"></a>02849         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>, v, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[0]);
<a name="l02850"></a>02850 
<a name="l02851"></a>02851         <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> &gt; 2) {
<a name="l02852"></a>02852             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[2], pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0]);
<a name="l02853"></a>02853             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>, v, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[1]);
<a name="l02854"></a>02854         }
<a name="l02855"></a>02855     }
<a name="l02856"></a>02856 }
<a name="l02857"></a><a class="code" href="../../df/d40/particle__system_8c.html#a11f7e36239548efe4287e74d5d220554">02857</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#a11f7e36239548efe4287e74d5d220554">collision_point_distance_with_normal</a>(<span class="keywordtype">float</span> p[3], <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> fac, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> *nor)
<a name="l02858"></a>02858 {
<a name="l02859"></a>02859     <span class="keywordflow">if</span> (fac &gt;= 0.f)
<a name="l02860"></a>02860         <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(pce, 0.f, fac, col);
<a name="l02861"></a>02861 
<a name="l02862"></a>02862     <span class="keywordflow">switch</span>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a>) {
<a name="l02863"></a>02863         <span class="keywordflow">case</span> 1:
<a name="l02864"></a>02864         {
<a name="l02865"></a>02865             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02866"></a>02866             <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02867"></a>02867         }
<a name="l02868"></a>02868         <span class="keywordflow">case</span> 2:
<a name="l02869"></a>02869         {
<a name="l02870"></a>02870             <span class="keywordtype">float</span> u, e[3], vec[3];
<a name="l02871"></a>02871             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02872"></a>02872             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02873"></a>02873             u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, e) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e, e);
<a name="l02874"></a>02874 
<a name="l02875"></a>02875             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(nor, vec, e, -u);
<a name="l02876"></a>02876             <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02877"></a>02877         }
<a name="l02878"></a>02878         <span class="keywordflow">case</span> 3:
<a name="l02879"></a>02879             <span class="keywordflow">return</span> <a class="code" href="../../df/d40/particle__system_8c.html#a78bd26ab1f7e45bcb25322e331a2e96d">nr_signed_distance_to_plane</a>(p, 0.f, pce, nor);
<a name="l02880"></a>02880     }
<a name="l02881"></a>02881     <span class="keywordflow">return</span> 0;
<a name="l02882"></a>02882 }
<a name="l02883"></a><a class="code" href="../../df/d40/particle__system_8c.html#a78ee9f89a1ba554909a8db1ce8459458">02883</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a78ee9f89a1ba554909a8db1ce8459458">collision_point_on_surface</a>(<span class="keywordtype">float</span> p[3], <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> fac, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l02884"></a>02884 {
<a name="l02885"></a>02885     <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(pce, 0.f, fac, col);
<a name="l02886"></a>02886 
<a name="l02887"></a>02887     <span class="keywordflow">switch</span>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a>) {
<a name="l02888"></a>02888         <span class="keywordflow">case</span> 1:
<a name="l02889"></a>02889         {
<a name="l02890"></a>02890             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(co, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02891"></a>02891             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(co);
<a name="l02892"></a>02892             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(co, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>, co, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a>);
<a name="l02893"></a>02893             <span class="keywordflow">break</span>;
<a name="l02894"></a>02894         }
<a name="l02895"></a>02895         <span class="keywordflow">case</span> 2:
<a name="l02896"></a>02896         {
<a name="l02897"></a>02897             <span class="keywordtype">float</span> u, e[3], vec[3], nor[3];
<a name="l02898"></a>02898             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02899"></a>02899             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02900"></a>02900             u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, e) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e, e);
<a name="l02901"></a>02901 
<a name="l02902"></a>02902             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(nor, vec, e, -u);
<a name="l02903"></a>02903             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02904"></a>02904 
<a name="l02905"></a>02905             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(co, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>, e, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[0]);
<a name="l02906"></a>02906             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, nor, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a>);
<a name="l02907"></a>02907             <span class="keywordflow">break</span>;
<a name="l02908"></a>02908         }
<a name="l02909"></a>02909         <span class="keywordflow">case</span> 3:
<a name="l02910"></a>02910         {
<a name="l02911"></a>02911                 <span class="keywordtype">float</span> p0[3], e1[3], e2[3], nor[3];
<a name="l02912"></a>02912 
<a name="l02913"></a>02913                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02914"></a>02914                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a3b27a6eb87d4837c6698bb11489f4807">x2</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02915"></a>02915                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(p0, p, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l02916"></a>02916 
<a name="l02917"></a>02917                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(nor, e1, e2);
<a name="l02918"></a>02918                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02919"></a>02919 
<a name="l02920"></a>02920                 <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> == 1)
<a name="l02921"></a>02921                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(nor);
<a name="l02922"></a>02922 
<a name="l02923"></a>02923                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(co, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>, nor, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a>);
<a name="l02924"></a>02924                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, e1, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[0]);
<a name="l02925"></a>02925                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, e2, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[1]);
<a name="l02926"></a>02926             <span class="keywordflow">break</span>;
<a name="l02927"></a>02927         }
<a name="l02928"></a>02928     }
<a name="l02929"></a>02929 }
<a name="l02930"></a>02930 <span class="comment">/* find first root in range [0-1] starting from 0 */</span>
<a name="l02931"></a><a class="code" href="../../df/d40/particle__system_8c.html#a25e7bb9c7c68317610b1df6af4c42f44">02931</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#a25e7bb9c7c68317610b1df6af4c42f44">collision_newton_rhapson</a>(<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <a class="code" href="../../df/d40/particle__system_8c.html#abf0099dd42cbf736cf5beff1f6696f6c">NRDistanceFunc</a> distance_func)
<a name="l02932"></a>02932 {
<a name="l02933"></a>02933     <span class="keywordtype">float</span> t0, t1, d0, d1, dd, n[3];
<a name="l02934"></a>02934     <span class="keywordtype">int</span> iter;
<a name="l02935"></a>02935 
<a name="l02936"></a>02936     pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> = -1;
<a name="l02937"></a>02937 
<a name="l02938"></a>02938     <span class="comment">/* start from the beginning */</span>
<a name="l02939"></a>02939     t0 = 0.f;
<a name="l02940"></a>02940     <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(pce, t0, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a>, col);
<a name="l02941"></a>02941     d0 = distance_func(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, radius, pce, n);
<a name="l02942"></a>02942     t1 = 0.001f;
<a name="l02943"></a>02943     d1 = 0.f;
<a name="l02944"></a>02944 
<a name="l02945"></a>02945     <span class="keywordflow">for</span> (iter=0; iter&lt;10; iter++) {<span class="comment">//, itersum++) {</span>
<a name="l02946"></a>02946         <span class="comment">/* get current location */</span>
<a name="l02947"></a>02947         <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(pce, t1, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a>, col);
<a name="l02948"></a>02948         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, t1);
<a name="l02949"></a>02949 
<a name="l02950"></a>02950         d1 = distance_func(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, radius, pce, n);
<a name="l02951"></a>02951 
<a name="l02952"></a>02952         <span class="comment">/* no movement, so no collision */</span>
<a name="l02953"></a>02953         <span class="keywordflow">if</span> (d1 == d0) {
<a name="l02954"></a>02954             <span class="keywordflow">return</span> -1.f;
<a name="l02955"></a>02955         }
<a name="l02956"></a>02956 
<a name="l02957"></a>02957         <span class="comment">/* particle already inside face, so report collision */</span>
<a name="l02958"></a>02958         <span class="keywordflow">if</span> (iter == 0 &amp;&amp; d0 &lt; 0.f &amp;&amp; d0 &gt; -radius) {
<a name="l02959"></a>02959             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>);
<a name="l02960"></a>02960             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, n);
<a name="l02961"></a>02961             pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 1;
<a name="l02962"></a>02962             <span class="keywordflow">return</span> 0.f;
<a name="l02963"></a>02963         }
<a name="l02964"></a>02964         
<a name="l02965"></a>02965         dd = (t1-t0)/(d1-d0);
<a name="l02966"></a>02966 
<a name="l02967"></a>02967         t0 = t1;
<a name="l02968"></a>02968         d0 = d1;
<a name="l02969"></a>02969 
<a name="l02970"></a>02970         t1 -= d1*dd;
<a name="l02971"></a>02971 
<a name="l02972"></a>02972         <span class="comment">/* particle movin away from plane could also mean a strangely rotating face, so check from end */</span>
<a name="l02973"></a>02973         <span class="keywordflow">if</span> (iter == 0 &amp;&amp; t1 &lt; 0.f) {
<a name="l02974"></a>02974             t0 = 1.f;
<a name="l02975"></a>02975             <a class="code" href="../../df/d40/particle__system_8c.html#a64e89a2dc5df7777994e15767082f9ce">collision_interpolate_element</a>(pce, t0, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a>, col);
<a name="l02976"></a>02976             d0 = distance_func(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, radius, pce, n);
<a name="l02977"></a>02977             t1 = 0.999f;
<a name="l02978"></a>02978             d1 = 0.f;
<a name="l02979"></a>02979 
<a name="l02980"></a>02980             <span class="keywordflow">continue</span>;
<a name="l02981"></a>02981         }
<a name="l02982"></a>02982         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iter == 1 &amp;&amp; (t1 &lt; -COLLISION_ZERO || t1 &gt; 1.f))
<a name="l02983"></a>02983             <span class="keywordflow">return</span> -1.f;
<a name="l02984"></a>02984 
<a name="l02985"></a>02985         <span class="keywordflow">if</span> (d1 &lt;= COLLISION_ZERO &amp;&amp; d1 &gt;= -<a class="code" href="../../df/d40/particle__system_8c.html#a1a344e1c05c0e648af3265ce29e39331">COLLISION_ZERO</a>) {
<a name="l02986"></a>02986             <span class="keywordflow">if</span> (t1 &gt;= -<a class="code" href="../../df/d40/particle__system_8c.html#a1a344e1c05c0e648af3265ce29e39331">COLLISION_ZERO</a> &amp;&amp; t1 &lt;= 1.f) {
<a name="l02987"></a>02987                 <span class="keywordflow">if</span> (distance_func == <a class="code" href="../../df/d40/particle__system_8c.html#a78bd26ab1f7e45bcb25322e331a2e96d">nr_signed_distance_to_plane</a>)
<a name="l02988"></a>02988                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, n);
<a name="l02989"></a>02989 
<a name="l02990"></a>02990                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(t1, 0.f, 1.f);
<a name="l02991"></a>02991 
<a name="l02992"></a>02992                 <span class="keywordflow">return</span> t1;
<a name="l02993"></a>02993             }
<a name="l02994"></a>02994             <span class="keywordflow">else</span>
<a name="l02995"></a>02995                 <span class="keywordflow">return</span> -1.f;
<a name="l02996"></a>02996         }
<a name="l02997"></a>02997     }
<a name="l02998"></a>02998     <span class="keywordflow">return</span> -1.0;
<a name="l02999"></a>02999 }
<a name="l03000"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae3bec76eb0969edf30a5d8def2d25035">03000</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ae3bec76eb0969edf30a5d8def2d25035">collision_sphere_to_tri</a>(<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *t)
<a name="l03001"></a>03001 {
<a name="l03002"></a>03002     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *result = &amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>;
<a name="l03003"></a>03003     <span class="keywordtype">float</span> ct, u, v;
<a name="l03004"></a>03004 
<a name="l03005"></a>03005     pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#afc8413d3a600f43ce323285d76d2ccb6">inv_nor</a> = -1;
<a name="l03006"></a>03006     pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 0;
<a name="l03007"></a>03007 
<a name="l03008"></a>03008     ct = <a class="code" href="../../df/d40/particle__system_8c.html#a25e7bb9c7c68317610b1df6af4c42f44">collision_newton_rhapson</a>(col, radius, pce, <a class="code" href="../../df/d40/particle__system_8c.html#a78bd26ab1f7e45bcb25322e331a2e96d">nr_signed_distance_to_plane</a>);
<a name="l03009"></a>03009 
<a name="l03010"></a>03010     <span class="keywordflow">if</span> (ct &gt;= 0.f &amp;&amp; ct &lt; *t &amp;&amp; (result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a>==0 || pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a>==1) ) {
<a name="l03011"></a>03011         <span class="keywordtype">float</span> e1[3], e2[3], p0[3];
<a name="l03012"></a>03012         <span class="keywordtype">float</span> e1e1, e1e2, e1p0, e2e2, e2p0, inv;
<a name="l03013"></a>03013 
<a name="l03014"></a>03014         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03015"></a>03015         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a3b27a6eb87d4837c6698bb11489f4807">x2</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03016"></a>03016         <span class="comment">/* XXX: add radius correction here? */</span>
<a name="l03017"></a>03017         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(p0, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03018"></a>03018 
<a name="l03019"></a>03019         e1e1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e1);
<a name="l03020"></a>03020         e1e2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e2);
<a name="l03021"></a>03021         e1p0 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p0);
<a name="l03022"></a>03022         e2e2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, e2);
<a name="l03023"></a>03023         e2p0 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, p0);
<a name="l03024"></a>03024 
<a name="l03025"></a>03025         inv = 1.f/(e1e1 * e2e2 - e1e2 * e1e2);
<a name="l03026"></a>03026         u = (e2e2 * e1p0 - e1e2 * e2p0) * inv;
<a name="l03027"></a>03027         v = (e1e1 * e2p0 - e1e2 * e1p0) * inv;
<a name="l03028"></a>03028 
<a name="l03029"></a>03029         <span class="keywordflow">if</span> (u&gt;=0.f &amp;&amp; u&lt;=1.f &amp;&amp; v&gt;=0.f &amp;&amp; u+v&lt;=1.f) {
<a name="l03030"></a>03030             *result = *pce;
<a name="l03031"></a>03031 
<a name="l03032"></a>03032             <span class="comment">/* normal already calculated in pce */</span>
<a name="l03033"></a>03033 
<a name="l03034"></a>03034             result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[0] = u;
<a name="l03035"></a>03035             result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[1] = v;
<a name="l03036"></a>03036 
<a name="l03037"></a>03037             *t = ct;
<a name="l03038"></a>03038             <span class="keywordflow">return</span> 1;
<a name="l03039"></a>03039         }
<a name="l03040"></a>03040     }
<a name="l03041"></a>03041     <span class="keywordflow">return</span> 0;
<a name="l03042"></a>03042 }
<a name="l03043"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad485d8d04d59cb4b9b205117546dae7f">03043</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ad485d8d04d59cb4b9b205117546dae7f">collision_sphere_to_edges</a>(<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *t)
<a name="l03044"></a>03044 {
<a name="l03045"></a>03045     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> edge[3], *cur = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *hit = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03046"></a>03046     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *result = &amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>;
<a name="l03047"></a>03047 
<a name="l03048"></a>03048     <span class="keywordtype">float</span> ct;
<a name="l03049"></a>03049     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03050"></a>03050 
<a name="l03051"></a>03051     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l03052"></a>03052         <span class="comment">/* in case of a quad, no need to check &quot;edge&quot; that goes through face twice */</span>
<a name="l03053"></a>03053         <span class="keywordflow">if</span> ((pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[3] &amp;&amp; i==2))
<a name="l03054"></a>03054             <span class="keywordflow">continue</span>;
<a name="l03055"></a>03055 
<a name="l03056"></a>03056         cur = edge+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03057"></a>03057         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[0] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[1] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[(i+1)%3];
<a name="l03058"></a>03058         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[1] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[(i+1)%3];
<a name="l03059"></a>03059         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> = 2;
<a name="l03060"></a>03060         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 0;
<a name="l03061"></a>03061 
<a name="l03062"></a>03062         ct = <a class="code" href="../../df/d40/particle__system_8c.html#a25e7bb9c7c68317610b1df6af4c42f44">collision_newton_rhapson</a>(col, radius, cur, <a class="code" href="../../df/d40/particle__system_8c.html#a22181ac9986881b5a8abe41284be3da3">nr_distance_to_edge</a>);
<a name="l03063"></a>03063 
<a name="l03064"></a>03064         <span class="keywordflow">if</span> (ct &gt;= 0.f &amp;&amp; ct &lt; *t) {
<a name="l03065"></a>03065             <span class="keywordtype">float</span> u, e[3], vec[3];
<a name="l03066"></a>03066 
<a name="l03067"></a>03067             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a319604b013d57a9ac1a1a238127e048c">x1</a>, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03068"></a>03068             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03069"></a>03069             u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, e) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e, e);
<a name="l03070"></a>03070 
<a name="l03071"></a>03071             <span class="keywordflow">if</span> (u &lt; 0.f || u &gt; 1.f)
<a name="l03072"></a>03072                 <span class="keywordflow">break</span>;
<a name="l03073"></a>03073 
<a name="l03074"></a>03074             *result = *cur;
<a name="l03075"></a>03075 
<a name="l03076"></a>03076             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, vec, e, -u);
<a name="l03077"></a>03077             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>);
<a name="l03078"></a>03078 
<a name="l03079"></a>03079             result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a69e4de85dcb5e780c1a812201eda0007">uv</a>[0] = u;
<a name="l03080"></a>03080 
<a name="l03081"></a>03081             
<a name="l03082"></a>03082             hit = cur;
<a name="l03083"></a>03083             *t = ct;
<a name="l03084"></a>03084         }
<a name="l03085"></a>03085 
<a name="l03086"></a>03086     }
<a name="l03087"></a>03087 
<a name="l03088"></a>03088     <span class="keywordflow">return</span> hit != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03089"></a>03089 }
<a name="l03090"></a><a class="code" href="../../df/d40/particle__system_8c.html#abd344b9282932a32180f7a18566ea156">03090</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#abd344b9282932a32180f7a18566ea156">collision_sphere_to_verts</a>(<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <span class="keywordtype">float</span> radius, <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce, <span class="keywordtype">float</span> *t)
<a name="l03091"></a>03091 {
<a name="l03092"></a>03092     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> vert[3], *cur = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *hit = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03093"></a>03093     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *result = &amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>;
<a name="l03094"></a>03094 
<a name="l03095"></a>03095     <span class="keywordtype">float</span> ct;
<a name="l03096"></a>03096     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03097"></a>03097 
<a name="l03098"></a>03098     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l03099"></a>03099         <span class="comment">/* in case of quad, only check one vert the first time */</span>
<a name="l03100"></a>03100         <span class="keywordflow">if</span> (pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[3] &amp;&amp; i != 1)
<a name="l03101"></a>03101             <span class="keywordflow">continue</span>;
<a name="l03102"></a>03102 
<a name="l03103"></a>03103         cur = vert+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03104"></a>03104         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[0] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l03105"></a>03105         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0] = pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l03106"></a>03106         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> = 1;
<a name="l03107"></a>03107         cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 0;
<a name="l03108"></a>03108 
<a name="l03109"></a>03109         ct = <a class="code" href="../../df/d40/particle__system_8c.html#a25e7bb9c7c68317610b1df6af4c42f44">collision_newton_rhapson</a>(col, radius, cur, <a class="code" href="../../df/d40/particle__system_8c.html#a095441914230c5e60199fb5e8e4cc22f">nr_distance_to_vert</a>);
<a name="l03110"></a>03110         
<a name="l03111"></a>03111         <span class="keywordflow">if</span> (ct &gt;= 0.f &amp;&amp; ct &lt; *t) {
<a name="l03112"></a>03112             *result = *cur;
<a name="l03113"></a>03113 
<a name="l03114"></a>03114             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a7513d05b5006470c0028b007b8031422">p</a>, cur-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ade11e646d6f177d88253162f9e197dc7">x0</a>);
<a name="l03115"></a>03115             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(result-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>);
<a name="l03116"></a>03116 
<a name="l03117"></a>03117             hit = cur;
<a name="l03118"></a>03118             *t = ct;
<a name="l03119"></a>03119         }
<a name="l03120"></a>03120 
<a name="l03121"></a>03121     }
<a name="l03122"></a>03122 
<a name="l03123"></a>03123     <span class="keywordflow">return</span> hit != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03124"></a>03124 }
<a name="l03125"></a>03125 <span class="comment">/* Callback for BVHTree near test */</span>
<a name="l03126"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae5312f3e844885739896372f7f706d68">03126</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a76dd9c3170dd43a33e113d7ce86f4aba">BKE_psys_collision_neartest_cb</a>(<span class="keywordtype">void</span> *userdata, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <a class="code" href="../../d5/d6e/structBVHTreeRay.html">BVHTreeRay</a> *ray, <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> *hit)
<a name="l03127"></a>03127 {
<a name="l03128"></a>03128     <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col = (<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *) userdata;
<a name="l03129"></a>03129     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> pce;
<a name="l03130"></a>03130     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *face = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#aa4d0e546bf8ad244b27c5336856a12fa">mfaces</a> + index;
<a name="l03131"></a>03131     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *x = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a38b250a905edd916a73390802ba4f68f">x</a>;
<a name="l03132"></a>03132     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a4c18ca9f89cedb3253e359b0608e9dc1">current_v</a>;
<a name="l03133"></a>03133     <span class="keywordtype">float</span> t = hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>/col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a6571885f4eed9a02464596aa983ee366">original_ray_length</a>;
<a name="l03134"></a>03134     <span class="keywordtype">int</span> collision = 0;
<a name="l03135"></a>03135 
<a name="l03136"></a>03136     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[0] = x[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03137"></a>03137     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[1] = x[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03138"></a>03138     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[2] = x[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03139"></a>03139     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[3] = face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? x[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03140"></a>03140 
<a name="l03141"></a>03141     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[0] = v[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03142"></a>03142     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[1] = v[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03143"></a>03143     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[2] = v[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l03144"></a>03144     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[3] = face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? v[face-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03145"></a>03145 
<a name="l03146"></a>03146     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> = 3;
<a name="l03147"></a>03147     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 0;
<a name="l03148"></a>03148     pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a6f76850c5020611eac08ac63d9727ebb">index</a> = index;
<a name="l03149"></a>03149 
<a name="l03150"></a>03150     <span class="comment">/* don&#39;t collide with same face again */</span>
<a name="l03151"></a>03151     <span class="keywordflow">if</span> (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aeec4fbbe65e8f2796a19e1a2d5f4529f">hit</a> == col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7bde798ebcee4939957d7e4fa10408e7">current</a> &amp;&amp; col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a6f76850c5020611eac08ac63d9727ebb">index</a> == index &amp;&amp; col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aaa32d8389e0e59a8b3406b0c35a5fb34">tot</a> == 3)
<a name="l03152"></a>03152         <span class="keywordflow">return</span>;
<a name="l03153"></a>03153 
<a name="l03154"></a>03154     <span class="keywordflow">do</span>
<a name="l03155"></a>03155     {   
<a name="l03156"></a>03156         collision = <a class="code" href="../../df/d40/particle__system_8c.html#ae3bec76eb0969edf30a5d8def2d25035">collision_sphere_to_tri</a>(col, ray-&gt;<a class="code" href="../../d5/d6e/structBVHTreeRay.html#af4cab8f21186d8c2d189acf2b69a1d02">radius</a>, &amp;pce, &amp;t);
<a name="l03157"></a>03157         <span class="keywordflow">if</span> (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> == 0) {
<a name="l03158"></a>03158             collision += <a class="code" href="../../df/d40/particle__system_8c.html#ad485d8d04d59cb4b9b205117546dae7f">collision_sphere_to_edges</a>(col, ray-&gt;<a class="code" href="../../d5/d6e/structBVHTreeRay.html#af4cab8f21186d8c2d189acf2b69a1d02">radius</a>, &amp;pce, &amp;t);
<a name="l03159"></a>03159             collision += <a class="code" href="../../df/d40/particle__system_8c.html#abd344b9282932a32180f7a18566ea156">collision_sphere_to_verts</a>(col, ray-&gt;<a class="code" href="../../d5/d6e/structBVHTreeRay.html#af4cab8f21186d8c2d189acf2b69a1d02">radius</a>, &amp;pce, &amp;t);
<a name="l03160"></a>03160         }
<a name="l03161"></a>03161 
<a name="l03162"></a>03162         <span class="keywordflow">if</span> (collision) {
<a name="l03163"></a>03163             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a6571885f4eed9a02464596aa983ee366">original_ray_length</a> * t;
<a name="l03164"></a>03164             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = index;
<a name="l03165"></a>03165                 
<a name="l03166"></a>03166             <a class="code" href="../../df/d40/particle__system_8c.html#ae43df2978b543fa6ebd1b3e47a2a333d">collision_point_velocity</a>(&amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>);
<a name="l03167"></a>03167 
<a name="l03168"></a>03168             col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aeec4fbbe65e8f2796a19e1a2d5f4529f">hit</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7bde798ebcee4939957d7e4fa10408e7">current</a>;
<a name="l03169"></a>03169         }
<a name="l03170"></a>03170 
<a name="l03171"></a>03171         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[1] = pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[2];
<a name="l03172"></a>03172         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[2] = pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[3];
<a name="l03173"></a>03173         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03174"></a>03174 
<a name="l03175"></a>03175         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[1] = pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[2];
<a name="l03176"></a>03176         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[2] = pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[3];
<a name="l03177"></a>03177         pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a0ce5977d702494db3670e50ee5279a31">v</a>[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03178"></a>03178 
<a name="l03179"></a>03179     } <span class="keywordflow">while</span> (pce.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#aeb53fe3ef95c38fa49abc29bc369a3fc">x</a>[2]);
<a name="l03180"></a>03180 }
<a name="l03181"></a><a class="code" href="../../df/d40/particle__system_8c.html#af0f1ee738e16c310b78174a8704d376e">03181</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#af0f1ee738e16c310b78174a8704d376e">collision_detect</a>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> *hit, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *colliders)
<a name="l03182"></a>03182 {
<a name="l03183"></a>03183     <a class="code" href="../../d7/d85/structColliderCache.html">ColliderCache</a> *coll;
<a name="l03184"></a>03184     <span class="keywordtype">float</span> ray_dir[3];
<a name="l03185"></a>03185 
<a name="l03186"></a>03186     <span class="keywordflow">if</span> (colliders-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03187"></a>03187         <span class="keywordflow">return</span> 0;
<a name="l03188"></a>03188 
<a name="l03189"></a>03189     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(ray_dir, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>);
<a name="l03190"></a>03190     hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = -1;
<a name="l03191"></a>03191     hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a6571885f4eed9a02464596aa983ee366">original_ray_length</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(ray_dir);
<a name="l03192"></a>03192     col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#ace709219a43e56ffec4a270f23c615fc">inside</a> = 0;
<a name="l03193"></a>03193 
<a name="l03194"></a>03194     <span class="comment">/* even if particle is stationary we want to check for moving colliders */</span>
<a name="l03195"></a>03195     <span class="comment">/* if hit.dist is zero the bvhtree_ray_cast will just ignore everything */</span>
<a name="l03196"></a>03196     <span class="keywordflow">if</span> (hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> == 0.0f)
<a name="l03197"></a>03197         hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a6571885f4eed9a02464596aa983ee366">original_ray_length</a> = 0.000001f;
<a name="l03198"></a>03198 
<a name="l03199"></a>03199     <span class="keywordflow">for</span> (coll = colliders-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; coll; coll=coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#ae6807bf10c556470545dd4044350be64">next</a>) {
<a name="l03200"></a>03200         <span class="comment">/* for boids: don&#39;t check with current ground object */</span>
<a name="l03201"></a>03201         <span class="keywordflow">if</span> (coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#a6a3c50558d09e5c9e70c1a963b6d0703">ob</a> == col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a5b6c097fa6066c90a8f3a3c34d281ab9">skip</a>)
<a name="l03202"></a>03202             <span class="keywordflow">continue</span>;
<a name="l03203"></a>03203 
<a name="l03204"></a>03204         <span class="comment">/* particles should not collide with emitter at birth */</span>
<a name="l03205"></a>03205         <span class="keywordflow">if</span> (coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#a6a3c50558d09e5c9e70c1a963b6d0703">ob</a> == col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aea3d859dc835b9fe96a0ac30d0d9553c">emitter</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &lt; col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7a1f5542b03144458de97b989dc0fe4a">cfra</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &gt;= col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#af08e43a3dce30ce08562436a05330d9f">old_cfra</a>)
<a name="l03206"></a>03206             <span class="keywordflow">continue</span>;
<a name="l03207"></a>03207 
<a name="l03208"></a>03208         col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7bde798ebcee4939957d7e4fa10408e7">current</a> = coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#a6a3c50558d09e5c9e70c1a963b6d0703">ob</a>;
<a name="l03209"></a>03209         col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a> = coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>;
<a name="l03210"></a>03210         col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a4f1fe5055cbee62b90b77c0ecfab9396">fac1</a> = (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#af08e43a3dce30ce08562436a05330d9f">old_cfra</a> - coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a0be4c6b05aef14ea7dc015b1741be347">time_x</a>) / (coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a782c22f53bbf2eb474353f8e4b8736af">time_xnew</a> - coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a0be4c6b05aef14ea7dc015b1741be347">time_x</a>);
<a name="l03211"></a>03211         col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#adc06ac4c1c894982d8e6e7f0588ccedc">fac2</a> = (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7a1f5542b03144458de97b989dc0fe4a">cfra</a> - coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a0be4c6b05aef14ea7dc015b1741be347">time_x</a>) / (coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a782c22f53bbf2eb474353f8e4b8736af">time_xnew</a> - coll-&gt;<a class="code" href="../../d7/d85/structColliderCache.html#abfdb93d2d3e379c739d01cb50361c695">collmd</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a0be4c6b05aef14ea7dc015b1741be347">time_x</a>);
<a name="l03212"></a>03212 
<a name="l03213"></a>03213         <span class="keywordflow">if</span> (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a> &amp;&amp; col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a239507a70644d0438b50d1969f744aac">bvhtree</a>)
<a name="l03214"></a>03214             <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a961a896017037e95a717e06943983f44">BLI_bvhtree_ray_cast</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada88b63af07b546fbda149a08ea9fc8a">md</a>-&gt;<a class="code" href="../../d7/d2f/structCollisionModifierData.html#a239507a70644d0438b50d1969f744aac">bvhtree</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, ray_dir, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a>, hit, <a class="code" href="../../db/dca/BKE__particle_8h.html#a76dd9c3170dd43a33e113d7ce86f4aba">BKE_psys_collision_neartest_cb</a>, col);
<a name="l03215"></a>03215     }
<a name="l03216"></a>03216 
<a name="l03217"></a>03217     <span class="keywordflow">return</span> hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> &gt;= 0;
<a name="l03218"></a>03218 }
<a name="l03219"></a><a class="code" href="../../df/d40/particle__system_8c.html#ad5673ff4e3163cd7423de5cafa3013a2">03219</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ad5673ff4e3163cd7423de5cafa3013a2">collision_response</a>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col, <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> *hit, <span class="keywordtype">int</span> kill, <span class="keywordtype">int</span> dynamic_rotation)
<a name="l03220"></a>03220 {
<a name="l03221"></a>03221     <a class="code" href="../../d4/dbd/structParticleCollisionElement.html">ParticleCollisionElement</a> *pce = &amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>;
<a name="l03222"></a>03222     <a class="code" href="../../d3/d76/structPartDeflect.html">PartDeflect</a> *pd = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aeec4fbbe65e8f2796a19e1a2d5f4529f">hit</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a5af3210d70b057f538ce36c033548836">pd</a>;
<a name="l03223"></a>03223     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];                                        <span class="comment">/* point of collision */</span>
<a name="l03224"></a>03224     <span class="keywordtype">float</span> x = hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>/col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a6571885f4eed9a02464596aa983ee366">original_ray_length</a>;       <span class="comment">/* location factor of collision between this iteration */</span>
<a name="l03225"></a>03225     <span class="keywordtype">float</span> f = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a> + x * (1.0f - col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a>);             <span class="comment">/* time factor of collision between timestep */</span>
<a name="l03226"></a>03226     <span class="keywordtype">float</span> dt1 = (f - col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a>) * col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a90314684f64dbbe09361738d47c55520">total_time</a>;         <span class="comment">/* time since previous collision (in seconds) */</span>
<a name="l03227"></a>03227     <span class="keywordtype">float</span> dt2 = (1.0f - f) * col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a90314684f64dbbe09361738d47c55520">total_time</a>;           <span class="comment">/* time left after collision (in seconds) */</span>
<a name="l03228"></a>03228     <span class="keywordtype">int</span> through = (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>() &lt; pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a64857a451c15c5f91590cb58871bba05">pdef_perm</a>) ? 1 : 0; <span class="comment">/* did particle pass through the collision surface? */</span>
<a name="l03229"></a>03229 
<a name="l03230"></a>03230     <span class="comment">/* calculate exact collision location */</span>
<a name="l03231"></a>03231     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(co, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, x);
<a name="l03232"></a>03232 
<a name="l03233"></a>03233     <span class="comment">/* particle dies in collision */</span>
<a name="l03234"></a>03234     <span class="keywordflow">if</span> (through == 0 &amp;&amp; (kill || pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a08a03fcfb909ede71b162d30462fed29">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#acdadd1cf42d3cbd87cefc982a1004d94">PDEFLE_KILL_PART</a>)) {
<a name="l03235"></a>03235         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae5a5904ec37e02a0b91b53d172d0849d">PARS_DYING</a>;
<a name="l03236"></a>03236         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#af08e43a3dce30ce08562436a05330d9f">old_cfra</a> + (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7a1f5542b03144458de97b989dc0fe4a">cfra</a> - col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#af08e43a3dce30ce08562436a05330d9f">old_cfra</a>) * f;
<a name="l03237"></a>03237 
<a name="l03238"></a>03238         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, co);
<a name="l03239"></a>03239         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, f);
<a name="l03240"></a>03240         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aabc8b501c8bcfe8a37ecfc39661b07d9">interp_qt_qtqt</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, f);
<a name="l03241"></a>03241         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, f);
<a name="l03242"></a>03242 
<a name="l03243"></a>03243         <span class="comment">/* particle is dead so we don&#39;t need to calculate further */</span>
<a name="l03244"></a>03244         <span class="keywordflow">return</span> 0;
<a name="l03245"></a>03245     }
<a name="l03246"></a>03246     <span class="comment">/* figure out velocity and other data after collision */</span>
<a name="l03247"></a>03247     <span class="keywordflow">else</span> {
<a name="l03248"></a>03248         <span class="keywordtype">float</span> v0[3];    <span class="comment">/* velocity directly before collision to be modified into velocity directly after collision */</span>
<a name="l03249"></a>03249         <span class="keywordtype">float</span> v0_nor[3];<span class="comment">/* normal component of v0 */</span>
<a name="l03250"></a>03250         <span class="keywordtype">float</span> v0_tan[3];<span class="comment">/* tangential component of v0 */</span>
<a name="l03251"></a>03251         <span class="keywordtype">float</span> vc_tan[3];<span class="comment">/* tangential component of collision surface velocity */</span>
<a name="l03252"></a>03252         <span class="keywordtype">float</span> v0_dot, vc_dot;
<a name="l03253"></a>03253         <span class="keywordtype">float</span> damp = pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#ac23261a0a94a953aa363a0e7f6b14b70">pdef_damp</a> + pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a1fdea77f9ab1036e1145a41622f630d8">pdef_rdamp</a> * 2 * (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>() - 0.5f);
<a name="l03254"></a>03254         <span class="keywordtype">float</span> frict = pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a2c3a194405b2c0b5f1dace7c5d024676">pdef_frict</a> + pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a3aca54d230be4a6b9dd5c8f214c4ffc0">pdef_rfrict</a> * 2 * (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>() - 0.5f);
<a name="l03255"></a>03255         <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>, nor[3], <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>;
<a name="l03256"></a>03256 
<a name="l03257"></a>03257         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(damp,0.0f, 1.0f);
<a name="l03258"></a>03258         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(frict,0.0f, 1.0f);
<a name="l03259"></a>03259 
<a name="l03260"></a>03260         <span class="comment">/* get exact velocity right before collision */</span>
<a name="l03261"></a>03261         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(v0, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a87ba2a24cd1dbf6fd593f1934be936a0">ve1</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a731c24684326a3365d76274c287f34">acc</a>, dt1);
<a name="l03262"></a>03262                 
<a name="l03263"></a>03263         <span class="comment">/* convert collider velocity from 1/framestep to 1/s TODO: here we assume 1 frame step for collision modifier */</span>
<a name="l03264"></a>03264         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aa8baf8772b4873fa2466bde2bd32ee3a">inv_timestep</a>);
<a name="l03265"></a>03265 
<a name="l03266"></a>03266         <span class="comment">/* calculate tangential particle velocity */</span>
<a name="l03267"></a>03267         v0_dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, v0);
<a name="l03268"></a>03268         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(v0_tan, v0, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, -v0_dot);
<a name="l03269"></a>03269 
<a name="l03270"></a>03270         <span class="comment">/* calculate tangential collider velocity */</span>
<a name="l03271"></a>03271         vc_dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>);
<a name="l03272"></a>03272         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(vc_tan, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, -vc_dot);
<a name="l03273"></a>03273 
<a name="l03274"></a>03274         <span class="comment">/* handle friction effects (tangential and angular velocity) */</span>
<a name="l03275"></a>03275         <span class="keywordflow">if</span> (frict &gt; 0.0f) {
<a name="l03276"></a>03276             <span class="comment">/* angular &lt;-&gt; linear velocity */</span>
<a name="l03277"></a>03277             <span class="keywordflow">if</span> (dynamic_rotation) {
<a name="l03278"></a>03278                 <span class="keywordtype">float</span> vr_tan[3], v1_tan[3], ave[3];
<a name="l03279"></a>03279                     
<a name="l03280"></a>03280                 <span class="comment">/* linear velocity of particle surface */</span>
<a name="l03281"></a>03281                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vr_tan, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l03282"></a>03282                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vr_tan, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>);
<a name="l03283"></a>03283 
<a name="l03284"></a>03284                 <span class="comment">/* change to coordinates that move with the collision plane */</span>
<a name="l03285"></a>03285                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1_tan, v0_tan, vc_tan);
<a name="l03286"></a>03286                         
<a name="l03287"></a>03287                 <span class="comment">/* The resulting velocity is a weighted average of particle cm &amp; surface</span>
<a name="l03288"></a>03288 <span class="comment">                 * velocity. This weight (related to particle&#39;s moment of inertia) could</span>
<a name="l03289"></a>03289 <span class="comment">                 * be made a parameter for angular &lt;-&gt; linear conversion.</span>
<a name="l03290"></a>03290 <span class="comment">                 */</span>
<a name="l03291"></a>03291                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(v1_tan, vr_tan, -0.4);
<a name="l03292"></a>03292                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(v1_tan, 1.0f/1.4f); <span class="comment">/* 1/(1+0.4) */</span>
<a name="l03293"></a>03293 
<a name="l03294"></a>03294                 <span class="comment">/* rolling friction is around 0.01 of sliding friction (could be made a parameter) */</span>
<a name="l03295"></a>03295                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(v1_tan, 1.0f - 0.01f * frict);
<a name="l03296"></a>03296 
<a name="l03297"></a>03297                 <span class="comment">/* surface_velocity is opposite to cm velocity */</span>
<a name="l03298"></a>03298                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(vr_tan, v1_tan);
<a name="l03299"></a>03299 
<a name="l03300"></a>03300                 <span class="comment">/* get back to global coordinates */</span>
<a name="l03301"></a>03301                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v1_tan, vc_tan);
<a name="l03302"></a>03302 
<a name="l03303"></a>03303                 <span class="comment">/* convert to angular velocity*/</span>
<a name="l03304"></a>03304                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ave, vr_tan, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>);
<a name="l03305"></a>03305                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ave, 1.0f/<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>, 0.001f));
<a name="l03306"></a>03306 
<a name="l03307"></a>03307                 <span class="comment">/* only friction will cause change in linear &amp; angular velocity */</span>
<a name="l03308"></a>03308                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>, ave, frict);
<a name="l03309"></a>03309                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(v0_tan, v0_tan, v1_tan, frict);
<a name="l03310"></a>03310             }
<a name="l03311"></a>03311             <span class="keywordflow">else</span> {
<a name="l03312"></a>03312                 <span class="comment">/* just basic friction (unphysical due to the friction model used in Blender) */</span>
<a name="l03313"></a>03313                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(v0_tan, v0_tan, vc_tan, frict);
<a name="l03314"></a>03314             }
<a name="l03315"></a>03315         }
<a name="l03316"></a>03316 
<a name="l03317"></a>03317         <span class="comment">/* stickness was possibly added before, so cancel that before calculating new normal velocity */</span>
<a name="l03318"></a>03318         <span class="comment">/* otherwise particles go flying out of the surface because of high reversed sticky velocity */</span>
<a name="l03319"></a>03319         <span class="keywordflow">if</span> (v0_dot &lt; 0.0f) {
<a name="l03320"></a>03320             v0_dot += pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a377ea7b3e3da5c0833f23b92945ce177">pdef_stickness</a>;
<a name="l03321"></a>03321             <span class="keywordflow">if</span> (v0_dot &gt; 0.0f)
<a name="l03322"></a>03322                 v0_dot = 0.0f;
<a name="l03323"></a>03323         }
<a name="l03324"></a>03324 
<a name="l03325"></a>03325         <span class="comment">/* damping and flipping of velocity around normal */</span>
<a name="l03326"></a>03326         v0_dot *= 1.0f - damp;
<a name="l03327"></a>03327         vc_dot *= through ? damp : 1.0f;
<a name="l03328"></a>03328 
<a name="l03329"></a>03329         <span class="comment">/* calculate normal particle velocity */</span>
<a name="l03330"></a>03330         <span class="comment">/* special case for object hitting the particle from behind */</span>
<a name="l03331"></a>03331         <span class="keywordflow">if</span> (through==0 &amp;&amp; ((vc_dot&gt;0.0f &amp;&amp; v0_dot&gt;0.0f &amp;&amp; vc_dot&gt;v0_dot) || (vc_dot&lt;0.0f &amp;&amp; v0_dot&lt;0.0f &amp;&amp; vc_dot&lt;v0_dot)))
<a name="l03332"></a>03332             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(v0_nor, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, vc_dot);
<a name="l03333"></a>03333         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v0_dot &gt; 0.f)
<a name="l03334"></a>03334             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(v0_nor, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, vc_dot + (through ? -1.0f : 1.0f) * v0_dot);
<a name="l03335"></a>03335         <span class="keywordflow">else</span>
<a name="l03336"></a>03336             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(v0_nor, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, vc_dot + (through ? 1.0f : -1.0f) * v0_dot);
<a name="l03337"></a>03337 
<a name="l03338"></a>03338         <span class="comment">/* combine components together again */</span>
<a name="l03339"></a>03339         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(v0, v0_nor, v0_tan);
<a name="l03340"></a>03340 
<a name="l03341"></a>03341         <span class="keywordflow">if</span> (col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ac68921bdaac896f1cde40dfcb0c574a0">boid</a>) {
<a name="l03342"></a>03342             <span class="comment">/* keep boids above ground */</span>
<a name="l03343"></a>03343             <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *bpa = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>;
<a name="l03344"></a>03344             <span class="keywordflow">if</span> (bpa-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>.<a class="code" href="../../d6/de4/structBoidData.html#aa6e9ec5ae35d37d8eaeb2030269a5a13">mode</a> == <a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a67b995c918295f7eebf7d4f722d0d33ca0f0551172300fc27ce79a155fd5df5dd">eBoidMode_OnLand</a> || co[2] &lt;= col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a1e6f60ea45cdcbd745346c4a3b99f74f">boid_z</a>) {
<a name="l03345"></a>03345                 co[2] = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a1e6f60ea45cdcbd745346c4a3b99f74f">boid_z</a>;
<a name="l03346"></a>03346                 v0[2] = 0.0f;
<a name="l03347"></a>03347             }
<a name="l03348"></a>03348         }
<a name="l03349"></a>03349         
<a name="l03350"></a>03350         <span class="comment">/* re-apply acceleration to final location and velocity */</span>
<a name="l03351"></a>03351         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, co, v0, dt2);
<a name="l03352"></a>03352         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a731c24684326a3365d76274c287f34">acc</a>, 0.5f*dt2*dt2);
<a name="l03353"></a>03353         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, v0, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a731c24684326a3365d76274c287f34">acc</a>, dt2);
<a name="l03354"></a>03354 
<a name="l03355"></a>03355         <span class="comment">/* make sure particle stays on the right side of the surface */</span>
<a name="l03356"></a>03356         <span class="keywordflow">if</span> (!through) {
<a name="l03357"></a>03357             distance = <a class="code" href="../../df/d40/particle__system_8c.html#a11f7e36239548efe4287e74d5d220554">collision_point_distance_with_normal</a>(co, pce, -1.f, col, nor);
<a name="l03358"></a>03358             
<a name="l03359"></a>03359             <span class="keywordflow">if</span> (distance &lt; col-&gt;radius + <a class="code" href="../../df/d40/particle__system_8c.html#afff275792de68f639084d96ae3d08d7c">COLLISION_MIN_DISTANCE</a>)
<a name="l03360"></a>03360                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, nor, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a> + <a class="code" href="../../df/d40/particle__system_8c.html#afff275792de68f639084d96ae3d08d7c">COLLISION_MIN_DISTANCE</a> - distance);
<a name="l03361"></a>03361 
<a name="l03362"></a>03362             dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, v0);
<a name="l03363"></a>03363             <span class="keywordflow">if</span> (dot &lt; 0.f)
<a name="l03364"></a>03364                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(v0, nor, -dot);
<a name="l03365"></a>03365 
<a name="l03366"></a>03366             distance = <a class="code" href="../../df/d40/particle__system_8c.html#a11f7e36239548efe4287e74d5d220554">collision_point_distance_with_normal</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pce, 1.f, col, nor);
<a name="l03367"></a>03367 
<a name="l03368"></a>03368             <span class="keywordflow">if</span> (distance &lt; col-&gt;radius + <a class="code" href="../../df/d40/particle__system_8c.html#afff275792de68f639084d96ae3d08d7c">COLLISION_MIN_DISTANCE</a>)
<a name="l03369"></a>03369                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, nor, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a> + <a class="code" href="../../df/d40/particle__system_8c.html#afff275792de68f639084d96ae3d08d7c">COLLISION_MIN_DISTANCE</a> - distance);
<a name="l03370"></a>03370 
<a name="l03371"></a>03371             dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l03372"></a>03372             <span class="keywordflow">if</span> (dot &lt; 0.f)
<a name="l03373"></a>03373                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, nor, -dot);
<a name="l03374"></a>03374         }
<a name="l03375"></a>03375 
<a name="l03376"></a>03376         <span class="comment">/* add stickness to surface */</span>
<a name="l03377"></a>03377         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pce-&gt;<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a50b9bb8ba2a4121939f38d46da2c1e77">nor</a>, -pd-&gt;<a class="code" href="../../d3/d76/structPartDeflect.html#a377ea7b3e3da5c0833f23b92945ce177">pdef_stickness</a>);
<a name="l03378"></a>03378 
<a name="l03379"></a>03379         <span class="comment">/* set coordinates for next iteration */</span>
<a name="l03380"></a>03380         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, co);
<a name="l03381"></a>03381         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l03382"></a>03382 
<a name="l03383"></a>03383         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a87ba2a24cd1dbf6fd593f1934be936a0">ve1</a>, v0);
<a name="l03384"></a>03384         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a7266b6cb94b9aa5081f6aa82c0ed2861">ve2</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l03385"></a>03385 
<a name="l03386"></a>03386         col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a> = f;
<a name="l03387"></a>03387     }
<a name="l03388"></a>03388 
<a name="l03389"></a>03389     col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ad6ccdfcb77e7940cff31f42f0f811a45">prev</a> = col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aeec4fbbe65e8f2796a19e1a2d5f4529f">hit</a>;
<a name="l03390"></a>03390     col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a56a7cac81d7eb9b52e1c83c93253c97b">prev_index</a> = hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a>;
<a name="l03391"></a>03391 
<a name="l03392"></a>03392     <span class="keywordflow">return</span> 1;
<a name="l03393"></a>03393 }
<a name="l03394"></a><a class="code" href="../../df/d40/particle__system_8c.html#aabe56d0d0ee556f12eff8b9e4c210359">03394</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aabe56d0d0ee556f12eff8b9e4c210359">collision_fail</a>(<a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa, <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> *col)
<a name="l03395"></a>03395 {
<a name="l03396"></a>03396     <span class="comment">/* final chance to prevent total failure, so stick to the surface and hope for the best */</span>
<a name="l03397"></a>03397     <a class="code" href="../../df/d40/particle__system_8c.html#a78ee9f89a1ba554909a8db1ce8459458">collision_point_on_surface</a>(col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, &amp;col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>, 1.f, col, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l03398"></a>03398 
<a name="l03399"></a>03399     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#ada04933b57ebf6624008d296c5655160">pce</a>.<a class="code" href="../../d4/dbd/structParticleCollisionElement.html#a2290768f672c716b54f36ade6b9c24bb">vel</a>);
<a name="l03400"></a>03400     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, col-&gt;<a class="code" href="../../de/d4d/structParticleCollision.html#aa8baf8772b4873fa2466bde2bd32ee3a">inv_timestep</a>);
<a name="l03401"></a>03401 
<a name="l03402"></a>03402 
<a name="l03403"></a>03403     <span class="comment">/* printf(&quot;max iterations\n&quot;); */</span>
<a name="l03404"></a>03404 }
<a name="l03405"></a>03405 
<a name="l03406"></a>03406 <span class="comment">/* Particle - Mesh collision detection and response</span>
<a name="l03407"></a>03407 <span class="comment"> * Features:</span>
<a name="l03408"></a>03408 <span class="comment"> * -friction and damping</span>
<a name="l03409"></a>03409 <span class="comment"> * -angular momentum &lt;-&gt; linear momentum</span>
<a name="l03410"></a>03410 <span class="comment"> * -high accuracy by re-applying particle acceleration after collision</span>
<a name="l03411"></a>03411 <span class="comment"> * -handles moving, rotating and deforming meshes</span>
<a name="l03412"></a>03412 <span class="comment"> * -uses Newton-Rhapson iteration to find the collisions</span>
<a name="l03413"></a>03413 <span class="comment"> * -handles spherical particles and (nearly) point like particles</span>
<a name="l03414"></a>03414 <span class="comment"> */</span>
<a name="l03415"></a><a class="code" href="../../df/d40/particle__system_8c.html#a9b1485feb4e39e22f4f1c1962aa899a4">03415</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a9b1485feb4e39e22f4f1c1962aa899a4">collision_check</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> p, <span class="keywordtype">float</span> dfra, <span class="keywordtype">float</span> cfra)
<a name="l03416"></a>03416 {
<a name="l03417"></a>03417     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l03418"></a>03418     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l03419"></a>03419     <a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a> col;
<a name="l03420"></a>03420     <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> hit;
<a name="l03421"></a>03421     <span class="keywordtype">int</span> collision_count=0;
<a name="l03422"></a>03422 
<a name="l03423"></a>03423     <span class="keywordtype">float</span> timestep = <a class="code" href="../../db/dca/BKE__particle_8h.html#a75c75a40fcacfa5cb9e05638d6e823ad">psys_get_timestep</a>(sim);
<a name="l03424"></a>03424 
<a name="l03425"></a>03425     memset(&amp;col, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../de/d4d/structParticleCollision.html">ParticleCollision</a>));
<a name="l03426"></a>03426 
<a name="l03427"></a>03427     col.<a class="code" href="../../de/d4d/structParticleCollision.html#a90314684f64dbbe09361738d47c55520">total_time</a> = timestep * dfra;
<a name="l03428"></a>03428     col.<a class="code" href="../../de/d4d/structParticleCollision.html#aa8baf8772b4873fa2466bde2bd32ee3a">inv_timestep</a> = 1.0f/timestep;
<a name="l03429"></a>03429 
<a name="l03430"></a>03430     col.<a class="code" href="../../de/d4d/structParticleCollision.html#a7a1f5542b03144458de97b989dc0fe4a">cfra</a> = cfra;
<a name="l03431"></a>03431     col.<a class="code" href="../../de/d4d/structParticleCollision.html#af08e43a3dce30ce08562436a05330d9f">old_cfra</a> = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>;
<a name="l03432"></a>03432 
<a name="l03433"></a>03433     <span class="comment">/* get acceleration (from gravity, forcefields etc. to be re-applied in collision response) */</span>
<a name="l03434"></a>03434     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a2a731c24684326a3365d76274c287f34">acc</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l03435"></a>03435     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a2a731c24684326a3365d76274c287f34">acc</a>, 1.f/col.<a class="code" href="../../de/d4d/structParticleCollision.html#a90314684f64dbbe09361738d47c55520">total_time</a>);
<a name="l03436"></a>03436 
<a name="l03437"></a>03437     <span class="comment">/* set values for first iteration */</span>
<a name="l03438"></a>03438     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a61dac3f910666960de8a3502eda23cca">co1</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l03439"></a>03439     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a20244f4cb1af080f3fc19f95388b050b">co2</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l03440"></a>03440     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a87ba2a24cd1dbf6fd593f1934be936a0">ve1</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l03441"></a>03441     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col.<a class="code" href="../../de/d4d/structParticleCollision.html#a7266b6cb94b9aa5081f6aa82c0ed2861">ve2</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l03442"></a>03442     col.<a class="code" href="../../de/d4d/structParticleCollision.html#a0d785c7e4830a5b5a8e39506dd37784e">f</a> = 0.0f;
<a name="l03443"></a>03443 
<a name="l03444"></a>03444     col.<a class="code" href="../../de/d4d/structParticleCollision.html#a2a26bf66138ff38d9c5d79eb31251065">radius</a> = ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a08b74db954c57b12925096e1eaec99e2">PART_SIZE_DEFL</a>) || (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>)) ? pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> : <a class="code" href="../../df/d40/particle__system_8c.html#ad646e7c4bd5998b2abcbe0c15c0bbea4">COLLISION_MIN_RADIUS</a>;
<a name="l03445"></a>03445 
<a name="l03446"></a>03446     <span class="comment">/* override for boids */</span>
<a name="l03447"></a>03447     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>-&gt;<a class="code" href="../../dd/d94/structBoidSettings.html#a50025e1d23b52c79591f918db262b014">options</a> &amp; <a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a9d06ba5b54b68601952089be7ce3ae35">BOID_ALLOW_LAND</a>) {
<a name="l03448"></a>03448         col.<a class="code" href="../../de/d4d/structParticleCollision.html#ac68921bdaac896f1cde40dfcb0c574a0">boid</a> = 1;
<a name="l03449"></a>03449         col.<a class="code" href="../../de/d4d/structParticleCollision.html#a1e6f60ea45cdcbd745346c4a3b99f74f">boid_z</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>[2];
<a name="l03450"></a>03450         col.<a class="code" href="../../de/d4d/structParticleCollision.html#a5b6c097fa6066c90a8f3a3c34d281ab9">skip</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a153353b488e3c142563cfa077ff3ea6b">ground</a>;
<a name="l03451"></a>03451     }
<a name="l03452"></a>03452 
<a name="l03453"></a>03453     <span class="comment">/* 10 iterations to catch multiple collisions */</span>
<a name="l03454"></a>03454     <span class="keywordflow">while</span> (collision_count &lt; <a class="code" href="../../df/d40/particle__system_8c.html#a07a352d4fe89db18644bfeb8c634b66f">COLLISION_MAX_COLLISIONS</a>) {
<a name="l03455"></a>03455         <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#af0f1ee738e16c310b78174a8704d376e">collision_detect</a>(pa, &amp;col, &amp;hit, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>)) {
<a name="l03456"></a>03456             
<a name="l03457"></a>03457             collision_count++;
<a name="l03458"></a>03458 
<a name="l03459"></a>03459             <span class="keywordflow">if</span> (collision_count == <a class="code" href="../../df/d40/particle__system_8c.html#a07a352d4fe89db18644bfeb8c634b66f">COLLISION_MAX_COLLISIONS</a>)
<a name="l03460"></a>03460                 <a class="code" href="../../df/d40/particle__system_8c.html#aabe56d0d0ee556f12eff8b9e4c210359">collision_fail</a>(pa, &amp;col);
<a name="l03461"></a>03461             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#ad5673ff4e3163cd7423de5cafa3013a2">collision_response</a>(pa, &amp;col, &amp;hit, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a6c48708e805518d3485fc508fc26bd37">PART_DIE_ON_COL</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad0717fb365b30da8ad2381fd9a688a4c">PART_ROT_DYN</a>)==0)
<a name="l03462"></a>03462                 <span class="keywordflow">return</span>;
<a name="l03463"></a>03463         }
<a name="l03464"></a>03464         <span class="keywordflow">else</span>
<a name="l03465"></a>03465             <span class="keywordflow">return</span>;
<a name="l03466"></a>03466     }
<a name="l03467"></a>03467 }
<a name="l03468"></a>03468 <span class="comment">/************************************************/</span>
<a name="l03469"></a>03469 <span class="comment">/*          Hair                                */</span>
<a name="l03470"></a>03470 <span class="comment">/************************************************/</span>
<a name="l03471"></a>03471 <span class="comment">/* check if path cache or children need updating and do it if needed */</span>
<a name="l03472"></a><a class="code" href="../../df/d40/particle__system_8c.html#af211e7a44c8a798b553ed08bc9045f5b">03472</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#af211e7a44c8a798b553ed08bc9045f5b">psys_update_path_cache</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> cfra)
<a name="l03473"></a>03473 {
<a name="l03474"></a>03474     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l03475"></a>03475     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l03476"></a>03476     <a class="code" href="../../df/db7/structParticleEditSettings.html">ParticleEditSettings</a> *pset = &amp;sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a931875e2d55fef9de65c777431a94f31">particle</a>;
<a name="l03477"></a>03477     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l03478"></a>03478     <span class="keywordtype">int</span> distr=0, alloc=0, skip=0;
<a name="l03479"></a>03479 
<a name="l03480"></a>03480     <span class="keywordflow">if</span> ((psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a> != <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, psys)) || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>)
<a name="l03481"></a>03481         alloc=1;
<a name="l03482"></a>03482 
<a name="l03483"></a>03483     <span class="keywordflow">if</span> (alloc || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a682502f586515a24a8148c421db2877b">PSYS_RECALC_CHILD</a> || (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad65cbfe5598e2785a4cbc8e32041adc8">vgroup</a>[<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa1ab7fc56cc92ec740d60822347a239a">PSYS_VG_DENSITY</a>] &amp;&amp; (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a> &amp;&amp; sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>)))
<a name="l03484"></a>03484         distr=1;
<a name="l03485"></a>03485 
<a name="l03486"></a>03486     <span class="keywordflow">if</span> (distr) {
<a name="l03487"></a>03487         <span class="keywordflow">if</span> (alloc)
<a name="l03488"></a>03488             <a class="code" href="../../df/d40/particle__system_8c.html#aef983187092ea570b9af5b7336c019f7">realloc_particles</a>(sim, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>);
<a name="l03489"></a>03489 
<a name="l03490"></a>03490         <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, psys)) {
<a name="l03491"></a>03491             <span class="comment">/* don&#39;t generate children while computing the hair keys */</span>
<a name="l03492"></a>03492             <span class="keywordflow">if</span> (!(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) || (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>)) {
<a name="l03493"></a>03493                 <a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">distribute_particles</a>(sim, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>);
<a name="l03494"></a>03494 
<a name="l03495"></a>03495                 <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7abd73329b3203429f5cc4e4782b7296">PART_CHILD_FACES</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a969d559e04ce0c077311ce8eae033240">parents</a> != 0.0f)
<a name="l03496"></a>03496                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a26deaf7d151d0636f04c69afb82b8165">psys_find_parents</a>(sim);
<a name="l03497"></a>03497             }
<a name="l03498"></a>03498         }
<a name="l03499"></a>03499         <span class="keywordflow">else</span>
<a name="l03500"></a>03500             <a class="code" href="../../db/dca/BKE__particle_8h.html#a82ab987ec4146bf9fa326003872470bb">psys_free_children</a>(psys);
<a name="l03501"></a>03501     }
<a name="l03502"></a>03502 
<a name="l03503"></a>03503     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)==0)
<a name="l03504"></a>03504         skip = 1; <span class="comment">/* only hair, keyed and baked stuff can have paths */</span>
<a name="l03505"></a>03505     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a> &amp;&amp; !(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2506fdc9f159583f812c900402c5ec54">PART_DRAW_OB</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ababc8a40b78ea25bfdb9cd7b85c83f19">PART_DRAW_GR</a>)))
<a name="l03506"></a>03506         skip = 1; <span class="comment">/* particle visualization must be set as path */</span>
<a name="l03507"></a>03507     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a86a9ed5baa3079474b611e98979c0928">renderdata</a>) {
<a name="l03508"></a>03508         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a675fa9a30bd2105087a98d138c6df66c">draw_as</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a4c845dcc070e77eedb10185fc4d61d06">PART_DRAW_REND</a>)
<a name="l03509"></a>03509             skip = 1; <span class="comment">/* draw visualization */</span>
<a name="l03510"></a>03510         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>)
<a name="l03511"></a>03511             skip = 1; <span class="comment">/* no need to cache paths while baking dynamics */</span>
<a name="l03512"></a>03512         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a1c1dc6c5a0228d884482290f64e6b5cc">psys_in_edit_mode</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, psys)) {
<a name="l03513"></a>03513             <span class="keywordflow">if</span> ((pset-&gt;<a class="code" href="../../df/db7/structParticleEditSettings.html#a3bfdff8f61248e79650bdf43d58b165c">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a224aa3154247ad38a5722be6f641fad7">PE_DRAW_PART</a>)==0)
<a name="l03514"></a>03514                 skip = 1;
<a name="l03515"></a>03515             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>==0 &amp;&amp; (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a65497cba4ef74badceb76706e2b0a526">PSYS_HAIR_DYNAMICS</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)==0)
<a name="l03516"></a>03516                 skip = 1; <span class="comment">/* in edit mode paths are needed for child particles and dynamic hair */</span>
<a name="l03517"></a>03517         }
<a name="l03518"></a>03518     }
<a name="l03519"></a>03519 
<a name="l03520"></a>03520 
<a name="l03521"></a>03521     <span class="comment">/* particle instance modifier with &quot;path&quot; option need cached paths even if particle system doesn&#39;t */</span>
<a name="l03522"></a>03522     <span class="keywordflow">for</span> (base = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l03523"></a>03523         <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435aade5130614696f8b224c5db72ab60f5a">eModifierType_ParticleInstance</a>);
<a name="l03524"></a>03524         <span class="keywordflow">if</span> (md) {
<a name="l03525"></a>03525             <a class="code" href="../../d2/dea/structParticleInstanceModifierData.html">ParticleInstanceModifierData</a> *pimd = (<a class="code" href="../../d2/dea/structParticleInstanceModifierData.html">ParticleInstanceModifierData</a> *)md;
<a name="l03526"></a>03526             <span class="keywordflow">if</span> (pimd-&gt;<a class="code" href="../../d2/dea/structParticleInstanceModifierData.html#a7517d09e2aab8b3c6cab7061c4c612d7">flag</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3439bc1d2c0e9ffab9902290c89e3d8cacd90f6d40eb38b325335565062cd04cc">eParticleInstanceFlag_Path</a> &amp;&amp; pimd-&gt;<a class="code" href="../../d2/dea/structParticleInstanceModifierData.html#a559349f9f597edaa93ea27569141bfa4">ob</a> == sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a> &amp;&amp; pimd-&gt;<a class="code" href="../../d2/dea/structParticleInstanceModifierData.html#a92ca2333012a6794518e6803e4f4ed8d">psys</a> == (psys - (<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a>*)sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l03527"></a>03527                 skip = 0;
<a name="l03528"></a>03528                 <span class="keywordflow">break</span>;
<a name="l03529"></a>03529             }
<a name="l03530"></a>03530         }
<a name="l03531"></a>03531     }
<a name="l03532"></a>03532 
<a name="l03533"></a>03533     <span class="keywordflow">if</span> (!skip) {
<a name="l03534"></a>03534         <a class="code" href="../../db/dca/BKE__particle_8h.html#af507b85abb2119ecbe202ed37f85486b">psys_cache_paths</a>(sim, cfra);
<a name="l03535"></a>03535 
<a name="l03536"></a>03536         <span class="comment">/* for render, child particle paths are computed on the fly */</span>
<a name="l03537"></a>03537         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>) {
<a name="l03538"></a>03538             <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>)
<a name="l03539"></a>03539                 skip = 1;
<a name="l03540"></a>03540             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>)==0)
<a name="l03541"></a>03541                 skip = 1;
<a name="l03542"></a>03542 
<a name="l03543"></a>03543             <span class="keywordflow">if</span> (!skip)
<a name="l03544"></a>03544                 <a class="code" href="../../db/dca/BKE__particle_8h.html#aaf684c8859e72c262720c0f86a21f38b">psys_cache_child_paths</a>(sim, cfra, 0);
<a name="l03545"></a>03545         }
<a name="l03546"></a>03546     }
<a name="l03547"></a>03547     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ae097f6afc34289ef7ef3a6d6741070ad">pathcache</a>)
<a name="l03548"></a>03548         <a class="code" href="../../db/dca/BKE__particle_8h.html#ac3a5caa58c093a03ce64938258f62d93">psys_free_path_cache</a>(psys, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03549"></a>03549 }
<a name="l03550"></a>03550 
<a name="l03551"></a><a class="code" href="../../df/d40/particle__system_8c.html#ac11b7fcc27b6cff0d842c7faaf986348">03551</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#ac11b7fcc27b6cff0d842c7faaf986348">do_hair_dynamics</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l03552"></a>03552 {
<a name="l03553"></a>03553     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l03554"></a>03554     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aa30d2b6e32316a34c46f4a66719b733f">hair_in_dm</a>;
<a name="l03555"></a>03555     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03556"></a>03556     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03557"></a>03557     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03558"></a>03558     <a class="code" href="../../de/d56/structHairKey.html">HairKey</a> *key;
<a name="l03559"></a>03559     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l03560"></a>03560     <span class="keywordtype">int</span> totpoint = 0;
<a name="l03561"></a>03561     <span class="keywordtype">int</span> totedge;
<a name="l03562"></a>03562     <span class="keywordtype">int</span> k;
<a name="l03563"></a>03563     <span class="keywordtype">float</span> hairmat[4][4];
<a name="l03564"></a>03564     float (*deformedVerts)[3];
<a name="l03565"></a>03565 
<a name="l03566"></a>03566     <span class="keywordflow">if</span> (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>) {
<a name="l03567"></a>03567         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a> = (<a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a>*)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ad792bc6e3890679e671ffd17a10194c5">modifier_new</a>(<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a5fc484f055c7aba4c89beda85b5ba321">eModifierType_Cloth</a>);
<a name="l03568"></a>03568         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a0efc6e380729475dfbfb4ed5a8eb3a64">goalspring</a> = 0.0f;
<a name="l03569"></a>03569         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a10ebf57c3511993c8893423967560aee">flags</a> |= <a class="code" href="../../d4/d17/BKE__cloth_8h.html#a95af84ce079cb69c39096070624f7d1ea2595e42e924cf740a5206b0e93cccc69">CLOTH_SIMSETTINGS_FLAG_GOAL</a>|<a class="code" href="../../d4/d17/BKE__cloth_8h.html#a95af84ce079cb69c39096070624f7d1ea9d204fbe70f8a4d97a77b76df2ebccbf">CLOTH_SIMSETTINGS_FLAG_NO_SPRING_COMPRESS</a>;
<a name="l03570"></a>03570         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#acaaa5b7360285674134abe28401bd0f9">coll_parms</a>-&gt;<a class="code" href="../../dc/db4/structClothCollSettings.html#adf5e8f6864b21bdf3412273b7588913f">flags</a> &amp;= ~<a class="code" href="../../d4/d17/BKE__cloth_8h.html#a57b10bdb160e33cbc64390be21399724af386e282854be21761e78cb5783abba4">CLOTH_COLLSETTINGS_FLAG_SELF</a>;
<a name="l03571"></a>03571     }
<a name="l03572"></a>03572 
<a name="l03573"></a>03573     <span class="comment">/* create a dm from hair vertices */</span>
<a name="l03574"></a>03574     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l03575"></a>03575         totpoint += pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a>;
<a name="l03576"></a>03576 
<a name="l03577"></a>03577     totedge = totpoint;
<a name="l03578"></a>03578     totpoint += psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l03579"></a>03579 
<a name="l03580"></a>03580     <span class="keywordflow">if</span> (dm &amp;&amp; (totpoint != dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm) || totedge != dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm))) {
<a name="l03581"></a>03581         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l03582"></a>03582         dm = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aa30d2b6e32316a34c46f4a66719b733f">hair_in_dm</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03583"></a>03583     }
<a name="l03584"></a>03584 
<a name="l03585"></a>03585     <span class="keywordflow">if</span> (!dm) {
<a name="l03586"></a>03586         dm = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aa30d2b6e32316a34c46f4a66719b733f">hair_in_dm</a> = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a430764cfc7b8ca4ba60d95c71ce227d7">CDDM_new</a>(totpoint, totedge, 0, 0, 0);
<a name="l03587"></a>03587         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1d5e2eb6e1a26961b60f0cac4a7411bc">DM_add_vert_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03588"></a>03588     }
<a name="l03589"></a>03589 
<a name="l03590"></a>03590     mvert = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aa752a14da3863173b9d2d3a6efa0b051">CDDM_get_verts</a>(dm);
<a name="l03591"></a>03591     medge = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a28e356313b5ea1ef69262330c3427954">CDDM_get_edges</a>(dm);
<a name="l03592"></a>03592     dvert = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l03593"></a>03593 
<a name="l03594"></a>03594     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a7ddc6013bd7e83909ad57dfc6a3f5077">vgroup_mass</a> = 1;
<a name="l03595"></a>03595 
<a name="l03596"></a>03596     <span class="comment">/* make vgroup for pin roots etc.. */</span>
<a name="l03597"></a>03597     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> = 1;
<a name="l03598"></a>03598     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l03599"></a>03599         <span class="keywordflow">if</span> (p)
<a name="l03600"></a>03600             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> = (pa-1)-&gt;hair_index + (pa-1)-&gt;totkey + 1;
<a name="l03601"></a>03601 
<a name="l03602"></a>03602         <a class="code" href="../../db/dca/BKE__particle_8h.html#a6e80d28b222c8d2bdc2989df214a1ec2">psys_mat_hair_to_object</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>, pa, hairmat);
<a name="l03603"></a>03603 
<a name="l03604"></a>03604         <span class="keywordflow">for</span> (k=0, key=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a6d1bcac455641baf1d02cede42894902">hair</a>; k&lt;pa-&gt;totkey; k++,key++) {
<a name="l03605"></a>03605             
<a name="l03606"></a>03606             <span class="comment">/* create fake root before actual root to resist bending */</span>
<a name="l03607"></a>03607             <span class="keywordflow">if</span> (k==0) {
<a name="l03608"></a>03608                 <span class="keywordtype">float</span> temp[3];
<a name="l03609"></a>03609                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>, (key+1)-&gt;co);
<a name="l03610"></a>03610                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>);
<a name="l03611"></a>03611                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, temp);
<a name="l03612"></a>03612                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(hairmat, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03613"></a>03613                 mvert++;
<a name="l03614"></a>03614 
<a name="l03615"></a>03615                 medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> - 1;
<a name="l03616"></a>03616                 medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a>;
<a name="l03617"></a>03617                 medge++;
<a name="l03618"></a>03618 
<a name="l03619"></a>03619                 <span class="keywordflow">if</span> (dvert) {
<a name="l03620"></a>03620                     <span class="keywordflow">if</span> (!dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>) {
<a name="l03621"></a>03621                         dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a>), <span class="stringliteral">&quot;deformWeight&quot;</span>);
<a name="l03622"></a>03622                         dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a> = 1;
<a name="l03623"></a>03623                     }
<a name="l03624"></a>03624 
<a name="l03625"></a>03625                     dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = 1.0f;
<a name="l03626"></a>03626                     dvert++;
<a name="l03627"></a>03627                 }
<a name="l03628"></a>03628             }
<a name="l03629"></a>03629 
<a name="l03630"></a>03630             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>);
<a name="l03631"></a>03631             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(hairmat, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03632"></a>03632             mvert++;
<a name="l03633"></a>03633             
<a name="l03634"></a>03634             <span class="keywordflow">if</span> (k) {
<a name="l03635"></a>03635                 medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> + k - 1;
<a name="l03636"></a>03636                 medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a416c9eac59551e345e14f0dc3ef7bfdf">hair_index</a> + k;
<a name="l03637"></a>03637                 medge++;
<a name="l03638"></a>03638             }
<a name="l03639"></a>03639 
<a name="l03640"></a>03640             <span class="keywordflow">if</span> (dvert) {
<a name="l03641"></a>03641                 <span class="keywordflow">if</span> (!dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>) {
<a name="l03642"></a>03642                     dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a>), <span class="stringliteral">&quot;deformWeight&quot;</span>);
<a name="l03643"></a>03643                     dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a> = 1;
<a name="l03644"></a>03644                 }
<a name="l03645"></a>03645                 <span class="comment">/* roots should be 1.0, the rest can be anything from 0.0 to 1.0 */</span>
<a name="l03646"></a>03646                 dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a09eeb1ee44f6385ec68a29a7695c3cd2">weight</a>;
<a name="l03647"></a>03647                 dvert++;
<a name="l03648"></a>03648             }
<a name="l03649"></a>03649         }
<a name="l03650"></a>03650     }
<a name="l03651"></a>03651 
<a name="l03652"></a>03652     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>)
<a name="l03653"></a>03653         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>);
<a name="l03654"></a>03654 
<a name="l03655"></a>03655     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a77605f4a26c5077252abce50377e3de9">point_cache</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>;
<a name="l03656"></a>03656     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a037f21034c9abf86dea5341c23be7e60">effector_weights</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a82846291d135c6395249f60253e2ce9d">effector_weights</a>;
<a name="l03657"></a>03657 
<a name="l03658"></a>03658     deformedVerts = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*deformedVerts)*dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm), <span class="stringliteral">&quot;do_hair_dynamics vertexCos&quot;</span>);
<a name="l03659"></a>03659     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a> = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l03660"></a>03660     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>, deformedVerts);
<a name="l03661"></a>03661 
<a name="l03662"></a>03662     <a class="code" href="../../d4/d17/BKE__cloth_8h.html#a26e62b636129fd92f46f18f1623e88bc">clothModifier_do</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, dm, deformedVerts);
<a name="l03663"></a>03663 
<a name="l03664"></a>03664     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#acbfc4717258b006bccf5053182147e56">hair_out_dm</a>, deformedVerts);
<a name="l03665"></a>03665 
<a name="l03666"></a>03666     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l03667"></a>03667 
<a name="l03668"></a>03668     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a037f21034c9abf86dea5341c23be7e60">effector_weights</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03669"></a>03669 }
<a name="l03670"></a><a class="code" href="../../df/d40/particle__system_8c.html#a2cb51debcd08b860ddca5971402f5c26">03670</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a2cb51debcd08b860ddca5971402f5c26">hair_step</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> cfra)
<a name="l03671"></a>03671 {
<a name="l03672"></a>03672     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l03673"></a>03673     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l03674"></a>03674     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l03675"></a>03675     <span class="keywordtype">float</span> disp = (float)<a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">psys_get_current_display_percentage</a>(psys)/100.0f;
<a name="l03676"></a>03676 
<a name="l03677"></a>03677     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l03678"></a>03678         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a776e1928583df9d19b41cc90e6fb42c8">size</a>;
<a name="l03679"></a>03679         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> &gt; 0.0f)
<a name="l03680"></a>03680             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 1);
<a name="l03681"></a>03681 
<a name="l03682"></a>03682         <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p) &gt; disp)
<a name="l03683"></a>03683             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l03684"></a>03684         <span class="keywordflow">else</span>
<a name="l03685"></a>03685             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l03686"></a>03686     }
<a name="l03687"></a>03687 
<a name="l03688"></a>03688     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>) {
<a name="l03689"></a>03689         <span class="comment">/* need this for changing subsurf levels */</span>
<a name="l03690"></a>03690         <a class="code" href="../../db/dca/BKE__particle_8h.html#a26715032d0452cc6788be0bded9d9d09">psys_calc_dmcache</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, psys);
<a name="l03691"></a>03691 
<a name="l03692"></a>03692         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>)
<a name="l03693"></a>03693             <a class="code" href="../../d4/d17/BKE__cloth_8h.html#a252b1bd957943fc2193f26d6893971f4">cloth_free_modifier</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>);
<a name="l03694"></a>03694     }
<a name="l03695"></a>03695 
<a name="l03696"></a>03696     <span class="comment">/* dynamics with cloth simulation, psys-&gt;particles can be NULL with 0 particles [#25519] */</span>
<a name="l03697"></a>03697     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a65497cba4ef74badceb76706e2b0a526">PSYS_HAIR_DYNAMICS</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>)
<a name="l03698"></a>03698         <a class="code" href="../../df/d40/particle__system_8c.html#ac11b7fcc27b6cff0d842c7faaf986348">do_hair_dynamics</a>(sim);
<a name="l03699"></a>03699 
<a name="l03700"></a>03700     <span class="comment">/* following lines were removed r29079 but cause bug [#22811], see report for details */</span>
<a name="l03701"></a>03701     <a class="code" href="../../df/d40/particle__system_8c.html#aa9b2d7bc7dcda6cfced08e18adbf2acb">psys_update_effectors</a>(sim);
<a name="l03702"></a>03702     <a class="code" href="../../df/d40/particle__system_8c.html#af211e7a44c8a798b553ed08bc9045f5b">psys_update_path_cache</a>(sim, cfra);
<a name="l03703"></a>03703 
<a name="l03704"></a>03704     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae7f51c5045d66192c7ea9f5c4c9b9c35">PSYS_HAIR_UPDATED</a>;
<a name="l03705"></a>03705 }
<a name="l03706"></a>03706 
<a name="l03707"></a><a class="code" href="../../df/d40/particle__system_8c.html#a1ba7cd33ae3175995819eb13fc9b11fe">03707</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a1ba7cd33ae3175995819eb13fc9b11fe">save_hair</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l03708"></a>03708 {
<a name="l03709"></a>03709     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l03710"></a>03710     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l03711"></a>03711     <a class="code" href="../../de/d56/structHairKey.html">HairKey</a> *key, *root;
<a name="l03712"></a>03712     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l03713"></a>03713 
<a name="l03714"></a>03714     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03715"></a>03715     
<a name="l03716"></a>03716     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../db/dca/BKE__particle_8h.html#a7f29db3949d983f1e222f2c5bb1a2a91">psys_get_lattice</a>(sim);
<a name="l03717"></a>03717 
<a name="l03718"></a>03718     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>==0) <span class="keywordflow">return</span>;
<a name="l03719"></a>03719     
<a name="l03720"></a>03720     <span class="comment">/* save new keys for elements if needed */</span>
<a name="l03721"></a>03721     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l03722"></a>03722         <span class="comment">/* first time alloc */</span>
<a name="l03723"></a>03723         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a>==0 || pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a6d1bcac455641baf1d02cede42894902">hair</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03724"></a>03724             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a6d1bcac455641baf1d02cede42894902">hair</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4c7ce6b3dc7ffa55b4b4dc83bee12b0c">hair_step</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../de/d56/structHairKey.html">HairKey</a>), <span class="stringliteral">&quot;HairKeys&quot;</span>);
<a name="l03725"></a>03725             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a> = 0;
<a name="l03726"></a>03726         }
<a name="l03727"></a>03727 
<a name="l03728"></a>03728         key = root = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a6d1bcac455641baf1d02cede42894902">hair</a>;
<a name="l03729"></a>03729         key += pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a>;
<a name="l03730"></a>03730 
<a name="l03731"></a>03731         <span class="comment">/* convert from global to geometry space */</span>
<a name="l03732"></a>03732         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l03733"></a>03733         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>);
<a name="l03734"></a>03734 
<a name="l03735"></a>03735         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a>) {
<a name="l03736"></a>03736             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>, root-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>);
<a name="l03737"></a>03737             <a class="code" href="../../db/dca/BKE__particle_8h.html#ace3b72cc846f1dabbe0a173c9e3925e3">psys_vec_rot_to_face</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, pa, key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>);
<a name="l03738"></a>03738         }
<a name="l03739"></a>03739 
<a name="l03740"></a>03740         key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a1c6928afc0c745e823438ed1e16f385a">time</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>;
<a name="l03741"></a>03741 
<a name="l03742"></a>03742         key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a09eeb1ee44f6385ec68a29a7695c3cd2">weight</a> = 1.0f - key-&gt;<a class="code" href="../../de/d56/structHairKey.html#a1c6928afc0c745e823438ed1e16f385a">time</a> / 100.0f;
<a name="l03743"></a>03743 
<a name="l03744"></a>03744         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a>++;
<a name="l03745"></a>03745 
<a name="l03746"></a>03746         <span class="comment">/* root is always in the origin of hair space so we set it to be so after the last key is saved*/</span>
<a name="l03747"></a>03747         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a8ca52533a1433a54399e1d9edbad7d85">totkey</a> == psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4c7ce6b3dc7ffa55b4b4dc83bee12b0c">hair_step</a> + 1)
<a name="l03748"></a>03748             root-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>[0] = root-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>[1] = root-&gt;<a class="code" href="../../de/d56/structHairKey.html#a7c62c2ffccdc2c863be09a8ff464bb19">co</a>[2] = 0.0f;
<a name="l03749"></a>03749     }
<a name="l03750"></a>03750 }
<a name="l03751"></a>03751 
<a name="l03752"></a>03752 <span class="comment">/* Code for an adaptive time step based on the Courant-Friedrichs-Lewy</span>
<a name="l03753"></a>03753 <span class="comment"> * condition. */</span>
<a name="l03754"></a><a class="code" href="../../df/d40/particle__system_8c.html#ac7ec50fa7e0f9e74874ec0e48a6e5770">03754</a> <span class="preprocessor">#define MIN_TIMESTEP 1.0f / 101.0f</span>
<a name="l03755"></a>03755 <span class="preprocessor"></span><span class="comment">/* Tolerance of 1.5 means the last subframe neither favors growing nor</span>
<a name="l03756"></a>03756 <span class="comment"> * shrinking (e.g if it were 1.3, the last subframe would tend to be too</span>
<a name="l03757"></a>03757 <span class="comment"> * small). */</span>
<a name="l03758"></a><a class="code" href="../../df/d40/particle__system_8c.html#a0605ee19d1908cc33573775adee4589a">03758</a> <span class="preprocessor">#define TIMESTEP_EXPANSION_TOLERANCE 1.5f</span>
<a name="l03759"></a>03759 <span class="preprocessor"></span>
<a name="l03760"></a>03760 <span class="comment">/* Calculate the speed of the particle relative to the local scale of the</span>
<a name="l03761"></a>03761 <span class="comment"> * simulation. This should be called once per particle during a simulation</span>
<a name="l03762"></a>03762 <span class="comment"> * step, after the velocity has been updated. element_size defines the scale of</span>
<a name="l03763"></a>03763 <span class="comment"> * the simulation, and is typically the distance to neighbourning particles. */</span>
<a name="l03764"></a><a class="code" href="../../df/d40/particle__system_8c.html#a1447277e7ca57666b58db6c1b10c2e4b">03764</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a1447277e7ca57666b58db6c1b10c2e4b">update_courant_num</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa,
<a name="l03765"></a>03765     <span class="keywordtype">float</span> dtime, <a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> *sphdata)
<a name="l03766"></a>03766 {
<a name="l03767"></a>03767     <span class="keywordtype">float</span> relative_vel[3];
<a name="l03768"></a>03768     <span class="keywordtype">float</span> speed;
<a name="l03769"></a>03769 
<a name="l03770"></a>03770     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(relative_vel, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a99187c1365972dd9b9c7050139d520a2">flow</a>);
<a name="l03771"></a>03771     speed = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(relative_vel);
<a name="l03772"></a>03772     <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a> &lt; speed * dtime / sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">element_size</a>)
<a name="l03773"></a>03773         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a> = speed * dtime / sphdata-&gt;<a class="code" href="../../d2/d3d/structSPHData.html#a8a0e06daed3975f6a569c845e4849558">element_size</a>;
<a name="l03774"></a>03774 }
<a name="l03775"></a>03775 <span class="comment">/* Update time step size to suit current conditions. */</span>
<a name="l03776"></a><a class="code" href="../../df/d40/particle__system_8c.html#ab8dfb99e190a0cc95e4d2f7a7e7f66f5">03776</a> <span class="keywordtype">float</span> <a class="code" href="../../df/d40/particle__system_8c.html#ab8dfb99e190a0cc95e4d2f7a7e7f66f5">update_timestep</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim,
<a name="l03777"></a>03777     <span class="keywordtype">float</span> t_frac)
<a name="l03778"></a>03778 {
<a name="l03779"></a>03779     <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a> == 0.0f)
<a name="l03780"></a>03780         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> = 1.0f;
<a name="l03781"></a>03781     <span class="keywordflow">else</span>
<a name="l03782"></a>03782         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> *= (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3a5e7f67257c4c73091d2b35fef9751e">courant_target</a> / sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a>);
<a name="l03783"></a>03783     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a>, <a class="code" href="../../df/d40/particle__system_8c.html#ac7ec50fa7e0f9e74874ec0e48a6e5770">MIN_TIMESTEP</a>, 1.0f);
<a name="l03784"></a>03784 
<a name="l03785"></a>03785     <span class="comment">/* Sync with frame end if it&#39;s close. */</span>
<a name="l03786"></a>03786     <span class="keywordflow">if</span> (t_frac == 1.0f)
<a name="l03787"></a>03787         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a>;
<a name="l03788"></a>03788     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t_frac + (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> * <a class="code" href="../../df/d40/particle__system_8c.html#a0605ee19d1908cc33573775adee4589a">TIMESTEP_EXPANSION_TOLERANCE</a>) &gt;= 1.0f)
<a name="l03789"></a>03789         <span class="keywordflow">return</span> 1.0f - t_frac;
<a name="l03790"></a>03790     <span class="keywordflow">else</span>
<a name="l03791"></a>03791         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a>;
<a name="l03792"></a>03792 }
<a name="l03793"></a>03793 
<a name="l03794"></a>03794 <span class="comment">/************************************************/</span>
<a name="l03795"></a>03795 <span class="comment">/*          System Core                         */</span>
<a name="l03796"></a>03796 <span class="comment">/************************************************/</span>
<a name="l03797"></a>03797 <span class="comment">/* unbaked particles are calculated dynamically */</span>
<a name="l03798"></a><a class="code" href="../../df/d40/particle__system_8c.html#a2aa9a57b38399ad6ad2164a9ec3e5f6e">03798</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a2aa9a57b38399ad6ad2164a9ec3e5f6e">dynamics_step</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> cfra)
<a name="l03799"></a>03799 {
<a name="l03800"></a>03800     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l03801"></a>03801     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l03802"></a>03802     <a class="code" href="../../d2/d40/structBoidBrainData.html">BoidBrainData</a> bbd;
<a name="l03803"></a>03803     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> ptex;
<a name="l03804"></a>03804     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l03805"></a>03805     <span class="keywordtype">float</span> timestep;
<a name="l03806"></a>03806     <span class="comment">/* frame &amp; time changes */</span>
<a name="l03807"></a>03807     <span class="keywordtype">float</span> dfra, dtime;
<a name="l03808"></a>03808     <span class="keywordtype">float</span> birthtime, dietime;
<a name="l03809"></a>03809 
<a name="l03810"></a>03810     <span class="comment">/* where have we gone in time since last time */</span>
<a name="l03811"></a>03811     dfra= cfra - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>;
<a name="l03812"></a>03812 
<a name="l03813"></a>03813     timestep = <a class="code" href="../../db/dca/BKE__particle_8h.html#a75c75a40fcacfa5cb9e05638d6e823ad">psys_get_timestep</a>(sim);
<a name="l03814"></a>03814     dtime= dfra*timestep;
<a name="l03815"></a>03815 
<a name="l03816"></a>03816     <span class="keywordflow">if</span> (dfra &lt; 0.0f) {
<a name="l03817"></a>03817         <a class="code" href="../../db/dca/BKE__particle_8h.html#ad409e9068225d14b2f0c08b23ec308e7">LOOP_EXISTING_PARTICLES</a> {
<a name="l03818"></a>03818             <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7e633bb8a8c28e52c7b7507536c33300">PAMAP_SIZE</a>, cfra);
<a name="l03819"></a>03819             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a776e1928583df9d19b41cc90e6fb42c8">size</a>*ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#acf699d1b168d47232dd4c710ec8beb55">size</a>;
<a name="l03820"></a>03820             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> &gt; 0.0f)
<a name="l03821"></a>03821                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 1);
<a name="l03822"></a>03822 
<a name="l03823"></a>03823             <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, dtime, cfra);
<a name="l03824"></a>03824         }
<a name="l03825"></a>03825         <span class="keywordflow">return</span>;
<a name="l03826"></a>03826     }
<a name="l03827"></a>03827 
<a name="l03828"></a>03828     <a class="code" href="../../d3/d88/BLI__rand_8h.html#a7ad661de51648e981c003a4d5694911b">BLI_srandom</a>(31415926 + (<span class="keywordtype">int</span>)cfra + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>);
<a name="l03829"></a>03829 
<a name="l03830"></a>03830     <a class="code" href="../../df/d40/particle__system_8c.html#aa9b2d7bc7dcda6cfced08e18adbf2acb">psys_update_effectors</a>(sim);
<a name="l03831"></a>03831 
<a name="l03832"></a>03832     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>)
<a name="l03833"></a>03833         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a> = <a class="code" href="../../d6/de6/BKE__collision_8h.html#a8a72494b6a3ccf837fb0d48d0bcd8466">get_collider_cache</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03834"></a>03834 
<a name="l03835"></a>03835     <span class="comment">/* initialize physics type specific stuff */</span>
<a name="l03836"></a>03836     <span class="keywordflow">switch</span>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>) {
<a name="l03837"></a>03837         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>:
<a name="l03838"></a>03838         {
<a name="l03839"></a>03839             <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l03840"></a>03840             bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#af7e4993d1f48d8d8a31cffd89c9b4fba">sim</a> = sim;
<a name="l03841"></a>03841             bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#a478934848cffcce7285ae7ae70419d89">part</a> = part;
<a name="l03842"></a>03842             bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#a18972f17ba1e8ef28e4d86db28af30bb">cfra</a> = cfra;
<a name="l03843"></a>03843             bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#a2745508dcc5788b0a9556fb3392ec35c">dfra</a> = dfra;
<a name="l03844"></a>03844             bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#a77e2a9d36a756fba47bedf24ad7b2a0c">timestep</a> = timestep;
<a name="l03845"></a>03845 
<a name="l03846"></a>03846             <a class="code" href="../../db/dca/BKE__particle_8h.html#aa570fc2652464faaab8b8edbe67fe176">psys_update_particle_tree</a>(psys, cfra);
<a name="l03847"></a>03847 
<a name="l03848"></a>03848             <a class="code" href="../../d8/db3/BKE__boids_8h.html#aea88229424dd7dfb2f2d5950491b03b2">boids_precalc_rules</a>(part, cfra);
<a name="l03849"></a>03849 
<a name="l03850"></a>03850             <span class="keywordflow">for</span> (; pt; pt=pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a>) {
<a name="l03851"></a>03851                 <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a>)
<a name="l03852"></a>03852                     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa570fc2652464faaab8b8edbe67fe176">psys_update_particle_tree</a>(<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>, pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a9ca544004c18942653f7d48882ca03f4">psys</a>-1), cfra);
<a name="l03853"></a>03853             }
<a name="l03854"></a>03854             <span class="keywordflow">break</span>;
<a name="l03855"></a>03855         }
<a name="l03856"></a>03856         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a>:
<a name="l03857"></a>03857         {
<a name="l03858"></a>03858             <a class="code" href="../../df/db9/structParticleTarget.html">ParticleTarget</a> *pt = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a37c37da2c9bb6301d50a6133d00b6b75">targets</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l03859"></a>03859             <a class="code" href="../../df/d40/particle__system_8c.html#ab65474e5e6875eaa766b038cf3422934">psys_update_particle_bvhtree</a>(psys, cfra);
<a name="l03860"></a>03860             
<a name="l03861"></a>03861             <span class="keywordflow">for</span> (; pt; pt=pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a6643a6f60f33e21a80a82e6140ddcbcc">next</a>) {  <span class="comment">/* Updating others systems particle tree for fluid-fluid interaction */</span>
<a name="l03862"></a>03862                 <span class="keywordflow">if</span> (pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a>)
<a name="l03863"></a>03863                     <a class="code" href="../../df/d40/particle__system_8c.html#ab65474e5e6875eaa766b038cf3422934">psys_update_particle_bvhtree</a>(<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a0b60fbd359436e5c221a0f4a719defd4">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>, pt-&gt;<a class="code" href="../../df/db9/structParticleTarget.html#a9ca544004c18942653f7d48882ca03f4">psys</a>-1), cfra);
<a name="l03864"></a>03864             }
<a name="l03865"></a>03865             <span class="keywordflow">break</span>;
<a name="l03866"></a>03866         }
<a name="l03867"></a>03867     }
<a name="l03868"></a>03868     <span class="comment">/* initialize all particles for dynamics */</span>
<a name="l03869"></a>03869     <a class="code" href="../../db/dca/BKE__particle_8h.html#a3f8993c95b4edac4705866d967b2ed51">LOOP_SHOWN_PARTICLES</a> {
<a name="l03870"></a>03870         <a class="code" href="../../db/dca/BKE__particle_8h.html#a5b76b44a0cc1f11cb6b8a552d0e89724">copy_particle_key</a>(&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>,&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>,1);
<a name="l03871"></a>03871 
<a name="l03872"></a>03872         <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7e633bb8a8c28e52c7b7507536c33300">PAMAP_SIZE</a>, cfra);
<a name="l03873"></a>03873 
<a name="l03874"></a>03874         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a776e1928583df9d19b41cc90e6fb42c8">size</a>*ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#acf699d1b168d47232dd4c710ec8beb55">size</a>;
<a name="l03875"></a>03875         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> &gt; 0.0f)
<a name="l03876"></a>03876             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 1);
<a name="l03877"></a>03877 
<a name="l03878"></a>03878         birthtime = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>;
<a name="l03879"></a>03879         dietime = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>;
<a name="l03880"></a>03880 
<a name="l03881"></a>03881         <span class="comment">/* store this, so we can do multiple loops over particles */</span>
<a name="l03882"></a>03882         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dfra;
<a name="l03883"></a>03883 
<a name="l03884"></a>03884         <span class="keywordflow">if</span> (dietime &lt;= cfra &amp;&amp; psys-&gt;cfra &lt; dietime) {
<a name="l03885"></a>03885             <span class="comment">/* particle dies some time between this and last step */</span>
<a name="l03886"></a>03886             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = dietime - ((birthtime &gt; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>) ? birthtime : psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>);
<a name="l03887"></a>03887             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae5a5904ec37e02a0b91b53d172d0849d">PARS_DYING</a>;
<a name="l03888"></a>03888         }
<a name="l03889"></a>03889         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (birthtime &lt;= cfra &amp;&amp; birthtime &gt;= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>) {
<a name="l03890"></a>03890             <span class="comment">/* particle is born some time between this and last step*/</span>
<a name="l03891"></a>03891             <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, dfra*timestep, cfra);
<a name="l03892"></a>03892             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>;
<a name="l03893"></a>03893             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = cfra - birthtime;
<a name="l03894"></a>03894         }
<a name="l03895"></a>03895         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dietime &lt; cfra) {
<a name="l03896"></a>03896             <span class="comment">/* nothing to be done when particle is dead */</span>
<a name="l03897"></a>03897         }
<a name="l03898"></a>03898 
<a name="l03899"></a>03899         <span class="comment">/* only reset unborn particles if they&#39;re shown or if the particle is born soon*/</span>
<a name="l03900"></a>03900         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae26eb239d67b64da7b2afef89052c50d">PARS_UNBORN</a> &amp;&amp; (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a89887736df27c700e59ef81204839e3c">PART_UNBORN</a> || (cfra + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a> &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>))) {
<a name="l03901"></a>03901             <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, dtime, cfra);
<a name="l03902"></a>03902         }
<a name="l03903"></a>03903         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aaaa65883b0fd34e1f66db33d0e55ef9e">PART_PHYS_NO</a>) {
<a name="l03904"></a>03904             <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, dtime, cfra);
<a name="l03905"></a>03905         }
<a name="l03906"></a>03906 
<a name="l03907"></a>03907         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae5a5904ec37e02a0b91b53d172d0849d">PARS_DYING</a>)==0 || (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp; (<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>)))
<a name="l03908"></a>03908             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = -1.f;
<a name="l03909"></a>03909     }
<a name="l03910"></a>03910 
<a name="l03911"></a>03911     <span class="keywordflow">switch</span>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>) {
<a name="l03912"></a>03912         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ab3449550f098a61b95dcfd28117f9b34">PART_PHYS_NEWTON</a>:
<a name="l03913"></a>03913         {
<a name="l03914"></a>03914             <a class="code" href="../../db/dca/BKE__particle_8h.html#ab07560d97aaeef7f51b42d3aec9f04bf">LOOP_DYNAMIC_PARTICLES</a> {
<a name="l03915"></a>03915                 <span class="comment">/* do global forces &amp; effectors */</span>
<a name="l03916"></a>03916                 <a class="code" href="../../df/d40/particle__system_8c.html#a46999aed187684f17527b6c3dc71ad41">basic_integrate</a>(sim, p, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, cfra);
<a name="l03917"></a>03917     
<a name="l03918"></a>03918                 <span class="comment">/* deflection */</span>
<a name="l03919"></a>03919                 <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>)
<a name="l03920"></a>03920                     <a class="code" href="../../df/d40/particle__system_8c.html#a9b1485feb4e39e22f4f1c1962aa899a4">collision_check</a>(sim, p, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, cfra);
<a name="l03921"></a>03921 
<a name="l03922"></a>03922                 <span class="comment">/* rotations */</span>
<a name="l03923"></a>03923                 <a class="code" href="../../df/d40/particle__system_8c.html#a6835f63573f5d96a041def3c73e3e540">basic_rotate</a>(part, pa, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, timestep);
<a name="l03924"></a>03924             }
<a name="l03925"></a>03925             <span class="keywordflow">break</span>;
<a name="l03926"></a>03926         }
<a name="l03927"></a>03927         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>:
<a name="l03928"></a>03928         {
<a name="l03929"></a>03929             <a class="code" href="../../db/dca/BKE__particle_8h.html#ab07560d97aaeef7f51b42d3aec9f04bf">LOOP_DYNAMIC_PARTICLES</a> {
<a name="l03930"></a>03930                 bbd.<a class="code" href="../../d2/d40/structBoidBrainData.html#a4a8de1421fb50ae1402f35cc7b333c8f">goal_ob</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03931"></a>03931                 
<a name="l03932"></a>03932                 <a class="code" href="../../d8/db3/BKE__boids_8h.html#a70c57787067c5d782fa712c8cf540d3b">boid_brain</a>(&amp;bbd, p, pa);
<a name="l03933"></a>03933 
<a name="l03934"></a>03934                 <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae5a5904ec37e02a0b91b53d172d0849d">PARS_DYING</a>) {
<a name="l03935"></a>03935                     <a class="code" href="../../d8/db3/BKE__boids_8h.html#a7c7d9f43ad747c97f0dfe096b420a439">boid_body</a>(&amp;bbd, pa);
<a name="l03936"></a>03936 
<a name="l03937"></a>03937                     <span class="comment">/* deflection */</span>
<a name="l03938"></a>03938                     <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>)
<a name="l03939"></a>03939                         <a class="code" href="../../df/d40/particle__system_8c.html#a9b1485feb4e39e22f4f1c1962aa899a4">collision_check</a>(sim, p, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, cfra);
<a name="l03940"></a>03940                 }
<a name="l03941"></a>03941             }
<a name="l03942"></a>03942             <span class="keywordflow">break</span>;
<a name="l03943"></a>03943         }
<a name="l03944"></a>03944         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a>:
<a name="l03945"></a>03945         {
<a name="l03946"></a>03946             <a class="code" href="../../d2/d3d/structSPHData.html">SPHData</a> sphdata;
<a name="l03947"></a>03947             <a class="code" href="../../df/d40/particle__system_8c.html#a192d0078854b03b3da322863a3511625">sph_solver_init</a>(sim, &amp;sphdata);
<a name="l03948"></a>03948 
<a name="l03949"></a>03949 <span class="preprocessor">            #pragma omp parallel for firstprivate (sphdata) private (pa) schedule(dynamic,5)</span>
<a name="l03950"></a>03950 <span class="preprocessor"></span>            <a class="code" href="../../db/dca/BKE__particle_8h.html#ab07560d97aaeef7f51b42d3aec9f04bf">LOOP_DYNAMIC_PARTICLES</a> {
<a name="l03951"></a>03951                 <span class="comment">/* do global forces &amp; effectors */</span>
<a name="l03952"></a>03952                 <a class="code" href="../../df/d40/particle__system_8c.html#a46999aed187684f17527b6c3dc71ad41">basic_integrate</a>(sim, p, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, cfra);
<a name="l03953"></a>03953 
<a name="l03954"></a>03954                 <span class="comment">/* actual fluids calculations */</span>
<a name="l03955"></a>03955                 <a class="code" href="../../df/d40/particle__system_8c.html#ab2855e2e7cd57a96ad2fc3a7a0061775">sph_integrate</a>(sim, pa, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, &amp;sphdata);
<a name="l03956"></a>03956 
<a name="l03957"></a>03957                 <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>)
<a name="l03958"></a>03958                     <a class="code" href="../../df/d40/particle__system_8c.html#a9b1485feb4e39e22f4f1c1962aa899a4">collision_check</a>(sim, p, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, cfra);
<a name="l03959"></a>03959                 
<a name="l03960"></a>03960                 <span class="comment">/* SPH particles are not physical particles, just interpolation</span>
<a name="l03961"></a>03961 <span class="comment">                 * particles,  thus rotation has not a direct sense for them */</span>
<a name="l03962"></a>03962                 <a class="code" href="../../df/d40/particle__system_8c.html#a6835f63573f5d96a041def3c73e3e540">basic_rotate</a>(part, pa, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>, timestep);  
<a name="l03963"></a>03963 
<a name="l03964"></a>03964 <span class="preprocessor">                #pragma omp critical</span>
<a name="l03965"></a>03965 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a87b70b67957deff5879733ebe0199189">time_flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3668a7bcb08c9f9af95dd5a2d4b1867b">PART_TIME_AUTOSF</a>)
<a name="l03966"></a>03966                     <a class="code" href="../../df/d40/particle__system_8c.html#a1447277e7ca57666b58db6c1b10c2e4b">update_courant_num</a>(sim, pa, dtime, &amp;sphdata);
<a name="l03967"></a>03967             }
<a name="l03968"></a>03968 
<a name="l03969"></a>03969             <a class="code" href="../../df/d40/particle__system_8c.html#aa0f5bd222ef8e3b9d9776705b09d2c7e">sph_springs_modify</a>(psys, timestep);
<a name="l03970"></a>03970 
<a name="l03971"></a>03971             <a class="code" href="../../df/d40/particle__system_8c.html#a17dc0037b3f3136aad7e688d5e63cbaf">sph_solver_finalise</a>(&amp;sphdata);
<a name="l03972"></a>03972             <span class="keywordflow">break</span>;
<a name="l03973"></a>03973         }
<a name="l03974"></a>03974     }
<a name="l03975"></a>03975 
<a name="l03976"></a>03976     <span class="comment">/* finalize particle state and time after dynamics */</span>
<a name="l03977"></a>03977     <a class="code" href="../../db/dca/BKE__particle_8h.html#ab07560d97aaeef7f51b42d3aec9f04bf">LOOP_DYNAMIC_PARTICLES</a> {
<a name="l03978"></a>03978         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae5a5904ec37e02a0b91b53d172d0849d">PARS_DYING</a>) {
<a name="l03979"></a>03979             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a>=<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a9f632cd1991990d1c11a712993d733dd">PARS_DEAD</a>;
<a name="l03980"></a>03980             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>;
<a name="l03981"></a>03981         }
<a name="l03982"></a>03982         <span class="keywordflow">else</span>
<a name="l03983"></a>03983             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>=cfra;
<a name="l03984"></a>03984     }
<a name="l03985"></a>03985 
<a name="l03986"></a>03986     <a class="code" href="../../d6/de6/BKE__collision_8h.html#ad0ad8be2c5f909fc0418178e2f023ffe">free_collider_cache</a>(&amp;sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#afafc0d612fc963a4a979f38c98def254">colliders</a>);
<a name="l03987"></a>03987 }
<a name="l03988"></a><a class="code" href="../../df/d40/particle__system_8c.html#a8604c136f8d06ea824571a7e789393bc">03988</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a8604c136f8d06ea824571a7e789393bc">update_children</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l03989"></a>03989 {
<a name="l03990"></a>03990     <span class="keywordflow">if</span> ((sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) &amp;&amp; (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>)==0)
<a name="l03991"></a>03991     <span class="comment">/* don&#39;t generate children while growing hair - waste of time */</span>
<a name="l03992"></a>03992         <a class="code" href="../../db/dca/BKE__particle_8h.html#a82ab987ec4146bf9fa326003872470bb">psys_free_children</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l03993"></a>03993     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>) {
<a name="l03994"></a>03994         <span class="keywordflow">if</span> (sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a> != <a class="code" href="../../df/d40/particle__system_8c.html#ac5b207273c836ca94073199b5a9dd662">get_psys_tot_child</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>))
<a name="l03995"></a>03995             <a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">distribute_particles</a>(sim, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a37165b156a83e3cf9a4c343f70af7665">PART_FROM_CHILD</a>);
<a name="l03996"></a>03996         <span class="keywordflow">else</span> {
<a name="l03997"></a>03997             <span class="comment">/* Children are up to date, nothing to do. */</span>
<a name="l03998"></a>03998         }
<a name="l03999"></a>03999     }
<a name="l04000"></a>04000     <span class="keywordflow">else</span>
<a name="l04001"></a>04001         <a class="code" href="../../db/dca/BKE__particle_8h.html#a82ab987ec4146bf9fa326003872470bb">psys_free_children</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l04002"></a>04002 }
<a name="l04003"></a>04003 <span class="comment">/* updates cached particles&#39; alive &amp; other flags etc..*/</span>
<a name="l04004"></a><a class="code" href="../../df/d40/particle__system_8c.html#a8654f7a06c0605b27422e9c82c5ddc6d">04004</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a8654f7a06c0605b27422e9c82c5ddc6d">cached_step</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> cfra)
<a name="l04005"></a>04005 {
<a name="l04006"></a>04006     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l04007"></a>04007     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04008"></a>04008     <a class="code" href="../../d8/d60/structParticleTexture.html">ParticleTexture</a> ptex;
<a name="l04009"></a>04009     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l04010"></a>04010     <span class="keywordtype">float</span> disp, dietime;
<a name="l04011"></a>04011 
<a name="l04012"></a>04012     <a class="code" href="../../df/d40/particle__system_8c.html#aa9b2d7bc7dcda6cfced08e18adbf2acb">psys_update_effectors</a>(sim);
<a name="l04013"></a>04013     
<a name="l04014"></a>04014     disp= (float)<a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">psys_get_current_display_percentage</a>(psys)/100.0f;
<a name="l04015"></a>04015 
<a name="l04016"></a>04016     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l04017"></a>04017         <a class="code" href="../../db/dca/BKE__particle_8h.html#acf1c957ad3abf411912b722c20a385a6">psys_get_texture</a>(sim, pa, &amp;ptex, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7e633bb8a8c28e52c7b7507536c33300">PAMAP_SIZE</a>, cfra);
<a name="l04018"></a>04018         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a776e1928583df9d19b41cc90e6fb42c8">size</a>*ptex.<a class="code" href="../../d8/d60/structParticleTexture.html#acf699d1b168d47232dd4c710ec8beb55">size</a>;
<a name="l04019"></a>04019         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> &gt; 0.0f)
<a name="l04020"></a>04020             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 1);
<a name="l04021"></a>04021 
<a name="l04022"></a>04022         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../db/dca/BKE__particle_8h.html#a7f29db3949d983f1e222f2c5bb1a2a91">psys_get_lattice</a>(sim);
<a name="l04023"></a>04023 
<a name="l04024"></a>04024         dietime = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>;
<a name="l04025"></a>04025 
<a name="l04026"></a>04026         <span class="comment">/* update alive status and push events */</span>
<a name="l04027"></a>04027         <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &gt; cfra) {
<a name="l04028"></a>04028             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae26eb239d67b64da7b2afef89052c50d">PARS_UNBORN</a>;
<a name="l04029"></a>04029             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a89887736df27c700e59ef81204839e3c">PART_UNBORN</a> &amp;&amp; (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>) == 0)
<a name="l04030"></a>04030                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(sim, pa, 0.0f, cfra);
<a name="l04031"></a>04031         }
<a name="l04032"></a>04032         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dietime &lt;= cfra)
<a name="l04033"></a>04033             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a9f632cd1991990d1c11a712993d733dd">PARS_DEAD</a>;
<a name="l04034"></a>04034         <span class="keywordflow">else</span>
<a name="l04035"></a>04035             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>;
<a name="l04036"></a>04036 
<a name="l04037"></a>04037         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>) {
<a name="l04038"></a>04038             <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>);
<a name="l04039"></a>04039             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04040"></a>04040         }
<a name="l04041"></a>04041 
<a name="l04042"></a>04042         <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p) &gt; disp)
<a name="l04043"></a>04043             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04044"></a>04044         <span class="keywordflow">else</span>
<a name="l04045"></a>04045             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04046"></a>04046     }
<a name="l04047"></a>04047 }
<a name="l04048"></a>04048 
<a name="l04049"></a><a class="code" href="../../df/d40/particle__system_8c.html#aa50844e6d7ccf13e6f546c4205a61805">04049</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aa50844e6d7ccf13e6f546c4205a61805">particles_fluid_step</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l04050"></a>04050 {   
<a name="l04051"></a>04051     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l04052"></a>04052     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>) {
<a name="l04053"></a>04053         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>);
<a name="l04054"></a>04054         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> = 0;
<a name="l04055"></a>04055         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> = 0;
<a name="l04056"></a>04056     }
<a name="l04057"></a>04057 
<a name="l04058"></a>04058     <span class="comment">/* fluid sim particle import handling, actual loading of particles from file */</span>
<a name="l04059"></a>04059 <span class="preprocessor">    #ifdef WITH_MOD_FLUID</span>
<a name="l04060"></a>04060 <span class="preprocessor"></span>    {
<a name="l04061"></a>04061         <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l04062"></a>04062         
<a name="l04063"></a>04063         <span class="keywordflow">if</span> ( fluidmd &amp;&amp; fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>) { 
<a name="l04064"></a>04064             <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss= fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>;
<a name="l04065"></a>04065             <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04066"></a>04066             <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04067"></a>04067             <span class="keywordtype">char</span> filename[256];
<a name="l04068"></a>04068             <span class="keywordtype">char</span> debugStrBuffer[256];
<a name="l04069"></a>04069             <span class="keywordtype">int</span>  curFrame = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> -1; <span class="comment">// warning - sync with derived mesh fsmesh loading</span>
<a name="l04070"></a>04070             <span class="keywordtype">int</span>  <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, j, totpart;
<a name="l04071"></a>04071             <span class="keywordtype">int</span> readMask, activeParts = 0, fileParts = 0;
<a name="l04072"></a>04072             gzFile gzf;
<a name="l04073"></a>04073     
<a name="l04074"></a>04074 <span class="comment">// XXX          if (ob==G.obedit) // off...</span>
<a name="l04075"></a>04075 <span class="comment">//              return;</span>
<a name="l04076"></a>04076 
<a name="l04077"></a>04077             <span class="comment">// ok, start loading</span>
<a name="l04078"></a>04078             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(filename, <span class="keyword">sizeof</span>(filename), fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#ae68e04f5195b89773d02585e58bb8106">OB_FLUIDSIM_SURF_PARTICLES_FNAME</a>);
<a name="l04079"></a>04079 
<a name="l04080"></a>04080             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(filename, <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a0e4a2d2784b8ca3c1b20c7268e1e68b4">modifier_path_relbase</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>));
<a name="l04081"></a>04081 
<a name="l04082"></a>04082             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a57e90c5ab9a8c42672bb881833b4bde0">BLI_path_frame</a>(filename, curFrame, 0); <span class="comment">// fixed #frame-no </span>
<a name="l04083"></a>04083 
<a name="l04084"></a>04084             gzf = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a4fbe331d32207c2937389e1d330bd7ff">BLI_gzopen</a>(filename, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l04085"></a>04085             <span class="keywordflow">if</span> (!gzf) {
<a name="l04086"></a>04086                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer, <span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;readFsPartData::error - Unable to open file for reading &#39;%s&#39;\n&quot;</span>, filename);
<a name="l04087"></a>04087                 <span class="comment">// XXX bad level call elbeemDebugOut(debugStrBuffer);</span>
<a name="l04088"></a>04088                 <span class="keywordflow">return</span>;
<a name="l04089"></a>04089             }
<a name="l04090"></a>04090     
<a name="l04091"></a>04091             gzread(gzf, &amp;totpart, <span class="keyword">sizeof</span>(totpart));
<a name="l04092"></a>04092             totpart = (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering)?totpart:(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae487721b04b5b6187f39a9e768d4630b">disp</a>*totpart)/100;
<a name="l04093"></a>04093             
<a name="l04094"></a>04094             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a987ea41fe09e95054533124966636aca">totpart</a>= totpart;
<a name="l04095"></a>04095             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a>=part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aaad187f6e55e19af7964ef74ef2f7b41">end</a> = 1.0f;
<a name="l04096"></a>04096             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad24d73f074832de37255a2f3cb1c16d0">lifetime</a> = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a> + 1;
<a name="l04097"></a>04097     
<a name="l04098"></a>04098             <span class="comment">/* allocate particles */</span>
<a name="l04099"></a>04099             <a class="code" href="../../df/d40/particle__system_8c.html#aef983187092ea570b9af5b7336c019f7">realloc_particles</a>(sim, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a987ea41fe09e95054533124966636aca">totpart</a>);
<a name="l04100"></a>04100     
<a name="l04101"></a>04101             <span class="comment">// set up reading mask</span>
<a name="l04102"></a>04102             readMask = fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a>;
<a name="l04103"></a>04103             
<a name="l04104"></a>04104             <span class="keywordflow">for</span> (p=0, pa=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>; p&lt;totpart; p++, pa++) {
<a name="l04105"></a>04105                 <span class="keywordtype">int</span> ptype=0;
<a name="l04106"></a>04106     
<a name="l04107"></a>04107                 gzread(gzf, &amp;ptype, <span class="keyword">sizeof</span>( ptype )); 
<a name="l04108"></a>04108                 <span class="keywordflow">if</span> (ptype&amp;readMask) {
<a name="l04109"></a>04109                     activeParts++;
<a name="l04110"></a>04110     
<a name="l04111"></a>04111                     gzread(gzf, &amp;(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>), <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> )); 
<a name="l04112"></a>04112     
<a name="l04113"></a>04113                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> /= 10.0f;
<a name="l04114"></a>04114     
<a name="l04115"></a>04115                     <span class="keywordflow">for</span> (j=0; j&lt;3; j++) {
<a name="l04116"></a>04116                         <span class="keywordtype">float</span> wrf;
<a name="l04117"></a>04117                         gzread(gzf, &amp;wrf, <span class="keyword">sizeof</span>( wrf )); 
<a name="l04118"></a>04118                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>[j] = wrf;
<a name="l04119"></a>04119                         <span class="comment">//fprintf(stderr,&quot;Rj%d &quot;,j);</span>
<a name="l04120"></a>04120                     }
<a name="l04121"></a>04121                     <span class="keywordflow">for</span> (j=0; j&lt;3; j++) {
<a name="l04122"></a>04122                         <span class="keywordtype">float</span> wrf;
<a name="l04123"></a>04123                         gzread(gzf, &amp;wrf, <span class="keyword">sizeof</span>( wrf )); 
<a name="l04124"></a>04124                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>[j] = wrf;
<a name="l04125"></a>04125                     }
<a name="l04126"></a>04126     
<a name="l04127"></a>04127                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[0] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[1] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>[2] = 0.0f;
<a name="l04128"></a>04128                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[0] = 1.0;
<a name="l04129"></a>04129                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[1] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[2] = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[3] = 0.0;
<a name="l04130"></a>04130     
<a name="l04131"></a>04131                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> = 1.f;
<a name="l04132"></a>04132                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a> + 1;
<a name="l04133"></a>04133                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a> = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>;
<a name="l04134"></a>04134                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a1cd229fd51e71006edb2e849b492e5ec">alive</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abd3b562441165347f8d70e1458aeacaa">PARS_ALIVE</a>;
<a name="l04135"></a>04135                     <span class="comment">//if (a &lt; 25) fprintf(stderr,&quot;FSPARTICLE debug set %s , a%d = %f,%f,%f , life=%f\n&quot;, filename, a, pa-&gt;co[0],pa-&gt;co[1],pa-&gt;co[2], pa-&gt;lifetime );</span>
<a name="l04136"></a>04136                 }
<a name="l04137"></a>04137                 <span class="keywordflow">else</span> {
<a name="l04138"></a>04138                     <span class="comment">// skip...</span>
<a name="l04139"></a>04139                     <span class="keywordflow">for</span> (j=0; j&lt;2*3+1; j++) {
<a name="l04140"></a>04140                         <span class="keywordtype">float</span> wrf; gzread(gzf, &amp;wrf, <span class="keyword">sizeof</span>( wrf )); 
<a name="l04141"></a>04141                     }
<a name="l04142"></a>04142                 }
<a name="l04143"></a>04143                 fileParts++;
<a name="l04144"></a>04144             }
<a name="l04145"></a>04145             gzclose(gzf);
<a name="l04146"></a>04146     
<a name="l04147"></a>04147             totpart = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> = activeParts;
<a name="l04148"></a>04148             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer,<span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;readFsPartData::done - particles:%d, active:%d, file:%d, mask:%d\n&quot;</span>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>,activeParts,fileParts,readMask);
<a name="l04149"></a>04149             <span class="comment">// bad level call</span>
<a name="l04150"></a>04150             <span class="comment">// XXX elbeemDebugOut(debugStrBuffer);</span>
<a name="l04151"></a>04151             
<a name="l04152"></a>04152         } <span class="comment">// fluid sim particles done</span>
<a name="l04153"></a>04153     }
<a name="l04154"></a>04154 <span class="preprocessor">    #endif // WITH_MOD_FLUID</span>
<a name="l04155"></a>04155 <span class="preprocessor"></span>}
<a name="l04156"></a>04156 
<a name="l04157"></a><a class="code" href="../../df/d40/particle__system_8c.html#ada3b59f53ea08364a5e2d2d065a9517b">04157</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#ada3b59f53ea08364a5e2d2d065a9517b">emit_particles</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l04158"></a>04158 {
<a name="l04159"></a>04159     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l04160"></a>04160     <span class="keywordtype">int</span> oldtotpart = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l04161"></a>04161     <span class="keywordtype">int</span> totpart = <a class="code" href="../../df/d40/particle__system_8c.html#a51344d20e820314d05f85fb5a6e3b6bd">tot_particles</a>(psys, pid);
<a name="l04162"></a>04162 
<a name="l04163"></a>04163     <span class="keywordflow">if</span> (totpart != oldtotpart)
<a name="l04164"></a>04164         <a class="code" href="../../df/d40/particle__system_8c.html#aef983187092ea570b9af5b7336c019f7">realloc_particles</a>(sim, totpart);
<a name="l04165"></a>04165 
<a name="l04166"></a>04166     <span class="keywordflow">return</span> totpart - oldtotpart;
<a name="l04167"></a>04167 }
<a name="l04168"></a>04168 
<a name="l04169"></a>04169 <span class="comment">/* Calculates the next state for all particles of the system</span>
<a name="l04170"></a>04170 <span class="comment"> * In particles code most fra-ending are frames, time-ending are fra*timestep (seconds)</span>
<a name="l04171"></a>04171 <span class="comment"> * 1. Emit particles</span>
<a name="l04172"></a>04172 <span class="comment"> * 2. Check cache (if used) and return if frame is cached</span>
<a name="l04173"></a>04173 <span class="comment"> * 3. Do dynamics</span>
<a name="l04174"></a>04174 <span class="comment"> * 4. Save to cache */</span>
<a name="l04175"></a><a class="code" href="../../df/d40/particle__system_8c.html#af1a2d4fd957db8242cbad1e9b4fa3117">04175</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#af1a2d4fd957db8242cbad1e9b4fa3117">system_step</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim, <span class="keywordtype">float</span> cfra)
<a name="l04176"></a>04176 {
<a name="l04177"></a>04177     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>;
<a name="l04178"></a>04178     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04179"></a>04179     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>;
<a name="l04180"></a>04180     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> ptcacheid, *pid = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04181"></a>04181     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l04182"></a>04182     <span class="keywordtype">float</span> disp, cache_cfra = cfra; <span class="comment">/*, *vg_vel= 0, *vg_tan= 0, *vg_rot= 0, *vg_size= 0; */</span>
<a name="l04183"></a>04183     <span class="keywordtype">int</span> startframe = 0, endframe = 100, oldtotpart = 0;
<a name="l04184"></a>04184 
<a name="l04185"></a>04185     <span class="comment">/* cache shouldn&#39;t be used for hair or &quot;continue physics&quot; */</span>
<a name="l04186"></a>04186     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a34764119fdcd6197dceb78b4181e6e3b">BKE_ptcache_get_continue_physics</a>() == 0) {
<a name="l04187"></a>04187         <a class="code" href="../../df/d40/particle__system_8c.html#ad0c2de08fc7877137e6d8e2c203b7a28">psys_clear_temp_pointcache</a>(psys);
<a name="l04188"></a>04188 
<a name="l04189"></a>04189         <span class="comment">/* set suitable cache range automatically */</span>
<a name="l04190"></a>04190         <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; (<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>))==0)
<a name="l04191"></a>04191             <a class="code" href="../../db/dca/BKE__particle_8h.html#a4eb47a384d089ddb5b3c91ae3e8ae07a">psys_get_pointcache_start_end</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, psys, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>);
<a name="l04192"></a>04192 
<a name="l04193"></a>04193         pid = &amp;ptcacheid;
<a name="l04194"></a>04194         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(pid, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, psys);
<a name="l04195"></a>04195         
<a name="l04196"></a>04196         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a3b3321b3ad61b23a9c227a438281ad14">BKE_ptcache_id_time</a>(pid, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, 0.0f, &amp;startframe, &amp;endframe, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04197"></a>04197 
<a name="l04198"></a>04198         <span class="comment">/* clear everythin on start frame */</span>
<a name="l04199"></a>04199         <span class="keywordflow">if</span> (cfra == startframe) {
<a name="l04200"></a>04200             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>, pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0da786e671a578f5467e04bcfdb99e4">PTCACHE_RESET_OUTDATED</a>);
<a name="l04201"></a>04201             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, startframe);
<a name="l04202"></a>04202             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>;
<a name="l04203"></a>04203         }
<a name="l04204"></a>04204         
<a name="l04205"></a>04205         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(cache_cfra, startframe, endframe);
<a name="l04206"></a>04206     }
<a name="l04207"></a>04207 
<a name="l04208"></a>04208 <span class="comment">/* 1. emit particles and redo particles if needed */</span>
<a name="l04209"></a>04209     oldtotpart = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l04210"></a>04210     <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#ada3b59f53ea08364a5e2d2d065a9517b">emit_particles</a>(sim, pid, cfra) || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>) {
<a name="l04211"></a>04211         <a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">distribute_particles</a>(sim, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>);
<a name="l04212"></a>04212         <a class="code" href="../../df/d40/particle__system_8c.html#add4524669eb21d40d95fc9af2d71aaac">initialize_all_particles</a>(sim);
<a name="l04213"></a>04213         <span class="comment">/* reset only just created particles (on startframe all particles are recreated) */</span>
<a name="l04214"></a>04214         <a class="code" href="../../df/d40/particle__system_8c.html#aaccab291bfa9cca97a0921409bac1c37">reset_all_particles</a>(sim, 0.0, cfra, oldtotpart);
<a name="l04215"></a>04215 
<a name="l04216"></a>04216         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>) {
<a name="l04217"></a>04217             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>);
<a name="l04218"></a>04218             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04219"></a>04219         }
<a name="l04220"></a>04220 
<a name="l04221"></a>04221         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> = 0;
<a name="l04222"></a>04222 
<a name="l04223"></a>04223         <span class="comment">/* flag for possible explode modifiers after this system */</span>
<a name="l04224"></a>04224         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#abc843013a6e93e2d94b3f45ac8fed2c9">flag</a> |= <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a4f03f9ddb8ddeabea182daaa994650afa52dbe6f11d2ae384b04028a2ccc4a332">eParticleSystemFlag_Pars</a>;
<a name="l04225"></a>04225 
<a name="l04226"></a>04226         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a>, cfra);
<a name="l04227"></a>04227     }
<a name="l04228"></a>04228 
<a name="l04229"></a>04229 <span class="comment">/* 2. try to read from the cache */</span>
<a name="l04230"></a>04230     <span class="keywordflow">if</span> (pid) {
<a name="l04231"></a>04231         <span class="keywordtype">int</span> cache_result = <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a707b45e87667b28ce4c28d7af981d015">BKE_ptcache_read</a>(pid, cache_cfra);
<a name="l04232"></a>04232 
<a name="l04233"></a>04233         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(cache_result, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af66510109c41fe8841cfef13e1548950">PTCACHE_READ_EXACT</a>, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a87c0cf2703ad8da6444507a50f1f31b3">PTCACHE_READ_INTERPOLATED</a>)) {
<a name="l04234"></a>04234             <a class="code" href="../../df/d40/particle__system_8c.html#a8654f7a06c0605b27422e9c82c5ddc6d">cached_step</a>(sim, cfra);
<a name="l04235"></a>04235             <a class="code" href="../../df/d40/particle__system_8c.html#a8604c136f8d06ea824571a7e789393bc">update_children</a>(sim);
<a name="l04236"></a>04236             <a class="code" href="../../df/d40/particle__system_8c.html#af211e7a44c8a798b553ed08bc9045f5b">psys_update_path_cache</a>(sim, cfra);
<a name="l04237"></a>04237 
<a name="l04238"></a>04238             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, (<span class="keywordtype">int</span>)cache_cfra);
<a name="l04239"></a>04239 
<a name="l04240"></a>04240             <span class="keywordflow">if</span> (cache_result == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a87c0cf2703ad8da6444507a50f1f31b3">PTCACHE_READ_INTERPOLATED</a> &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>)
<a name="l04241"></a>04241                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, (<span class="keywordtype">int</span>)cache_cfra);
<a name="l04242"></a>04242 
<a name="l04243"></a>04243             <span class="keywordflow">return</span>;
<a name="l04244"></a>04244         }
<a name="l04245"></a>04245         <span class="comment">/* Cache is supposed to be baked, but no data was found so bail out */</span>
<a name="l04246"></a>04246         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>) {
<a name="l04247"></a>04247             <a class="code" href="../../db/dca/BKE__particle_8h.html#a686244657da3b6f9c17f52070e5cd4b4">psys_reset</a>(psys, <a class="code" href="../../db/dca/BKE__particle_8h.html#a8a3147d568795fdb59169e7e6325bad4">PSYS_RESET_CACHE_MISS</a>);
<a name="l04248"></a>04248             <span class="keywordflow">return</span>;
<a name="l04249"></a>04249         }
<a name="l04250"></a>04250         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cache_result == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aa462ff2d6af45758c0d40956a93c1e37">PTCACHE_READ_OLD</a>) {
<a name="l04251"></a>04251             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> = (float)cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a>;
<a name="l04252"></a>04252             <a class="code" href="../../df/d40/particle__system_8c.html#a8654f7a06c0605b27422e9c82c5ddc6d">cached_step</a>(sim, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>);
<a name="l04253"></a>04253         }
<a name="l04254"></a>04254 
<a name="l04255"></a>04255         <span class="comment">/* if on second frame, write cache for first frame */</span>
<a name="l04256"></a>04256         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> == startframe &amp;&amp; (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a> || cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>==0))
<a name="l04257"></a>04257             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, startframe);
<a name="l04258"></a>04258     }
<a name="l04259"></a>04259     <span class="keywordflow">else</span>
<a name="l04260"></a>04260         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l04261"></a>04261 
<a name="l04262"></a>04262 <span class="comment">/* 3. do dynamics */</span>
<a name="l04263"></a>04263     <span class="comment">/* set particles to be not calculated TODO: can&#39;t work with pointcache */</span>
<a name="l04264"></a>04264     disp= (float)<a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">psys_get_current_display_percentage</a>(psys)/100.0f;
<a name="l04265"></a>04265 
<a name="l04266"></a>04266     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a> {
<a name="l04267"></a>04267         <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p) &gt; disp)
<a name="l04268"></a>04268             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04269"></a>04269         <span class="keywordflow">else</span>
<a name="l04270"></a>04270             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04271"></a>04271     }
<a name="l04272"></a>04272 
<a name="l04273"></a>04273     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>) {
<a name="l04274"></a>04274         <span class="keywordtype">int</span> dframe, totframesback = 0;
<a name="l04275"></a>04275         <span class="keywordtype">float</span> t_frac, dt_frac;
<a name="l04276"></a>04276 
<a name="l04277"></a>04277         <span class="comment">/* handle negative frame start at the first frame by doing</span>
<a name="l04278"></a>04278 <span class="comment">         * all the steps before the first frame */</span>
<a name="l04279"></a>04279         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)cfra == startframe &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a> &lt; startframe)
<a name="l04280"></a>04280             totframesback = (startframe - (<span class="keywordtype">int</span>)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa177c3d303d19c10eb2ad99fa6fc76dc">sta</a>);
<a name="l04281"></a>04281 
<a name="l04282"></a>04282         <span class="keywordflow">if</span> (!(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a87b70b67957deff5879733ebe0199189">time_flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3668a7bcb08c9f9af95dd5a2d4b1867b">PART_TIME_AUTOSF</a>)) {
<a name="l04283"></a>04283             <span class="comment">/* Constant time step */</span>
<a name="l04284"></a>04284             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> = 1.0f / (float) (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a06b06f806fbf875d9ca4728e46b05697">subframes</a> + 1);
<a name="l04285"></a>04285         }
<a name="l04286"></a>04286         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)cfra == startframe) {
<a name="l04287"></a>04287             <span class="comment">/* Variable time step; use a very conservative value at the start.</span>
<a name="l04288"></a>04288 <span class="comment">             * If it doesn&#39;t need to be so small, it will quickly grow. */</span>
<a name="l04289"></a>04289             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> = 1.0;
<a name="l04290"></a>04290         }
<a name="l04291"></a>04291         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> &lt; <a class="code" href="../../df/d40/particle__system_8c.html#ac7ec50fa7e0f9e74874ec0e48a6e5770">MIN_TIMESTEP</a>) {
<a name="l04292"></a>04292             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a> = <a class="code" href="../../df/d40/particle__system_8c.html#ac7ec50fa7e0f9e74874ec0e48a6e5770">MIN_TIMESTEP</a>;
<a name="l04293"></a>04293         }
<a name="l04294"></a>04294 
<a name="l04295"></a>04295         <span class="keywordflow">for</span> (dframe=-totframesback; dframe&lt;=0; dframe++) {
<a name="l04296"></a>04296             <span class="comment">/* simulate each subframe */</span>
<a name="l04297"></a>04297             dt_frac = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a9756872b0ad4fd129d320211ababa2df">dt_frac</a>;
<a name="l04298"></a>04298             <span class="keywordflow">for</span> (t_frac = dt_frac; t_frac &lt;= 1.0f; t_frac += dt_frac) {
<a name="l04299"></a>04299                 sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a> = 0.0f;
<a name="l04300"></a>04300                 <a class="code" href="../../df/d40/particle__system_8c.html#a2aa9a57b38399ad6ad2164a9ec3e5f6e">dynamics_step</a>(sim, cfra+dframe+t_frac - 1.f);
<a name="l04301"></a>04301                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> = cfra+dframe+t_frac - 1.f;
<a name="l04302"></a>04302 <span class="preprocessor">#if 0</span>
<a name="l04303"></a>04303 <span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;%f,%f,%f,%f\n&quot;</span>, cfra+dframe+t_frac - 1.f, t_frac, dt_frac, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a196f327be0f44079a1a5cb5525198e85">courant_num</a>);
<a name="l04304"></a>04304 <span class="preprocessor">#endif</span>
<a name="l04305"></a>04305 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a87b70b67957deff5879733ebe0199189">time_flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3668a7bcb08c9f9af95dd5a2d4b1867b">PART_TIME_AUTOSF</a>)
<a name="l04306"></a>04306                     dt_frac = <a class="code" href="../../df/d40/particle__system_8c.html#ab8dfb99e190a0cc95e4d2f7a7e7f66f5">update_timestep</a>(psys, sim, t_frac);
<a name="l04307"></a>04307             }
<a name="l04308"></a>04308         }
<a name="l04309"></a>04309     }
<a name="l04310"></a>04310     
<a name="l04311"></a>04311 <span class="comment">/* 4. only write cache starting from second frame */</span>
<a name="l04312"></a>04312     <span class="keywordflow">if</span> (pid) {
<a name="l04313"></a>04313         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(cache, (<span class="keywordtype">int</span>)cache_cfra);
<a name="l04314"></a>04314         <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)cache_cfra != startframe)
<a name="l04315"></a>04315             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, (<span class="keywordtype">int</span>)cache_cfra);
<a name="l04316"></a>04316     }
<a name="l04317"></a>04317 
<a name="l04318"></a>04318     <a class="code" href="../../df/d40/particle__system_8c.html#a8604c136f8d06ea824571a7e789393bc">update_children</a>(sim);
<a name="l04319"></a>04319 
<a name="l04320"></a>04320 <span class="comment">/* cleanup */</span>
<a name="l04321"></a>04321     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>) {
<a name="l04322"></a>04322         <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>);
<a name="l04323"></a>04323         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04324"></a>04324     }
<a name="l04325"></a>04325 }
<a name="l04326"></a>04326 
<a name="l04327"></a>04327 <span class="comment">/* system type has changed so set sensible defaults and clear non applicable flags */</span>
<a name="l04328"></a><a class="code" href="../../df/d40/particle__system_8c.html#a32c54eba2930f1f852e7b9aace395fea">04328</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a32c54eba2930f1f852e7b9aace395fea">psys_changed_type</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l04329"></a>04329 {
<a name="l04330"></a>04330     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04331"></a>04331     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> pid;
<a name="l04332"></a>04332 
<a name="l04333"></a>04333     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(&amp;pid, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l04334"></a>04334 
<a name="l04335"></a>04335     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>)
<a name="l04336"></a>04336         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l04337"></a>04337 
<a name="l04338"></a>04338     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>) {
<a name="l04339"></a>04339         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a55688d6811f05b2d3fc30fcfe9805218">PART_DRAW_NOT</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2506fdc9f159583f812c900402c5ec54">PART_DRAW_OB</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ababc8a40b78ea25bfdb9cd7b85c83f19">PART_DRAW_GR</a>)==0)
<a name="l04340"></a>04340             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a>;
<a name="l04341"></a>04341 
<a name="l04342"></a>04342         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93c2418e9c7c39a31da98a0ccbf31363">PART_DISTR_GRID</a>)
<a name="l04343"></a>04343             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a97865c6208d50cebb5cb825cfdd936d2">distr</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a76c24af3e61b9d908298b0febc6511c4">PART_DISTR_JIT</a>;
<a name="l04344"></a>04344 
<a name="l04345"></a>04345         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a675fa9a30bd2105087a98d138c6df66c">draw_as</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a55688d6811f05b2d3fc30fcfe9805218">PART_DRAW_NOT</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a4c845dcc070e77eedb10185fc4d61d06">PART_DRAW_REND</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a>)==0)
<a name="l04346"></a>04346             part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a675fa9a30bd2105087a98d138c6df66c">draw_as</a> = <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a4c845dcc070e77eedb10185fc4d61d06">PART_DRAW_REND</a>;
<a name="l04347"></a>04347 
<a name="l04348"></a>04348         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a134ea98c79f925fcda45f10ad3395cdc">path_start</a>, 0.0f, 100.0f);
<a name="l04349"></a>04349         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a15135d6b7e6634c4b7411a842b64a4ad">path_end</a>, 0.0f, 100.0f);
<a name="l04350"></a>04350 
<a name="l04351"></a>04351         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(&amp;pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l04352"></a>04352     }
<a name="l04353"></a>04353     <span class="keywordflow">else</span> {
<a name="l04354"></a>04354         <a class="code" href="../../db/dca/BKE__particle_8h.html#ad4a4c0273bdebb56a63e5b6f93b089c0">free_hair</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, 1);
<a name="l04355"></a>04355 
<a name="l04356"></a>04356         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a134ea98c79f925fcda45f10ad3395cdc">path_start</a>, 0.0f, <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(100.0f, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aaad187f6e55e19af7964ef74ef2f7b41">end</a> + part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad24d73f074832de37255a2f3cb1c16d0">lifetime</a>));
<a name="l04357"></a>04357         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a15135d6b7e6634c4b7411a842b64a4ad">path_end</a>, 0.0f, <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(100.0f, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aaad187f6e55e19af7964ef74ef2f7b41">end</a> + part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad24d73f074832de37255a2f3cb1c16d0">lifetime</a>));
<a name="l04358"></a>04358     }
<a name="l04359"></a>04359 
<a name="l04360"></a>04360     <a class="code" href="../../db/dca/BKE__particle_8h.html#a686244657da3b6f9c17f52070e5cd4b4">psys_reset</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>, <a class="code" href="../../db/dca/BKE__particle_8h.html#aac0cee343bc36395e4bec4851c8f0ab3">PSYS_RESET_ALL</a>);
<a name="l04361"></a>04361 }
<a name="l04362"></a><a class="code" href="../../df/d40/particle__system_8c.html#ae69b050f93ee9f52563b24d1701d94ae">04362</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#aa5f9470220acee4b740afbae7f0378f6">psys_check_boid_data</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l04363"></a>04363 {
<a name="l04364"></a>04364         <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *bpa;
<a name="l04365"></a>04365         <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l04366"></a>04366 
<a name="l04367"></a>04367         pa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l04368"></a>04368 
<a name="l04369"></a>04369         <span class="keywordflow">if</span> (!pa)
<a name="l04370"></a>04370             <span class="keywordflow">return</span>;
<a name="l04371"></a>04371 
<a name="l04372"></a>04372         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>) {
<a name="l04373"></a>04373             <span class="keywordflow">if</span> (!pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>) {
<a name="l04374"></a>04374                 bpa = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a>), <span class="stringliteral">&quot;Boid Data&quot;</span>);
<a name="l04375"></a>04375 
<a name="l04376"></a>04376                 <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l04377"></a>04377                     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a> = bpa++;
<a name="l04378"></a>04378             }
<a name="l04379"></a>04379         }
<a name="l04380"></a>04380         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>) {
<a name="l04381"></a>04381             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a>);
<a name="l04382"></a>04382             <a class="code" href="../../db/dca/BKE__particle_8h.html#aa06abf4e4789623e56a63ba561394fcf">LOOP_PARTICLES</a>
<a name="l04383"></a>04383                 pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04384"></a>04384         }
<a name="l04385"></a>04385 }
<a name="l04386"></a>04386 
<a name="l04387"></a><a class="code" href="../../df/d40/particle__system_8c.html#aae675d22e20ff6650e5086d2ec577022">04387</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#aae675d22e20ff6650e5086d2ec577022">fluid_default_settings</a>(<a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part)
<a name="l04388"></a>04388 {
<a name="l04389"></a>04389     <a class="code" href="../../dc/dec/structSPHFluidSettings.html">SPHFluidSettings</a> *fluid = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>;
<a name="l04390"></a>04390 
<a name="l04391"></a>04391     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a741e28e1248ae13c22a4005957ac91af">spring_k</a> = 0.f;
<a name="l04392"></a>04392     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#aaa124eaea3771050852377fb7016c998">plasticity_constant</a> = 0.1f;
<a name="l04393"></a>04393     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#afb71873140a34fb9f23f0df84c695e02">yield_ratio</a> = 0.1f;
<a name="l04394"></a>04394     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a1735770145f57a726145c62e4febdd32">rest_length</a> = 1.f;
<a name="l04395"></a>04395     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a1260d04b9f6de9be921a6fe51f4c2161">viscosity_omega</a> = 2.f;
<a name="l04396"></a>04396     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a638fd519a54ce0f1e80403096053cf10">viscosity_beta</a> = 0.1f;
<a name="l04397"></a>04397     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#ae8c9e7bb63f9b3df64315bf1251e63fb">stiffness_k</a> = 1.f;
<a name="l04398"></a>04398     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a6f50b5b42b1ba89370dfb018ce5520a3">stiffness_knear</a> = 1.f;
<a name="l04399"></a>04399     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a02ffbdbc2fd53c6a07ff4d15b7b5cf2d">rest_density</a> = 1.f;
<a name="l04400"></a>04400     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3bdcb3d8df6f6018da1e99b15d00cb75">buoyancy</a> = 0.f;
<a name="l04401"></a>04401     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a3c862176cec0f6d154b586c95cb3eef9">radius</a> = 1.f;
<a name="l04402"></a>04402     fluid-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a93aa7174a2fa964091451ea4b416638d">SPH_FAC_REPULSION</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a807a2c378806c6f97fe123fa241be237">SPH_FAC_DENSITY</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a73860b1cccbd3d53f68d5866349a22b5">SPH_FAC_RADIUS</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8d0765504fa2fc04012e5b6f5579beb7">SPH_FAC_VISCOSITY</a>|<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a998a03e8c54b5f2f64e39bb7d72dffeb">SPH_FAC_REST_LENGTH</a>;
<a name="l04403"></a>04403 }
<a name="l04404"></a>04404 
<a name="l04405"></a><a class="code" href="../../df/d40/particle__system_8c.html#a37c30ebe40967b733817fc7f9dda6541">04405</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d40/particle__system_8c.html#a37c30ebe40967b733817fc7f9dda6541">psys_prepare_physics</a>(<a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> *sim)
<a name="l04406"></a>04406 {
<a name="l04407"></a>04407     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04408"></a>04408 
<a name="l04409"></a>04409     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aaaa65883b0fd34e1f66db33d0e55ef9e">PART_PHYS_NO</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>)) {
<a name="l04410"></a>04410         <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> pid;
<a name="l04411"></a>04411         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(&amp;pid, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>, sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l04412"></a>04412         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(&amp;pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l04413"></a>04413     }
<a name="l04414"></a>04414     <span class="keywordflow">else</span> {
<a name="l04415"></a>04415         <a class="code" href="../../db/dca/BKE__particle_8h.html#a8325d53f262b836a28783e7fa06c6adf">free_keyed_keys</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l04416"></a>04416         sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a789523a2c52fbcea1f0dd066be9895d2">PSYS_KEYED</a>;
<a name="l04417"></a>04417     }
<a name="l04418"></a>04418 
<a name="l04419"></a>04419     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04420"></a>04420         <a class="code" href="../../db/dfa/structBoidState.html">BoidState</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>;
<a name="l04421"></a>04421 
<a name="l04422"></a>04422         part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d94/structBoidSettings.html">BoidSettings</a>), <span class="stringliteral">&quot;Boid Settings&quot;</span>);
<a name="l04423"></a>04423         <a class="code" href="../../d8/db3/BKE__boids_8h.html#afad7b879530511e21a139df70f9208d3">boid_default_settings</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>);
<a name="l04424"></a>04424 
<a name="l04425"></a>04425         state = <a class="code" href="../../d8/db3/BKE__boids_8h.html#a3bf43eb666d0a2b14fad47bcb4a17fc1">boid_new_state</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>);
<a name="l04426"></a>04426         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;state-&gt;<a class="code" href="../../db/dfa/structBoidState.html#ad8d710f50d63b84e59b358315bc9fa92">rules</a>, <a class="code" href="../../d8/db3/BKE__boids_8h.html#a6781a25f7819ee493c5c348bdad3a5f4">boid_new_rule</a>(<a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a186fa849c8c3a6efa9ca9d740700efe9a563e4ac4b376a0dda4f84e256b87de0f">eBoidRuleType_Separate</a>));
<a name="l04427"></a>04427         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;state-&gt;<a class="code" href="../../db/dfa/structBoidState.html#ad8d710f50d63b84e59b358315bc9fa92">rules</a>, <a class="code" href="../../d8/db3/BKE__boids_8h.html#a6781a25f7819ee493c5c348bdad3a5f4">boid_new_rule</a>(<a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a186fa849c8c3a6efa9ca9d740700efe9a2404bac397416ae768facc8686f5a169">eBoidRuleType_Flock</a>));
<a name="l04428"></a>04428 
<a name="l04429"></a>04429         ((<a class="code" href="../../d5/d08/structBoidRule.html">BoidRule</a>*)state-&gt;<a class="code" href="../../db/dfa/structBoidState.html#ad8d710f50d63b84e59b358315bc9fa92">rules</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;flag |= <a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a8166e38d02535b559fc17ee306062c44">BOIDRULE_CURRENT</a>;
<a name="l04430"></a>04430 
<a name="l04431"></a>04431         state-&gt;<a class="code" href="../../db/dfa/structBoidState.html#a788d06e221d26fe2e7d470372beb1a63">flag</a> |= <a class="code" href="../../d8/dbb/DNA__boid__types_8h.html#a10580db0b463ada9f1c0c45008ede7aa">BOIDSTATE_CURRENT</a>;
<a name="l04432"></a>04432         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7f6ac08c9c2f17012eb0b626b91c040f">boids</a>-&gt;<a class="code" href="../../dd/d94/structBoidSettings.html#a632b0e4786d070f07183c7659cac4444">states</a>, state);
<a name="l04433"></a>04433     }
<a name="l04434"></a>04434     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a> &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04435"></a>04435         part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/dec/structSPHFluidSettings.html">SPHFluidSettings</a>), <span class="stringliteral">&quot;SPH Fluid Settings&quot;</span>);
<a name="l04436"></a>04436         <a class="code" href="../../df/d40/particle__system_8c.html#aae675d22e20ff6650e5086d2ec577022">fluid_default_settings</a>(part);
<a name="l04437"></a>04437     }
<a name="l04438"></a>04438 
<a name="l04439"></a>04439     <a class="code" href="../../db/dca/BKE__particle_8h.html#aa5f9470220acee4b740afbae7f0378f6">psys_check_boid_data</a>(sim-&gt;<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>);
<a name="l04440"></a>04440 }
<a name="l04441"></a><a class="code" href="../../df/d40/particle__system_8c.html#adeaac4f838a7e537eade2a14ac091aeb">04441</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d40/particle__system_8c.html#adeaac4f838a7e537eade2a14ac091aeb">hair_needs_recalc</a>(<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l04442"></a>04442 {
<a name="l04443"></a>04443     <span class="keywordflow">if</span> (!(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad70fdae16497470d0b08a332f4021b7b">PSYS_EDITED</a>) &amp;&amp; (!psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> || !psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>-&gt;<a class="code" href="../../d7/d0e/structPTCacheEdit.html#a6f2f8b6afe3caac984c2bd615784ade6">edited</a>) &amp;&amp;
<a name="l04444"></a>04444         ((psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>)==0 || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a> || (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ab03a4cb2c2c44efc04593c36d185c57e">PART_HAIR_REGROW</a> &amp;&amp; !psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>))) {
<a name="l04445"></a>04445         <span class="keywordflow">return</span> 1;
<a name="l04446"></a>04446     }
<a name="l04447"></a>04447 
<a name="l04448"></a>04448     <span class="keywordflow">return</span> 0;
<a name="l04449"></a>04449 }
<a name="l04450"></a>04450 
<a name="l04451"></a>04451 <span class="comment">/* main particle update call, checks that things are ok on the large scale and</span>
<a name="l04452"></a>04452 <span class="comment"> * then advances in to actual particle calculations depending on particle type */</span>
<a name="l04453"></a><a class="code" href="../../df/d40/particle__system_8c.html#a6b891d0afb9c5ad49459b45baeb30954">04453</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dca/BKE__particle_8h.html#a21a8fbd33ba603d37a2ab195152545a2">particle_system_update</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l04454"></a>04454 {
<a name="l04455"></a>04455     <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> sim= {0};
<a name="l04456"></a>04456     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l04457"></a>04457     <span class="keywordtype">float</span> cfra;
<a name="l04458"></a>04458 
<a name="l04459"></a>04459     <span class="comment">/* drawdata is outdated after ANY change */</span>
<a name="l04460"></a>04460     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad87d1dfe2f606dd7a3e646c182e63e4b">pdd</a>) psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad87d1dfe2f606dd7a3e646c182e63e4b">pdd</a>-&gt;<a class="code" href="../../d0/df1/structParticleDrawData.html#a4eba3a0cda18872b81547eeac9e4e8d7">flag</a> &amp;= ~<a class="code" href="../../db/dca/BKE__particle_8h.html#a1a450d97b58cdae347e7d4271813e3d5">PARTICLE_DRAW_DATA_UPDATED</a>;
<a name="l04461"></a>04461 
<a name="l04462"></a>04462     <span class="keywordflow">if</span> (!<a class="code" href="../../db/dca/BKE__particle_8h.html#ae1ec21bf7aea2fdbe47e71514b97d919">psys_check_enabled</a>(ob, psys))
<a name="l04463"></a>04463         <span class="keywordflow">return</span>;
<a name="l04464"></a>04464 
<a name="l04465"></a>04465     cfra= <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(scene);
<a name="l04466"></a>04466 
<a name="l04467"></a>04467     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>= scene;
<a name="l04468"></a>04468     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>= ob;
<a name="l04469"></a>04469     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>= psys;
<a name="l04470"></a>04470     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>= <a class="code" href="../../db/dca/BKE__particle_8h.html#abb46b353cec8d54be258c683d352fc1d">psys_get_modifier</a>(ob, psys);
<a name="l04471"></a>04471 
<a name="l04472"></a>04472     <span class="comment">/* system was already updated from modifier stack */</span>
<a name="l04473"></a>04473     <span class="keywordflow">if</span> (sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#abc843013a6e93e2d94b3f45ac8fed2c9">flag</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a4f03f9ddb8ddeabea182daaa994650afaabaaf7f2d3b45ec49fb96b09b99615a3">eParticleSystemFlag_psys_updated</a>) {
<a name="l04474"></a>04474         sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#abc843013a6e93e2d94b3f45ac8fed2c9">flag</a> &amp;= ~<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a4f03f9ddb8ddeabea182daaa994650afaabaaf7f2d3b45ec49fb96b09b99615a3">eParticleSystemFlag_psys_updated</a>;
<a name="l04475"></a>04475         <span class="comment">/* make sure it really was updated to cfra */</span>
<a name="l04476"></a>04476         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> == cfra)
<a name="l04477"></a>04477             <span class="keywordflow">return</span>;
<a name="l04478"></a>04478     }
<a name="l04479"></a>04479 
<a name="l04480"></a>04480     <span class="keywordflow">if</span> (!sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>)
<a name="l04481"></a>04481         <span class="keywordflow">return</span>;
<a name="l04482"></a>04482 
<a name="l04483"></a>04483     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2ab666cbca234362666830dce9b2b21c">PART_FROM_VERT</a>) {
<a name="l04484"></a>04484         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>);
<a name="l04485"></a>04485     }
<a name="l04486"></a>04486 
<a name="l04487"></a>04487     <span class="comment">/* execute drivers only, as animation has already been done */</span>
<a name="l04488"></a>04488     <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a210d807df3902dfeb404ae25d402959d">id</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a35cf38441722e9b029ac80ee28f63031">adt</a>, cfra, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8af8b60644f7baff691944ebfdb8b39d03">ADT_RECALC_DRIVERS</a>);
<a name="l04489"></a>04489 
<a name="l04490"></a>04490     <span class="comment">/* to verify if we need to restore object afterwards */</span>
<a name="l04491"></a>04491     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1da5a9997318b0cdcc2b56e1c131632c">PSYS_OB_ANIM_RESTORE</a>;
<a name="l04492"></a>04492 
<a name="l04493"></a>04493     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a64b7d34b897665242d6d98c265fc9270">PSYS_RECALC_TYPE</a>)
<a name="l04494"></a>04494         <a class="code" href="../../df/d40/particle__system_8c.html#a32c54eba2930f1f852e7b9aace395fea">psys_changed_type</a>(&amp;sim);
<a name="l04495"></a>04495 
<a name="l04496"></a>04496     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>)
<a name="l04497"></a>04497         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a1800f585ab041a1d8f7193142188fef0">totunexist</a> = 0;
<a name="l04498"></a>04498 
<a name="l04499"></a>04499     <span class="comment">/* setup necessary physics type dependent additional data if it doesn&#39;t yet exist */</span>
<a name="l04500"></a>04500     <a class="code" href="../../df/d40/particle__system_8c.html#a37c30ebe40967b733817fc7f9dda6541">psys_prepare_physics</a>(&amp;sim);
<a name="l04501"></a>04501 
<a name="l04502"></a>04502     <span class="keywordflow">switch</span>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>) {
<a name="l04503"></a>04503         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>:
<a name="l04504"></a>04504         {
<a name="l04505"></a>04505             <span class="comment">/* nothing to do so bail out early */</span>
<a name="l04506"></a>04506             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a> == 0 &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a987ea41fe09e95054533124966636aca">totpart</a> == 0) {
<a name="l04507"></a>04507                 <a class="code" href="../../db/dca/BKE__particle_8h.html#ac3a5caa58c093a03ce64938258f62d93">psys_free_path_cache</a>(psys, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04508"></a>04508                 <a class="code" href="../../db/dca/BKE__particle_8h.html#ad4a4c0273bdebb56a63e5b6f93b089c0">free_hair</a>(ob, psys, 0);
<a name="l04509"></a>04509                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>;
<a name="l04510"></a>04510             }
<a name="l04511"></a>04511             <span class="comment">/* (re-)create hair */</span>
<a name="l04512"></a>04512             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#adeaac4f838a7e537eade2a14ac091aeb">hair_needs_recalc</a>(psys)) {
<a name="l04513"></a>04513                 <span class="keywordtype">float</span> hcfra=0.0f;
<a name="l04514"></a>04514                 <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, recalc = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a>;
<a name="l04515"></a>04515 
<a name="l04516"></a>04516                 <a class="code" href="../../db/dca/BKE__particle_8h.html#ad4a4c0273bdebb56a63e5b6f93b089c0">free_hair</a>(ob, psys, 0);
<a name="l04517"></a>04517 
<a name="l04518"></a>04518                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>) {
<a name="l04519"></a>04519                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a>);
<a name="l04520"></a>04520                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a102cd0af2e10a5d6f931a4a80555ed8d">edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04521"></a>04521                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a7ea15da16f08ff149ba679d663cf0276">free_edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04522"></a>04522                 }
<a name="l04523"></a>04523 
<a name="l04524"></a>04524                 <span class="comment">/* first step is negative so particles get killed and reset */</span>
<a name="l04525"></a>04525                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a>= 1.0f;
<a name="l04526"></a>04526 
<a name="l04527"></a>04527                 <span class="keywordflow">for</span> (i=0; i&lt;=part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4c7ce6b3dc7ffa55b4b4dc83bee12b0c">hair_step</a>; i++) {
<a name="l04528"></a>04528                     hcfra=100.0f*(float)i/(<span class="keywordtype">float</span>)psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4c7ce6b3dc7ffa55b4b4dc83bee12b0c">hair_step</a>;
<a name="l04529"></a>04529                     <span class="keywordflow">if</span> ((part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ab03a4cb2c2c44efc04593c36d185c57e">PART_HAIR_REGROW</a>)==0)
<a name="l04530"></a>04530                         <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a210d807df3902dfeb404ae25d402959d">id</a>, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a35cf38441722e9b029ac80ee28f63031">adt</a>, hcfra, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8a1bce4262e3f1016c7b92e1ac709e4bec">ADT_RECALC_ANIM</a>);
<a name="l04531"></a>04531                     <a class="code" href="../../df/d40/particle__system_8c.html#af1a2d4fd957db8242cbad1e9b4fa3117">system_step</a>(&amp;sim, hcfra);
<a name="l04532"></a>04532                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> = hcfra;
<a name="l04533"></a>04533                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> = 0;
<a name="l04534"></a>04534                     <a class="code" href="../../df/d40/particle__system_8c.html#a1ba7cd33ae3175995819eb13fc9b11fe">save_hair</a>(&amp;sim, hcfra);
<a name="l04535"></a>04535                 }
<a name="l04536"></a>04536 
<a name="l04537"></a>04537                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>;
<a name="l04538"></a>04538                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> = recalc;
<a name="l04539"></a>04539             }
<a name="l04540"></a>04540             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad70fdae16497470d0b08a332f4021b7b">PSYS_EDITED</a>)
<a name="l04541"></a>04541                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>;
<a name="l04542"></a>04542 
<a name="l04543"></a>04543             <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#af7fec7e58566fefda17630ff076d2d66">PSYS_HAIR_DONE</a>)
<a name="l04544"></a>04544                 <a class="code" href="../../df/d40/particle__system_8c.html#a2cb51debcd08b860ddca5971402f5c26">hair_step</a>(&amp;sim, cfra);
<a name="l04545"></a>04545             <span class="keywordflow">break</span>;
<a name="l04546"></a>04546         }
<a name="l04547"></a>04547         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad2b156b6908626c14f063e15712fe427">PART_FLUID</a>:
<a name="l04548"></a>04548         {
<a name="l04549"></a>04549             <a class="code" href="../../df/d40/particle__system_8c.html#aa50844e6d7ccf13e6f546c4205a61805">particles_fluid_step</a>(&amp;sim, (<span class="keywordtype">int</span>)cfra);
<a name="l04550"></a>04550             <span class="keywordflow">break</span>;
<a name="l04551"></a>04551         }
<a name="l04552"></a>04552         <span class="keywordflow">default</span>:
<a name="l04553"></a>04553         {
<a name="l04554"></a>04554             <span class="keywordflow">switch</span>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>) {
<a name="l04555"></a>04555                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aaaa65883b0fd34e1f66db33d0e55ef9e">PART_PHYS_NO</a>:
<a name="l04556"></a>04556                 <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>:
<a name="l04557"></a>04557                 {
<a name="l04558"></a>04558                     <a class="code" href="../../db/dca/BKE__particle_8h.html#af96ce351255ada868e0f775d00ac7a52">PARTICLE_P</a>;
<a name="l04559"></a>04559                     <span class="keywordtype">float</span> disp = (float)<a class="code" href="../../df/d40/particle__system_8c.html#a6d41c6f4b0df2ec9b46a0c5666ac94d9">psys_get_current_display_percentage</a>(psys)/100.0f;
<a name="l04560"></a>04560 
<a name="l04561"></a>04561                     <span class="comment">/* Particles without dynamics haven&#39;t been reset yet because they don&#39;t use pointcache */</span>
<a name="l04562"></a>04562                     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>)
<a name="l04563"></a>04563                         <a class="code" href="../../db/dca/BKE__particle_8h.html#a686244657da3b6f9c17f52070e5cd4b4">psys_reset</a>(psys, <a class="code" href="../../db/dca/BKE__particle_8h.html#aac0cee343bc36395e4bec4851c8f0ab3">PSYS_RESET_ALL</a>);
<a name="l04564"></a>04564 
<a name="l04565"></a>04565                     <span class="keywordflow">if</span> (<a class="code" href="../../df/d40/particle__system_8c.html#ada3b59f53ea08364a5e2d2d065a9517b">emit_particles</a>(&amp;sim, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, cfra) || (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>)) {
<a name="l04566"></a>04566                         <a class="code" href="../../db/dca/BKE__particle_8h.html#a8325d53f262b836a28783e7fa06c6adf">free_keyed_keys</a>(psys);
<a name="l04567"></a>04567                         <a class="code" href="../../df/d40/particle__system_8c.html#a979496760ea59c623a9d846ad70f54f1">distribute_particles</a>(&amp;sim, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>);
<a name="l04568"></a>04568                         <a class="code" href="../../df/d40/particle__system_8c.html#add4524669eb21d40d95fc9af2d71aaac">initialize_all_particles</a>(&amp;sim);
<a name="l04569"></a>04569 
<a name="l04570"></a>04570                         <span class="comment">/* flag for possible explode modifiers after this system */</span>
<a name="l04571"></a>04571                         sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#abc843013a6e93e2d94b3f45ac8fed2c9">flag</a> |= <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a4f03f9ddb8ddeabea182daaa994650afa52dbe6f11d2ae384b04028a2ccc4a332">eParticleSystemFlag_Pars</a>;
<a name="l04572"></a>04572                     }
<a name="l04573"></a>04573 
<a name="l04574"></a>04574                     <a class="code" href="../../db/dca/BKE__particle_8h.html#ad409e9068225d14b2f0c08b23ec308e7">LOOP_EXISTING_PARTICLES</a> {
<a name="l04575"></a>04575                         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a776e1928583df9d19b41cc90e6fb42c8">size</a>;
<a name="l04576"></a>04576                         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> &gt; 0.0f)
<a name="l04577"></a>04577                             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a> *= 1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a422c596a2ca620e7d5986d8d0eaefa9e">randsize</a> * <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p + 1);
<a name="l04578"></a>04578 
<a name="l04579"></a>04579                         <a class="code" href="../../db/dca/BKE__particle_8h.html#a4ae892920c05b62d4397361946129ae8">reset_particle</a>(&amp;sim, pa, 0.0, cfra);
<a name="l04580"></a>04580 
<a name="l04581"></a>04581                         <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(p) &gt; disp)
<a name="l04582"></a>04582                             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04583"></a>04583                         <span class="keywordflow">else</span>
<a name="l04584"></a>04584                             pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#adddf5beca21354e46dfeadab76952feb">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5419c3719e77cf5a291da056590cda31">PARS_NO_DISP</a>;
<a name="l04585"></a>04585                     }
<a name="l04586"></a>04586 
<a name="l04587"></a>04587                     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>) {
<a name="l04588"></a>04588                         <a class="code" href="../../db/dca/BKE__particle_8h.html#a367eaf7149486c4f3ef97ffc0d61b48e">psys_count_keyed_targets</a>(&amp;sim);
<a name="l04589"></a>04589                         <a class="code" href="../../df/d40/particle__system_8c.html#a9f494756830a547aee46374cf4fb9153">set_keyed_keys</a>(&amp;sim);
<a name="l04590"></a>04590                         <a class="code" href="../../df/d40/particle__system_8c.html#af211e7a44c8a798b553ed08bc9045f5b">psys_update_path_cache</a>(&amp;sim,(<span class="keywordtype">int</span>)cfra);
<a name="l04591"></a>04591                     }
<a name="l04592"></a>04592                     <span class="keywordflow">break</span>;
<a name="l04593"></a>04593                 }
<a name="l04594"></a>04594                 <span class="keywordflow">default</span>:
<a name="l04595"></a>04595                 {
<a name="l04596"></a>04596                     <span class="comment">/* the main dynamic particle system step */</span>
<a name="l04597"></a>04597                     <a class="code" href="../../df/d40/particle__system_8c.html#af1a2d4fd957db8242cbad1e9b4fa3117">system_step</a>(&amp;sim, cfra);
<a name="l04598"></a>04598                     <span class="keywordflow">break</span>;
<a name="l04599"></a>04599                 }
<a name="l04600"></a>04600             }
<a name="l04601"></a>04601             <span class="keywordflow">break</span>;
<a name="l04602"></a>04602         }
<a name="l04603"></a>04603     }
<a name="l04604"></a>04604 
<a name="l04605"></a>04605     <span class="comment">/* make sure emitter is left at correct time (particle emission can change this) */</span>
<a name="l04606"></a>04606     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1da5a9997318b0cdcc2b56e1c131632c">PSYS_OB_ANIM_RESTORE</a>) {
<a name="l04607"></a>04607         <span class="keywordflow">while</span> (ob) {
<a name="l04608"></a>04608             <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>, cfra, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8a1bce4262e3f1016c7b92e1ac709e4bec">ADT_RECALC_ANIM</a>);
<a name="l04609"></a>04609             ob = ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>;
<a name="l04610"></a>04610         }
<a name="l04611"></a>04611         ob = sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>;
<a name="l04612"></a>04612         <a class="code" href="../../df/dac/BKE__object_8h.html#a041216c9db7724b51417887b9e31f5d3">where_is_object_time</a>(scene, ob, cfra);
<a name="l04613"></a>04613 
<a name="l04614"></a>04614         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1da5a9997318b0cdcc2b56e1c131632c">PSYS_OB_ANIM_RESTORE</a>;
<a name="l04615"></a>04615     }
<a name="l04616"></a>04616 
<a name="l04617"></a>04617     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad467ed7c4ac38af9be464e636ee13321">cfra</a> = cfra;
<a name="l04618"></a>04618     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> = 0;
<a name="l04619"></a>04619 
<a name="l04620"></a>04620     <span class="comment">/* save matrix for duplicators, at rendertime the actual dupliobject&#39;s matrix is used so don&#39;t update! */</span>
<a name="l04621"></a>04621     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a86a9ed5baa3079474b611e98979c0928">renderdata</a>==0)
<a name="l04622"></a>04622         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a365fda1e3579186b77768df8dfbd00ed">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l04623"></a>04623 }
<a name="l04624"></a>04624 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:44 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
