<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: brush.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">brush.c</div>  </div>
</div>
<div class="contents">
<a href="../../df/d2b/brush_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d37/DNA__brush__types_8h.html">DNA_brush_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddd/DNA__color__types_8h.html">DNA_color_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html">DNA_windowmanager_types.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd1/BLI__bpath_8h.html">BLI_bpath.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dc9/BKE__brush_8h.html">BKE_brush.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d32/BKE__icons_8h.html">BKE_icons.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/de4/RE__render__ext_8h.html">RE_render_ext.h</a>&quot;</span> <span class="comment">/* externtex */</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d49/RE__shader__ext_8h.html">RE_shader_ext.h</a>&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="../../df/d2b/brush_8c.html#a88dc85cc421f5c27bc293b802faaaeab">00070</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#a88dc85cc421f5c27bc293b802faaaeab">brush_set_defaults</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a99c5887452ddfa34dc629fc3ba4a7c54">blend</a> = 0;
<a name="l00073"></a>00073     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> = 0;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a472884ac26c7633c6486940a4cf79089">ob_mode</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a71c18d7335332f6a2fb10b7b1f9f94f5">OB_MODE_ALL_PAINT</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">/* BRUSH SCULPT TOOL SETTINGS */</span>
<a name="l00078"></a>00078     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a9cf9fcecab64b7e853066eb75d4c78d4">size</a>= 35; <span class="comment">/* radius of the brush in pixels */</span>
<a name="l00079"></a>00079     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a05d1b34fb95a0932190b690b61b276ee">alpha</a>= 0.5f; <span class="comment">/* brush strength/intensity probably variable should be renamed? */</span>
<a name="l00080"></a>00080     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#af0ef2dc8a9630f72448756387750170f">autosmooth_factor</a>= 0.0f;
<a name="l00081"></a>00081     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad35bfdb13e68eef83a2b959d57c80f6">crease_pinch_factor</a>= 0.5f;
<a name="l00082"></a>00082     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a1411b107a50286cb27a891dbe12e8fce">sculpt_plane</a> = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a8feb5a39a55448c86e0dfc20f53a6c1da7139d631bebb565530257f2a37617291">SCULPT_DISP_DIR_AREA</a>;
<a name="l00083"></a>00083     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#ace0c5bccb85708d4a7913ce9caed843e">plane_offset</a>= 0.0f; <span class="comment">/* how far above or below the plane that is found by averaging the faces */</span>
<a name="l00084"></a>00084     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a757759e952a4e503c94975bc9625315b">plane_trim</a>= 0.5f;
<a name="l00085"></a>00085     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a1d5409226c13d67ee4da5b99aa0a3f7c">alpha</a>= 0.5f;
<a name="l00086"></a>00086     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c6230695038ed067f2d5ab610e0e262">normal_weight</a>= 0.0f;
<a name="l00087"></a>00087     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> |= <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa1ceadb32af646d1aefddce74622934fd">BRUSH_ALPHA_PRESSURE</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="comment">/* BRUSH PAINT TOOL SETTINGS */</span>
<a name="l00090"></a>00090     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[0]= 1.0f; <span class="comment">/* default rgb color of the brush when painting - white */</span>
<a name="l00091"></a>00091     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[1]= 1.0f;
<a name="l00092"></a>00092     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[2]= 1.0f;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <span class="comment">/* BRUSH STROKE SETTINGS */</span>
<a name="l00095"></a>00095     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> |= (<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf76b87d500309f20c493b07d8b7c48d6">BRUSH_SPACE</a>|<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa226d1c367c16acd4d07469b4f1f31304">BRUSH_SPACE_ATTEN</a>);
<a name="l00096"></a>00096     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a>= 10; <span class="comment">/* how far each brush dot should be spaced as a percentage of brush diameter */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a4c80a74f85b613bb78050daca2560af5">smooth_stroke_radius</a>= 75;
<a name="l00099"></a>00099     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a4527e8e14e477e793c46db01777c1ca2">smooth_stroke_factor</a>= 0.9f;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#acda87e5d0baba3a86b0fed2d3f5a13f4">rate</a>= 0.1f; <span class="comment">/* time delay between dots of paint or sculpting when doing airbrush mode */</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a>= 0.0f;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="comment">/* BRUSH TEXTURE SETTINGS */</span>
<a name="l00106"></a>00106     <a class="code" href="../../d2/d66/BKE__texture_8h.html#a804c8b305f091b569244c79fc98a295b">default_mtex</a>(&amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a649085a61e71a012c640c7cdb7c98586">texture_sample_bias</a>= 0; <span class="comment">/* value to added to texture samples */</span>
<a name="l00109"></a>00109     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a370eb070b1a9ae34e7f2190f347046aa">texture_overlay_alpha</a>= 33;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">/* brush appearance  */</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0]= 1.00; <span class="comment">/* add mode color is light red */</span>
<a name="l00114"></a>00114     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1]= 0.39;
<a name="l00115"></a>00115     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2]= 0.39;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0]= 0.39; <span class="comment">/* subtract mode color is light blue */</span>
<a name="l00118"></a>00118     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1]= 0.39;
<a name="l00119"></a>00119     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[2]= 1.00;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/* Datablock add/copy/free/make_local */</span>
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="../../df/d2b/brush_8c.html#ad42fb1a9a1ae9222ef34b12d46055f83">00124</a> <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#a14ed580a7c7cd960328a593201f9fb3a">add_brush</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     brush= <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;brush, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7f2ccbf688d8c6763420cb2fe028e5a">ID_BR</a>, name);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">/* enable fake user by default */</span>
<a name="l00131"></a>00131     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <a class="code" href="../../df/d2b/brush_8c.html#a88dc85cc421f5c27bc293b802faaaeab">brush_set_defaults</a>(brush);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#ab1a9175890a69550b6dae0cd66e5a8d6">sculpt_tool</a> = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba58d31ad3a29727e9d3308379f73cab0e">SCULPT_TOOL_DRAW</a>; <span class="comment">/* sculpting defaults to the draw tool for new brushes */</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137      <span class="comment">/* the default alpha falloff curve */</span>
<a name="l00138"></a>00138     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae1aaf97753692d574d8f1a4de609cfe6">brush_curve_preset</a>(brush, <a class="code" href="../../da/ddd/DNA__color__types_8h.html#a6dd78cb24fdca0792ce9e05b433409cea8880071f13cceaa7a4341aee8e65bbe3">CURVE_PRESET_SMOOTH</a>);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="keywordflow">return</span> brush;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="../../df/d2b/brush_8c.html#ad60aa4388a87d3c734471a69edcc89bd">00143</a> <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#a0ca061ba46d29cbfdfc67e9be168a2a8">copy_brush</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brushn;
<a name="l00146"></a>00146     
<a name="l00147"></a>00147     brushn= <a class="code" href="../../d8/db1/BKE__library_8h.html#a0c0c1987364874c73cda326eace31efd">copy_libblock</a>(&amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>)
<a name="l00150"></a>00150         <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a>*)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a110f0f4309616d63024d59203d4d6dc1">icon_imbuf</a>)
<a name="l00153"></a>00153         brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a110f0f4309616d63024d59203d4d6dc1">icon_imbuf</a>= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a094bab2aa339f34922893e1d6d617c28">IMB_dupImBuf</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a110f0f4309616d63024d59203d4d6dc1">icon_imbuf</a>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aa56832257ac5b4738eb4f25ff30acf96">preview</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>= <a class="code" href="../../d4/dca/BKE__colortools_8h.html#abf02c86e7ad7564ba85ff1adc9c34641">curvemapping_copy</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">/* enable fake user by default */</span>
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (!(brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp; <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>)) {
<a name="l00161"></a>00161         brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>;
<a name="l00162"></a>00162         brushn-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     <span class="keywordflow">return</span> brushn;
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">/* not brush itself */</span>
<a name="l00169"></a><a class="code" href="../../df/d2b/brush_8c.html#a5ba1db34fd1092f0a81a88cfdf2a6e5b">00169</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a531fd438647c81038a11b831aae68b52">free_brush</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>)
<a name="l00172"></a>00172         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a110f0f4309616d63024d59203d4d6dc1">icon_imbuf</a>)
<a name="l00175"></a>00175         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a110f0f4309616d63024d59203d4d6dc1">icon_imbuf</a>);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <a class="code" href="../../d4/d32/BKE__icons_8h.html#a4b6858e5df40aefe6c016aef8aef2082">BKE_previewimg_free</a>(&amp;(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aa56832257ac5b4738eb4f25ff30acf96">preview</a>));
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a2814c1eea529822b51a36d9cfe3348cf">curvemapping_free</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>);
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="../../df/d2b/brush_8c.html#a80801d349dc28e4fe5b5fc28400752cf">00182</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#a80801d349dc28e4fe5b5fc28400752cf">extern_local_brush</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <a class="code" href="../../d8/db1/BKE__library_8h.html#a43e37bd819b3a44520ff6fbfd9e8962d">id_lib_extern</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>);
<a name="l00185"></a>00185     <a class="code" href="../../d8/db1/BKE__library_8h.html#a43e37bd819b3a44520ff6fbfd9e8962d">id_lib_extern</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>);
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="../../df/d2b/brush_8c.html#a8f8eb5845b35753c0562f25e262aa914">00188</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ac1a2b8a3fae9d5f55ab2616dac077f0d">make_local_brush</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment">/* - only lib users: do nothing</span>
<a name="l00192"></a>00192 <span class="comment">     * - only local users: set flag</span>
<a name="l00193"></a>00193 <span class="comment">     * - mixed: make copy</span>
<a name="l00194"></a>00194 <span class="comment">     */</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main;
<a name="l00197"></a>00197     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>;
<a name="l00198"></a>00198     <span class="keywordtype">int</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>) {
<a name="l00203"></a>00203         <span class="comment">/* special case: ima always local immediately. Clone image should only</span>
<a name="l00204"></a>00204 <span class="comment">         * have one user anyway. */</span>
<a name="l00205"></a>00205         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00206"></a>00206         <a class="code" href="../../df/d2b/brush_8c.html#a80801d349dc28e4fe5b5fc28400752cf">extern_local_brush</a>(brush);
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">for</span> (scene= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a976062774f867fa0f917c23f2ec331bb">scene</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; scene &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(0, is_lib, is_local); scene=scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>)==brush) {
<a name="l00211"></a>00211             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00212"></a>00212             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00217"></a>00217         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>);
<a name="l00218"></a>00218         <a class="code" href="../../df/d2b/brush_8c.html#a80801d349dc28e4fe5b5fc28400752cf">extern_local_brush</a>(brush);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="comment">/* enable fake user by default */</span>
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (!(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp; <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>)) {
<a name="l00222"></a>00222             brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>;
<a name="l00223"></a>00223             brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib) {
<a name="l00227"></a>00227         <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush_new= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a0ca061ba46d29cbfdfc67e9be168a2a8">copy_brush</a>(brush);
<a name="l00228"></a>00228         brush_new-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>= 1; <span class="comment">/* only keep fake user */</span>
<a name="l00229"></a>00229         brush_new-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac7a490f7c486f67fa46961f920fc8e26">LIB_FAKEUSER</a>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">/* Remap paths of new ID using old library as base. */</span>
<a name="l00232"></a>00232         <a class="code" href="../../d8/db1/BKE__library_8h.html#a28231f1e4d5edb6c8498db449bda4528">BKE_id_lib_local_paths</a>(bmain, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>, &amp;brush_new-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>);
<a name="l00233"></a>00233         
<a name="l00234"></a>00234         <span class="keywordflow">for</span> (scene= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a976062774f867fa0f917c23f2ec331bb">scene</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; scene; scene=scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00235"></a>00235             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>)==brush) {
<a name="l00236"></a>00236                 <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00237"></a>00237                     <a class="code" href="../../d8/d86/BKE__paint_8h.html#a21e8e0a4675dd1ed326c4c7dae3b70a6">paint_brush_set</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>, brush_new);
<a name="l00238"></a>00238                 }
<a name="l00239"></a>00239             }
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="../../df/d2b/brush_8c.html#a213817f6d6f7c847734ff5c994439968">00244</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a7980bb1f114e0fc11a2745c6d134d312">brush_debug_print_state</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <span class="comment">/* create a fake brush and set it to the defaults */</span>
<a name="l00247"></a>00247     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> def= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l00248"></a>00248     <a class="code" href="../../df/d2b/brush_8c.html#a88dc85cc421f5c27bc293b802faaaeab">brush_set_defaults</a>(&amp;def);
<a name="l00249"></a>00249     
<a name="l00250"></a>00250 <span class="preprocessor">#define BR_TEST(field, t)                   \</span>
<a name="l00251"></a>00251 <span class="preprocessor">    if (br-&gt;field != def.field)             \</span>
<a name="l00252"></a>00252 <span class="preprocessor">        printf(&quot;br-&gt;&quot; #field &quot; = %&quot; #t &quot;;\n&quot;, br-&gt;field)</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>
<a name="l00254"></a>00254 <span class="preprocessor">#define BR_TEST_FLAG(_f)                \</span>
<a name="l00255"></a>00255 <span class="preprocessor">    if ((br-&gt;flag &amp; _f) &amp;&amp; !(def.flag &amp; _f))        \</span>
<a name="l00256"></a>00256 <span class="preprocessor">        printf(&quot;br-&gt;flag |= &quot; #_f &quot;;\n&quot;);   \</span>
<a name="l00257"></a>00257 <span class="preprocessor">    else if (!(br-&gt;flag &amp; _f) &amp;&amp; (def.flag &amp; _f))   \</span>
<a name="l00258"></a>00258 <span class="preprocessor">        printf(&quot;br-&gt;flag &amp;= ~&quot; #_f &quot;;\n&quot;)</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>    
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="comment">/* print out any non-default brush state */</span>
<a name="l00262"></a>00262     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(normal_weight, f);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(<a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>, d);
<a name="l00265"></a>00265     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, d);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <span class="comment">/* br-&gt;flag */</span>
<a name="l00268"></a>00268     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf33942d16772316fcb0e94d4a77eaba2">BRUSH_AIRBRUSH</a>);
<a name="l00269"></a>00269     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa3d163933e82fcfe43e2b5e65fd307aa7">BRUSH_TORUS</a>);
<a name="l00270"></a>00270     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa1ceadb32af646d1aefddce74622934fd">BRUSH_ALPHA_PRESSURE</a>);
<a name="l00271"></a>00271     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaeaf56ab45402053483316909c0ae8e10">BRUSH_SIZE_PRESSURE</a>);
<a name="l00272"></a>00272     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baab449aef9850266fa70c1a3da48cf4759">BRUSH_JITTER_PRESSURE</a>);
<a name="l00273"></a>00273     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa58e5ffa5a3828b73f28d92bba74d41f4">BRUSH_SPACING_PRESSURE</a>);
<a name="l00274"></a>00274     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa915ac4283e5c43b73cc5da10130549df">BRUSH_FIXED_TEX</a>);
<a name="l00275"></a>00275     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa83ea7d03bfcb5421092dc11a7110536a">BRUSH_RAKE</a>);
<a name="l00276"></a>00276     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaa226f73c6e663f17d978981991b101df">BRUSH_ANCHORED</a>);
<a name="l00277"></a>00277     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa9cd2632129ecafb7cb6748add92632e2">BRUSH_DIR_IN</a>);
<a name="l00278"></a>00278     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf76b87d500309f20c493b07d8b7c48d6">BRUSH_SPACE</a>);
<a name="l00279"></a>00279     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa84be63611e80462d7fe3c11494e80cfe">BRUSH_SMOOTH_STROKE</a>);
<a name="l00280"></a>00280     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baae6dc59eabba02745fadc960246788308">BRUSH_PERSISTENT</a>);
<a name="l00281"></a>00281     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa9312f7c884446bd871669fa6f3fc1fd5">BRUSH_ACCUMULATE</a>);
<a name="l00282"></a>00282     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa3f4ea443167c10441b654c023ad65b37">BRUSH_LOCK_ALPHA</a>);
<a name="l00283"></a>00283     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa1636c4d12e612e69042c67f1086712af">BRUSH_ORIGINAL_NORMAL</a>);
<a name="l00284"></a>00284     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa04e51b91d9271dd233173d09ccfccfeb">BRUSH_OFFSET_PRESSURE</a>);
<a name="l00285"></a>00285     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa226d1c367c16acd4d07469b4f1f31304">BRUSH_SPACE_ATTEN</a>);
<a name="l00286"></a>00286     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa42bf2acdf839d6001d52d3f9b4a71fd6">BRUSH_ADAPTIVE_SPACE</a>);
<a name="l00287"></a>00287     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baabaf4e3d5fd85b6ad0442d3a3713760fb">BRUSH_LOCK_SIZE</a>);
<a name="l00288"></a>00288     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baace89048406530d63082ec346809fc455">BRUSH_TEXTURE_OVERLAY</a>);
<a name="l00289"></a>00289     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa7eba5d5e73a7cf919c6fa011801bf115">BRUSH_EDGE_TO_EDGE</a>);
<a name="l00290"></a>00290     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf0aabbde784d13487aa9a0475a5a973f">BRUSH_RESTORE_MESH</a>);
<a name="l00291"></a>00291     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baac6c9c72e23f7a51a4574f3fa4ec87f43">BRUSH_INVERSE_SMOOTH_PRESSURE</a>);
<a name="l00292"></a>00292     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa8a63fccf03af1e345cc4f7ed2fb24e00">BRUSH_RANDOM_ROTATION</a>);
<a name="l00293"></a>00293     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baab70b1962529341ba8a2eb2a17a02245f">BRUSH_PLANE_TRIM</a>);
<a name="l00294"></a>00294     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa41b18f09897eca05b1afaeeab837ab0d">BRUSH_FRONTFACE</a>);
<a name="l00295"></a>00295     <a class="code" href="../../df/d2b/brush_8c.html#af64ab3aec886a899e2afea8d864c3f09">BR_TEST_FLAG</a>(<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaac0a16e4fcbb3a24d7e0c30e7a0982bf">BRUSH_CUSTOM_ICON</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(jitter, f);
<a name="l00298"></a>00298     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(spacing, d);
<a name="l00299"></a>00299     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(smooth_stroke_radius, d);
<a name="l00300"></a>00300     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(smooth_stroke_factor, f);
<a name="l00301"></a>00301     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(rate, f);
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(alpha, f);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(sculpt_plane, d);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(plane_offset, f);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(autosmooth_factor, f);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(crease_pinch_factor, f);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(<a class="code" href="../../d2/df6/sculpt_8c.html#a094bb9b9a00c4c03fc7aab8850aaa385">plane_trim</a>, f);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(texture_sample_bias, f);
<a name="l00316"></a>00316     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(texture_overlay_alpha, d);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(add_col[0], f);
<a name="l00319"></a>00319     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(add_col[1], f);
<a name="l00320"></a>00320     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(add_col[2], f);
<a name="l00321"></a>00321     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(sub_col[0], f);
<a name="l00322"></a>00322     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(sub_col[1], f);
<a name="l00323"></a>00323     <a class="code" href="../../df/d2b/brush_8c.html#a205eb894890c2bbd7d26e7e3ccf86364">BR_TEST</a>(sub_col[2], f);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327 <span class="preprocessor">#undef BR_TEST</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span><span class="preprocessor">#undef BR_TEST_FLAG</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span>}
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="../../df/d2b/brush_8c.html#ab209adfa10bc1c996aeec780d6b87a4e">00331</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ab8e6e3ae03999f5572b2a367781956ca">brush_reset_sculpt</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <span class="comment">/* enable this to see any non-default</span>
<a name="l00334"></a>00334 <span class="comment">     * settings used by a brush: */</span>
<a name="l00335"></a>00335     <span class="comment">// brush_debug_print_state(br);</span>
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <a class="code" href="../../df/d2b/brush_8c.html#a88dc85cc421f5c27bc293b802faaaeab">brush_set_defaults</a>(br);
<a name="l00338"></a>00338     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae1aaf97753692d574d8f1a4de609cfe6">brush_curve_preset</a>(br, <a class="code" href="../../da/ddd/DNA__color__types_8h.html#a6dd78cb24fdca0792ce9e05b433409cea8880071f13cceaa7a4341aee8e65bbe3">CURVE_PRESET_SMOOTH</a>);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">switch</span>(br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#ab1a9175890a69550b6dae0cd66e5a8d6">sculpt_tool</a>) {
<a name="l00341"></a>00341     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39ebad3a2bb262942af524e1d81e401a6a146">SCULPT_TOOL_CLAY</a>:
<a name="l00342"></a>00342         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> |= <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa41b18f09897eca05b1afaeeab837ab0d">BRUSH_FRONTFACE</a>;
<a name="l00343"></a>00343         <span class="keywordflow">break</span>;
<a name="l00344"></a>00344     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39ebaf6659442b4838609d2dcdff049636832">SCULPT_TOOL_CREASE</a>:
<a name="l00345"></a>00345         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> |= <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa9cd2632129ecafb7cb6748add92632e2">BRUSH_DIR_IN</a>;
<a name="l00346"></a>00346         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a05d1b34fb95a0932190b690b61b276ee">alpha</a> = 0.25;
<a name="l00347"></a>00347         <span class="keywordflow">break</span>;
<a name="l00348"></a>00348     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba90a7608caabce8b7abeafe7eda93dc52">SCULPT_TOOL_FILL</a>:
<a name="l00349"></a>00349         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 1;
<a name="l00350"></a>00350         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0] = 0.25;
<a name="l00351"></a>00351         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1] = 1;
<a name="l00352"></a>00352         <span class="keywordflow">break</span>;
<a name="l00353"></a>00353     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba5fe133df67d3ab03e936b7dbd227240d">SCULPT_TOOL_FLATTEN</a>:
<a name="l00354"></a>00354         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 1;
<a name="l00355"></a>00355         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0] = 0.25;
<a name="l00356"></a>00356         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1] = 1;
<a name="l00357"></a>00357         <span class="keywordflow">break</span>;
<a name="l00358"></a>00358     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba474790ce9d631606a9d6ef9c9ec87deb">SCULPT_TOOL_INFLATE</a>:
<a name="l00359"></a>00359         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0] = 0.750000;
<a name="l00360"></a>00360         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 0.750000;
<a name="l00361"></a>00361         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2] = 0.750000;
<a name="l00362"></a>00362         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0] = 0.250000;
<a name="l00363"></a>00363         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1] = 0.250000;
<a name="l00364"></a>00364         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[2] = 0.250000;
<a name="l00365"></a>00365         <span class="keywordflow">break</span>;
<a name="l00366"></a>00366     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba25dc545d0fe31b39ba1503d8b4028a3a">SCULPT_TOOL_NUDGE</a>:
<a name="l00367"></a>00367         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0] = 0.250000;
<a name="l00368"></a>00368         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 1.000000;
<a name="l00369"></a>00369         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2] = 0.250000;
<a name="l00370"></a>00370         <span class="keywordflow">break</span>;
<a name="l00371"></a>00371     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba726b91c3d87cb30b75d00c1c4df4b866">SCULPT_TOOL_PINCH</a>:
<a name="l00372"></a>00372         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0] = 0.750000;
<a name="l00373"></a>00373         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 0.750000;
<a name="l00374"></a>00374         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2] = 0.750000;
<a name="l00375"></a>00375         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0] = 0.250000;
<a name="l00376"></a>00376         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1] = 0.250000;
<a name="l00377"></a>00377         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[2] = 0.250000;
<a name="l00378"></a>00378         <span class="keywordflow">break</span>;
<a name="l00379"></a>00379     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba27ef79585e2162a6b5b2d2598d405f9c">SCULPT_TOOL_SCRAPE</a>:
<a name="l00380"></a>00380         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 1.000000;
<a name="l00381"></a>00381         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[0] = 0.250000;
<a name="l00382"></a>00382         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a7fe6da287c1d2414c87fabc8e8325167">sub_col</a>[1] = 1.000000;
<a name="l00383"></a>00383         <span class="keywordflow">break</span>;
<a name="l00384"></a>00384     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39ebaea2e7c98691af9e799de42c097e93405">SCULPT_TOOL_ROTATE</a>:
<a name="l00385"></a>00385         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a05d1b34fb95a0932190b690b61b276ee">alpha</a> = 1.0;
<a name="l00386"></a>00386         <span class="keywordflow">break</span>;
<a name="l00387"></a>00387     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba06ac3578c93de27e070d474f62a3f68f">SCULPT_TOOL_SMOOTH</a>:
<a name="l00388"></a>00388         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp;= ~<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa226d1c367c16acd4d07469b4f1f31304">BRUSH_SPACE_ATTEN</a>;
<a name="l00389"></a>00389         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a> = 5;
<a name="l00390"></a>00390         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0] = 0.750000;
<a name="l00391"></a>00391         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 0.750000;
<a name="l00392"></a>00392         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2] = 0.750000;
<a name="l00393"></a>00393         <span class="keywordflow">break</span>;
<a name="l00394"></a>00394     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba45422ddf2ec5f40ad635f4e78bfe4777">SCULPT_TOOL_GRAB</a>:
<a name="l00395"></a>00395     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39ebaede12bdd3af05c67ff87c5409d19202c">SCULPT_TOOL_SNAKE_HOOK</a>:
<a name="l00396"></a>00396     <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a32b04aa41966305a60754f234d6a39eba2cb755ae92e42a9f86d6f5dcb635634d">SCULPT_TOOL_THUMB</a>:
<a name="l00397"></a>00397         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a9cf9fcecab64b7e853066eb75d4c78d4">size</a> = 75;
<a name="l00398"></a>00398         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp;= ~<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa1ceadb32af646d1aefddce74622934fd">BRUSH_ALPHA_PRESSURE</a>;
<a name="l00399"></a>00399         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp;= ~<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf76b87d500309f20c493b07d8b7c48d6">BRUSH_SPACE</a>;
<a name="l00400"></a>00400         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp;= ~<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa226d1c367c16acd4d07469b4f1f31304">BRUSH_SPACE_ATTEN</a>;
<a name="l00401"></a>00401         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0] = 0.250000;
<a name="l00402"></a>00402         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1] = 1.000000;
<a name="l00403"></a>00403         br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2] = 0.250000;
<a name="l00404"></a>00404         <span class="keywordflow">break</span>;
<a name="l00405"></a>00405     <span class="keywordflow">default</span>:
<a name="l00406"></a>00406         <span class="keywordflow">break</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="comment">/* Library Operations */</span>
<a name="l00411"></a><a class="code" href="../../df/d2b/brush_8c.html#a821ba6e3446297e734e7023c822554da">00411</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae1aaf97753692d574d8f1a4de609cfe6">brush_curve_preset</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *b, <span class="comment">/*CurveMappingPreset*/</span><span class="keywordtype">int</span> preset)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <a class="code" href="../../df/d78/structCurveMap.html">CurveMap</a> *cm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (!b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>)
<a name="l00416"></a>00416         b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a> = <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a0fe6bbbc391a99f155add4272972ba6d">curvemapping_add</a>(1, 0, 0, 1, 1);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     cm = b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>-&gt;<a class="code" href="../../d4/d40/structCurveMapping.html#abaeb35254b998c201c1957d67a757f7c">cm</a>;
<a name="l00419"></a>00419     cm-&gt;<a class="code" href="../../df/d78/structCurveMap.html#ab8bdb4a30d4ac21edb9c7f0fe4784c9c">flag</a> &amp;= ~<a class="code" href="../../da/ddd/DNA__color__types_8h.html#a53e0b7a779b29f4940c4eae3fd37ad8d">CUMA_EXTEND_EXTRAPOLATE</a>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>-&gt;<a class="code" href="../../d4/d40/structCurveMapping.html#a799bee38fb167d41e7ff198e86e359f5">preset</a> = preset;
<a name="l00422"></a>00422     <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ac3ec3c6480f50624abef2aa621aba9b1">curvemap_reset</a>(cm, &amp;b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>-&gt;<a class="code" href="../../d4/d40/structCurveMapping.html#a8a22e59a40d9fdd4cd46ebed31f078d4">clipr</a>, b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>-&gt;<a class="code" href="../../d4/d40/structCurveMapping.html#a799bee38fb167d41e7ff198e86e359f5">preset</a>, <a class="code" href="../../d4/dca/BKE__colortools_8h.html#ae7a30b4c8f1a5b4cc28a7375e55105bd">CURVEMAP_SLOPE_NEGATIVE</a>);
<a name="l00423"></a>00423     <a class="code" href="../../d4/dca/BKE__colortools_8h.html#af77727c97a9f13c114da3e7dc320f41e">curvemapping_changed</a>(b-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>, 0);
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="../../df/d2b/brush_8c.html#a52a98aad73211965e4bf06024a275055">00426</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa6222720369f4f7304ab1b0578c2f8a4">brush_texture_set_nr</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">int</span> nr)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     <a class="code" href="../../d8/d7e/structID.html">ID</a> *idtest, *<span class="keywordtype">id</span>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="keywordtype">id</span>= (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     idtest= (<a class="code" href="../../d8/d7e/structID.html">ID</a>*)<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;tex, nr-1);
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (idtest==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { <span class="comment">/* new tex */</span>
<a name="l00434"></a>00434         <span class="keywordflow">if</span> (<span class="keywordtype">id</span>) idtest= (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)<a class="code" href="../../d2/d66/BKE__texture_8h.html#a3cceee613a9f69934c09f1a051c9cb0f">copy_texture</a>((<a class="code" href="../../df/d2d/structTex.html">Tex</a> *)id);
<a name="l00435"></a>00435         <span class="keywordflow">else</span> idtest= (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)<a class="code" href="../../d2/d66/BKE__texture_8h.html#aea71c0bebaf638d73539d77503def50e">add_texture</a>(<span class="stringliteral">&quot;Tex&quot;</span>);
<a name="l00436"></a>00436         idtest-&gt;<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (idtest!=<span class="keywordtype">id</span>) {
<a name="l00439"></a>00439         <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4d237010760003df9ecc7b8315b34765">brush_texture_delete</a>(brush);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>= (<a class="code" href="../../df/d2d/structTex.html">Tex</a>*)idtest;
<a name="l00442"></a>00442         <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(idtest);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         <span class="keywordflow">return</span> 1;
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordflow">return</span> 0;
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="../../df/d2b/brush_8c.html#aea4372a9efe5ef287ae9cbe43a006089">00450</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4d237010760003df9ecc7b8315b34765">brush_texture_delete</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>)
<a name="l00453"></a>00453         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="keywordflow">return</span> 1;
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a><a class="code" href="../../df/d2b/brush_8c.html#a519619386e328eeb698e35b5e99de3b8">00458</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a2b58c9120e38d7f38b0bdb5d04dfebce">brush_clone_image_set_nr</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">int</span> nr)
<a name="l00459"></a>00459 {
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (brush &amp;&amp; nr &gt; 0) {
<a name="l00461"></a>00461         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= (<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a>*)<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image, nr-1);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="keywordflow">if</span> (ima) {
<a name="l00464"></a>00464             <a class="code" href="../../da/dc9/BKE__brush_8h.html#a20d0b2e43d4b0123f2f0449b9de2f6da">brush_clone_image_delete</a>(brush);
<a name="l00465"></a>00465             brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>= ima;
<a name="l00466"></a>00466             <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00467"></a>00467             brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>[0]= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>[1]= 0.0f;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469             <span class="keywordflow">return</span> 1;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="keywordflow">return</span> 0;
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00476"></a><a class="code" href="../../df/d2b/brush_8c.html#ab247e29ed5e6f101c124427ee32dbdbd">00476</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a20d0b2e43d4b0123f2f0449b9de2f6da">brush_clone_image_delete</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478     <span class="keywordflow">if</span> (brush &amp;&amp; brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>) {
<a name="l00479"></a>00479         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00480"></a>00480         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00481"></a>00481         <span class="keywordflow">return</span> 1;
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">return</span> 0;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="comment">/* Brush Sampling */</span>
<a name="l00488"></a><a class="code" href="../../df/d2b/brush_8c.html#a5bd6f5736c346d7b5a305704995781ff">00488</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keyword">const</span> <span class="keywordtype">float</span> xy[2], <span class="keywordtype">float</span> rgba[4], <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex= &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (mtex &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l00493"></a>00493         <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], tin, tr, tg, tb, ta;
<a name="l00494"></a>00494         <span class="keywordtype">int</span> hasrgb;
<a name="l00495"></a>00495         <span class="keyword">const</span> <span class="keywordtype">int</span> radius= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         co[0]= xy[0]/radius;
<a name="l00498"></a>00498         co[1]= xy[1]/radius;
<a name="l00499"></a>00499         co[2]= 0.0f;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         hasrgb= <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a833cb47a92698779f8873ec22ba1fad1">externtex</a>(mtex, co, &amp;tin, &amp;tr, &amp;tg, &amp;tb, &amp;ta, thread);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (hasrgb) {
<a name="l00504"></a>00504             rgba[0]= tr;
<a name="l00505"></a>00505             rgba[1]= tg;
<a name="l00506"></a>00506             rgba[2]= tb;
<a name="l00507"></a>00507             rgba[3]= ta;
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509         <span class="keywordflow">else</span> {
<a name="l00510"></a>00510             rgba[0]= tin;
<a name="l00511"></a>00511             rgba[1]= tin;
<a name="l00512"></a>00512             rgba[2]= tin;
<a name="l00513"></a>00513             rgba[3]= 1.0f;
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516     <span class="keywordflow">else</span> {
<a name="l00517"></a>00517         rgba[0]= rgba[1]= rgba[2]= rgba[3]= 1.0f;
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="comment">/* TODO, use define for &#39;texfall&#39; arg */</span>
<a name="l00522"></a><a class="code" href="../../df/d2b/brush_8c.html#a9e688ddfecb5c21ef378dcafdd39c341">00522</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ad209ef820289c8428dab9884e6cb122a">brush_imbuf_new</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">short</span> flt, <span class="keywordtype">short</span> texfall, <span class="keywordtype">int</span> bufsize, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> **outbuf, <span class="keywordtype">int</span> use_color_correction)
<a name="l00523"></a>00523 {
<a name="l00524"></a>00524     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00525"></a>00525     <span class="keywordtype">float</span> xy[2], rgba[4], *dstf;
<a name="l00526"></a>00526     <span class="keywordtype">int</span> x, y, rowbytes, xoff, yoff, imbflag;
<a name="l00527"></a>00527     <span class="keyword">const</span> <span class="keywordtype">int</span> radius= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l00528"></a>00528     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, crgb[3];
<a name="l00529"></a>00529     <span class="keyword">const</span> <span class="keywordtype">float</span> alpha= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(scene, brush);
<a name="l00530"></a>00530     <span class="keywordtype">float</span> brush_rgb[3];
<a name="l00531"></a>00531     
<a name="l00532"></a>00532     imbflag= (flt)? <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>: <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>;
<a name="l00533"></a>00533     xoff = -bufsize/2.0f + 0.5f;
<a name="l00534"></a>00534     yoff = -bufsize/2.0f + 0.5f;
<a name="l00535"></a>00535     rowbytes= bufsize*4;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (*outbuf)
<a name="l00538"></a>00538         ibuf= *outbuf;
<a name="l00539"></a>00539     <span class="keywordflow">else</span>
<a name="l00540"></a>00540         ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(bufsize, bufsize, 32, imbflag);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (flt) {
<a name="l00543"></a>00543         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(brush_rgb, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (use_color_correction) {
<a name="l00545"></a>00545             <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(brush_rgb, brush_rgb);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <span class="keywordflow">for</span> (y=0; y &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; y++) {
<a name="l00549"></a>00549             dstf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + y*rowbytes;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551             <span class="keywordflow">for</span> (x=0; x &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>; x++, dstf+=4) {
<a name="l00552"></a>00552                 xy[0] = x + xoff;
<a name="l00553"></a>00553                 xy[1] = y + yoff;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555                 <span class="keywordflow">if</span> (texfall == 0) {
<a name="l00556"></a>00556                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dstf, brush_rgb);
<a name="l00557"></a>00557                     dstf[3]= alpha*<a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(brush, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(xy), radius);
<a name="l00558"></a>00558                 }
<a name="l00559"></a>00559                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texfall == 1) {
<a name="l00560"></a>00560                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, dstf, 0);
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562                 <span class="keywordflow">else</span> {
<a name="l00563"></a>00563                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, rgba, 0);
<a name="l00564"></a>00564                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(dstf, rgba, brush_rgb);
<a name="l00565"></a>00565                     dstf[3] = rgba[3]*alpha*<a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(brush, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(xy), radius);
<a name="l00566"></a>00566                 }
<a name="l00567"></a>00567             }
<a name="l00568"></a>00568         }
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     <span class="keywordflow">else</span> {
<a name="l00571"></a>00571         <span class="keywordtype">float</span> alpha_f; <span class="comment">/* final float alpha to convert to char */</span>
<a name="l00572"></a>00572         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a9b3bb8bb3331550782244e732cd1d349">rgb_float_to_uchar</a>(crgb, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         <span class="keywordflow">for</span> (y=0; y &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; y++) {
<a name="l00575"></a>00575             dst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + y*rowbytes;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577             for (x=0; x &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>; x++, dst+=4) {
<a name="l00578"></a>00578                 xy[0] = x + xoff;
<a name="l00579"></a>00579                 xy[1] = y + yoff;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                 <span class="keywordflow">if</span> (texfall == 0) {
<a name="l00582"></a>00582                     alpha_f = alpha * <a class="code" href="../../da/dc9/BKE__brush_8h.html#afcd6c828e3c28abab8e3aaf5f32b60d9">brush_curve_strength</a>(brush, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(xy), radius);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                     dst[0] = crgb[0];
<a name="l00585"></a>00585                     dst[1] = crgb[1];
<a name="l00586"></a>00586                     dst[2] = crgb[2];
<a name="l00587"></a>00587                     dst[3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(alpha_f);
<a name="l00588"></a>00588                 }
<a name="l00589"></a>00589                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texfall == 1) {
<a name="l00590"></a>00590                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, rgba, 0);
<a name="l00591"></a>00591                     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ae4ca069c8f950fd8499b3aaa9c0a57d6">rgba_float_to_uchar</a>(dst, rgba);
<a name="l00592"></a>00592                 }
<a name="l00593"></a>00593                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texfall == 2) {
<a name="l00594"></a>00594                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, rgba, 0);
<a name="l00595"></a>00595                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3c368253a0bd6032fa80dba876df5425">mul_v3_v3</a>(rgba, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l00596"></a>00596                     alpha_f = rgba[3] * alpha * <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(brush, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(xy), radius);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598                     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a9b3bb8bb3331550782244e732cd1d349">rgb_float_to_uchar</a>(dst, rgba);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600                     dst[3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(alpha_f);
<a name="l00601"></a>00601                 }
<a name="l00602"></a>00602                 <span class="keywordflow">else</span> {
<a name="l00603"></a>00603                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, rgba, 0);
<a name="l00604"></a>00604                     alpha_f = rgba[3] * alpha * <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(brush, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(xy), radius);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606                     dst[0] = crgb[0];
<a name="l00607"></a>00607                     dst[1] = crgb[1];
<a name="l00608"></a>00608                     dst[2] = crgb[2];
<a name="l00609"></a>00609                     dst[3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(alpha_f);
<a name="l00610"></a>00610                 }
<a name="l00611"></a>00611             }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     *outbuf= ibuf;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">/* Unified Size and Strength */</span>
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="comment">// XXX: be careful about setting size and unprojected radius</span>
<a name="l00621"></a>00621 <span class="comment">// because they depend on one another</span>
<a name="l00622"></a>00622 <span class="comment">// these functions do not set the other corresponding value</span>
<a name="l00623"></a>00623 <span class="comment">// this can lead to odd behavior if size and unprojected</span>
<a name="l00624"></a>00624 <span class="comment">// radius become inconsistent.</span>
<a name="l00625"></a>00625 <span class="comment">// the biggest problem is that it isn&#39;t possible to change</span>
<a name="l00626"></a>00626 <span class="comment">// unprojected radius because a view context is not</span>
<a name="l00627"></a>00627 <span class="comment">// available.  my ussual solution to this is to use the</span>
<a name="l00628"></a>00628 <span class="comment">// ratio of change of the size to change the unprojected</span>
<a name="l00629"></a>00629 <span class="comment">// radius.  Not completely convinced that is correct.</span>
<a name="l00630"></a>00630 <span class="comment">// In anycase, a better solution is needed to prevent</span>
<a name="l00631"></a>00631 <span class="comment">// inconsistency.</span>
<a name="l00632"></a>00632 
<a name="l00633"></a><a class="code" href="../../df/d2b/brush_8c.html#a9c792b734b645dd600aba52db3e03708">00633</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>)
<a name="l00638"></a>00638         ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a04acc9601d0f85542b037b823d004da0">size</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00639"></a>00639     <span class="keywordflow">else</span>
<a name="l00640"></a>00640         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a9cf9fcecab64b7e853066eb75d4c78d4">size</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="../../df/d2b/brush_8c.html#a3ff721735d3be1df8be905cc9e5f94ed">00643</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <span class="keywordflow">return</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>) ? ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a04acc9601d0f85542b037b823d004da0">size</a> : brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a9cf9fcecab64b7e853066eb75d4c78d4">size</a>;
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="../../df/d2b/brush_8c.html#a46e78244ba0b0a9123376ab8ac63ee98">00650</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#af14a6efb74307c40b650151608585bf6">brush_use_locked_size</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="keyword">const</span> <span class="keywordtype">short</span> us_flag = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>.<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a>;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="keywordflow">return</span> (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>) ?
<a name="l00655"></a>00655             (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a6ca37c0c5e6b2e261f0b5d36f9abd9e5">UNIFIED_PAINT_BRUSH_LOCK_SIZE</a>) :
<a name="l00656"></a>00656             (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baabaf4e3d5fd85b6ad0442d3a3713760fb">BRUSH_LOCK_SIZE</a>);
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00659"></a><a class="code" href="../../df/d2b/brush_8c.html#a17db2c6c8f1432a90419c65c55a8996a">00659</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661     <span class="keyword">const</span> <span class="keywordtype">short</span> us_flag = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>.<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="keywordflow">return</span> (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>) ?
<a name="l00664"></a>00664             (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883ad62c1096465f5202977e74d2fba1346c">UNIFIED_PAINT_BRUSH_SIZE_PRESSURE</a>) :
<a name="l00665"></a>00665             (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaeaf56ab45402053483316909c0ae8e10">BRUSH_SIZE_PRESSURE</a>);
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a><a class="code" href="../../df/d2b/brush_8c.html#ac3c133c07f8e9c1a3f2a8f4fd3ea2c41">00668</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670     <span class="keyword">const</span> <span class="keywordtype">short</span> us_flag = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>.<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">return</span> (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a8264ad1822e030a1eb1e76a59628b679">UNIFIED_PAINT_ALPHA</a>) ?
<a name="l00673"></a>00673             (us_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a8b3fffd22a84c6fb5df9fcad62c576de">UNIFIED_PAINT_BRUSH_ALPHA_PRESSURE</a>) :
<a name="l00674"></a>00674             (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa1ceadb32af646d1aefddce74622934fd">BRUSH_ALPHA_PRESSURE</a>);
<a name="l00675"></a>00675 }
<a name="l00676"></a>00676 
<a name="l00677"></a><a class="code" href="../../df/d2b/brush_8c.html#ae9a823523ea0a77fab69cfede5dbb9ff">00677</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae3b23fd74a84a739f9a3ed82c2973935">brush_set_unprojected_radius</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">float</span> unprojected_radius)
<a name="l00678"></a>00678 {
<a name="l00679"></a>00679     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>)
<a name="l00682"></a>00682         ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a7640bf1c669a3f0ecd9f3dd73e64e4d4">unprojected_radius</a>= unprojected_radius;
<a name="l00683"></a>00683     <span class="keywordflow">else</span>
<a name="l00684"></a>00684         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3eaaeca69e25ae6877ea6a318c61a9f6">unprojected_radius</a>= unprojected_radius;
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="../../df/d2b/brush_8c.html#aa8b8285a36d885180b22c6e3cd8d940b">00687</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41b4719703fddf033bfac555bd01d5c4">brush_unprojected_radius</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">return</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a67e9575be155179fa71df8abcf699b91">UNIFIED_PAINT_SIZE</a>) ?
<a name="l00692"></a>00692             ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a7640bf1c669a3f0ecd9f3dd73e64e4d4">unprojected_radius</a> :
<a name="l00693"></a>00693             brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3eaaeca69e25ae6877ea6a318c61a9f6">unprojected_radius</a>;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="../../df/d2b/brush_8c.html#ae6e53b1ad46fd567235d71c977ede805">00696</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#ae6e53b1ad46fd567235d71c977ede805">brush_set_alpha</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">float</span> alpha)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a8264ad1822e030a1eb1e76a59628b679">UNIFIED_PAINT_ALPHA</a>)
<a name="l00701"></a>00701         ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a54a33983d3e43124d7c3b908cbb98e3f">alpha</a>= alpha;
<a name="l00702"></a>00702     <span class="keywordflow">else</span>
<a name="l00703"></a>00703         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a05d1b34fb95a0932190b690b61b276ee">alpha</a>= alpha;
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a><a class="code" href="../../df/d2b/brush_8c.html#ac48392f9c006d36f182f6feb0a0f10c9">00706</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/df1/structbContext.html#afdb25fc2860ffc38a34af50e3bdc772c">scene</a>, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708     <a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html">UnifiedPaintSettings</a> *ups = &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a588da956ca487565352dd4fc8f8cef08">unified_paint_settings</a>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">return</span> (ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a211cc9a005afbe46b6b31d685ad02721">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af5df1186bc4f7ee1c68d587575caa883a8264ad1822e030a1eb1e76a59628b679">UNIFIED_PAINT_ALPHA</a>) ? ups-&gt;<a class="code" href="../../d0/dbe/structUnifiedPaintSettings.html#a54a33983d3e43124d7c3b908cbb98e3f">alpha</a> : brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a05d1b34fb95a0932190b690b61b276ee">alpha</a>;
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="comment">/* scale unprojected radius to reflect a change in the brush&#39;s 2D size */</span>
<a name="l00714"></a><a class="code" href="../../df/d2b/brush_8c.html#a7d297a5b1e7deec0090e970312a296bf">00714</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a7d297a5b1e7deec0090e970312a296bf">brush_scale_unprojected_radius</a>(<span class="keywordtype">float</span> *unprojected_radius,
<a name="l00715"></a>00715                                     <span class="keywordtype">int</span> new_brush_size,
<a name="l00716"></a>00716                                     <span class="keywordtype">int</span> old_brush_size)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <span class="keywordtype">float</span> scale = new_brush_size;
<a name="l00719"></a>00719     <span class="comment">/* avoid division by zero */</span>
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (old_brush_size != 0)
<a name="l00721"></a>00721         scale /= (float)old_brush_size;
<a name="l00722"></a>00722     (*unprojected_radius) *= scale;
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="comment">/* scale brush size to reflect a change in the brush&#39;s unprojected radius */</span>
<a name="l00726"></a><a class="code" href="../../df/d2b/brush_8c.html#af814019840a1d32056b5cc1434951a0b">00726</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#af814019840a1d32056b5cc1434951a0b">brush_scale_size</a>(<span class="keywordtype">int</span> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>,
<a name="l00727"></a>00727                       <span class="keywordtype">float</span> new_unprojected_radius,
<a name="l00728"></a>00728                       <span class="keywordtype">float</span> old_unprojected_radius)
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730     <span class="keywordtype">float</span> scale = new_unprojected_radius;
<a name="l00731"></a>00731     <span class="comment">/* avoid division by zero */</span>
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (old_unprojected_radius != 0)
<a name="l00733"></a>00733         scale /= new_unprojected_radius;
<a name="l00734"></a>00734     (*brush_size)= (int)((<span class="keywordtype">float</span>)(*brush_size) * scale);
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <span class="comment">/* Brush Painting */</span>
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html">00739</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/dc7/structBrushPainterCache.html">BrushPainterCache</a> {
<a name="l00740"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">00740</a>     <span class="keywordtype">short</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>;
<a name="l00741"></a>00741 
<a name="l00742"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">00742</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">size</a>;           <span class="comment">/* size override, if 0 uses 2*brush_size(brush) */</span>
<a name="l00743"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">00743</a>     <span class="keywordtype">short</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a>;          <span class="comment">/* need float imbuf? */</span>
<a name="l00744"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#afc346c2492dd7a954d34f054c14aa582">00744</a>     <span class="keywordtype">short</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#afc346c2492dd7a954d34f054c14aa582">texonly</a>;      <span class="comment">/* no alpha, color or fallof, only texture in imbuf */</span>
<a name="l00745"></a>00745 
<a name="l00746"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">00746</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a>;
<a name="l00747"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a3dfcf7d8ef92b2496abfb5eb6523db95">00747</a>     <span class="keywordtype">float</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#a3dfcf7d8ef92b2496abfb5eb6523db95">lastalpha</a>;
<a name="l00748"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4eca1a1604ed236895a8eff236935c29">00748</a>     <span class="keywordtype">float</span> <a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4eca1a1604ed236895a8eff236935c29">lastjitter</a>;
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">00750</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>;
<a name="l00751"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">00751</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>;
<a name="l00752"></a><a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">00752</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>;
<a name="l00753"></a>00753 } <a class="code" href="../../df/d2b/brush_8c.html#a17af148343b87832a4d78930d80f85e8">BrushPainterCache</a>;
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="../../d4/dc9/structBrushPainter.html">00755</a> <span class="keyword">struct </span><a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> {
<a name="l00756"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">00756</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>;
<a name="l00757"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">00757</a>     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l00758"></a>00758 
<a name="l00759"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">00759</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[2];  <span class="comment">/* mouse position of last paint call */</span>
<a name="l00760"></a>00760 
<a name="l00761"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">00761</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a>;    <span class="comment">/* accumulated distance of brush since last paint op */</span>
<a name="l00762"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">00762</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[2];  <span class="comment">/* position of last paint op */</span>
<a name="l00763"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">00763</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">startpaintpos</a>[2]; <span class="comment">/* position of first paint */</span>
<a name="l00764"></a>00764 
<a name="l00765"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">00765</a>     <span class="keywordtype">double</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a>;       <span class="comment">/* accumulated time since last paint op (airbrush) */</span>
<a name="l00766"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">00766</a>     <span class="keywordtype">double</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>;        <span class="comment">/* time of last update */</span>
<a name="l00767"></a>00767 
<a name="l00768"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">00768</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a>;
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">00770</a>     <span class="keywordtype">short</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">firsttouch</a>;       <span class="comment">/* first paint op */</span>
<a name="l00771"></a>00771 
<a name="l00772"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">00772</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">startsize</a>;
<a name="l00773"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">00773</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">startalpha</a>;
<a name="l00774"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">00774</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">startjitter</a>;
<a name="l00775"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">00775</a>     <span class="keywordtype">float</span> <a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">startspacing</a>;
<a name="l00776"></a>00776 
<a name="l00777"></a><a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">00777</a>     <a class="code" href="../../d8/dc7/structBrushPainterCache.html">BrushPainterCache</a> <a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>;
<a name="l00778"></a>00778 };
<a name="l00779"></a>00779 
<a name="l00780"></a><a class="code" href="../../df/d2b/brush_8c.html#ada9080724aa8a906cfae8ddbe009c6d4">00780</a> <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#ab89d23567cf26e1640346524daf7fdc5">brush_painter_new</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782     <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a>), <span class="stringliteral">&quot;BrushPainter&quot;</span>);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>= brush;
<a name="l00785"></a>00785     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>= scene;
<a name="l00786"></a>00786     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">firsttouch</a>= 1;
<a name="l00787"></a>00787     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a>= -1; <span class="comment">/* force ibuf create in refresh */</span>
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">startsize</a> = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l00790"></a>00790     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">startalpha</a> = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(scene, brush);
<a name="l00791"></a>00791     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">startjitter</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a>;
<a name="l00792"></a>00792     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">startspacing</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a>;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="keywordflow">return</span> painter;
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a><a class="code" href="../../df/d2b/brush_8c.html#a491a1be93918327ffa2779443fa73caa">00797</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a491a1be93918327ffa2779443fa73caa">brush_painter_require_imbuf</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keywordtype">short</span> flt, <span class="keywordtype">short</span> texonly, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799     <span class="keywordflow">if</span> ((painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a> != flt) || (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">size</a> != size) ||
<a name="l00800"></a>00800         ((painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afc346c2492dd7a954d34f054c14aa582">texonly</a> != texonly) &amp;&amp; texonly)) {
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>);
<a name="l00802"></a>00802         <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>);
<a name="l00803"></a>00803         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00804"></a>00804         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a>= -1; <span class="comment">/* force ibuf create in refresh */</span>
<a name="l00805"></a>00805     }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a> != flt) {
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>);
<a name="l00809"></a>00809         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00810"></a>00810         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a>= -1; <span class="comment">/* force ibuf create in refresh */</span>
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">size</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00814"></a>00814     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a>= flt;
<a name="l00815"></a>00815     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afc346c2492dd7a954d34f054c14aa582">texonly</a>= texonly;
<a name="l00816"></a>00816     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>= 1;
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a><a class="code" href="../../df/d2b/brush_8c.html#a9b08758992635893d820454d81e22494">00819</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9b08758992635893d820454d81e22494">brush_painter_free</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter)
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">startsize</a>);
<a name="l00824"></a>00824     <a class="code" href="../../df/d2b/brush_8c.html#ae6e53b1ad46fd567235d71c977ede805">brush_set_alpha</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">startalpha</a>);
<a name="l00825"></a>00825     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a> = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">startjitter</a>;
<a name="l00826"></a>00826     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a> = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">startspacing</a>;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>);
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>);
<a name="l00830"></a>00830     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>);
<a name="l00831"></a>00831     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(painter);
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a><a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">00834</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *oldtexibuf,
<a name="l00835"></a>00835                                      <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h, <span class="keywordtype">int</span> xt, <span class="keywordtype">int</span> yt,
<a name="l00836"></a>00836                                      <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2])
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>;
<a name="l00839"></a>00839     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l00840"></a>00840     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, *maskibuf, *texibuf;
<a name="l00841"></a>00841     <span class="keywordtype">float</span> *bf, *mf, *tf, *otf=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, xoff, yoff, xy[2], rgba[4];
<a name="l00842"></a>00842     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *b, *m, *t, *ot= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00843"></a>00843     <span class="keywordtype">int</span> dotexold, origx= x, origy= y;
<a name="l00844"></a>00844     <span class="keyword">const</span> <span class="keywordtype">int</span> radius= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     xoff = -radius + 0.5f;
<a name="l00847"></a>00847     yoff = -radius + 0.5f;
<a name="l00848"></a>00848     xoff += (int)pos[0] - (<span class="keywordtype">int</span>)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">startpaintpos</a>[0];
<a name="l00849"></a>00849     yoff += (int)pos[1] - (<span class="keywordtype">int</span>)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">startpaintpos</a>[1];
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     ibuf = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>;
<a name="l00852"></a>00852     texibuf = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>;
<a name="l00853"></a>00853     maskibuf = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     dotexold = (oldtexibuf != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="comment">/* not sure if it&#39;s actually needed or it&#39;s a mistake in coords/sizes</span>
<a name="l00858"></a>00858 <span class="comment">     * calculation in brush_painter_fixed_tex_partial_update(), but without this</span>
<a name="l00859"></a>00859 <span class="comment">     * limitation memory gets corrupted at fast strokes with quite big spacing (sergey) */</span>
<a name="l00860"></a>00860     w = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(w, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00861"></a>00861     h = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(h, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a>) {
<a name="l00864"></a>00864         <span class="keywordflow">for</span> (; y &lt; h; y++) {
<a name="l00865"></a>00865             bf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (y*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00866"></a>00866             tf = texibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (y*texibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00867"></a>00867             mf = maskibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (y*maskibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869             <span class="keywordflow">if</span> (dotexold)
<a name="l00870"></a>00870                 otf = oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + ((y - origy + yt)*oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + xt)*4;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872             <span class="keywordflow">for</span> (x=origx; x &lt; w; x++, bf+=4, mf+=4, tf+=4) {
<a name="l00873"></a>00873                 <span class="keywordflow">if</span> (dotexold) {
<a name="l00874"></a>00874                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tf, otf);
<a name="l00875"></a>00875                     tf[3] = otf[3];
<a name="l00876"></a>00876                     otf += 4;
<a name="l00877"></a>00877                 }
<a name="l00878"></a>00878                 <span class="keywordflow">else</span> {
<a name="l00879"></a>00879                     xy[0] = x + xoff;
<a name="l00880"></a>00880                     xy[1] = y + yoff;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, tf, 0);
<a name="l00883"></a>00883                 }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885                 bf[0] = tf[0]*mf[0];
<a name="l00886"></a>00886                 bf[1] = tf[1]*mf[1];
<a name="l00887"></a>00887                 bf[2] = tf[2]*mf[2];
<a name="l00888"></a>00888                 bf[3] = tf[3]*mf[3];
<a name="l00889"></a>00889             }
<a name="l00890"></a>00890         }
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892     <span class="keywordflow">else</span> {
<a name="l00893"></a>00893         <span class="keywordflow">for</span> (; y &lt; h; y++) {
<a name="l00894"></a>00894             b = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + (y*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00895"></a>00895             t = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)texibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + (y*texibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00896"></a>00896             m = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)maskibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + (y*maskibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + origx)*4;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898             <span class="keywordflow">if</span> (dotexold)
<a name="l00899"></a>00899                 ot = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + ((y - origy + yt)*oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + xt)*4;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901             <span class="keywordflow">for</span> (x=origx; x &lt; w; x++, b+=4, m+=4, t+=4) {
<a name="l00902"></a>00902                 <span class="keywordflow">if</span> (dotexold) {
<a name="l00903"></a>00903                     t[0] = ot[0];
<a name="l00904"></a>00904                     t[1] = ot[1];
<a name="l00905"></a>00905                     t[2] = ot[2];
<a name="l00906"></a>00906                     t[3] = ot[3];
<a name="l00907"></a>00907                     ot += 4;
<a name="l00908"></a>00908                 }
<a name="l00909"></a>00909                 <span class="keywordflow">else</span> {
<a name="l00910"></a>00910                     xy[0] = x + xoff;
<a name="l00911"></a>00911                     xy[1] = y + yoff;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                     <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(scene, brush, xy, rgba, 0);
<a name="l00914"></a>00914                     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ae4ca069c8f950fd8499b3aaa9c0a57d6">rgba_float_to_uchar</a>(t, rgba);
<a name="l00915"></a>00915                 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917                 b[0] = t[0]*m[0]/255;
<a name="l00918"></a>00918                 b[1] = t[1]*m[1]/255;
<a name="l00919"></a>00919                 b[2] = t[2]*m[2]/255;
<a name="l00920"></a>00920                 b[3] = t[3]*m[3]/255;
<a name="l00921"></a>00921             }
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00926"></a><a class="code" href="../../df/d2b/brush_8c.html#ae17b700c03a4394d01b0b245135b3e6c">00926</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#ae17b700c03a4394d01b0b245135b3e6c">brush_painter_fixed_tex_partial_update</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2])
<a name="l00927"></a>00927 {
<a name="l00928"></a>00928     <span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>;
<a name="l00929"></a>00929     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l00930"></a>00930     <a class="code" href="../../d8/dc7/structBrushPainterCache.html">BrushPainterCache</a> *cache= &amp;painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>;
<a name="l00931"></a>00931     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *oldtexibuf, *ibuf;
<a name="l00932"></a>00932     <span class="keywordtype">int</span> imbflag, destx, desty, srcx, srcy, w, h, x1, y1, x2, y2;
<a name="l00933"></a>00933     <span class="keyword">const</span> <span class="keywordtype">int</span> diameter= 2*<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     imbflag= (cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a>)? <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>: <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>;
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (!cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>)
<a name="l00937"></a>00937         cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(diameter, diameter, 32, imbflag);
<a name="l00938"></a>00938     ibuf= cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>;
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     oldtexibuf= cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>;
<a name="l00941"></a>00941     cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(diameter, diameter, 32, imbflag);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (oldtexibuf) {
<a name="l00944"></a>00944         srcx= srcy= 0;
<a name="l00945"></a>00945         destx= (int)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0] - (<span class="keywordtype">int</span>)pos[0];
<a name="l00946"></a>00946         desty= (int)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1] - (<span class="keywordtype">int</span>)pos[1];
<a name="l00947"></a>00947         w= oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00948"></a>00948         h= oldtexibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a15a5bfbeb712924c5bd3742a768143ec">IMB_rectclip</a>(cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#aca743295c0852ae19889893ad1b5dbba">texibuf</a>, oldtexibuf, &amp;destx, &amp;desty, &amp;srcx, &amp;srcy, &amp;w, &amp;h);
<a name="l00951"></a>00951     }
<a name="l00952"></a>00952     <span class="keywordflow">else</span> {
<a name="l00953"></a>00953         srcx= srcy= 0;
<a name="l00954"></a>00954         destx= desty= 0;
<a name="l00955"></a>00955         w= h= 0;
<a name="l00956"></a>00956     }
<a name="l00957"></a>00957     
<a name="l00958"></a>00958     x1= destx;
<a name="l00959"></a>00959     y1= desty;
<a name="l00960"></a>00960     x2= destx+w;
<a name="l00961"></a>00961     y2= desty+h;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">/* blend existing texture in new position */</span>
<a name="l00964"></a>00964     <span class="keywordflow">if</span> ((x1 &lt; x2) &amp;&amp; (y1 &lt; y2))
<a name="l00965"></a>00965         <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(painter, oldtexibuf, x1, y1, x2, y2, srcx, srcy, pos);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (oldtexibuf)
<a name="l00968"></a>00968         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(oldtexibuf);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <span class="comment">/* sample texture in new areas */</span>
<a name="l00971"></a>00971     <span class="keywordflow">if</span> ((0 &lt; x1) &amp;&amp; (0 &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>))
<a name="l00972"></a>00972         <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(painter, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, x1, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 0, 0, pos);
<a name="l00973"></a>00973     <span class="keywordflow">if</span> ((x2 &lt; ibuf-&gt;x) &amp;&amp; (0 &lt; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>))
<a name="l00974"></a>00974         <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(painter, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x2, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 0, 0, pos);
<a name="l00975"></a>00975     <span class="keywordflow">if</span> ((x1 &lt; x2) &amp;&amp; (0 &lt; y1))
<a name="l00976"></a>00976         <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(painter, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x1, 0, x2, y1, 0, 0, pos);
<a name="l00977"></a>00977     <span class="keywordflow">if</span> ((x1 &lt; x2) &amp;&amp; (y2 &lt; ibuf-&gt;y))
<a name="l00978"></a>00978         <a class="code" href="../../df/d2b/brush_8c.html#a7fed86c6d9811c8cc7f4061e1161d28f">brush_painter_do_partial</a>(painter, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x1, y2, x2, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 0, 0, pos);
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a><a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">00981</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> use_color_correction)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983     <span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>;
<a name="l00984"></a>00984     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l00985"></a>00985     <a class="code" href="../../d8/dc7/structBrushPainterCache.html">BrushPainterCache</a> *cache= &amp;painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>;
<a name="l00986"></a>00986     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex= &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>;
<a name="l00987"></a>00987     <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00988"></a>00988     <span class="keywordtype">short</span> flt;
<a name="l00989"></a>00989     <span class="keyword">const</span> <span class="keywordtype">int</span> diameter= 2*<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l00990"></a>00990     <span class="keyword">const</span> <span class="keywordtype">float</span> alpha= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(scene, brush);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     <span class="keywordflow">if</span> (diameter != cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a> ||
<a name="l00993"></a>00993         alpha != cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a3dfcf7d8ef92b2496abfb5eb6523db95">lastalpha</a> ||
<a name="l00994"></a>00994         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a> != cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4eca1a1604ed236895a8eff236935c29">lastjitter</a>)
<a name="l00995"></a>00995     {
<a name="l00996"></a>00996         <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>) {
<a name="l00997"></a>00997             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>);
<a name="l00998"></a>00998             cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00999"></a>00999         }
<a name="l01000"></a>01000         <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>) {
<a name="l01001"></a>01001             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>);
<a name="l01002"></a>01002             cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         flt= cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#afad8089e6a5979d75f16a63ad23ebef9">flt</a>;
<a name="l01006"></a>01006         size= (cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">size</a>)? cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a214f65e77cc3fabedfb39b69c49fad17">size</a>: diameter;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa915ac4283e5c43b73cc5da10130549df">BRUSH_FIXED_TEX</a>) {
<a name="l01009"></a>01009             <a class="code" href="../../da/dc9/BKE__brush_8h.html#ad209ef820289c8428dab9884e6cb122a">brush_imbuf_new</a>(scene, brush, flt, 3, size, &amp;cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a8dea8ba5dcc51dc065c38f8949eca916">maskibuf</a>, use_color_correction);
<a name="l01010"></a>01010             <a class="code" href="../../df/d2b/brush_8c.html#ae17b700c03a4394d01b0b245135b3e6c">brush_painter_fixed_tex_partial_update</a>(painter, pos);
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012         <span class="keywordflow">else</span>
<a name="l01013"></a>01013             <a class="code" href="../../da/dc9/BKE__brush_8h.html#ad209ef820289c8428dab9884e6cb122a">brush_imbuf_new</a>(scene, brush, flt, 2, size, &amp;cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>, use_color_correction);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015         cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4b372dc06d6da7a650f5928729b346fd">lastsize</a>= diameter;
<a name="l01016"></a>01016         cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a3dfcf7d8ef92b2496abfb5eb6523db95">lastalpha</a>= alpha;
<a name="l01017"></a>01017         cache-&gt;<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a4eca1a1604ed236895a8eff236935c29">lastjitter</a>= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a>;
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa915ac4283e5c43b73cc5da10130549df">BRUSH_FIXED_TEX</a>) &amp;&amp; mtex &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l01020"></a>01020         <span class="keywordtype">int</span> dx = (int)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0] - (<span class="keywordtype">int</span>)pos[0];
<a name="l01021"></a>01021         <span class="keywordtype">int</span> dy = (int)painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1] - (<span class="keywordtype">int</span>)pos[1];
<a name="l01022"></a>01022 
<a name="l01023"></a>01023         <span class="keywordflow">if</span> ((dx != 0) || (dy != 0))
<a name="l01024"></a>01024             <a class="code" href="../../df/d2b/brush_8c.html#ae17b700c03a4394d01b0b245135b3e6c">brush_painter_fixed_tex_partial_update</a>(painter, pos);
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="../../df/d2b/brush_8c.html#a9c2cef2ed6fbc7ee51686cd6c7216073">01028</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9c2cef2ed6fbc7ee51686cd6c7216073">brush_painter_break_stroke</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">firsttouch</a>= 1;
<a name="l01031"></a>01031 }
<a name="l01032"></a>01032 
<a name="l01033"></a><a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">01033</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">brush_apply_pressure</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keywordtype">float</span> pressure)
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035     <span class="keywordflow">if</span> (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush)) 
<a name="l01036"></a>01036         <a class="code" href="../../df/d2b/brush_8c.html#ae6e53b1ad46fd567235d71c977ede805">brush_set_alpha</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush, <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(0.0f, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">startalpha</a>*pressure));
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush))
<a name="l01038"></a>01038         <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>, brush, <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1.0f, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">startsize</a>*pressure));
<a name="l01039"></a>01039     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baab449aef9850266fa70c1a3da48cf4759">BRUSH_JITTER_PRESSURE</a>)
<a name="l01040"></a>01040         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(0.0f, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">startjitter</a>*pressure);
<a name="l01041"></a>01041     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa58e5ffa5a3828b73f28d92bba74d41f4">BRUSH_SPACING_PRESSURE</a>)
<a name="l01042"></a>01042         brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1.0f, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">startspacing</a>*(1.5f-pressure));
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 
<a name="l01045"></a><a class="code" href="../../df/d2b/brush_8c.html#ae19489610c50964da08bae780616e053">01045</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4797562c53e58126ef811986212b468f">brush_jitter_pos</a>(<span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush, <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2], <span class="keywordtype">float</span> jitterpos[2])
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047     <span class="keywordtype">int</span> use_jitter= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a> != 0;
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     <span class="comment">/* jitter-ed brush gives weird and unpredictable result for this</span>
<a name="l01050"></a>01050 <span class="comment">     * kinds of stroke, so manyally disable jitter usage (sergey) */</span>
<a name="l01051"></a>01051     use_jitter &amp;= (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; (<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf0aabbde784d13487aa9a0475a5a973f">BRUSH_RESTORE_MESH</a>|<a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaa226f73c6e663f17d978981991b101df">BRUSH_ANCHORED</a>)) == 0;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="keywordflow">if</span> (use_jitter) {
<a name="l01054"></a>01054         <span class="keywordtype">float</span> rand_pos[2];
<a name="l01055"></a>01055         <span class="keyword">const</span> <span class="keywordtype">int</span> radius= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l01056"></a>01056         <span class="keyword">const</span> <span class="keywordtype">int</span> diameter= 2*radius;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         <span class="comment">// find random position within a circle of diameter 1</span>
<a name="l01059"></a>01059         <span class="keywordflow">do</span> {
<a name="l01060"></a>01060             rand_pos[0] = <a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f;
<a name="l01061"></a>01061             rand_pos[1] = <a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>()-0.5f;
<a name="l01062"></a>01062         } <span class="keywordflow">while</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(rand_pos) &gt; 0.5f);
<a name="l01063"></a>01063 
<a name="l01064"></a>01064         jitterpos[0] = pos[0] + 2*rand_pos[0]*diameter*brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a>;
<a name="l01065"></a>01065         jitterpos[1] = pos[1] + 2*rand_pos[1]*diameter*brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a>;
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067     <span class="keywordflow">else</span> {
<a name="l01068"></a>01068         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(jitterpos, pos);
<a name="l01069"></a>01069     }
<a name="l01070"></a>01070 }
<a name="l01071"></a>01071 
<a name="l01072"></a><a class="code" href="../../df/d2b/brush_8c.html#a732ac43ad904347516905410b680b36f">01072</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a732ac43ad904347516905410b680b36f">brush_painter_paint</a>(<a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa27310a2d6abc805f807cae72ba48e5a">BrushFunc</a> func, <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2], <span class="keywordtype">double</span> time, <span class="keywordtype">float</span> pressure,
<a name="l01073"></a>01073                         <span class="keywordtype">void</span> *user, <span class="keywordtype">int</span> use_color_correction)
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a92d740bf081432834f4d0620abea8ab7">scene</a>;
<a name="l01076"></a>01076     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>;
<a name="l01077"></a>01077     <span class="keywordtype">int</span> totpaintops= 0;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (pressure == 0.0f) {
<a name="l01080"></a>01080         <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a>) <span class="comment">// XXX - hack, operator misses</span>
<a name="l01081"></a>01081             pressure= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a>;
<a name="l01082"></a>01082         <span class="keywordflow">else</span>
<a name="l01083"></a>01083             pressure = 1.0f;    <span class="comment">/* zero pressure == not using tablet */</span>
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085     <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">firsttouch</a>) {
<a name="l01086"></a>01086         <span class="comment">/* paint exactly once on first touch */</span>
<a name="l01087"></a>01087         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">startpaintpos</a>[0]= pos[0];
<a name="l01088"></a>01088         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9df3283f9e83d87f356ec094f3bafe9a">startpaintpos</a>[1]= pos[1];
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">brush_apply_pressure</a>(painter, brush, pressure);
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>)
<a name="l01092"></a>01092             <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(painter, pos, use_color_correction);
<a name="l01093"></a>01093         totpaintops += func(user, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>, pos, pos);
<a name="l01094"></a>01094         
<a name="l01095"></a>01095         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>= time;
<a name="l01096"></a>01096         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af10f8620cb04e6f7562b914f3d1b1497">firsttouch</a>= 0;
<a name="l01097"></a>01097         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0]= pos[0];
<a name="l01098"></a>01098         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1]= pos[1];
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100 <span class="preprocessor">#if 0</span>
<a name="l01101"></a>01101 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a00183f059766280cd4841027f2b1d7ef">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf33942d16772316fcb0e94d4a77eaba2">BRUSH_AIRBRUSH</a>) {
<a name="l01102"></a>01102         <span class="keywordtype">float</span> spacing, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, paintpos[2], dmousepos[2], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01103"></a>01103         <span class="keywordtype">double</span> starttime, curtime= time;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105         <span class="comment">/* compute brush spacing adapted to brush size */</span>
<a name="l01106"></a>01106         spacing= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#acda87e5d0baba3a86b0fed2d3f5a13f4">rate</a>; <span class="comment">//radius*brush-&gt;spacing*0.01f;</span>
<a name="l01107"></a>01107 
<a name="l01108"></a>01108         <span class="comment">/* setup starting time, direction vector and accumulated time */</span>
<a name="l01109"></a>01109         starttime= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a>;
<a name="l01110"></a>01110         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dmousepos, pos, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>);
<a name="l01111"></a>01111         len= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dmousepos);
<a name="l01112"></a>01112         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> += curtime - painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="comment">/* do paint op over unpainted time distance */</span>
<a name="l01115"></a>01115         <span class="keywordflow">while</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> &gt;= spacing) {
<a name="l01116"></a>01116             step= (spacing - starttime)*len;
<a name="l01117"></a>01117             paintpos[0]= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[0] + dmousepos[0]*<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01118"></a>01118             paintpos[1]= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[1] + dmousepos[1]*<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120             <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>)
<a name="l01121"></a>01121                 <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(painter);
<a name="l01122"></a>01122             totpaintops += func(user, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>,
<a name="l01123"></a>01123                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>, paintpos);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0]= paintpos[0];
<a name="l01126"></a>01126             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1]= paintpos[1];
<a name="l01127"></a>01127             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> -= spacing;
<a name="l01128"></a>01128             starttime -= spacing;
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130         
<a name="l01131"></a>01131         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>= curtime;
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133 <span class="preprocessor">#endif</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
<a name="l01135"></a>01135         <span class="keywordtype">float</span> startdistance, spacing, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, paintpos[2], dmousepos[2], finalpos[2];
<a name="l01136"></a>01136         <span class="keywordtype">float</span> t, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, press;
<a name="l01137"></a>01137         <span class="keyword">const</span> <span class="keywordtype">int</span> radius= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139         <span class="comment">/* compute brush spacing adapted to brush radius, spacing may depend</span>
<a name="l01140"></a>01140 <span class="comment">         * on pressure, so update it */</span>
<a name="l01141"></a>01141         <a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">brush_apply_pressure</a>(painter, brush, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a>);
<a name="l01142"></a>01142         spacing= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1.0f, radius)*brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a>*0.01f;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="comment">/* setup starting distance, direction vector and accumulated distance */</span>
<a name="l01145"></a>01145         startdistance= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a>;
<a name="l01146"></a>01146         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dmousepos, pos, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>);
<a name="l01147"></a>01147         len= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dmousepos);
<a name="l01148"></a>01148         painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a> += <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150         <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf76b87d500309f20c493b07d8b7c48d6">BRUSH_SPACE</a>) {
<a name="l01151"></a>01151             <span class="comment">/* do paint op over unpainted distance */</span>
<a name="l01152"></a>01152             <span class="keywordflow">while</span> ((len &gt; 0.0f) &amp;&amp; (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a> &gt;= spacing)) {
<a name="l01153"></a>01153                 step= spacing - startdistance;
<a name="l01154"></a>01154                 paintpos[0]= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[0] + dmousepos[0]*<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01155"></a>01155                 paintpos[1]= painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[1] + dmousepos[1]*<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157                 t = step/<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01158"></a>01158                 press= (1.0f-t)*painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a> + t*pressure;
<a name="l01159"></a>01159                 <a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">brush_apply_pressure</a>(painter, brush, press);
<a name="l01160"></a>01160                 spacing= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1.0f, radius)*brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a>*0.01f;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162                 <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4797562c53e58126ef811986212b468f">brush_jitter_pos</a>(scene, brush, paintpos, finalpos);
<a name="l01163"></a>01163 
<a name="l01164"></a>01164                 <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>)
<a name="l01165"></a>01165                     <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(painter, finalpos, use_color_correction);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167                 totpaintops +=
<a name="l01168"></a>01168                     func(user, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>, finalpos);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0]= paintpos[0];
<a name="l01171"></a>01171                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1]= paintpos[1];
<a name="l01172"></a>01172                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a> -= spacing;
<a name="l01173"></a>01173                 startdistance -= spacing;
<a name="l01174"></a>01174             }
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176         <span class="keywordflow">else</span> {
<a name="l01177"></a>01177             <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4797562c53e58126ef811986212b468f">brush_jitter_pos</a>(scene, brush, pos, finalpos);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179             <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>)
<a name="l01180"></a>01180                 <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(painter, finalpos, use_color_correction);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182             totpaintops += func(user, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>, pos, finalpos);
<a name="l01183"></a>01183 
<a name="l01184"></a>01184             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[0]= pos[0];
<a name="l01185"></a>01185             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a8c0f3103424e410bf954bbad00506042">lastpaintpos</a>[1]= pos[1];
<a name="l01186"></a>01186             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a1d6effe69f5e6b425bba7bdbea466efd">accumdistance</a>= 0;
<a name="l01187"></a>01187         }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <span class="comment">/* do airbrush paint ops, based on the number of paint ops left over</span>
<a name="l01190"></a>01190 <span class="comment">         * from regular painting. this is a temporary solution until we have</span>
<a name="l01191"></a>01191 <span class="comment">         * accurate time stamps for mouse move events */</span>
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf33942d16772316fcb0e94d4a77eaba2">BRUSH_AIRBRUSH</a>) {
<a name="l01193"></a>01193             <span class="keywordtype">double</span> curtime= time;
<a name="l01194"></a>01194             <span class="keywordtype">double</span> painttime= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#acda87e5d0baba3a86b0fed2d3f5a13f4">rate</a>*totpaintops;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> += curtime - painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>;
<a name="l01197"></a>01197             <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> &lt;= painttime)
<a name="l01198"></a>01198                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a>= 0.0;
<a name="l01199"></a>01199             <span class="keywordflow">else</span>
<a name="l01200"></a>01200                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> -= painttime;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202             <span class="keywordflow">while</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> &gt;= (<span class="keywordtype">double</span>)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#acda87e5d0baba3a86b0fed2d3f5a13f4">rate</a>) {
<a name="l01203"></a>01203                 <a class="code" href="../../df/d2b/brush_8c.html#affdcfb9b34eb67da09e205a12494fc68">brush_apply_pressure</a>(painter, brush, pressure);
<a name="l01204"></a>01204 
<a name="l01205"></a>01205                 <a class="code" href="../../da/dc9/BKE__brush_8h.html#a4797562c53e58126ef811986212b468f">brush_jitter_pos</a>(scene, brush, pos, finalpos);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207                 <span class="keywordflow">if</span> (painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#ab1433187c06ae62947d54f9c6ab80a86">enabled</a>)
<a name="l01208"></a>01208                     <a class="code" href="../../df/d2b/brush_8c.html#a8f5679a2faf19892a97ee74a8aa85e14">brush_painter_refresh_cache</a>(painter, finalpos, use_color_correction);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210                 totpaintops +=
<a name="l01211"></a>01211                     func(user, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aac4f1879dbb422e04ca81fbd1847270e">cache</a>.<a class="code" href="../../d8/dc7/structBrushPainterCache.html#a6232ba39f4a160ffbf9204d75cf5521e">ibuf</a>, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>, finalpos);
<a name="l01212"></a>01212                 painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aafd5aa1271dada7bf80127b7ba5a229d">accumtime</a> -= (double)brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#acda87e5d0baba3a86b0fed2d3f5a13f4">rate</a>;
<a name="l01213"></a>01213             }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215             painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#aa007328551e477ce429eebca44788f87">lasttime</a>= curtime;
<a name="l01216"></a>01216         }
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[0]= pos[0];
<a name="l01220"></a>01220     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0f36d9156b799cec61fff28ae05a9e3d">lastmousepos</a>[1]= pos[1];
<a name="l01221"></a>01221     painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a9dd0ceda555e400f71452b9dac6bbe37">lastpressure</a>= pressure;
<a name="l01222"></a>01222 
<a name="l01223"></a>01223     <a class="code" href="../../df/d2b/brush_8c.html#ae6e53b1ad46fd567235d71c977ede805">brush_set_alpha</a>(scene, brush, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d797131d5b06941f590b1104a104666">startalpha</a>);
<a name="l01224"></a>01224     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, brush, painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#af9e205b9785ec8867bb10d9617d1f382">startsize</a>);
<a name="l01225"></a>01225     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a0ccf48a0e9169603281ecdeacece94c7">jitter</a> = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a0efa0df6b6fe2ccc07e7fad885cde1ea">startjitter</a>;
<a name="l01226"></a>01226     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#aad34a21e33c74412c20c9a20c5535424">spacing</a> = painter-&gt;<a class="code" href="../../d4/dc9/structBrushPainter.html#a5d3f1fc23fcc19f4601e86770da9f532">startspacing</a>;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="keywordflow">return</span> totpaintops;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="comment">/* Uses the brush curve control to find a strength value between 0 and 1 */</span>
<a name="l01232"></a><a class="code" href="../../df/d2b/brush_8c.html#af3dc9e5363086a6a340cd42df4ccbb5e">01232</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>)
<a name="l01233"></a>01233 {
<a name="l01234"></a>01234     <span class="keywordflow">if</span> (p &gt;= len)   <span class="keywordflow">return</span> 0;
<a name="l01235"></a>01235     <span class="keywordflow">else</span>            p= p/<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     p= <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a24a039a3e10ecfb8a0cfefc9811f4830">curvemapping_evaluateF</a>(br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>, 0, p);
<a name="l01238"></a>01238     <span class="keywordflow">if</span> (p &lt; 0.0f)       p= 0.0f;
<a name="l01239"></a>01239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p &gt; 1.0f)  p= 1.0f;
<a name="l01240"></a>01240     <span class="keywordflow">return</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 <span class="comment">/* same as above but can return negative values if the curve enables</span>
<a name="l01243"></a>01243 <span class="comment"> * used for sculpt only */</span>
<a name="l01244"></a><a class="code" href="../../df/d2b/brush_8c.html#acf5979563cea5a385453c1b1f25d9698">01244</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#afcd6c828e3c28abab8e3aaf5f32b60d9">brush_curve_strength</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>)
<a name="l01245"></a>01245 {
<a name="l01246"></a>01246     <span class="keywordflow">if</span> (p &gt;= len)
<a name="l01247"></a>01247         p= 1.0f;
<a name="l01248"></a>01248     <span class="keywordflow">else</span>
<a name="l01249"></a>01249         p= p/<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01250"></a>01250 
<a name="l01251"></a>01251     <span class="keywordflow">return</span> <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a24a039a3e10ecfb8a0cfefc9811f4830">curvemapping_evaluateF</a>(br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a5f7b0d9181df178da588821ce9f02d44">curve</a>, 0, p);
<a name="l01252"></a>01252 }
<a name="l01253"></a>01253 
<a name="l01254"></a>01254 <span class="comment">/* TODO: should probably be unified with BrushPainter stuff? */</span>
<a name="l01255"></a><a class="code" href="../../df/d2b/brush_8c.html#a43d8e6f687086f187782e3695dbafb6a">01255</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#af1b77d23e56d09e53bb358f585d95d0b">brush_gen_texture_cache</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br, <span class="keywordtype">int</span> half_side)
<a name="l01256"></a>01256 {
<a name="l01257"></a>01257     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *texcache = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01258"></a>01258     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex = &amp;br-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>;
<a name="l01259"></a>01259     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0};
<a name="l01260"></a>01260     <span class="keywordtype">int</span> hasrgb, ix, iy;
<a name="l01261"></a>01261     <span class="keywordtype">int</span> side = half_side * 2;
<a name="l01262"></a>01262     
<a name="l01263"></a>01263     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l01264"></a>01264         <span class="keywordtype">float</span> x, y, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = 2.0 / side, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];
<a name="l01265"></a>01265 
<a name="l01266"></a>01266         texcache = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * side * side, <span class="stringliteral">&quot;Brush texture cache&quot;</span>);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268         <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01269"></a>01269         
<a name="l01270"></a>01270         <span class="comment">/*do normalized cannonical view coords for texture*/</span>
<a name="l01271"></a>01271         <span class="keywordflow">for</span> (y=-1.0, iy=0; iy&lt;side; iy++, y += <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>) {
<a name="l01272"></a>01272             <span class="keywordflow">for</span> (x=-1.0, ix=0; ix&lt;side; ix++, x += <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>) {
<a name="l01273"></a>01273                 co[0]= x;
<a name="l01274"></a>01274                 co[1]= y;
<a name="l01275"></a>01275                 co[2]= 0.0f;
<a name="l01276"></a>01276                 
<a name="l01277"></a>01277                 <span class="comment">/* This is copied from displace modifier code */</span>
<a name="l01278"></a>01278                 hasrgb = <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a5a08933d2cffb0132e123669117f04ac">multitex_ext</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>, co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, &amp;texres);
<a name="l01279"></a>01279             
<a name="l01280"></a>01280                 <span class="comment">/* if the texture gave an RGB value, we assume it didn&#39;t give a valid</span>
<a name="l01281"></a>01281 <span class="comment">                 * intensity, so calculate one (formula from do_material_tex).</span>
<a name="l01282"></a>01282 <span class="comment">                 * if the texture didn&#39;t give an RGB value, copy the intensity across</span>
<a name="l01283"></a>01283 <span class="comment">                 */</span>
<a name="l01284"></a>01284                 <span class="keywordflow">if</span> (hasrgb &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>)
<a name="l01285"></a>01285                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = (0.35f * texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + 0.45f *
<a name="l01286"></a>01286                                   texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + 0.2f * texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> * 255.0f;
<a name="l01289"></a>01289                 ((<span class="keywordtype">char</span>*)texcache)[(iy*side+ix)*4] = (<span class="keywordtype">char</span>)texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l01290"></a>01290                 ((<span class="keywordtype">char</span>*)texcache)[(iy*side+ix)*4+1] = (<span class="keywordtype">char</span>)texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l01291"></a>01291                 ((<span class="keywordtype">char</span>*)texcache)[(iy*side+ix)*4+2] = (<span class="keywordtype">char</span>)texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l01292"></a>01292                 ((<span class="keywordtype">char</span>*)texcache)[(iy*side+ix)*4+3] = (<span class="keywordtype">char</span>)texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l01293"></a>01293             }
<a name="l01294"></a>01294         }
<a name="l01295"></a>01295     }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <span class="keywordflow">return</span> texcache;
<a name="l01298"></a>01298 }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300 <span class="comment">/**** Radial Control ****/</span>
<a name="l01301"></a><a class="code" href="../../df/d2b/brush_8c.html#ae87a586c3c2465ff786f463211a7625b">01301</a> <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/dc9/BKE__brush_8h.html#a719a56d09328eb46f509a68e35800874">brush_gen_radial_control_imbuf</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *br)
<a name="l01302"></a>01302 {
<a name="l01303"></a>01303     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *im = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>), <span class="stringliteral">&quot;radial control texture&quot;</span>);
<a name="l01304"></a>01304     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *texcache;
<a name="l01305"></a>01305     <span class="keywordtype">int</span> side = 128;
<a name="l01306"></a>01306     <span class="keywordtype">int</span> half = side / 2;
<a name="l01307"></a>01307     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     texcache = <a class="code" href="../../da/dc9/BKE__brush_8h.html#af1b77d23e56d09e53bb358f585d95d0b">brush_gen_texture_cache</a>(br, half);
<a name="l01310"></a>01310     im-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * side * side, <span class="stringliteral">&quot;radial control rect&quot;</span>);
<a name="l01311"></a>01311     im-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> = im-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> = side;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     <span class="keywordflow">for</span> (i=0; i&lt;side; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01314"></a>01314         <span class="keywordflow">for</span> (j=0; j&lt;side; ++j) {
<a name="l01315"></a>01315             <span class="keywordtype">float</span> magn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(i - half, 2) + <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(j - half, 2));
<a name="l01316"></a>01316             im-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>[i*side + j]= <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(br, magn, half);
<a name="l01317"></a>01317         }
<a name="l01318"></a>01318     }
<a name="l01319"></a>01319 
<a name="l01320"></a>01320     <span class="comment">/* Modulate curve with texture */</span>
<a name="l01321"></a>01321     <span class="keywordflow">if</span> (texcache) {
<a name="l01322"></a>01322         <span class="keywordflow">for</span> (i=0; i&lt;side; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01323"></a>01323             <span class="keywordflow">for</span> (j=0; j&lt;side; ++j) {
<a name="l01324"></a>01324                 <span class="keyword">const</span> <span class="keywordtype">int</span> col= texcache[i*side+j];
<a name="l01325"></a>01325                 im-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>[i*side+j]*= (((<span class="keywordtype">char</span>*)&amp;col)[0]+((<span class="keywordtype">char</span>*)&amp;col)[1]+((<span class="keywordtype">char</span>*)&amp;col)[2])/3.0f/255.0f;
<a name="l01326"></a>01326             }
<a name="l01327"></a>01327         }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(texcache);
<a name="l01330"></a>01330     }
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <span class="keywordflow">return</span> im;
<a name="l01333"></a>01333 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:06 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
