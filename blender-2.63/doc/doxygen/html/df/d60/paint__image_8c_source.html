<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: paint_image.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">paint_image.c</div>  </div>
</div>
<div class="contents">
<a href="../../df/d60/paint__image_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * imagepaint.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Functions to paint images in 2D and 3D.</span>
<a name="l00005"></a>00005 <span class="comment"> * </span>
<a name="l00006"></a>00006 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00009"></a>00009 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00010"></a>00010 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00011"></a>00011 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00019"></a>00019 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00022"></a>00022 <span class="comment"> * All rights reserved.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * The Original Code is: some of this file.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * Contributor(s): Jens Ole Wund (bjornmose), Campbell Barton (ideasman42)</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#  include &quot;<a class="code" href="../../d9/ded/BLI__winstuff_8h.html" title="Compatibility-like things for windows.">BLI_winstuff.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/BLI__dynstr_8h.html" title="A dynamically sized string ADT.">BLI_dynstr.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d31/BLI__linklist_8h.html" title="Routines for working with singly linked lists of &#39;links&#39; - pointers to other data.">BLI_linklist.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d37/DNA__brush__types_8h.html">DNA_brush_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dff/BKE__camera_8h.html" title="Camera datablock and utility functions.">BKE_camera.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d95/BKE__idprop_8h.html">BKE_idprop.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dc9/BKE__brush_8h.html">BKE_brush.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d71/BIF__glutil_8h.html">BIF_glutil.h</a>&quot;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d53/ED__image_8h.html">ED_image.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &quot;<a class="code" href="../../db/de3/ED__sculpt_8h.html">ED_sculpt.h</a>&quot;</span>
<a name="l00097"></a>00097 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d25/ED__uvedit_8h.html">ED_uvedit.h</a>&quot;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00102"></a>00102 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d68/RNA__enum__types_8h.html">RNA_enum_types.h</a>&quot;</span>
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/df0/GPU__draw_8h.html">GPU_draw.h</a>&quot;</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &quot;<a class="code" href="../../da/deb/GPU__extensions_8h.html">GPU_extensions.h</a>&quot;</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d6c/paint__intern_8h.html">paint_intern.h</a>&quot;</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="comment">/* Defines and Structs */</span>
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3c49d7645948f938cf1ea093bd131d1f">00115</a> <span class="preprocessor">#define IMAPAINT_CHAR_TO_FLOAT(c) ((c) / 255.0f)</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5ae2e8f12c6c2bc0560daced034d6414">00117</a> <span class="preprocessor">#define IMAPAINT_FLOAT_RGB_TO_CHAR(c, f)  {                                   \</span>
<a name="l00118"></a>00118 <span class="preprocessor">    (c)[0]= FTOCHAR((f)[0]);                                                  \</span>
<a name="l00119"></a>00119 <span class="preprocessor">    (c)[1]= FTOCHAR((f)[1]);                                                  \</span>
<a name="l00120"></a>00120 <span class="preprocessor">    (c)[2]= FTOCHAR((f)[2]);                                                  \</span>
<a name="l00121"></a>00121 <span class="preprocessor">}</span>
<a name="l00122"></a><a class="code" href="../../df/d60/paint__image_8c.html#a74558eb5d272e225b52223c7b2f9ac21">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define IMAPAINT_FLOAT_RGBA_TO_CHAR(c, f)  {                                  \</span>
<a name="l00123"></a>00123 <span class="preprocessor">    (c)[0]= FTOCHAR((f)[0]);                                                  \</span>
<a name="l00124"></a>00124 <span class="preprocessor">    (c)[1]= FTOCHAR((f)[1]);                                                  \</span>
<a name="l00125"></a>00125 <span class="preprocessor">    (c)[2]= FTOCHAR((f)[2]);                                                  \</span>
<a name="l00126"></a>00126 <span class="preprocessor">    (c)[3]= FTOCHAR((f)[3]);                                                  \</span>
<a name="l00127"></a>00127 <span class="preprocessor">}</span>
<a name="l00128"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9c95c409b2d5cf8fc2ddc25badf7be11">00128</a> <span class="preprocessor"></span><span class="preprocessor">#define IMAPAINT_CHAR_RGB_TO_FLOAT(f, c)  {                                   \</span>
<a name="l00129"></a>00129 <span class="preprocessor">    (f)[0]= IMAPAINT_CHAR_TO_FLOAT((c)[0]);                                   \</span>
<a name="l00130"></a>00130 <span class="preprocessor">    (f)[1]= IMAPAINT_CHAR_TO_FLOAT((c)[1]);                                   \</span>
<a name="l00131"></a>00131 <span class="preprocessor">    (f)[2]= IMAPAINT_CHAR_TO_FLOAT((c)[2]);                                   \</span>
<a name="l00132"></a>00132 <span class="preprocessor">}</span>
<a name="l00133"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab64a89eb73f6bf7f5f66ff9283e2a674">00133</a> <span class="preprocessor"></span><span class="preprocessor">#define IMAPAINT_CHAR_RGBA_TO_FLOAT(f, c)  {                                  \</span>
<a name="l00134"></a>00134 <span class="preprocessor">    (f)[0]= IMAPAINT_CHAR_TO_FLOAT((c)[0]);                                   \</span>
<a name="l00135"></a>00135 <span class="preprocessor">    (f)[1]= IMAPAINT_CHAR_TO_FLOAT((c)[1]);                                   \</span>
<a name="l00136"></a>00136 <span class="preprocessor">    (f)[2]= IMAPAINT_CHAR_TO_FLOAT((c)[2]);                                   \</span>
<a name="l00137"></a>00137 <span class="preprocessor">    (f)[3]= IMAPAINT_CHAR_TO_FLOAT((c)[3]);                                   \</span>
<a name="l00138"></a>00138 <span class="preprocessor">}</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>
<a name="l00140"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5f564d2f4c956db995f117e80f3b6611">00140</a> <span class="preprocessor">#define IMAPAINT_FLOAT_RGB_COPY(a, b) copy_v3_v3(a, b)</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00142"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">00142</a> <span class="preprocessor">#define IMAPAINT_TILE_BITS          6</span>
<a name="l00143"></a><a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">00143</a> <span class="preprocessor"></span><span class="preprocessor">#define IMAPAINT_TILE_SIZE          (1 &lt;&lt; IMAPAINT_TILE_BITS)</span>
<a name="l00144"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7aad04c41f4673fca187386f1a4539d8">00144</a> <span class="preprocessor"></span><span class="preprocessor">#define IMAPAINT_TILE_NUMBER(size)  (((size) + IMAPAINT_TILE_SIZE - 1) &gt;&gt; IMAPAINT_TILE_BITS)</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5b98d3b6f04aea7acf08e2096c9527b5">imapaint_image_update</a>(<a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">short</span> texpaint);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../db/d04/structImagePaintState.html">00149</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> {
<a name="l00150"></a><a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">00150</a>     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>;
<a name="l00151"></a><a class="code" href="../../db/d04/structImagePaintState.html#a82f2ec8b14d1535ec6ef400a98f02694">00151</a>     <a class="code" href="../../d7/de3/structView2D.html">View2D</a> *<a class="code" href="../../db/d04/structImagePaintState.html#a82f2ec8b14d1535ec6ef400a98f02694">v2d</a>;
<a name="l00152"></a><a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">00152</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>;
<a name="l00153"></a><a class="code" href="../../db/d04/structImagePaintState.html#a7a288e4e3b56c3aa8b372010ea9b596a">00153</a>     <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *<a class="code" href="../../db/d04/structImagePaintState.html#a7a288e4e3b56c3aa8b372010ea9b596a">screen</a>;
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">00155</a>     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>;
<a name="l00156"></a><a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">00156</a>     <span class="keywordtype">short</span> <a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a>, <a class="code" href="../../db/d04/structImagePaintState.html#a8d48f247e4e2fe00576f2cae6d39b1b7">blend</a>;
<a name="l00157"></a><a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">00157</a>     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>;
<a name="l00158"></a><a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">00158</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>;
<a name="l00159"></a><a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">00159</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>;
<a name="l00160"></a><a class="code" href="../../db/d04/structImagePaintState.html#a6ae40c7c442e4ad1c71a2c2ecb4cee19">00160</a>     <span class="keywordtype">short</span> <a class="code" href="../../db/d04/structImagePaintState.html#a6ae40c7c442e4ad1c71a2c2ecb4cee19">clonefreefloat</a>;
<a name="l00161"></a><a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">00161</a>     <span class="keywordtype">char</span> *<a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">warnpackedfile</a>;
<a name="l00162"></a><a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">00162</a>     <span class="keywordtype">char</span> *<a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">warnmultifile</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="comment">/* viewport texture paint only, but _not_ project paint */</span>
<a name="l00165"></a><a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">00165</a>     <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>;
<a name="l00166"></a><a class="code" href="../../db/d04/structImagePaintState.html#ad7ebff08256d982e2c4560a78c657cae">00166</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/d04/structImagePaintState.html#ad7ebff08256d982e2c4560a78c657cae">faceindex</a>;
<a name="l00167"></a><a class="code" href="../../db/d04/structImagePaintState.html#a6750ef16f1c448811f050896b91c0fe2">00167</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/d04/structImagePaintState.html#a6750ef16f1c448811f050896b91c0fe2">uv</a>[2];
<a name="l00168"></a><a class="code" href="../../db/d04/structImagePaintState.html#a99d45f9f371cade14cca7b42de33bb0e">00168</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/d04/structImagePaintState.html#a99d45f9f371cade14cca7b42de33bb0e">do_facesel</a>;
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">00170</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>    *<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>;
<a name="l00171"></a><a class="code" href="../../db/d04/structImagePaintState.html#a6c7ef713ea4db97f8f1c309a1242f9a3">00171</a>     <span class="keywordtype">int</span>             <a class="code" href="../../db/d04/structImagePaintState.html#a6c7ef713ea4db97f8f1c309a1242f9a3">dm_totface</a>;
<a name="l00172"></a><a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">00172</a>     <span class="keywordtype">int</span>             <a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">dm_release</a>;
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="../../db/d04/structImagePaintState.html#a101251ead8a3f30ec777ac67f9a38bec">00174</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a>          *<a class="code" href="../../db/d04/structImagePaintState.html#a101251ead8a3f30ec777ac67f9a38bec">dm_mface</a>;
<a name="l00175"></a><a class="code" href="../../db/d04/structImagePaintState.html#a372ae501bbd0c968d25100f9652e7888">00175</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>         *<a class="code" href="../../db/d04/structImagePaintState.html#a372ae501bbd0c968d25100f9652e7888">dm_mtface</a>;
<a name="l00176"></a>00176 } <a class="code" href="../../df/d60/paint__image_8c.html#a977bb99283ca9ea820b033a21b6ab979">ImagePaintState</a>;
<a name="l00177"></a>00177 
<a name="l00178"></a><a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">00178</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> {
<a name="l00179"></a><a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">00179</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>, <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>, <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a>, <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a>;
<a name="l00180"></a><a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ac57e97aa061db024a54300869b0cf856">00180</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ac57e97aa061db024a54300869b0cf856">enabled</a>;
<a name="l00181"></a>00181 } <a class="code" href="../../df/d60/paint__image_8c.html#ab27d32720612e24fca7aa99d3ac52f2c">ImagePaintPartialRedraw</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="../../df/d22/structImagePaintRegion.html">00183</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/d22/structImagePaintRegion.html">ImagePaintRegion</a> {
<a name="l00184"></a><a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">00184</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/d22/structImagePaintRegion.html#a91f0c6d1df0d50eab795023effd3af0d">destx</a>, <a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">desty</a>;
<a name="l00185"></a><a class="code" href="../../df/d22/structImagePaintRegion.html#a854278cd9a8991d4be7f332d2b1e8a30">00185</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/d22/structImagePaintRegion.html#ace65e35ccfb746ff4256e29c71e110a4">srcx</a>, <a class="code" href="../../df/d22/structImagePaintRegion.html#a854278cd9a8991d4be7f332d2b1e8a30">srcy</a>;
<a name="l00186"></a><a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">00186</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">width</a>, <a class="code" href="../../df/d22/structImagePaintRegion.html#a6acd82cf1b0c96d4819ee42debf53238">height</a>;
<a name="l00187"></a>00187 } <a class="code" href="../../df/d60/paint__image_8c.html#ad99a8665eae8e84a1853c15e1025c0c1">ImagePaintRegion</a>;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">/* ProjectionPaint defines */</span>
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="comment">/* approx the number of buckets to have under the brush,</span>
<a name="l00192"></a>00192 <span class="comment"> * used with the brush size to set the ps-&gt;buckets_x and ps-&gt;buckets_y value.</span>
<a name="l00193"></a>00193 <span class="comment"> * </span>
<a name="l00194"></a>00194 <span class="comment"> * When 3 - a brush should have ~9 buckets under it at once</span>
<a name="l00195"></a>00195 <span class="comment"> * ...this helps for threading while painting as well as</span>
<a name="l00196"></a>00196 <span class="comment"> * avoiding initializing pixels that wont touch the brush */</span>
<a name="l00197"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5cc4f9d4314bedd223adbc70746691ae">00197</a> <span class="preprocessor">#define PROJ_BUCKET_BRUSH_DIV 4</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>
<a name="l00199"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7a736a6d57923d56412ba6265d9191e3">00199</a> <span class="preprocessor">#define PROJ_BUCKET_RECT_MIN 4</span>
<a name="l00200"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6230c970e9181f1236493d5aa6666ab3">00200</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_BUCKET_RECT_MAX 256</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a><a class="code" href="../../df/d60/paint__image_8c.html#a33024fffec7f039a87563af02b910506">00202</a> <span class="preprocessor">#define PROJ_BOUNDBOX_DIV 8</span>
<a name="l00203"></a><a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">00203</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_BOUNDBOX_SQUARED  (PROJ_BOUNDBOX_DIV * PROJ_BOUNDBOX_DIV)</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span>
<a name="l00205"></a>00205 <span class="comment">//#define PROJ_DEBUG_PAINT 1</span>
<a name="l00206"></a>00206 <span class="comment">//#define PROJ_DEBUG_NOSEAMBLEED 1</span>
<a name="l00207"></a>00207 <span class="comment">//#define PROJ_DEBUG_PRINT_CLIP 1</span>
<a name="l00208"></a><a class="code" href="../../df/d60/paint__image_8c.html#a431d2b350fdedf87372e91b2aaf6c7b0">00208</a> <span class="preprocessor">#define PROJ_DEBUG_WINCLIP 1</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span>
<a name="l00210"></a>00210 <span class="comment">/* projectFaceSeamFlags options */</span>
<a name="l00211"></a>00211 <span class="comment">//#define PROJ_FACE_IGNORE  (1&lt;&lt;0)  /* When the face is hidden, backfacing or occluded */</span>
<a name="l00212"></a>00212 <span class="comment">//#define PROJ_FACE_INIT    (1&lt;&lt;1)  /* When we have initialized the faces data */</span>
<a name="l00213"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2f0a1b2e617d22161ba34a37025f62f0">00213</a> <span class="preprocessor">#define PROJ_FACE_SEAM1 (1 &lt;&lt; 0)  </span><span class="comment">/* If this face has a seam on any of its edges */</span>
<a name="l00214"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0e1f22a29694e3d7aed564a9e00d2f2b">00214</a> <span class="preprocessor">#define PROJ_FACE_SEAM2 (1 &lt;&lt; 1)</span>
<a name="l00215"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab4e6a0a67aacc45db6e81ef4f8c84e16">00215</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_FACE_SEAM3 (1 &lt;&lt; 2)</span>
<a name="l00216"></a><a class="code" href="../../df/d60/paint__image_8c.html#abea63161df145e528f3adfc4f8008943">00216</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_FACE_SEAM4 (1 &lt;&lt; 3)</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>
<a name="l00218"></a><a class="code" href="../../df/d60/paint__image_8c.html#aeb64fa2a207f9ce096489b04f08d0c9f">00218</a> <span class="preprocessor">#define PROJ_FACE_NOSEAM1   (1 &lt;&lt; 4)</span>
<a name="l00219"></a><a class="code" href="../../df/d60/paint__image_8c.html#a27c283767c6685555b156d34fb845bfc">00219</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_FACE_NOSEAM2   (1 &lt;&lt; 5)</span>
<a name="l00220"></a><a class="code" href="../../df/d60/paint__image_8c.html#afa3ef9cf452ac30cd410ecaaaceedbee">00220</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_FACE_NOSEAM3   (1 &lt;&lt; 6)</span>
<a name="l00221"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6032595ab69e857e67e783a11a361f77">00221</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_FACE_NOSEAM4   (1 &lt;&lt; 7)</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">00223</a> <span class="preprocessor">#define PROJ_SRC_VIEW       1</span>
<a name="l00224"></a><a class="code" href="../../df/d60/paint__image_8c.html#a56b7a4e1251c26a2406c0ee3cda5d93c">00224</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_SRC_IMAGE_CAM  2</span>
<a name="l00225"></a><a class="code" href="../../df/d60/paint__image_8c.html#a69cb721f7bda43a05e29c407e0eebf3e">00225</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_SRC_IMAGE_VIEW 3</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>
<a name="l00227"></a><a class="code" href="../../df/d60/paint__image_8c.html#aacaf081d26a03b460ceb39111eaa9194">00227</a> <span class="preprocessor">#define PROJ_VIEW_DATA_ID &quot;view_data&quot;</span>
<a name="l00228"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2508613f2e579874aa5fee40a69032b5">00228</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_VIEW_DATA_SIZE (4 * 4 + 4 * 4 + 3) </span><span class="comment">/* viewmat + winmat + clipsta + clipend + is_ortho */</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 <span class="comment">/* a slightly scaled down face is used to get fake 3D location for edge pixels in the seams</span>
<a name="l00232"></a>00232 <span class="comment"> * as this number approaches  1.0f the likelihood increases of float precision errors where</span>
<a name="l00233"></a>00233 <span class="comment"> * it is occluded by an adjacent face */</span>
<a name="l00234"></a><a class="code" href="../../df/d60/paint__image_8c.html#af6ffae7a06b8d485c328de66a6882ec2">00234</a> <span class="preprocessor">#define PROJ_FACE_SCALE_SEAM    0.99f</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>
<a name="l00236"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2aea653d601c8061e2954f97c969c5a3">00236</a> <span class="preprocessor">#define PROJ_BUCKET_NULL        0</span>
<a name="l00237"></a><a class="code" href="../../df/d60/paint__image_8c.html#ad2d1aa99c0ae8f9c345063878bb2593d">00237</a> <span class="preprocessor"></span><span class="preprocessor">#define PROJ_BUCKET_INIT        (1 &lt;&lt; 0)</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="comment">// #define PROJ_BUCKET_CLONE_INIT   (1&lt;&lt;1)</span>
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="comment">/* used for testing doubles, if a point is on a line etc */</span>
<a name="l00241"></a><a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">00241</a> <span class="preprocessor">#define PROJ_GEOM_TOLERANCE 0.00075f</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>
<a name="l00243"></a>00243 <span class="comment">/* vert flags */</span>
<a name="l00244"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">00244</a> <span class="preprocessor">#define PROJ_VERT_CULL 1</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>
<a name="l00246"></a><a class="code" href="../../df/d60/paint__image_8c.html#a43c51f75b980571fdbc4062b65a41a31">00246</a> <span class="preprocessor">#define PI_80_DEG ((M_PI_2 / 9) * 8)</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span>
<a name="l00248"></a>00248 <span class="comment">/* This is mainly a convenience struct used so we can keep an array of images we use</span>
<a name="l00249"></a>00249 <span class="comment"> * Thir imbufs, etc, in 1 array, When using threads this array is copied for each thread</span>
<a name="l00250"></a>00250 <span class="comment"> * because &#39;partRedrawRect&#39; and &#39;touch&#39; values would not be thread safe */</span>
<a name="l00251"></a><a class="code" href="../../dc/d64/structProjPaintImage.html">00251</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> {
<a name="l00252"></a><a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">00252</a>     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>;
<a name="l00253"></a><a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">00253</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>;
<a name="l00254"></a><a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">00254</a>     <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>;
<a name="l00255"></a><a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">00255</a>     <span class="keywordtype">void</span> **<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a>; <span class="comment">/* only used to build undo tiles after painting */</span>
<a name="l00256"></a><a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">00256</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a>;
<a name="l00257"></a>00257 } <a class="code" href="../../df/d60/paint__image_8c.html#a91f19b62c9fcce10a072f1a2d5eb0568">ProjPaintImage</a>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="comment">/* Main projection painting struct passed to all projection painting functions */</span>
<a name="l00260"></a><a class="code" href="../../d0/d4c/structProjPaintState.html">00260</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> {
<a name="l00261"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">00261</a>     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">v3d</a>;
<a name="l00262"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">00262</a>     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>;
<a name="l00263"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a64c03981e25b7657c2fc6878f52e8b08">00263</a>     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a64c03981e25b7657c2fc6878f52e8b08">ar</a>;
<a name="l00264"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">00264</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>;
<a name="l00265"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">00265</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a>; <span class="comment">/* PROJ_SRC_**** */</span>
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">00267</a>     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>;
<a name="l00268"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">00268</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a>, <a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>;
<a name="l00269"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">00269</a>     <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>;
<a name="l00270"></a>00270     <span class="comment">/* end similarities with ImagePaintState */</span>
<a name="l00271"></a>00271     
<a name="l00272"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">00272</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>    *<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>;
<a name="l00273"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a5cd37e0a44900d9668ec1f3df174d4d7">00273</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a5cd37e0a44900d9668ec1f3df174d4d7">dm_totface</a>;
<a name="l00274"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">00274</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">dm_totvert</a>;
<a name="l00275"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">00275</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">00277</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a>          *<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>;
<a name="l00278"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">00278</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a>          *<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a>;
<a name="l00279"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">00279</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>         *<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>;
<a name="l00280"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">00280</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>         *<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>;    <span class="comment">/* other UV map, use for cloning between layers */</span>
<a name="l00281"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">00281</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>         *<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a>;
<a name="l00282"></a>00282     
<a name="l00283"></a>00283     <span class="comment">/* projection painting only */</span>
<a name="l00284"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">00284</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>]; <span class="comment">/* for multithreading, the first item is sometimes used for non threaded cases too */</span>
<a name="l00285"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">00285</a>     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a>;              <span class="comment">/* screen sized 2D array, each pixel has a linked list of ProjPixel&#39;s */</span>
<a name="l00286"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">00286</a>     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>;             <span class="comment">/* bucketRect aligned array linkList of faces overlapping each bucket */</span>
<a name="l00287"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">00287</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">bucketFlags</a>;         <span class="comment">/* store if the bucks have been initialized  */</span>
<a name="l00288"></a>00288 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l00289"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">00289</a> <span class="preprocessor"></span>    <span class="keywordtype">char</span> *<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>;                <span class="comment">/* store info about faces, if they are initialized etc*/</span>
<a name="l00290"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">00290</a>     float (*<a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">faceSeamUVs</a>)[4][2];         <span class="comment">/* expanded UVs for faces to use as seams */</span>
<a name="l00291"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">00291</a>     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>;               <span class="comment">/* Only needed for when seam_bleed_px is enabled, use to find UV seams */</span>
<a name="l00292"></a>00292 <span class="preprocessor">#endif</span>
<a name="l00293"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">00293</a> <span class="preprocessor"></span>    <span class="keywordtype">char</span> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>;                    <span class="comment">/* store options per vert, now only store if the vert is pointing away from the view */</span>
<a name="l00294"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">00294</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>;                      <span class="comment">/* The size of the bucket grid, the grid span&#39;s screenMin/screenMax so you can paint outsize the screen or with 2 brushes at once */</span>
<a name="l00295"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">00295</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>;
<a name="l00296"></a>00296     
<a name="l00297"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">00297</a>     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>;
<a name="l00298"></a>00298     
<a name="l00299"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">00299</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>;              <span class="comment">/* size of projectImages array */</span>
<a name="l00300"></a>00300     
<a name="l00301"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">00301</a>     float (*<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>)[4];   <span class="comment">/* verts projected into floating point screen space */</span>
<a name="l00302"></a>00302     
<a name="l00303"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">00303</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[2];         <span class="comment">/* 2D bounds for mesh verts on the screen&#39;s plane (screenspace) */</span>
<a name="l00304"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">00304</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[2]; 
<a name="l00305"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">00305</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a>;         <span class="comment">/* Calculated from screenMin &amp; screenMax */</span>
<a name="l00306"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">00306</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a>;
<a name="l00307"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">00307</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a>, <a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a>;             <span class="comment">/* from the carea or from the projection render */</span>
<a name="l00308"></a>00308     
<a name="l00309"></a>00309     <span class="comment">/* options for projection painting */</span>
<a name="l00310"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a3d27fb6e59636e9ec4305ab594028bb2">00310</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a3d27fb6e59636e9ec4305ab594028bb2">do_layer_clone</a>;
<a name="l00311"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">00311</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">do_layer_stencil</a>;
<a name="l00312"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#afa9c804d1f7bf7c7c1c9cf86d3167035">00312</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#afa9c804d1f7bf7c7c1c9cf86d3167035">do_layer_stencil_inv</a>;
<a name="l00313"></a>00313     
<a name="l00314"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a04cc2cedebda1163ba6bcce7f02a183a">00314</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a04cc2cedebda1163ba6bcce7f02a183a">do_occlude</a>;               <span class="comment">/* Use raytraced occlusion? - ortherwise will paint right through to the back*/</span>
<a name="l00315"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">00315</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">do_backfacecull</a>;          <span class="comment">/* ignore faces with normals pointing away, skips a lot of raycasts if your normals are correctly flipped */</span>
<a name="l00316"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">00316</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a>;           <span class="comment">/* mask out pixels based on their normals */</span>
<a name="l00317"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#adc1ef909275c342888d42712ae9e7685">00317</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#adc1ef909275c342888d42712ae9e7685">do_new_shading_nodes</a>;     <span class="comment">/* cache scene_use_new_shading_nodes value */</span>
<a name="l00318"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">00318</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a>;             <span class="comment">/* what angle to mask at*/</span>
<a name="l00319"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">00319</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a>;
<a name="l00320"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a6d2c975c51ef4c7c41cbe8f20f4ca172">00320</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a6d2c975c51ef4c7c41cbe8f20f4ca172">normal_angle_range</a>;       <span class="comment">/* difference between normal_angle and normal_angle_inner, for easy access */</span>
<a name="l00321"></a>00321     
<a name="l00322"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">00322</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>;
<a name="l00323"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">00323</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a>;              <span class="comment">/* only to avoid using (ps.brush-&gt;flag &amp; BRUSH_AIRBRUSH) */</span>
<a name="l00324"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">00324</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a>;              <span class="comment">/* only to avoid running  */</span>
<a name="l00325"></a>00325 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l00326"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">00326</a> <span class="preprocessor"></span>    <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a>;
<a name="l00327"></a>00327 <span class="preprocessor">#endif</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>    <span class="comment">/* clone vars */</span>
<a name="l00329"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aff1f5b2976a49764aa85c89cf1d528f5">00329</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#aff1f5b2976a49764aa85c89cf1d528f5">cloneOffset</a>[2];
<a name="l00330"></a>00330     
<a name="l00331"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">00331</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>[4][4];     <span class="comment">/* Projection matrix, use for getting screen coords */</span>
<a name="l00332"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">00332</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>[3];           <span class="comment">/* View vector, use for do_backfacecull and for ray casting with an ortho viewport  */</span>
<a name="l00333"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">00333</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>[3];           <span class="comment">/* View location in object relative 3D space, so can compare to verts  */</span>
<a name="l00334"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">00334</a>     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">clipsta</a>, <a class="code" href="../../d0/d4c/structProjPaintState.html#ada08bc0948d0a0716e250a286ddc154e">clipend</a>;
<a name="l00335"></a>00335     
<a name="l00336"></a>00336     <span class="comment">/* reproject vars */</span>
<a name="l00337"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#acfaf5c49e6159a42c0311a6cbf1ca3f5">00337</a>     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaf5c49e6159a42c0311a6cbf1ca3f5">reproject_image</a>;
<a name="l00338"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">00338</a>     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a>;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="comment">/* threads */</span>
<a name="l00342"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">00342</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>;
<a name="l00343"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">00343</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[2];
<a name="l00344"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">00344</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[2];
<a name="l00345"></a><a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">00345</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a>, <a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a>; <span class="comment">/* must lock threads while accessing these */</span>
<a name="l00346"></a>00346 } <a class="code" href="../../df/d60/paint__image_8c.html#a5afd07ddcd39f6bf05ac0c4fc86ac786">ProjPaintState</a>;
<a name="l00347"></a>00347 
<a name="l00348"></a><a class="code" href="../../d6/dfa/unionpixelPointer.html">00348</a> <span class="keyword">typedef</span> <span class="keyword">union </span><a class="code" href="../../d6/dfa/unionpixelPointer.html">pixelPointer</a> {
<a name="l00349"></a><a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">00349</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>;            <span class="comment">/* float buffer */</span>
<a name="l00350"></a><a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">00350</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a>; <span class="comment">/* 2 ways to access a char buffer */</span>
<a name="l00351"></a><a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">00351</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a>;
<a name="l00352"></a>00352 } <a class="code" href="../../df/d60/paint__image_8c.html#ad3c75bed8e8fe28a23dcfa2e6624b4bd">PixelPointer</a>;
<a name="l00353"></a>00353 
<a name="l00354"></a><a class="code" href="../../d3/d0c/unionpixelStore.html">00354</a> <span class="keyword">typedef</span> <span class="keyword">union </span><a class="code" href="../../d3/d0c/unionpixelStore.html">pixelStore</a> {
<a name="l00355"></a><a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">00355</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>[4];
<a name="l00356"></a><a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">00356</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a>;
<a name="l00357"></a><a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">00357</a>     <span class="keywordtype">float</span> <a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[4];
<a name="l00358"></a>00358 } <a class="code" href="../../df/d60/paint__image_8c.html#a2425162cd439748fa8610885918be415">PixelStore</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="../../d7/da7/structProjPixel.html">00360</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> {
<a name="l00361"></a><a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">00361</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>[2]; <span class="comment">/* the floating point screen projection of this pixel */</span>
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     <span class="comment">/* Only used when the airbrush is disabled.</span>
<a name="l00364"></a>00364 <span class="comment">     * Store the max mask value to avoid painting over an area with a lower opacity</span>
<a name="l00365"></a>00365 <span class="comment">     * with an advantage that we can avoid touching the pixel at all, if the </span>
<a name="l00366"></a>00366 <span class="comment">     * new mask value is lower then mask_max */</span>
<a name="l00367"></a><a class="code" href="../../d7/da7/structProjPixel.html#a1c6fe91a1523482d4efd421dacf319b3">00367</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="../../d7/da7/structProjPixel.html#a1c6fe91a1523482d4efd421dacf319b3">mask_max</a>;
<a name="l00368"></a>00368     
<a name="l00369"></a>00369     <span class="comment">/* for various reasons we may want to mask out painting onto this pixel */</span>
<a name="l00370"></a><a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">00370</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">mask</a>;
<a name="l00371"></a>00371     
<a name="l00372"></a><a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">00372</a>     <span class="keywordtype">short</span> <a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a>, <a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a>;
<a name="l00373"></a>00373     
<a name="l00374"></a><a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">00374</a>     <a class="code" href="../../d3/d0c/unionpixelStore.html">PixelStore</a> <a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>;
<a name="l00375"></a><a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">00375</a>     <a class="code" href="../../d3/d0c/unionpixelStore.html">PixelStore</a> <a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>;
<a name="l00376"></a><a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">00376</a>     <a class="code" href="../../d6/dfa/unionpixelPointer.html">PixelPointer</a> <a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>;
<a name="l00377"></a>00377     
<a name="l00378"></a><a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">00378</a>     <span class="keywordtype">short</span> <a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a>; <span class="comment">/* if anyone wants to paint onto more then 32768 images they can bite me */</span>
<a name="l00379"></a><a class="code" href="../../d7/da7/structProjPixel.html#ace733fd9deb93129e05540104c3e375f">00379</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d7/da7/structProjPixel.html#ace733fd9deb93129e05540104c3e375f">bb_cell_index</a>;
<a name="l00380"></a>00380 } <a class="code" href="../../df/d60/paint__image_8c.html#aaf0c0ca859e4a2d91c3f687c16692061">ProjPixel</a>;
<a name="l00381"></a>00381 
<a name="l00382"></a><a class="code" href="../../db/d6f/structProjPixelClone.html">00382</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> {
<a name="l00383"></a><a class="code" href="../../db/d6f/structProjPixelClone.html#a3600ccb9b7b824dd7ee8a3b15f394701">00383</a>     <span class="keyword">struct </span><a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> <a class="code" href="../../db/d6f/structProjPixelClone.html#a3600ccb9b7b824dd7ee8a3b15f394701">__pp</a>;
<a name="l00384"></a><a class="code" href="../../db/d6f/structProjPixelClone.html#a16f73a65562d8be5be635bc8eebd2a96">00384</a>     <a class="code" href="../../d3/d0c/unionpixelStore.html">PixelStore</a> <a class="code" href="../../db/d6f/structProjPixelClone.html#a16f73a65562d8be5be635bc8eebd2a96">clonepx</a>;
<a name="l00385"></a>00385 } <a class="code" href="../../df/d60/paint__image_8c.html#a33097a6fe86e5d9027de8599a0cb1c2c">ProjPixelClone</a>;
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 <span class="comment">/* Finish projection painting structs */</span>
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html">00389</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> {
<a name="l00390"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a957c882abb66c5e07f6b71a01efe7143">00390</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> *<a class="code" href="../../d0/d5a/structUndoImageTile.html#a127d3b832598f880016f5c6108c0ff7d">next</a>, *<a class="code" href="../../d0/d5a/structUndoImageTile.html#a957c882abb66c5e07f6b71a01efe7143">prev</a>;
<a name="l00391"></a>00391 
<a name="l00392"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">00392</a>     <span class="keywordtype">char</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>[<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a6d7bce2e9ad79af316c9690a5b84b75c">MAX_ID_NAME</a>];  <span class="comment">/* name instead of pointer*/</span>
<a name="l00393"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">00393</a>     <span class="keywordtype">char</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>[<a class="code" href="../../dd/d38/iff_8h.html#a7a060924763e4b85b86b9fa61b3bc08e">IB_FILENAME_SIZE</a>];
<a name="l00394"></a>00394 
<a name="l00395"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">00395</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>;
<a name="l00396"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">00396</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>, <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>;
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">00398</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#aad5ff0e9e307408ee87fb9200fcc7ebe">source</a>, <a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a>;
<a name="l00399"></a><a class="code" href="../../d0/d5a/structUndoImageTile.html#a9661724127ca9f53676883b5cbb71c20">00399</a>     <span class="keywordtype">char</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#a9661724127ca9f53676883b5cbb71c20">gen_type</a>;
<a name="l00400"></a>00400 } <a class="code" href="../../df/d60/paint__image_8c.html#a0c49277d441c6ad13a8fcadc6154dc93">UndoImageTile</a>;
<a name="l00401"></a>00401 
<a name="l00402"></a><a class="code" href="../../df/d60/paint__image_8c.html#a68d991f4214f1f581ab16a213003bebe">00402</a> <span class="keyword">static</span> <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> <a class="code" href="../../df/d60/paint__image_8c.html#a68d991f4214f1f581ab16a213003bebe">imapaintpartial</a> = {0, 0, 0, 0, 0};
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">/* UNDO */</span>
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0ff2500d2d036ae7c43d04449a7e3f9b">00406</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0ff2500d2d036ae7c43d04449a7e3f9b">undo_copy_tile</a>(<a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> *tile, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> restore)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408     <span class="comment">/* copy or swap contents of tile-&gt;rect and region in ibuf-&gt;rect */</span>
<a name="l00409"></a>00409     <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tmpibuf, ibuf, 0, 0, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a> * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>,
<a name="l00410"></a>00410                 tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a> * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00413"></a>00413         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">void</span> *, tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>);
<a name="l00414"></a>00414     }
<a name="l00415"></a>00415     <span class="keywordflow">else</span> {
<a name="l00416"></a>00416         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">void</span> *, tmpibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>);
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418     
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (restore)
<a name="l00420"></a>00420         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(ibuf, tmpibuf, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a> * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>,
<a name="l00421"></a>00421                     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a> * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, 0, 0, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>);
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9890215840305f6195ffd5deb672ab8e">00424</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../df/d60/paint__image_8c.html#a9890215840305f6195ffd5deb672ab8e">image_undo_push_tile</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> **tmpibuf, <span class="keywordtype">int</span> x_tile, <span class="keywordtype">int</span> y_tile)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../d3/d6c/paint__intern_8h.html#adf3ad319a227bf21f482daae4acceb33">undo_paint_push_get_list</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#ae72eba1367367168e15c361226b6f8b5">UNDO_PAINT_IMAGE</a>);
<a name="l00427"></a>00427     <a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> *tile;
<a name="l00428"></a>00428     <span class="keywordtype">int</span> allocsize;
<a name="l00429"></a>00429     <span class="keywordtype">short</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> ? 1 : 0;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="keywordflow">for</span> (tile = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tile; tile = tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a127d3b832598f880016f5c6108c0ff7d">next</a>)
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a> == x_tile &amp;&amp; tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a> == y_tile &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a> == tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a9661724127ca9f53676883b5cbb71c20">gen_type</a> &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aad5ff0e9e307408ee87fb9200fcc7ebe">source</a>)
<a name="l00433"></a>00433             <span class="keywordflow">if</span> (tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a> == use_float)
<a name="l00434"></a>00434                 <span class="keywordflow">if</span> (strcmp(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) == 0 &amp;&amp; strcmp(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>) == 0)
<a name="l00435"></a>00435                     <span class="keywordflow">return</span> tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>;
<a name="l00436"></a>00436     
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (*tmpibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00438"></a>00438         *tmpibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(<a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, 32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00439"></a>00439     
<a name="l00440"></a>00440     tile = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a>), <span class="stringliteral">&quot;UndoImageTile&quot;</span>);
<a name="l00441"></a>00441     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, <span class="keyword">sizeof</span>(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>));
<a name="l00442"></a>00442     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a> = x_tile;
<a name="l00443"></a>00443     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a> = y_tile;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     allocsize = <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a> * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a> * 4;
<a name="l00446"></a>00446     allocsize *= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) ? <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) : <span class="keyword">sizeof</span>(char);
<a name="l00447"></a>00447     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(allocsize, <span class="stringliteral">&quot;UndeImageTile.rect&quot;</span>);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keyword">sizeof</span>(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>));
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a9661724127ca9f53676883b5cbb71c20">gen_type</a> = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>;
<a name="l00452"></a>00452     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aad5ff0e9e307408ee87fb9200fcc7ebe">source</a> = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>;
<a name="l00453"></a>00453     tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a> = <a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <a class="code" href="../../df/d60/paint__image_8c.html#a0ff2500d2d036ae7c43d04449a7e3f9b">undo_copy_tile</a>(tile, *tmpibuf, ibuf, 0);
<a name="l00456"></a>00456     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a153efe1cce4a72fa81032c023218580d">undo_paint_push_count_alloc</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#ae72eba1367367168e15c361226b6f8b5">UNDO_PAINT_IMAGE</a>, allocsize);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, tile);
<a name="l00459"></a>00459     
<a name="l00460"></a>00460     <span class="keywordflow">return</span> tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>;
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a><a class="code" href="../../df/d60/paint__image_8c.html#a25817c3cd4284aa49818857455c8b5f7">00463</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a25817c3cd4284aa49818857455c8b5f7">image_undo_restore</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l00466"></a>00466     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00467"></a>00467     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, *tmpibuf;
<a name="l00468"></a>00468     <a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> *tile;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     tmpibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(<a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>, 32,
<a name="l00471"></a>00471                              <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00472"></a>00472     
<a name="l00473"></a>00473     <span class="keywordflow">for</span> (tile = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tile; tile = tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a127d3b832598f880016f5c6108c0ff7d">next</a>) {
<a name="l00474"></a>00474         <span class="keywordtype">short</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a>;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="comment">/* find image based on name, pointer becomes invalid with global undo */</span>
<a name="l00477"></a>00477         <span class="keywordflow">if</span> (ima &amp;&amp; strcmp(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) == 0) {
<a name="l00478"></a>00478             <span class="comment">/* ima is valid */</span>
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480         <span class="keywordflow">else</span> {
<a name="l00481"></a>00481             ima = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(&amp;bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a683bfdfa3f231a8a2cd1f88552a685dd">image</a>, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5ce37f912bc04fe0d7a33764df49fcb1">idname</a>, offsetof(<a class="code" href="../../d8/d7e/structID.html">ID</a>, name));
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         <span class="keywordflow">if</span> (ima &amp;&amp; ibuf &amp;&amp; strcmp(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>) != 0) {
<a name="l00487"></a>00487             <span class="comment">/* current ImBuf filename was changed, probably current frame</span>
<a name="l00488"></a>00488 <span class="comment">             * was changed when paiting on image sequence, rather than storing</span>
<a name="l00489"></a>00489 <span class="comment">             * full image user (which isn&#39;t so obvious, btw) try to find ImBuf with</span>
<a name="l00490"></a>00490 <span class="comment">             * matched file name in list of already loaded images */</span>
<a name="l00491"></a>00491 
<a name="l00492"></a>00492             ibuf = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5918a1d334bb83d7a3b6b6a371bd3314">ibufname</a>, offsetof(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>, name));
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         <span class="keywordflow">if</span> (!ima || !ibuf || !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> || ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>))
<a name="l00496"></a>00496             <span class="keywordflow">continue</span>;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a> != tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a9661724127ca9f53676883b5cbb71c20">gen_type</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> != tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#aad5ff0e9e307408ee87fb9200fcc7ebe">source</a>)
<a name="l00499"></a>00499             <span class="keywordflow">continue</span>;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         use_float = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> ? 1 : 0;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (use_float != tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a12edd35a09d4ea2f473982d0c3d951de">use_float</a>)
<a name="l00504"></a>00504             <span class="keywordflow">continue</span>;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <a class="code" href="../../df/d60/paint__image_8c.html#a0ff2500d2d036ae7c43d04449a7e3f9b">undo_copy_tile</a>(tile, tmpibuf, ibuf, 1);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(ima); <span class="comment">/* force OpenGL reload */</span>
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l00510"></a>00510             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>; <span class="comment">/* force recreate of char rect */</span>
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0])
<a name="l00512"></a>00512             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;  <span class="comment">/* force mipmap recreatiom */</span>
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tmpibuf);
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab48408e0b88f6dd23f5690a5a2823354">00519</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab48408e0b88f6dd23f5690a5a2823354">image_undo_free</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <a class="code" href="../../d0/d5a/structUndoImageTile.html">UndoImageTile</a> *tile;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="keywordflow">for</span> (tile = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tile; tile = tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a127d3b832598f880016f5c6108c0ff7d">next</a>)
<a name="l00524"></a>00524         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tile-&gt;<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>);
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="comment">/* get active image for face depending on old/new shading system */</span>
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9cc21c157177ac3f0c14231d18520a57">00529</a> <span class="keyword">static</span> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../df/d60/paint__image_8c.html#a9cc21c157177ac3f0c14231d18520a57">imapaint_face_image</a>(<span class="keyword">const</span> <a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s, <span class="keywordtype">int</span> face_index)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a041ff0e68dd0152e85ceddddc9b53cdc">scene_use_new_shading_nodes</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>)) {
<a name="l00534"></a>00534         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a101251ead8a3f30ec777ac67f9a38bec">dm_mface</a>[face_index];
<a name="l00535"></a>00535         <a class="code" href="../../dd/d25/ED__uvedit_8h.html#a7114dcdd8bc9228ae432eb8667519e88">ED_object_get_active_image</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> + 1, &amp;ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537     <span class="keywordflow">else</span> {
<a name="l00538"></a>00538         <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf = &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a372ae501bbd0c968d25100f9652e7888">dm_mtface</a>[face_index];
<a name="l00539"></a>00539         ima = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">return</span> ima;
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">00545</a> <span class="keyword">static</span> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *dm_mtface, <span class="keywordtype">int</span> face_index)
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adc1ef909275c342888d42712ae9e7685">do_new_shading_nodes</a>) { <span class="comment">/* cached scene_use_new_shading_nodes result */</span>
<a name="l00550"></a>00550         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l00551"></a>00551         <a class="code" href="../../dd/d25/ED__uvedit_8h.html#a7114dcdd8bc9228ae432eb8667519e88">ED_object_get_active_image</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> + 1, &amp;ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553     <span class="keywordflow">else</span> {
<a name="l00554"></a>00554         ima = dm_mtface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>;
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557     <span class="keywordflow">return</span> ima;
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">/* fast projection bucket array lookup, use the safe version for bound checking  */</span>
<a name="l00561"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0cd5b76b629dc241aa24cd0036fd8fa2">00561</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0cd5b76b629dc241aa24cd0036fd8fa2">project_bucket_offset</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">float</span> projCoSS[2])
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <span class="comment">/* If we were not dealing with screenspace 2D coords we could simple do...</span>
<a name="l00564"></a>00564 <span class="comment">     * ps-&gt;bucketRect[x + (y*ps-&gt;buckets_y)] */</span>
<a name="l00565"></a>00565     
<a name="l00566"></a>00566     <span class="comment">/* please explain?</span>
<a name="l00567"></a>00567 <span class="comment">     * projCoSS[0] - ps-&gt;screenMin[0]   : zero origin</span>
<a name="l00568"></a>00568 <span class="comment">     * ... / ps-&gt;screen_width               : range from 0.0 to 1.0</span>
<a name="l00569"></a>00569 <span class="comment">     * ... * ps-&gt;buckets_x      : use as a bucket index</span>
<a name="l00570"></a>00570 <span class="comment">     *</span>
<a name="l00571"></a>00571 <span class="comment">     * Second multiplication does similar but for vertical offset</span>
<a name="l00572"></a>00572 <span class="comment">     */</span>
<a name="l00573"></a>00573     <span class="keywordflow">return</span> (   (<span class="keywordtype">int</span>)(((projCoSS[0] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0]) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a>)  * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>)) +
<a name="l00574"></a>00574            (   (   (int)(((projCoSS[1] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1])  / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>)) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>);
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="../../df/d60/paint__image_8c.html#a101d04ef699e224c48dd9f9e61e26c51">00577</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a101d04ef699e224c48dd9f9e61e26c51">project_bucket_offset_safe</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">float</span> projCoSS[2])
<a name="l00578"></a>00578 {
<a name="l00579"></a>00579     <span class="keywordtype">int</span> bucket_index = <a class="code" href="../../df/d60/paint__image_8c.html#a0cd5b76b629dc241aa24cd0036fd8fa2">project_bucket_offset</a>(ps, projCoSS);
<a name="l00580"></a>00580     
<a name="l00581"></a>00581     <span class="keywordflow">if</span> (bucket_index &lt; 0 || bucket_index &gt;= ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>) {
<a name="l00582"></a>00582         <span class="keywordflow">return</span> -1;
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584     <span class="keywordflow">else</span> {
<a name="l00585"></a>00585         <span class="keywordflow">return</span> bucket_index;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="comment">/* still use 2D X,Y space but this works for verts transformed by a perspective matrix, using their 4th component as a weight */</span>
<a name="l00590"></a><a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">00590</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(<span class="keywordtype">float</span> v1[4], <span class="keywordtype">float</span> v2[4], <span class="keywordtype">float</span> v3[4], <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2], <span class="keywordtype">float</span> w[3])
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <span class="keywordtype">float</span> wtot_inv, wtot;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     w[0] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v2, v3, co) / v1[3];
<a name="l00595"></a>00595     w[1] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v3, v1, co) / v2[3];
<a name="l00596"></a>00596     w[2] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v1, v2, co) / v3[3];
<a name="l00597"></a>00597     wtot = w[0] + w[1] + w[2];
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (wtot != 0.0f) {
<a name="l00600"></a>00600         wtot_inv = 1.0f / wtot;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         w[0] = w[0] * wtot_inv;
<a name="l00603"></a>00603         w[1] = w[1] * wtot_inv;
<a name="l00604"></a>00604         w[2] = w[2] * wtot_inv;
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606     <span class="keywordflow">else</span> <span class="comment">/* dummy values for zero area face */</span>
<a name="l00607"></a>00607         w[0] = w[1] = w[2] = 1.0f / 3.0f;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="../../df/d60/paint__image_8c.html#a04bf95ac363883c0d3a9aeb7af96b1ab">00610</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d60/paint__image_8c.html#a04bf95ac363883c0d3a9aeb7af96b1ab">VecZDepthOrtho</a>(<span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> v2[3], <span class="keywordtype">float</span> v3[3], <span class="keywordtype">float</span> w[3])
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1, v2, v3, pt, w);
<a name="l00613"></a>00613     <span class="keywordflow">return</span> (v1[2] * w[0]) + (v2[2] * w[1]) + (v3[2] * w[2]);
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="../../df/d60/paint__image_8c.html#af2abf2a07bffe0460c69c3fc6a036248">00616</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d60/paint__image_8c.html#af2abf2a07bffe0460c69c3fc6a036248">VecZDepthPersp</a>(<span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> v1[4], <span class="keywordtype">float</span> v2[4], <span class="keywordtype">float</span> v3[4], <span class="keywordtype">float</span> w[3])
<a name="l00617"></a>00617 {
<a name="l00618"></a>00618     <span class="keywordtype">float</span> wtot_inv, wtot;
<a name="l00619"></a>00619     <span class="keywordtype">float</span> w_tmp[3];
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1, v2, v3, pt, w);
<a name="l00622"></a>00622     <span class="comment">/* for the depth we need the weights to match what</span>
<a name="l00623"></a>00623 <span class="comment">     * barycentric_weights_v2 would return, in this case its easiest just to</span>
<a name="l00624"></a>00624 <span class="comment">     * undo the 4th axis division and make it unit-sum</span>
<a name="l00625"></a>00625 <span class="comment">     *</span>
<a name="l00626"></a>00626 <span class="comment">     * don&#39;t call barycentric_weights_v2() becaue our callers expect &#39;w&#39;</span>
<a name="l00627"></a>00627 <span class="comment">     * to be weighted from the perspective */</span>
<a name="l00628"></a>00628     w_tmp[0] = w[0] * v1[3];
<a name="l00629"></a>00629     w_tmp[1] = w[1] * v2[3];
<a name="l00630"></a>00630     w_tmp[2] = w[2] * v3[3];
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     wtot = w_tmp[0] + w_tmp[1] + w_tmp[2];
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (wtot != 0.0f) {
<a name="l00635"></a>00635         wtot_inv = 1.0f / wtot;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         w_tmp[0] = w_tmp[0] * wtot_inv;
<a name="l00638"></a>00638         w_tmp[1] = w_tmp[1] * wtot_inv;
<a name="l00639"></a>00639         w_tmp[2] = w_tmp[2] * wtot_inv;
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641     <span class="keywordflow">else</span> <span class="comment">/* dummy values for zero area face */</span>
<a name="l00642"></a>00642         w_tmp[0] = w_tmp[1] = w_tmp[2] = 1.0f / 3.0f;
<a name="l00643"></a>00643     <span class="comment">/* done mimicing barycentric_weights_v2() */</span>
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="keywordflow">return</span> (v1[2] * w_tmp[0]) + (v2[2] * w_tmp[1]) + (v3[2] * w_tmp[2]);
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="comment">/* Return the top-most face index that the screen space coord &#39;pt&#39; touches (or -1) */</span>
<a name="l00650"></a><a class="code" href="../../df/d60/paint__image_8c.html#abfc2c1dbf9f1db5aacf31165e24d946c">00650</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#abfc2c1dbf9f1db5aacf31165e24d946c">project_paint_PickFace</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> w[3], <span class="keywordtype">int</span> *side)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node;
<a name="l00653"></a>00653     <span class="keywordtype">float</span> w_tmp[3];
<a name="l00654"></a>00654     <span class="keywordtype">float</span> *v1, *v2, *v3, *v4;
<a name="l00655"></a>00655     <span class="keywordtype">int</span> bucket_index;
<a name="l00656"></a>00656     <span class="keywordtype">int</span> face_index;
<a name="l00657"></a>00657     <span class="keywordtype">int</span> best_side = -1;
<a name="l00658"></a>00658     <span class="keywordtype">int</span> best_face_index = -1;
<a name="l00659"></a>00659     <span class="keywordtype">float</span> z_depth_best = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, z_depth;
<a name="l00660"></a>00660     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l00661"></a>00661     
<a name="l00662"></a>00662     bucket_index = <a class="code" href="../../df/d60/paint__image_8c.html#a101d04ef699e224c48dd9f9e61e26c51">project_bucket_offset_safe</a>(ps, pt);
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (bucket_index == -1)
<a name="l00664"></a>00664         <span class="keywordflow">return</span> -1;
<a name="l00665"></a>00665     
<a name="l00666"></a>00666     
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     <span class="comment">/* we could return 0 for 1 face buckets, as long as this function assumes</span>
<a name="l00669"></a>00669 <span class="comment">     * that the point its testing is only every originated from an existing face */</span>
<a name="l00670"></a>00670     
<a name="l00671"></a>00671     <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>[bucket_index]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l00672"></a>00672         face_index = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>);
<a name="l00673"></a>00673         mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l00674"></a>00674         
<a name="l00675"></a>00675         v1 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l00676"></a>00676         v2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l00677"></a>00677         v3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l00678"></a>00678         
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(pt, v1, v2, v3)) {
<a name="l00680"></a>00680             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) z_depth = <a class="code" href="../../df/d60/paint__image_8c.html#a04bf95ac363883c0d3a9aeb7af96b1ab">VecZDepthOrtho</a>(pt, v1, v2, v3, w_tmp);
<a name="l00681"></a>00681             <span class="keywordflow">else</span> z_depth = <a class="code" href="../../df/d60/paint__image_8c.html#af2abf2a07bffe0460c69c3fc6a036248">VecZDepthPersp</a>(pt, v1, v2, v3, w_tmp);
<a name="l00682"></a>00682             
<a name="l00683"></a>00683             <span class="keywordflow">if</span> (z_depth &lt; z_depth_best) {
<a name="l00684"></a>00684                 best_face_index = face_index;
<a name="l00685"></a>00685                 best_side = 0;
<a name="l00686"></a>00686                 z_depth_best = z_depth;
<a name="l00687"></a>00687                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(w, w_tmp);
<a name="l00688"></a>00688             }
<a name="l00689"></a>00689         }
<a name="l00690"></a>00690         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00691"></a>00691             v4 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l00692"></a>00692             
<a name="l00693"></a>00693             <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(pt, v1, v3, v4)) {
<a name="l00694"></a>00694                 <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) z_depth = <a class="code" href="../../df/d60/paint__image_8c.html#a04bf95ac363883c0d3a9aeb7af96b1ab">VecZDepthOrtho</a>(pt, v1, v3, v4, w_tmp);
<a name="l00695"></a>00695                 <span class="keywordflow">else</span> z_depth = <a class="code" href="../../df/d60/paint__image_8c.html#af2abf2a07bffe0460c69c3fc6a036248">VecZDepthPersp</a>(pt, v1, v3, v4, w_tmp);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (z_depth &lt; z_depth_best) {
<a name="l00698"></a>00698                     best_face_index = face_index;
<a name="l00699"></a>00699                     best_side = 1;
<a name="l00700"></a>00700                     z_depth_best = z_depth;
<a name="l00701"></a>00701                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(w, w_tmp);
<a name="l00702"></a>00702                 }
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     
<a name="l00707"></a>00707     *side = best_side;
<a name="l00708"></a>00708     <span class="keywordflow">return</span> best_face_index; <span class="comment">/* will be -1 or a valid face */</span>
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="comment">/* Converts a uv coord into a pixel location wrapping if the uv is outside 0-1 range */</span>
<a name="l00712"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6d67ec6342a242a0d07887a248b2b43e">00712</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6d67ec6342a242a0d07887a248b2b43e">uvco_to_wrapped_pxco</a>(<span class="keywordtype">float</span> uv[2], <span class="keywordtype">int</span> ibuf_x, <span class="keywordtype">int</span> ibuf_y, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>)
<a name="l00713"></a>00713 {
<a name="l00714"></a>00714     <span class="comment">/* use */</span>
<a name="l00715"></a>00715     *x = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(uv[0], 1.0f);
<a name="l00716"></a>00716     *y = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(uv[1], 1.0f);
<a name="l00717"></a>00717     
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (*x &lt; 0.0f) *x += 1.0f;
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (*y &lt; 0.0f) *y += 1.0f;
<a name="l00720"></a>00720     
<a name="l00721"></a>00721     *x = *x * ibuf_x - 0.5f;
<a name="l00722"></a>00722     *y = *y * ibuf_y - 0.5f;
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="comment">/* Set the top-most face color that the screen space coord &#39;pt&#39; touches (or return 0 if none touch) */</span>
<a name="l00726"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">00726</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">project_paint_PickColor</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> *rgba_fp, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rgba, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#a32ab8a4ea05ec3bd24625aa576b6adab">interp</a>)
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728     <span class="keywordtype">float</span> w[3], uv[2];
<a name="l00729"></a>00729     <span class="keywordtype">int</span> side;
<a name="l00730"></a>00730     <span class="keywordtype">int</span> face_index;
<a name="l00731"></a>00731     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf;
<a name="l00732"></a>00732     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00733"></a>00733     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00734"></a>00734     <span class="keywordtype">int</span> xi, yi;
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     
<a name="l00737"></a>00737     face_index = <a class="code" href="../../df/d60/paint__image_8c.html#abfc2c1dbf9f1db5aacf31165e24d946c">project_paint_PickFace</a>(ps, pt, w, &amp;side);
<a name="l00738"></a>00738     
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (face_index == -1)
<a name="l00740"></a>00740         <span class="keywordflow">return</span> 0;
<a name="l00741"></a>00741     
<a name="l00742"></a>00742     tf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> + face_index;
<a name="l00743"></a>00743     
<a name="l00744"></a>00744     <span class="keywordflow">if</span> (side == 0) {
<a name="l00745"></a>00745         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(uv, tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2], w);
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747     <span class="keywordflow">else</span> { <span class="comment">/* QUAD */</span>
<a name="l00748"></a>00748         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(uv, tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3], w);
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     ima = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, face_index);
<a name="l00752"></a>00752     ibuf = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; <span class="comment">/* we must have got the imbuf before getting here */</span>
<a name="l00753"></a>00753     <span class="keywordflow">if</span> (!ibuf) <span class="keywordflow">return</span> 0;
<a name="l00754"></a>00754     
<a name="l00755"></a>00755     <span class="keywordflow">if</span> (interp) {
<a name="l00756"></a>00756         <span class="keywordtype">float</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>, <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>;
<a name="l00757"></a>00757         <a class="code" href="../../df/d60/paint__image_8c.html#a6d67ec6342a242a0d07887a248b2b43e">uvco_to_wrapped_pxco</a>(uv, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, &amp;x, &amp;y);
<a name="l00758"></a>00758         
<a name="l00759"></a>00759         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00760"></a>00760             <span class="keywordflow">if</span> (rgba_fp) {
<a name="l00761"></a>00761                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rgba_fp, x, y);
<a name="l00762"></a>00762             }
<a name="l00763"></a>00763             <span class="keywordflow">else</span> {
<a name="l00764"></a>00764                 <span class="keywordtype">float</span> rgba_tmp_f[4];
<a name="l00765"></a>00765                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rgba_tmp_f, x, y);
<a name="l00766"></a>00766                 <a class="code" href="../../df/d60/paint__image_8c.html#a74558eb5d272e225b52223c7b2f9ac21">IMAPAINT_FLOAT_RGBA_TO_CHAR</a>(rgba, rgba_tmp_f);
<a name="l00767"></a>00767             }
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769         <span class="keywordflow">else</span> {
<a name="l00770"></a>00770             <span class="keywordflow">if</span> (rgba) {
<a name="l00771"></a>00771                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf, rgba, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x, y);
<a name="l00772"></a>00772             }
<a name="l00773"></a>00773             <span class="keywordflow">else</span> {
<a name="l00774"></a>00774                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_tmp[4];
<a name="l00775"></a>00775                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf, rgba_tmp, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x, y);
<a name="l00776"></a>00776                 <a class="code" href="../../df/d60/paint__image_8c.html#ab64a89eb73f6bf7f5f66ff9283e2a674">IMAPAINT_CHAR_RGBA_TO_FLOAT</a>(rgba_fp, rgba_tmp);
<a name="l00777"></a>00777             }
<a name="l00778"></a>00778         }
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780     <span class="keywordflow">else</span> {
<a name="l00781"></a>00781         <span class="comment">//xi = (int)((uv[0]*ibuf-&gt;x) + 0.5f);</span>
<a name="l00782"></a>00782         <span class="comment">//yi = (int)((uv[1]*ibuf-&gt;y) + 0.5f);</span>
<a name="l00783"></a>00783         <span class="comment">//if (xi&lt;0 || xi&gt;=ibuf-&gt;x  ||  yi&lt;0 || yi&gt;=ibuf-&gt;y) return 0;</span>
<a name="l00784"></a>00784         
<a name="l00785"></a>00785         <span class="comment">/* wrap */</span>
<a name="l00786"></a>00786         xi = ((int)(uv[0] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>)) % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00787"></a>00787         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (xi &lt; 0) xi += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00788"></a>00788         yi = ((int)(uv[1] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>)) % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00789"></a>00789         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (yi &lt; 0) yi += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00790"></a>00790         
<a name="l00791"></a>00791         
<a name="l00792"></a>00792         <span class="keywordflow">if</span> (rgba) {
<a name="l00793"></a>00793             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00794"></a>00794                 <span class="keywordtype">float</span> *rgba_tmp_fp = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (xi + yi * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * 4);
<a name="l00795"></a>00795                 <a class="code" href="../../df/d60/paint__image_8c.html#a74558eb5d272e225b52223c7b2f9ac21">IMAPAINT_FLOAT_RGBA_TO_CHAR</a>(rgba, rgba_tmp_fp);
<a name="l00796"></a>00796             }
<a name="l00797"></a>00797             <span class="keywordflow">else</span> {
<a name="l00798"></a>00798                 *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rgba) = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(((<span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) + ((xi + yi * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * 4));
<a name="l00799"></a>00799             }
<a name="l00800"></a>00800         }
<a name="l00801"></a>00801         
<a name="l00802"></a>00802         <span class="keywordflow">if</span> (rgba_fp) {
<a name="l00803"></a>00803             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00804"></a>00804                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(rgba_fp, ((<span class="keywordtype">float</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + ((xi + yi * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * 4)));
<a name="l00805"></a>00805             }
<a name="l00806"></a>00806             <span class="keywordflow">else</span> {
<a name="l00807"></a>00807                 <span class="keywordtype">char</span> *tmp_ch = ((<span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) + ((xi + yi * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * 4);
<a name="l00808"></a>00808                 <a class="code" href="../../df/d60/paint__image_8c.html#ab64a89eb73f6bf7f5f66ff9283e2a674">IMAPAINT_CHAR_RGBA_TO_FLOAT</a>(rgba_fp, tmp_ch);
<a name="l00809"></a>00809             }
<a name="l00810"></a>00810         }
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812     <span class="keywordflow">return</span> 1;
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 <span class="comment">/* Check if &#39;pt&#39; is infront of the 3 verts on the Z axis (used for screenspace occlusuion test)</span>
<a name="l00816"></a>00816 <span class="comment"> * return...</span>
<a name="l00817"></a>00817 <span class="comment"> *  0   : no occlusion</span>
<a name="l00818"></a>00818 <span class="comment"> * -1   : no occlusion but 2D intersection is true (avoid testing the other half of a quad)</span>
<a name="l00819"></a>00819 <span class="comment"> *  1   : occluded</span>
<a name="l00820"></a>00820 <span class="comment"> *  2   : occluded with w[3] weights set (need to know in some cases) */</span>
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="../../df/d60/paint__image_8c.html#a1f3a6d5b05995fd94c1c25384107fb61">00822</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a1f3a6d5b05995fd94c1c25384107fb61">project_paint_occlude_ptv</a>(<span class="keywordtype">float</span> pt[3], <span class="keywordtype">float</span> v1[4], <span class="keywordtype">float</span> v2[4], <span class="keywordtype">float</span> v3[4], <span class="keywordtype">float</span> w[3], <span class="keywordtype">int</span> is_ortho)
<a name="l00823"></a>00823 {
<a name="l00824"></a>00824     <span class="comment">/* if all are behind us, return false */</span>
<a name="l00825"></a>00825     <span class="keywordflow">if</span> (v1[2] &gt; pt[2] &amp;&amp; v2[2] &gt; pt[2] &amp;&amp; v3[2] &gt; pt[2])
<a name="l00826"></a>00826         <span class="keywordflow">return</span> 0;
<a name="l00827"></a>00827         
<a name="l00828"></a>00828     <span class="comment">/* do a 2D point in try intersection */</span>
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(pt, v1, v2, v3))
<a name="l00830"></a>00830         <span class="keywordflow">return</span> 0;  <span class="comment">/* we know there is  */</span>
<a name="l00831"></a>00831     
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="comment">/* From here on we know there IS an intersection */</span>
<a name="l00834"></a>00834     <span class="comment">/* if ALL of the verts are infront of us then we know it intersects ? */</span>
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (v1[2] &lt; pt[2] &amp;&amp; v2[2] &lt; pt[2] &amp;&amp; v3[2] &lt; pt[2]) {
<a name="l00836"></a>00836         <span class="keywordflow">return</span> 1;
<a name="l00837"></a>00837     }
<a name="l00838"></a>00838     <span class="keywordflow">else</span> {
<a name="l00839"></a>00839         <span class="comment">/* we intersect? - find the exact depth at the point of intersection */</span>
<a name="l00840"></a>00840         <span class="comment">/* Is this point is occluded by another face? */</span>
<a name="l00841"></a>00841         <span class="keywordflow">if</span> (is_ortho) {
<a name="l00842"></a>00842             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a04bf95ac363883c0d3a9aeb7af96b1ab">VecZDepthOrtho</a>(pt, v1, v2, v3, w) &lt; pt[2]) <span class="keywordflow">return</span> 2;
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844         <span class="keywordflow">else</span> {
<a name="l00845"></a>00845             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#af2abf2a07bffe0460c69c3fc6a036248">VecZDepthPersp</a>(pt, v1, v2, v3, w) &lt; pt[2]) <span class="keywordflow">return</span> 2;
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847     }
<a name="l00848"></a>00848     <span class="keywordflow">return</span> -1;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851 
<a name="l00852"></a><a class="code" href="../../df/d60/paint__image_8c.html#aa84c64ea92bd773bdf6c082efb79ca25">00852</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#aa84c64ea92bd773bdf6c082efb79ca25">project_paint_occlude_ptv_clip</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf,
<a name="l00853"></a>00853                                           <span class="keywordtype">float</span> pt[3], <span class="keywordtype">float</span> v1[4], <span class="keywordtype">float</span> v2[4], <span class="keywordtype">float</span> v3[4],
<a name="l00854"></a>00854                                           <span class="keyword">const</span> <span class="keywordtype">int</span> side)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856     <span class="keywordtype">float</span> w[3], wco[3];
<a name="l00857"></a>00857     <span class="keywordtype">int</span> ret = <a class="code" href="../../df/d60/paint__image_8c.html#a1f3a6d5b05995fd94c1c25384107fb61">project_paint_occlude_ptv</a>(pt, v1, v2, v3, w, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (ret &lt;= 0)
<a name="l00860"></a>00860         <span class="keywordflow">return</span> ret;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (ret == 1) { <span class="comment">/* weights not calculated */</span>
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1, v2, v3, pt, w);
<a name="l00864"></a>00864         <span class="keywordflow">else</span> <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1, v2, v3, pt, w);
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867     <span class="comment">/* Test if we&#39;re in the clipped area, */</span>
<a name="l00868"></a>00868     <span class="keywordflow">if</span> (side) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(wco, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, w);
<a name="l00869"></a>00869     <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(wco, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, w);
<a name="l00870"></a>00870     
<a name="l00871"></a>00871     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, wco, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l00872"></a>00872         <span class="keywordflow">return</span> 1;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874     
<a name="l00875"></a>00875     <span class="keywordflow">return</span> -1;
<a name="l00876"></a>00876 }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 <span class="comment">/* Check if a screenspace location is occluded by any other faces</span>
<a name="l00880"></a>00880 <span class="comment"> * check, pixelScreenCo must be in screenspace, its Z-Depth only needs to be used for comparison</span>
<a name="l00881"></a>00881 <span class="comment"> * and dosn&#39;t need to be correct in relation to X and Y coords (this is the case in perspective view) */</span>
<a name="l00882"></a><a class="code" href="../../df/d60/paint__image_8c.html#a615fee50daf162b756518969493e594f">00882</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a615fee50daf162b756518969493e594f">project_bucket_point_occluded</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *bucketFace, <span class="keyword">const</span> <span class="keywordtype">int</span> orig_face, <span class="keywordtype">float</span> pixelScreenCo[4])
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l00885"></a>00885     <span class="keywordtype">int</span> face_index;
<a name="l00886"></a>00886     <span class="keywordtype">int</span> isect_ret;
<a name="l00887"></a>00887     <span class="keywordtype">float</span> w[3]; <span class="comment">/* not needed when clipping */</span>
<a name="l00888"></a>00888     <span class="keyword">const</span> <span class="keywordtype">short</span> do_clip = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a> ? ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a> : 0;
<a name="l00889"></a>00889     
<a name="l00890"></a>00890     <span class="comment">/* we could return 0 for 1 face buckets, as long as this function assumes</span>
<a name="l00891"></a>00891 <span class="comment">     * that the point its testing is only every originated from an existing face */</span>
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <span class="keywordflow">for</span> (; bucketFace; bucketFace = bucketFace-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l00894"></a>00894         face_index = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(bucketFace-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896         <span class="keywordflow">if</span> (orig_face != face_index) {
<a name="l00897"></a>00897             mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l00898"></a>00898             <span class="keywordflow">if</span> (do_clip)
<a name="l00899"></a>00899                 isect_ret = <a class="code" href="../../df/d60/paint__image_8c.html#aa84c64ea92bd773bdf6c082efb79ca25">project_paint_occlude_ptv_clip</a>(ps, mf, pixelScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], 0);
<a name="l00900"></a>00900             <span class="keywordflow">else</span>
<a name="l00901"></a>00901                 isect_ret = <a class="code" href="../../df/d60/paint__image_8c.html#a1f3a6d5b05995fd94c1c25384107fb61">project_paint_occlude_ptv</a>(pixelScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], w, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903             <span class="comment">/* Note, if isect_ret==-1 then we don&#39;t want to test the other side of the quad */</span>
<a name="l00904"></a>00904             <span class="keywordflow">if</span> (isect_ret == 0 &amp;&amp; mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> (do_clip)
<a name="l00906"></a>00906                     isect_ret = <a class="code" href="../../df/d60/paint__image_8c.html#aa84c64ea92bd773bdf6c082efb79ca25">project_paint_occlude_ptv_clip</a>(ps, mf, pixelScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], 1);
<a name="l00907"></a>00907                 <span class="keywordflow">else</span>
<a name="l00908"></a>00908                     isect_ret = <a class="code" href="../../df/d60/paint__image_8c.html#a1f3a6d5b05995fd94c1c25384107fb61">project_paint_occlude_ptv</a>(pixelScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], w, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>);
<a name="l00909"></a>00909             }
<a name="l00910"></a>00910             <span class="keywordflow">if</span> (isect_ret &gt;= 1) {
<a name="l00911"></a>00911                 <span class="comment">/* TODO - we may want to cache the first hit,</span>
<a name="l00912"></a>00912 <span class="comment">                 * it is not possible to swap the face order in the list anymore */</span>
<a name="l00913"></a>00913                 <span class="keywordflow">return</span> 1;
<a name="l00914"></a>00914             }
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="keywordflow">return</span> 0;
<a name="l00918"></a>00918 }
<a name="l00919"></a>00919 
<a name="l00920"></a>00920 <span class="comment">/* basic line intersection, could move to math_geom.c, 2 points with a horiz line</span>
<a name="l00921"></a>00921 <span class="comment"> * 1 for an intersection, 2 if the first point is aligned, 3 if the second point is aligned */</span>
<a name="l00922"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">00922</a> <span class="preprocessor">#define ISECT_TRUE 1</span>
<a name="l00923"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0dfddbe6def4a1f2d1aee0dc31d80f95">00923</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_TRUE_P1 2</span>
<a name="l00924"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2f7b3975729582359dd59715106b6d89">00924</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_TRUE_P2 3</span>
<a name="l00925"></a><a class="code" href="../../df/d60/paint__image_8c.html#a900db82417f8a9aae2748a6a9889096c">00925</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a900db82417f8a9aae2748a6a9889096c">line_isect_y</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> y_level, <span class="keywordtype">float</span> *x_isect)
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927     <span class="keywordtype">float</span> y_diff;
<a name="l00928"></a>00928     
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (y_level == p1[1]) { <span class="comment">/* are we touching the first point? - no interpolation needed */</span>
<a name="l00930"></a>00930         *x_isect = p1[0];
<a name="l00931"></a>00931         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0dfddbe6def4a1f2d1aee0dc31d80f95">ISECT_TRUE_P1</a>;
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (y_level == p2[1]) { <span class="comment">/* are we touching the second point? - no interpolation needed */</span>
<a name="l00934"></a>00934         *x_isect = p2[0];
<a name="l00935"></a>00935         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2f7b3975729582359dd59715106b6d89">ISECT_TRUE_P2</a>;
<a name="l00936"></a>00936     }
<a name="l00937"></a>00937     
<a name="l00938"></a>00938     y_diff = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(p1[1] - p2[1]); <span class="comment">/* yuck, horizontal line, we cant do much here */</span>
<a name="l00939"></a>00939     
<a name="l00940"></a>00940     <span class="keywordflow">if</span> (y_diff &lt; 0.000001f) {
<a name="l00941"></a>00941         *x_isect = (p1[0] + p2[0]) * 0.5f;
<a name="l00942"></a>00942         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;      
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944     
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (p1[1] &gt; y_level &amp;&amp; p2[1] &lt; y_level) {
<a name="l00946"></a>00946         *x_isect = (p2[0] * (p1[1] - y_level) + p1[0] * (y_level - p2[1])) / y_diff;  <span class="comment">/*(p1[1]-p2[1]);*/</span>
<a name="l00947"></a>00947         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;
<a name="l00948"></a>00948     }
<a name="l00949"></a>00949     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p1[1] &lt; y_level &amp;&amp; p2[1] &gt; y_level) {
<a name="l00950"></a>00950         *x_isect = (p2[0] * (y_level - p1[1]) + p1[0] * (p2[1] - y_level)) / y_diff;  <span class="comment">/*(p2[1]-p1[1]);*/</span>
<a name="l00951"></a>00951         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953     <span class="keywordflow">else</span> {
<a name="l00954"></a>00954         <span class="keywordflow">return</span> 0;
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5c66f3b2ea7b4c317b3c5d5ef5658636">00958</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5c66f3b2ea7b4c317b3c5d5ef5658636">line_isect_x</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> x_level, <span class="keywordtype">float</span> *y_isect)
<a name="l00959"></a>00959 {
<a name="l00960"></a>00960     <span class="keywordtype">float</span> x_diff;
<a name="l00961"></a>00961     
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (x_level == p1[0]) { <span class="comment">/* are we touching the first point? - no interpolation needed */</span>
<a name="l00963"></a>00963         *y_isect = p1[1];
<a name="l00964"></a>00964         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0dfddbe6def4a1f2d1aee0dc31d80f95">ISECT_TRUE_P1</a>;
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (x_level == p2[0]) { <span class="comment">/* are we touching the second point? - no interpolation needed */</span>
<a name="l00967"></a>00967         *y_isect = p2[1];
<a name="l00968"></a>00968         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2f7b3975729582359dd59715106b6d89">ISECT_TRUE_P2</a>;
<a name="l00969"></a>00969     }
<a name="l00970"></a>00970     
<a name="l00971"></a>00971     x_diff = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(p1[0] - p2[0]); <span class="comment">/* yuck, horizontal line, we cant do much here */</span>
<a name="l00972"></a>00972     
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (x_diff &lt; 0.000001f) { <span class="comment">/* yuck, vertical line, we cant do much here */</span>
<a name="l00974"></a>00974         *y_isect = (p1[0] + p2[0]) * 0.5f;
<a name="l00975"></a>00975         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;      
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977     
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (p1[0] &gt; x_level &amp;&amp; p2[0] &lt; x_level) {
<a name="l00979"></a>00979         *y_isect = (p2[1] * (p1[0] - x_level) + p1[1] * (x_level - p2[0])) / x_diff; <span class="comment">/*(p1[0]-p2[0]);*/</span>
<a name="l00980"></a>00980         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p1[0] &lt; x_level &amp;&amp; p2[0] &gt; x_level) {
<a name="l00983"></a>00983         *y_isect = (p2[1] * (x_level - p1[0]) + p1[1] * (p2[0] - x_level)) / x_diff; <span class="comment">/*(p2[0]-p1[0]);*/</span>
<a name="l00984"></a>00984         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2d60ca8374bb5451990fddea74cd47f8">ISECT_TRUE</a>;
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986     <span class="keywordflow">else</span> {
<a name="l00987"></a>00987         <span class="keywordflow">return</span> 0;
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="comment">/* simple func use for comparing UV locations to check if there are seams.</span>
<a name="l00992"></a>00992 <span class="comment"> * Its possible this gives incorrect results, when the UVs for 1 face go into the next </span>
<a name="l00993"></a>00993 <span class="comment"> * tile, but do not do this for the adjacent face, it could return a false positive.</span>
<a name="l00994"></a>00994 <span class="comment"> * This is so unlikely that Id not worry about it. */</span>
<a name="l00995"></a>00995 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l00996"></a><a class="code" href="../../df/d60/paint__image_8c.html#a366ace00123b03142fff987b2da5670e">00996</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a366ace00123b03142fff987b2da5670e">cmp_uv</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> vec2a[2], <span class="keyword">const</span> <span class="keywordtype">float</span> vec2b[2])
<a name="l00997"></a>00997 {
<a name="l00998"></a>00998     <span class="comment">/* if the UV&#39;s are not between 0.0 and 1.0 */</span>
<a name="l00999"></a>00999     <span class="keywordtype">float</span> xa = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(vec2a[0], 1.0f);
<a name="l01000"></a>01000     <span class="keywordtype">float</span> ya = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(vec2a[1], 1.0f);
<a name="l01001"></a>01001     
<a name="l01002"></a>01002     <span class="keywordtype">float</span> xb = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(vec2b[0], 1.0f);
<a name="l01003"></a>01003     <span class="keywordtype">float</span> yb = (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(vec2b[1], 1.0f);    
<a name="l01004"></a>01004     
<a name="l01005"></a>01005     <span class="keywordflow">if</span> (xa &lt; 0.0f) xa += 1.0f;
<a name="l01006"></a>01006     <span class="keywordflow">if</span> (ya &lt; 0.0f) ya += 1.0f;
<a name="l01007"></a>01007     
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (xb &lt; 0.0f) xb += 1.0f;
<a name="l01009"></a>01009     <span class="keywordflow">if</span> (yb &lt; 0.0f) yb += 1.0f;
<a name="l01010"></a>01010     
<a name="l01011"></a>01011     <span class="keywordflow">return</span> ((<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(xa - xb) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) &amp;&amp; (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(ya - yb) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>)) ? 1 : 0;
<a name="l01012"></a>01012 }
<a name="l01013"></a>01013 <span class="preprocessor">#endif</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>
<a name="l01015"></a>01015 <span class="comment">/* set min_px and max_px to the image space bounds of the UV coords </span>
<a name="l01016"></a>01016 <span class="comment"> * return zero if there is no area in the returned rectangle */</span>
<a name="l01017"></a>01017 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l01018"></a><a class="code" href="../../df/d60/paint__image_8c.html#adb17a3ea894973daf252121eaca54238">01018</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#adb17a3ea894973daf252121eaca54238">pixel_bounds_uv</a>(
<a name="l01019"></a>01019         <span class="keyword">const</span> <span class="keywordtype">float</span> uv1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> uv2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> uv3[2], <span class="keyword">const</span> <span class="keywordtype">float</span> uv4[2],
<a name="l01020"></a>01020         <a class="code" href="../../d0/d28/structrcti.html">rcti</a> *bounds_px,
<a name="l01021"></a>01021         <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_x, <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_y,
<a name="l01022"></a>01022         <span class="keywordtype">int</span> is_quad
<a name="l01023"></a>01023         )
<a name="l01024"></a>01024 {
<a name="l01025"></a>01025     <span class="keywordtype">float</span> min_uv[2], max_uv[2]; <span class="comment">/* UV bounds */</span>
<a name="l01026"></a>01026     
<a name="l01027"></a>01027     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1a74cc7bfb4a5b9eda1fb38c3fbb51c1">INIT_MINMAX2</a>(min_uv, max_uv);
<a name="l01028"></a>01028     
<a name="l01029"></a>01029     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(uv1, min_uv, max_uv);
<a name="l01030"></a>01030     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(uv2, min_uv, max_uv);
<a name="l01031"></a>01031     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(uv3, min_uv, max_uv);
<a name="l01032"></a>01032     <span class="keywordflow">if</span> (is_quad)
<a name="l01033"></a>01033         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(uv4, min_uv, max_uv);
<a name="l01034"></a>01034     
<a name="l01035"></a>01035     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = (int)(ibuf_x * min_uv[0]);
<a name="l01036"></a>01036     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = (int)(ibuf_y * min_uv[1]);
<a name="l01037"></a>01037     
<a name="l01038"></a>01038     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = (int)(ibuf_x * max_uv[0]) + 1;
<a name="l01039"></a>01039     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = (int)(ibuf_y * max_uv[1]) + 1;
<a name="l01040"></a>01040     
<a name="l01041"></a>01041     <span class="comment">/*printf(&quot;%d %d %d %d\n&quot;, min_px[0], min_px[1], max_px[0], max_px[1]);*/</span>
<a name="l01042"></a>01042     
<a name="l01043"></a>01043     <span class="comment">/* face uses no UV area when quantized to pixels? */</span>
<a name="l01044"></a>01044     <span class="keywordflow">return</span> (bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> == bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> || bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> == bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>) ? 0 : 1;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 <span class="preprocessor">#endif</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span>
<a name="l01048"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae713769b38499b668a21dbab27ff9950">01048</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae713769b38499b668a21dbab27ff9950">pixel_bounds_array</a>(<span class="keywordtype">float</span> (*uv)[2], <a class="code" href="../../d0/d28/structrcti.html">rcti</a> *bounds_px, <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_x, <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_y, <span class="keywordtype">int</span> tot)
<a name="l01049"></a>01049 {
<a name="l01050"></a>01050     <span class="keywordtype">float</span> min_uv[2], max_uv[2]; <span class="comment">/* UV bounds */</span>
<a name="l01051"></a>01051     
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (tot == 0) {
<a name="l01053"></a>01053         <span class="keywordflow">return</span> 0;
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     
<a name="l01056"></a>01056     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1a74cc7bfb4a5b9eda1fb38c3fbb51c1">INIT_MINMAX2</a>(min_uv, max_uv);
<a name="l01057"></a>01057     
<a name="l01058"></a>01058     <span class="keywordflow">while</span> (tot--) {
<a name="l01059"></a>01059         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>((*uv), min_uv, max_uv);
<a name="l01060"></a>01060         uv++;
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062     
<a name="l01063"></a>01063     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = (int)(ibuf_x * min_uv[0]);
<a name="l01064"></a>01064     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = (int)(ibuf_y * min_uv[1]);
<a name="l01065"></a>01065     
<a name="l01066"></a>01066     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = (int)(ibuf_x * max_uv[0]) + 1;
<a name="l01067"></a>01067     bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = (int)(ibuf_y * max_uv[1]) + 1;
<a name="l01068"></a>01068     
<a name="l01069"></a>01069     <span class="comment">/*printf(&quot;%d %d %d %d\n&quot;, min_px[0], min_px[1], max_px[0], max_px[1]);*/</span>
<a name="l01070"></a>01070     
<a name="l01071"></a>01071     <span class="comment">/* face uses no UV area when quantized to pixels? */</span>
<a name="l01072"></a>01072     <span class="keywordflow">return</span> (bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> == bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> || bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> == bounds_px-&gt;<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>) ? 0 : 1;
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l01076"></a>01076 <span class="preprocessor"></span>
<a name="l01077"></a>01077 <span class="comment">/* This function returns 1 if this face has a seam along the 2 face-vert indices</span>
<a name="l01078"></a>01078 <span class="comment"> * &#39;orig_i1_fidx&#39; and &#39;orig_i2_fidx&#39; */</span>
<a name="l01079"></a><a class="code" href="../../df/d60/paint__image_8c.html#a854f1d3b7855d6306014c348f193109b">01079</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a854f1d3b7855d6306014c348f193109b">check_seam</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">int</span> orig_face, <span class="keyword">const</span> <span class="keywordtype">int</span> orig_i1_fidx, <span class="keyword">const</span> <span class="keywordtype">int</span> orig_i2_fidx, <span class="keywordtype">int</span> *other_face, <span class="keywordtype">int</span> *orig_fidx)
<a name="l01080"></a>01080 {
<a name="l01081"></a>01081     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node;
<a name="l01082"></a>01082     <span class="keywordtype">int</span> face_index;
<a name="l01083"></a>01083     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i1, i2;
<a name="l01084"></a>01084     <span class="keywordtype">int</span> i1_fidx = -1, i2_fidx = -1; <span class="comment">/* index in face */</span>
<a name="l01085"></a>01085     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l01086"></a>01086     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf;
<a name="l01087"></a>01087     <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *orig_mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + orig_face;  
<a name="l01088"></a>01088     <span class="keyword">const</span> <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *orig_tf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> + orig_face;
<a name="l01089"></a>01089     
<a name="l01090"></a>01090     <span class="comment">/* vert indices from face vert order indices */</span>
<a name="l01091"></a>01091     i1 = (*(&amp;orig_mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + orig_i1_fidx));
<a name="l01092"></a>01092     i2 = (*(&amp;orig_mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + orig_i2_fidx));
<a name="l01093"></a>01093     
<a name="l01094"></a>01094     <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>[i1]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l01095"></a>01095         face_index = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="keywordflow">if</span> (face_index != orig_face) {
<a name="l01098"></a>01098             mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l01099"></a>01099             <span class="comment">/* could check if the 2 faces images match here,</span>
<a name="l01100"></a>01100 <span class="comment">             * but then there wouldn&#39;t be a way to return the opposite face&#39;s info */</span>
<a name="l01101"></a>01101             
<a name="l01102"></a>01102             
<a name="l01103"></a>01103             <span class="comment">/* We need to know the order of the verts in the adjacent face </span>
<a name="l01104"></a>01104 <span class="comment">             * set the i1_fidx and i2_fidx to (0,1,2,3) */</span>
<a name="l01105"></a>01105             <span class="keywordflow">if</span>      (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == i1) i1_fidx = 0;
<a name="l01106"></a>01106             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == i1) i1_fidx = 1;
<a name="l01107"></a>01107             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == i1) i1_fidx = 2;
<a name="l01108"></a>01108             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == i1) i1_fidx = 3;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110             <span class="keywordflow">if</span>      (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == i2) i2_fidx = 0;
<a name="l01111"></a>01111             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == i2) i2_fidx = 1;
<a name="l01112"></a>01112             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == i2) i2_fidx = 2;
<a name="l01113"></a>01113             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == i2) i2_fidx = 3;
<a name="l01114"></a>01114             
<a name="l01115"></a>01115             <span class="comment">/* Only need to check if &#39;i2_fidx&#39; is valid because we know i1_fidx is the same vert on both faces */</span>
<a name="l01116"></a>01116             <span class="keywordflow">if</span> (i2_fidx != -1) {
<a name="l01117"></a>01117                 <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, face_index);
<a name="l01118"></a>01118                 <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *orig_tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, orig_face);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                 <span class="comment">/* This IS an adjacent face!, now lets check if the UVs are ok */</span>
<a name="l01121"></a>01121                 tf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> + face_index;
<a name="l01122"></a>01122                 
<a name="l01123"></a>01123                 <span class="comment">/* set up the other face */</span>
<a name="l01124"></a>01124                 *other_face = face_index;
<a name="l01125"></a>01125                 *orig_fidx = (i1_fidx &lt; i2_fidx) ? i1_fidx : i2_fidx;
<a name="l01126"></a>01126                 
<a name="l01127"></a>01127                 <span class="comment">/* first test if they have the same image */</span>
<a name="l01128"></a>01128                 <span class="keywordflow">if</span> ((orig_tpage == tpage) &amp;&amp;
<a name="l01129"></a>01129                     <a class="code" href="../../df/d60/paint__image_8c.html#a366ace00123b03142fff987b2da5670e">cmp_uv</a>(orig_tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[orig_i1_fidx], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[i1_fidx]) &amp;&amp;
<a name="l01130"></a>01130                     <a class="code" href="../../df/d60/paint__image_8c.html#a366ace00123b03142fff987b2da5670e">cmp_uv</a>(orig_tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[orig_i2_fidx], tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[i2_fidx]) )
<a name="l01131"></a>01131                 {
<a name="l01132"></a>01132                     <span class="comment">// printf(&quot;SEAM (NONE)\n&quot;);</span>
<a name="l01133"></a>01133                     <span class="keywordflow">return</span> 0;
<a name="l01134"></a>01134                     
<a name="l01135"></a>01135                 }
<a name="l01136"></a>01136                 <span class="keywordflow">else</span> {
<a name="l01137"></a>01137                     <span class="comment">// printf(&quot;SEAM (UV GAP)\n&quot;);</span>
<a name="l01138"></a>01138                     <span class="keywordflow">return</span> 1;
<a name="l01139"></a>01139                 }
<a name="l01140"></a>01140             }
<a name="l01141"></a>01141         }
<a name="l01142"></a>01142     }
<a name="l01143"></a>01143     <span class="comment">// printf(&quot;SEAM (NO FACE)\n&quot;);</span>
<a name="l01144"></a>01144     *other_face = -1;
<a name="l01145"></a>01145     <span class="keywordflow">return</span> 1;
<a name="l01146"></a>01146 }
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 <span class="comment">/* Calculate outset UV&#39;s, this is not the same as simply scaling the UVs,</span>
<a name="l01149"></a>01149 <span class="comment"> * since the outset coords are a margin that keep an even distance from the original UV&#39;s,</span>
<a name="l01150"></a>01150 <span class="comment"> * note that the image aspect is taken into account */</span>
<a name="l01151"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5cff554eefd5ffdf8c5aa8330d6a1099">01151</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5cff554eefd5ffdf8c5aa8330d6a1099">uv_image_outset</a>(<span class="keywordtype">float</span> (*orig_uv)[2], <span class="keywordtype">float</span> (*outset_uv)[2], <span class="keyword">const</span> <span class="keywordtype">float</span> scaler, <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_x, <span class="keyword">const</span> <span class="keywordtype">int</span> ibuf_y, <span class="keyword">const</span> <span class="keywordtype">int</span> is_quad)
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     <span class="keywordtype">float</span> a1, a2, a3, a4 = 0.0f;
<a name="l01154"></a>01154     <span class="keywordtype">float</span> puv[4][2]; <span class="comment">/* pixelspace uv&#39;s */</span>
<a name="l01155"></a>01155     <span class="keywordtype">float</span> no1[2], no2[2], no3[2], no4[2]; <span class="comment">/* normals */</span>
<a name="l01156"></a>01156     <span class="keywordtype">float</span> dir1[2], dir2[2], dir3[2], dir4[2];
<a name="l01157"></a>01157     <span class="keywordtype">float</span> ibuf_inv[2];
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     ibuf_inv[0] = 1.0f / (float)ibuf_x;
<a name="l01160"></a>01160     ibuf_inv[1] = 1.0f / (float)ibuf_y;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     <span class="comment">/* make UV&#39;s in pixel space so we can */</span>
<a name="l01163"></a>01163     puv[0][0] = orig_uv[0][0] * ibuf_x;
<a name="l01164"></a>01164     puv[0][1] = orig_uv[0][1] * ibuf_y;
<a name="l01165"></a>01165     
<a name="l01166"></a>01166     puv[1][0] = orig_uv[1][0] * ibuf_x;
<a name="l01167"></a>01167     puv[1][1] = orig_uv[1][1] * ibuf_y;
<a name="l01168"></a>01168     
<a name="l01169"></a>01169     puv[2][0] = orig_uv[2][0] * ibuf_x;
<a name="l01170"></a>01170     puv[2][1] = orig_uv[2][1] * ibuf_y;
<a name="l01171"></a>01171     
<a name="l01172"></a>01172     <span class="keywordflow">if</span> (is_quad) {
<a name="l01173"></a>01173         puv[3][0] = orig_uv[3][0] * ibuf_x;
<a name="l01174"></a>01174         puv[3][1] = orig_uv[3][1] * ibuf_y;
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176     
<a name="l01177"></a>01177     <span class="comment">/* face edge directions */</span>
<a name="l01178"></a>01178     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dir1, puv[1], puv[0]);
<a name="l01179"></a>01179     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dir2, puv[2], puv[1]);
<a name="l01180"></a>01180     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dir1);
<a name="l01181"></a>01181     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dir2);
<a name="l01182"></a>01182     
<a name="l01183"></a>01183     <span class="keywordflow">if</span> (is_quad) {
<a name="l01184"></a>01184         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dir3, puv[3], puv[2]);
<a name="l01185"></a>01185         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dir4, puv[0], puv[3]);
<a name="l01186"></a>01186         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dir3);
<a name="l01187"></a>01187         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dir4);
<a name="l01188"></a>01188     }
<a name="l01189"></a>01189     <span class="keywordflow">else</span> {
<a name="l01190"></a>01190         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(dir3, puv[0], puv[2]);
<a name="l01191"></a>01191         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(dir3);
<a name="l01192"></a>01192     }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="comment">/* TODO - angle_normalized_v2v2(...) * (M_PI/180.0f)</span>
<a name="l01195"></a>01195 <span class="comment">     * This is incorrect. Its already given radians but without it wont work.</span>
<a name="l01196"></a>01196 <span class="comment">     * need to look into a fix - campbell */</span>
<a name="l01197"></a>01197     <span class="keywordflow">if</span> (is_quad) {
<a name="l01198"></a>01198         a1 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir4, dir1) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01199"></a>01199         a2 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir1, dir2) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01200"></a>01200         a3 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir2, dir3) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01201"></a>01201         a4 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir3, dir4) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203     <span class="keywordflow">else</span> {
<a name="l01204"></a>01204         a1 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir3, dir1) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01205"></a>01205         a2 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir1, dir2) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01206"></a>01206         a3 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac8c51c432aaaf45dc0328f51dfb8cbfb">shell_angle_to_dist</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adaaaa1a69f74fb11be126f4388ec8aa3">angle_normalized_v2v2</a>(dir2, dir3) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180.0f));
<a name="l01207"></a>01207     }
<a name="l01208"></a>01208     
<a name="l01209"></a>01209     <span class="keywordflow">if</span> (is_quad) {
<a name="l01210"></a>01210         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no1, dir4, dir1);
<a name="l01211"></a>01211         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no2, dir1, dir2);
<a name="l01212"></a>01212         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no3, dir2, dir3);
<a name="l01213"></a>01213         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no4, dir3, dir4);
<a name="l01214"></a>01214         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no1);
<a name="l01215"></a>01215         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no2);
<a name="l01216"></a>01216         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no3);
<a name="l01217"></a>01217         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no4);
<a name="l01218"></a>01218         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no1, a1 * scaler);
<a name="l01219"></a>01219         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no2, a2 * scaler);
<a name="l01220"></a>01220         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no3, a3 * scaler);
<a name="l01221"></a>01221         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no4, a4 * scaler);
<a name="l01222"></a>01222         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[0], puv[0], no1);
<a name="l01223"></a>01223         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[1], puv[1], no2);
<a name="l01224"></a>01224         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[2], puv[2], no3);
<a name="l01225"></a>01225         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[3], puv[3], no4);
<a name="l01226"></a>01226         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[0], ibuf_inv);
<a name="l01227"></a>01227         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[1], ibuf_inv);
<a name="l01228"></a>01228         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[2], ibuf_inv);
<a name="l01229"></a>01229         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[3], ibuf_inv);
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231     <span class="keywordflow">else</span> {
<a name="l01232"></a>01232         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no1, dir3, dir1);
<a name="l01233"></a>01233         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no2, dir1, dir2);
<a name="l01234"></a>01234         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(no3, dir2, dir3);
<a name="l01235"></a>01235         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no1);
<a name="l01236"></a>01236         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no2);
<a name="l01237"></a>01237         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad56c6a83e4d51efce2881bb484c50221">normalize_v2</a>(no3);
<a name="l01238"></a>01238         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no1, a1 * scaler);
<a name="l01239"></a>01239         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no2, a2 * scaler);
<a name="l01240"></a>01240         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(no3, a3 * scaler);
<a name="l01241"></a>01241         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[0], puv[0], no1);
<a name="l01242"></a>01242         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[1], puv[1], no2);
<a name="l01243"></a>01243         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab0531c46b21fcaa3131042050865ecee">add_v2_v2v2</a>(outset_uv[2], puv[2], no3);
<a name="l01244"></a>01244 
<a name="l01245"></a>01245         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[0], ibuf_inv);
<a name="l01246"></a>01246         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[1], ibuf_inv);
<a name="l01247"></a>01247         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4ac9c4e152361594ce2ac66d0080e0a8">mul_v2_v2</a>(outset_uv[2], ibuf_inv);
<a name="l01248"></a>01248     }
<a name="l01249"></a>01249 }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 <span class="comment">/* </span>
<a name="l01252"></a>01252 <span class="comment"> * Be tricky with flags, first 4 bits are PROJ_FACE_SEAM1 to 4, last 4 bits are PROJ_FACE_NOSEAM1 to 4</span>
<a name="l01253"></a>01253 <span class="comment"> * 1&lt;&lt;i - where i is (0-3) </span>
<a name="l01254"></a>01254 <span class="comment"> * </span>
<a name="l01255"></a>01255 <span class="comment"> * If we&#39;re multithreadng, make sure threads are locked when this is called</span>
<a name="l01256"></a>01256 <span class="comment"> */</span>
<a name="l01257"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6ef668f719dcc5a1cf7d5b40f5138182">01257</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6ef668f719dcc5a1cf7d5b40f5138182">project_face_seams_init</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">int</span> is_quad)
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259     <span class="keywordtype">int</span> other_face, other_fidx; <span class="comment">/* vars for the other face, we also set its flag */</span>
<a name="l01260"></a>01260     <span class="keywordtype">int</span> fidx1 = is_quad ? 3 : 2;
<a name="l01261"></a>01261     <span class="keywordtype">int</span> fidx2 = 0; <span class="comment">/* next fidx in the face (0,1,2,3) -&gt; (1,2,3,0) or (0,1,2) -&gt; (1,2,0) for a tri */</span>
<a name="l01262"></a>01262     
<a name="l01263"></a>01263     <span class="keywordflow">do</span> {
<a name="l01264"></a>01264         <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index] &amp; (1 &lt;&lt; fidx1 | 16 &lt;&lt; fidx1)) == 0) {
<a name="l01265"></a>01265             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a854f1d3b7855d6306014c348f193109b">check_seam</a>(ps, face_index, fidx1, fidx2, &amp;other_face, &amp;other_fidx)) {
<a name="l01266"></a>01266                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index] |= 1 &lt;&lt; fidx1;
<a name="l01267"></a>01267                 <span class="keywordflow">if</span> (other_face != -1)
<a name="l01268"></a>01268                     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[other_face] |= 1 &lt;&lt; other_fidx;
<a name="l01269"></a>01269             }
<a name="l01270"></a>01270             <span class="keywordflow">else</span> {
<a name="l01271"></a>01271                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index] |= 16 &lt;&lt; fidx1;
<a name="l01272"></a>01272                 <span class="keywordflow">if</span> (other_face != -1)
<a name="l01273"></a>01273                     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[other_face] |= 16 &lt;&lt; other_fidx;  <span class="comment">/* second 4 bits for disabled */</span>
<a name="l01274"></a>01274             }
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276         
<a name="l01277"></a>01277         fidx2 = fidx1;
<a name="l01278"></a>01278     } <span class="keywordflow">while</span> (fidx1--);
<a name="l01279"></a>01279 }
<a name="l01280"></a>01280 <span class="preprocessor">#endif // PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span>
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="comment">/* Converts a UV location to a 3D screenspace location</span>
<a name="l01284"></a>01284 <span class="comment"> * Takes a &#39;uv&#39; and 3 UV coords, and sets the values of pixelScreenCo</span>
<a name="l01285"></a>01285 <span class="comment"> * </span>
<a name="l01286"></a>01286 <span class="comment"> * This is used for finding a pixels location in screenspace for painting */</span>
<a name="l01287"></a><a class="code" href="../../df/d60/paint__image_8c.html#aa9ce010ae6b5da33479b684e54ff40d0">01287</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#aa9ce010ae6b5da33479b684e54ff40d0">screen_px_from_ortho</a>(
<a name="l01288"></a>01288         <span class="keywordtype">float</span> uv[2],
<a name="l01289"></a>01289         <span class="keywordtype">float</span> v1co[3], <span class="keywordtype">float</span> v2co[3], <span class="keywordtype">float</span> v3co[3],  <span class="comment">/* Screenspace coords */</span>
<a name="l01290"></a>01290         <span class="keywordtype">float</span> uv1co[2], <span class="keywordtype">float</span> uv2co[2], <span class="keywordtype">float</span> uv3co[2],
<a name="l01291"></a>01291         <span class="keywordtype">float</span> pixelScreenCo[4],
<a name="l01292"></a>01292         <span class="keywordtype">float</span> w[3])
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(uv1co, uv2co, uv3co, uv, w);
<a name="l01295"></a>01295     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(pixelScreenCo, v1co, v2co, v3co, w);
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 <span class="comment">/* same as screen_px_from_ortho except we need to take into account</span>
<a name="l01299"></a>01299 <span class="comment"> * the perspective W coord for each vert */</span>
<a name="l01300"></a><a class="code" href="../../df/d60/paint__image_8c.html#a78b908f9c929285c9ef5dd923cc8486f">01300</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a78b908f9c929285c9ef5dd923cc8486f">screen_px_from_persp</a>(
<a name="l01301"></a>01301         <span class="keywordtype">float</span> uv[2],
<a name="l01302"></a>01302         <span class="keywordtype">float</span> v1co[4], <span class="keywordtype">float</span> v2co[4], <span class="keywordtype">float</span> v3co[4],  <span class="comment">/* screenspace coords */</span>
<a name="l01303"></a>01303         <span class="keywordtype">float</span> uv1co[2], <span class="keywordtype">float</span> uv2co[2], <span class="keywordtype">float</span> uv3co[2],
<a name="l01304"></a>01304         <span class="keywordtype">float</span> pixelScreenCo[4],
<a name="l01305"></a>01305         <span class="keywordtype">float</span> w[3])
<a name="l01306"></a>01306 {
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="keywordtype">float</span> wtot_inv, wtot;
<a name="l01309"></a>01309     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(uv1co, uv2co, uv3co, uv, w);
<a name="l01310"></a>01310     
<a name="l01311"></a>01311     <span class="comment">/* re-weight from the 4th coord of each screen vert */</span>
<a name="l01312"></a>01312     w[0] *= v1co[3];
<a name="l01313"></a>01313     w[1] *= v2co[3];
<a name="l01314"></a>01314     w[2] *= v3co[3];
<a name="l01315"></a>01315     
<a name="l01316"></a>01316     wtot = w[0] + w[1] + w[2];
<a name="l01317"></a>01317     
<a name="l01318"></a>01318     <span class="keywordflow">if</span> (wtot &gt; 0.0f) {
<a name="l01319"></a>01319         wtot_inv = 1.0f / wtot;
<a name="l01320"></a>01320         w[0] *= wtot_inv;
<a name="l01321"></a>01321         w[1] *= wtot_inv;
<a name="l01322"></a>01322         w[2] *= wtot_inv;
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324     <span class="keywordflow">else</span> {
<a name="l01325"></a>01325         w[0] = w[1] = w[2] = 1.0f / 3.0f;  <span class="comment">/* dummy values for zero area face */</span>
<a name="l01326"></a>01326     }
<a name="l01327"></a>01327     <span class="comment">/* done re-weighting */</span>
<a name="l01328"></a>01328     
<a name="l01329"></a>01329     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(pixelScreenCo, v1co, v2co, v3co, w);
<a name="l01330"></a>01330 }
<a name="l01331"></a>01331 
<a name="l01332"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">01332</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(<span class="keyword">const</span> <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf_other, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf_other, <span class="keyword">const</span> <span class="keywordtype">float</span> w[3], <span class="keywordtype">int</span> side, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_ub[4], <span class="keywordtype">float</span> rgba_f[4])
<a name="l01333"></a>01333 {
<a name="l01334"></a>01334     <span class="keywordtype">float</span> *uvCo1, *uvCo2, *uvCo3;
<a name="l01335"></a>01335     <span class="keywordtype">float</span> uv_other[2], <a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>, <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>;
<a name="l01336"></a>01336     
<a name="l01337"></a>01337     uvCo1 =  (<span class="keywordtype">float</span> *)tf_other-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0];
<a name="l01338"></a>01338     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (side == 1) {
<a name="l01339"></a>01339         uvCo2 =  (<span class="keywordtype">float</span> *)tf_other-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l01340"></a>01340         uvCo3 =  (<span class="keywordtype">float</span> *)tf_other-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3];
<a name="l01341"></a>01341     }
<a name="l01342"></a>01342     <span class="keywordflow">else</span> {
<a name="l01343"></a>01343         uvCo2 =  (<span class="keywordtype">float</span> *)tf_other-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1];
<a name="l01344"></a>01344         uvCo3 =  (<span class="keywordtype">float</span> *)tf_other-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346     
<a name="l01347"></a>01347     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(uv_other, uvCo1, uvCo2, uvCo3, (<span class="keywordtype">float</span> *)w);
<a name="l01348"></a>01348     
<a name="l01349"></a>01349     <span class="comment">/* use */</span>
<a name="l01350"></a>01350     <a class="code" href="../../df/d60/paint__image_8c.html#a6d67ec6342a242a0d07887a248b2b43e">uvco_to_wrapped_pxco</a>(uv_other, ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, &amp;x, &amp;y);
<a name="l01351"></a>01351     
<a name="l01352"></a>01352     
<a name="l01353"></a>01353     <span class="keywordflow">if</span> (ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) { <span class="comment">/* from float to float */</span>
<a name="l01354"></a>01354         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf_other, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rgba_f, x, y);
<a name="l01355"></a>01355     }
<a name="l01356"></a>01356     <span class="keywordflow">else</span> { <span class="comment">/* from char to float */</span>
<a name="l01357"></a>01357         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ac79fde1f1caffa48e22a1ed3318b74f9">bilinear_interpolation_color_wrap</a>(ibuf_other, rgba_ub, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, x, y);
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359         
<a name="l01360"></a>01360 }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 <span class="comment">/* run this outside project_paint_uvpixel_init since pixels with mask 0 don&#39;t need init */</span>
<a name="l01363"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3fe8683e840d2767a3f4a7cfe22efe4d">01363</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3fe8683e840d2767a3f4a7cfe22efe4d">project_paint_uvpixel_mask</a>(
<a name="l01364"></a>01364         <span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps,
<a name="l01365"></a>01365         <span class="keyword">const</span> <span class="keywordtype">int</span> face_index,
<a name="l01366"></a>01366         <span class="keyword">const</span> <span class="keywordtype">int</span> side,
<a name="l01367"></a>01367         <span class="keyword">const</span> <span class="keywordtype">float</span> w[3])
<a name="l01368"></a>01368 {
<a name="l01369"></a>01369     <span class="keywordtype">float</span> mask;
<a name="l01370"></a>01370     
<a name="l01371"></a>01371     <span class="comment">/* Image Mask */</span>
<a name="l01372"></a>01372     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">do_layer_stencil</a>) {
<a name="l01373"></a>01373         <span class="comment">/* another UV maps image is masking this one&#39;s */</span>
<a name="l01374"></a>01374         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf_other;
<a name="l01375"></a>01375         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *other_tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a>, face_index);
<a name="l01376"></a>01376         <span class="keyword">const</span> <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf_other = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> + face_index;
<a name="l01377"></a>01377         
<a name="l01378"></a>01378         <span class="keywordflow">if</span> (other_tpage &amp;&amp; (ibuf_other = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(other_tpage, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l01379"></a>01379             <span class="comment">/* BKE_image_get_ibuf - TODO - this may be slow */</span>
<a name="l01380"></a>01380             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_ub[4];
<a name="l01381"></a>01381             <span class="keywordtype">float</span> rgba_f[4];
<a name="l01382"></a>01382             
<a name="l01383"></a>01383             <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(tf_other, ibuf_other, w, side, rgba_ub, rgba_f);
<a name="l01384"></a>01384             
<a name="l01385"></a>01385             <span class="keywordflow">if</span> (ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) { <span class="comment">/* from float to float */</span>
<a name="l01386"></a>01386                 mask = ((rgba_f[0] + rgba_f[1] + rgba_f[2]) / 3.0f) * rgba_f[3];
<a name="l01387"></a>01387             }
<a name="l01388"></a>01388             <span class="keywordflow">else</span> { <span class="comment">/* from char to float */</span>
<a name="l01389"></a>01389                 mask = ((rgba_ub[0] + rgba_ub[1] + rgba_ub[2]) / (256 * 3.0f)) * (rgba_ub[3] / 256.0f);
<a name="l01390"></a>01390             }
<a name="l01391"></a>01391             
<a name="l01392"></a>01392             <span class="keywordflow">if</span> (!ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa9c804d1f7bf7c7c1c9cf86d3167035">do_layer_stencil_inv</a>) <span class="comment">/* matching the gimps layer mask black/white rules, white==full opacity */</span>
<a name="l01393"></a>01393                 mask = (1.0f - mask);
<a name="l01394"></a>01394 
<a name="l01395"></a>01395             <span class="keywordflow">if</span> (mask == 0.0f) {
<a name="l01396"></a>01396                 <span class="keywordflow">return</span> 0.0f;
<a name="l01397"></a>01397             }
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399         <span class="keywordflow">else</span> {
<a name="l01400"></a>01400             <span class="keywordflow">return</span> 0.0f;
<a name="l01401"></a>01401         }
<a name="l01402"></a>01402     }
<a name="l01403"></a>01403     <span class="keywordflow">else</span> {
<a name="l01404"></a>01404         mask = 1.0f;
<a name="l01405"></a>01405     }
<a name="l01406"></a>01406     
<a name="l01407"></a>01407     <span class="comment">/* calculate mask */</span>
<a name="l01408"></a>01408     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a>) {
<a name="l01409"></a>01409         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l01410"></a>01410         <span class="keywordtype">short</span> *no1, *no2, *no3;
<a name="l01411"></a>01411         <span class="keywordtype">float</span> no[3], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l01412"></a>01412         no1 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l01413"></a>01413         <span class="keywordflow">if</span> (side == 1) {
<a name="l01414"></a>01414             no2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l01415"></a>01415             no3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l01416"></a>01416         }
<a name="l01417"></a>01417         <span class="keywordflow">else</span> {
<a name="l01418"></a>01418             no2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l01419"></a>01419             no3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>;
<a name="l01420"></a>01420         }
<a name="l01421"></a>01421         
<a name="l01422"></a>01422         no[0] = w[0] * no1[0] + w[1] * no2[0] + w[2] * no3[0];
<a name="l01423"></a>01423         no[1] = w[0] * no1[1] + w[1] * no2[1] + w[2] * no3[1];
<a name="l01424"></a>01424         no[2] = w[0] * no1[2] + w[1] * no2[2] + w[2] * no3[2];
<a name="l01425"></a>01425         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(no);
<a name="l01426"></a>01426         
<a name="l01427"></a>01427         <span class="comment">/* now we can use the normal as a mask */</span>
<a name="l01428"></a>01428         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) {
<a name="l01429"></a>01429             angle = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4a2003033c639cab3de101b1cfe7a595">angle_normalized_v3v3</a>((<span class="keywordtype">float</span> *)ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>, no);
<a name="l01430"></a>01430         }
<a name="l01431"></a>01431         <span class="keywordflow">else</span> {
<a name="l01432"></a>01432             <span class="comment">/* Annoying but for the perspective view we need to get the pixels location in 3D space :/ */</span>
<a name="l01433"></a>01433             <span class="keywordtype">float</span> viewDirPersp[3];
<a name="l01434"></a>01434             <span class="keywordtype">float</span> *co1, *co2, *co3;
<a name="l01435"></a>01435             co1 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01436"></a>01436             <span class="keywordflow">if</span> (side == 1) {
<a name="l01437"></a>01437                 co2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01438"></a>01438                 co3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01439"></a>01439             }
<a name="l01440"></a>01440             <span class="keywordflow">else</span> {
<a name="l01441"></a>01441                 co2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01442"></a>01442                 co3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01443"></a>01443             }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445             <span class="comment">/* Get the direction from the viewPoint to the pixel and normalize */</span>
<a name="l01446"></a>01446             viewDirPersp[0] = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>[0] - (w[0] * co1[0] + w[1] * co2[0] + w[2] * co3[0]));
<a name="l01447"></a>01447             viewDirPersp[1] = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>[1] - (w[0] * co1[1] + w[1] * co2[1] + w[2] * co3[1]));
<a name="l01448"></a>01448             viewDirPersp[2] = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>[2] - (w[0] * co1[2] + w[1] * co2[2] + w[2] * co3[2]));
<a name="l01449"></a>01449             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(viewDirPersp);
<a name="l01450"></a>01450             
<a name="l01451"></a>01451             angle = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4a2003033c639cab3de101b1cfe7a595">angle_normalized_v3v3</a>(viewDirPersp, no);
<a name="l01452"></a>01452         }
<a name="l01453"></a>01453         
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (angle &gt;= ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a>) {
<a name="l01455"></a>01455             <span class="keywordflow">return</span> 0.0f; <span class="comment">/* outsize the normal limit*/</span>
<a name="l01456"></a>01456         }
<a name="l01457"></a>01457         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a>) {
<a name="l01458"></a>01458             mask *= (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a> - <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d2c975c51ef4c7c41cbe8f20f4ca172">normal_angle_range</a>;
<a name="l01459"></a>01459         } <span class="comment">/* otherwise no mask normal is needed, were within the limit */</span>
<a name="l01460"></a>01460     }
<a name="l01461"></a>01461     
<a name="l01462"></a>01462     <span class="comment">// This only works when the opacity dosnt change while painting, stylus pressure messes with this</span>
<a name="l01463"></a>01463     <span class="comment">// so don&#39;t use it.</span>
<a name="l01464"></a>01464     <span class="comment">// if (ps-&gt;is_airbrush==0) mask *= brush_alpha(ps-&gt;brush);</span>
<a name="l01465"></a>01465     
<a name="l01466"></a>01466     <span class="keywordflow">return</span> mask;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="comment">/* run this function when we know a bucket&#39;s, face&#39;s pixel can be initialized,</span>
<a name="l01470"></a>01470 <span class="comment"> * return the ProjPixel which is added to &#39;ps-&gt;bucketRect[bucket_index]&#39; */</span>
<a name="l01471"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2ce0eb39a3c0adde977984143144630b">01471</a> <span class="keyword">static</span> <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *<a class="code" href="../../df/d60/paint__image_8c.html#a2ce0eb39a3c0adde977984143144630b">project_paint_uvpixel_init</a>(
<a name="l01472"></a>01472         <span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps,
<a name="l01473"></a>01473         <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena,
<a name="l01474"></a>01474         <span class="keyword">const</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf,
<a name="l01475"></a>01475         <span class="keywordtype">short</span> x_px, <span class="keywordtype">short</span> y_px,
<a name="l01476"></a>01476         <span class="keyword">const</span> <span class="keywordtype">float</span> mask,
<a name="l01477"></a>01477         <span class="keyword">const</span> <span class="keywordtype">int</span> face_index,
<a name="l01478"></a>01478         <span class="keyword">const</span> <span class="keywordtype">int</span> image_index,
<a name="l01479"></a>01479         <span class="keyword">const</span> <span class="keywordtype">float</span> pixelScreenCo[4],
<a name="l01480"></a>01480         <span class="keyword">const</span> <span class="keywordtype">int</span> side,
<a name="l01481"></a>01481         <span class="keyword">const</span> <span class="keywordtype">float</span> w[3])
<a name="l01482"></a>01482 {
<a name="l01483"></a>01483     <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel;
<a name="l01484"></a>01484     <span class="keywordtype">short</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01485"></a>01485     
<a name="l01486"></a>01486     <span class="comment">/* wrap pixel location */</span>
<a name="l01487"></a>01487     x_px = x_px % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (x_px &lt; 0) x_px += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01489"></a>01489     y_px = y_px % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01490"></a>01490     <span class="keywordflow">if</span> (y_px &lt; 0) y_px += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01491"></a>01491     
<a name="l01492"></a>01492     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>) {
<a name="l01493"></a>01493         size = <span class="keyword">sizeof</span>(<a class="code" href="../../df/d60/paint__image_8c.html#a33097a6fe86e5d9027de8599a0cb1c2c">ProjPixelClone</a>);
<a name="l01494"></a>01494     }
<a name="l01495"></a>01495     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa2144bb61a8ed41729a963353f30cab">PAINT_TOOL_SMEAR</a>) {
<a name="l01496"></a>01496         size = <span class="keyword">sizeof</span>(<a class="code" href="../../df/d60/paint__image_8c.html#a33097a6fe86e5d9027de8599a0cb1c2c">ProjPixelClone</a>);
<a name="l01497"></a>01497     }
<a name="l01498"></a>01498     <span class="keywordflow">else</span> {
<a name="l01499"></a>01499         size = <span class="keyword">sizeof</span>(<a class="code" href="../../df/d60/paint__image_8c.html#aaf0c0ca859e4a2d91c3f687c16692061">ProjPixel</a>);
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501     
<a name="l01502"></a>01502     projPixel = (<a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *)<a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, size);
<a name="l01503"></a>01503     <span class="comment">//memset(projPixel, 0, size);</span>
<a name="l01504"></a>01504     
<a name="l01505"></a>01505     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01506"></a>01506         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a> = (<span class="keywordtype">float</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + ((x_px + y_px * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * 4);
<a name="l01507"></a>01507         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[0] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[0] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[0];  
<a name="l01508"></a>01508         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[1] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[1] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[1];  
<a name="l01509"></a>01509         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[2] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[2] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[2];  
<a name="l01510"></a>01510         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[3] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[3] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[3];  
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512     <span class="keywordflow">else</span> {
<a name="l01513"></a>01513         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a> = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + ((x_px + y_px * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * 4));
<a name="l01514"></a>01514         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a> = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a> = *projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a>;
<a name="l01515"></a>01515     }
<a name="l01516"></a>01516     
<a name="l01517"></a>01517     <span class="comment">/* screenspace unclamped, we could keep its z and w values but don&#39;t need them at the moment */</span>
<a name="l01518"></a>01518     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>, pixelScreenCo);
<a name="l01519"></a>01519     
<a name="l01520"></a>01520     projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a> = x_px;
<a name="l01521"></a>01521     projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a> = y_px;
<a name="l01522"></a>01522     
<a name="l01523"></a>01523     projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">mask</a> = (<span class="keywordtype">unsigned</span> short)(mask * 65535);
<a name="l01524"></a>01524     projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1c6fe91a1523482d4efd421dacf319b3">mask_max</a> = 0;
<a name="l01525"></a>01525     
<a name="l01526"></a>01526     <span class="comment">/* which bounding box cell are we in?, needed for undo */</span>
<a name="l01527"></a>01527     projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ace733fd9deb93129e05540104c3e375f">bb_cell_index</a> = ((int)(((<span class="keywordtype">float</span>)x_px / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#a33024fffec7f039a87563af02b910506">PROJ_BOUNDBOX_DIV</a>)) +
<a name="l01528"></a>01528                                ((int)(((<span class="keywordtype">float</span>)y_px / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#a33024fffec7f039a87563af02b910506">PROJ_BOUNDBOX_DIV</a>)) * <a class="code" href="../../df/d60/paint__image_8c.html#a33024fffec7f039a87563af02b910506">PROJ_BOUNDBOX_DIV</a>;
<a name="l01529"></a>01529     
<a name="l01530"></a>01530     <span class="comment">/* done with view3d_project_float inline */</span>
<a name="l01531"></a>01531     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>) {
<a name="l01532"></a>01532         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>) {
<a name="l01533"></a>01533             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf_other;
<a name="l01534"></a>01534             <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *other_tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>, face_index);
<a name="l01535"></a>01535             <span class="keyword">const</span> <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf_other = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> + face_index;
<a name="l01536"></a>01536             
<a name="l01537"></a>01537             <span class="keywordflow">if</span> (other_tpage &amp;&amp; (ibuf_other = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(other_tpage, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l01538"></a>01538                 <span class="comment">/* BKE_image_get_ibuf - TODO - this may be slow */</span>
<a name="l01539"></a>01539                 
<a name="l01540"></a>01540                 <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01541"></a>01541                     <span class="keywordflow">if</span> (ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) { <span class="comment">/* from float to float */</span>
<a name="l01542"></a>01542                         <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(tf_other, ibuf_other, w, side, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f);
<a name="l01543"></a>01543                     }
<a name="l01544"></a>01544                     <span class="keywordflow">else</span> { <span class="comment">/* from char to float */</span>
<a name="l01545"></a>01545                         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_ub[4];
<a name="l01546"></a>01546                         <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(tf_other, ibuf_other, w, side, rgba_ub, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01547"></a>01547                         <a class="code" href="../../df/d60/paint__image_8c.html#ab64a89eb73f6bf7f5f66ff9283e2a674">IMAPAINT_CHAR_RGBA_TO_FLOAT</a>(((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f, rgba_ub);
<a name="l01548"></a>01548                     }
<a name="l01549"></a>01549                 }
<a name="l01550"></a>01550                 <span class="keywordflow">else</span> {
<a name="l01551"></a>01551                     <span class="keywordflow">if</span> (ibuf_other-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) { <span class="comment">/* float to char */</span>
<a name="l01552"></a>01552                         <span class="keywordtype">float</span> rgba[4];
<a name="l01553"></a>01553                         <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(tf_other, ibuf_other, w, side, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rgba);
<a name="l01554"></a>01554                         <a class="code" href="../../df/d60/paint__image_8c.html#a74558eb5d272e225b52223c7b2f9ac21">IMAPAINT_FLOAT_RGBA_TO_CHAR</a>(((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch, rgba)
<a name="l01555"></a>01555                     }
<a name="l01556"></a>01556                     <span class="keywordflow">else</span> { <span class="comment">/* char to char */</span>
<a name="l01557"></a>01557                         <a class="code" href="../../df/d60/paint__image_8c.html#a3a00b066ddfa6627f6302f832f9755e5">project_face_pixel</a>(tf_other, ibuf_other, w, side, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01558"></a>01558                     }
<a name="l01559"></a>01559                 }
<a name="l01560"></a>01560             }
<a name="l01561"></a>01561             <span class="keywordflow">else</span> {
<a name="l01562"></a>01562                 <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01563"></a>01563                     ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f[3] = 0;
<a name="l01564"></a>01564                 }
<a name="l01565"></a>01565                 <span class="keywordflow">else</span> {
<a name="l01566"></a>01566                     ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch[3] = 0;
<a name="l01567"></a>01567                 }
<a name="l01568"></a>01568             }
<a name="l01569"></a>01569             
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571         <span class="keywordflow">else</span> {
<a name="l01572"></a>01572             <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2];
<a name="l01573"></a>01573             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(co, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>, (<span class="keywordtype">float</span> *)ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aff1f5b2976a49764aa85c89cf1d528f5">cloneOffset</a>);
<a name="l01574"></a>01574             
<a name="l01575"></a>01575             <span class="comment">/* no need to initialize the bucket, we&#39;re only checking buckets faces and for this</span>
<a name="l01576"></a>01576 <span class="comment">             * the faces are already initialized in project_paint_delayed_face_init(...) */</span>
<a name="l01577"></a>01577             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01578"></a>01578                 <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">project_paint_PickColor</a>(ps, co, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1)) {
<a name="l01579"></a>01579                     ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f[3] = 0; <span class="comment">/* zero alpha - ignore */</span>
<a name="l01580"></a>01580                 }
<a name="l01581"></a>01581             }
<a name="l01582"></a>01582             <span class="keywordflow">else</span> {
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">project_paint_PickColor</a>(ps, co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch, 1)) {
<a name="l01584"></a>01584                     ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch[3] = 0; <span class="comment">/* zero alpha - ignore */</span>
<a name="l01585"></a>01585                 }
<a name="l01586"></a>01586             }
<a name="l01587"></a>01587         }
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589     
<a name="l01590"></a>01590 <span class="preprocessor">#ifdef PROJ_DEBUG_PAINT</span>
<a name="l01591"></a>01591 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[0] = 0;
<a name="l01592"></a>01592     <span class="keywordflow">else</span>                  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a>[0] = 0;
<a name="l01593"></a>01593 <span class="preprocessor">#endif</span>
<a name="l01594"></a>01594 <span class="preprocessor"></span>    projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a> = image_index;
<a name="l01595"></a>01595     
<a name="l01596"></a>01596     <span class="keywordflow">return</span> projPixel;
<a name="l01597"></a>01597 }
<a name="l01598"></a>01598 
<a name="l01599"></a><a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">01599</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">line_clip_rect2f</a>(
<a name="l01600"></a>01600         <a class="code" href="../../da/d10/structrctf.html">rctf</a> *<a class="code" href="../../d0/d5a/structUndoImageTile.html#a5586e1a050e297f98e5f0d6d49b0b58b">rect</a>,
<a name="l01601"></a>01601         <span class="keyword">const</span> <span class="keywordtype">float</span> l1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[2],
<a name="l01602"></a>01602         <span class="keywordtype">float</span> l1_clip[2], <span class="keywordtype">float</span> l2_clip[2])
<a name="l01603"></a>01603 {
<a name="l01604"></a>01604     <span class="comment">/* first account for horizontal, then vertical lines */</span>
<a name="l01605"></a>01605     <span class="comment">/* horiz */</span>
<a name="l01606"></a>01606     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(l1[1] - l2[1]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) {
<a name="l01607"></a>01607         <span class="comment">/* is the line out of range on its Y axis? */</span>
<a name="l01608"></a>01608         <span class="keywordflow">if</span> (l1[1] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> || l1[1] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) {
<a name="l01609"></a>01609             <span class="keywordflow">return</span> 0;
<a name="l01610"></a>01610         }
<a name="l01611"></a>01611         <span class="comment">/* line is out of range on its X axis */</span>
<a name="l01612"></a>01612         <span class="keywordflow">if</span> ((l1[0] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> &amp;&amp; l2[0] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) || (l1[0] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> &amp;&amp; l2[0] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>)) {
<a name="l01613"></a>01613             <span class="keywordflow">return</span> 0;
<a name="l01614"></a>01614         }
<a name="l01615"></a>01615         
<a name="l01616"></a>01616         
<a name="l01617"></a>01617         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(l1[0] - l2[0]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) { <span class="comment">/* this is a single point  (or close to)*/</span>
<a name="l01618"></a>01618             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(rect, l1[0], l1[1])) {
<a name="l01619"></a>01619                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l1_clip, l1);
<a name="l01620"></a>01620                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l2_clip, l2);
<a name="l01621"></a>01621                 <span class="keywordflow">return</span> 1;
<a name="l01622"></a>01622             }
<a name="l01623"></a>01623             <span class="keywordflow">else</span> {
<a name="l01624"></a>01624                 <span class="keywordflow">return</span> 0;
<a name="l01625"></a>01625             }
<a name="l01626"></a>01626         }
<a name="l01627"></a>01627         
<a name="l01628"></a>01628         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l1_clip, l1);
<a name="l01629"></a>01629         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l2_clip, l2);
<a name="l01630"></a>01630         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(l1_clip[0], rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>);
<a name="l01631"></a>01631         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(l2_clip[0], rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>);
<a name="l01632"></a>01632         <span class="keywordflow">return</span> 1;
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(l1[0] - l2[0]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) {
<a name="l01635"></a>01635         <span class="comment">/* is the line out of range on its X axis? */</span>
<a name="l01636"></a>01636         <span class="keywordflow">if</span> (l1[0] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> || l1[0] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) {
<a name="l01637"></a>01637             <span class="keywordflow">return</span> 0;
<a name="l01638"></a>01638         }
<a name="l01639"></a>01639         
<a name="l01640"></a>01640         <span class="comment">/* line is out of range on its Y axis */</span>
<a name="l01641"></a>01641         <span class="keywordflow">if</span> ((l1[1] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> &amp;&amp; l2[1] &lt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) || (l1[1] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> &amp;&amp; l2[1] &gt; rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>)) {
<a name="l01642"></a>01642             <span class="keywordflow">return</span> 0;
<a name="l01643"></a>01643         }
<a name="l01644"></a>01644         
<a name="l01645"></a>01645         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(l1[1] - l2[1]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) { <span class="comment">/* this is a single point  (or close to)*/</span>
<a name="l01646"></a>01646             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(rect, l1[0], l1[1])) {
<a name="l01647"></a>01647                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l1_clip, l1);
<a name="l01648"></a>01648                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l2_clip, l2);
<a name="l01649"></a>01649                 <span class="keywordflow">return</span> 1;
<a name="l01650"></a>01650             }
<a name="l01651"></a>01651             <span class="keywordflow">else</span> {
<a name="l01652"></a>01652                 <span class="keywordflow">return</span> 0;
<a name="l01653"></a>01653             }
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655         
<a name="l01656"></a>01656         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l1_clip, l1);
<a name="l01657"></a>01657         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l2_clip, l2);
<a name="l01658"></a>01658         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(l1_clip[1], rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>);
<a name="l01659"></a>01659         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(l2_clip[1], rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>);
<a name="l01660"></a>01660         <span class="keywordflow">return</span> 1;
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662     <span class="keywordflow">else</span> {
<a name="l01663"></a>01663         <span class="keywordtype">float</span> isect;
<a name="l01664"></a>01664         <span class="keywordtype">short</span> ok1 = 0;
<a name="l01665"></a>01665         <span class="keywordtype">short</span> ok2 = 0;
<a name="l01666"></a>01666         
<a name="l01667"></a>01667         <span class="comment">/* Done with vertical lines */</span>
<a name="l01668"></a>01668         
<a name="l01669"></a>01669         <span class="comment">/* are either of the points inside the rectangle ? */</span>
<a name="l01670"></a>01670         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(rect, l1[0], l1[1])) {
<a name="l01671"></a>01671             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l1_clip, l1);
<a name="l01672"></a>01672             ok1 = 1;
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674         
<a name="l01675"></a>01675         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(rect, l2[0], l2[1])) {
<a name="l01676"></a>01676             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(l2_clip, l2);
<a name="l01677"></a>01677             ok2 = 1;
<a name="l01678"></a>01678         }
<a name="l01679"></a>01679         
<a name="l01680"></a>01680         <span class="comment">/* line inside rect */</span>
<a name="l01681"></a>01681         <span class="keywordflow">if</span> (ok1 &amp;&amp; ok2) <span class="keywordflow">return</span> 1;
<a name="l01682"></a>01682         
<a name="l01683"></a>01683         <span class="comment">/* top/bottom */</span>
<a name="l01684"></a>01684         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a900db82417f8a9aae2748a6a9889096c">line_isect_y</a>(l1, l2, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, &amp;isect) &amp;&amp; (isect &gt;= rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) &amp;&amp; (isect &lt;= rect-&gt;xmax)) {
<a name="l01685"></a>01685             <span class="keywordflow">if</span> (l1[1] &lt; l2[1]) { <span class="comment">/* line 1 is outside */</span>
<a name="l01686"></a>01686                 l1_clip[0] = isect;
<a name="l01687"></a>01687                 l1_clip[1] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01688"></a>01688                 ok1 = 1;
<a name="l01689"></a>01689             }
<a name="l01690"></a>01690             <span class="keywordflow">else</span> {
<a name="l01691"></a>01691                 l2_clip[0] = isect;
<a name="l01692"></a>01692                 l2_clip[1] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01693"></a>01693                 ok2 = 2;
<a name="l01694"></a>01694             }
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696         
<a name="l01697"></a>01697         <span class="keywordflow">if</span> (ok1 &amp;&amp; ok2) <span class="keywordflow">return</span> 1;
<a name="l01698"></a>01698         
<a name="l01699"></a>01699         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a900db82417f8a9aae2748a6a9889096c">line_isect_y</a>(l1, l2, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>, &amp;isect) &amp;&amp; (isect &gt;= rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) &amp;&amp; (isect &lt;= rect-&gt;xmax)) {
<a name="l01700"></a>01700             <span class="keywordflow">if</span> (l1[1] &gt; l2[1]) { <span class="comment">/* line 1 is outside */</span>
<a name="l01701"></a>01701                 l1_clip[0] = isect;
<a name="l01702"></a>01702                 l1_clip[1] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01703"></a>01703                 ok1 = 1;
<a name="l01704"></a>01704             }
<a name="l01705"></a>01705             <span class="keywordflow">else</span> {
<a name="l01706"></a>01706                 l2_clip[0] = isect;
<a name="l01707"></a>01707                 l2_clip[1] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01708"></a>01708                 ok2 = 2;
<a name="l01709"></a>01709             }
<a name="l01710"></a>01710         }
<a name="l01711"></a>01711         
<a name="l01712"></a>01712         <span class="keywordflow">if</span> (ok1 &amp;&amp; ok2) <span class="keywordflow">return</span> 1;
<a name="l01713"></a>01713         
<a name="l01714"></a>01714         <span class="comment">/* left/right */</span>
<a name="l01715"></a>01715         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a5c66f3b2ea7b4c317b3c5d5ef5658636">line_isect_x</a>(l1, l2, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, &amp;isect) &amp;&amp; (isect &gt;= rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) &amp;&amp; (isect &lt;= rect-&gt;ymax)) {
<a name="l01716"></a>01716             <span class="keywordflow">if</span> (l1[0] &lt; l2[0]) { <span class="comment">/* line 1 is outside */</span>
<a name="l01717"></a>01717                 l1_clip[0] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01718"></a>01718                 l1_clip[1] = isect;
<a name="l01719"></a>01719                 ok1 = 1;
<a name="l01720"></a>01720             }
<a name="l01721"></a>01721             <span class="keywordflow">else</span> {
<a name="l01722"></a>01722                 l2_clip[0] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01723"></a>01723                 l2_clip[1] = isect;
<a name="l01724"></a>01724                 ok2 = 2;
<a name="l01725"></a>01725             }
<a name="l01726"></a>01726         }
<a name="l01727"></a>01727     
<a name="l01728"></a>01728         <span class="keywordflow">if</span> (ok1 &amp;&amp; ok2) <span class="keywordflow">return</span> 1;
<a name="l01729"></a>01729         
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a5c66f3b2ea7b4c317b3c5d5ef5658636">line_isect_x</a>(l1, l2, rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, &amp;isect) &amp;&amp; (isect &gt;= rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) &amp;&amp; (isect &lt;= rect-&gt;ymax)) {
<a name="l01731"></a>01731             <span class="keywordflow">if</span> (l1[0] &gt; l2[0]) { <span class="comment">/* line 1 is outside */</span>
<a name="l01732"></a>01732                 l1_clip[0] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01733"></a>01733                 l1_clip[1] = isect;
<a name="l01734"></a>01734                 ok1 = 1;
<a name="l01735"></a>01735             }
<a name="l01736"></a>01736             <span class="keywordflow">else</span> {
<a name="l01737"></a>01737                 l2_clip[0] = rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01738"></a>01738                 l2_clip[1] = isect;
<a name="l01739"></a>01739                 ok2 = 2;
<a name="l01740"></a>01740             }
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742         
<a name="l01743"></a>01743         <span class="keywordflow">if</span> (ok1 &amp;&amp; ok2) {
<a name="l01744"></a>01744             <span class="keywordflow">return</span> 1;
<a name="l01745"></a>01745         }
<a name="l01746"></a>01746         <span class="keywordflow">else</span> {
<a name="l01747"></a>01747             <span class="keywordflow">return</span> 0;
<a name="l01748"></a>01748         }
<a name="l01749"></a>01749     }
<a name="l01750"></a>01750 }
<a name="l01751"></a>01751 
<a name="l01752"></a>01752 
<a name="l01753"></a>01753 
<a name="l01754"></a>01754 <span class="comment">/* scale the quad &amp; tri about its center</span>
<a name="l01755"></a>01755 <span class="comment"> * scaling by PROJ_FACE_SCALE_SEAM (0.99x) is used for getting fake UV pixel coords that are on the</span>
<a name="l01756"></a>01756 <span class="comment"> * edge of the face but slightly inside it occlusion tests don&#39;t return hits on adjacent faces */</span>
<a name="l01757"></a>01757 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l01758"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae18ef62fd3415d2aef86c8139d702c26">01758</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae18ef62fd3415d2aef86c8139d702c26">scale_quad</a>(<span class="keywordtype">float</span> insetCos[4][3], <span class="keywordtype">float</span> *origCos[4], <span class="keyword">const</span> <span class="keywordtype">float</span> inset)
<a name="l01759"></a>01759 {
<a name="l01760"></a>01760     <span class="keywordtype">float</span> cent[3];
<a name="l01761"></a>01761     cent[0] = (origCos[0][0] + origCos[1][0] + origCos[2][0] + origCos[3][0]) / 4.0f;
<a name="l01762"></a>01762     cent[1] = (origCos[0][1] + origCos[1][1] + origCos[2][1] + origCos[3][1]) / 4.0f;
<a name="l01763"></a>01763     cent[2] = (origCos[0][2] + origCos[1][2] + origCos[2][2] + origCos[3][2]) / 4.0f;
<a name="l01764"></a>01764     
<a name="l01765"></a>01765     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[0], origCos[0], cent);
<a name="l01766"></a>01766     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[1], origCos[1], cent);
<a name="l01767"></a>01767     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[2], origCos[2], cent);
<a name="l01768"></a>01768     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[3], origCos[3], cent);
<a name="l01769"></a>01769     
<a name="l01770"></a>01770     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[0], inset);
<a name="l01771"></a>01771     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[1], inset);
<a name="l01772"></a>01772     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[2], inset);
<a name="l01773"></a>01773     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[3], inset);
<a name="l01774"></a>01774     
<a name="l01775"></a>01775     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[0], cent);
<a name="l01776"></a>01776     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[1], cent);
<a name="l01777"></a>01777     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[2], cent);
<a name="l01778"></a>01778     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[3], cent);
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 
<a name="l01782"></a><a class="code" href="../../df/d60/paint__image_8c.html#a44d80b3cab32617a780875297cb002a6">01782</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a44d80b3cab32617a780875297cb002a6">scale_tri</a>(<span class="keywordtype">float</span> insetCos[4][3], <span class="keywordtype">float</span> *origCos[4], <span class="keyword">const</span> <span class="keywordtype">float</span> inset)
<a name="l01783"></a>01783 {
<a name="l01784"></a>01784     <span class="keywordtype">float</span> cent[3];
<a name="l01785"></a>01785     cent[0] = (origCos[0][0] + origCos[1][0] + origCos[2][0]) / 3.0f;
<a name="l01786"></a>01786     cent[1] = (origCos[0][1] + origCos[1][1] + origCos[2][1]) / 3.0f;
<a name="l01787"></a>01787     cent[2] = (origCos[0][2] + origCos[1][2] + origCos[2][2]) / 3.0f;
<a name="l01788"></a>01788     
<a name="l01789"></a>01789     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[0], origCos[0], cent);
<a name="l01790"></a>01790     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[1], origCos[1], cent);
<a name="l01791"></a>01791     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(insetCos[2], origCos[2], cent);
<a name="l01792"></a>01792     
<a name="l01793"></a>01793     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[0], inset);
<a name="l01794"></a>01794     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[1], inset);
<a name="l01795"></a>01795     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(insetCos[2], inset);
<a name="l01796"></a>01796     
<a name="l01797"></a>01797     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[0], cent);
<a name="l01798"></a>01798     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[1], cent);
<a name="l01799"></a>01799     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(insetCos[2], cent);
<a name="l01800"></a>01800 }
<a name="l01801"></a>01801 <span class="preprocessor">#endif //PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l01802"></a>01802 <span class="preprocessor"></span>
<a name="l01803"></a><a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">01803</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">len_squared_v2v2_alt</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> *v1, <span class="keyword">const</span> <span class="keywordtype">float</span> v2_1, <span class="keyword">const</span> <span class="keywordtype">float</span> v2_2)
<a name="l01804"></a>01804 {
<a name="l01805"></a>01805     <span class="keywordtype">float</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>, <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807     x = v1[0] - v2_1;
<a name="l01808"></a>01808     y = v1[1] - v2_2;
<a name="l01809"></a>01809     <span class="keywordflow">return</span> x * x + y * <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>;
<a name="l01810"></a>01810 }
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 <span class="comment">/* note, use a squared value so we can use len_squared_v2v2</span>
<a name="l01813"></a>01813 <span class="comment"> * be sure that you have done a bounds check first or this may fail */</span>
<a name="l01814"></a>01814 <span class="comment">/* only give bucket_bounds as an arg because we need it elsewhere */</span>
<a name="l01815"></a><a class="code" href="../../df/d60/paint__image_8c.html#a520c5ed2b0cd0bd48996cd9bbbcd277d">01815</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a520c5ed2b0cd0bd48996cd9bbbcd277d">project_bucket_isect_circle</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> cent[2], <span class="keyword">const</span> <span class="keywordtype">float</span> radius_squared, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds)
<a name="l01816"></a>01816 {
<a name="l01817"></a>01817      
<a name="l01818"></a>01818     <span class="comment">/* Would normally to a simple intersection test, however we know the bounds of these 2 already intersect </span>
<a name="l01819"></a>01819 <span class="comment">     * so we only need to test if the center is inside the vertical or horizontal bounds on either axis,</span>
<a name="l01820"></a>01820 <span class="comment">     * this is even less work then an intersection test</span>
<a name="l01821"></a>01821 <span class="comment">     */</span>
<a name="l01822"></a>01822 <span class="preprocessor">#if 0</span>
<a name="l01823"></a>01823 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(bucket_bounds, cent[0], cent[1]))
<a name="l01824"></a>01824         <span class="keywordflow">return</span> 1;
<a name="l01825"></a>01825 <span class="preprocessor">#endif</span>
<a name="l01826"></a>01826 <span class="preprocessor"></span>    
<a name="l01827"></a>01827     <span class="keywordflow">if</span> ((bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> &lt;= cent[0] &amp;&amp; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> &gt;= cent[0]) ||
<a name="l01828"></a>01828         (bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> &lt;= cent[1] &amp;&amp; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> &gt;= cent[1]))
<a name="l01829"></a>01829     {
<a name="l01830"></a>01830         <span class="keywordflow">return</span> 1;
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832     
<a name="l01833"></a>01833     <span class="comment">/* out of bounds left */</span>
<a name="l01834"></a>01834     <span class="keywordflow">if</span> (cent[0] &lt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) {
<a name="l01835"></a>01835         <span class="comment">/* lower left out of radius test */</span>
<a name="l01836"></a>01836         <span class="keywordflow">if</span> (cent[1] &lt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) {
<a name="l01837"></a>01837             <span class="keywordflow">return</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">len_squared_v2v2_alt</a>(cent, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) &lt; radius_squared) ? 1 : 0;
<a name="l01838"></a>01838         } 
<a name="l01839"></a>01839         <span class="comment">/* top left test */</span>
<a name="l01840"></a>01840         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cent[1] &gt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) {
<a name="l01841"></a>01841             <span class="keywordflow">return</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">len_squared_v2v2_alt</a>(cent, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) &lt; radius_squared) ? 1 : 0;
<a name="l01842"></a>01842         }
<a name="l01843"></a>01843     }
<a name="l01844"></a>01844     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cent[0] &gt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) {
<a name="l01845"></a>01845         <span class="comment">/* lower right out of radius test */</span>
<a name="l01846"></a>01846         <span class="keywordflow">if</span> (cent[1] &lt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) {
<a name="l01847"></a>01847             <span class="keywordflow">return</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">len_squared_v2v2_alt</a>(cent, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) &lt; radius_squared) ? 1 : 0;
<a name="l01848"></a>01848         } 
<a name="l01849"></a>01849         <span class="comment">/* top right test */</span>
<a name="l01850"></a>01850         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cent[1] &gt; bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) {
<a name="l01851"></a>01851             <span class="keywordflow">return</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a27e435efb6c35f7aefe72a6f07689f55">len_squared_v2v2_alt</a>(cent, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) &lt; radius_squared) ? 1 : 0;
<a name="l01852"></a>01852         }
<a name="l01853"></a>01853     }
<a name="l01854"></a>01854     
<a name="l01855"></a>01855     <span class="keywordflow">return</span> 0;
<a name="l01856"></a>01856 }
<a name="l01857"></a>01857 
<a name="l01858"></a>01858 
<a name="l01859"></a>01859 
<a name="l01860"></a>01860 <span class="comment">/* Note for rect_to_uvspace_ortho() and rect_to_uvspace_persp()</span>
<a name="l01861"></a>01861 <span class="comment"> * in ortho view this function gives good results when bucket_bounds are outside the triangle</span>
<a name="l01862"></a>01862 <span class="comment"> * however in some cases, perspective view will mess up with faces that have minimal screenspace area</span>
<a name="l01863"></a>01863 <span class="comment"> * (viewed from the side)</span>
<a name="l01864"></a>01864 <span class="comment"> * </span>
<a name="l01865"></a>01865 <span class="comment"> * for this reason its not reliable in this case so we&#39;ll use the Simple Barycentric&#39;</span>
<a name="l01866"></a>01866 <span class="comment"> * funcs that only account for points inside the triangle.</span>
<a name="l01867"></a>01867 <span class="comment"> * however switching back to this for ortho is always an option */</span>
<a name="l01868"></a>01868 
<a name="l01869"></a><a class="code" href="../../df/d60/paint__image_8c.html#ad2ca6f2d173e8ac452db9e99d8004ff6">01869</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ad2ca6f2d173e8ac452db9e99d8004ff6">rect_to_uvspace_ortho</a>(
<a name="l01870"></a>01870         <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds,
<a name="l01871"></a>01871         <span class="keywordtype">float</span> *v1coSS, <span class="keywordtype">float</span> *v2coSS, <span class="keywordtype">float</span> *v3coSS,
<a name="l01872"></a>01872         <span class="keywordtype">float</span> *uv1co, <span class="keywordtype">float</span> *uv2co, <span class="keywordtype">float</span> *uv3co,
<a name="l01873"></a>01873         <span class="keywordtype">float</span> bucket_bounds_uv[4][2],
<a name="l01874"></a>01874         <span class="keyword">const</span> <span class="keywordtype">int</span> flip)
<a name="l01875"></a>01875 {
<a name="l01876"></a>01876     <span class="keywordtype">float</span> uv[2];
<a name="l01877"></a>01877     <span class="keywordtype">float</span> w[3];
<a name="l01878"></a>01878     
<a name="l01879"></a>01879     <span class="comment">/* get the UV space bounding box */</span>
<a name="l01880"></a>01880     uv[0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01881"></a>01881     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01882"></a>01882     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01883"></a>01883     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 3 : 0], uv1co, uv2co, uv3co, w);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     <span class="comment">//uv[0] = bucket_bounds-&gt;xmax; // set above</span>
<a name="l01886"></a>01886     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01887"></a>01887     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01888"></a>01888     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 2 : 1], uv1co, uv2co, uv3co, w);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890     uv[0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01891"></a>01891     <span class="comment">//uv[1] = bucket_bounds-&gt;ymax; // set above</span>
<a name="l01892"></a>01892     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01893"></a>01893     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 1 : 2], uv1co, uv2co, uv3co, w);
<a name="l01894"></a>01894 
<a name="l01895"></a>01895     <span class="comment">//uv[0] = bucket_bounds-&gt;xmin; // set above</span>
<a name="l01896"></a>01896     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01897"></a>01897     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01898"></a>01898     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 0 : 3], uv1co, uv2co, uv3co, w);
<a name="l01899"></a>01899 }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901 <span class="comment">/* same as above but use barycentric_weights_v2_persp */</span>
<a name="l01902"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9c5a1fce7a9c46a7b297c277ec224edd">01902</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9c5a1fce7a9c46a7b297c277ec224edd">rect_to_uvspace_persp</a>(
<a name="l01903"></a>01903         <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds,
<a name="l01904"></a>01904         <span class="keywordtype">float</span> *v1coSS, <span class="keywordtype">float</span> *v2coSS, <span class="keywordtype">float</span> *v3coSS,
<a name="l01905"></a>01905         <span class="keywordtype">float</span> *uv1co, <span class="keywordtype">float</span> *uv2co, <span class="keywordtype">float</span> *uv3co,
<a name="l01906"></a>01906         <span class="keywordtype">float</span> bucket_bounds_uv[4][2],
<a name="l01907"></a>01907         <span class="keyword">const</span> <span class="keywordtype">int</span> flip
<a name="l01908"></a>01908         )
<a name="l01909"></a>01909 {
<a name="l01910"></a>01910     <span class="keywordtype">float</span> uv[2];
<a name="l01911"></a>01911     <span class="keywordtype">float</span> w[3];
<a name="l01912"></a>01912     
<a name="l01913"></a>01913     <span class="comment">/* get the UV space bounding box */</span>
<a name="l01914"></a>01914     uv[0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01915"></a>01915     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01916"></a>01916     <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01917"></a>01917     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 3 : 0], uv1co, uv2co, uv3co, w);
<a name="l01918"></a>01918 
<a name="l01919"></a>01919     <span class="comment">//uv[0] = bucket_bounds-&gt;xmax; // set above</span>
<a name="l01920"></a>01920     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01921"></a>01921     <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01922"></a>01922     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 2 : 1], uv1co, uv2co, uv3co, w);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     uv[0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01925"></a>01925     <span class="comment">//uv[1] = bucket_bounds-&gt;ymax; // set above</span>
<a name="l01926"></a>01926     <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01927"></a>01927     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 1 : 2], uv1co, uv2co, uv3co, w);
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <span class="comment">//uv[0] = bucket_bounds-&gt;xmin; // set above</span>
<a name="l01930"></a>01930     uv[1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01931"></a>01931     <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1coSS, v2coSS, v3coSS, uv, w);
<a name="l01932"></a>01932     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[flip ? 0 : 3], uv1co, uv2co, uv3co, w);
<a name="l01933"></a>01933 }
<a name="l01934"></a>01934 
<a name="l01935"></a>01935 <span class="comment">/* This works as we need it to but we can save a few steps and not use it */</span>
<a name="l01936"></a>01936 
<a name="l01937"></a>01937 <span class="preprocessor">#if 0</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">float</span> angle_2d_clockwise(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> p3[2])
<a name="l01939"></a>01939 {
<a name="l01940"></a>01940     <span class="keywordtype">float</span> v1[2], v2[2];
<a name="l01941"></a>01941     
<a name="l01942"></a>01942     v1[0] = p1[0] - p2[0];    v1[1] = p1[1] - p2[1];
<a name="l01943"></a>01943     v2[0] = p3[0] - p2[0];    v2[1] = p3[1] - p2[1];
<a name="l01944"></a>01944     
<a name="l01945"></a>01945     <span class="keywordflow">return</span> -<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(v1[0] * v2[1] - v1[1] * v2[0], v1[0] * v2[0] + v1[1] * v2[1]);
<a name="l01946"></a>01946 }
<a name="l01947"></a>01947 <span class="preprocessor">#endif</span>
<a name="l01948"></a>01948 <span class="preprocessor"></span>
<a name="l01949"></a><a class="code" href="../../df/d60/paint__image_8c.html#ac64dc90bd8ad0332b0f212d584494471">01949</a> <span class="preprocessor">#define ISECT_1 (1)</span>
<a name="l01950"></a><a class="code" href="../../df/d60/paint__image_8c.html#ad4407a1b96e226162084a80348ad332e">01950</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_2 (1 &lt;&lt; 1)</span>
<a name="l01951"></a><a class="code" href="../../df/d60/paint__image_8c.html#aa68fa08d3f5e9f12510ded8d86f79e00">01951</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_3 (1 &lt;&lt; 2)</span>
<a name="l01952"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3b23fe3595b7e1efe985bde935726cbd">01952</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_4 (1 &lt;&lt; 3)</span>
<a name="l01953"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae5933d50a97399c0f88ffbd8d644d844">01953</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_ALL3 ((1 &lt;&lt; 3) - 1)</span>
<a name="l01954"></a><a class="code" href="../../df/d60/paint__image_8c.html#a100d75ed3fa94d4bac797836d966f924">01954</a> <span class="preprocessor"></span><span class="preprocessor">#define ISECT_ALL4 ((1 &lt;&lt; 4) - 1)</span>
<a name="l01955"></a>01955 <span class="preprocessor"></span>
<a name="l01956"></a>01956 <span class="comment">/* limit must be a fraction over 1.0f */</span>
<a name="l01957"></a><a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">01957</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">IsectPT2Df_limit</a>(<span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> v1[2], <span class="keywordtype">float</span> v2[2], <span class="keywordtype">float</span> v3[2], <span class="keywordtype">float</span> limit)
<a name="l01958"></a>01958 {
<a name="l01959"></a>01959     <span class="keywordflow">return</span> ((<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(pt, v1, v2) + <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(pt, v2, v3) + <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(pt, v3, v1)) / (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(v1, v2, v3))) &lt; limit;
<a name="l01960"></a>01960 }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962 <span class="comment">/* Clip the face by a bucket and set the uv-space bucket_bounds_uv</span>
<a name="l01963"></a>01963 <span class="comment"> * so we have the clipped UV&#39;s to do pixel intersection tests with </span>
<a name="l01964"></a>01964 <span class="comment"> * */</span>
<a name="l01965"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6515592c88be1841f1cef1c0833980a3">01965</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6515592c88be1841f1cef1c0833980a3">float_z_sort_flip</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *p1, <span class="keyword">const</span> <span class="keywordtype">void</span> *p2)
<a name="l01966"></a>01966 {
<a name="l01967"></a>01967     <span class="keywordflow">return</span> (((<span class="keywordtype">float</span> *)p1)[2] &lt; ((<span class="keywordtype">float</span> *)p2)[2] ? 1 : -1);
<a name="l01968"></a>01968 }
<a name="l01969"></a>01969 
<a name="l01970"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7e4f40db780a157c175f4adb333cbc2e">01970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a7e4f40db780a157c175f4adb333cbc2e">float_z_sort</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *p1, <span class="keyword">const</span> <span class="keywordtype">void</span> *p2)
<a name="l01971"></a>01971 {
<a name="l01972"></a>01972     <span class="keywordflow">return</span> (((<span class="keywordtype">float</span> *)p1)[2] &lt; ((<span class="keywordtype">float</span> *)p2)[2] ? -1 : 1);
<a name="l01973"></a>01973 }
<a name="l01974"></a>01974 
<a name="l01975"></a><a class="code" href="../../df/d60/paint__image_8c.html#a312c16254fbd5115a98c9158122e9996">01975</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a312c16254fbd5115a98c9158122e9996">project_bucket_clip_face</a>(
<a name="l01976"></a>01976         <span class="keyword">const</span> <span class="keywordtype">int</span> is_ortho,
<a name="l01977"></a>01977         <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds,
<a name="l01978"></a>01978         <span class="keywordtype">float</span> *v1coSS, <span class="keywordtype">float</span> *v2coSS, <span class="keywordtype">float</span> *v3coSS,
<a name="l01979"></a>01979         <span class="keywordtype">float</span> *uv1co, <span class="keywordtype">float</span> *uv2co, <span class="keywordtype">float</span> *uv3co,
<a name="l01980"></a>01980         <span class="keywordtype">float</span> bucket_bounds_uv[8][2],
<a name="l01981"></a>01981         <span class="keywordtype">int</span> *tot)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983     <span class="keywordtype">int</span> inside_bucket_flag = 0;
<a name="l01984"></a>01984     <span class="keywordtype">int</span> inside_face_flag = 0;
<a name="l01985"></a>01985     <span class="keyword">const</span> <span class="keywordtype">int</span> flip = ((<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v1coSS, v2coSS, v3coSS) &gt; 0.0f) != (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(uv1co, uv2co, uv3co) &gt; 0.0f));
<a name="l01986"></a>01986     
<a name="l01987"></a>01987     <span class="keywordtype">float</span> bucket_bounds_ss[4][2];
<a name="l01988"></a>01988 
<a name="l01989"></a>01989     <span class="comment">/* get the UV space bounding box */</span>
<a name="l01990"></a>01990     inside_bucket_flag |= <a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(bucket_bounds, v1coSS[0], v1coSS[1]);
<a name="l01991"></a>01991     inside_bucket_flag |= <a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(bucket_bounds, v2coSS[0], v2coSS[1]) &lt;&lt; 1;
<a name="l01992"></a>01992     inside_bucket_flag |= <a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(bucket_bounds, v3coSS[0], v3coSS[1]) &lt;&lt; 2;
<a name="l01993"></a>01993     
<a name="l01994"></a>01994     <span class="keywordflow">if</span> (inside_bucket_flag == <a class="code" href="../../df/d60/paint__image_8c.html#ae5933d50a97399c0f88ffbd8d644d844">ISECT_ALL3</a>) {
<a name="l01995"></a>01995         <span class="comment">/* all screenspace points are inside the bucket bounding box, this means we don&#39;t need to clip and can simply return the UVs */</span>
<a name="l01996"></a>01996         <span class="keywordflow">if</span> (flip) { <span class="comment">/* facing the back? */</span>
<a name="l01997"></a>01997             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[0], uv3co);
<a name="l01998"></a>01998             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[1], uv2co);
<a name="l01999"></a>01999             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[2], uv1co);
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001         <span class="keywordflow">else</span> {
<a name="l02002"></a>02002             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[0], uv1co);
<a name="l02003"></a>02003             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[1], uv2co);
<a name="l02004"></a>02004             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(bucket_bounds_uv[2], uv3co);
<a name="l02005"></a>02005         }
<a name="l02006"></a>02006         
<a name="l02007"></a>02007         *tot = 3; 
<a name="l02008"></a>02008         <span class="keywordflow">return</span>;
<a name="l02009"></a>02009     }
<a name="l02010"></a>02010     
<a name="l02011"></a>02011     <span class="comment">/* get the UV space bounding box */</span>
<a name="l02012"></a>02012     <span class="comment">/* use IsectPT2Df_limit here so we catch points are are touching the tri edge (or a small fraction over) */</span>
<a name="l02013"></a>02013     bucket_bounds_ss[0][0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l02014"></a>02014     bucket_bounds_ss[0][1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l02015"></a>02015     inside_face_flag |= (<a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">IsectPT2Df_limit</a>(bucket_bounds_ss[0], v1coSS, v2coSS, v3coSS, 1 + <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) ? <a class="code" href="../../df/d60/paint__image_8c.html#ac64dc90bd8ad0332b0f212d584494471">ISECT_1</a> : 0);
<a name="l02016"></a>02016     
<a name="l02017"></a>02017     bucket_bounds_ss[1][0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l02018"></a>02018     bucket_bounds_ss[1][1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l02019"></a>02019     inside_face_flag |= (<a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">IsectPT2Df_limit</a>(bucket_bounds_ss[1], v1coSS, v2coSS, v3coSS, 1 + <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) ? <a class="code" href="../../df/d60/paint__image_8c.html#ad4407a1b96e226162084a80348ad332e">ISECT_2</a> : 0);
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     bucket_bounds_ss[2][0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l02022"></a>02022     bucket_bounds_ss[2][1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l02023"></a>02023     inside_face_flag |= (<a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">IsectPT2Df_limit</a>(bucket_bounds_ss[2], v1coSS, v2coSS, v3coSS, 1 + <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) ? <a class="code" href="../../df/d60/paint__image_8c.html#aa68fa08d3f5e9f12510ded8d86f79e00">ISECT_3</a> : 0);
<a name="l02024"></a>02024 
<a name="l02025"></a>02025     bucket_bounds_ss[3][0] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l02026"></a>02026     bucket_bounds_ss[3][1] = bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l02027"></a>02027     inside_face_flag |= (<a class="code" href="../../df/d60/paint__image_8c.html#a8434cd9eeb55ac2c293c1c0f01ca1912">IsectPT2Df_limit</a>(bucket_bounds_ss[3], v1coSS, v2coSS, v3coSS, 1 + <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) ? <a class="code" href="../../df/d60/paint__image_8c.html#a3b23fe3595b7e1efe985bde935726cbd">ISECT_4</a> : 0);
<a name="l02028"></a>02028     
<a name="l02029"></a>02029     <span class="keywordflow">if</span> (inside_face_flag == <a class="code" href="../../df/d60/paint__image_8c.html#a100d75ed3fa94d4bac797836d966f924">ISECT_ALL4</a>) {
<a name="l02030"></a>02030         <span class="comment">/* bucket is totally inside the screenspace face, we can safely use weights */</span>
<a name="l02031"></a>02031         
<a name="l02032"></a>02032         <span class="keywordflow">if</span> (is_ortho) <a class="code" href="../../df/d60/paint__image_8c.html#ad2ca6f2d173e8ac452db9e99d8004ff6">rect_to_uvspace_ortho</a>(bucket_bounds, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, bucket_bounds_uv, flip);
<a name="l02033"></a>02033         <span class="keywordflow">else</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9c5a1fce7a9c46a7b297c277ec224edd">rect_to_uvspace_persp</a>(bucket_bounds, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, bucket_bounds_uv, flip);
<a name="l02034"></a>02034         
<a name="l02035"></a>02035         *tot = 4;
<a name="l02036"></a>02036         <span class="keywordflow">return</span>;
<a name="l02037"></a>02037     }
<a name="l02038"></a>02038     <span class="keywordflow">else</span> {
<a name="l02039"></a>02039         <span class="comment">/* The Complicated Case! </span>
<a name="l02040"></a>02040 <span class="comment">         * </span>
<a name="l02041"></a>02041 <span class="comment">         * The 2 cases above are where the face is inside the bucket or the bucket is inside the face.</span>
<a name="l02042"></a>02042 <span class="comment">         * </span>
<a name="l02043"></a>02043 <span class="comment">         * we need to make a convex polyline from the intersection between the screenspace face</span>
<a name="l02044"></a>02044 <span class="comment">         * and the bucket bounds.</span>
<a name="l02045"></a>02045 <span class="comment">         * </span>
<a name="l02046"></a>02046 <span class="comment">         * There are a number of ways this could be done, currently it just collects all intersecting verts,</span>
<a name="l02047"></a>02047 <span class="comment">         * and line intersections,  then sorts them clockwise, this is a lot easier then evaluating the geometry to</span>
<a name="l02048"></a>02048 <span class="comment">         * do a correct clipping on both shapes. */</span>
<a name="l02049"></a>02049         
<a name="l02050"></a>02050         
<a name="l02051"></a>02051         <span class="comment">/* add a bunch of points, we know must make up the convex hull which is the clipped rect and triangle */</span>
<a name="l02052"></a>02052         
<a name="l02053"></a>02053         
<a name="l02054"></a>02054         
<a name="l02055"></a>02055         <span class="comment">/* Maximum possible 6 intersections when using a rectangle and triangle */</span>
<a name="l02056"></a>02056         <span class="keywordtype">float</span> isectVCosSS[8][3]; <span class="comment">/* The 3rd float is used to store angle for qsort(), NOT as a Z location */</span>
<a name="l02057"></a>02057         <span class="keywordtype">float</span> v1_clipSS[2], v2_clipSS[2];
<a name="l02058"></a>02058         <span class="keywordtype">float</span> w[3];
<a name="l02059"></a>02059         
<a name="l02060"></a>02060         <span class="comment">/* calc center*/</span>
<a name="l02061"></a>02061         <span class="keywordtype">float</span> cent[2] = {0.0f, 0.0f};
<a name="l02062"></a>02062         <span class="comment">/*float up[2] = {0.0f, 1.0f};*/</span>
<a name="l02063"></a>02063         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02064"></a>02064         <span class="keywordtype">short</span> doubles;
<a name="l02065"></a>02065         
<a name="l02066"></a>02066         (*tot) = 0;
<a name="l02067"></a>02067         
<a name="l02068"></a>02068         <span class="keywordflow">if</span> (inside_face_flag &amp; <a class="code" href="../../df/d60/paint__image_8c.html#ac64dc90bd8ad0332b0f212d584494471">ISECT_1</a>) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], bucket_bounds_ss[0]); (*tot)++; }
<a name="l02069"></a>02069         <span class="keywordflow">if</span> (inside_face_flag &amp; <a class="code" href="../../df/d60/paint__image_8c.html#ad4407a1b96e226162084a80348ad332e">ISECT_2</a>) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], bucket_bounds_ss[1]); (*tot)++; }
<a name="l02070"></a>02070         <span class="keywordflow">if</span> (inside_face_flag &amp; <a class="code" href="../../df/d60/paint__image_8c.html#aa68fa08d3f5e9f12510ded8d86f79e00">ISECT_3</a>) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], bucket_bounds_ss[2]); (*tot)++; }
<a name="l02071"></a>02071         <span class="keywordflow">if</span> (inside_face_flag &amp; <a class="code" href="../../df/d60/paint__image_8c.html#a3b23fe3595b7e1efe985bde935726cbd">ISECT_4</a>) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], bucket_bounds_ss[3]); (*tot)++; }
<a name="l02072"></a>02072 
<a name="l02073"></a>02073         <span class="keywordflow">if</span> (inside_bucket_flag &amp; ISECT_1) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v1coSS); (*tot)++; }
<a name="l02074"></a>02074         <span class="keywordflow">if</span> (inside_bucket_flag &amp; ISECT_2) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v2coSS); (*tot)++; }
<a name="l02075"></a>02075         <span class="keywordflow">if</span> (inside_bucket_flag &amp; ISECT_3) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v3coSS); (*tot)++; }
<a name="l02076"></a>02076         
<a name="l02077"></a>02077         <span class="keywordflow">if</span> ((inside_bucket_flag &amp; (ISECT_1 | ISECT_2)) != (ISECT_1 | ISECT_2)) {
<a name="l02078"></a>02078             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">line_clip_rect2f</a>(bucket_bounds, v1coSS, v2coSS, v1_clipSS, v2_clipSS)) {
<a name="l02079"></a>02079                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_1) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v1_clipSS); (*tot)++; }
<a name="l02080"></a>02080                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_2) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v2_clipSS); (*tot)++; }
<a name="l02081"></a>02081             }
<a name="l02082"></a>02082         }
<a name="l02083"></a>02083         
<a name="l02084"></a>02084         <span class="keywordflow">if</span> ((inside_bucket_flag &amp; (ISECT_2 | ISECT_3)) != (ISECT_2 | ISECT_3)) {
<a name="l02085"></a>02085             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">line_clip_rect2f</a>(bucket_bounds, v2coSS, v3coSS, v1_clipSS, v2_clipSS)) {
<a name="l02086"></a>02086                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_2) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v1_clipSS); (*tot)++; }
<a name="l02087"></a>02087                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_3) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v2_clipSS); (*tot)++; }
<a name="l02088"></a>02088             }
<a name="l02089"></a>02089         }   
<a name="l02090"></a>02090         
<a name="l02091"></a>02091         <span class="keywordflow">if</span> ((inside_bucket_flag &amp; (ISECT_3 | ISECT_1)) != (ISECT_3 | ISECT_1)) {
<a name="l02092"></a>02092             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">line_clip_rect2f</a>(bucket_bounds, v3coSS, v1coSS, v1_clipSS, v2_clipSS)) {
<a name="l02093"></a>02093                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_3) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v1_clipSS); (*tot)++; }
<a name="l02094"></a>02094                 <span class="keywordflow">if</span> ((inside_bucket_flag &amp; ISECT_1) == 0) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(isectVCosSS[*tot], v2_clipSS); (*tot)++; }
<a name="l02095"></a>02095             }
<a name="l02096"></a>02096         }
<a name="l02097"></a>02097         
<a name="l02098"></a>02098         
<a name="l02099"></a>02099         <span class="keywordflow">if</span> ((*tot) &lt; 3) { <span class="comment">/* no intersections to speak of */</span>
<a name="l02100"></a>02100             *tot = 0;
<a name="l02101"></a>02101             <span class="keywordflow">return</span>;
<a name="l02102"></a>02102         }
<a name="l02103"></a>02103     
<a name="l02104"></a>02104         <span class="comment">/* now we have all points we need, collect their angles and sort them clockwise */</span>
<a name="l02105"></a>02105         
<a name="l02106"></a>02106         <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02107"></a>02107             cent[0] += isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0];
<a name="l02108"></a>02108             cent[1] += isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1];
<a name="l02109"></a>02109         }
<a name="l02110"></a>02110         cent[0] = cent[0] / (float)(*tot);
<a name="l02111"></a>02111         cent[1] = cent[1] / (float)(*tot);
<a name="l02112"></a>02112         
<a name="l02113"></a>02113         
<a name="l02114"></a>02114         
<a name="l02115"></a>02115         <span class="comment">/* Collect angles for every point around the center point */</span>
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         
<a name="l02118"></a>02118 <span class="preprocessor">#if 0   </span><span class="comment">/* uses a few more cycles then the above loop */</span>
<a name="l02119"></a>02119         <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02120"></a>02120             isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] = angle_2d_clockwise(up, cent, isectVCosSS[i]);
<a name="l02121"></a>02121         }
<a name="l02122"></a>02122 <span class="preprocessor">#endif</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span>
<a name="l02124"></a>02124         v1_clipSS[0] = cent[0]; <span class="comment">/* Abuse this var for the loop below */</span>
<a name="l02125"></a>02125         v1_clipSS[1] = cent[1] + 1.0f;
<a name="l02126"></a>02126         
<a name="l02127"></a>02127         <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02128"></a>02128             v2_clipSS[0] = isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] - cent[0];
<a name="l02129"></a>02129             v2_clipSS[1] = isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] - cent[1];
<a name="l02130"></a>02130             isectVCosSS[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab616618cf09fc0ef5c0ec0d9e5825f58">atan2f</a>(v1_clipSS[0] * v2_clipSS[1] - v1_clipSS[1] * v2_clipSS[0], v1_clipSS[0] * v2_clipSS[0] + v1_clipSS[1] * v2_clipSS[1]);
<a name="l02131"></a>02131         }
<a name="l02132"></a>02132         
<a name="l02133"></a>02133         <span class="keywordflow">if</span> (flip) qsort(isectVCosSS, *tot, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3, <a class="code" href="../../df/d60/paint__image_8c.html#a6515592c88be1841f1cef1c0833980a3">float_z_sort_flip</a>);
<a name="l02134"></a>02134         <span class="keywordflow">else</span>      qsort(isectVCosSS, *tot, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3, <a class="code" href="../../df/d60/paint__image_8c.html#a7e4f40db780a157c175f4adb333cbc2e">float_z_sort</a>);
<a name="l02135"></a>02135         
<a name="l02136"></a>02136         <span class="comment">/* remove doubles */</span>
<a name="l02137"></a>02137         <span class="comment">/* first/last check */</span>
<a name="l02138"></a>02138         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(isectVCosSS[0][0] - isectVCosSS[(*tot) - 1][0]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a> &amp;&amp;  <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(isectVCosSS[0][1] - isectVCosSS[(*tot) - 1][1]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>) {
<a name="l02139"></a>02139             (*tot)--;
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141         
<a name="l02142"></a>02142         <span class="comment">/* its possible there is only a few left after remove doubles */</span>
<a name="l02143"></a>02143         <span class="keywordflow">if</span> ((*tot) &lt; 3) {
<a name="l02144"></a>02144             <span class="comment">// printf(&quot;removed too many doubles A\n&quot;);</span>
<a name="l02145"></a>02145             *tot = 0;
<a name="l02146"></a>02146             <span class="keywordflow">return</span>;
<a name="l02147"></a>02147         }
<a name="l02148"></a>02148         
<a name="l02149"></a>02149         doubles = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02150"></a>02150         <span class="keywordflow">while</span> (doubles == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l02151"></a>02151             doubles = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02152"></a>02152             <span class="keywordflow">for</span> (i = 1; i &lt; (*tot); i++) {
<a name="l02153"></a>02153                 <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(isectVCosSS[i - 1][0] - isectVCosSS[i][0]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a> &amp;&amp;
<a name="l02154"></a>02154                     <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(isectVCosSS[i - 1][1] - isectVCosSS[i][1]) &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a>)
<a name="l02155"></a>02155                 {
<a name="l02156"></a>02156                     <span class="keywordtype">int</span> j;
<a name="l02157"></a>02157                     <span class="keywordflow">for</span> (j = i + 1; j &lt; (*tot); j++) {
<a name="l02158"></a>02158                         isectVCosSS[j - 1][0] = isectVCosSS[j][0];
<a name="l02159"></a>02159                         isectVCosSS[j - 1][1] = isectVCosSS[j][1];
<a name="l02160"></a>02160                     }
<a name="l02161"></a>02161                     doubles = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">/* keep looking for more doubles */</span>
<a name="l02162"></a>02162                     (*tot)--;
<a name="l02163"></a>02163                 }
<a name="l02164"></a>02164             }
<a name="l02165"></a>02165         }
<a name="l02166"></a>02166         
<a name="l02167"></a>02167         <span class="comment">/* its possible there is only a few left after remove doubles */</span>
<a name="l02168"></a>02168         <span class="keywordflow">if</span> ((*tot) &lt; 3) {
<a name="l02169"></a>02169             <span class="comment">// printf(&quot;removed too many doubles B\n&quot;);</span>
<a name="l02170"></a>02170             *tot = 0;
<a name="l02171"></a>02171             <span class="keywordflow">return</span>;
<a name="l02172"></a>02172         }
<a name="l02173"></a>02173         
<a name="l02174"></a>02174         
<a name="l02175"></a>02175         <span class="keywordflow">if</span> (is_ortho) {
<a name="l02176"></a>02176             <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02177"></a>02177                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(v1coSS, v2coSS, v3coSS, isectVCosSS[i], w);
<a name="l02178"></a>02178                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[i], uv1co, uv2co, uv3co, w);
<a name="l02179"></a>02179             }
<a name="l02180"></a>02180         }
<a name="l02181"></a>02181         <span class="keywordflow">else</span> {
<a name="l02182"></a>02182             <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02183"></a>02183                 <a class="code" href="../../df/d60/paint__image_8c.html#a957b1edee435ae9e8f833886331e7671">barycentric_weights_v2_persp</a>(v1coSS, v2coSS, v3coSS, isectVCosSS[i], w);
<a name="l02184"></a>02184                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acf860ba11f1b1ad86b6e01712db1564e">interp_v2_v2v2v2</a>(bucket_bounds_uv[i], uv1co, uv2co, uv3co, w);
<a name="l02185"></a>02185             }
<a name="l02186"></a>02186         }
<a name="l02187"></a>02187     }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189 <span class="preprocessor">#ifdef PROJ_DEBUG_PRINT_CLIP</span>
<a name="l02190"></a>02190 <span class="preprocessor"></span>    <span class="comment">/* include this at the bottom of the above function to debug the output */</span>
<a name="l02191"></a>02191 
<a name="l02192"></a>02192     {
<a name="l02193"></a>02193         <span class="comment">/* If there are ever any problems, */</span>
<a name="l02194"></a>02194         <span class="keywordtype">float</span> test_uv[4][2];
<a name="l02195"></a>02195         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02196"></a>02196         <span class="keywordflow">if</span> (is_ortho) <a class="code" href="../../df/d60/paint__image_8c.html#ad2ca6f2d173e8ac452db9e99d8004ff6">rect_to_uvspace_ortho</a>(bucket_bounds, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, test_uv, flip);
<a name="l02197"></a>02197         <span class="keywordflow">else</span>          <a class="code" href="../../df/d60/paint__image_8c.html#a9c5a1fce7a9c46a7b297c277ec224edd">rect_to_uvspace_persp</a>(bucket_bounds, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, test_uv, flip);
<a name="l02198"></a>02198         printf(<span class="stringliteral">&quot;(  [(%f,%f), (%f,%f), (%f,%f), (%f,%f)], &quot;</span>, test_uv[0][0], test_uv[0][1],   test_uv[1][0], test_uv[1][1],    test_uv[2][0], test_uv[2][1],    test_uv[3][0], test_uv[3][1]);
<a name="l02199"></a>02199         
<a name="l02200"></a>02200         printf(<span class="stringliteral">&quot;  [(%f,%f), (%f,%f), (%f,%f)], &quot;</span>, uv1co[0], uv1co[1],   uv2co[0], uv2co[1],    uv3co[0], uv3co[1]);
<a name="l02201"></a>02201         
<a name="l02202"></a>02202         printf(<span class="stringliteral">&quot;[&quot;</span>);
<a name="l02203"></a>02203         <span class="keywordflow">for</span> (i = 0; i &lt; (*tot); i++) {
<a name="l02204"></a>02204             printf(<span class="stringliteral">&quot;(%f, %f),&quot;</span>, bucket_bounds_uv[i][0], bucket_bounds_uv[i][1]);
<a name="l02205"></a>02205         }
<a name="l02206"></a>02206         printf(<span class="stringliteral">&quot;]),\\\n&quot;</span>);
<a name="l02207"></a>02207     }
<a name="l02208"></a>02208 <span class="preprocessor">#endif</span>
<a name="l02209"></a>02209 <span class="preprocessor"></span>}
<a name="l02210"></a>02210 
<a name="l02211"></a>02211 <span class="comment">/*</span>
<a name="l02212"></a>02212 <span class="comment"> * # This script creates faces in a blender scene from printed data above.</span>
<a name="l02213"></a>02213 <span class="comment"> *</span>
<a name="l02214"></a>02214 <span class="comment"> * project_ls = [</span>
<a name="l02215"></a>02215 <span class="comment"> * ...(output from above block)...</span>
<a name="l02216"></a>02216 <span class="comment"> * ]</span>
<a name="l02217"></a>02217 <span class="comment"> *</span>
<a name="l02218"></a>02218 <span class="comment"> * from Blender import Scene, Mesh, Window, sys, Mathutils</span>
<a name="l02219"></a>02219 <span class="comment"> *</span>
<a name="l02220"></a>02220 <span class="comment"> * import bpy</span>
<a name="l02221"></a>02221 <span class="comment"> *</span>
<a name="l02222"></a>02222 <span class="comment"> * V = Mathutils.Vector</span>
<a name="l02223"></a>02223 <span class="comment"> *</span>
<a name="l02224"></a>02224 <span class="comment"> * def main():</span>
<a name="l02225"></a>02225 <span class="comment"> *     sce = bpy.data.scenes.active</span>
<a name="l02226"></a>02226 <span class="comment"> *     </span>
<a name="l02227"></a>02227 <span class="comment"> *     for item in project_ls:</span>
<a name="l02228"></a>02228 <span class="comment"> *         bb = item[0]</span>
<a name="l02229"></a>02229 <span class="comment"> *         uv = item[1]</span>
<a name="l02230"></a>02230 <span class="comment"> *         poly = item[2]</span>
<a name="l02231"></a>02231 <span class="comment"> *         </span>
<a name="l02232"></a>02232 <span class="comment"> *         me = bpy.data.meshes.new()</span>
<a name="l02233"></a>02233 <span class="comment"> *         ob = sce.objects.new(me)</span>
<a name="l02234"></a>02234 <span class="comment"> *         </span>
<a name="l02235"></a>02235 <span class="comment"> *         me.verts.extend([V(bb[0]).xyz, V(bb[1]).xyz, V(bb[2]).xyz, V(bb[3]).xyz])</span>
<a name="l02236"></a>02236 <span class="comment"> *         me.faces.extend([(0,1,2,3),])</span>
<a name="l02237"></a>02237 <span class="comment"> *         me.verts.extend([V(uv[0]).xyz, V(uv[1]).xyz, V(uv[2]).xyz])</span>
<a name="l02238"></a>02238 <span class="comment"> *         me.faces.extend([(4,5,6),])</span>
<a name="l02239"></a>02239 <span class="comment"> *         </span>
<a name="l02240"></a>02240 <span class="comment"> *         vs = [V(p).xyz for p in poly]</span>
<a name="l02241"></a>02241 <span class="comment"> *         print len(vs)</span>
<a name="l02242"></a>02242 <span class="comment"> *         l = len(me.verts)</span>
<a name="l02243"></a>02243 <span class="comment"> *         me.verts.extend(vs)</span>
<a name="l02244"></a>02244 <span class="comment"> *         </span>
<a name="l02245"></a>02245 <span class="comment"> *         i = l</span>
<a name="l02246"></a>02246 <span class="comment"> *         while i &lt; len(me.verts):</span>
<a name="l02247"></a>02247 <span class="comment"> *             ii = i+1</span>
<a name="l02248"></a>02248 <span class="comment"> *             if ii==len(me.verts):</span>
<a name="l02249"></a>02249 <span class="comment"> *                 ii = l</span>
<a name="l02250"></a>02250 <span class="comment"> *             me.edges.extend([i, ii])</span>
<a name="l02251"></a>02251 <span class="comment"> *             i+=1</span>
<a name="l02252"></a>02252 <span class="comment"> * </span>
<a name="l02253"></a>02253 <span class="comment"> * if __name__ == &#39;__main__&#39;:</span>
<a name="l02254"></a>02254 <span class="comment"> *     main()</span>
<a name="l02255"></a>02255 <span class="comment"> */</span>
<a name="l02256"></a>02256 
<a name="l02257"></a>02257 
<a name="l02258"></a>02258 <span class="preprocessor">#undef ISECT_1</span>
<a name="l02259"></a>02259 <span class="preprocessor"></span><span class="preprocessor">#undef ISECT_2</span>
<a name="l02260"></a>02260 <span class="preprocessor"></span><span class="preprocessor">#undef ISECT_3</span>
<a name="l02261"></a>02261 <span class="preprocessor"></span><span class="preprocessor">#undef ISECT_4</span>
<a name="l02262"></a>02262 <span class="preprocessor"></span><span class="preprocessor">#undef ISECT_ALL3</span>
<a name="l02263"></a>02263 <span class="preprocessor"></span><span class="preprocessor">#undef ISECT_ALL4</span>
<a name="l02264"></a>02264 <span class="preprocessor"></span>
<a name="l02265"></a>02265     
<a name="l02266"></a>02266 <span class="comment">/* checks if pt is inside a convex 2D polyline, the polyline must be ordered rotating clockwise</span>
<a name="l02267"></a>02267 <span class="comment"> * otherwise it would have to test for mixed (line_point_side_v2 &gt; 0.0f) cases */</span>
<a name="l02268"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae3289c1591a5d561416e9c505623c798">02268</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae3289c1591a5d561416e9c505623c798">IsectPoly2Df</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> uv[][2], <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l02269"></a>02269 {
<a name="l02270"></a>02270     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02271"></a>02271     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(uv[tot - 1], uv[0], pt) &lt; 0.0f)
<a name="l02272"></a>02272         <span class="keywordflow">return</span> 0;
<a name="l02273"></a>02273     
<a name="l02274"></a>02274     <span class="keywordflow">for</span> (i = 1; i &lt; tot; i++) {
<a name="l02275"></a>02275         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(uv[i - 1], uv[i], pt) &lt; 0.0f)
<a name="l02276"></a>02276             <span class="keywordflow">return</span> 0;
<a name="l02277"></a>02277         
<a name="l02278"></a>02278     }
<a name="l02279"></a>02279     
<a name="l02280"></a>02280     <span class="keywordflow">return</span> 1;
<a name="l02281"></a>02281 }
<a name="l02282"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7b6b6f6919200f62728b6530ec455063">02282</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a7b6b6f6919200f62728b6530ec455063">IsectPoly2Df_twoside</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> uv[][2], <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l02283"></a>02283 {
<a name="l02284"></a>02284     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02285"></a>02285     <span class="keywordtype">int</span> side = (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(uv[tot - 1], uv[0], pt) &gt; 0.0f);
<a name="l02286"></a>02286     
<a name="l02287"></a>02287     <span class="keywordflow">for</span> (i = 1; i &lt; tot; i++) {
<a name="l02288"></a>02288         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(uv[i - 1], uv[i], pt) &gt; 0.0f) != side)
<a name="l02289"></a>02289             <span class="keywordflow">return</span> 0;
<a name="l02290"></a>02290         
<a name="l02291"></a>02291     }
<a name="l02292"></a>02292     
<a name="l02293"></a>02293     <span class="keywordflow">return</span> 1;
<a name="l02294"></a>02294 }
<a name="l02295"></a>02295 
<a name="l02296"></a>02296 <span class="comment">/* One of the most important function for projectiopn painting, since it selects the pixels to be added into each bucket.</span>
<a name="l02297"></a>02297 <span class="comment"> * initialize pixels from this face where it intersects with the bucket_index, optionally initialize pixels for removing seams */</span>
<a name="l02298"></a><a class="code" href="../../df/d60/paint__image_8c.html#a94aa3b387f040c2b6744501eecd936a0">02298</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a94aa3b387f040c2b6744501eecd936a0">project_paint_face_init</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">int</span> thread_index, <span class="keyword">const</span> <span class="keywordtype">int</span> bucket_index, <span class="keyword">const</span> <span class="keywordtype">int</span> face_index, <span class="keyword">const</span> <span class="keywordtype">int</span> image_index, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds, <span class="keyword">const</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">short</span> clamp_u, <span class="keyword">const</span> <span class="keywordtype">short</span> clamp_v)
<a name="l02299"></a>02299 {
<a name="l02300"></a>02300     <span class="comment">/* Projection vars, to get the 3D locations into screen space  */</span>
<a name="l02301"></a>02301     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[thread_index];
<a name="l02302"></a>02302     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **bucketPixelNodes = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a> + bucket_index;
<a name="l02303"></a>02303     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *bucketFaceNodes = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>[bucket_index];
<a name="l02304"></a>02304     
<a name="l02305"></a>02305     <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> + face_index;
<a name="l02306"></a>02306     <span class="keyword">const</span> <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> + face_index;
<a name="l02307"></a>02307     
<a name="l02308"></a>02308     <span class="comment">/* UV/pixel seeking data */</span>
<a name="l02309"></a>02309     <span class="keywordtype">int</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#aa90219adfbd70a960721689cd7d368f6">x</a>; <span class="comment">/* Image X-Pixel */</span>
<a name="l02310"></a>02310     <span class="keywordtype">int</span> <a class="code" href="../../d0/d5a/structUndoImageTile.html#af827f02622427196b91ac3bcc1ec461e">y</a>; <span class="comment">/* Image Y-Pixel */</span>
<a name="l02311"></a>02311     <span class="keywordtype">float</span> mask;
<a name="l02312"></a>02312     <span class="keywordtype">float</span> uv[2]; <span class="comment">/* Image floating point UV - same as x, y but from 0.0-1.0 */</span>
<a name="l02313"></a>02313     
<a name="l02314"></a>02314     <span class="keywordtype">int</span> side;
<a name="l02315"></a>02315     <span class="keywordtype">float</span> *v1coSS, *v2coSS, *v3coSS; <span class="comment">/* vert co screen-space, these will be assigned to mf-&gt;v1,2,3 or mf-&gt;v1,3,4 */</span>
<a name="l02316"></a>02316     
<a name="l02317"></a>02317     <span class="keywordtype">float</span> *vCo[4]; <span class="comment">/* vertex screenspace coords */</span>
<a name="l02318"></a>02318     
<a name="l02319"></a>02319     <span class="keywordtype">float</span> w[3], wco[3];
<a name="l02320"></a>02320     
<a name="l02321"></a>02321     <span class="keywordtype">float</span> *uv1co, *uv2co, *uv3co; <span class="comment">/* for convenience only, these will be assigned to tf-&gt;uv[0],1,2 or tf-&gt;uv[0],2,3 */</span>
<a name="l02322"></a>02322     <span class="keywordtype">float</span> pixelScreenCo[4];
<a name="l02323"></a>02323     
<a name="l02324"></a>02324     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> bounds_px; <span class="comment">/* ispace bounds */</span>
<a name="l02325"></a>02325     <span class="comment">/* vars for getting uvspace bounds */</span>
<a name="l02326"></a>02326     
<a name="l02327"></a>02327     <span class="keywordtype">float</span> tf_uv_pxoffset[4][2]; <span class="comment">/* bucket bounds in UV space so we can init pixels only for this face,  */</span>
<a name="l02328"></a>02328     <span class="keywordtype">float</span> xhalfpx, yhalfpx;
<a name="l02329"></a>02329     <span class="keyword">const</span> <span class="keywordtype">float</span> ibuf_xf = (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf_yf = (<span class="keywordtype">float</span>)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l02330"></a>02330     
<a name="l02331"></a>02331     <span class="keywordtype">int</span> has_x_isect = 0, has_isect = 0; <span class="comment">/* for early loop exit */</span>
<a name="l02332"></a>02332     
<a name="l02333"></a>02333     <span class="keywordtype">int</span> i1, i2, i3;
<a name="l02334"></a>02334     
<a name="l02335"></a>02335     <span class="keywordtype">float</span> uv_clip[8][2];
<a name="l02336"></a>02336     <span class="keywordtype">int</span> uv_clip_tot;
<a name="l02337"></a>02337     <span class="keyword">const</span> <span class="keywordtype">short</span> is_ortho = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>;
<a name="l02338"></a>02338     <span class="keyword">const</span> <span class="keywordtype">short</span> do_backfacecull = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">do_backfacecull</a>;
<a name="l02339"></a>02339     <span class="keyword">const</span> <span class="keywordtype">short</span> do_clip = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a> ? ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a> : 0;
<a name="l02340"></a>02340     
<a name="l02341"></a>02341     vCo[0] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02342"></a>02342     vCo[1] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02343"></a>02343     vCo[2] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02344"></a>02344     
<a name="l02345"></a>02345     
<a name="l02346"></a>02346     <span class="comment">/* Use tf_uv_pxoffset instead of tf-&gt;uv so we can offset the UV half a pixel</span>
<a name="l02347"></a>02347 <span class="comment">     * this is done so we can avoid offseting all the pixels by 0.5 which causes</span>
<a name="l02348"></a>02348 <span class="comment">     * problems when wrapping negative coords */</span>
<a name="l02349"></a>02349     xhalfpx = (0.5f +   (<a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a> / 3.0f)   ) / ibuf_xf;
<a name="l02350"></a>02350     yhalfpx = (0.5f +   (<a class="code" href="../../df/d60/paint__image_8c.html#a4aef2211d3b0c404e6b5be9c81330966">PROJ_GEOM_TOLERANCE</a> / 4.0f)   ) / ibuf_yf;
<a name="l02351"></a>02351     
<a name="l02352"></a>02352     <span class="comment">/* Note about (PROJ_GEOM_TOLERANCE/x) above...</span>
<a name="l02353"></a>02353 <span class="comment">     * Needed to add this offset since UV coords are often quads aligned to pixels.</span>
<a name="l02354"></a>02354 <span class="comment">     * In this case pixels can be exactly between 2 triangles causing nasty</span>
<a name="l02355"></a>02355 <span class="comment">     * artifacts.</span>
<a name="l02356"></a>02356 <span class="comment">     * </span>
<a name="l02357"></a>02357 <span class="comment">     * This workaround can be removed and painting will still work on most cases</span>
<a name="l02358"></a>02358 <span class="comment">     * but since the first thing most people try is painting onto a quad- better make it work.</span>
<a name="l02359"></a>02359 <span class="comment">     */</span>
<a name="l02360"></a>02360 
<a name="l02361"></a>02361 
<a name="l02362"></a>02362 
<a name="l02363"></a>02363     tf_uv_pxoffset[0][0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0] - xhalfpx;
<a name="l02364"></a>02364     tf_uv_pxoffset[0][1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1] - yhalfpx;
<a name="l02365"></a>02365 
<a name="l02366"></a>02366     tf_uv_pxoffset[1][0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0] - xhalfpx;
<a name="l02367"></a>02367     tf_uv_pxoffset[1][1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1] - yhalfpx;
<a name="l02368"></a>02368     
<a name="l02369"></a>02369     tf_uv_pxoffset[2][0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0] - xhalfpx;
<a name="l02370"></a>02370     tf_uv_pxoffset[2][1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1] - yhalfpx;  
<a name="l02371"></a>02371     
<a name="l02372"></a>02372     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02373"></a>02373         vCo[3] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02374"></a>02374         
<a name="l02375"></a>02375         tf_uv_pxoffset[3][0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0] - xhalfpx;
<a name="l02376"></a>02376         tf_uv_pxoffset[3][1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1] - yhalfpx;
<a name="l02377"></a>02377         side = 1;
<a name="l02378"></a>02378     }
<a name="l02379"></a>02379     <span class="keywordflow">else</span> {
<a name="l02380"></a>02380         side = 0;
<a name="l02381"></a>02381     }
<a name="l02382"></a>02382     
<a name="l02383"></a>02383     <span class="keywordflow">do</span> {
<a name="l02384"></a>02384         <span class="keywordflow">if</span> (side == 1) {
<a name="l02385"></a>02385             i1 = 0; i2 = 2; i3 = 3;
<a name="l02386"></a>02386         }
<a name="l02387"></a>02387         <span class="keywordflow">else</span> {
<a name="l02388"></a>02388             i1 = 0; i2 = 1; i3 = 2;
<a name="l02389"></a>02389         }
<a name="l02390"></a>02390         
<a name="l02391"></a>02391         uv1co = tf_uv_pxoffset[i1]; <span class="comment">// was tf-&gt;uv[i1];</span>
<a name="l02392"></a>02392         uv2co = tf_uv_pxoffset[i2]; <span class="comment">// was tf-&gt;uv[i2];</span>
<a name="l02393"></a>02393         uv3co = tf_uv_pxoffset[i3]; <span class="comment">// was tf-&gt;uv[i3];</span>
<a name="l02394"></a>02394 
<a name="l02395"></a>02395         v1coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i1))];
<a name="l02396"></a>02396         v2coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i2))];
<a name="l02397"></a>02397         v3coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i3))];
<a name="l02398"></a>02398         
<a name="l02399"></a>02399         <span class="comment">/* This funtion gives is a concave polyline in UV space from the clipped quad and tri*/</span>
<a name="l02400"></a>02400         <a class="code" href="../../df/d60/paint__image_8c.html#a312c16254fbd5115a98c9158122e9996">project_bucket_clip_face</a>(
<a name="l02401"></a>02401                 is_ortho, bucket_bounds,
<a name="l02402"></a>02402                 v1coSS, v2coSS, v3coSS,
<a name="l02403"></a>02403                 uv1co, uv2co, uv3co,
<a name="l02404"></a>02404                 uv_clip, &amp;uv_clip_tot
<a name="l02405"></a>02405                 );
<a name="l02406"></a>02406 
<a name="l02407"></a>02407         <span class="comment">/* sometimes this happens, better just allow for 8 intersectiosn even though there should be max 6 */</span>
<a name="l02408"></a>02408 <span class="preprocessor">#if 0</span>
<a name="l02409"></a>02409 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (uv_clip_tot &gt; 6) {
<a name="l02410"></a>02410             printf(<span class="stringliteral">&quot;this should never happen! %d\n&quot;</span>, uv_clip_tot);
<a name="l02411"></a>02411         }
<a name="l02412"></a>02412 <span class="preprocessor">#endif</span>
<a name="l02413"></a>02413 <span class="preprocessor"></span>
<a name="l02414"></a>02414         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#ae713769b38499b668a21dbab27ff9950">pixel_bounds_array</a>(uv_clip, &amp;bounds_px, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, uv_clip_tot)) {
<a name="l02415"></a>02415 
<a name="l02416"></a>02416             <span class="keywordflow">if</span> (clamp_u) {
<a name="l02417"></a>02417                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bounds_px.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l02418"></a>02418                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bounds_px.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l02419"></a>02419             }
<a name="l02420"></a>02420 
<a name="l02421"></a>02421             <span class="keywordflow">if</span> (clamp_v) {
<a name="l02422"></a>02422                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l02423"></a>02423                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l02424"></a>02424             }
<a name="l02425"></a>02425 
<a name="l02426"></a>02426             <span class="comment">/* clip face and */</span>
<a name="l02427"></a>02427             
<a name="l02428"></a>02428             has_isect = 0;
<a name="l02429"></a>02429             <span class="keywordflow">for</span> (y = bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>; y &lt; bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>; y++) {
<a name="l02430"></a>02430                 <span class="comment">//uv[1] = (((float)y) + 0.5f) / (float)ibuf-&gt;y;</span>
<a name="l02431"></a>02431                 uv[1] = (float)y / ibuf_yf; <span class="comment">/* use pixel offset UV coords instead */</span>
<a name="l02432"></a>02432 
<a name="l02433"></a>02433                 has_x_isect = 0;
<a name="l02434"></a>02434                 <span class="keywordflow">for</span> (x = bounds_px.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>; x &lt; bounds_px.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a>; x++) {
<a name="l02435"></a>02435                     <span class="comment">//uv[0] = (((float)x) + 0.5f) / ibuf-&gt;x;</span>
<a name="l02436"></a>02436                     uv[0] = (float)x / ibuf_xf; <span class="comment">/* use pixel offset UV coords instead */</span>
<a name="l02437"></a>02437                     
<a name="l02438"></a>02438                     <span class="comment">/* Note about IsectPoly2Df_twoside, checking the face or uv flipping doesnt work,</span>
<a name="l02439"></a>02439 <span class="comment">                     * could check the poly direction but better to do this */</span>
<a name="l02440"></a>02440                     <span class="keywordflow">if</span> ((do_backfacecull          &amp;&amp; <a class="code" href="../../df/d60/paint__image_8c.html#ae3289c1591a5d561416e9c505623c798">IsectPoly2Df</a>(uv, uv_clip, uv_clip_tot)) ||
<a name="l02441"></a>02441                         (do_backfacecull == 0     &amp;&amp; <a class="code" href="../../df/d60/paint__image_8c.html#a7b6b6f6919200f62728b6530ec455063">IsectPoly2Df_twoside</a>(uv, uv_clip, uv_clip_tot)))
<a name="l02442"></a>02442                     {
<a name="l02443"></a>02443                         
<a name="l02444"></a>02444                         has_x_isect = has_isect = 1;
<a name="l02445"></a>02445                         
<a name="l02446"></a>02446                         <span class="keywordflow">if</span> (is_ortho) <a class="code" href="../../df/d60/paint__image_8c.html#aa9ce010ae6b5da33479b684e54ff40d0">screen_px_from_ortho</a>(uv, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, pixelScreenCo, w);
<a name="l02447"></a>02447                         <span class="keywordflow">else</span>          <a class="code" href="../../df/d60/paint__image_8c.html#a78b908f9c929285c9ef5dd923cc8486f">screen_px_from_persp</a>(uv, v1coSS, v2coSS, v3coSS, uv1co, uv2co, uv3co, pixelScreenCo, w);
<a name="l02448"></a>02448                         
<a name="l02449"></a>02449                         <span class="comment">/* a pity we need to get the worldspace pixel location here */</span>
<a name="l02450"></a>02450                         <span class="keywordflow">if</span> (do_clip) {
<a name="l02451"></a>02451                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(wco, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i1))].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i2))].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + i3))].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, w);
<a name="l02452"></a>02452                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, wco, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l02453"></a>02453                                 <span class="keywordflow">continue</span>; <span class="comment">/* Watch out that no code below this needs to run */</span>
<a name="l02454"></a>02454                             }
<a name="l02455"></a>02455                         }
<a name="l02456"></a>02456                         
<a name="l02457"></a>02457                         <span class="comment">/* Is this UV visible from the view? - raytrace */</span>
<a name="l02458"></a>02458                         <span class="comment">/* project_paint_PickFace is less complex, use for testing */</span>
<a name="l02459"></a>02459                         <span class="comment">//if (project_paint_PickFace(ps, pixelScreenCo, w, &amp;side) == face_index) {</span>
<a name="l02460"></a>02460                         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a04cc2cedebda1163ba6bcce7f02a183a">do_occlude</a> == 0 || !<a class="code" href="../../df/d60/paint__image_8c.html#a615fee50daf162b756518969493e594f">project_bucket_point_occluded</a>(ps, bucketFaceNodes, face_index, pixelScreenCo)) {
<a name="l02461"></a>02461                             
<a name="l02462"></a>02462                             mask = <a class="code" href="../../df/d60/paint__image_8c.html#a3fe8683e840d2767a3f4a7cfe22efe4d">project_paint_uvpixel_mask</a>(ps, face_index, side, w);
<a name="l02463"></a>02463                             
<a name="l02464"></a>02464                             <span class="keywordflow">if</span> (mask &gt; 0.0f) {
<a name="l02465"></a>02465                                 <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(
<a name="l02466"></a>02466                                         bucketPixelNodes,
<a name="l02467"></a>02467                                         <a class="code" href="../../df/d60/paint__image_8c.html#a2ce0eb39a3c0adde977984143144630b">project_paint_uvpixel_init</a>(ps, arena, ibuf, x, y, mask, face_index, image_index, pixelScreenCo, side, w),
<a name="l02468"></a>02468                                         arena
<a name="l02469"></a>02469                                         );
<a name="l02470"></a>02470                             }
<a name="l02471"></a>02471                         }
<a name="l02472"></a>02472                         
<a name="l02473"></a>02473                     }
<a name="l02474"></a>02474 <span class="comment">//#if 0</span>
<a name="l02475"></a>02475                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (has_x_isect) {
<a name="l02476"></a>02476                         <span class="comment">/* assuming the face is not a bow-tie - we know we cant intersect again on the X */</span>
<a name="l02477"></a>02477                         <span class="keywordflow">break</span>;
<a name="l02478"></a>02478                     }
<a name="l02479"></a>02479 <span class="comment">//#endif</span>
<a name="l02480"></a>02480                 }
<a name="l02481"></a>02481                 
<a name="l02482"></a>02482                 
<a name="l02483"></a>02483 <span class="preprocessor">#if 0           </span><span class="comment">/* TODO - investigate why this dosnt work sometimes! it should! */</span>
<a name="l02484"></a>02484                 <span class="comment">/* no intersection for this entire row, after some intersection above means we can quit now */</span>
<a name="l02485"></a>02485                 <span class="keywordflow">if</span> (has_x_isect == 0 &amp;&amp; has_isect) {
<a name="l02486"></a>02486                     <span class="keywordflow">break</span>;
<a name="l02487"></a>02487                 }
<a name="l02488"></a>02488 <span class="preprocessor">#endif</span>
<a name="l02489"></a>02489 <span class="preprocessor"></span>            }
<a name="l02490"></a>02490         }
<a name="l02491"></a>02491     } <span class="keywordflow">while</span> (side--);
<a name="l02492"></a>02492 
<a name="l02493"></a>02493     
<a name="l02494"></a>02494     
<a name="l02495"></a>02495 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l02496"></a>02496 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> &gt; 0.0f) {
<a name="l02497"></a>02497         <span class="keywordtype">int</span> face_seam_flag;
<a name="l02498"></a>02498         
<a name="l02499"></a>02499         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l02500"></a>02500             <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);  <span class="comment">/* Other threads could be modifying these vars */</span>
<a name="l02501"></a>02501         
<a name="l02502"></a>02502         face_seam_flag = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index];
<a name="l02503"></a>02503         
<a name="l02504"></a>02504         <span class="comment">/* are any of our edges un-initialized? */</span>
<a name="l02505"></a>02505         <span class="keywordflow">if</span> ((face_seam_flag &amp; (<a class="code" href="../../df/d60/paint__image_8c.html#a2f0a1b2e617d22161ba34a37025f62f0">PROJ_FACE_SEAM1</a> | <a class="code" href="../../df/d60/paint__image_8c.html#aeb64fa2a207f9ce096489b04f08d0c9f">PROJ_FACE_NOSEAM1</a>)) == 0 ||
<a name="l02506"></a>02506             (face_seam_flag &amp; (<a class="code" href="../../df/d60/paint__image_8c.html#a0e1f22a29694e3d7aed564a9e00d2f2b">PROJ_FACE_SEAM2</a> | <a class="code" href="../../df/d60/paint__image_8c.html#a27c283767c6685555b156d34fb845bfc">PROJ_FACE_NOSEAM2</a>)) == 0 ||
<a name="l02507"></a>02507             (face_seam_flag &amp; (<a class="code" href="../../df/d60/paint__image_8c.html#ab4e6a0a67aacc45db6e81ef4f8c84e16">PROJ_FACE_SEAM3</a> | <a class="code" href="../../df/d60/paint__image_8c.html#afa3ef9cf452ac30cd410ecaaaceedbee">PROJ_FACE_NOSEAM3</a>)) == 0 ||
<a name="l02508"></a>02508             (face_seam_flag &amp; (<a class="code" href="../../df/d60/paint__image_8c.html#abea63161df145e528f3adfc4f8008943">PROJ_FACE_SEAM4</a> | <a class="code" href="../../df/d60/paint__image_8c.html#a6032595ab69e857e67e783a11a361f77">PROJ_FACE_NOSEAM4</a>)) == 0)
<a name="l02509"></a>02509         {
<a name="l02510"></a>02510             <a class="code" href="../../df/d60/paint__image_8c.html#a6ef668f719dcc5a1cf7d5b40f5138182">project_face_seams_init</a>(ps, face_index, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>);
<a name="l02511"></a>02511             face_seam_flag = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index];
<a name="l02512"></a>02512             <span class="comment">//printf(&quot;seams - %d %d %d %d\n&quot;, flag&amp;PROJ_FACE_SEAM1, flag&amp;PROJ_FACE_SEAM2, flag&amp;PROJ_FACE_SEAM3, flag&amp;PROJ_FACE_SEAM4);</span>
<a name="l02513"></a>02513         }
<a name="l02514"></a>02514         
<a name="l02515"></a>02515         <span class="keywordflow">if</span> ((face_seam_flag &amp; (<a class="code" href="../../df/d60/paint__image_8c.html#a2f0a1b2e617d22161ba34a37025f62f0">PROJ_FACE_SEAM1</a> | <a class="code" href="../../df/d60/paint__image_8c.html#a0e1f22a29694e3d7aed564a9e00d2f2b">PROJ_FACE_SEAM2</a> | <a class="code" href="../../df/d60/paint__image_8c.html#ab4e6a0a67aacc45db6e81ef4f8c84e16">PROJ_FACE_SEAM3</a> | <a class="code" href="../../df/d60/paint__image_8c.html#abea63161df145e528f3adfc4f8008943">PROJ_FACE_SEAM4</a>)) == 0) {
<a name="l02516"></a>02516             
<a name="l02517"></a>02517             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l02518"></a>02518                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);  <span class="comment">/* Other threads could be modifying these vars */</span>
<a name="l02519"></a>02519             
<a name="l02520"></a>02520         }
<a name="l02521"></a>02521         <span class="keywordflow">else</span> {
<a name="l02522"></a>02522             <span class="comment">/* we have a seam - deal with it! */</span>
<a name="l02523"></a>02523             
<a name="l02524"></a>02524             <span class="comment">/* Now create new UV&#39;s for the seam face */</span>
<a name="l02525"></a>02525             float (*outset_uv)[2] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">faceSeamUVs</a>[face_index];
<a name="l02526"></a>02526             <span class="keywordtype">float</span> insetCos[4][3]; <span class="comment">/* inset face coords.  NOTE!!! ScreenSace for ortho, Worldspace in prespective view */</span>
<a name="l02527"></a>02527 
<a name="l02528"></a>02528             <span class="keywordtype">float</span> fac;
<a name="l02529"></a>02529             <span class="keywordtype">float</span> *vCoSS[4]; <span class="comment">/* vertex screenspace coords */</span>
<a name="l02530"></a>02530             
<a name="l02531"></a>02531             <span class="keywordtype">float</span> bucket_clip_edges[2][2]; <span class="comment">/* store the screenspace coords of the face, clipped by the bucket&#39;s screen aligned rectangle */</span>
<a name="l02532"></a>02532             <span class="keywordtype">float</span> edge_verts_inset_clip[2][3];
<a name="l02533"></a>02533             <span class="keywordtype">int</span> fidx1, fidx2; <span class="comment">/* face edge pairs - loop throuh these ((0,1), (1,2), (2,3), (3,0)) or ((0,1), (1,2), (2,0)) for a tri */</span>
<a name="l02534"></a>02534             
<a name="l02535"></a>02535             <span class="keywordtype">float</span> seam_subsection[4][2];
<a name="l02536"></a>02536             <span class="keywordtype">float</span> fac1, fac2, ftot;
<a name="l02537"></a>02537             
<a name="l02538"></a>02538             
<a name="l02539"></a>02539             <span class="keywordflow">if</span> (outset_uv[0][0] == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>) <span class="comment">/* first time initialize */</span>
<a name="l02540"></a>02540                 <a class="code" href="../../df/d60/paint__image_8c.html#a5cff554eefd5ffdf8c5aa8330d6a1099">uv_image_outset</a>(tf_uv_pxoffset, outset_uv, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>);
<a name="l02541"></a>02541             
<a name="l02542"></a>02542             <span class="comment">/* ps-&gt;faceSeamUVs cant be modified when threading, now this is done we can unlock */</span>
<a name="l02543"></a>02543             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l02544"></a>02544                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);  <span class="comment">/* Other threads could be modifying these vars */</span>
<a name="l02545"></a>02545             
<a name="l02546"></a>02546             vCoSS[0] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l02547"></a>02547             vCoSS[1] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l02548"></a>02548             vCoSS[2] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l02549"></a>02549             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l02550"></a>02550                 vCoSS[3] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l02551"></a>02551             
<a name="l02552"></a>02552             <span class="comment">/* PROJ_FACE_SCALE_SEAM must be slightly less then 1.0f */</span>
<a name="l02553"></a>02553             <span class="keywordflow">if</span> (is_ortho) {
<a name="l02554"></a>02554                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) <a class="code" href="../../df/d60/paint__image_8c.html#ae18ef62fd3415d2aef86c8139d702c26">scale_quad</a>(insetCos, vCoSS, <a class="code" href="../../df/d60/paint__image_8c.html#af6ffae7a06b8d485c328de66a6882ec2">PROJ_FACE_SCALE_SEAM</a>);
<a name="l02555"></a>02555                 <span class="keywordflow">else</span>        <a class="code" href="../../df/d60/paint__image_8c.html#a44d80b3cab32617a780875297cb002a6">scale_tri</a>(insetCos, vCoSS, <a class="code" href="../../df/d60/paint__image_8c.html#af6ffae7a06b8d485c328de66a6882ec2">PROJ_FACE_SCALE_SEAM</a>);
<a name="l02556"></a>02556             }
<a name="l02557"></a>02557             <span class="keywordflow">else</span> {
<a name="l02558"></a>02558                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) <a class="code" href="../../df/d60/paint__image_8c.html#ae18ef62fd3415d2aef86c8139d702c26">scale_quad</a>(insetCos, vCo, <a class="code" href="../../df/d60/paint__image_8c.html#af6ffae7a06b8d485c328de66a6882ec2">PROJ_FACE_SCALE_SEAM</a>);
<a name="l02559"></a>02559                 <span class="keywordflow">else</span>        <a class="code" href="../../df/d60/paint__image_8c.html#a44d80b3cab32617a780875297cb002a6">scale_tri</a>(insetCos, vCo, <a class="code" href="../../df/d60/paint__image_8c.html#af6ffae7a06b8d485c328de66a6882ec2">PROJ_FACE_SCALE_SEAM</a>);
<a name="l02560"></a>02560             }
<a name="l02561"></a>02561             
<a name="l02562"></a>02562             side = 0; <span class="comment">/* for triangles this wont need to change */</span>
<a name="l02563"></a>02563             
<a name="l02564"></a>02564             <span class="keywordflow">for</span> (fidx1 = 0; fidx1 &lt; (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3); fidx1++) {
<a name="l02565"></a>02565                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) fidx2 = (fidx1 == 3) ? 0 : fidx1 + 1;  <span class="comment">/* next fidx in the face (0,1,2,3) -&gt; (1,2,3,0) */</span>
<a name="l02566"></a>02566                 <span class="keywordflow">else</span>        fidx2 = (fidx1 == 2) ? 0 : fidx1 + 1;  <span class="comment">/* next fidx in the face (0,1,2) -&gt; (1,2,0) */</span>
<a name="l02567"></a>02567                 
<a name="l02568"></a>02568                 <span class="keywordflow">if</span> ((face_seam_flag &amp; (1 &lt;&lt; fidx1)) &amp;&amp; <span class="comment">/* 1&lt;&lt;fidx1 -&gt; PROJ_FACE_SEAM# */</span>
<a name="l02569"></a>02569                     <a class="code" href="../../df/d60/paint__image_8c.html#a869727c0ba2feacedef2d42be0ebe9cb">line_clip_rect2f</a>(bucket_bounds, vCoSS[fidx1], vCoSS[fidx2], bucket_clip_edges[0], bucket_clip_edges[1]))
<a name="l02570"></a>02570                 {
<a name="l02571"></a>02571 
<a name="l02572"></a>02572                     ftot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(vCoSS[fidx1], vCoSS[fidx2]); <span class="comment">/* screenspace edge length */</span>
<a name="l02573"></a>02573                     
<a name="l02574"></a>02574                     <span class="keywordflow">if</span> (ftot &gt; 0.0f) { <span class="comment">/* avoid div by zero */</span>
<a name="l02575"></a>02575                         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02576"></a>02576                             <span class="keywordflow">if</span> (fidx1 == 2 || fidx2 == 2) side = 1;
<a name="l02577"></a>02577                             <span class="keywordflow">else</span> side = 0;
<a name="l02578"></a>02578                         }
<a name="l02579"></a>02579                         
<a name="l02580"></a>02580                         fac1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(vCoSS[fidx1], bucket_clip_edges[0]) / ftot;
<a name="l02581"></a>02581                         fac2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(vCoSS[fidx1], bucket_clip_edges[1]) / ftot;
<a name="l02582"></a>02582                         
<a name="l02583"></a>02583                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(seam_subsection[0], tf_uv_pxoffset[fidx1], tf_uv_pxoffset[fidx2], fac1);
<a name="l02584"></a>02584                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(seam_subsection[1], tf_uv_pxoffset[fidx1], tf_uv_pxoffset[fidx2], fac2);
<a name="l02585"></a>02585 
<a name="l02586"></a>02586                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(seam_subsection[2], outset_uv[fidx1], outset_uv[fidx2], fac2);
<a name="l02587"></a>02587                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(seam_subsection[3], outset_uv[fidx1], outset_uv[fidx2], fac1);
<a name="l02588"></a>02588                         
<a name="l02589"></a>02589                         <span class="comment">/* if the bucket_clip_edges values Z values was kept we could avoid this</span>
<a name="l02590"></a>02590 <span class="comment">                         * Inset needs to be added so occlusion tests wont hit adjacent faces */</span>
<a name="l02591"></a>02591                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(edge_verts_inset_clip[0], insetCos[fidx1], insetCos[fidx2], fac1);
<a name="l02592"></a>02592                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(edge_verts_inset_clip[1], insetCos[fidx1], insetCos[fidx2], fac2);
<a name="l02593"></a>02593                         
<a name="l02594"></a>02594 
<a name="l02595"></a>02595                         <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#adb17a3ea894973daf252121eaca54238">pixel_bounds_uv</a>(seam_subsection[0], seam_subsection[1], seam_subsection[2], seam_subsection[3], &amp;bounds_px, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 1)) {
<a name="l02596"></a>02596                             <span class="comment">/* bounds between the seam rect and the uvspace bucket pixels */</span>
<a name="l02597"></a>02597                             
<a name="l02598"></a>02598                             has_isect = 0;
<a name="l02599"></a>02599                             <span class="keywordflow">for</span> (y = bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>; y &lt; bounds_px.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>; y++) {
<a name="l02600"></a>02600                                 <span class="comment">// uv[1] = (((float)y) + 0.5f) / (float)ibuf-&gt;y;</span>
<a name="l02601"></a>02601                                 uv[1] = (float)y / ibuf_yf; <span class="comment">/* use offset uvs instead */</span>
<a name="l02602"></a>02602                                 
<a name="l02603"></a>02603                                 has_x_isect = 0;
<a name="l02604"></a>02604                                 <span class="keywordflow">for</span> (x = bounds_px.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>; x &lt; bounds_px.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a>; x++) {
<a name="l02605"></a>02605                                     <span class="comment">//uv[0] = (((float)x) + 0.5f) / (float)ibuf-&gt;x;</span>
<a name="l02606"></a>02606                                     uv[0] = (float)x / ibuf_xf; <span class="comment">/* use offset uvs instead */</span>
<a name="l02607"></a>02607                                     
<a name="l02608"></a>02608                                     <span class="comment">/* test we&#39;re inside uvspace bucket and triangle bounds */</span>
<a name="l02609"></a>02609                                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(uv, seam_subsection[0], seam_subsection[1], seam_subsection[2], seam_subsection[3])) {
<a name="l02610"></a>02610                                         
<a name="l02611"></a>02611                                         <span class="comment">/* We need to find the closest point along the face edge,</span>
<a name="l02612"></a>02612 <span class="comment">                                         * getting the screen_px_from_*** wont work because our actual location</span>
<a name="l02613"></a>02613 <span class="comment">                                         * is not relevant, since we are outside the face, Use VecLerpf to find</span>
<a name="l02614"></a>02614 <span class="comment">                                         * our location on the side of the face&#39;s UV */</span>
<a name="l02615"></a>02615 <span class="preprocessor">#if 0</span>
<a name="l02616"></a>02616 <span class="preprocessor"></span>                                        <span class="keywordflow">if</span> (is_ortho) <a class="code" href="../../df/d60/paint__image_8c.html#aa9ce010ae6b5da33479b684e54ff40d0">screen_px_from_ortho</a>(ps, uv, v1co, v2co, v3co, uv1co, uv2co, uv3co, pixelScreenCo);
<a name="l02617"></a>02617                                         <span class="keywordflow">else</span>          <a class="code" href="../../df/d60/paint__image_8c.html#a78b908f9c929285c9ef5dd923cc8486f">screen_px_from_persp</a>(ps, uv, v1co, v2co, v3co, uv1co, uv2co, uv3co, pixelScreenCo);
<a name="l02618"></a>02618 <span class="preprocessor">#endif</span>
<a name="l02619"></a>02619 <span class="preprocessor"></span>                                        
<a name="l02620"></a>02620                                         <span class="comment">/* Since this is a seam we need to work out where on the line this pixel is */</span>
<a name="l02621"></a>02621                                         <span class="comment">//fac = line_point_factor_v2(uv, uv_seam_quad[0], uv_seam_quad[1]);</span>
<a name="l02622"></a>02622                                         
<a name="l02623"></a>02623                                         fac = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a87d4f10694f41505747272f5a4490057">line_point_factor_v2</a>(uv, seam_subsection[0], seam_subsection[1]);
<a name="l02624"></a>02624                                         <span class="keywordflow">if</span>      (fac &lt; 0.0f) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pixelScreenCo, edge_verts_inset_clip[0]); }
<a name="l02625"></a>02625                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt; 1.0f) { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pixelScreenCo, edge_verts_inset_clip[1]); }
<a name="l02626"></a>02626                                         <span class="keywordflow">else</span>                 { <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(pixelScreenCo, edge_verts_inset_clip[0], edge_verts_inset_clip[1], fac); }
<a name="l02627"></a>02627                                         
<a name="l02628"></a>02628                                         <span class="keywordflow">if</span> (!is_ortho) {
<a name="l02629"></a>02629                                             pixelScreenCo[3] = 1.0f;
<a name="l02630"></a>02630                                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>((<span class="keywordtype">float</span>(*)[4])ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>, pixelScreenCo); <span class="comment">/* cast because of const */</span>
<a name="l02631"></a>02631                                             pixelScreenCo[0] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) * pixelScreenCo[0] / pixelScreenCo[3];
<a name="l02632"></a>02632                                             pixelScreenCo[1] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) * pixelScreenCo[1] / pixelScreenCo[3];
<a name="l02633"></a>02633                                             pixelScreenCo[2] = pixelScreenCo[2] / pixelScreenCo[3]; <span class="comment">/* Use the depth for bucket point occlusion */</span>
<a name="l02634"></a>02634                                         }
<a name="l02635"></a>02635                                         
<a name="l02636"></a>02636                                         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a04cc2cedebda1163ba6bcce7f02a183a">do_occlude</a> == 0 || !<a class="code" href="../../df/d60/paint__image_8c.html#a615fee50daf162b756518969493e594f">project_bucket_point_occluded</a>(ps, bucketFaceNodes, face_index, pixelScreenCo)) {
<a name="l02637"></a>02637                                             
<a name="l02638"></a>02638                                             <span class="comment">/* Only bother calculating the weights if we intersect */</span>
<a name="l02639"></a>02639                                             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a> || ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>) {
<a name="l02640"></a>02640 <span class="preprocessor">#if 1</span>
<a name="l02641"></a>02641 <span class="preprocessor"></span>                                                <span class="comment">/* get the UV on the line since we want to copy the pixels from there for bleeding */</span>
<a name="l02642"></a>02642                                                 <span class="keywordtype">float</span> uv_close[2];
<a name="l02643"></a>02643                                                 <span class="keywordtype">float</span> fac = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00d439c1ac1a9593b794ebe8734358f5">closest_to_line_v2</a>(uv_close, uv, tf_uv_pxoffset[fidx1], tf_uv_pxoffset[fidx2]);
<a name="l02644"></a>02644                                                 <span class="keywordflow">if</span>      (fac &lt; 0.0f) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(uv_close, tf_uv_pxoffset[fidx1]);
<a name="l02645"></a>02645                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt; 1.0f) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(uv_close, tf_uv_pxoffset[fidx2]);
<a name="l02646"></a>02646 
<a name="l02647"></a>02647                                                 <span class="keywordflow">if</span> (side) {
<a name="l02648"></a>02648                                                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(tf_uv_pxoffset[0], tf_uv_pxoffset[2], tf_uv_pxoffset[3], uv_close, w);
<a name="l02649"></a>02649                                                 }
<a name="l02650"></a>02650                                                 <span class="keywordflow">else</span> {
<a name="l02651"></a>02651                                                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(tf_uv_pxoffset[0], tf_uv_pxoffset[1], tf_uv_pxoffset[2], uv_close, w);
<a name="l02652"></a>02652                                                 }
<a name="l02653"></a>02653 <span class="preprocessor">#else                                           </span><span class="comment">/* this is buggy with quads, don&#39;t use for now */</span>
<a name="l02654"></a>02654 
<a name="l02655"></a>02655                                                 <span class="comment">/* Cheat, we know where we are along the edge so work out the weights from that */</span>
<a name="l02656"></a>02656                                                 fac = fac1 + (fac * (fac2 - fac1));
<a name="l02657"></a>02657 
<a name="l02658"></a>02658                                                 w[0] = w[1] = w[2] = 0.0;
<a name="l02659"></a>02659                                                 <span class="keywordflow">if</span> (side) {
<a name="l02660"></a>02660                                                     w[fidx1 ? fidx1 - 1 : 0] = 1.0f - fac;
<a name="l02661"></a>02661                                                     w[fidx2 ? fidx2 - 1 : 0] = fac;
<a name="l02662"></a>02662                                                 }
<a name="l02663"></a>02663                                                 <span class="keywordflow">else</span> {
<a name="l02664"></a>02664                                                     w[fidx1] = 1.0f - fac;
<a name="l02665"></a>02665                                                     w[fidx2] = fac;
<a name="l02666"></a>02666                                                 }
<a name="l02667"></a>02667 <span class="preprocessor">#endif</span>
<a name="l02668"></a>02668 <span class="preprocessor"></span>                                            }
<a name="l02669"></a>02669                                             
<a name="l02670"></a>02670                                             <span class="comment">/* a pity we need to get the worldspace pixel location here */</span>
<a name="l02671"></a>02671                                             <span class="keywordflow">if</span> (do_clip) {
<a name="l02672"></a>02672                                                 <span class="keywordflow">if</span> (side) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(wco, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, w);
<a name="l02673"></a>02673                                                 <span class="keywordflow">else</span>      <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(wco, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, w);
<a name="l02674"></a>02674 
<a name="l02675"></a>02675                                                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, wco, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l02676"></a>02676                                                     <span class="keywordflow">continue</span>; <span class="comment">/* Watch out that no code below this needs to run */</span>
<a name="l02677"></a>02677                                                 }
<a name="l02678"></a>02678                                             }
<a name="l02679"></a>02679                                             
<a name="l02680"></a>02680                                             mask = <a class="code" href="../../df/d60/paint__image_8c.html#a3fe8683e840d2767a3f4a7cfe22efe4d">project_paint_uvpixel_mask</a>(ps, face_index, side, w);
<a name="l02681"></a>02681                                             
<a name="l02682"></a>02682                                             <span class="keywordflow">if</span> (mask &gt; 0.0f) {
<a name="l02683"></a>02683                                                 <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(
<a name="l02684"></a>02684                                                         bucketPixelNodes,
<a name="l02685"></a>02685                                                         <a class="code" href="../../df/d60/paint__image_8c.html#a2ce0eb39a3c0adde977984143144630b">project_paint_uvpixel_init</a>(ps, arena, ibuf, x, y, mask, face_index, image_index, pixelScreenCo, side, w),
<a name="l02686"></a>02686                                                         arena
<a name="l02687"></a>02687                                                         );
<a name="l02688"></a>02688                                             }
<a name="l02689"></a>02689                                             
<a name="l02690"></a>02690                                         }
<a name="l02691"></a>02691                                     }
<a name="l02692"></a>02692                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (has_x_isect) {
<a name="l02693"></a>02693                                         <span class="comment">/* assuming the face is not a bow-tie - we know we cant intersect again on the X */</span>
<a name="l02694"></a>02694                                         <span class="keywordflow">break</span>;
<a name="l02695"></a>02695                                     }
<a name="l02696"></a>02696                                 }
<a name="l02697"></a>02697                                 
<a name="l02698"></a>02698 <span class="preprocessor">#if 0                           </span><span class="comment">/* TODO - investigate why this dosnt work sometimes! it should! */</span>
<a name="l02699"></a>02699                                 <span class="comment">/* no intersection for this entire row, after some intersection above means we can quit now */</span>
<a name="l02700"></a>02700                                 <span class="keywordflow">if</span> (has_x_isect == 0 &amp;&amp; has_isect) {
<a name="l02701"></a>02701                                     <span class="keywordflow">break</span>;
<a name="l02702"></a>02702                                 }
<a name="l02703"></a>02703 <span class="preprocessor">#endif</span>
<a name="l02704"></a>02704 <span class="preprocessor"></span>                            }
<a name="l02705"></a>02705                         }
<a name="l02706"></a>02706                     }
<a name="l02707"></a>02707                 }
<a name="l02708"></a>02708             }
<a name="l02709"></a>02709         }
<a name="l02710"></a>02710     }
<a name="l02711"></a>02711 <span class="preprocessor">#endif // PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l02712"></a>02712 <span class="preprocessor"></span>}
<a name="l02713"></a>02713 
<a name="l02714"></a>02714 
<a name="l02715"></a>02715 <span class="comment">/* takes floating point screenspace min/max and returns int min/max to be used as indices for ps-&gt;bucketRect, ps-&gt;bucketFlags */</span>
<a name="l02716"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9c6f9f3a014285c37f9b53be00b992fb">02716</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9c6f9f3a014285c37f9b53be00b992fb">project_paint_bucket_bounds</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[2], <span class="keywordtype">int</span> bucketMin[2], <span class="keywordtype">int</span> bucketMax[2])
<a name="l02717"></a>02717 {
<a name="l02718"></a>02718     <span class="comment">/* divide by bucketWidth &amp; bucketHeight so the bounds are offset in bucket grid units */</span>
<a name="l02719"></a>02719     <span class="comment">/* XXX: the offset of 0.5 is always truncated to zero and the offset of 1.5f is always truncated to 1, is this really correct?? - jwilkins */</span>
<a name="l02720"></a>02720     bucketMin[0] = (int)((<span class="keywordtype">int</span>)(((float)(min[0] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0]) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>) + 0.5f); <span class="comment">/* these offsets of 0.5 and 1.5 seem odd but they are correct */</span>
<a name="l02721"></a>02721     bucketMin[1] = (int)((<span class="keywordtype">int</span>)(((float)(min[1] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1]) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>) + 0.5f);
<a name="l02722"></a>02722     
<a name="l02723"></a>02723     bucketMax[0] = (int)((<span class="keywordtype">int</span>)(((float)(max[0] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0]) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>) + 1.5f);
<a name="l02724"></a>02724     bucketMax[1] = (int)((<span class="keywordtype">int</span>)(((float)(max[1] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1]) / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>) + 1.5f);
<a name="l02725"></a>02725     
<a name="l02726"></a>02726     <span class="comment">/* in case the rect is outside the mesh 2d bounds */</span>
<a name="l02727"></a>02727     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bucketMin[0], 0, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>);
<a name="l02728"></a>02728     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bucketMin[1], 0, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>);
<a name="l02729"></a>02729     
<a name="l02730"></a>02730     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bucketMax[0], 0, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>);
<a name="l02731"></a>02731     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(bucketMax[1], 0, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>);
<a name="l02732"></a>02732 }
<a name="l02733"></a>02733 
<a name="l02734"></a>02734 <span class="comment">/* set bucket_bounds to a screen space-aligned floating point bound-box */</span>
<a name="l02735"></a><a class="code" href="../../df/d60/paint__image_8c.html#aaf0474ab33a5d3aec4be59bea9932955">02735</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#aaf0474ab33a5d3aec4be59bea9932955">project_bucket_bounds</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">int</span> bucket_x, <span class="keyword">const</span> <span class="keywordtype">int</span> bucket_y, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds)
<a name="l02736"></a>02736 {
<a name="l02737"></a>02737     bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] + ((bucket_x) * (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a> / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>));     <span class="comment">/* left */</span>
<a name="l02738"></a>02738     bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] + ((bucket_x + 1) * (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a> / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>)); <span class="comment">/* right */</span>
<a name="l02739"></a>02739     
<a name="l02740"></a>02740     bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] + ((bucket_y) * (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a> / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>));      <span class="comment">/* bottom */</span>
<a name="l02741"></a>02741     bucket_bounds-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] + ((bucket_y + 1) * (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a>  / ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>)); <span class="comment">/* top */</span>
<a name="l02742"></a>02742 }
<a name="l02743"></a>02743 
<a name="l02744"></a>02744 <span class="comment">/* Fill this bucket with pixels from the faces that intersect it.</span>
<a name="l02745"></a>02745 <span class="comment"> * </span>
<a name="l02746"></a>02746 <span class="comment"> * have bucket_bounds as an argument so we don&#39;t need to give bucket_x/y the rect function needs */</span>
<a name="l02747"></a><a class="code" href="../../df/d60/paint__image_8c.html#a76e5f00aad4637c2e05e25cc0f548f29">02747</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a76e5f00aad4637c2e05e25cc0f548f29">project_bucket_init</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">int</span> thread_index, <span class="keyword">const</span> <span class="keywordtype">int</span> bucket_index, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds)
<a name="l02748"></a>02748 {
<a name="l02749"></a>02749     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node;
<a name="l02750"></a>02750     <span class="keywordtype">int</span> face_index, image_index = 0;
<a name="l02751"></a>02751     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02752"></a>02752     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *tpage_last = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *tpage;
<a name="l02753"></a>02753     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02754"></a>02754 
<a name="l02755"></a>02755     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a> == 1) {
<a name="l02756"></a>02756         <span class="comment">/* Simple loop, no context switching */</span>
<a name="l02757"></a>02757         ibuf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[0].<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>;
<a name="l02758"></a>02758         ima = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[0].<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>;
<a name="l02759"></a>02759 
<a name="l02760"></a>02760         <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>[bucket_index]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l02761"></a>02761             <a class="code" href="../../df/d60/paint__image_8c.html#a94aa3b387f040c2b6744501eecd936a0">project_paint_face_init</a>(ps, thread_index, bucket_index, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>), 0, bucket_bounds, ibuf, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a65a2ab2d575be924c225dc2a8f2acf8c">IMA_CLAMP_U</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ab959f7879d4da8113fa214d94c303e73">IMA_CLAMP_V</a>);
<a name="l02762"></a>02762         }
<a name="l02763"></a>02763     }
<a name="l02764"></a>02764     <span class="keywordflow">else</span> {
<a name="l02765"></a>02765         
<a name="l02766"></a>02766         <span class="comment">/* More complicated loop, switch between images */</span>
<a name="l02767"></a>02767         <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>[bucket_index]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l02768"></a>02768             face_index = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>);
<a name="l02769"></a>02769                 
<a name="l02770"></a>02770             <span class="comment">/* Image context switching */</span>
<a name="l02771"></a>02771             tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, face_index);
<a name="l02772"></a>02772             <span class="keywordflow">if</span> (tpage_last != tpage) {
<a name="l02773"></a>02773                 tpage_last = tpage;
<a name="l02774"></a>02774 
<a name="l02775"></a>02775                 <span class="keywordflow">for</span> (image_index = 0; image_index &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; image_index++) {
<a name="l02776"></a>02776                     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[image_index].<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a> == tpage_last) {
<a name="l02777"></a>02777                         ibuf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[image_index].<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>;
<a name="l02778"></a>02778                         ima = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[image_index].<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>;
<a name="l02779"></a>02779                         <span class="keywordflow">break</span>;
<a name="l02780"></a>02780                     }
<a name="l02781"></a>02781                 }
<a name="l02782"></a>02782             }
<a name="l02783"></a>02783             <span class="comment">/* context switching done */</span>
<a name="l02784"></a>02784             
<a name="l02785"></a>02785             <a class="code" href="../../df/d60/paint__image_8c.html#a94aa3b387f040c2b6744501eecd936a0">project_paint_face_init</a>(ps, thread_index, bucket_index, face_index, image_index, bucket_bounds, ibuf, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a65a2ab2d575be924c225dc2a8f2acf8c">IMA_CLAMP_U</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ab959f7879d4da8113fa214d94c303e73">IMA_CLAMP_V</a>);
<a name="l02786"></a>02786         }
<a name="l02787"></a>02787     }
<a name="l02788"></a>02788     
<a name="l02789"></a>02789     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">bucketFlags</a>[bucket_index] |= <a class="code" href="../../df/d60/paint__image_8c.html#ad2d1aa99c0ae8f9c345063878bb2593d">PROJ_BUCKET_INIT</a>;
<a name="l02790"></a>02790 }
<a name="l02791"></a>02791 
<a name="l02792"></a>02792 
<a name="l02793"></a>02793 <span class="comment">/* We want to know if a bucket and a face overlap in screen-space</span>
<a name="l02794"></a>02794 <span class="comment"> * </span>
<a name="l02795"></a>02795 <span class="comment"> * Note, if this ever returns false positives its not that bad, since a face in the bounding area will have its pixels</span>
<a name="l02796"></a>02796 <span class="comment"> * calculated when it might not be needed later, (at the moment at least)</span>
<a name="l02797"></a>02797 <span class="comment"> * obviously it shouldn&#39;t have bugs though */</span>
<a name="l02798"></a>02798 
<a name="l02799"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3b186e713fa624b0a4f0f54c7808adc3">02799</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3b186e713fa624b0a4f0f54c7808adc3">project_bucket_face_isect</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keywordtype">int</span> bucket_x, <span class="keywordtype">int</span> bucket_y, <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf)
<a name="l02800"></a>02800 {
<a name="l02801"></a>02801     <span class="comment">/* TODO - replace this with a tricker method that uses sideofline for all screenCoords&#39;s edges against the closest bucket corner */</span>
<a name="l02802"></a>02802     <a class="code" href="../../da/d10/structrctf.html">rctf</a> bucket_bounds;
<a name="l02803"></a>02803     <span class="keywordtype">float</span> p1[2], p2[2], p3[2], p4[2];
<a name="l02804"></a>02804     <span class="keywordtype">float</span> *v, *v1, *v2, *v3, *v4 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02805"></a>02805     <span class="keywordtype">int</span> fidx;
<a name="l02806"></a>02806     
<a name="l02807"></a>02807     <a class="code" href="../../df/d60/paint__image_8c.html#aaf0474ab33a5d3aec4be59bea9932955">project_bucket_bounds</a>(ps, bucket_x, bucket_y, &amp;bucket_bounds);
<a name="l02808"></a>02808     
<a name="l02809"></a>02809     <span class="comment">/* Is one of the faces verts in the bucket bounds? */</span>
<a name="l02810"></a>02810     
<a name="l02811"></a>02811     fidx = mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 3 : 2;
<a name="l02812"></a>02812     <span class="keywordflow">do</span> {
<a name="l02813"></a>02813         v = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[(*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + fidx))];
<a name="l02814"></a>02814         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>(&amp;bucket_bounds, v[0], v[1])) {
<a name="l02815"></a>02815             <span class="keywordflow">return</span> 1;
<a name="l02816"></a>02816         }
<a name="l02817"></a>02817     } <span class="keywordflow">while</span> (fidx--);
<a name="l02818"></a>02818     
<a name="l02819"></a>02819     v1 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l02820"></a>02820     v2 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l02821"></a>02821     v3 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l02822"></a>02822     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02823"></a>02823         v4 = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l02824"></a>02824     }
<a name="l02825"></a>02825     
<a name="l02826"></a>02826     p1[0] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>; p1[1] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l02827"></a>02827     p2[0] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>; p2[1] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l02828"></a>02828     p3[0] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>; p3[1] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l02829"></a>02829     p4[0] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>; p4[1] = bucket_bounds.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l02830"></a>02830         
<a name="l02831"></a>02831     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02832"></a>02832         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(p1, v1, v2, v3, v4) ||
<a name="l02833"></a>02833             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(p2, v1, v2, v3, v4) ||
<a name="l02834"></a>02834             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(p3, v1, v2, v3, v4) ||
<a name="l02835"></a>02835             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(p4, v1, v2, v3, v4) ||
<a name="l02836"></a>02836 
<a name="l02837"></a>02837             <span class="comment">/* we can avoid testing v3,v1 because another intersection MUST exist if this intersects */</span>
<a name="l02838"></a>02838             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p1, p2, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p1, p2, v2, v3) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p1, p2, v3, v4)) ||
<a name="l02839"></a>02839             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p2, p3, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p2, p3, v2, v3) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p2, p3, v3, v4)) ||
<a name="l02840"></a>02840             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p3, p4, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p3, p4, v2, v3) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p3, p4, v3, v4)) ||
<a name="l02841"></a>02841             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p4, p1, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p4, p1, v2, v3) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p4, p1, v3, v4)))
<a name="l02842"></a>02842         {
<a name="l02843"></a>02843             <span class="keywordflow">return</span> 1;
<a name="l02844"></a>02844         }
<a name="l02845"></a>02845     }
<a name="l02846"></a>02846     <span class="keywordflow">else</span> {
<a name="l02847"></a>02847         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(p1, v1, v2, v3) ||
<a name="l02848"></a>02848             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(p2, v1, v2, v3) ||
<a name="l02849"></a>02849             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(p3, v1, v2, v3) ||
<a name="l02850"></a>02850             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(p4, v1, v2, v3) ||
<a name="l02851"></a>02851             <span class="comment">/* we can avoid testing v3,v1 because another intersection MUST exist if this intersects */</span>
<a name="l02852"></a>02852             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p1, p2, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p1, p2, v2, v3)) ||
<a name="l02853"></a>02853             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p2, p3, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p2, p3, v2, v3)) ||
<a name="l02854"></a>02854             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p3, p4, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p3, p4, v2, v3)) ||
<a name="l02855"></a>02855             (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p4, p1, v1, v2) || <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(p4, p1, v2, v3)))
<a name="l02856"></a>02856         {
<a name="l02857"></a>02857             <span class="keywordflow">return</span> 1;
<a name="l02858"></a>02858         }
<a name="l02859"></a>02859     }
<a name="l02860"></a>02860 
<a name="l02861"></a>02861     <span class="keywordflow">return</span> 0;
<a name="l02862"></a>02862 }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864 <span class="comment">/* Add faces to the bucket but don&#39;t initialize its pixels</span>
<a name="l02865"></a>02865 <span class="comment"> * TODO - when painting occluded, sort the faces on their min-Z and only add faces that faces that are not occluded */</span>
<a name="l02866"></a><a class="code" href="../../df/d60/paint__image_8c.html#a61edb43f324dcd0d8bdd655c484d2689">02866</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a61edb43f324dcd0d8bdd655c484d2689">project_paint_delayed_face_init</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf, <span class="keyword">const</span> <span class="keywordtype">int</span> face_index)
<a name="l02867"></a>02867 {
<a name="l02868"></a>02868     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[2], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[2], *vCoSS;
<a name="l02869"></a>02869     <span class="keywordtype">int</span> bucketMin[2], bucketMax[2]; <span class="comment">/* for  ps-&gt;bucketRect indexing */</span>
<a name="l02870"></a>02870     <span class="keywordtype">int</span> fidx, bucket_x, bucket_y;
<a name="l02871"></a>02871     <span class="keywordtype">int</span> has_x_isect = -1, has_isect = 0; <span class="comment">/* for early loop exit */</span>
<a name="l02872"></a>02872     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[0]; <span class="comment">/* just use the first thread arena since threading has not started yet */</span>
<a name="l02873"></a>02873     
<a name="l02874"></a>02874     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1a74cc7bfb4a5b9eda1fb38c3fbb51c1">INIT_MINMAX2</a>(min, max);
<a name="l02875"></a>02875     
<a name="l02876"></a>02876     fidx = mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 3 : 2;
<a name="l02877"></a>02877     <span class="keywordflow">do</span> {
<a name="l02878"></a>02878         vCoSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + fidx)];
<a name="l02879"></a>02879         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(vCoSS, min, max);
<a name="l02880"></a>02880     } <span class="keywordflow">while</span> (fidx--);
<a name="l02881"></a>02881     
<a name="l02882"></a>02882     <a class="code" href="../../df/d60/paint__image_8c.html#a9c6f9f3a014285c37f9b53be00b992fb">project_paint_bucket_bounds</a>(ps, min, max, bucketMin, bucketMax);
<a name="l02883"></a>02883     
<a name="l02884"></a>02884     <span class="keywordflow">for</span> (bucket_y = bucketMin[1]; bucket_y &lt; bucketMax[1]; bucket_y++) {
<a name="l02885"></a>02885         has_x_isect = 0;
<a name="l02886"></a>02886         <span class="keywordflow">for</span> (bucket_x = bucketMin[0]; bucket_x &lt; bucketMax[0]; bucket_x++) {
<a name="l02887"></a>02887             <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a3b186e713fa624b0a4f0f54c7808adc3">project_bucket_face_isect</a>(ps, bucket_x, bucket_y, mf)) {
<a name="l02888"></a>02888                 <span class="keywordtype">int</span> bucket_index = bucket_x + (bucket_y * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>);
<a name="l02889"></a>02889                 <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(
<a name="l02890"></a>02890                         &amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>[bucket_index],
<a name="l02891"></a>02891                         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(face_index), <span class="comment">/* cast to a pointer to shut up the compiler */</span>
<a name="l02892"></a>02892                         arena
<a name="l02893"></a>02893                         );
<a name="l02894"></a>02894                 
<a name="l02895"></a>02895                 has_x_isect = has_isect = 1;
<a name="l02896"></a>02896             }
<a name="l02897"></a>02897             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (has_x_isect) {
<a name="l02898"></a>02898                 <span class="comment">/* assuming the face is not a bow-tie - we know we cant intersect again on the X */</span>
<a name="l02899"></a>02899                 <span class="keywordflow">break</span>;
<a name="l02900"></a>02900             }
<a name="l02901"></a>02901         }
<a name="l02902"></a>02902         
<a name="l02903"></a>02903         <span class="comment">/* no intersection for this entire row, after some intersection above means we can quit now */</span>
<a name="l02904"></a>02904         <span class="keywordflow">if</span> (has_x_isect == 0 &amp;&amp; has_isect) {
<a name="l02905"></a>02905             <span class="keywordflow">break</span>;
<a name="l02906"></a>02906         }
<a name="l02907"></a>02907     }
<a name="l02908"></a>02908     
<a name="l02909"></a>02909 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l02910"></a>02910 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> &gt; 0.0f) {
<a name="l02911"></a>02911         <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02912"></a>02912             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>[face_index] |= <a class="code" href="../../df/d60/paint__image_8c.html#a6032595ab69e857e67e783a11a361f77">PROJ_FACE_NOSEAM4</a>; <span class="comment">/* so this wont show up as an untagged edge */</span>
<a name="l02913"></a>02913         }
<a name="l02914"></a>02914         **ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">faceSeamUVs</a>[face_index] = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>; <span class="comment">/* set as uninitialized */</span>
<a name="l02915"></a>02915     }
<a name="l02916"></a>02916 <span class="preprocessor">#endif</span>
<a name="l02917"></a>02917 <span class="preprocessor"></span>}
<a name="l02918"></a>02918 
<a name="l02919"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9e7a7981ddcd6ac0cb6b5899ea208b35">02919</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9e7a7981ddcd6ac0cb6b5899ea208b35">project_paint_view_clip</a>(<a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d, <span class="keywordtype">float</span> *clipsta, <span class="keywordtype">float</span> *clipend)
<a name="l02920"></a>02920 {
<a name="l02921"></a>02921     <span class="keywordtype">int</span> <a class="code" href="../../d8/d33/btConvexHull_8cpp.html#afce09874f19dc3bb6d742f1f52fd8bb0">orth</a> = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1c3f804a2b06362e3a9704c9b932f011">ED_view3d_clip_range_get</a>(v3d, rv3d, clipsta, clipend);
<a name="l02922"></a>02922 
<a name="l02923"></a>02923     <span class="keywordflow">if</span> (orth) { <span class="comment">/* only needed for ortho */</span>
<a name="l02924"></a>02924         <span class="keywordtype">float</span> fac = 2.0f / ((*clipend) - (*clipsta));
<a name="l02925"></a>02925         *clipsta *= fac;
<a name="l02926"></a>02926         *clipend *= fac;
<a name="l02927"></a>02927     }
<a name="l02928"></a>02928 
<a name="l02929"></a>02929     <span class="keywordflow">return</span> <a class="code" href="../../d8/d33/btConvexHull_8cpp.html#afce09874f19dc3bb6d742f1f52fd8bb0">orth</a>;
<a name="l02930"></a>02930 }
<a name="l02931"></a>02931 
<a name="l02932"></a>02932 <span class="comment">/* run once per stroke before projection painting */</span>
<a name="l02933"></a><a class="code" href="../../df/d60/paint__image_8c.html#a34cdbe9457ea478ebb874465579b95ac">02933</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a34cdbe9457ea478ebb874465579b95ac">project_paint_begin</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps)
<a name="l02934"></a>02934 {   
<a name="l02935"></a>02935     <span class="comment">/* Viewport vars */</span>
<a name="l02936"></a>02936     <span class="keywordtype">float</span> mat[3][3];
<a name="l02937"></a>02937     
<a name="l02938"></a>02938     <span class="keywordtype">float</span> no[3];
<a name="l02939"></a>02939     
<a name="l02940"></a>02940     <span class="keywordtype">float</span> *projScreenCo; <span class="comment">/* Note, we could have 4D vectors are only needed for */</span>
<a name="l02941"></a>02941     <span class="keywordtype">float</span> projMargin;
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     <span class="comment">/* Image Vars - keep track of images we have used */</span>
<a name="l02944"></a>02944     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *image_LinkList = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02945"></a>02945     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node;
<a name="l02946"></a>02946     
<a name="l02947"></a>02947     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *projIma;
<a name="l02948"></a>02948     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *tpage_last = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *tpage;
<a name="l02949"></a>02949     
<a name="l02950"></a>02950     <span class="comment">/* Face vars */</span>
<a name="l02951"></a>02951     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l02952"></a>02952     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf;
<a name="l02953"></a>02953     
<a name="l02954"></a>02954     <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; <span class="comment">/* generic looping vars */</span>
<a name="l02955"></a>02955     <span class="keywordtype">int</span> image_index = -1, face_index;
<a name="l02956"></a>02956     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv;
<a name="l02957"></a>02957     
<a name="l02958"></a>02958     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena; <span class="comment">/* at the moment this is just ps-&gt;arena_mt[0], but use this to show were not multithreading */</span>
<a name="l02959"></a>02959 
<a name="l02960"></a>02960     <span class="keyword">const</span> <span class="keywordtype">int</span> diameter = 2 * <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l02961"></a>02961     
<a name="l02962"></a>02962     <span class="comment">/* ---- end defines ---- */</span>
<a name="l02963"></a>02963     
<a name="l02964"></a>02964     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>)
<a name="l02965"></a>02965         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#af23af849d7708b6c8c92edc20bb450af">ED_view3d_clipping_local</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);  <span class="comment">/* faster clipping lookups */</span>
<a name="l02966"></a>02966 
<a name="l02967"></a>02967     <span class="comment">/* paint onto the derived mesh */</span>
<a name="l02968"></a>02968     
<a name="l02969"></a>02969     <span class="comment">/* Workaround for subsurf selection, try the display mesh first */</span>
<a name="l02970"></a>02970     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#a56b7a4e1251c26a2406c0ee3cda5d93c">PROJ_SRC_IMAGE_CAM</a>) {
<a name="l02971"></a>02971         <span class="comment">/* using render mesh, assume only camera was rendered from */</span>
<a name="l02972"></a>02972         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aeade9a199706a910fa3a5593b49cdbdf">mesh_create_derived_render</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a3a4f81e0f2023f6834ccb638ed26cd0c">customdata_mask</a> | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>);
<a name="l02973"></a>02973         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02974"></a>02974     }
<a name="l02975"></a>02975     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a> &amp;&amp; <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>)) {
<a name="l02976"></a>02976         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l02977"></a>02977         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02978"></a>02978     }
<a name="l02979"></a>02979     <span class="keywordflow">else</span> {
<a name="l02980"></a>02980         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a3a4f81e0f2023f6834ccb638ed26cd0c">customdata_mask</a> | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>);
<a name="l02981"></a>02981         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02982"></a>02982     }
<a name="l02983"></a>02983     
<a name="l02984"></a>02984     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>) ) {
<a name="l02985"></a>02985         
<a name="l02986"></a>02986         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a>)
<a name="l02987"></a>02987             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l02988"></a>02988         
<a name="l02989"></a>02989         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02990"></a>02990         <span class="keywordflow">return</span>; 
<a name="l02991"></a>02991     }
<a name="l02992"></a>02992     
<a name="l02993"></a>02993     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l02994"></a>02994     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l02995"></a>02995     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l02996"></a>02996     
<a name="l02997"></a>02997     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">dm_totvert</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l02998"></a>02998     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cd37e0a44900d9668ec1f3df174d4d7">dm_totface</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l02999"></a>02999     
<a name="l03000"></a>03000     <span class="comment">/* use clone mtface? */</span>
<a name="l03001"></a>03001     
<a name="l03002"></a>03002     
<a name="l03003"></a>03003     <span class="comment">/* Note, use the original mesh for getting the clone and mask layer index</span>
<a name="l03004"></a>03004 <span class="comment">     * this avoids re-generating the derived mesh just to get the new index */</span>
<a name="l03005"></a>03005     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a3d27fb6e59636e9ec4305ab594028bb2">do_layer_clone</a>) {
<a name="l03006"></a>03006         <span class="comment">//int layer_num = CustomData_get_clone_layer(&amp;ps-&gt;dm-&gt;faceData, CD_MTFACE);</span>
<a name="l03007"></a>03007         <span class="keywordtype">int</span> layer_num = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1f22de5d08ace60f042e3a6a95f8ae8b">CustomData_get_clone_layer</a>(&amp;((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;fdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l03008"></a>03008         <span class="keywordflow">if</span> (layer_num != -1)
<a name="l03009"></a>03009             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa4f16a171b314c81058a73acdd45388b">CustomData_get_layer_n</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, layer_num);
<a name="l03010"></a>03010         
<a name="l03011"></a>03011         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> == ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>) {
<a name="l03012"></a>03012             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a3d27fb6e59636e9ec4305ab594028bb2">do_layer_clone</a> = 0;
<a name="l03013"></a>03013             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03014"></a>03014             printf(<span class="stringliteral">&quot;ACK!\n&quot;</span>);
<a name="l03015"></a>03015         }
<a name="l03016"></a>03016     }
<a name="l03017"></a>03017     
<a name="l03018"></a>03018     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">do_layer_stencil</a>) {
<a name="l03019"></a>03019         <span class="comment">//int layer_num = CustomData_get_stencil_layer(&amp;ps-&gt;dm-&gt;faceData, CD_MTFACE);</span>
<a name="l03020"></a>03020         <span class="keywordtype">int</span> layer_num = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a78d04fd850007c92f4e30100f0a1f937">CustomData_get_stencil_layer</a>(&amp;((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;fdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l03021"></a>03021         <span class="keywordflow">if</span> (layer_num != -1)
<a name="l03022"></a>03022             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa4f16a171b314c81058a73acdd45388b">CustomData_get_layer_n</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, layer_num);
<a name="l03023"></a>03023         
<a name="l03024"></a>03024         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> == ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>) {
<a name="l03025"></a>03025             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">do_layer_stencil</a> = 0;
<a name="l03026"></a>03026             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03027"></a>03027         }
<a name="l03028"></a>03028     }
<a name="l03029"></a>03029     
<a name="l03030"></a>03030     <span class="comment">/* when using subsurf or multires, mface arrays are thrown away, we need to keep a copy */</span>
<a name="l03031"></a>03031     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> != <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>) {
<a name="l03032"></a>03032         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>);
<a name="l03033"></a>03033         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a>);
<a name="l03034"></a>03034         <span class="comment">/* looks like these are ok for now.*/</span>
<a name="l03035"></a>03035 <span class="preprocessor">#if 0</span>
<a name="l03036"></a>03036 <span class="preprocessor"></span>        ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>);
<a name="l03037"></a>03037         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>);
<a name="l03038"></a>03038         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a>);
<a name="l03039"></a>03039 <span class="preprocessor">#endif</span>
<a name="l03040"></a>03040 <span class="preprocessor"></span>    }
<a name="l03041"></a>03041     
<a name="l03042"></a>03042     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>[0] = 0.0f;
<a name="l03043"></a>03043     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>[1] = 0.0f;
<a name="l03044"></a>03044     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>[2] = 1.0f;
<a name="l03045"></a>03045     
<a name="l03046"></a>03046     {
<a name="l03047"></a>03047         <span class="keywordtype">float</span> viewmat[4][4];
<a name="l03048"></a>03048         <span class="keywordtype">float</span> viewinv[4][4];
<a name="l03049"></a>03049 
<a name="l03050"></a>03050         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03051"></a>03051 
<a name="l03052"></a>03052         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>) {
<a name="l03053"></a>03053             <span class="comment">/* normal drawing */</span>
<a name="l03054"></a>03054             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a64c03981e25b7657c2fc6878f52e8b08">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l03055"></a>03055             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a64c03981e25b7657c2fc6878f52e8b08">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l03056"></a>03056 
<a name="l03057"></a>03057             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(viewmat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l03058"></a>03058             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(viewinv, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>);
<a name="l03059"></a>03059 
<a name="l03060"></a>03060             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a282c83136349eb4ba6c6dfb330a14440">ED_view3d_ob_project_mat_get</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>);
<a name="l03061"></a>03061 
<a name="l03062"></a>03062             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a9e7a7981ddcd6ac0cb6b5899ea208b35">project_paint_view_clip</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">v3d</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a>, &amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">clipsta</a>, &amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ada08bc0948d0a0716e250a286ddc154e">clipend</a>);
<a name="l03063"></a>03063         }
<a name="l03064"></a>03064         <span class="keywordflow">else</span> {
<a name="l03065"></a>03065             <span class="comment">/* re-projection */</span>
<a name="l03066"></a>03066             <span class="keywordtype">float</span> winmat[4][4];
<a name="l03067"></a>03067             <span class="keywordtype">float</span> vmat[4][4];
<a name="l03068"></a>03068 
<a name="l03069"></a>03069             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l03070"></a>03070             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l03071"></a>03071 
<a name="l03072"></a>03072             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#a69cb721f7bda43a05e29c407e0eebf3e">PROJ_SRC_IMAGE_VIEW</a>) {
<a name="l03073"></a>03073                 <span class="comment">/* image stores camera data, tricky */</span>
<a name="l03074"></a>03074                 <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *idgroup = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#a6abd6d3d5bf8145c0b4d29166e938b11">IDP_GetProperties</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaf5c49e6159a42c0311a6cbf1ca3f5">reproject_image</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, 0);
<a name="l03075"></a>03075                 <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *view_data = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#abf2facca64e1d32419686163fb1b0414">IDP_GetPropertyFromGroup</a>(idgroup, <a class="code" href="../../df/d60/paint__image_8c.html#aacaf081d26a03b460ceb39111eaa9194">PROJ_VIEW_DATA_ID</a>);
<a name="l03076"></a>03076 
<a name="l03077"></a>03077                 <span class="keywordtype">float</span> *<a class="code" href="../../d2/d41/classarray.html">array</a> = (<span class="keywordtype">float</span> *)<a class="code" href="../../d5/d95/BKE__idprop_8h.html#afcd801b64d87f8967273ddd406377549">IDP_Array</a>(view_data);
<a name="l03078"></a>03078 
<a name="l03079"></a>03079                 <span class="comment">/* use image array, written when creating image */</span>
<a name="l03080"></a>03080                 memcpy(winmat, array, <span class="keyword">sizeof</span>(winmat)); array += <span class="keyword">sizeof</span>(winmat) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);
<a name="l03081"></a>03081                 memcpy(viewmat, array, <span class="keyword">sizeof</span>(viewmat)); array += <span class="keyword">sizeof</span>(viewmat) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);
<a name="l03082"></a>03082                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">clipsta</a> = array[0];
<a name="l03083"></a>03083                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ada08bc0948d0a0716e250a286ddc154e">clipend</a> = array[1];
<a name="l03084"></a>03084                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a> = array[2] ? 1 : 0;
<a name="l03085"></a>03085 
<a name="l03086"></a>03086                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(viewinv, viewmat);
<a name="l03087"></a>03087             }
<a name="l03088"></a>03088             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#a56b7a4e1251c26a2406c0ee3cda5d93c">PROJ_SRC_IMAGE_CAM</a>) {
<a name="l03089"></a>03089                 <a class="code" href="../../de/de7/structObject.html">Object</a> *cam_ob = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>;
<a name="l03090"></a>03090                 <a class="code" href="../../d4/daf/structCameraParams.html">CameraParams</a> params;
<a name="l03091"></a>03091 
<a name="l03092"></a>03092                 <span class="comment">/* viewmat &amp; viewinv */</span>
<a name="l03093"></a>03093                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(viewinv, cam_ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03094"></a>03094                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(viewinv);
<a name="l03095"></a>03095                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(viewmat, viewinv);
<a name="l03096"></a>03096 
<a name="l03097"></a>03097                 <span class="comment">/* window matrix, clipping and ortho */</span>
<a name="l03098"></a>03098                 <a class="code" href="../../d2/dff/BKE__camera_8h.html#a114faeb2a77048e814e5a120d29026b3">camera_params_init</a>(&amp;params);
<a name="l03099"></a>03099                 <a class="code" href="../../d2/dff/BKE__camera_8h.html#ac561da82b9e128bc2020a2d4e4d2ddd8">camera_params_from_object</a>(&amp;params, cam_ob);
<a name="l03100"></a>03100                 <a class="code" href="../../d2/dff/BKE__camera_8h.html#af290ff2b9dc901aae0f54d62f44c0e1a">camera_params_compute_viewplane</a>(&amp;params, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a>, 1.0f, 1.0f);
<a name="l03101"></a>03101                 <a class="code" href="../../d2/dff/BKE__camera_8h.html#a892ebdf01c9cd451ee7244f472dcaba3">camera_params_compute_matrix</a>(&amp;params);
<a name="l03102"></a>03102 
<a name="l03103"></a>03103                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, params.<a class="code" href="../../d4/daf/structCameraParams.html#a231ce565968a26a1ec032de9d5940a89">winmat</a>);
<a name="l03104"></a>03104                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">clipsta</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#a6fdd84ec4312347929d3b560fd1f603e">clipsta</a>;
<a name="l03105"></a>03105                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ada08bc0948d0a0716e250a286ddc154e">clipend</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#addd6d77879aab2484838c2c66861422e">clipend</a>;
<a name="l03106"></a>03106                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#a360670b5b20df46648686f386e1fc2d2">is_ortho</a>;
<a name="l03107"></a>03107             }
<a name="l03108"></a>03108 
<a name="l03109"></a>03109             <span class="comment">/* same as view3d_get_object_project_mat */</span>
<a name="l03110"></a>03110             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(vmat, viewmat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03111"></a>03111             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>, winmat, vmat);
<a name="l03112"></a>03112         }
<a name="l03113"></a>03113 
<a name="l03114"></a>03114 
<a name="l03115"></a>03115         <span class="comment">/* viewDir - object relative */</span>
<a name="l03116"></a>03116         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03117"></a>03117         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mat, viewinv);
<a name="l03118"></a>03118         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(mat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>);
<a name="l03119"></a>03119         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l03120"></a>03120         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(mat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>);
<a name="l03121"></a>03121         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>);
<a name="l03122"></a>03122         
<a name="l03123"></a>03123         <span class="comment">/* viewPos - object relative */</span>
<a name="l03124"></a>03124         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>, viewinv[3]);
<a name="l03125"></a>03125         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(mat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l03126"></a>03126         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(mat, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>);
<a name="l03127"></a>03127         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>[3]);
<a name="l03128"></a>03128     }
<a name="l03129"></a>03129     
<a name="l03130"></a>03130     <span class="comment">/* calculate vert screen coords</span>
<a name="l03131"></a>03131 <span class="comment">     * run this early so we can calculate the x/y resolution of our bucket rect */</span>
<a name="l03132"></a>03132     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1a74cc7bfb4a5b9eda1fb38c3fbb51c1">INIT_MINMAX2</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>);
<a name="l03133"></a>03133     
<a name="l03134"></a>03134     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">dm_totvert</a> * 4, <span class="stringliteral">&quot;ProjectPaint ScreenVerts&quot;</span>);
<a name="l03135"></a>03135     projScreenCo = *ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>;
<a name="l03136"></a>03136     
<a name="l03137"></a>03137     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) {
<a name="l03138"></a>03138         <span class="keywordflow">for</span> (a = 0, mv = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>; a &lt; ps-&gt;dm_totvert; a++, mv++, projScreenCo += 4) {
<a name="l03139"></a>03139             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(projScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03140"></a>03140             
<a name="l03141"></a>03141             <span class="comment">/* screen space, not clamped */</span>
<a name="l03142"></a>03142             projScreenCo[0] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) * projScreenCo[0];
<a name="l03143"></a>03143             projScreenCo[1] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) * projScreenCo[1];
<a name="l03144"></a>03144             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(projScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>);
<a name="l03145"></a>03145         }
<a name="l03146"></a>03146     }
<a name="l03147"></a>03147     <span class="keywordflow">else</span> {
<a name="l03148"></a>03148         <span class="keywordflow">for</span> (a = 0, mv = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>; a &lt; ps-&gt;dm_totvert; a++, mv++, projScreenCo += 4) {
<a name="l03149"></a>03149             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(projScreenCo, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03150"></a>03150             projScreenCo[3] = 1.0f;
<a name="l03151"></a>03151 
<a name="l03152"></a>03152             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>, projScreenCo);
<a name="l03153"></a>03153 
<a name="l03154"></a>03154             <span class="keywordflow">if</span> (projScreenCo[3] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a550d8cc2d8e47f73827ef2b2cd8d6dfd">clipsta</a>) {
<a name="l03155"></a>03155                 <span class="comment">/* screen space, not clamped */</span>
<a name="l03156"></a>03156                 projScreenCo[0] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) * projScreenCo[0] / projScreenCo[3];
<a name="l03157"></a>03157                 projScreenCo[1] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) * projScreenCo[1] / projScreenCo[3];
<a name="l03158"></a>03158                 projScreenCo[2] = projScreenCo[2] / projScreenCo[3]; <span class="comment">/* Use the depth for bucket point occlusion */</span>
<a name="l03159"></a>03159                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1b61fa5351fa5319daed9bf7cab6f331">DO_MINMAX2</a>(projScreenCo, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>);
<a name="l03160"></a>03160             }
<a name="l03161"></a>03161             <span class="keywordflow">else</span> {
<a name="l03162"></a>03162                 <span class="comment">/* TODO - deal with cases where 1 side of a face goes behind the view ?</span>
<a name="l03163"></a>03163 <span class="comment">                 * </span>
<a name="l03164"></a>03164 <span class="comment">                 * After some research this is actually very tricky, only option is to</span>
<a name="l03165"></a>03165 <span class="comment">                 * clip the derived mesh before painting, which is a Pain */</span>
<a name="l03166"></a>03166                 projScreenCo[0] = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l03167"></a>03167             }
<a name="l03168"></a>03168         }
<a name="l03169"></a>03169     }
<a name="l03170"></a>03170     
<a name="l03171"></a>03171     <span class="comment">/* If this border is not added we get artifacts for faces that</span>
<a name="l03172"></a>03172 <span class="comment">     * have a parallel edge and at the bounds of the the 2D projected verts eg</span>
<a name="l03173"></a>03173 <span class="comment">     * - a single screen aligned quad */</span>
<a name="l03174"></a>03174     projMargin = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0]) * 0.000001f;
<a name="l03175"></a>03175     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] += projMargin;
<a name="l03176"></a>03176     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] -= projMargin;
<a name="l03177"></a>03177     projMargin = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1]) * 0.000001f;
<a name="l03178"></a>03178     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] += projMargin;
<a name="l03179"></a>03179     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] -= projMargin;
<a name="l03180"></a>03180     
<a name="l03181"></a>03181     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>) {
<a name="l03182"></a>03182 <span class="preprocessor">#ifdef PROJ_DEBUG_WINCLIP</span>
<a name="l03183"></a>03183 <span class="preprocessor"></span>        <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0], (<span class="keywordtype">float</span>)(-diameter), (<span class="keywordtype">float</span>)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> + diameter));
<a name="l03184"></a>03184         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0], (<span class="keywordtype">float</span>)(-diameter), (<span class="keywordtype">float</span>)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> + diameter));
<a name="l03185"></a>03185 
<a name="l03186"></a>03186         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1], (<span class="keywordtype">float</span>)(-diameter), (<span class="keywordtype">float</span>)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> + diameter));
<a name="l03187"></a>03187         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1], (<span class="keywordtype">float</span>)(-diameter), (<span class="keywordtype">float</span>)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> + diameter));
<a name="l03188"></a>03188 <span class="preprocessor">#endif</span>
<a name="l03189"></a>03189 <span class="preprocessor"></span>    }
<a name="l03190"></a>03190     <span class="keywordflow">else</span> { <span class="comment">/* re-projection, use bounds */</span>
<a name="l03191"></a>03191         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] = 0;
<a name="l03192"></a>03192         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a>);
<a name="l03193"></a>03193 
<a name="l03194"></a>03194         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] = 0;
<a name="l03195"></a>03195         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] = (float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a>);
<a name="l03196"></a>03196     }
<a name="l03197"></a>03197 
<a name="l03198"></a>03198     <span class="comment">/* only for convenience */</span>
<a name="l03199"></a>03199     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a>  = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0];
<a name="l03200"></a>03200     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1];
<a name="l03201"></a>03201     
<a name="l03202"></a>03202     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> = (int)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac26ba74bfcffdc81efe86057869808bb">screen_width</a> / (((<span class="keywordtype">float</span>)diameter) / <a class="code" href="../../df/d60/paint__image_8c.html#a5cc4f9d4314bedd223adbc70746691ae">PROJ_BUCKET_BRUSH_DIV</a>));
<a name="l03203"></a>03203     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a> = (int)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aba60017f72d7665c695ea2855315490f">screen_height</a> / (((<span class="keywordtype">float</span>)diameter) / <a class="code" href="../../df/d60/paint__image_8c.html#a5cc4f9d4314bedd223adbc70746691ae">PROJ_BUCKET_BRUSH_DIV</a>));
<a name="l03204"></a>03204     
<a name="l03205"></a>03205     <span class="comment">/* printf(&quot;\tscreenspace bucket division x:%d y:%d\n&quot;, ps-&gt;buckets_x, ps-&gt;buckets_y); */</span>
<a name="l03206"></a>03206     
<a name="l03207"></a>03207     <span class="comment">/* really high values could cause problems since it has to allocate a few</span>
<a name="l03208"></a>03208 <span class="comment">     * (ps-&gt;buckets_x*ps-&gt;buckets_y) sized arrays  */</span>
<a name="l03209"></a>03209     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a7a736a6d57923d56412ba6265d9191e3">PROJ_BUCKET_RECT_MIN</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a6230c970e9181f1236493d5aa6666ab3">PROJ_BUCKET_RECT_MAX</a>);
<a name="l03210"></a>03210     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a7a736a6d57923d56412ba6265d9191e3">PROJ_BUCKET_RECT_MIN</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a6230c970e9181f1236493d5aa6666ab3">PROJ_BUCKET_RECT_MAX</a>);
<a name="l03211"></a>03211     
<a name="l03212"></a>03212     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a> = (<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>, <span class="stringliteral">&quot;paint-bucketRect&quot;</span>);
<a name="l03213"></a>03213     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a> = (<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>, <span class="stringliteral">&quot;paint-bucketFaces&quot;</span>);
<a name="l03214"></a>03214     
<a name="l03215"></a>03215     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">bucketFlags</a> = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>, <span class="stringliteral">&quot;paint-bucketFaces&quot;</span>);
<a name="l03216"></a>03216 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l03217"></a>03217 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> &gt; 0.0f) {
<a name="l03218"></a>03218         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a> = (<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">dm_totvert</a>, <span class="stringliteral">&quot;paint-vertFaces&quot;</span>);
<a name="l03219"></a>03219         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a> = (<span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cd37e0a44900d9668ec1f3df174d4d7">dm_totface</a>, <span class="stringliteral">&quot;paint-faceSeamFlags&quot;</span>);
<a name="l03220"></a>03220         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">faceSeamUVs</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cd37e0a44900d9668ec1f3df174d4d7">dm_totface</a> * 8, <span class="stringliteral">&quot;paint-faceSeamUVs&quot;</span>);
<a name="l03221"></a>03221     }
<a name="l03222"></a>03222 <span class="preprocessor">#endif</span>
<a name="l03223"></a>03223 <span class="preprocessor"></span>    
<a name="l03224"></a>03224     <span class="comment">/* Thread stuff</span>
<a name="l03225"></a>03225 <span class="comment">     * </span>
<a name="l03226"></a>03226 <span class="comment">     * very small brushes run a lot slower multithreaded since the advantage with</span>
<a name="l03227"></a>03227 <span class="comment">     * threads is being able to fill in multiple buckets at once.</span>
<a name="l03228"></a>03228 <span class="comment">     * Only use threads for bigger brushes. */</span>
<a name="l03229"></a>03229     
<a name="l03230"></a>03230     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a821a3940a952444838528ee450075408">R_FIXED_THREADS</a>) {
<a name="l03231"></a>03231         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>;
<a name="l03232"></a>03232     }
<a name="l03233"></a>03233     <span class="keywordflow">else</span> {
<a name="l03234"></a>03234         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> = <a class="code" href="../../df/dbb/BLI__threads_8h.html#a7c7ea80a0fb6cafac205997f51079745">BLI_system_thread_count</a>();
<a name="l03235"></a>03235     }
<a name="l03236"></a>03236     <span class="keywordflow">for</span> (a = 0; a &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>; a++) {
<a name="l03237"></a>03237         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[a] = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(1 &lt;&lt; 16, <span class="stringliteral">&quot;project paint arena&quot;</span>);
<a name="l03238"></a>03238     }
<a name="l03239"></a>03239     
<a name="l03240"></a>03240     arena = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[0]; 
<a name="l03241"></a>03241     
<a name="l03242"></a>03242     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">do_backfacecull</a> &amp;&amp; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a>) {
<a name="l03243"></a>03243         <span class="keywordtype">float</span> viewDirPersp[3];
<a name="l03244"></a>03244         
<a name="l03245"></a>03245         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a369924df1d8eaf2bde87cc67240ea827">dm_totvert</a>, <span class="stringliteral">&quot;paint-vertFlags&quot;</span>);
<a name="l03246"></a>03246         
<a name="l03247"></a>03247         <span class="keywordflow">for</span> (a = 0, mv = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>; a &lt; ps-&gt;dm_totvert; a++, mv++) {
<a name="l03248"></a>03248             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(no, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>);
<a name="l03249"></a>03249             
<a name="l03250"></a>03250             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) {
<a name="l03251"></a>03251                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4a2003033c639cab3de101b1cfe7a595">angle_normalized_v3v3</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac0752b86a6cd591611ab5b2dba3e7028">viewDir</a>, no) &gt;= ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a>) { <span class="comment">/* 1 vert of this face is towards us */</span>
<a name="l03252"></a>03252                     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[a] |= <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>;
<a name="l03253"></a>03253                 }
<a name="l03254"></a>03254             }
<a name="l03255"></a>03255             <span class="keywordflow">else</span> {
<a name="l03256"></a>03256                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(viewDirPersp, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2a116c70d4f36be984ca12d9a11bcf6f">viewPos</a>, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03257"></a>03257                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(viewDirPersp);
<a name="l03258"></a>03258                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4a2003033c639cab3de101b1cfe7a595">angle_normalized_v3v3</a>(viewDirPersp, no) &gt;= ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a>) { <span class="comment">/* 1 vert of this face is towards us */</span>
<a name="l03259"></a>03259                     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[a] |= <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>;
<a name="l03260"></a>03260                 }
<a name="l03261"></a>03261             }
<a name="l03262"></a>03262         }
<a name="l03263"></a>03263     }
<a name="l03264"></a>03264     
<a name="l03265"></a>03265 
<a name="l03266"></a>03266     <span class="keywordflow">for</span> (face_index = 0, tf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, mf = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a>; face_index &lt; ps-&gt;dm_totface; mf++, tf++, face_index++) {
<a name="l03267"></a>03267         
<a name="l03268"></a>03268 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l03269"></a>03269 <span class="preprocessor"></span>        <span class="comment">/* add face user if we have bleed enabled, set the UV seam flags later */</span>
<a name="l03270"></a>03270         <span class="comment">/* annoying but we need to add all faces even ones we never use elsewhere */</span>
<a name="l03271"></a>03271         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> &gt; 0.0f) {
<a name="l03272"></a>03272             <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(face_index), arena);
<a name="l03273"></a>03273             <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(face_index), arena);
<a name="l03274"></a>03274             <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(face_index), arena);
<a name="l03275"></a>03275             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l03276"></a>03276                 <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(&amp;ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(face_index), arena);
<a name="l03277"></a>03277             }
<a name="l03278"></a>03278         }
<a name="l03279"></a>03279 <span class="preprocessor">#endif</span>
<a name="l03280"></a>03280 <span class="preprocessor"></span>        
<a name="l03281"></a>03281         tpage = <a class="code" href="../../df/d60/paint__image_8c.html#a48cc5bed84af249eacfc4629c7c03b9f">project_paint_face_image</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>, face_index);
<a name="l03282"></a>03282 
<a name="l03283"></a>03283         <span class="keywordflow">if</span> (tpage &amp;&amp; ((((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;editflag &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) == 0 || mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>)) {
<a name="l03284"></a>03284             
<a name="l03285"></a>03285             <span class="keywordtype">float</span> *v1coSS, *v2coSS, *v3coSS, *v4coSS = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03286"></a>03286             
<a name="l03287"></a>03287             v1coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]; 
<a name="l03288"></a>03288             v2coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]; 
<a name="l03289"></a>03289             v3coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l03290"></a>03290             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l03291"></a>03291                 v4coSS = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]; 
<a name="l03292"></a>03292             }
<a name="l03293"></a>03293             
<a name="l03294"></a>03294             
<a name="l03295"></a>03295             <span class="keywordflow">if</span> (!ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aa8823ec7e4678d895578688608c45d70">is_ortho</a>) {
<a name="l03296"></a>03296                 <span class="keywordflow">if</span> (v1coSS[0] == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> ||
<a name="l03297"></a>03297                     v2coSS[0] == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> ||
<a name="l03298"></a>03298                     v3coSS[0] == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> ||
<a name="l03299"></a>03299                     (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; v4coSS[0] == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>))
<a name="l03300"></a>03300                 {
<a name="l03301"></a>03301                     <span class="keywordflow">continue</span>;
<a name="l03302"></a>03302                 }
<a name="l03303"></a>03303             }
<a name="l03304"></a>03304             
<a name="l03305"></a>03305 <span class="preprocessor">#ifdef PROJ_DEBUG_WINCLIP</span>
<a name="l03306"></a>03306 <span class="preprocessor"></span>            <span class="comment">/* ignore faces outside the view */</span>
<a name="l03307"></a>03307             <span class="keywordflow">if</span> (
<a name="l03308"></a>03308                 (v1coSS[0] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] &amp;&amp;
<a name="l03309"></a>03309                  v2coSS[0] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] &amp;&amp;
<a name="l03310"></a>03310                  v3coSS[0] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0] &amp;&amp;
<a name="l03311"></a>03311                  (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; v4coSS[0] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[0])) ||
<a name="l03312"></a>03312 
<a name="l03313"></a>03313                 (v1coSS[0] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] &amp;&amp;
<a name="l03314"></a>03314                  v2coSS[0] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] &amp;&amp;
<a name="l03315"></a>03315                  v3coSS[0] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0] &amp;&amp;
<a name="l03316"></a>03316                  (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; v4coSS[0] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[0])) ||
<a name="l03317"></a>03317 
<a name="l03318"></a>03318                 (v1coSS[1] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] &amp;&amp;
<a name="l03319"></a>03319                  v2coSS[1] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] &amp;&amp;
<a name="l03320"></a>03320                  v3coSS[1] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1] &amp;&amp;
<a name="l03321"></a>03321                  (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; v4coSS[1] &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae45b52c76d843a33a414c80e428c9669">screenMin</a>[1])) ||
<a name="l03322"></a>03322 
<a name="l03323"></a>03323                 (v1coSS[1] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] &amp;&amp;
<a name="l03324"></a>03324                  v2coSS[1] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] &amp;&amp;
<a name="l03325"></a>03325                  v3coSS[1] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1] &amp;&amp;
<a name="l03326"></a>03326                  (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; v4coSS[1] &gt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a1b4e1010cae8b82b7a4efd980878617a">screenMax</a>[1]))
<a name="l03327"></a>03327                 )
<a name="l03328"></a>03328             {
<a name="l03329"></a>03329                 <span class="keywordflow">continue</span>;
<a name="l03330"></a>03330             }
<a name="l03331"></a>03331             
<a name="l03332"></a>03332 <span class="preprocessor">#endif //PROJ_DEBUG_WINCLIP</span>
<a name="l03333"></a>03333 <span class="preprocessor"></span>    
<a name="l03334"></a>03334             
<a name="l03335"></a>03335             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">do_backfacecull</a>) {
<a name="l03336"></a>03336                 <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a>) {
<a name="l03337"></a>03337                     <span class="comment">/* Since we are interpolating the normals of faces, we want to make </span>
<a name="l03338"></a>03338 <span class="comment">                     * sure all the verts are pointing away from the view,</span>
<a name="l03339"></a>03339 <span class="comment">                     * not just the face */</span>
<a name="l03340"></a>03340                     <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>] &amp; <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>) &amp;&amp;
<a name="l03341"></a>03341                         (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>] &amp; <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>) &amp;&amp;
<a name="l03342"></a>03342                         (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>] &amp; <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>) &amp;&amp;
<a name="l03343"></a>03343                         (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == 0 || ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>] &amp; <a class="code" href="../../df/d60/paint__image_8c.html#a7b663201ff3f4ca4edddd00be02cadc9">PROJ_VERT_CULL</a>)
<a name="l03344"></a>03344                         )
<a name="l03345"></a>03345                     {
<a name="l03346"></a>03346                         <span class="keywordflow">continue</span>;
<a name="l03347"></a>03347                     }
<a name="l03348"></a>03348                 }
<a name="l03349"></a>03349                 <span class="keywordflow">else</span> {
<a name="l03350"></a>03350                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v1coSS, v2coSS, v3coSS) &lt; 0.0f) {
<a name="l03351"></a>03351                         <span class="keywordflow">continue</span>;
<a name="l03352"></a>03352                     }
<a name="l03353"></a>03353                     
<a name="l03354"></a>03354                 }
<a name="l03355"></a>03355             }
<a name="l03356"></a>03356             
<a name="l03357"></a>03357             <span class="keywordflow">if</span> (tpage_last != tpage) {
<a name="l03358"></a>03358                 
<a name="l03359"></a>03359                 image_index = <a class="code" href="../../df/d31/BLI__linklist_8h.html#aa2291b2dc92e7eb5518e078a2ed3bdcd">BLI_linklist_index</a>(image_LinkList, tpage);
<a name="l03360"></a>03360                 
<a name="l03361"></a>03361                 <span class="keywordflow">if</span> (image_index == -1 &amp;&amp; <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(tpage, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) { <span class="comment">/* MemArena dosnt have an append func */</span>
<a name="l03362"></a>03362                     <a class="code" href="../../df/d31/BLI__linklist_8h.html#ab4e3ce40e3189723a2737a09d5e3466e">BLI_linklist_append</a>(&amp;image_LinkList, tpage);
<a name="l03363"></a>03363                     image_index = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>;
<a name="l03364"></a>03364                     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>++;
<a name="l03365"></a>03365                 }
<a name="l03366"></a>03366                 
<a name="l03367"></a>03367                 tpage_last = tpage;
<a name="l03368"></a>03368             }
<a name="l03369"></a>03369             
<a name="l03370"></a>03370             <span class="keywordflow">if</span> (image_index != -1) {
<a name="l03371"></a>03371                 <span class="comment">/* Initialize the faces screen pixels */</span>
<a name="l03372"></a>03372                 <span class="comment">/* Add this to a list to initialize later */</span>
<a name="l03373"></a>03373                 <a class="code" href="../../df/d60/paint__image_8c.html#a61edb43f324dcd0d8bdd655c484d2689">project_paint_delayed_face_init</a>(ps, mf, face_index);
<a name="l03374"></a>03374             }
<a name="l03375"></a>03375         }
<a name="l03376"></a>03376     }
<a name="l03377"></a>03377     
<a name="l03378"></a>03378     <span class="comment">/* build an array of images we use*/</span>
<a name="l03379"></a>03379     projIma = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a> = (<a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *)<a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a>) * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>);
<a name="l03380"></a>03380     
<a name="l03381"></a>03381     <span class="keywordflow">for</span> (node = image_LinkList, i = 0; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>, i++, projIma++) {
<a name="l03382"></a>03382         projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a> = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l03383"></a>03383         projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a> = 0;
<a name="l03384"></a>03384         projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03385"></a>03385         projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a> =  <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>);
<a name="l03386"></a>03386         memset(projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a>) * PROJ_BOUNDBOX_SQUARED);
<a name="l03387"></a>03387     }
<a name="l03388"></a>03388     
<a name="l03389"></a>03389     <span class="comment">/* we have built the array, discard the linked list */</span>
<a name="l03390"></a>03390     <a class="code" href="../../df/d31/BLI__linklist_8h.html#a8c58644b0c8fa747ee6d0b1d02b89861">BLI_linklist_free</a>(image_LinkList, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03391"></a>03391 }
<a name="l03392"></a>03392 
<a name="l03393"></a><a class="code" href="../../df/d60/paint__image_8c.html#a26576d9e38551ade624a6369ca679170">03393</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a26576d9e38551ade624a6369ca679170">project_paint_begin_clone</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keywordtype">int</span> mouse[2])
<a name="l03394"></a>03394 {
<a name="l03395"></a>03395     <span class="comment">/* setup clone offset */</span>
<a name="l03396"></a>03396     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>) {
<a name="l03397"></a>03397         <span class="keywordtype">float</span> projCo[4];
<a name="l03398"></a>03398         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(projCo, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">v3d</a>));
<a name="l03399"></a>03399         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, projCo);
<a name="l03400"></a>03400         
<a name="l03401"></a>03401         projCo[3] = 1.0f;
<a name="l03402"></a>03402         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a003878ea81f0308f24fe30c3b893fa1b">projectMat</a>, projCo);
<a name="l03403"></a>03403         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aff1f5b2976a49764aa85c89cf1d528f5">cloneOffset</a>[0] = mouse[0] - ((float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae8cc2131645c91777eba1683a8a1fdfe">winx</a> / 2.0f) * projCo[0] / projCo[3]);
<a name="l03404"></a>03404         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aff1f5b2976a49764aa85c89cf1d528f5">cloneOffset</a>[1] = mouse[1] - ((float)(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4cf776bbe5d3a5030d382c8f3f4ed4ef">winy</a> / 2.0f) * projCo[1] / projCo[3]);
<a name="l03405"></a>03405     }   
<a name="l03406"></a>03406 }   
<a name="l03407"></a>03407 
<a name="l03408"></a><a class="code" href="../../df/d60/paint__image_8c.html#a87190dde8aa253de62b5b4032be51722">03408</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a87190dde8aa253de62b5b4032be51722">project_paint_end</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps)
<a name="l03409"></a>03409 {
<a name="l03410"></a>03410     <span class="keywordtype">int</span> a;
<a name="l03411"></a>03411     
<a name="l03412"></a>03412     <span class="comment">/* build undo data from original pixel colors */</span>
<a name="l03413"></a>03413     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a32bbcf7e58a7e710fb5357bcc9da4f20">USER_GLOBALUNDO</a>) {
<a name="l03414"></a>03414         <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel;
<a name="l03415"></a>03415         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *tmpibuf_float = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03416"></a>03416         <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *pixel_node;
<a name="l03417"></a>03417         <span class="keywordtype">void</span> *tilerect;
<a name="l03418"></a>03418         <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[0]; <span class="comment">/* threaded arena re-used for non threaded case */</span>
<a name="l03419"></a>03419                 
<a name="l03420"></a>03420         <span class="keywordtype">int</span> bucket_tot = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>); <span class="comment">/* we could get an X/Y but easier to loop through all possible buckets */</span>
<a name="l03421"></a>03421         <span class="keywordtype">int</span> bucket_index; 
<a name="l03422"></a>03422         <span class="keywordtype">int</span> tile_index;
<a name="l03423"></a>03423         <span class="keywordtype">int</span> x_round, y_round;
<a name="l03424"></a>03424         <span class="keywordtype">int</span> x_tile, y_tile;
<a name="l03425"></a>03425         <span class="keywordtype">int</span> is_float = -1;
<a name="l03426"></a>03426         
<a name="l03427"></a>03427         <span class="comment">/* context */</span>
<a name="l03428"></a>03428         <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *last_projIma;
<a name="l03429"></a>03429         <span class="keywordtype">int</span> last_image_index = -1;
<a name="l03430"></a>03430         <span class="keywordtype">int</span> last_tile_width = 0;
<a name="l03431"></a>03431         
<a name="l03432"></a>03432         <span class="keywordflow">for</span> (a = 0, last_projIma = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>; a &lt; ps-&gt;image_tot; a++, last_projIma++) {
<a name="l03433"></a>03433             <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> **) * <a class="code" href="../../df/d60/paint__image_8c.html#a7aad04c41f4673fca187386f1a4539d8">IMAPAINT_TILE_NUMBER</a>(last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#a7aad04c41f4673fca187386f1a4539d8">IMAPAINT_TILE_NUMBER</a>(last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l03434"></a>03434             last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a> = (<span class="keywordtype">void</span> **) <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, size);
<a name="l03435"></a>03435             memset(last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a>, 0, size);
<a name="l03436"></a>03436             last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l03437"></a>03437         }
<a name="l03438"></a>03438         
<a name="l03439"></a>03439         <span class="keywordflow">for</span> (bucket_index = 0; bucket_index &lt; bucket_tot; bucket_index++) {
<a name="l03440"></a>03440             <span class="comment">/* loop through all pixels */</span>
<a name="l03441"></a>03441             <span class="keywordflow">for</span> (pixel_node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a>[bucket_index]; pixel_node; pixel_node = pixel_node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l03442"></a>03442             
<a name="l03443"></a>03443                 <span class="comment">/* ok we have a pixel, was it modified? */</span>
<a name="l03444"></a>03444                 projPixel = (<a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *)pixel_node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l03445"></a>03445                 
<a name="l03446"></a>03446                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (last_image_index != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a>) {
<a name="l03447"></a>03447                     <span class="comment">/* set the context */</span>
<a name="l03448"></a>03448                     last_image_index = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a>;
<a name="l03449"></a>03449                     last_projIma =     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a> + last_image_index;
<a name="l03450"></a>03450                     last_tile_width =  <a class="code" href="../../df/d60/paint__image_8c.html#a7aad04c41f4673fca187386f1a4539d8">IMAPAINT_TILE_NUMBER</a>(last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l03451"></a>03451                     is_float =         last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> ? 1 : 0;
<a name="l03452"></a>03452                 }
<a name="l03453"></a>03453                 
<a name="l03454"></a>03454                 
<a name="l03455"></a>03455                 <span class="keywordflow">if</span> ((is_float == 0 &amp;&amp; projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a> != *projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a>) ||
<a name="l03456"></a>03456                     (is_float == 1 &amp;&amp;
<a name="l03457"></a>03457                      (projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[0] != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[0] ||
<a name="l03458"></a>03458                       projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[1] != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[1] ||
<a name="l03459"></a>03459                       projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[2] != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[2] ||
<a name="l03460"></a>03460                       projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[3] != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[3]))
<a name="l03461"></a>03461                     )
<a name="l03462"></a>03462                 {
<a name="l03463"></a>03463                     
<a name="l03464"></a>03464                     x_tile =  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a> &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>;
<a name="l03465"></a>03465                     y_tile =  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a> &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>;
<a name="l03466"></a>03466                     
<a name="l03467"></a>03467                     x_round = x_tile * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>;
<a name="l03468"></a>03468                     y_round = y_tile * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>;
<a name="l03469"></a>03469                     
<a name="l03470"></a>03470                     tile_index = x_tile + y_tile * last_tile_width;
<a name="l03471"></a>03471                     
<a name="l03472"></a>03472                     <span class="keywordflow">if</span> (last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a>[tile_index] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03473"></a>03473                         <span class="comment">/* add the undo tile from the modified image, then write the original colors back into it */</span>
<a name="l03474"></a>03474                         tilerect = last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a>[tile_index] = <a class="code" href="../../df/d60/paint__image_8c.html#a9890215840305f6195ffd5deb672ab8e">image_undo_push_tile</a>(last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>, last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>, is_float ? (&amp;tmpibuf_float) : (&amp;tmpibuf), x_tile, y_tile);
<a name="l03475"></a>03475                     }
<a name="l03476"></a>03476                     <span class="keywordflow">else</span> {
<a name="l03477"></a>03477                         tilerect = last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a121e9a78f6769ba1ecbebd491da79891">undoRect</a>[tile_index];
<a name="l03478"></a>03478                     }
<a name="l03479"></a>03479                     
<a name="l03480"></a>03480                     <span class="comment">/* This is a BIT ODD, but overwrite the undo tiles image info with this pixels original color</span>
<a name="l03481"></a>03481 <span class="comment">                     * because allocating the tiles along the way slows down painting */</span>
<a name="l03482"></a>03482                     
<a name="l03483"></a>03483                     <span class="keywordflow">if</span> (is_float) {
<a name="l03484"></a>03484                         <span class="keywordtype">float</span> *rgba_fp = (<span class="keywordtype">float</span> *)tilerect + (((projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a> - x_round) + (projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a> - y_round) * IMAPAINT_TILE_SIZE)) * 4;
<a name="l03485"></a>03485                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(rgba_fp, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>);
<a name="l03486"></a>03486                     }
<a name="l03487"></a>03487                     <span class="keywordflow">else</span> {
<a name="l03488"></a>03488                         ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)tilerect)[(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a> - x_round) + (projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a> - y_round) * <a class="code" href="../../df/d60/paint__image_8c.html#a422a45ce013f27286fd093511e5f7cea">IMAPAINT_TILE_SIZE</a>] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a>;
<a name="l03489"></a>03489                     }
<a name="l03490"></a>03490                 }
<a name="l03491"></a>03491             }
<a name="l03492"></a>03492         }
<a name="l03493"></a>03493         
<a name="l03494"></a>03494         <span class="keywordflow">if</span> (tmpibuf) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tmpibuf);
<a name="l03495"></a>03495         <span class="keywordflow">if</span> (tmpibuf_float) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tmpibuf_float);
<a name="l03496"></a>03496     }
<a name="l03497"></a>03497     <span class="comment">/* done calculating undo data */</span>
<a name="l03498"></a>03498     
<a name="l03499"></a>03499     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adbeab1c62d123d6ec64706c98f80119a">screenCoords</a>);
<a name="l03500"></a>03500     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a>);
<a name="l03501"></a>03501     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d69f96f28a814176e587630d20b37a2">bucketFaces</a>);
<a name="l03502"></a>03502     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">bucketFlags</a>);
<a name="l03503"></a>03503     
<a name="l03504"></a>03504 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l03505"></a>03505 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> &gt; 0.0f) {
<a name="l03506"></a>03506         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab1089e8498f12a6315ed437a9ec4a3a">vertFaces</a>);
<a name="l03507"></a>03507         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aed202faa169d60bca2777a27b2c2ad10">faceSeamFlags</a>);
<a name="l03508"></a>03508         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a8fb066eef8e00449c20ebab414ddc6bc">faceSeamUVs</a>);
<a name="l03509"></a>03509     }
<a name="l03510"></a>03510 <span class="preprocessor">#endif</span>
<a name="l03511"></a>03511 <span class="preprocessor"></span>    
<a name="l03512"></a>03512     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a73e7b2011d9546b97248567f9723052e">vertFlags</a>);
<a name="l03513"></a>03513     
<a name="l03514"></a>03514     <span class="keywordflow">for</span> (a = 0; a &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>; a++) {
<a name="l03515"></a>03515         <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[a]);
<a name="l03516"></a>03516     }
<a name="l03517"></a>03517     
<a name="l03518"></a>03518     <span class="comment">/* copy for subsurf/multires, so throw away */</span>
<a name="l03519"></a>03519     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> != <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>) {
<a name="l03520"></a>03520         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a421fe4169ca9c7059270c0d907026423">dm_mvert</a>);
<a name="l03521"></a>03521         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ad3c20fee4fd925c2199ea13a3818a071">dm_mface</a>);
<a name="l03522"></a>03522         <span class="comment">/* looks like these don&#39;t need copying */</span>
<a name="l03523"></a>03523 <span class="preprocessor">#if 0</span>
<a name="l03524"></a>03524 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5c302d600801837de62f25defb5c7895">dm_mtface</a>);
<a name="l03525"></a>03525         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a0f9ffaa8c1b279b64401a03acd3a992e">dm_mtface_clone</a>);
<a name="l03526"></a>03526         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afbfd322609e522221347d552ea8d8571">dm_mtface_stencil</a>);
<a name="l03527"></a>03527 <span class="preprocessor">#endif</span>
<a name="l03528"></a>03528 <span class="preprocessor"></span>    }
<a name="l03529"></a>03529 
<a name="l03530"></a>03530     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a720d11a5968038b70b0359c3b33f4ab3">dm_release</a>)
<a name="l03531"></a>03531         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a>);
<a name="l03532"></a>03532 }
<a name="l03533"></a>03533 
<a name="l03534"></a>03534 <span class="comment">/* 1= an undo, -1 is a redo. */</span>
<a name="l03535"></a><a class="code" href="../../df/d60/paint__image_8c.html#a4b2d6a9b45a4de5f188c81f2c2a94485">03535</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a4b2d6a9b45a4de5f188c81f2c2a94485">partial_redraw_array_init</a>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *pr)
<a name="l03536"></a>03536 {
<a name="l03537"></a>03537     <span class="keywordtype">int</span> tot = <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>;
<a name="l03538"></a>03538     <span class="keywordflow">while</span> (tot--) {
<a name="l03539"></a>03539         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a> = 10000000;
<a name="l03540"></a>03540         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a> = 10000000;
<a name="l03541"></a>03541         
<a name="l03542"></a>03542         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> = -1;
<a name="l03543"></a>03543         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> = -1;
<a name="l03544"></a>03544         
<a name="l03545"></a>03545         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ac57e97aa061db024a54300869b0cf856">enabled</a> = 1;
<a name="l03546"></a>03546         
<a name="l03547"></a>03547         pr++;
<a name="l03548"></a>03548     }
<a name="l03549"></a>03549 }
<a name="l03550"></a>03550 
<a name="l03551"></a>03551 
<a name="l03552"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0834fe1f2555e5f49731d95f35439ee3">03552</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0834fe1f2555e5f49731d95f35439ee3">partial_redraw_array_merge</a>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *pr, <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *pr_other, <span class="keywordtype">int</span> tot)
<a name="l03553"></a>03553 {
<a name="l03554"></a>03554     <span class="keywordtype">int</span> touch = 0;
<a name="l03555"></a>03555     <span class="keywordflow">while</span> (tot--) {
<a name="l03556"></a>03556         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>, pr_other-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>);
<a name="l03557"></a>03557         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>, pr_other-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>);
<a name="l03558"></a>03558         
<a name="l03559"></a>03559         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a>, pr_other-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a>);
<a name="l03560"></a>03560         pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a>, pr_other-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a>);
<a name="l03561"></a>03561         
<a name="l03562"></a>03562         <span class="keywordflow">if</span> (pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> != -1)
<a name="l03563"></a>03563             touch = 1;
<a name="l03564"></a>03564         
<a name="l03565"></a>03565         pr++; pr_other++;
<a name="l03566"></a>03566     }
<a name="l03567"></a>03567     
<a name="l03568"></a>03568     <span class="keywordflow">return</span> touch;
<a name="l03569"></a>03569 }
<a name="l03570"></a>03570 
<a name="l03571"></a>03571 <span class="comment">/* Loop over all images on this mesh and update any we have touched */</span>
<a name="l03572"></a><a class="code" href="../../df/d60/paint__image_8c.html#a1554f85f438e1cbc5ac4e49f7c37e006">03572</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a1554f85f438e1cbc5ac4e49f7c37e006">project_image_refresh_tagged</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps)
<a name="l03573"></a>03573 {
<a name="l03574"></a>03574     <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *pr;
<a name="l03575"></a>03575     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *projIma;
<a name="l03576"></a>03576     <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l03577"></a>03577     <span class="keywordtype">int</span> redraw = 0;
<a name="l03578"></a>03578     
<a name="l03579"></a>03579     
<a name="l03580"></a>03580     <span class="keywordflow">for</span> (a = 0, projIma = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>; a &lt; ps-&gt;image_tot; a++, projIma++) {
<a name="l03581"></a>03581         <span class="keywordflow">if</span> (projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a>) {
<a name="l03582"></a>03582             <span class="comment">/* look over each bound cell */</span>
<a name="l03583"></a>03583             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>; i++) {
<a name="l03584"></a>03584                 pr = &amp;(projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l03585"></a>03585                 <span class="keywordflow">if</span> (pr-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> != -1) { <span class="comment">/* TODO - use &#39;enabled&#39; ? */</span>
<a name="l03586"></a>03586                     imapaintpartial = *pr;
<a name="l03587"></a>03587                     <a class="code" href="../../df/d60/paint__image_8c.html#a5b98d3b6f04aea7acf08e2096c9527b5">imapaint_image_update</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>, projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>, 1); <span class="comment">/*last 1 is for texpaint*/</span>
<a name="l03588"></a>03588                     redraw = 1;
<a name="l03589"></a>03589                 }
<a name="l03590"></a>03590             }
<a name="l03591"></a>03591             
<a name="l03592"></a>03592             projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a> = 0; <span class="comment">/* clear for reuse */</span>
<a name="l03593"></a>03593         }
<a name="l03594"></a>03594     }
<a name="l03595"></a>03595     
<a name="l03596"></a>03596     <span class="keywordflow">return</span> redraw;
<a name="l03597"></a>03597 }
<a name="l03598"></a>03598 
<a name="l03599"></a>03599 <span class="comment">/* run this per painting onto each mouse location */</span>
<a name="l03600"></a><a class="code" href="../../df/d60/paint__image_8c.html#a786b51fa91e3435a477b76a2fca9ff17">03600</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a786b51fa91e3435a477b76a2fca9ff17">project_bucket_iter_init</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keyword">const</span> <span class="keywordtype">float</span> mval_f[2])
<a name="l03601"></a>03601 {
<a name="l03602"></a>03602     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> == <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>) {
<a name="l03603"></a>03603         <span class="keywordtype">float</span> min_brush[2], max_brush[2];
<a name="l03604"></a>03604         <span class="keyword">const</span> <span class="keywordtype">float</span> radius = (float)<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l03605"></a>03605 
<a name="l03606"></a>03606         <span class="comment">/* so we don&#39;t have a bucket bounds that is way too small to paint into */</span>
<a name="l03607"></a>03607         <span class="comment">// if (radius &lt; 1.0f) radius = 1.0f; // this doesn&#39;t work yet :/</span>
<a name="l03608"></a>03608 
<a name="l03609"></a>03609         min_brush[0] = mval_f[0] - radius;
<a name="l03610"></a>03610         min_brush[1] = mval_f[1] - radius;
<a name="l03611"></a>03611 
<a name="l03612"></a>03612         max_brush[0] = mval_f[0] + radius;
<a name="l03613"></a>03613         max_brush[1] = mval_f[1] + radius;
<a name="l03614"></a>03614 
<a name="l03615"></a>03615         <span class="comment">/* offset to make this a valid bucket index */</span>
<a name="l03616"></a>03616         <a class="code" href="../../df/d60/paint__image_8c.html#a9c6f9f3a014285c37f9b53be00b992fb">project_paint_bucket_bounds</a>(ps, min_brush, max_brush, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>);
<a name="l03617"></a>03617 
<a name="l03618"></a>03618         <span class="comment">/* mouse outside the model areas? */</span>
<a name="l03619"></a>03619         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[0] == ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[0] || ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[1] == ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[1]) {
<a name="l03620"></a>03620             <span class="keywordflow">return</span> 0;
<a name="l03621"></a>03621         }
<a name="l03622"></a>03622 
<a name="l03623"></a>03623         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[0];
<a name="l03624"></a>03624         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[1];
<a name="l03625"></a>03625     }
<a name="l03626"></a>03626     <span class="keywordflow">else</span> { <span class="comment">/* reproject: PROJ_SRC_* */</span>
<a name="l03627"></a>03627         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[0] = 0;
<a name="l03628"></a>03628         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[1] = 0;
<a name="l03629"></a>03629 
<a name="l03630"></a>03630         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[0] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>;
<a name="l03631"></a>03631         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[1] = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9a798739d6c3ff09984fe707874efbfe">buckets_y</a>;
<a name="l03632"></a>03632 
<a name="l03633"></a>03633         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a> = 0;
<a name="l03634"></a>03634         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a> = 0;
<a name="l03635"></a>03635     }
<a name="l03636"></a>03636     <span class="keywordflow">return</span> 1;
<a name="l03637"></a>03637 }
<a name="l03638"></a>03638 
<a name="l03639"></a>03639 
<a name="l03640"></a><a class="code" href="../../df/d60/paint__image_8c.html#acdf80f6c056d5338a39f0ebc39402d9f">03640</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#acdf80f6c056d5338a39f0ebc39402d9f">project_bucket_iter_next</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <span class="keywordtype">int</span> *bucket_index, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *bucket_bounds, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2])
<a name="l03641"></a>03641 {
<a name="l03642"></a>03642     <span class="keyword">const</span> <span class="keywordtype">int</span> diameter = 2 * <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l03643"></a>03643 
<a name="l03644"></a>03644     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l03645"></a>03645         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l03646"></a>03646     
<a name="l03647"></a>03647     <span class="comment">//printf(&quot;%d %d\n&quot;, ps-&gt;context_bucket_x, ps-&gt;context_bucket_y);</span>
<a name="l03648"></a>03648     
<a name="l03649"></a>03649     <span class="keywordflow">for</span> (; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a> &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[1]; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a>++) {
<a name="l03650"></a>03650         <span class="keywordflow">for</span> (; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a> &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a75394084c13a04db701b02bb9628d479">bucketMax</a>[0]; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a>++) {
<a name="l03651"></a>03651             
<a name="l03652"></a>03652             <span class="comment">/* use bucket_bounds for project_bucket_isect_circle and project_bucket_init*/</span>
<a name="l03653"></a>03653             <a class="code" href="../../df/d60/paint__image_8c.html#aaf0474ab33a5d3aec4be59bea9932955">project_bucket_bounds</a>(ps, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a>, bucket_bounds);
<a name="l03654"></a>03654             
<a name="l03655"></a>03655             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> != <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>) ||
<a name="l03656"></a>03656                 <a class="code" href="../../df/d60/paint__image_8c.html#a520c5ed2b0cd0bd48996cd9bbbcd277d">project_bucket_isect_circle</a>(mval, (<span class="keywordtype">float</span>)(diameter * diameter), bucket_bounds))
<a name="l03657"></a>03657             {
<a name="l03658"></a>03658                 *bucket_index = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a> + (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aab230dc8342cc845f542a4798f47b444">context_bucket_y</a> * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ae0bc69dbd70b656d4a1940840109874f">buckets_x</a>);
<a name="l03659"></a>03659                 ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a>++;
<a name="l03660"></a>03660                 
<a name="l03661"></a>03661                 <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l03662"></a>03662                     <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l03663"></a>03663                 
<a name="l03664"></a>03664                 <span class="keywordflow">return</span> 1;
<a name="l03665"></a>03665             }
<a name="l03666"></a>03666         }
<a name="l03667"></a>03667         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ac440d6c0eb8885ed4305b83e80ab0608">context_bucket_x</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a2abf7732c0d2ae1cfd683c287abbc634">bucketMin</a>[0];
<a name="l03668"></a>03668     }
<a name="l03669"></a>03669     
<a name="l03670"></a>03670     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l03671"></a>03671         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l03672"></a>03672     <span class="keywordflow">return</span> 0;
<a name="l03673"></a>03673 }
<a name="l03674"></a>03674 
<a name="l03675"></a>03675 <span class="comment">/* Each thread gets one of these, also used as an argument to pass to project_paint_op */</span>
<a name="l03676"></a><a class="code" href="../../d9/d51/structProjectHandle.html">03676</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> {
<a name="l03677"></a>03677     <span class="comment">/* args */</span>
<a name="l03678"></a><a class="code" href="../../d9/d51/structProjectHandle.html#a3127e0a895b3728025dfc9fdd29dc112">03678</a>     <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *<a class="code" href="../../d9/d51/structProjectHandle.html#a3127e0a895b3728025dfc9fdd29dc112">ps</a>;
<a name="l03679"></a><a class="code" href="../../d9/d51/structProjectHandle.html#ad02e1f7e30757ddc5516d6c8133071b9">03679</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d51/structProjectHandle.html#ad02e1f7e30757ddc5516d6c8133071b9">prevmval</a>[2];
<a name="l03680"></a><a class="code" href="../../d9/d51/structProjectHandle.html#a85a7dbbbc5f8bd889958e0cf92e7a005">03680</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d51/structProjectHandle.html#a85a7dbbbc5f8bd889958e0cf92e7a005">mval</a>[2];
<a name="l03681"></a>03681     
<a name="l03682"></a>03682     <span class="comment">/* annoying but we need to have image bounds per thread, then merge into ps-&gt;projectPartialRedraws */</span>
<a name="l03683"></a><a class="code" href="../../d9/d51/structProjectHandle.html#a42b7a37871bab42e93005c0f195b9ae6">03683</a>     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *<a class="code" href="../../d9/d51/structProjectHandle.html#a42b7a37871bab42e93005c0f195b9ae6">projImages</a>; <span class="comment">/* array of partial redraws */</span>
<a name="l03684"></a>03684     
<a name="l03685"></a>03685     <span class="comment">/* thread settings */</span>
<a name="l03686"></a><a class="code" href="../../d9/d51/structProjectHandle.html#a81e99332074a521f7da2397a3b519f6d">03686</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d51/structProjectHandle.html#a81e99332074a521f7da2397a3b519f6d">thread_index</a>;
<a name="l03687"></a>03687 } <a class="code" href="../../df/d60/paint__image_8c.html#ad9b2ef50b622596a5bb52e5dd832cd00">ProjectHandle</a>;
<a name="l03688"></a>03688 
<a name="l03689"></a><a class="code" href="../../df/d60/paint__image_8c.html#ad1bac1f3603b4bd832fe58f903f07817">03689</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ad1bac1f3603b4bd832fe58f903f07817">blend_color_mix</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp2, <span class="keyword">const</span> <span class="keywordtype">int</span> fac)
<a name="l03690"></a>03690 {
<a name="l03691"></a>03691     <span class="comment">/* this and other blending modes previously used &gt;&gt;8 instead of /255. both</span>
<a name="l03692"></a>03692 <span class="comment">     * are not equivalent (&gt;&gt;8 is /256), and the former results in rounding</span>
<a name="l03693"></a>03693 <span class="comment">     * errors that can turn colors black fast after repeated blending */</span>
<a name="l03694"></a>03694     <span class="keyword">const</span> <span class="keywordtype">int</span> mfac = 255 - fac;
<a name="l03695"></a>03695 
<a name="l03696"></a>03696     cp[0] = (mfac * cp1[0] + fac * cp2[0]) / 255;
<a name="l03697"></a>03697     cp[1] = (mfac * cp1[1] + fac * cp2[1]) / 255;
<a name="l03698"></a>03698     cp[2] = (mfac * cp1[2] + fac * cp2[2]) / 255;
<a name="l03699"></a>03699     cp[3] = (mfac * cp1[3] + fac * cp2[3]) / 255;
<a name="l03700"></a>03700 }
<a name="l03701"></a>03701 
<a name="l03702"></a><a class="code" href="../../df/d60/paint__image_8c.html#af139b5b4c18011837531c8f90d2f3b69">03702</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#af139b5b4c18011837531c8f90d2f3b69">blend_color_mix_float</a>(<span class="keywordtype">float</span> *cp, <span class="keyword">const</span> <span class="keywordtype">float</span> *cp1, <span class="keyword">const</span> <span class="keywordtype">float</span> *cp2, <span class="keyword">const</span> <span class="keywordtype">float</span> fac)
<a name="l03703"></a>03703 {
<a name="l03704"></a>03704     <span class="keyword">const</span> <span class="keywordtype">float</span> mfac = 1.0f - fac;
<a name="l03705"></a>03705     cp[0] = mfac * cp1[0] + fac * cp2[0];
<a name="l03706"></a>03706     cp[1] = mfac * cp1[1] + fac * cp2[1];
<a name="l03707"></a>03707     cp[2] = mfac * cp1[2] + fac * cp2[2];
<a name="l03708"></a>03708     cp[3] = mfac * cp1[3] + fac * cp2[3];
<a name="l03709"></a>03709 }
<a name="l03710"></a>03710 
<a name="l03711"></a><a class="code" href="../../df/d60/paint__image_8c.html#a8d406bb90a704278ce18fdced6e88666">03711</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a8d406bb90a704278ce18fdced6e88666">blend_color_mix_accum</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp2, <span class="keyword">const</span> <span class="keywordtype">int</span> fac)
<a name="l03712"></a>03712 {
<a name="l03713"></a>03713     <span class="comment">/* this and other blending modes previously used &gt;&gt;8 instead of /255. both</span>
<a name="l03714"></a>03714 <span class="comment">     * are not equivalent (&gt;&gt;8 is /256), and the former results in rounding</span>
<a name="l03715"></a>03715 <span class="comment">     * errors that can turn colors black fast after repeated blending */</span>
<a name="l03716"></a>03716     <span class="keyword">const</span> <span class="keywordtype">int</span> mfac = 255 - fac;
<a name="l03717"></a>03717     <span class="keyword">const</span> <span class="keywordtype">int</span> alpha = cp1[3] + ((fac * cp2[3]) / 255);
<a name="l03718"></a>03718 
<a name="l03719"></a>03719     cp[0] = (mfac * cp1[0] + fac * cp2[0]) / 255;
<a name="l03720"></a>03720     cp[1] = (mfac * cp1[1] + fac * cp2[1]) / 255;
<a name="l03721"></a>03721     cp[2] = (mfac * cp1[2] + fac * cp2[2]) / 255;
<a name="l03722"></a>03722     cp[3] = alpha &gt; 255 ? 255 : alpha;
<a name="l03723"></a>03723 }
<a name="l03724"></a>03724 
<a name="l03725"></a><a class="code" href="../../df/d60/paint__image_8c.html#a013ec2392f6579c20c352b91d457d77a">03725</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a013ec2392f6579c20c352b91d457d77a">do_projectpaint_clone</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask)
<a name="l03726"></a>03726 {
<a name="l03727"></a>03727     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> == 0 &amp;&amp; mask &lt; 1.0f) {
<a name="l03728"></a>03728         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a> = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2619b932d08c5ced9bf5541cf99d4b2a">IMB_blend_color</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.uint, (<span class="keywordtype">int</span>)(alpha * 255), ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03729"></a>03729         <a class="code" href="../../df/d60/paint__image_8c.html#ad1bac1f3603b4bd832fe58f903f07817">blend_color_mix</a>(projPixel-&gt;pixel.ch_pt,  projPixel-&gt;origColor.ch, projPixel-&gt;newColor.ch, (<span class="keywordtype">int</span>)(mask * 255));
<a name="l03730"></a>03730     }
<a name="l03731"></a>03731     <span class="keywordflow">else</span> {
<a name="l03732"></a>03732         *projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a> = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2619b932d08c5ced9bf5541cf99d4b2a">IMB_blend_color</a>(*projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.uint, (<span class="keywordtype">int</span>)(alpha * mask * 255), ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03733"></a>03733     }
<a name="l03734"></a>03734 }
<a name="l03735"></a>03735 
<a name="l03736"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5d5c39d010036746e9f458573f7de46f">03736</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5d5c39d010036746e9f458573f7de46f">do_projectpaint_clone_f</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask)
<a name="l03737"></a>03737 {
<a name="l03738"></a>03738     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> == 0 &amp;&amp; mask &lt; 1.0f) {
<a name="l03739"></a>03739         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aa64888cbc05ffa46075c5d3fd2aa5f36">IMB_blend_color_float</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f, alpha, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03740"></a>03740         <a class="code" href="../../df/d60/paint__image_8c.html#af139b5b4c18011837531c8f90d2f3b69">blend_color_mix_float</a>(projPixel-&gt;pixel.f_pt,  projPixel-&gt;origColor.f, projPixel-&gt;newColor.f, mask);
<a name="l03741"></a>03741     }
<a name="l03742"></a>03742     <span class="keywordflow">else</span> {
<a name="l03743"></a>03743         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aa64888cbc05ffa46075c5d3fd2aa5f36">IMB_blend_color_float</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f, alpha * mask, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03744"></a>03744     }
<a name="l03745"></a>03745 }
<a name="l03746"></a>03746 
<a name="l03747"></a>03747 <span class="comment">/* do_projectpaint_smear*</span>
<a name="l03748"></a>03748 <span class="comment"> * </span>
<a name="l03749"></a>03749 <span class="comment"> * note, mask is used to modify the alpha here, this is not correct since it allows</span>
<a name="l03750"></a>03750 <span class="comment"> * accumulation of color greater then &#39;projPixel-&gt;mask&#39; however in the case of smear its not </span>
<a name="l03751"></a>03751 <span class="comment"> * really that important to be correct as it is with clone and painting </span>
<a name="l03752"></a>03752 <span class="comment"> */</span>
<a name="l03753"></a><a class="code" href="../../df/d60/paint__image_8c.html#afa214f507f63812e66dd8460cb20083f">03753</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#afa214f507f63812e66dd8460cb20083f">do_projectpaint_smear</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *smearArena, <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **smearPixels, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2])
<a name="l03754"></a>03754 {
<a name="l03755"></a>03755     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_ub[4];
<a name="l03756"></a>03756     
<a name="l03757"></a>03757     <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">project_paint_PickColor</a>(ps, co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, rgba_ub, 1) == 0)
<a name="l03758"></a>03758         <span class="keywordflow">return</span>; 
<a name="l03759"></a>03759     <span class="comment">/* ((ProjPixelClone *)projPixel)-&gt;clonepx.uint = IMB_blend_color(*projPixel-&gt;pixel.uint_pt, *((unsigned int *)rgba_ub), (int)(alpha*mask*255), ps-&gt;blend); */</span>
<a name="l03760"></a>03760     <a class="code" href="../../df/d60/paint__image_8c.html#ad1bac1f3603b4bd832fe58f903f07817">blend_color_mix</a>(((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch, projPixel-&gt;pixel.ch_pt, rgba_ub, (<span class="keywordtype">int</span>)(alpha * mask * 255));
<a name="l03761"></a>03761     <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(smearPixels, (<span class="keywordtype">void</span> *)projPixel, smearArena);
<a name="l03762"></a>03762 } 
<a name="l03763"></a>03763 
<a name="l03764"></a><a class="code" href="../../df/d60/paint__image_8c.html#adc560e6ba3730ba57119432216d5f220">03764</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#adc560e6ba3730ba57119432216d5f220">do_projectpaint_smear_f</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *smearArena, <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> **smearPixels_f, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2])
<a name="l03765"></a>03765 {
<a name="l03766"></a>03766     <span class="keywordtype">float</span> rgba[4];
<a name="l03767"></a>03767     
<a name="l03768"></a>03768     <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a2d5954cb98a7e0f484e6922738b40564">project_paint_PickColor</a>(ps, co, rgba, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1) == 0)
<a name="l03769"></a>03769         <span class="keywordflow">return</span>;
<a name="l03770"></a>03770     
<a name="l03771"></a>03771     <span class="comment">/* (ProjPixelClone *)projPixel)-&gt;clonepx.uint = IMB_blend_color(*((unsigned int *)rgba_smear), *((unsigned int *)rgba_ub), (int)(alpha*mask*255), ps-&gt;blend); */</span>
<a name="l03772"></a>03772     <a class="code" href="../../df/d60/paint__image_8c.html#af139b5b4c18011837531c8f90d2f3b69">blend_color_mix_float</a>(((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f, projPixel-&gt;pixel.f_pt, rgba, alpha * mask);
<a name="l03773"></a>03773     <a class="code" href="../../df/d31/BLI__linklist_8h.html#a562e4cd7db635a846706b241d175a304">BLI_linklist_prepend_arena</a>(smearPixels_f, (<span class="keywordtype">void</span> *)projPixel, smearArena);
<a name="l03774"></a>03774 }
<a name="l03775"></a>03775 
<a name="l03776"></a><a class="code" href="../../df/d60/paint__image_8c.html#a2df3b885105126b10c56f3a1095cef97">03776</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2df3b885105126b10c56f3a1095cef97">do_projectpaint_draw</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> *rgba, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask)
<a name="l03777"></a>03777 {
<a name="l03778"></a>03778     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rgba_ub[4];
<a name="l03779"></a>03779     
<a name="l03780"></a>03780     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a>) {
<a name="l03781"></a>03781         rgba_ub[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(rgba[0] * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[0]);
<a name="l03782"></a>03782         rgba_ub[1] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(rgba[1] * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[1]);
<a name="l03783"></a>03783         rgba_ub[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(rgba[2] * ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>[2]);
<a name="l03784"></a>03784         rgba_ub[3] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a950f9248447cf3159372f4f48e7504d6">FTOCHAR</a>(rgba[3]);
<a name="l03785"></a>03785     }
<a name="l03786"></a>03786     <span class="keywordflow">else</span> {
<a name="l03787"></a>03787         <a class="code" href="../../df/d60/paint__image_8c.html#a5ae2e8f12c6c2bc0560daced034d6414">IMAPAINT_FLOAT_RGB_TO_CHAR</a>(rgba_ub, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l03788"></a>03788         rgba_ub[3] = 255;
<a name="l03789"></a>03789     }
<a name="l03790"></a>03790     
<a name="l03791"></a>03791     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> == 0 &amp;&amp; mask &lt; 1.0f) {
<a name="l03792"></a>03792         projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a> = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2619b932d08c5ced9bf5541cf99d4b2a">IMB_blend_color</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aaec06290a0e88c814db5dbc930ab98d8">uint</a>, *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rgba_ub), (<span class="keywordtype">int</span>)(alpha * 255), ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03793"></a>03793         <a class="code" href="../../df/d60/paint__image_8c.html#ad1bac1f3603b4bd832fe58f903f07817">blend_color_mix</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a>,  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>, (<span class="keywordtype">int</span>)(mask * 255));
<a name="l03794"></a>03794     }
<a name="l03795"></a>03795     <span class="keywordflow">else</span> {
<a name="l03796"></a>03796         *projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a> = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2619b932d08c5ced9bf5541cf99d4b2a">IMB_blend_color</a>(*projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a>, *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rgba_ub), (<span class="keywordtype">int</span>)(alpha * mask * 255), ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798 }
<a name="l03799"></a>03799 
<a name="l03800"></a><a class="code" href="../../df/d60/paint__image_8c.html#a287f56238d92999b9b7621dd528ebb01">03800</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a287f56238d92999b9b7621dd528ebb01">do_projectpaint_draw_f</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel, <span class="keywordtype">float</span> *rgba, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> mask, <span class="keywordtype">int</span> use_color_correction)
<a name="l03801"></a>03801 {
<a name="l03802"></a>03802     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a>) {
<a name="l03803"></a>03803         <span class="comment">/* rgba already holds a texture result here from higher level function */</span>
<a name="l03804"></a>03804         <span class="keywordflow">if</span> (use_color_correction) {
<a name="l03805"></a>03805             <span class="keywordtype">float</span> rgba_br[3];
<a name="l03806"></a>03806             <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(rgba_br, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l03807"></a>03807             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3c368253a0bd6032fa80dba876df5425">mul_v3_v3</a>(rgba, rgba_br);
<a name="l03808"></a>03808         }
<a name="l03809"></a>03809         <span class="keywordflow">else</span> {
<a name="l03810"></a>03810             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3c368253a0bd6032fa80dba876df5425">mul_v3_v3</a>(rgba, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l03811"></a>03811         }
<a name="l03812"></a>03812     }
<a name="l03813"></a>03813     <span class="keywordflow">else</span> {
<a name="l03814"></a>03814         <span class="keywordflow">if</span> (use_color_correction) {
<a name="l03815"></a>03815             <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(rgba, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l03816"></a>03816         }
<a name="l03817"></a>03817         <span class="keywordflow">else</span> {
<a name="l03818"></a>03818             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rgba, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l03819"></a>03819         }
<a name="l03820"></a>03820         rgba[3] = 1.0;
<a name="l03821"></a>03821     }
<a name="l03822"></a>03822     
<a name="l03823"></a>03823     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> == 0 &amp;&amp; mask &lt; 1.0f) {
<a name="l03824"></a>03824         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aa64888cbc05ffa46075c5d3fd2aa5f36">IMB_blend_color_float</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, rgba, alpha, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03825"></a>03825         <a class="code" href="../../df/d60/paint__image_8c.html#af139b5b4c18011837531c8f90d2f3b69">blend_color_mix_float</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>,  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>, mask);
<a name="l03826"></a>03826     }
<a name="l03827"></a>03827     <span class="keywordflow">else</span> {
<a name="l03828"></a>03828         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aa64888cbc05ffa46075c5d3fd2aa5f36">IMB_blend_color_float</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>, rgba, alpha * mask, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a>);
<a name="l03829"></a>03829     }
<a name="l03830"></a>03830 }
<a name="l03831"></a>03831 
<a name="l03832"></a>03832 
<a name="l03833"></a>03833 
<a name="l03834"></a>03834 <span class="comment">/* run this for single and multithreaded painting */</span>
<a name="l03835"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5474b533032b0dd7201ae9e884e4a0a1">03835</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../df/d60/paint__image_8c.html#a5474b533032b0dd7201ae9e884e4a0a1">do_projectpaint_thread</a>(<span class="keywordtype">void</span> *ph_v)
<a name="l03836"></a>03836 {
<a name="l03837"></a>03837     <span class="comment">/* First unpack args from the struct */</span>
<a name="l03838"></a>03838     <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps =         ((<a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> *)ph_v)-&gt;ps;
<a name="l03839"></a>03839     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *projImages = ((<a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> *)ph_v)-&gt;projImages;
<a name="l03840"></a>03840     <span class="keyword">const</span> <span class="keywordtype">float</span> *lastpos =       ((<a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> *)ph_v)-&gt;prevmval;
<a name="l03841"></a>03841     <span class="keyword">const</span> <span class="keywordtype">float</span> *pos =           ((<a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> *)ph_v)-&gt;mval;
<a name="l03842"></a>03842     <span class="keyword">const</span> <span class="keywordtype">int</span> thread_index =     ((<a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> *)ph_v)-&gt;thread_index;
<a name="l03843"></a>03843     <span class="comment">/* Done with args from ProjectHandle */</span>
<a name="l03844"></a>03844 
<a name="l03845"></a>03845     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *node;
<a name="l03846"></a>03846     <a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *projPixel;
<a name="l03847"></a>03847     
<a name="l03848"></a>03848     <span class="keywordtype">int</span> last_index = -1;
<a name="l03849"></a>03849     <a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *last_projIma = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03850"></a>03850     <a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *last_partial_redraw_cell;
<a name="l03851"></a>03851     
<a name="l03852"></a>03852     <span class="keywordtype">float</span> rgba[4], alpha, dist_nosqrt, dist;
<a name="l03853"></a>03853     
<a name="l03854"></a>03854     <span class="keywordtype">float</span> falloff;
<a name="l03855"></a>03855     <span class="keywordtype">int</span> bucket_index;
<a name="l03856"></a>03856     <span class="keywordtype">int</span> is_floatbuf = 0;
<a name="l03857"></a>03857     <span class="keywordtype">int</span> use_color_correction = 0;
<a name="l03858"></a>03858     <span class="keyword">const</span> <span class="keywordtype">short</span> tool =  ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a>;
<a name="l03859"></a>03859     <a class="code" href="../../da/d10/structrctf.html">rctf</a> bucket_bounds;
<a name="l03860"></a>03860     
<a name="l03861"></a>03861     <span class="comment">/* for smear only */</span>
<a name="l03862"></a>03862     <span class="keywordtype">float</span> pos_ofs[2] = {0};
<a name="l03863"></a>03863     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2];
<a name="l03864"></a>03864     <span class="keywordtype">float</span> mask = 1.0f; <span class="comment">/* airbrush wont use mask */</span>
<a name="l03865"></a>03865     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> mask_short;
<a name="l03866"></a>03866     <span class="keyword">const</span> <span class="keywordtype">float</span> radius = (float)<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l03867"></a>03867     <span class="keyword">const</span> <span class="keywordtype">float</span> radius_squared = radius * radius; <span class="comment">/* avoid a square root with every dist comparison */</span>
<a name="l03868"></a>03868     
<a name="l03869"></a>03869     <span class="keywordtype">short</span> lock_alpha = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a99c5887452ddfa34dc629fc3ba4a7c54">blend</a>, <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841a20deb7a35361d787288b0195b81c8655">IMB_BLEND_ERASE_ALPHA</a>, <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841a549070f6700cfa341b1e6277ad0659a7">IMB_BLEND_ADD_ALPHA</a>) ? 0 : ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa3f4ea443167c10441b654c023ad65b37">BRUSH_LOCK_ALPHA</a>;
<a name="l03870"></a>03870     
<a name="l03871"></a>03871     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *smearPixels = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03872"></a>03872     <a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a> *smearPixels_f = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03873"></a>03873     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *smearArena = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* mem arena for this brush projection only */</span>
<a name="l03874"></a>03874     
<a name="l03875"></a>03875     <span class="keywordflow">if</span> (tool == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa2144bb61a8ed41729a963353f30cab">PAINT_TOOL_SMEAR</a>) {
<a name="l03876"></a>03876         pos_ofs[0] = pos[0] - lastpos[0];
<a name="l03877"></a>03877         pos_ofs[1] = pos[1] - lastpos[1];
<a name="l03878"></a>03878         
<a name="l03879"></a>03879         smearArena = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(1 &lt;&lt; 16, <span class="stringliteral">&quot;paint smear arena&quot;</span>);
<a name="l03880"></a>03880     }
<a name="l03881"></a>03881     
<a name="l03882"></a>03882     <span class="comment">/* printf(&quot;brush bounds %d %d %d %d\n&quot;, bucketMin[0], bucketMin[1], bucketMax[0], bucketMax[1]); */</span>
<a name="l03883"></a>03883     
<a name="l03884"></a>03884     <span class="keywordflow">while</span> (<a class="code" href="../../df/d60/paint__image_8c.html#acdf80f6c056d5338a39f0ebc39402d9f">project_bucket_iter_next</a>(ps, &amp;bucket_index, &amp;bucket_bounds, pos)) {              
<a name="l03885"></a>03885         
<a name="l03886"></a>03886         <span class="comment">/* Check this bucket and its faces are initialized */</span>
<a name="l03887"></a>03887         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9e4fcb33028a9261ef0f1e5f2e6c54e9">bucketFlags</a>[bucket_index] == <a class="code" href="../../df/d60/paint__image_8c.html#a2aea653d601c8061e2954f97c969c5a3">PROJ_BUCKET_NULL</a>) {
<a name="l03888"></a>03888             <span class="comment">/* No pixels initialized */</span>
<a name="l03889"></a>03889             <a class="code" href="../../df/d60/paint__image_8c.html#a76e5f00aad4637c2e05e25cc0f548f29">project_bucket_init</a>(ps, thread_index, bucket_index, &amp;bucket_bounds);
<a name="l03890"></a>03890         }
<a name="l03891"></a>03891 
<a name="l03892"></a>03892         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> != <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>) {
<a name="l03893"></a>03893 
<a name="l03894"></a>03894             <span class="comment">/* Re-Projection, simple, no brushes! */</span>
<a name="l03895"></a>03895             
<a name="l03896"></a>03896             <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a>[bucket_index]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l03897"></a>03897                 projPixel = (<a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *)node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l03898"></a>03898 
<a name="l03899"></a>03899                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ae906cedccac81c19672da6b59d21d0d1">bicubic_interpolation_color</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>[0], projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>[1]);
<a name="l03900"></a>03900                 <span class="keywordflow">if</span> (projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>[3]) {
<a name="l03901"></a>03901                     mask = ((float)projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">mask</a>) / 65535.0f;
<a name="l03902"></a>03902                     <a class="code" href="../../df/d60/paint__image_8c.html#a8d406bb90a704278ce18fdced6e88666">blend_color_mix_accum</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a>,  projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>, (<span class="keywordtype">int</span>)(mask * projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1b65eafc01c6ae82a8036cc7e3af8545">newColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>[3]));
<a name="l03903"></a>03903 
<a name="l03904"></a>03904                 }
<a name="l03905"></a>03905             }
<a name="l03906"></a>03906         }
<a name="l03907"></a>03907         <span class="keywordflow">else</span> {
<a name="l03908"></a>03908             <span class="comment">/* Normal brush painting */</span>
<a name="l03909"></a>03909             
<a name="l03910"></a>03910             <span class="keywordflow">for</span> (node = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a79d5ebe29b53d39fcde69c7469f3a314">bucketRect</a>[bucket_index]; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l03911"></a>03911 
<a name="l03912"></a>03912                 projPixel = (<a class="code" href="../../d7/da7/structProjPixel.html">ProjPixel</a> *)node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l03913"></a>03913 
<a name="l03914"></a>03914                 dist_nosqrt = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aad974afda68ca9dc12b3ebc0ce297a0c">len_squared_v2v2</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>, pos);
<a name="l03915"></a>03915 
<a name="l03916"></a>03916                 <span class="comment">/*if (dist &lt; radius) {*/</span> <span class="comment">/* correct but uses a sqrtf */</span>
<a name="l03917"></a>03917                 <span class="keywordflow">if</span> (dist_nosqrt &lt;= radius_squared) {
<a name="l03918"></a>03918                     dist = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(dist_nosqrt);
<a name="l03919"></a>03919 
<a name="l03920"></a>03920                     falloff = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, dist, radius);
<a name="l03921"></a>03921 
<a name="l03922"></a>03922                     <span class="keywordflow">if</span> (falloff &gt; 0.0f) {
<a name="l03923"></a>03923                         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a>) {
<a name="l03924"></a>03924                             <span class="comment">/* note, for clone and smear, we only use the alpha, could be a special function */</span>
<a name="l03925"></a>03925                             <a class="code" href="../../da/dc9/BKE__brush_8h.html#aa924882b6adf527f7f8e47953579df56">brush_sample_tex</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>, rgba, thread_index);
<a name="l03926"></a>03926                             alpha = rgba[3];
<a name="l03927"></a>03927                         }
<a name="l03928"></a>03928                         <span class="keywordflow">else</span> {
<a name="l03929"></a>03929                             alpha = 1.0f;
<a name="l03930"></a>03930                         }
<a name="l03931"></a>03931                         
<a name="l03932"></a>03932                         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a>) {
<a name="l03933"></a>03933                             <span class="comment">/* for an aurbrush there is no real mask, so just multiply the alpha by it */</span>
<a name="l03934"></a>03934                             alpha *= falloff * <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l03935"></a>03935                             mask = ((float)projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">mask</a>) / 65535.0f;
<a name="l03936"></a>03936                         }
<a name="l03937"></a>03937                         <span class="keywordflow">else</span> {
<a name="l03938"></a>03938                             <span class="comment">/* This brush dosnt accumulate so add some curve to the brushes falloff */</span>
<a name="l03939"></a>03939                             falloff = 1.0f - falloff;
<a name="l03940"></a>03940                             falloff = 1.0f - (falloff * falloff);
<a name="l03941"></a>03941                             
<a name="l03942"></a>03942                             mask_short = (<span class="keywordtype">unsigned</span> short)(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a390d0aebd1504e2f2c9668e7300b1a81">mask</a> * (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>) * falloff));
<a name="l03943"></a>03943                             <span class="keywordflow">if</span> (mask_short &gt; projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1c6fe91a1523482d4efd421dacf319b3">mask_max</a>) {
<a name="l03944"></a>03944                                 mask = ((float)mask_short) / 65535.0f;
<a name="l03945"></a>03945                                 projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1c6fe91a1523482d4efd421dacf319b3">mask_max</a> = mask_short;
<a name="l03946"></a>03946                             }
<a name="l03947"></a>03947                             <span class="keywordflow">else</span> {
<a name="l03948"></a>03948                                 <span class="comment">/*mask = ((float)projPixel-&gt;mask_max)/65535.0f;*/</span>
<a name="l03949"></a>03949 
<a name="l03950"></a>03950                                 <span class="comment">/* Go onto the next pixel */</span>
<a name="l03951"></a>03951                                 <span class="keywordflow">continue</span>;
<a name="l03952"></a>03952                             }
<a name="l03953"></a>03953                         }
<a name="l03954"></a>03954                         
<a name="l03955"></a>03955                         <span class="keywordflow">if</span> (alpha &gt; 0.0f) {
<a name="l03956"></a>03956 
<a name="l03957"></a>03957                             <span class="keywordflow">if</span> (last_index != projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a>) {
<a name="l03958"></a>03958                                 last_index = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ad5353b122ab3c7f772caed4b14f1c371">image_index</a>;
<a name="l03959"></a>03959                                 last_projIma = projImages + last_index;
<a name="l03960"></a>03960 
<a name="l03961"></a>03961                                 last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a> = 1;
<a name="l03962"></a>03962                                 is_floatbuf = last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> ? 1 : 0;
<a name="l03963"></a>03963                                 use_color_correction = (last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a695871a5ad1977b428860c1f3560a907">ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> == <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>) ? 1 : 0;
<a name="l03964"></a>03964                             }
<a name="l03965"></a>03965 
<a name="l03966"></a>03966                             last_partial_redraw_cell = last_projIma-&gt;<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a> + projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#ace733fd9deb93129e05540104c3e375f">bb_cell_index</a>;
<a name="l03967"></a>03967                             last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a>);
<a name="l03968"></a>03968                             last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a>);
<a name="l03969"></a>03969 
<a name="l03970"></a>03970                             last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a65621d5d95bb13c746229cb793d4d980">x_px</a> + 1);
<a name="l03971"></a>03971                             last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(last_partial_redraw_cell-&gt;<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a>, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#adb9b54f90128daf69d1599d080c13d1b">y_px</a> + 1);
<a name="l03972"></a>03972 
<a name="l03973"></a>03973                             
<a name="l03974"></a>03974                             <span class="keywordflow">switch</span> (tool) {
<a name="l03975"></a>03975                                 <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>:
<a name="l03976"></a>03976                                     <span class="keywordflow">if</span> (is_floatbuf) {
<a name="l03977"></a>03977                                         <span class="keywordflow">if</span> (((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f[3]) {
<a name="l03978"></a>03978                                             <a class="code" href="../../df/d60/paint__image_8c.html#a5d5c39d010036746e9f458573f7de46f">do_projectpaint_clone_f</a>(ps, projPixel, alpha, mask); <span class="comment">/* rgba isn&#39;t used for cloning, only alpha */</span>
<a name="l03979"></a>03979                                         }
<a name="l03980"></a>03980                                     }
<a name="l03981"></a>03981                                     <span class="keywordflow">else</span> {
<a name="l03982"></a>03982                                         <span class="keywordflow">if</span> (((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.ch[3]) {
<a name="l03983"></a>03983                                             <a class="code" href="../../df/d60/paint__image_8c.html#a013ec2392f6579c20c352b91d457d77a">do_projectpaint_clone</a>(ps, projPixel, alpha, mask); <span class="comment">/* rgba isn&#39;t used for cloning, only alpha */</span>
<a name="l03984"></a>03984                                         }
<a name="l03985"></a>03985                                     }
<a name="l03986"></a>03986                                     <span class="keywordflow">break</span>;
<a name="l03987"></a>03987                                 <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa2144bb61a8ed41729a963353f30cab">PAINT_TOOL_SMEAR</a>:
<a name="l03988"></a>03988                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(co, projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a1e985030da5f671a1fd1bf72d9fb1171">projCoSS</a>, pos_ofs);
<a name="l03989"></a>03989 
<a name="l03990"></a>03990                                     <span class="keywordflow">if</span> (is_floatbuf) <a class="code" href="../../df/d60/paint__image_8c.html#adc560e6ba3730ba57119432216d5f220">do_projectpaint_smear_f</a>(ps, projPixel, alpha, mask, smearArena, &amp;smearPixels_f, co);
<a name="l03991"></a>03991                                     <span class="keywordflow">else</span> <a class="code" href="../../df/d60/paint__image_8c.html#afa214f507f63812e66dd8460cb20083f">do_projectpaint_smear</a>(ps, projPixel, alpha, mask, smearArena, &amp;smearPixels, co);
<a name="l03992"></a>03992                                     <span class="keywordflow">break</span>;
<a name="l03993"></a>03993                                 <span class="keywordflow">default</span>:
<a name="l03994"></a>03994                                     <span class="keywordflow">if</span> (is_floatbuf) <a class="code" href="../../df/d60/paint__image_8c.html#a287f56238d92999b9b7621dd528ebb01">do_projectpaint_draw_f</a>(ps, projPixel, rgba, alpha, mask, use_color_correction);
<a name="l03995"></a>03995                                     <span class="keywordflow">else</span> <a class="code" href="../../df/d60/paint__image_8c.html#a2df3b885105126b10c56f3a1095cef97">do_projectpaint_draw</a>(ps, projPixel, rgba, alpha, mask);
<a name="l03996"></a>03996                                     <span class="keywordflow">break</span>;
<a name="l03997"></a>03997                             }
<a name="l03998"></a>03998                         }
<a name="l03999"></a>03999 
<a name="l04000"></a>04000                         <span class="keywordflow">if</span> (lock_alpha) {
<a name="l04001"></a>04001                             <span class="keywordflow">if</span> (is_floatbuf) projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>[3] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#aa2cede15b8722b20f9b77e5fe747fc16">f</a>[3];
<a name="l04002"></a>04002                             <span class="keywordflow">else</span> projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#ac7480eaa6d43eecc9ea4011af6486170">ch_pt</a>[3] = projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a2fa52fe78688a4c15b022961105a2db7">origColor</a>.<a class="code" href="../../d3/d0c/unionpixelStore.html#a37a20c33c51ff35dc625dae950bad5ea">ch</a>[3];
<a name="l04003"></a>04003                         }
<a name="l04004"></a>04004 
<a name="l04005"></a>04005                         <span class="comment">/* done painting */</span>
<a name="l04006"></a>04006                     }
<a name="l04007"></a>04007                 }
<a name="l04008"></a>04008             }
<a name="l04009"></a>04009         }
<a name="l04010"></a>04010     }
<a name="l04011"></a>04011 
<a name="l04012"></a>04012     
<a name="l04013"></a>04013     <span class="keywordflow">if</span> (tool == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa2144bb61a8ed41729a963353f30cab">PAINT_TOOL_SMEAR</a>) {
<a name="l04014"></a>04014         
<a name="l04015"></a>04015         <span class="keywordflow">for</span> (node = smearPixels; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) { <span class="comment">/* this wont run for a float image */</span>
<a name="l04016"></a>04016             projPixel = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l04017"></a>04017             *projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a3c5c3cb8928b70b09f281f7150495614">uint_pt</a> = ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.uint;
<a name="l04018"></a>04018         }
<a name="l04019"></a>04019         
<a name="l04020"></a>04020         <span class="keywordflow">for</span> (node = smearPixels_f; node; node = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a8dfad71be4e66058ae9b9a97383e128c">next</a>) {
<a name="l04021"></a>04021             projPixel = node-&gt;<a class="code" href="../../d7/deb/structLinkNode.html#a0cbae9a354b6f652667f7d5ccee2d733">link</a>;
<a name="l04022"></a>04022             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(projPixel-&gt;<a class="code" href="../../d7/da7/structProjPixel.html#a275c3b5db0a1ebeb53c7bb481e7944b2">pixel</a>.<a class="code" href="../../d6/dfa/unionpixelPointer.html#a592a30f1966746222f4a6107cecf98f3">f_pt</a>, ((<a class="code" href="../../db/d6f/structProjPixelClone.html">ProjPixelClone</a> *)projPixel)-&gt;clonepx.f);
<a name="l04023"></a>04023         }
<a name="l04024"></a>04024         
<a name="l04025"></a>04025         <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(smearArena);
<a name="l04026"></a>04026     }
<a name="l04027"></a>04027     
<a name="l04028"></a>04028     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04029"></a>04029 }
<a name="l04030"></a>04030 
<a name="l04031"></a><a class="code" href="../../df/d60/paint__image_8c.html#ac6240e69a5f47dc2023d8a3e39531605">04031</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ac6240e69a5f47dc2023d8a3e39531605">project_paint_op</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ibufb), <span class="keyword">const</span> <span class="keywordtype">float</span> lastpos[2], <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2])
<a name="l04032"></a>04032 {
<a name="l04033"></a>04033     <span class="comment">/* First unpack args from the struct */</span>
<a name="l04034"></a>04034     <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps = (<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *)state;
<a name="l04035"></a>04035     <span class="keywordtype">int</span> touch_any = 0;  
<a name="l04036"></a>04036     
<a name="l04037"></a>04037     <a class="code" href="../../d9/d51/structProjectHandle.html">ProjectHandle</a> handles[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l04038"></a>04038     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l04039"></a>04039     <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l04040"></a>04040     
<a name="l04041"></a>04041     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a786b51fa91e3435a477b76a2fca9ff17">project_bucket_iter_init</a>(ps, pos)) {
<a name="l04042"></a>04042         <span class="keywordflow">return</span> 0;
<a name="l04043"></a>04043     }
<a name="l04044"></a>04044     
<a name="l04045"></a>04045     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l04046"></a>04046         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../df/d60/paint__image_8c.html#a5474b533032b0dd7201ae9e884e4a0a1">do_projectpaint_thread</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>);
<a name="l04047"></a>04047     
<a name="l04048"></a>04048     <span class="comment">/* get the threads running */</span>
<a name="l04049"></a>04049     <span class="keywordflow">for</span> (a = 0; a &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>; a++) {
<a name="l04050"></a>04050         
<a name="l04051"></a>04051         <span class="comment">/* set defaults in handles */</span>
<a name="l04052"></a>04052         <span class="comment">//memset(&amp;handles[a], 0, sizeof(BakeShade));</span>
<a name="l04053"></a>04053         
<a name="l04054"></a>04054         handles[a].<a class="code" href="../../d9/d51/structProjectHandle.html#a3127e0a895b3728025dfc9fdd29dc112">ps</a> = ps;
<a name="l04055"></a>04055         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(handles[a].mval, pos);
<a name="l04056"></a>04056         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(handles[a].prevmval, lastpos);
<a name="l04057"></a>04057         
<a name="l04058"></a>04058         <span class="comment">/* thread specific */</span>
<a name="l04059"></a>04059         handles[a].<a class="code" href="../../d9/d51/structProjectHandle.html#a81e99332074a521f7da2397a3b519f6d">thread_index</a> = a;
<a name="l04060"></a>04060         
<a name="l04061"></a>04061         handles[a].<a class="code" href="../../d9/d51/structProjectHandle.html#a42b7a37871bab42e93005c0f195b9ae6">projImages</a> = (<a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a> *)<a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[a], ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a>));
<a name="l04062"></a>04062         
<a name="l04063"></a>04063         memcpy(handles[a].projImages, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d64/structProjPaintImage.html">ProjPaintImage</a>));
<a name="l04064"></a>04064         
<a name="l04065"></a>04065         <span class="comment">/* image bounds */</span>
<a name="l04066"></a>04066         <span class="keywordflow">for</span> (i = 0; i &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; i++) {
<a name="l04067"></a>04067             handles[a].<a class="code" href="../../d9/d51/structProjectHandle.html#a42b7a37871bab42e93005c0f195b9ae6">projImages</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a> = (<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a> *)<a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaccea3d5cb4a0b1776e59b2d18b5e6">arena_mt</a>[a], <span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>);
<a name="l04068"></a>04068             memcpy(handles[a].projImages[i].partRedrawRect, ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[i].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html">ImagePaintPartialRedraw</a>) * <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>);         
<a name="l04069"></a>04069         }
<a name="l04070"></a>04070 
<a name="l04071"></a>04071         <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1)
<a name="l04072"></a>04072             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;handles[a]);
<a name="l04073"></a>04073     }
<a name="l04074"></a>04074     
<a name="l04075"></a>04075     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a> &gt; 1) <span class="comment">/* wait for everything to be done */</span>
<a name="l04076"></a>04076         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l04077"></a>04077     <span class="keywordflow">else</span>
<a name="l04078"></a>04078         <a class="code" href="../../df/d60/paint__image_8c.html#a5474b533032b0dd7201ae9e884e4a0a1">do_projectpaint_thread</a>(&amp;handles[0]);
<a name="l04079"></a>04079         
<a name="l04080"></a>04080     
<a name="l04081"></a>04081     <span class="comment">/* move threaded bounds back into ps-&gt;projectPartialRedraws */</span>
<a name="l04082"></a>04082     <span class="keywordflow">for</span> (i = 0; i &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; i++) {
<a name="l04083"></a>04083         <span class="keywordtype">int</span> touch = 0;
<a name="l04084"></a>04084         <span class="keywordflow">for</span> (a = 0; a &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a5cde1764786dc1d55aef36a3c7536e8c">thread_tot</a>; a++) {
<a name="l04085"></a>04085             touch |= <a class="code" href="../../df/d60/paint__image_8c.html#a0834fe1f2555e5f49731d95f35439ee3">partial_redraw_array_merge</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[i].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>, handles[a].<a class="code" href="../../d9/d51/structProjectHandle.html#a42b7a37871bab42e93005c0f195b9ae6">projImages</a>[i].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>, <a class="code" href="../../df/d60/paint__image_8c.html#ac38a16989f7eed4fc93978613e4e28cd">PROJ_BOUNDBOX_SQUARED</a>);
<a name="l04086"></a>04086         }
<a name="l04087"></a>04087         
<a name="l04088"></a>04088         <span class="keywordflow">if</span> (touch) {
<a name="l04089"></a>04089             ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d64/structProjPaintImage.html#a6aedd585fd4d2c776ec01927725c5999">touch</a> = 1;
<a name="l04090"></a>04090             touch_any = 1;
<a name="l04091"></a>04091         }
<a name="l04092"></a>04092     }
<a name="l04093"></a>04093     
<a name="l04094"></a>04094     <span class="keywordflow">return</span> touch_any;
<a name="l04095"></a>04095 }
<a name="l04096"></a>04096 
<a name="l04097"></a>04097 
<a name="l04098"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab8c4dc3f97a466b10de1293b3bfba515">04098</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab8c4dc3f97a466b10de1293b3bfba515">project_paint_sub_stroke</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(prevmval_i[2]), <span class="keyword">const</span> <span class="keywordtype">int</span> mval_i[2], <span class="keywordtype">double</span> time, <span class="keywordtype">float</span> pressure)
<a name="l04099"></a>04099 {
<a name="l04100"></a>04100     
<a name="l04101"></a>04101     <span class="comment">/* Use mouse coords as floats for projection painting */</span>
<a name="l04102"></a>04102     <span class="keywordtype">float</span> pos[2];
<a name="l04103"></a>04103     
<a name="l04104"></a>04104     pos[0] = (float)(mval_i[0]);
<a name="l04105"></a>04105     pos[1] = (float)(mval_i[1]);
<a name="l04106"></a>04106     
<a name="l04107"></a>04107     <span class="comment">// we may want to use this later </span>
<a name="l04108"></a>04108     <span class="comment">// brush_painter_require_imbuf(painter, ((ibuf-&gt;rect_float)? 1: 0), 0, 0);</span>
<a name="l04109"></a>04109     
<a name="l04110"></a>04110     <span class="keywordflow">if</span> (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a732ac43ad904347516905410b680b36f">brush_painter_paint</a>(painter, <a class="code" href="../../df/d60/paint__image_8c.html#ac6240e69a5f47dc2023d8a3e39531605">project_paint_op</a>, pos, time, pressure, ps, 0)) {
<a name="l04111"></a>04111         <span class="keywordflow">return</span> 1;
<a name="l04112"></a>04112     }
<a name="l04113"></a>04113     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l04114"></a>04114 }
<a name="l04115"></a>04115 
<a name="l04116"></a>04116 
<a name="l04117"></a><a class="code" href="../../df/d60/paint__image_8c.html#aab68b8225c6afb02dfcdc4da2e8f7a10">04117</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#aab68b8225c6afb02dfcdc4da2e8f7a10">project_paint_stroke</a>(<a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps, <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keyword">const</span> <span class="keywordtype">int</span> prevmval_i[2], <span class="keyword">const</span> <span class="keywordtype">int</span> mval_i[2], <span class="keywordtype">double</span> time, <span class="keywordtype">float</span> pressure)
<a name="l04118"></a>04118 {
<a name="l04119"></a>04119     <span class="keywordtype">int</span> a, redraw;
<a name="l04120"></a>04120     
<a name="l04121"></a>04121     <span class="keywordflow">for</span> (a = 0; a &lt; ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; a++)
<a name="l04122"></a>04122         <a class="code" href="../../df/d60/paint__image_8c.html#a4b2d6a9b45a4de5f188c81f2c2a94485">partial_redraw_array_init</a>(ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[a].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>);
<a name="l04123"></a>04123     
<a name="l04124"></a>04124     redraw = <a class="code" href="../../df/d60/paint__image_8c.html#ab8c4dc3f97a466b10de1293b3bfba515">project_paint_sub_stroke</a>(ps, painter, prevmval_i, mval_i, time, pressure);
<a name="l04125"></a>04125     
<a name="l04126"></a>04126     <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a1554f85f438e1cbc5ac4e49f7c37e006">project_image_refresh_tagged</a>(ps))
<a name="l04127"></a>04127         <span class="keywordflow">return</span> redraw;
<a name="l04128"></a>04128     
<a name="l04129"></a>04129     <span class="keywordflow">return</span> 0;
<a name="l04130"></a>04130 }
<a name="l04131"></a>04131 
<a name="l04132"></a>04132 <span class="comment">/* Imagepaint Partial Redraw &amp; Dirty Region */</span>
<a name="l04133"></a>04133 
<a name="l04134"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae914b04c94418dd4a7282fdd806e42e8">04134</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae914b04c94418dd4a7282fdd806e42e8">imapaint_clear_partial_redraw</a>(<span class="keywordtype">void</span>)
<a name="l04135"></a>04135 {
<a name="l04136"></a>04136     memset(&amp;imapaintpartial, 0, <span class="keyword">sizeof</span>(imapaintpartial));
<a name="l04137"></a>04137 }
<a name="l04138"></a>04138 
<a name="l04139"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9208f196b34e445c533249de468372bf">04139</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9208f196b34e445c533249de468372bf">imapaint_dirty_region</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
<a name="l04140"></a>04140 {
<a name="l04141"></a>04141     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *tmpibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04142"></a>04142     <span class="keywordtype">int</span> srcx = 0, srcy = 0, origx;
<a name="l04143"></a>04143 
<a name="l04144"></a>04144     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a15a5bfbeb712924c5bd3742a768143ec">IMB_rectclip</a>(ibuf, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;x, &amp;y, &amp;srcx, &amp;srcy, &amp;w, &amp;h);
<a name="l04145"></a>04145 
<a name="l04146"></a>04146     <span class="keywordflow">if</span> (w == 0 || h == 0)
<a name="l04147"></a>04147         <span class="keywordflow">return</span>;
<a name="l04148"></a>04148     
<a name="l04149"></a>04149     <span class="keywordflow">if</span> (!imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ac57e97aa061db024a54300869b0cf856">enabled</a>) {
<a name="l04150"></a>04150         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a> = x;
<a name="l04151"></a>04151         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a> = y;
<a name="l04152"></a>04152         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> = x + w;
<a name="l04153"></a>04153         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> = y + h;
<a name="l04154"></a>04154         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ac57e97aa061db024a54300869b0cf856">enabled</a> = 1;
<a name="l04155"></a>04155     }
<a name="l04156"></a>04156     <span class="keywordflow">else</span> {
<a name="l04157"></a>04157         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>, x);
<a name="l04158"></a>04158         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>, y);
<a name="l04159"></a>04159         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a>, x + w);
<a name="l04160"></a>04160         imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a>, y + h);
<a name="l04161"></a>04161     }
<a name="l04162"></a>04162 
<a name="l04163"></a>04163     w = ((x + w - 1) &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>);
<a name="l04164"></a>04164     h = ((y + h - 1) &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>);
<a name="l04165"></a>04165     origx = (x &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>);
<a name="l04166"></a>04166     y = (y &gt;&gt; <a class="code" href="../../df/d60/paint__image_8c.html#a5642337e90c9f9f4f598e1262cf4c57c">IMAPAINT_TILE_BITS</a>);
<a name="l04167"></a>04167     
<a name="l04168"></a>04168     <span class="keywordflow">for</span> (; y &lt;= h; y++)
<a name="l04169"></a>04169         <span class="keywordflow">for</span> (x = origx; x &lt;= w; x++)
<a name="l04170"></a>04170             <a class="code" href="../../df/d60/paint__image_8c.html#a9890215840305f6195ffd5deb672ab8e">image_undo_push_tile</a>(ima, ibuf, &amp;tmpibuf, x, y);
<a name="l04171"></a>04171 
<a name="l04172"></a>04172     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l04173"></a>04173     
<a name="l04174"></a>04174     <span class="keywordflow">if</span> (tmpibuf)
<a name="l04175"></a>04175         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tmpibuf);
<a name="l04176"></a>04176 }
<a name="l04177"></a>04177 
<a name="l04178"></a><a class="code" href="../../df/d60/paint__image_8c.html#a5b98d3b6f04aea7acf08e2096c9527b5">04178</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5b98d3b6f04aea7acf08e2096c9527b5">imapaint_image_update</a>(<a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">short</span> texpaint)
<a name="l04179"></a>04179 {
<a name="l04180"></a>04180     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l04181"></a>04181         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a92a02dd4555f75018da42d96eb8d150f">IB_RECT_INVALID</a>;  <span class="comment">/* force recreate of char rect */</span>
<a name="l04182"></a>04182     
<a name="l04183"></a>04183     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0])
<a name="l04184"></a>04184         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l04185"></a>04185 
<a name="l04186"></a>04186     <span class="comment">/* todo: should set_tpage create -&gt;rect? */</span>
<a name="l04187"></a>04187     <span class="keywordflow">if</span> (texpaint || (sima &amp;&amp; sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a0893ac8e618be47c31334a0804c5b598">lock</a>)) {
<a name="l04188"></a>04188         <span class="keywordtype">int</span> w = imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ade3d8559d61f59475f3b123fe2c0a428">x2</a> - imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>;
<a name="l04189"></a>04189         <span class="keywordtype">int</span> h = imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#acbc76d5f4227c23108a9995803e0ebb8">y2</a> - imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>;
<a name="l04190"></a>04190         <span class="comment">/* Testing with partial update in uv editor too */</span>
<a name="l04191"></a>04191         <a class="code" href="../../d3/df0/GPU__draw_8h.html#a3f794257bd3da59116c32923acd83caf">GPU_paint_update_image</a>(image, imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#ab314c29c034c00b24d3d0ce5d3a761c9">x1</a>, imapaintpartial.<a class="code" href="../../da/d29/structImagePaintPartialRedraw.html#adfdc89272882a70ffed541f54780be6e">y1</a>, w, h, 0); 
<a name="l04192"></a>04192     }
<a name="l04193"></a>04193 }
<a name="l04194"></a>04194 
<a name="l04195"></a>04195 <span class="comment">/* Image Paint Operations */</span>
<a name="l04196"></a>04196 
<a name="l04197"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">04197</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">imapaint_ibuf_get_set_rgb</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">short</span> torus, <span class="keywordtype">short</span> <span class="keyword">set</span>, <span class="keywordtype">float</span> *rgb)
<a name="l04198"></a>04198 {
<a name="l04199"></a>04199     <span class="keywordflow">if</span> (torus) {
<a name="l04200"></a>04200         x %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04201"></a>04201         <span class="keywordflow">if</span> (x &lt; 0) x += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04202"></a>04202         y %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04203"></a>04203         <span class="keywordflow">if</span> (y &lt; 0) y += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04204"></a>04204     }
<a name="l04205"></a>04205 
<a name="l04206"></a>04206     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l04207"></a>04207         <span class="keywordtype">float</span> *rrgbf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * y + x) * 4;
<a name="l04208"></a>04208 
<a name="l04209"></a>04209         <span class="keywordflow">if</span> (<span class="keyword">set</span>) {
<a name="l04210"></a>04210             <a class="code" href="../../df/d60/paint__image_8c.html#a5f564d2f4c956db995f117e80f3b6611">IMAPAINT_FLOAT_RGB_COPY</a>(rrgbf, rgb);
<a name="l04211"></a>04211         }
<a name="l04212"></a>04212         <span class="keywordflow">else</span> {
<a name="l04213"></a>04213             <a class="code" href="../../df/d60/paint__image_8c.html#a5f564d2f4c956db995f117e80f3b6611">IMAPAINT_FLOAT_RGB_COPY</a>(rgb, rrgbf);
<a name="l04214"></a>04214         }
<a name="l04215"></a>04215     }
<a name="l04216"></a>04216     <span class="keywordflow">else</span> {
<a name="l04217"></a>04217         <span class="keywordtype">char</span> *rrgb = (<span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * y + x) * 4;
<a name="l04218"></a>04218 
<a name="l04219"></a>04219         <span class="keywordflow">if</span> (<span class="keyword">set</span>) {
<a name="l04220"></a>04220             <a class="code" href="../../df/d60/paint__image_8c.html#a5ae2e8f12c6c2bc0560daced034d6414">IMAPAINT_FLOAT_RGB_TO_CHAR</a>(rrgb, rgb)
<a name="l04221"></a>04221         }
<a name="l04222"></a>04222         <span class="keywordflow">else</span> {
<a name="l04223"></a>04223             <a class="code" href="../../df/d60/paint__image_8c.html#a9c95c409b2d5cf8fc2ddc25badf7be11">IMAPAINT_CHAR_RGB_TO_FLOAT</a>(rgb, rrgb)
<a name="l04224"></a>04224         }
<a name="l04225"></a>04225     }
<a name="l04226"></a>04226 }
<a name="l04227"></a>04227 
<a name="l04228"></a><a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">04228</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> x, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> y, <span class="keywordtype">float</span> *outrgb, <span class="keywordtype">short</span> torus)
<a name="l04229"></a>04229 {
<a name="l04230"></a>04230     <span class="keywordtype">float</span> inrgb[3];
<a name="l04231"></a>04231 
<a name="l04232"></a>04232     <span class="comment">// XXX: signed unsigned mismatch</span>
<a name="l04233"></a>04233     <span class="keywordflow">if</span> ((x &gt;= (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>)) || (y &gt;= (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>))) {
<a name="l04234"></a>04234         <span class="keywordflow">if</span> (torus) <a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">imapaint_ibuf_get_set_rgb</a>(ibuf, x, y, 1, 0, inrgb);
<a name="l04235"></a>04235         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l04236"></a>04236     }
<a name="l04237"></a>04237     <span class="keywordflow">else</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">imapaint_ibuf_get_set_rgb</a>(ibuf, x, y, 0, 0, inrgb);
<a name="l04238"></a>04238 
<a name="l04239"></a>04239     outrgb[0] += inrgb[0];
<a name="l04240"></a>04240     outrgb[1] += inrgb[1];
<a name="l04241"></a>04241     outrgb[2] += inrgb[2];
<a name="l04242"></a>04242 
<a name="l04243"></a>04243     <span class="keywordflow">return</span> 1;
<a name="l04244"></a>04244 }
<a name="l04245"></a>04245 
<a name="l04246"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae6c29932eed13238c66719f43fcdfdf8">04246</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae6c29932eed13238c66719f43fcdfdf8">imapaint_lift_soften</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibufb, <span class="keywordtype">int</span> *pos, <span class="keywordtype">short</span> torus)
<a name="l04247"></a>04247 {
<a name="l04248"></a>04248     <span class="keywordtype">int</span> x, y, count, xi, yi, xo, yo;
<a name="l04249"></a>04249     <span class="keywordtype">int</span> out_off[2], in_off[2], dim[2];
<a name="l04250"></a>04250     <span class="keywordtype">float</span> outrgb[3];
<a name="l04251"></a>04251 
<a name="l04252"></a>04252     dim[0] = ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04253"></a>04253     dim[1] = ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04254"></a>04254     in_off[0] = pos[0];
<a name="l04255"></a>04255     in_off[1] = pos[1];
<a name="l04256"></a>04256     out_off[0] = out_off[1] = 0;
<a name="l04257"></a>04257 
<a name="l04258"></a>04258     <span class="keywordflow">if</span> (!torus) {
<a name="l04259"></a>04259         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a15a5bfbeb712924c5bd3742a768143ec">IMB_rectclip</a>(ibuf, ibufb, &amp;in_off[0], &amp;in_off[1], &amp;out_off[0],
<a name="l04260"></a>04260                      &amp;out_off[1], &amp;dim[0], &amp;dim[1]);
<a name="l04261"></a>04261 
<a name="l04262"></a>04262         <span class="keywordflow">if</span> ((dim[0] == 0) || (dim[1] == 0))
<a name="l04263"></a>04263             <span class="keywordflow">return</span>;
<a name="l04264"></a>04264     }
<a name="l04265"></a>04265 
<a name="l04266"></a>04266     <span class="keywordflow">for</span> (y = 0; y &lt; dim[1]; y++) {
<a name="l04267"></a>04267         <span class="keywordflow">for</span> (x = 0; x &lt; dim[0]; x++) {
<a name="l04268"></a>04268             <span class="comment">/* get input pixel */</span>
<a name="l04269"></a>04269             xi = in_off[0] + x;
<a name="l04270"></a>04270             yi = in_off[1] + y;
<a name="l04271"></a>04271 
<a name="l04272"></a>04272             count = 1;
<a name="l04273"></a>04273             <a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">imapaint_ibuf_get_set_rgb</a>(ibuf, xi, yi, torus, 0, outrgb);
<a name="l04274"></a>04274 
<a name="l04275"></a>04275             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi - 1, yi - 1, outrgb, torus);
<a name="l04276"></a>04276             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi - 1, yi, outrgb, torus);
<a name="l04277"></a>04277             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi - 1, yi + 1, outrgb, torus);
<a name="l04278"></a>04278 
<a name="l04279"></a>04279             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi, yi - 1, outrgb, torus);
<a name="l04280"></a>04280             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi, yi + 1, outrgb, torus);
<a name="l04281"></a>04281 
<a name="l04282"></a>04282             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi + 1, yi - 1, outrgb, torus);
<a name="l04283"></a>04283             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi + 1, yi, outrgb, torus);
<a name="l04284"></a>04284             count += <a class="code" href="../../df/d60/paint__image_8c.html#a0ceaaf192340e15a92862f6aa8832b23">imapaint_ibuf_add_if</a>(ibuf, xi + 1, yi + 1, outrgb, torus);
<a name="l04285"></a>04285 
<a name="l04286"></a>04286             outrgb[0] /= count;
<a name="l04287"></a>04287             outrgb[1] /= count;
<a name="l04288"></a>04288             outrgb[2] /= count;
<a name="l04289"></a>04289 
<a name="l04290"></a>04290             <span class="comment">/* write into brush buffer */</span>
<a name="l04291"></a>04291             xo = out_off[0] + x;
<a name="l04292"></a>04292             yo = out_off[1] + y;
<a name="l04293"></a>04293             <a class="code" href="../../df/d60/paint__image_8c.html#ae3104209a2a15276044b235449978342">imapaint_ibuf_get_set_rgb</a>(ibufb, xo, yo, 0, 1, outrgb);
<a name="l04294"></a>04294         }
<a name="l04295"></a>04295     }
<a name="l04296"></a>04296 }
<a name="l04297"></a>04297 
<a name="l04298"></a><a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">04298</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(<a class="code" href="../../df/d22/structImagePaintRegion.html">ImagePaintRegion</a> *region, <span class="keywordtype">int</span> destx, <span class="keywordtype">int</span> desty, <span class="keywordtype">int</span> srcx, <span class="keywordtype">int</span> srcy, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height)
<a name="l04299"></a>04299 {
<a name="l04300"></a>04300     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a91f0c6d1df0d50eab795023effd3af0d">destx</a> = destx;
<a name="l04301"></a>04301     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">desty</a> = desty;
<a name="l04302"></a>04302     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#ace65e35ccfb746ff4256e29c71e110a4">srcx</a> = srcx;
<a name="l04303"></a>04303     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a854278cd9a8991d4be7f332d2b1e8a30">srcy</a> = srcy;
<a name="l04304"></a>04304     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">width</a> = width;
<a name="l04305"></a>04305     region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a6acd82cf1b0c96d4819ee42debf53238">height</a> = height;
<a name="l04306"></a>04306 }
<a name="l04307"></a>04307 
<a name="l04308"></a><a class="code" href="../../df/d60/paint__image_8c.html#a02012521cdb2094a8e63459b999fcbfb">04308</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a02012521cdb2094a8e63459b999fcbfb">imapaint_torus_split_region</a>(<a class="code" href="../../df/d22/structImagePaintRegion.html">ImagePaintRegion</a> region[4], <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *dbuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *sbuf)
<a name="l04309"></a>04309 {
<a name="l04310"></a>04310     <span class="keywordtype">int</span> destx = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a91f0c6d1df0d50eab795023effd3af0d">destx</a>;
<a name="l04311"></a>04311     <span class="keywordtype">int</span> desty = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">desty</a>;
<a name="l04312"></a>04312     <span class="keywordtype">int</span> srcx = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#ace65e35ccfb746ff4256e29c71e110a4">srcx</a>;
<a name="l04313"></a>04313     <span class="keywordtype">int</span> srcy = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a854278cd9a8991d4be7f332d2b1e8a30">srcy</a>;
<a name="l04314"></a>04314     <span class="keywordtype">int</span> width = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">width</a>;
<a name="l04315"></a>04315     <span class="keywordtype">int</span> height = region-&gt;<a class="code" href="../../df/d22/structImagePaintRegion.html#a6acd82cf1b0c96d4819ee42debf53238">height</a>;
<a name="l04316"></a>04316     <span class="keywordtype">int</span> origw, origh, w, h, tot = 0;
<a name="l04317"></a>04317 
<a name="l04318"></a>04318     <span class="comment">/* convert destination and source coordinates to be within image */</span>
<a name="l04319"></a>04319     destx = destx % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04320"></a>04320     <span class="keywordflow">if</span> (destx &lt; 0) destx += dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04321"></a>04321     desty = desty % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04322"></a>04322     <span class="keywordflow">if</span> (desty &lt; 0) desty += dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04323"></a>04323     srcx = srcx % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04324"></a>04324     <span class="keywordflow">if</span> (srcx &lt; 0) srcx += sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04325"></a>04325     srcy = srcy % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04326"></a>04326     <span class="keywordflow">if</span> (srcy &lt; 0) srcy += sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04327"></a>04327 
<a name="l04328"></a>04328     <span class="comment">/* clip width of blending area to destination imbuf, to avoid writing the</span>
<a name="l04329"></a>04329 <span class="comment">     * same pixel twice */</span>
<a name="l04330"></a>04330     origw = w = (width &gt; dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) ? dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> : width;
<a name="l04331"></a>04331     origh = h = (height &gt; dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) ? dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> : height;
<a name="l04332"></a>04332 
<a name="l04333"></a>04333     <span class="comment">/* clip within image */</span>
<a name="l04334"></a>04334     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a15a5bfbeb712924c5bd3742a768143ec">IMB_rectclip</a>(dbuf, sbuf, &amp;destx, &amp;desty, &amp;srcx, &amp;srcy, &amp;w, &amp;h);
<a name="l04335"></a>04335     <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(&amp;region[tot++], destx, desty, srcx, srcy, w, h);
<a name="l04336"></a>04336 
<a name="l04337"></a>04337     <span class="comment">/* do 3 other rects if needed */</span>
<a name="l04338"></a>04338     <span class="keywordflow">if</span> (w &lt; origw)
<a name="l04339"></a>04339         <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(&amp;region[tot++], (destx + w) % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, desty, (srcx + w) % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, srcy, origw - w, h);
<a name="l04340"></a>04340     <span class="keywordflow">if</span> (h &lt; origh)
<a name="l04341"></a>04341         <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(&amp;region[tot++], destx, (desty + h) % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, srcx, (srcy + h) % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, w, origh - h);
<a name="l04342"></a>04342     <span class="keywordflow">if</span> ((w &lt; origw) &amp;&amp; (h &lt; origh))
<a name="l04343"></a>04343         <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(&amp;region[tot++], (destx + w) % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (desty + h) % dbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, (srcx + w) % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (srcy + h) % sbuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, origw - w, origh - h);
<a name="l04344"></a>04344     
<a name="l04345"></a>04345     <span class="keywordflow">return</span> tot;
<a name="l04346"></a>04346 }
<a name="l04347"></a>04347 
<a name="l04348"></a><a class="code" href="../../df/d60/paint__image_8c.html#aef6ba279d9e937c8657b12ddcf5aa57e">04348</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#aef6ba279d9e937c8657b12ddcf5aa57e">imapaint_lift_smear</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibufb, <span class="keywordtype">int</span> *pos)
<a name="l04349"></a>04349 {
<a name="l04350"></a>04350     <a class="code" href="../../df/d22/structImagePaintRegion.html">ImagePaintRegion</a> region[4];
<a name="l04351"></a>04351     <span class="keywordtype">int</span> a, tot;
<a name="l04352"></a>04352 
<a name="l04353"></a>04353     <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(region, 0, 0, pos[0], pos[1], ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l04354"></a>04354     tot = <a class="code" href="../../df/d60/paint__image_8c.html#a02012521cdb2094a8e63459b999fcbfb">imapaint_torus_split_region</a>(region, ibufb, ibuf);
<a name="l04355"></a>04355 
<a name="l04356"></a>04356     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++)
<a name="l04357"></a>04357         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2343096585732799595ffd77aba1a7bf">IMB_rectblend</a>(ibufb, ibuf, region[a].destx, region[a].desty,
<a name="l04358"></a>04358                       region[a].srcx, region[a].srcy,
<a name="l04359"></a>04359                       region[a].width, region[a].height, <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841ab2e28eb4980b552ab69f8e3daff16336">IMB_BLEND_COPY_RGB</a>);
<a name="l04360"></a>04360 }
<a name="l04361"></a>04361 
<a name="l04362"></a><a class="code" href="../../df/d60/paint__image_8c.html#aa5c1db2b1985009042c3f99157d0186c">04362</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../df/d60/paint__image_8c.html#aa5c1db2b1985009042c3f99157d0186c">imapaint_lift_clone</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibufb, <span class="keywordtype">int</span> *pos)
<a name="l04363"></a>04363 {
<a name="l04364"></a>04364     <span class="comment">/* note: allocImbuf returns zero&#39;d memory, so regions outside image will</span>
<a name="l04365"></a>04365 <span class="comment">     * have zero alpha, and hence not be blended onto the image */</span>
<a name="l04366"></a>04366     <span class="keywordtype">int</span> w = ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, h = ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, destx = 0, desty = 0, srcx = pos[0], srcy = pos[1];
<a name="l04367"></a>04367     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *clonebuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(w, h, ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>, ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a>);
<a name="l04368"></a>04368 
<a name="l04369"></a>04369     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a15a5bfbeb712924c5bd3742a768143ec">IMB_rectclip</a>(clonebuf, ibuf, &amp;destx, &amp;desty, &amp;srcx, &amp;srcy, &amp;w, &amp;h);
<a name="l04370"></a>04370     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2343096585732799595ffd77aba1a7bf">IMB_rectblend</a>(clonebuf, ibuf, destx, desty, srcx, srcy, w, h,
<a name="l04371"></a>04371                   <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841ab2e28eb4980b552ab69f8e3daff16336">IMB_BLEND_COPY_RGB</a>);
<a name="l04372"></a>04372     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2343096585732799595ffd77aba1a7bf">IMB_rectblend</a>(clonebuf, ibufb, destx, desty, destx, desty, w, h,
<a name="l04373"></a>04373                   <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841ac271e4db8fdabccc29ddbf6cab191f12">IMB_BLEND_COPY_ALPHA</a>);
<a name="l04374"></a>04374 
<a name="l04375"></a>04375     <span class="keywordflow">return</span> clonebuf;
<a name="l04376"></a>04376 }
<a name="l04377"></a>04377 
<a name="l04378"></a><a class="code" href="../../df/d60/paint__image_8c.html#a86cedff5506e741cfec6e6db0ed700ef">04378</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a86cedff5506e741cfec6e6db0ed700ef">imapaint_convert_brushco</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibufb, <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2], <span class="keywordtype">int</span> ipos[2])
<a name="l04379"></a>04379 {
<a name="l04380"></a>04380     ipos[0] = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>((pos[0] - ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> / 2) + 1.0f);
<a name="l04381"></a>04381     ipos[1] = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>((pos[1] - ibufb-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> / 2) + 1.0f);
<a name="l04382"></a>04382 }
<a name="l04383"></a>04383 
<a name="l04384"></a>04384 <span class="comment">/* dosnt run for projection painting</span>
<a name="l04385"></a>04385 <span class="comment"> * only the old style painting in the 3d view */</span>
<a name="l04386"></a><a class="code" href="../../df/d60/paint__image_8c.html#a42a599ab368d3a5d73d7e02f1c0c0e02">04386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a42a599ab368d3a5d73d7e02f1c0c0e02">imapaint_paint_op</a>(<span class="keywordtype">void</span> *state, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibufb, <span class="keyword">const</span> <span class="keywordtype">float</span> lastpos[2], <span class="keyword">const</span> <span class="keywordtype">float</span> pos[2])
<a name="l04387"></a>04387 {
<a name="l04388"></a>04388     <a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s = ((<a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *)state);
<a name="l04389"></a>04389     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *clonebuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *frombuf;
<a name="l04390"></a>04390     <a class="code" href="../../df/d22/structImagePaintRegion.html">ImagePaintRegion</a> region[4];
<a name="l04391"></a>04391     <span class="keywordtype">short</span> torus = s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa3d163933e82fcfe43e2b5e65fd307aa7">BRUSH_TORUS</a>;
<a name="l04392"></a>04392     <span class="keywordtype">short</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a> = s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a8d48f247e4e2fe00576f2cae6d39b1b7">blend</a>;
<a name="l04393"></a>04393     <span class="keywordtype">float</span> *offset = s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>;
<a name="l04394"></a>04394     <span class="keywordtype">float</span> liftpos[2];
<a name="l04395"></a>04395     <span class="keywordtype">int</span> bpos[2], blastpos[2], bliftpos[2];
<a name="l04396"></a>04396     <span class="keywordtype">int</span> a, tot;
<a name="l04397"></a>04397 
<a name="l04398"></a>04398     <a class="code" href="../../df/d60/paint__image_8c.html#a86cedff5506e741cfec6e6db0ed700ef">imapaint_convert_brushco</a>(ibufb, pos, bpos);
<a name="l04399"></a>04399 
<a name="l04400"></a>04400     <span class="comment">/* lift from canvas */</span>
<a name="l04401"></a>04401     <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a19deab8694f5fc2c8ad4bd3340d89266">PAINT_TOOL_SOFTEN</a>) {
<a name="l04402"></a>04402         <a class="code" href="../../df/d60/paint__image_8c.html#ae6c29932eed13238c66719f43fcdfdf8">imapaint_lift_soften</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>, ibufb, bpos, torus);
<a name="l04403"></a>04403     }
<a name="l04404"></a>04404     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa2144bb61a8ed41729a963353f30cab">PAINT_TOOL_SMEAR</a>) {
<a name="l04405"></a>04405         <span class="keywordflow">if</span> (lastpos[0] == pos[0] &amp;&amp; lastpos[1] == pos[1])
<a name="l04406"></a>04406             <span class="keywordflow">return</span> 0;
<a name="l04407"></a>04407 
<a name="l04408"></a>04408         <a class="code" href="../../df/d60/paint__image_8c.html#a86cedff5506e741cfec6e6db0ed700ef">imapaint_convert_brushco</a>(ibufb, lastpos, blastpos);
<a name="l04409"></a>04409         <a class="code" href="../../df/d60/paint__image_8c.html#aef6ba279d9e937c8657b12ddcf5aa57e">imapaint_lift_smear</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>, ibufb, blastpos);
<a name="l04410"></a>04410     }
<a name="l04411"></a>04411     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a> &amp;&amp; s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>) {
<a name="l04412"></a>04412         liftpos[0] = pos[0] - offset[0] * s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04413"></a>04413         liftpos[1] = pos[1] - offset[1] * s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04414"></a>04414 
<a name="l04415"></a>04415         <a class="code" href="../../df/d60/paint__image_8c.html#a86cedff5506e741cfec6e6db0ed700ef">imapaint_convert_brushco</a>(ibufb, liftpos, bliftpos);
<a name="l04416"></a>04416         clonebuf = <a class="code" href="../../df/d60/paint__image_8c.html#aa5c1db2b1985009042c3f99157d0186c">imapaint_lift_clone</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>, ibufb, bliftpos);
<a name="l04417"></a>04417     }
<a name="l04418"></a>04418 
<a name="l04419"></a>04419     frombuf = (clonebuf) ? clonebuf : ibufb;
<a name="l04420"></a>04420 
<a name="l04421"></a>04421     <span class="keywordflow">if</span> (torus) {
<a name="l04422"></a>04422         <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(region, bpos[0], bpos[1], 0, 0, frombuf-&gt;x, frombuf-&gt;y);
<a name="l04423"></a>04423         tot = <a class="code" href="../../df/d60/paint__image_8c.html#a02012521cdb2094a8e63459b999fcbfb">imapaint_torus_split_region</a>(region, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>, frombuf);
<a name="l04424"></a>04424     }
<a name="l04425"></a>04425     <span class="keywordflow">else</span> {
<a name="l04426"></a>04426         <a class="code" href="../../df/d60/paint__image_8c.html#a254bd4a7a20570d030bb335ea3026715">imapaint_set_region</a>(region, bpos[0], bpos[1], 0, 0, frombuf-&gt;x, frombuf-&gt;y);
<a name="l04427"></a>04427         tot = 1;
<a name="l04428"></a>04428     }
<a name="l04429"></a>04429 
<a name="l04430"></a>04430     <span class="comment">/* blend into canvas */</span>
<a name="l04431"></a>04431     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++) {
<a name="l04432"></a>04432         <a class="code" href="../../df/d60/paint__image_8c.html#a9208f196b34e445c533249de468372bf">imapaint_dirty_region</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>,
<a name="l04433"></a>04433                               region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a91f0c6d1df0d50eab795023effd3af0d">destx</a>, region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">desty</a>,
<a name="l04434"></a>04434                               region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">width</a>, region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a6acd82cf1b0c96d4819ee42debf53238">height</a>);
<a name="l04435"></a>04435         
<a name="l04436"></a>04436         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a2343096585732799595ffd77aba1a7bf">IMB_rectblend</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>, frombuf,
<a name="l04437"></a>04437                       region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a91f0c6d1df0d50eab795023effd3af0d">destx</a>, region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a0035fbe376436d1f50dfe391aae417b6">desty</a>,
<a name="l04438"></a>04438                       region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#ace65e35ccfb746ff4256e29c71e110a4">srcx</a>, region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a854278cd9a8991d4be7f332d2b1e8a30">srcy</a>,
<a name="l04439"></a>04439                       region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a8e40ddc30252552df27072dd91b5fd07">width</a>, region[a].<a class="code" href="../../df/d22/structImagePaintRegion.html#a6acd82cf1b0c96d4819ee42debf53238">height</a>, blend);
<a name="l04440"></a>04440     }
<a name="l04441"></a>04441 
<a name="l04442"></a>04442     <span class="keywordflow">if</span> (clonebuf) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(clonebuf);
<a name="l04443"></a>04443 
<a name="l04444"></a>04444     <span class="keywordflow">return</span> 1;
<a name="l04445"></a>04445 }
<a name="l04446"></a>04446 
<a name="l04447"></a>04447 <span class="comment">/* 3D TexturePaint */</span>
<a name="l04448"></a>04448 
<a name="l04449"></a><a class="code" href="../../df/d60/paint__image_8c.html#a919f25bd3fef9d0455f2f5283dfb4721">04449</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a919f25bd3fef9d0455f2f5283dfb4721">texpaint_break_stroke</a>(<span class="keywordtype">float</span> *prevuv, <span class="keywordtype">float</span> *fwuv, <span class="keywordtype">float</span> *bkuv, <span class="keywordtype">float</span> *uv)
<a name="l04450"></a>04450 {
<a name="l04451"></a>04451     <span class="keywordtype">float</span> d1[2], d2[2];
<a name="l04452"></a>04452     <span class="keywordtype">float</span> mismatch = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(fwuv, uv);
<a name="l04453"></a>04453     <span class="keywordtype">float</span> len1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(prevuv, fwuv);
<a name="l04454"></a>04454     <span class="keywordtype">float</span> len2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(bkuv, uv);
<a name="l04455"></a>04455 
<a name="l04456"></a>04456     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(d1, fwuv, prevuv);
<a name="l04457"></a>04457     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(d2, uv, bkuv);
<a name="l04458"></a>04458 
<a name="l04459"></a>04459     <span class="keywordflow">return</span> ((<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(d1, d2) &lt; 0.0f) || (mismatch &gt; <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(len1, len2) * 2));
<a name="l04460"></a>04460 }
<a name="l04461"></a>04461 
<a name="l04462"></a>04462 <span class="comment">/* ImagePaint Common */</span>
<a name="l04463"></a>04463 
<a name="l04464"></a><a class="code" href="../../df/d60/paint__image_8c.html#a150deb75d1694c883fb3b52118454591">04464</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a150deb75d1694c883fb3b52118454591">imapaint_canvas_set</a>(<a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l04465"></a>04465 {
<a name="l04466"></a>04466     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> ? &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04467"></a>04467     
<a name="l04468"></a>04468     <span class="comment">/* verify that we can paint and set canvas */</span>
<a name="l04469"></a>04469     <span class="keywordflow">if</span> (ima == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04470"></a>04470         <span class="keywordflow">return</span> 0;
<a name="l04471"></a>04471     }
<a name="l04472"></a>04472     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l04473"></a>04473         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">warnpackedfile</a> = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2;
<a name="l04474"></a>04474         <span class="keywordflow">return</span> 0;
<a name="l04475"></a>04475     }   
<a name="l04476"></a>04476     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> != 4) {
<a name="l04477"></a>04477         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">warnmultifile</a> = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2;
<a name="l04478"></a>04478         <span class="keywordflow">return</span> 0;
<a name="l04479"></a>04479     }
<a name="l04480"></a>04480     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ibuf || !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> || ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>))
<a name="l04481"></a>04481         <span class="keywordflow">return</span> 0;
<a name="l04482"></a>04482 
<a name="l04483"></a>04483     s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a> = ima;
<a name="l04484"></a>04484     s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a> = ibuf;
<a name="l04485"></a>04485 
<a name="l04486"></a>04486     <span class="comment">/* set clone canvas */</span>
<a name="l04487"></a>04487     <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>) {
<a name="l04488"></a>04488         ima = s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>;
<a name="l04489"></a>04489         ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> ? &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04490"></a>04490         
<a name="l04491"></a>04491         <span class="keywordflow">if</span> (!ima || !ibuf || !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> || ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>))
<a name="l04492"></a>04492             <span class="keywordflow">return</span> 0;
<a name="l04493"></a>04493 
<a name="l04494"></a>04494         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a> = ibuf;
<a name="l04495"></a>04495 
<a name="l04496"></a>04496         <span class="comment">/* temporarily add float rect for cloning */</span>
<a name="l04497"></a>04497         <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; !s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l04498"></a>04498             <span class="keywordtype">int</span> profile = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a5a4ca931467afcec1f255cd469ec5433">IB_PROFILE_NONE</a>;
<a name="l04499"></a>04499             
<a name="l04500"></a>04500             <span class="comment">/* Don&#39;t want to color manage, but don&#39;t disturb existing profiles */</span>
<a name="l04501"></a>04501             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">int</span>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a>, profile);
<a name="l04502"></a>04502 
<a name="l04503"></a>04503             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0484659502ef804f57a4dd6c9d3b6d6c">IMB_float_from_rect</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>);
<a name="l04504"></a>04504             s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ae40c7c442e4ad1c71a2c2ecb4cee19">clonefreefloat</a> = 1;
<a name="l04505"></a>04505             
<a name="l04506"></a>04506             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">int</span>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a>, profile);
<a name="l04507"></a>04507         }
<a name="l04508"></a>04508         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ab944b398a1c2efc95db5a2ea2e48443c">canvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; !s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>)
<a name="l04509"></a>04509             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a3af34b4b5c6b91ddf5b872fcb9e2d66c">IMB_rect_from_float</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>);
<a name="l04510"></a>04510     }
<a name="l04511"></a>04511 
<a name="l04512"></a>04512     <span class="keywordflow">return</span> 1;
<a name="l04513"></a>04513 }
<a name="l04514"></a>04514 
<a name="l04515"></a><a class="code" href="../../df/d60/paint__image_8c.html#aa653e3e3854e25ee09ea0b6fa8baa2c1">04515</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#aa653e3e3854e25ee09ea0b6fa8baa2c1">imapaint_canvas_free</a>(<a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s)
<a name="l04516"></a>04516 {
<a name="l04517"></a>04517     <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ae40c7c442e4ad1c71a2c2ecb4cee19">clonefreefloat</a>)
<a name="l04518"></a>04518         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0d2ec7ce9e9b8e094f31e6a4535ce8d3">imb_freerectfloatImBuf</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#aa51a815fd90208e1905fc7e7017ebbdf">clonecanvas</a>);
<a name="l04519"></a>04519 }
<a name="l04520"></a>04520 
<a name="l04521"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">04521</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">imapaint_paint_sub_stroke</a>(<a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s, <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image, <span class="keywordtype">short</span> texpaint, <span class="keywordtype">float</span> *uv, <span class="keywordtype">double</span> time, <span class="keywordtype">int</span> <a class="code" href="../../d7/d49/node__composite__tree_8c.html#a8568effaf95c1efd2e0482ed79dfac4f">update</a>, <span class="keywordtype">float</span> pressure)
<a name="l04522"></a>04522 {
<a name="l04523"></a>04523     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(image, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> ? &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04524"></a>04524     <span class="keywordtype">float</span> pos[2];
<a name="l04525"></a>04525 
<a name="l04526"></a>04526     <span class="keywordflow">if</span> (!ibuf)
<a name="l04527"></a>04527         <span class="keywordflow">return</span> 0;
<a name="l04528"></a>04528 
<a name="l04529"></a>04529     pos[0] = uv[0] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l04530"></a>04530     pos[1] = uv[1] * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l04531"></a>04531 
<a name="l04532"></a>04532     <a class="code" href="../../da/dc9/BKE__brush_8h.html#a491a1be93918327ffa2779443fa73caa">brush_painter_require_imbuf</a>(painter, ((ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) ? 1 : 0), 0, 0);
<a name="l04533"></a>04533 
<a name="l04534"></a>04534     <span class="keywordflow">if</span> (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a732ac43ad904347516905410b680b36f">brush_painter_paint</a>(painter, <a class="code" href="../../df/d60/paint__image_8c.html#a42a599ab368d3a5d73d7e02f1c0c0e02">imapaint_paint_op</a>, pos, time, pressure, s, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> == <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>)) {
<a name="l04535"></a>04535         <span class="keywordflow">if</span> (update)
<a name="l04536"></a>04536             <a class="code" href="../../df/d60/paint__image_8c.html#a5b98d3b6f04aea7acf08e2096c9527b5">imapaint_image_update</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>, image, ibuf, texpaint);
<a name="l04537"></a>04537         <span class="keywordflow">return</span> 1;
<a name="l04538"></a>04538     }
<a name="l04539"></a>04539     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l04540"></a>04540 }
<a name="l04541"></a>04541 
<a name="l04542"></a><a class="code" href="../../df/d60/paint__image_8c.html#a651206999c256eee9726e0ad3485dcae">04542</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a651206999c256eee9726e0ad3485dcae">imapaint_paint_stroke</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s, <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *painter, <span class="keywordtype">short</span> texpaint, <span class="keyword">const</span> <span class="keywordtype">int</span> prevmval[2], <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">double</span> time, <span class="keywordtype">float</span> pressure)
<a name="l04543"></a>04543 {
<a name="l04544"></a>04544     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *newimage = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04545"></a>04545     <span class="keywordtype">float</span> fwuv[2], bkuv[2], newuv[2];
<a name="l04546"></a>04546     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> newfaceindex;
<a name="l04547"></a>04547     <span class="keywordtype">int</span> breakstroke = 0, redraw = 0;
<a name="l04548"></a>04548 
<a name="l04549"></a>04549     <span class="keywordflow">if</span> (texpaint) {
<a name="l04550"></a>04550         <span class="comment">/* pick new face and image */</span>
<a name="l04551"></a>04551         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6c/paint__intern_8h.html#a4bda7b1976ddbbfa542225324a51840c">imapaint_pick_face</a>(vc, mval, &amp;newfaceindex, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6c7ef713ea4db97f8f1c309a1242f9a3">dm_totface</a>) &amp;&amp;
<a name="l04552"></a>04552             ((s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a99d45f9f371cade14cca7b42de33bb0e">do_facesel</a> == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) || (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a101251ead8a3f30ec777ac67f9a38bec">dm_mface</a>[newfaceindex].<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>)))
<a name="l04553"></a>04553         {
<a name="l04554"></a>04554             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l04555"></a>04555             
<a name="l04556"></a>04556             newimage = <a class="code" href="../../df/d60/paint__image_8c.html#a9cc21c157177ac3f0c14231d18520a57">imapaint_face_image</a>(s, newfaceindex);
<a name="l04557"></a>04557             ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(newimage, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> ? &amp;s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#aab747e6c4e4e22d6d238bf13929cc775">iuser</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04558"></a>04558 
<a name="l04559"></a>04559             <span class="keywordflow">if</span> (ibuf &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>)
<a name="l04560"></a>04560                 <a class="code" href="../../d3/d6c/paint__intern_8h.html#afe83fbb731c729ce1f1e554e5c78aa63">imapaint_pick_uv</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>, newfaceindex, mval, newuv);
<a name="l04561"></a>04561             <span class="keywordflow">else</span> {
<a name="l04562"></a>04562                 newimage = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04563"></a>04563                 newuv[0] = newuv[1] = 0.0f;
<a name="l04564"></a>04564             }
<a name="l04565"></a>04565         }
<a name="l04566"></a>04566         <span class="keywordflow">else</span>
<a name="l04567"></a>04567             newuv[0] = newuv[1] = 0.0f;
<a name="l04568"></a>04568 
<a name="l04569"></a>04569         <span class="comment">/* see if stroke is broken, and if so finish painting in old position */</span>
<a name="l04570"></a>04570         <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>) {
<a name="l04571"></a>04571             <a class="code" href="../../d3/d6c/paint__intern_8h.html#afe83fbb731c729ce1f1e554e5c78aa63">imapaint_pick_uv</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ad7ebff08256d982e2c4560a78c657cae">faceindex</a>, mval, fwuv);
<a name="l04572"></a>04572             <a class="code" href="../../d3/d6c/paint__intern_8h.html#afe83fbb731c729ce1f1e554e5c78aa63">imapaint_pick_uv</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>, newfaceindex, prevmval, bkuv);
<a name="l04573"></a>04573 
<a name="l04574"></a>04574             <span class="keywordflow">if</span> (newimage == s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>)
<a name="l04575"></a>04575                 breakstroke = <a class="code" href="../../df/d60/paint__image_8c.html#a919f25bd3fef9d0455f2f5283dfb4721">texpaint_break_stroke</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6750ef16f1c448811f050896b91c0fe2">uv</a>, fwuv, bkuv, newuv);
<a name="l04576"></a>04576             <span class="keywordflow">else</span>
<a name="l04577"></a>04577                 breakstroke = 1;
<a name="l04578"></a>04578         }
<a name="l04579"></a>04579         <span class="keywordflow">else</span>
<a name="l04580"></a>04580             fwuv[0] = fwuv[1] = 0.0f;
<a name="l04581"></a>04581 
<a name="l04582"></a>04582         <span class="keywordflow">if</span> (breakstroke) {
<a name="l04583"></a>04583             <a class="code" href="../../d3/d6c/paint__intern_8h.html#afe83fbb731c729ce1f1e554e5c78aa63">imapaint_pick_uv</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ad7ebff08256d982e2c4560a78c657cae">faceindex</a>, mval, fwuv);
<a name="l04584"></a>04584             redraw |= <a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">imapaint_paint_sub_stroke</a>(s, painter, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>, texpaint,
<a name="l04585"></a>04585                                                 fwuv, time, 1, pressure);
<a name="l04586"></a>04586             <a class="code" href="../../df/d60/paint__image_8c.html#ae914b04c94418dd4a7282fdd806e42e8">imapaint_clear_partial_redraw</a>();
<a name="l04587"></a>04587             <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9c2cef2ed6fbc7ee51686cd6c7216073">brush_painter_break_stroke</a>(painter);
<a name="l04588"></a>04588         }
<a name="l04589"></a>04589 
<a name="l04590"></a>04590         <span class="comment">/* set new canvas */</span>
<a name="l04591"></a>04591         <span class="keywordflow">if</span> (newimage &amp;&amp; (newimage != s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>))
<a name="l04592"></a>04592             <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a150deb75d1694c883fb3b52118454591">imapaint_canvas_set</a>(s, newimage))
<a name="l04593"></a>04593                 newimage = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04594"></a>04594 
<a name="l04595"></a>04595         <span class="comment">/* paint in new image */</span>
<a name="l04596"></a>04596         <span class="keywordflow">if</span> (newimage) {
<a name="l04597"></a>04597             <span class="keywordflow">if</span> (breakstroke)
<a name="l04598"></a>04598                 redraw |= <a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">imapaint_paint_sub_stroke</a>(s, painter, newimage,
<a name="l04599"></a>04599                                                     texpaint, bkuv, time, 0, pressure);
<a name="l04600"></a>04600             redraw |= <a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">imapaint_paint_sub_stroke</a>(s, painter, newimage, texpaint,
<a name="l04601"></a>04601                                                 newuv, time, 1, pressure);
<a name="l04602"></a>04602         }
<a name="l04603"></a>04603 
<a name="l04604"></a>04604         <span class="comment">/* update state */</span>
<a name="l04605"></a>04605         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a> = newimage;
<a name="l04606"></a>04606         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ad7ebff08256d982e2c4560a78c657cae">faceindex</a> = newfaceindex;
<a name="l04607"></a>04607         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6750ef16f1c448811f050896b91c0fe2">uv</a>[0] = newuv[0];
<a name="l04608"></a>04608         s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6750ef16f1c448811f050896b91c0fe2">uv</a>[1] = newuv[1];
<a name="l04609"></a>04609     }
<a name="l04610"></a>04610     <span class="keywordflow">else</span> {
<a name="l04611"></a>04611         <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a82f2ec8b14d1535ec6ef400a98f02694">v2d</a>, mval[0], mval[1], &amp;newuv[0], &amp;newuv[1]);
<a name="l04612"></a>04612         redraw |= <a class="code" href="../../df/d60/paint__image_8c.html#ab594b38850587c869e39af5b5eea7ebe">imapaint_paint_sub_stroke</a>(s, painter, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>, texpaint, newuv,
<a name="l04613"></a>04613                                             time, 1, pressure);
<a name="l04614"></a>04614     }
<a name="l04615"></a>04615 
<a name="l04616"></a>04616     <span class="keywordflow">if</span> (redraw)
<a name="l04617"></a>04617         <a class="code" href="../../df/d60/paint__image_8c.html#ae914b04c94418dd4a7282fdd806e42e8">imapaint_clear_partial_redraw</a>();
<a name="l04618"></a>04618 
<a name="l04619"></a>04619     <span class="keywordflow">return</span> redraw;
<a name="l04620"></a>04620 }
<a name="l04621"></a>04621 
<a name="l04622"></a>04622 <span class="comment">/************************ image paint poll ************************/</span>
<a name="l04623"></a>04623 
<a name="l04624"></a><a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">04624</a> <span class="keyword">static</span> <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04625"></a>04625 {
<a name="l04626"></a>04626     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04627"></a>04627     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04628"></a>04628 
<a name="l04629"></a>04629     <span class="keywordflow">return</span> <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>);
<a name="l04630"></a>04630 }
<a name="l04631"></a>04631 
<a name="l04632"></a><a class="code" href="../../df/d60/paint__image_8c.html#a53608893228dbedcc9aaea9b4bf942f3">04632</a> <span class="keyword">static</span> <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *<a class="code" href="../../df/d60/paint__image_8c.html#a53608893228dbedcc9aaea9b4bf942f3">uv_sculpt_brush</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04633"></a>04633 {
<a name="l04634"></a>04634     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04635"></a>04635     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04636"></a>04636 
<a name="l04637"></a>04637     <span class="keywordflow">if</span> (!settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>)
<a name="l04638"></a>04638         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04639"></a>04639     <span class="keywordflow">return</span> <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>-&gt;<a class="code" href="../../d6/dcf/structUvSculpt.html#acc76f2f5b6ea63dc6951b306d23e7426">paint</a>);
<a name="l04640"></a>04640 }
<a name="l04641"></a>04641 
<a name="l04642"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">04642</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04643"></a>04643 {
<a name="l04644"></a>04644     <a class="code" href="../../de/de7/structObject.html">Object</a> *obact = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l04645"></a>04645 
<a name="l04646"></a>04646     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C))
<a name="l04647"></a>04647         <span class="keywordflow">return</span> 0;
<a name="l04648"></a>04648 
<a name="l04649"></a>04649     <span class="keywordflow">if</span> ((obact &amp;&amp; obact-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>) &amp;&amp; <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C)) {
<a name="l04650"></a>04650         <span class="keywordflow">return</span> 1;
<a name="l04651"></a>04651     }
<a name="l04652"></a>04652     <span class="keywordflow">else</span> {
<a name="l04653"></a>04653         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l04654"></a>04654 
<a name="l04655"></a>04655         <span class="keywordflow">if</span> (sima) {
<a name="l04656"></a>04656             <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l04657"></a>04657 
<a name="l04658"></a>04658             <span class="keywordflow">if</span> ((sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a5aa3ece1e2d42bb0018dea9decabf8fe">flag</a> &amp; <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a63dc730381371d70e0ae6ce7db62ad98">SI_DRAWTOOL</a>) &amp;&amp; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> == <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>)
<a name="l04659"></a>04659                 <span class="keywordflow">return</span> 1;
<a name="l04660"></a>04660         }
<a name="l04661"></a>04661     }
<a name="l04662"></a>04662 
<a name="l04663"></a>04663     <span class="keywordflow">return</span> 0;
<a name="l04664"></a>04664 }
<a name="l04665"></a>04665 
<a name="l04666"></a><a class="code" href="../../df/d60/paint__image_8c.html#ac04444b53627bd2baaa8030d7a721066">04666</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ac04444b53627bd2baaa8030d7a721066">uv_sculpt_brush_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04667"></a>04667 {
<a name="l04668"></a>04668     <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em;
<a name="l04669"></a>04669     <span class="keywordtype">int</span> ret;
<a name="l04670"></a>04670     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l04671"></a>04671     <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l04672"></a>04672     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04673"></a>04673     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *toolsettings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04674"></a>04674 
<a name="l04675"></a>04675     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a53608893228dbedcc9aaea9b4bf942f3">uv_sculpt_brush</a>(C) || !obedit || obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>)
<a name="l04676"></a>04676         <span class="keywordflow">return</span> 0;
<a name="l04677"></a>04677 
<a name="l04678"></a>04678     em = <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(obedit);
<a name="l04679"></a>04679     ret = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aee1eae81bbb9df65368016a3c309f21d">EDBM_mtexpoly_check</a>(em);
<a name="l04680"></a>04680 
<a name="l04681"></a>04681     <span class="keywordflow">if</span> (ret &amp;&amp; sima) {
<a name="l04682"></a>04682         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l04683"></a>04683         <span class="keywordflow">if</span> ((toolsettings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af7ce42dd5fcc7c52535ecc61842a7009">use_uv_sculpt</a>) &amp;&amp; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> == <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>)
<a name="l04684"></a>04684             <span class="keywordflow">return</span> 1;
<a name="l04685"></a>04685     }
<a name="l04686"></a>04686 
<a name="l04687"></a>04687     <span class="keywordflow">return</span> 0;
<a name="l04688"></a>04688 }
<a name="l04689"></a>04689 
<a name="l04690"></a><a class="code" href="../../df/d60/paint__image_8c.html#a064f9146cbe84b8b389694ac45d5042a">04690</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a064f9146cbe84b8b389694ac45d5042a">image_paint_3d_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04691"></a>04691 {
<a name="l04692"></a>04692     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C))
<a name="l04693"></a>04693         <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>(C);
<a name="l04694"></a>04694     
<a name="l04695"></a>04695     <span class="keywordflow">return</span> 0;
<a name="l04696"></a>04696 }
<a name="l04697"></a>04697 
<a name="l04698"></a><a class="code" href="../../df/d60/paint__image_8c.html#add83b42539531a89e99aa833dfe4cbb4">04698</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#add83b42539531a89e99aa833dfe4cbb4">image_paint_2d_clone_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l04699"></a>04699 {
<a name="l04700"></a>04700     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C);
<a name="l04701"></a>04701 
<a name="l04702"></a>04702     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C) &amp;&amp; <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>(C))
<a name="l04703"></a>04703         <span class="keywordflow">if</span> (brush &amp;&amp; (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a8ac01891f6e377fbb833d3fa9086a1a4">imagepaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>))
<a name="l04704"></a>04704             <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>)
<a name="l04705"></a>04705                 <span class="keywordflow">return</span> 1;
<a name="l04706"></a>04706     
<a name="l04707"></a>04707     <span class="keywordflow">return</span> 0;
<a name="l04708"></a>04708 }
<a name="l04709"></a>04709 
<a name="l04710"></a>04710 <span class="comment">/************************ paint operator ************************/</span>
<a name="l04711"></a>04711 
<a name="l04712"></a><a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282b">04712</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282b">PaintMode</a> {
<a name="l04713"></a><a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba63b04c8a019581fdaee957634828b871">04713</a>     <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba63b04c8a019581fdaee957634828b871">PAINT_MODE_2D</a>,
<a name="l04714"></a><a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">04714</a>     <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>,
<a name="l04715"></a><a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">04715</a>     <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">PAINT_MODE_3D_PROJECT</a>
<a name="l04716"></a>04716 } <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282b">PaintMode</a>;
<a name="l04717"></a>04717 
<a name="l04718"></a><a class="code" href="../../d9/da8/structPaintOperation.html">04718</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> {
<a name="l04719"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">04719</a>     <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282b">PaintMode</a> <a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a>;
<a name="l04720"></a>04720 
<a name="l04721"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">04721</a>     <a class="code" href="../../d4/dc9/structBrushPainter.html">BrushPainter</a> *<a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">painter</a>;
<a name="l04722"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">04722</a>     <a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> <a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>;
<a name="l04723"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">04723</a>     <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> <a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>;
<a name="l04724"></a>04724 
<a name="l04725"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">04725</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">first</a>;
<a name="l04726"></a><a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">04726</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[2];
<a name="l04727"></a><a class="code" href="../../d9/da8/structPaintOperation.html#ad5c2ecc5f7bf9c4d154ae97374e0076c">04727</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/da8/structPaintOperation.html#ad5c2ecc5f7bf9c4d154ae97374e0076c">prev_pressure</a>; <span class="comment">/* need this since we don&#39;t get tablet events for pressure change */</span>
<a name="l04728"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a581ca8b9bbace21449d8d563860ccb3f">04728</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/da8/structPaintOperation.html#a581ca8b9bbace21449d8d563860ccb3f">orig_brush_size</a>;
<a name="l04729"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a3b754ed6d6507b7435e119b061a10ec8">04729</a>     <span class="keywordtype">double</span> <a class="code" href="../../d9/da8/structPaintOperation.html#a3b754ed6d6507b7435e119b061a10ec8">starttime</a>;
<a name="l04730"></a>04730 
<a name="l04731"></a><a class="code" href="../../d9/da8/structPaintOperation.html#aa68e93aa21b7daa1141a814dbce3719e">04731</a>     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> <a class="code" href="../../d9/da8/structPaintOperation.html#aa68e93aa21b7daa1141a814dbce3719e">vc</a>;
<a name="l04732"></a><a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">04732</a>     <a class="code" href="../../d9/d33/structwmTimer.html">wmTimer</a> *<a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">timer</a>;
<a name="l04733"></a>04733 
<a name="l04734"></a><a class="code" href="../../d9/da8/structPaintOperation.html#a345d18904b898912511010427b8aa717">04734</a>     <span class="keywordtype">short</span> <a class="code" href="../../d9/da8/structPaintOperation.html#a345d18904b898912511010427b8aa717">restore_projection</a>;
<a name="l04735"></a>04735 } <a class="code" href="../../df/d60/paint__image_8c.html#a555c6fbc9dda72d4fdea71766605b4e3">PaintOperation</a>;
<a name="l04736"></a>04736 
<a name="l04737"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6f90849fb8e3238075c758f3b00339f5">04737</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6f90849fb8e3238075c758f3b00339f5">paint_redraw</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../db/d04/structImagePaintState.html">ImagePaintState</a> *s, <span class="keywordtype">int</span> texpaint, <span class="keywordtype">int</span> <span class="keyword">final</span>)
<a name="l04738"></a>04738 {
<a name="l04739"></a>04739     <span class="keywordflow">if</span> (<span class="keyword">final</span>) {
<a name="l04740"></a>04740         <span class="keywordflow">if</span> (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a> &amp;&amp; !(texpaint || (s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> &amp;&amp; s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a0893ac8e618be47c31334a0804c5b598">lock</a>)))
<a name="l04741"></a>04741             <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>);
<a name="l04742"></a>04742 
<a name="l04743"></a>04743         <span class="comment">/* compositor listener deals with updating */</span>
<a name="l04744"></a>04744         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>);
<a name="l04745"></a>04745     }
<a name="l04746"></a>04746     <span class="keywordflow">else</span> {
<a name="l04747"></a>04747         <span class="keywordflow">if</span> (!s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> || !s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#a0893ac8e618be47c31334a0804c5b598">lock</a>)
<a name="l04748"></a>04748             <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l04749"></a>04749         <span class="keywordflow">else</span>
<a name="l04750"></a>04750             <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, s-&gt;<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>);
<a name="l04751"></a>04751     }
<a name="l04752"></a>04752 }
<a name="l04753"></a>04753 
<a name="l04754"></a>04754 <span class="comment">/* initialize project paint settings from context */</span>
<a name="l04755"></a><a class="code" href="../../df/d60/paint__image_8c.html#acd740144727b703dd7fb65c822d50365">04755</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#acd740144727b703dd7fb65c822d50365">project_state_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> *ps)
<a name="l04756"></a>04756 {
<a name="l04757"></a>04757     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04758"></a>04758     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04759"></a>04759     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>);
<a name="l04760"></a>04760 
<a name="l04761"></a>04761     <span class="comment">/* brush */</span>
<a name="l04762"></a>04762     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a> = brush;
<a name="l04763"></a>04763     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a8ac01891f6e377fbb833d3fa9086a1a4">imagepaint_tool</a>;
<a name="l04764"></a>04764     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a015f4d43dc762bd867a8629734374f5f">blend</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a99c5887452ddfa34dc629fc3ba4a7c54">blend</a>;
<a name="l04765"></a>04765 
<a name="l04766"></a>04766     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> = (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf33942d16772316fcb0e94d4a77eaba2">BRUSH_AIRBRUSH</a>) ? 1 : 0;
<a name="l04767"></a>04767     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a> = (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) ? 1 : 0;
<a name="l04768"></a>04768 
<a name="l04769"></a>04769 
<a name="l04770"></a>04770     <span class="comment">/* these can be NULL */</span>
<a name="l04771"></a>04771     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">v3d</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l04772"></a>04772     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a88a6f31c2969bea08d004f6215b8edbd">rv3d</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l04773"></a>04773     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a64c03981e25b7657c2fc6878f52e8b08">ar</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l04774"></a>04774 
<a name="l04775"></a>04775     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a28b16945bda2c5354625ea41a0c61a43">scene</a> = scene;
<a name="l04776"></a>04776     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a> = ob; <span class="comment">/* allow override of active object */</span>
<a name="l04777"></a>04777 
<a name="l04778"></a>04778     <span class="comment">/* setup projection painting data */</span>
<a name="l04779"></a>04779     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a401cf720e5e52a969ee5c758145c0fa9">do_backfacecull</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aac7073248a1afb1a8e46fe328ddf2752">IMAGEPAINT_PROJECT_BACKFACE</a>) ? 0 : 1;
<a name="l04780"></a>04780     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a04cc2cedebda1163ba6bcce7f02a183a">do_occlude</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a48b5246d0872f5b5a24e87e368a33bc7">IMAGEPAINT_PROJECT_XRAY</a>) ? 0 : 1;
<a name="l04781"></a>04781     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1cea92a38b982eb822895706fdc89bec">IMAGEPAINT_PROJECT_FLAT</a>) ? 0 : 1;
<a name="l04782"></a>04782     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#adc1ef909275c342888d42712ae9e7685">do_new_shading_nodes</a> = <a class="code" href="../../d8/d53/BKE__scene_8h.html#a041ff0e68dd0152e85ceddddc9b53cdc">scene_use_new_shading_nodes</a>(scene); <span class="comment">/* only cache the value */</span>
<a name="l04783"></a>04783 
<a name="l04784"></a>04784     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>)
<a name="l04785"></a>04785         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a3d27fb6e59636e9ec4305ab594028bb2">do_layer_clone</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a491aa40e901c3502c4fefe3c73d49d6e">IMAGEPAINT_PROJECT_LAYER_CLONE</a>);
<a name="l04786"></a>04786 
<a name="l04787"></a>04787     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a4101b87ada1c5eec29bc301aec6e5b91">do_layer_stencil</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1e22f698b912b5c69930abed253fb6c7">IMAGEPAINT_PROJECT_LAYER_STENCIL</a>) ? 1 : 0;
<a name="l04788"></a>04788     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa9c804d1f7bf7c7c1c9cf86d3167035">do_layer_stencil_inv</a> = (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a76085a49902bbceb5112d0aeb69b7e26">IMAGEPAINT_PROJECT_LAYER_STENCIL_INV</a>) ? 1 : 0;
<a name="l04789"></a>04789 
<a name="l04790"></a>04790 
<a name="l04791"></a>04791 <span class="preprocessor">#ifndef PROJ_DEBUG_NOSEAMBLEED</span>
<a name="l04792"></a>04792 <span class="preprocessor"></span>    ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6ecf5c83b8cb79d7a276fe3eaeb9f7fd">seam_bleed_px</a> = settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#ae5925dc4ec1c892dbdad54d31840fac0">seam_bleed</a>; <span class="comment">/* pixel num to bleed */</span>
<a name="l04793"></a>04793 <span class="preprocessor">#endif</span>
<a name="l04794"></a>04794 <span class="preprocessor"></span>
<a name="l04795"></a>04795     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a>) {
<a name="l04796"></a>04796         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a> = settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#ad31c396b208e9e258d1d29f2728dd23f">normal_angle</a>;
<a name="l04797"></a>04797         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a> = (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a> + 90.0f) * 0.5f;
<a name="l04798"></a>04798     }
<a name="l04799"></a>04799     <span class="keywordflow">else</span> {
<a name="l04800"></a>04800         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a> = settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#ad31c396b208e9e258d1d29f2728dd23f">normal_angle</a>;
<a name="l04801"></a>04801     }
<a name="l04802"></a>04802 
<a name="l04803"></a>04803     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a> *=   (float)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a> / 90);
<a name="l04804"></a>04804     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a> *=         (float)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a> / 90);
<a name="l04805"></a>04805     ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d2c975c51ef4c7c41cbe8f20f4ca172">normal_angle_range</a> = ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a36bc5526a10d86fc736f083153787941">normal_angle</a> - ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a751675a1729ad2a18f6237114d02683a">normal_angle_inner</a>;
<a name="l04806"></a>04806 
<a name="l04807"></a>04807     <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#a6d2c975c51ef4c7c41cbe8f20f4ca172">normal_angle_range</a> &lt;= 0.0f)
<a name="l04808"></a>04808         ps-&gt;<a class="code" href="../../d0/d4c/structProjPaintState.html#afa49e5ccd490a12ec12e48f3dcda5fa5">do_mask_normal</a> = 0;  <span class="comment">/* no need to do blending */</span>
<a name="l04809"></a>04809 }
<a name="l04810"></a>04810 
<a name="l04811"></a><a class="code" href="../../df/d60/paint__image_8c.html#a8ef9f5b3cf489d151d6d7164c45c6dba">04811</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a8ef9f5b3cf489d151d6d7164c45c6dba">paint_brush_init_tex</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l04812"></a>04812 {
<a name="l04813"></a>04813     <span class="comment">/* init mtex nodes */</span> 
<a name="l04814"></a>04814     <span class="keywordflow">if</span> (brush) {
<a name="l04815"></a>04815         <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex = &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>;
<a name="l04816"></a>04816         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a> &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>)
<a name="l04817"></a>04817             <a class="code" href="../../d4/d91/BKE__node_8h.html#a9e14a324036d8f90c3f9f09cf35c56f0">ntreeTexBeginExecTree</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>, 1);  <span class="comment">/* has internal flag to detect it only does it once */</span>
<a name="l04818"></a>04818     }
<a name="l04819"></a>04819     
<a name="l04820"></a>04820 }
<a name="l04821"></a>04821 
<a name="l04822"></a><a class="code" href="../../df/d60/paint__image_8c.html#a8630e7495d839fca3cfad67693597798">04822</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a8630e7495d839fca3cfad67693597798">texture_paint_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l04823"></a>04823 {
<a name="l04824"></a>04824     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04825"></a>04825     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04826"></a>04826     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>);
<a name="l04827"></a>04827     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a>), <span class="stringliteral">&quot;PaintOperation&quot;</span>); <span class="comment">/* caller frees */</span>
<a name="l04828"></a>04828 
<a name="l04829"></a>04829     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">first</a> = 1;
<a name="l04830"></a>04830     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = pop;
<a name="l04831"></a>04831     
<a name="l04832"></a>04832     <span class="comment">/* XXX: Soften tool does not support projection painting atm, so just disable</span>
<a name="l04833"></a>04833 <span class="comment">     *      projection for this brush */</span>
<a name="l04834"></a>04834     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a8ac01891f6e377fbb833d3fa9086a1a4">imagepaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a19deab8694f5fc2c8ad4bd3340d89266">PAINT_TOOL_SOFTEN</a>) {
<a name="l04835"></a>04835         settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5b182dab648e4616a42d075acfbcaf0c">IMAGEPAINT_PROJECT_DISABLE</a>;
<a name="l04836"></a>04836         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a345d18904b898912511010427b8aa717">restore_projection</a> = 1;
<a name="l04837"></a>04837     }
<a name="l04838"></a>04838 
<a name="l04839"></a>04839     <span class="comment">/* initialize from context */</span>
<a name="l04840"></a>04840     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C)) {
<a name="l04841"></a>04841         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> = <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>;
<a name="l04842"></a>04842 
<a name="l04843"></a>04843         <span class="keywordflow">if</span> (!(settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5b182dab648e4616a42d075acfbcaf0c">IMAGEPAINT_PROJECT_DISABLE</a>))
<a name="l04844"></a>04844             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> = <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">PAINT_MODE_3D_PROJECT</a>;
<a name="l04845"></a>04845         <span class="keywordflow">else</span>
<a name="l04846"></a>04846             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#aa68e93aa21b7daa1141a814dbce3719e">vc</a>);
<a name="l04847"></a>04847     }
<a name="l04848"></a>04848     <span class="keywordflow">else</span> {
<a name="l04849"></a>04849         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l04850"></a>04850         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a82f2ec8b14d1535ec6ef400a98f02694">v2d</a> = &amp;<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C)-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>;
<a name="l04851"></a>04851     }
<a name="l04852"></a>04852 
<a name="l04853"></a>04853     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a> = scene;
<a name="l04854"></a>04854     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a288e4e3b56c3aa8b372010ea9b596a">screen</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C);
<a name="l04855"></a>04855 
<a name="l04856"></a>04856     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a> = brush;
<a name="l04857"></a>04857     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a8ac01891f6e377fbb833d3fa9086a1a4">imagepaint_tool</a>;
<a name="l04858"></a>04858     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a> &amp;&amp; (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a56de62c9e2c552b1987c0865a88b4148">PAINT_TOOL_CLONE</a>))
<a name="l04859"></a>04859         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a889dc4447f337d4a1cc47a018b5d88ba">tool</a> = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a41bd38861e66f9dd43c7dcab9e7bb485">PAINT_TOOL_DRAW</a>;
<a name="l04860"></a>04860     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d48f247e4e2fe00576f2cae6d39b1b7">blend</a> = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a99c5887452ddfa34dc629fc3ba4a7c54">blend</a>;
<a name="l04861"></a>04861     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a581ca8b9bbace21449d8d563860ccb3f">orig_brush_size</a> = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l04862"></a>04862 
<a name="l04863"></a>04863     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> != <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba63b04c8a019581fdaee957634828b871">PAINT_MODE_2D</a>) {
<a name="l04864"></a>04864         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>;
<a name="l04865"></a>04865         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l04866"></a>04866 
<a name="l04867"></a>04867         <span class="keywordflow">if</span> (!me) {
<a name="l04868"></a>04868             <span class="keywordflow">return</span> 0;
<a name="l04869"></a>04869         }
<a name="l04870"></a>04870 
<a name="l04871"></a>04871         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a67ed4272aa2385316d30bb35d432340e">ob</a> = ob;
<a name="l04872"></a>04872         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a99d45f9f371cade14cca7b42de33bb0e">do_facesel</a> = (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) != 0;
<a name="l04873"></a>04873 
<a name="l04874"></a>04874         <span class="comment">/* for non prohect paint we need */</span>
<a name="l04875"></a>04875         <span class="comment">/* fill in derived mesh */</span>
<a name="l04876"></a>04876         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a> &amp;&amp; <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>)) {
<a name="l04877"></a>04877             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a> = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l04878"></a>04878             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">dm_release</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04879"></a>04879         }
<a name="l04880"></a>04880         <span class="keywordflow">else</span> {
<a name="l04881"></a>04881             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>, ob, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a97870e8885214c6dddcacdb7c52eabf0">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a3a4f81e0f2023f6834ccb638ed26cd0c">customdata_mask</a> | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>);
<a name="l04882"></a>04882             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">dm_release</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04883"></a>04883         }
<a name="l04884"></a>04884 
<a name="l04885"></a>04885         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>)) {
<a name="l04886"></a>04886 
<a name="l04887"></a>04887             <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">dm_release</a>)
<a name="l04888"></a>04888                 pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>);
<a name="l04889"></a>04889 
<a name="l04890"></a>04890             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04891"></a>04891             <span class="keywordflow">return</span> 0;
<a name="l04892"></a>04892         }
<a name="l04893"></a>04893 
<a name="l04894"></a>04894         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a101251ead8a3f30ec777ac67f9a38bec">dm_mface</a> = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>);
<a name="l04895"></a>04895         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a372ae501bbd0c968d25100f9652e7888">dm_mtface</a> = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l04896"></a>04896         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a6c7ef713ea4db97f8f1c309a1242f9a3">dm_totface</a> = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>);
<a name="l04897"></a>04897     }
<a name="l04898"></a>04898     <span class="keywordflow">else</span> {
<a name="l04899"></a>04899         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a> = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ac299099fb37e8e46063e5ff3f5f08880">sima</a>-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>;
<a name="l04900"></a>04900 
<a name="l04901"></a>04901         <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a150deb75d1694c883fb3b52118454591">imapaint_canvas_set</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a6ece55d9f4147459dd58a9600c028da2">image</a>)) {
<a name="l04902"></a>04902             <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">warnmultifile</a>)
<a name="l04903"></a>04903                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Image requires 4 color channels to paint&quot;</span>);
<a name="l04904"></a>04904             <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">warnpackedfile</a>)
<a name="l04905"></a>04905                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Packed MultiLayer files cannot be painted&quot;</span>);
<a name="l04906"></a>04906 
<a name="l04907"></a>04907             <span class="keywordflow">return</span> 0;
<a name="l04908"></a>04908         }
<a name="l04909"></a>04909     }
<a name="l04910"></a>04910     
<a name="l04911"></a>04911     <a class="code" href="../../df/d60/paint__image_8c.html#a8ef9f5b3cf489d151d6d7164c45c6dba">paint_brush_init_tex</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>);
<a name="l04912"></a>04912     
<a name="l04913"></a>04913     <span class="comment">/* note, if we have no UVs on the derived mesh, then we must return here */</span>
<a name="l04914"></a>04914     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">PAINT_MODE_3D_PROJECT</a>) {
<a name="l04915"></a>04915 
<a name="l04916"></a>04916         <span class="comment">/* initialize all data from the context */</span>
<a name="l04917"></a>04917         <a class="code" href="../../df/d60/paint__image_8c.html#acd740144727b703dd7fb65c822d50365">project_state_init</a>(C, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>, &amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>);
<a name="l04918"></a>04918         
<a name="l04919"></a>04919         <a class="code" href="../../df/d60/paint__image_8c.html#a8ef9f5b3cf489d151d6d7164c45c6dba">paint_brush_init_tex</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l04920"></a>04920 
<a name="l04921"></a>04921         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> = <a class="code" href="../../df/d60/paint__image_8c.html#ae379c84f61115c748cb0ebcd5c4b1b05">PROJ_SRC_VIEW</a>;
<a name="l04922"></a>04922 
<a name="l04923"></a>04923         <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || !(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> &amp; pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#a9c227ecf99a710c5101951c5f14b021d">v3d</a>-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a>))
<a name="l04924"></a>04924             <span class="keywordflow">return</span> 0;
<a name="l04925"></a>04925 
<a name="l04926"></a>04926         <span class="comment">/* Don&#39;t allow brush size below 2 */</span>
<a name="l04927"></a>04927         <span class="keywordflow">if</span> (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush) &lt; 2)
<a name="l04928"></a>04928             <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, brush, 2);
<a name="l04929"></a>04929 
<a name="l04930"></a>04930         <span class="comment">/* allocate and initialize spacial data structures */</span>
<a name="l04931"></a>04931         <a class="code" href="../../df/d60/paint__image_8c.html#a34cdbe9457ea478ebb874465579b95ac">project_paint_begin</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>);
<a name="l04932"></a>04932         
<a name="l04933"></a>04933         <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04934"></a>04934             <span class="keywordflow">return</span> 0;
<a name="l04935"></a>04935     }
<a name="l04936"></a>04936     
<a name="l04937"></a>04937     settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9f3bb05546eeb62c063e6731ddb02ef4">IMAGEPAINT_DRAWING</a>;
<a name="l04938"></a>04938     <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab8bed50dd373fb5e5192dfb78c561cda">undo_paint_push_begin</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#ae72eba1367367168e15c361226b6f8b5">UNDO_PAINT_IMAGE</a>, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a>,
<a name="l04939"></a>04939                           <a class="code" href="../../df/d60/paint__image_8c.html#a25817c3cd4284aa49818857455c8b5f7">image_undo_restore</a>, <a class="code" href="../../df/d60/paint__image_8c.html#ab48408e0b88f6dd23f5690a5a2823354">image_undo_free</a>);
<a name="l04940"></a>04940 
<a name="l04941"></a>04941     <span class="comment">/* create painter */</span>
<a name="l04942"></a>04942     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">painter</a> = <a class="code" href="../../da/dc9/BKE__brush_8h.html#ab89d23567cf26e1640346524daf7fdc5">brush_painter_new</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>);
<a name="l04943"></a>04943 
<a name="l04944"></a>04944     <span class="keywordflow">return</span> 1;
<a name="l04945"></a>04945 }
<a name="l04946"></a>04946 
<a name="l04947"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab3cab5c0747515a47b893e34746b9273">04947</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab3cab5c0747515a47b893e34746b9273">paint_apply</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *itemptr)
<a name="l04948"></a>04948 {
<a name="l04949"></a>04949     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l04950"></a>04950     <span class="keywordtype">float</span> time, mousef[2];
<a name="l04951"></a>04951     <span class="keywordtype">float</span> pressure;
<a name="l04952"></a>04952     <span class="keywordtype">int</span> mouse[2], redraw;
<a name="l04953"></a>04953 
<a name="l04954"></a>04954     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mousef);
<a name="l04955"></a>04955     mouse[0] = (int)(mousef[0]);
<a name="l04956"></a>04956     mouse[1] = (int)(mousef[1]);
<a name="l04957"></a>04957     time = <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(itemptr, <span class="stringliteral">&quot;time&quot;</span>);
<a name="l04958"></a>04958     pressure = <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(itemptr, <span class="stringliteral">&quot;pressure&quot;</span>);
<a name="l04959"></a>04959 
<a name="l04960"></a>04960     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">first</a>)
<a name="l04961"></a>04961         <a class="code" href="../../df/d60/paint__image_8c.html#a26576d9e38551ade624a6369ca679170">project_paint_begin_clone</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>, mouse);
<a name="l04962"></a>04962 
<a name="l04963"></a>04963     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>)
<a name="l04964"></a>04964         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l04965"></a>04965 
<a name="l04966"></a>04966     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">PAINT_MODE_3D_PROJECT</a>) {
<a name="l04967"></a>04967         redraw = <a class="code" href="../../df/d60/paint__image_8c.html#aab68b8225c6afb02dfcdc4da2e8f7a10">project_paint_stroke</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">painter</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>, mouse, time, pressure);
<a name="l04968"></a>04968         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[0] = mouse[0];
<a name="l04969"></a>04969         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[1] = mouse[1];
<a name="l04970"></a>04970 
<a name="l04971"></a>04971     }
<a name="l04972"></a>04972     <span class="keywordflow">else</span> { 
<a name="l04973"></a>04973         redraw = <a class="code" href="../../df/d60/paint__image_8c.html#a651206999c256eee9726e0ad3485dcae">imapaint_paint_stroke</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#aa68e93aa21b7daa1141a814dbce3719e">vc</a>, &amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">painter</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>, mouse, time, pressure);
<a name="l04974"></a>04974         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[0] = mouse[0];
<a name="l04975"></a>04975         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[1] = mouse[1];
<a name="l04976"></a>04976     }
<a name="l04977"></a>04977 
<a name="l04978"></a>04978     <span class="keywordflow">if</span> (redraw)
<a name="l04979"></a>04979         <a class="code" href="../../df/d60/paint__image_8c.html#a6f90849fb8e3238075c758f3b00339f5">paint_redraw</a>(C, &amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>, 0);
<a name="l04980"></a>04980 
<a name="l04981"></a>04981     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">first</a> = 0;
<a name="l04982"></a>04982 }
<a name="l04983"></a>04983 
<a name="l04984"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6ed159ac719b80e0879b7a0fb22cb43f">04984</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6ed159ac719b80e0879b7a0fb22cb43f">paint_brush_exit_tex</a>(<a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush)
<a name="l04985"></a>04985 {
<a name="l04986"></a>04986     <span class="keywordflow">if</span> (brush) {
<a name="l04987"></a>04987         <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex = &amp;brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a32f9a049d7bb4ec8093ef569975f2919">mtex</a>;
<a name="l04988"></a>04988         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a> &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>)
<a name="l04989"></a>04989             <a class="code" href="../../d4/d91/BKE__node_8h.html#a724a94a118bf6c8c74e2e06464652211">ntreeTexEndExecTree</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>-&gt;<a class="code" href="../../d9/da9/structbNodeTree.html#ae9db87987b712dfeae144221d0e225d4">execdata</a>, 1);
<a name="l04990"></a>04990     }   
<a name="l04991"></a>04991 }
<a name="l04992"></a>04992 
<a name="l04993"></a><a class="code" href="../../df/d60/paint__image_8c.html#ad4aab32155a8bc7335d225d146cf2b26">04993</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ad4aab32155a8bc7335d225d146cf2b26">paint_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l04994"></a>04994 {
<a name="l04995"></a>04995     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l04996"></a>04996     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l04997"></a>04997     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l04998"></a>04998 
<a name="l04999"></a>04999     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">timer</a>)
<a name="l05000"></a>05000         <a class="code" href="../../d7/d6e/wm__window_8c.html#a1a9f31ba88dd1dd3982b3d8f02de2e75">WM_event_remove_timer</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">timer</a>);
<a name="l05001"></a>05001 
<a name="l05002"></a>05002     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a345d18904b898912511010427b8aa717">restore_projection</a>)
<a name="l05003"></a>05003         settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5b182dab648e4616a42d075acfbcaf0c">IMAGEPAINT_PROJECT_DISABLE</a>;
<a name="l05004"></a>05004 
<a name="l05005"></a>05005     <a class="code" href="../../df/d60/paint__image_8c.html#a6ed159ac719b80e0879b7a0fb22cb43f">paint_brush_exit_tex</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>);
<a name="l05006"></a>05006     
<a name="l05007"></a>05007     settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9f3bb05546eeb62c063e6731ddb02ef4">IMAGEPAINT_DRAWING</a>;
<a name="l05008"></a>05008     <a class="code" href="../../df/d60/paint__image_8c.html#aa653e3e3854e25ee09ea0b6fa8baa2c1">imapaint_canvas_free</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>);
<a name="l05009"></a>05009     <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9b08758992635893d820454d81e22494">brush_painter_free</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3e4fca03d2dec1d09f5245dc28a34b1c">painter</a>);
<a name="l05010"></a>05010 
<a name="l05011"></a>05011     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba94f56b264d866a3953acabe8d0aaf7ce">PAINT_MODE_3D_PROJECT</a>) {
<a name="l05012"></a>05012         <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a581ca8b9bbace21449d8d563860ccb3f">orig_brush_size</a>);
<a name="l05013"></a>05013         <a class="code" href="../../df/d60/paint__image_8c.html#a6ed159ac719b80e0879b7a0fb22cb43f">paint_brush_exit_tex</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l05014"></a>05014         
<a name="l05015"></a>05015         <a class="code" href="../../df/d60/paint__image_8c.html#a87190dde8aa253de62b5b4032be51722">project_paint_end</a>(&amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2f5ffa01a51ce595105517dd030308ef">ps</a>);
<a name="l05016"></a>05016     }
<a name="l05017"></a>05017     <span class="keywordflow">else</span> {
<a name="l05018"></a>05018         <span class="comment">/* non projection 3d paint, could move into own function of more needs adding */</span>
<a name="l05019"></a>05019         <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#aa7679decbfa69efc25d0231f5b26a0b9">dm_release</a>)
<a name="l05020"></a>05020             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a7a02ab97a890ef763c4871fdab83afcd">dm</a>);
<a name="l05021"></a>05021     }
<a name="l05022"></a>05022     
<a name="l05023"></a>05023     <a class="code" href="../../df/d60/paint__image_8c.html#a6f90849fb8e3238075c758f3b00339f5">paint_redraw</a>(C, &amp;pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a5a4cf4206cc87558d534539c8598742e">mode</a> == <a class="code" href="../../df/d60/paint__image_8c.html#afe2c062c943c4d8c17774c5132d5282ba2b7d0df59d0fe470509c7acb1bf5df18">PAINT_MODE_3D</a>, 1);
<a name="l05024"></a>05024     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a6e1a555b71a4ce0281af8b3a7648b662">undo_paint_push_end</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#ae72eba1367367168e15c361226b6f8b5">UNDO_PAINT_IMAGE</a>);
<a name="l05025"></a>05025     
<a name="l05026"></a>05026     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">warnmultifile</a>)
<a name="l05027"></a>05027         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Image requires 4 color channels to paint: %s&quot;</span>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d5df1832ff6a875d8dc0e1d174c58d1">warnmultifile</a>);
<a name="l05028"></a>05028     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">warnpackedfile</a>)
<a name="l05029"></a>05029         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Packed MultiLayer files cannot be painted: %s&quot;</span>, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a16c87eae32f033de2e1fefd6d588a01d">warnpackedfile</a>);
<a name="l05030"></a>05030 
<a name="l05031"></a>05031     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pop);
<a name="l05032"></a>05032 }
<a name="l05033"></a>05033 
<a name="l05034"></a><a class="code" href="../../df/d60/paint__image_8c.html#aed58f36fb13dcab673c2bd4b4f537c62">05034</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#aed58f36fb13dcab673c2bd4b4f537c62">paint_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05035"></a>05035 {
<a name="l05036"></a>05036     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a8630e7495d839fca3cfad67693597798">texture_paint_init</a>(C, op)) {
<a name="l05037"></a>05037         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l05038"></a>05038         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05039"></a>05039     }
<a name="l05040"></a>05040 
<a name="l05041"></a>05041     <a class="code" href="../../de/ddf/RNA__access_8h.html#a0310a34930fc9ac8d15a39c38d3dd429">RNA_BEGIN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, itemptr, <span class="stringliteral">&quot;stroke&quot;</span>) {
<a name="l05042"></a>05042         <a class="code" href="../../df/d60/paint__image_8c.html#ab3cab5c0747515a47b893e34746b9273">paint_apply</a>(C, op, &amp;itemptr);
<a name="l05043"></a>05043     }
<a name="l05044"></a>05044     <a class="code" href="../../de/ddf/RNA__access_8h.html#a245d0341a908eab74fc30b93cf24a74d">RNA_END</a>;
<a name="l05045"></a>05045 
<a name="l05046"></a>05046     <a class="code" href="../../df/d60/paint__image_8c.html#ad4aab32155a8bc7335d225d146cf2b26">paint_exit</a>(C, op);
<a name="l05047"></a>05047 
<a name="l05048"></a>05048     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05049"></a>05049 }
<a name="l05050"></a>05050 
<a name="l05051"></a><a class="code" href="../../df/d60/paint__image_8c.html#a97038ef493487ebdbad66acb823bb10c">05051</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a97038ef493487ebdbad66acb823bb10c">paint_apply_event</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05052"></a>05052 {
<a name="l05053"></a>05053     <span class="keyword">const</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05054"></a>05054     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l05055"></a>05055     <a class="code" href="../../d3/d0b/structwmTabletData.html">wmTabletData</a> *wmtab;
<a name="l05056"></a>05056     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> itemptr;
<a name="l05057"></a>05057     <span class="keywordtype">float</span> pressure, mousef[2];
<a name="l05058"></a>05058     <span class="keywordtype">double</span> time;
<a name="l05059"></a>05059     <span class="keywordtype">int</span> tablet;
<a name="l05060"></a>05060 
<a name="l05061"></a>05061     time = <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l05062"></a>05062 
<a name="l05063"></a>05063     tablet = 0;
<a name="l05064"></a>05064     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d48f247e4e2fe00576f2cae6d39b1b7">blend</a> = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a99c5887452ddfa34dc629fc3ba4a7c54">blend</a>;
<a name="l05065"></a>05065 
<a name="l05066"></a>05066     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a276cd44fa9cab09b621a83980b335b47">custom</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a0dbe462839c84a02b2d3698e720ed27d">EVT_DATA_TABLET</a>) {
<a name="l05067"></a>05067         wmtab = <span class="keyword">event</span>-&gt;customdata;
<a name="l05068"></a>05068 
<a name="l05069"></a>05069         tablet = (wmtab-&gt;<a class="code" href="../../d3/d0b/structwmTabletData.html#a25cff19785a3b589057c8d8324420cbd">Active</a> != <a class="code" href="../../d1/d40/wm__event__types_8h.html#a92e0ec16911af8a6cb6ea9214ce89fb7">EVT_TABLET_NONE</a>);
<a name="l05070"></a>05070         pressure = wmtab-&gt;<a class="code" href="../../d3/d0b/structwmTabletData.html#a6456330e282f7e3e622d09741b3ddb60">Pressure</a>;
<a name="l05071"></a>05071         <span class="keywordflow">if</span> (wmtab-&gt;<a class="code" href="../../d3/d0b/structwmTabletData.html#a25cff19785a3b589057c8d8324420cbd">Active</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a5ef56f7080b391d4c33e87559e4445e1">EVT_TABLET_ERASER</a>)
<a name="l05072"></a>05072             pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#a8d48f247e4e2fe00576f2cae6d39b1b7">blend</a> = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a980e316e53add57605546236ec128841a20deb7a35361d787288b0195b81c8655">IMB_BLEND_ERASE_ALPHA</a>;
<a name="l05073"></a>05073     }
<a name="l05074"></a>05074     <span class="keywordflow">else</span> { <span class="comment">/* otherwise airbrush becomes 1.0 pressure instantly */</span>
<a name="l05075"></a>05075         pressure = pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ad5c2ecc5f7bf9c4d154ae97374e0076c">prev_pressure</a> ? pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ad5c2ecc5f7bf9c4d154ae97374e0076c">prev_pressure</a> : 1.0f;
<a name="l05076"></a>05076     }
<a name="l05077"></a>05077 
<a name="l05078"></a>05078     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a2c0a77258d2e3bf615efea8cc107a7f5">first</a>) {
<a name="l05079"></a>05079         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[0] = <span class="keyword">event</span>-&gt;mval[0];
<a name="l05080"></a>05080         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ab777d91852302a0e6007a37e5f1790b1">prevmouse</a>[1] = <span class="keyword">event</span>-&gt;mval[1];
<a name="l05081"></a>05081         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3b754ed6d6507b7435e119b061a10ec8">starttime</a> = time;
<a name="l05082"></a>05082 
<a name="l05083"></a>05083         <span class="comment">/* special exception here for too high pressure values on first touch in</span>
<a name="l05084"></a>05084 <span class="comment">         * windows for some tablets, then we just skip first touch ..  */</span>
<a name="l05085"></a>05085         <span class="keywordflow">if</span> (tablet &amp;&amp; (pressure &gt;= 0.99f) &amp;&amp; ((pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa58e5ffa5a3828b73f28d92bba74d41f4">BRUSH_SPACING_PRESSURE</a>) || <a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>) || <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>)))
<a name="l05086"></a>05086             <span class="keywordflow">return</span>;
<a name="l05087"></a>05087 
<a name="l05088"></a>05088         <span class="comment">/* This can be removed once fixed properly in</span>
<a name="l05089"></a>05089 <span class="comment">         * brush_painter_paint(BrushPainter *painter, BrushFunc func, float *pos, double time, float pressure, void *user) </span>
<a name="l05090"></a>05090 <span class="comment">         * at zero pressure we should do nothing 1/2^12 is .0002 which is the sensitivity of the most sensitive pen tablet available */</span>
<a name="l05091"></a>05091         <span class="keywordflow">if</span> (tablet &amp;&amp; (pressure &lt; .0002f) &amp;&amp; ((pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baa58e5ffa5a3828b73f28d92bba74d41f4">BRUSH_SPACING_PRESSURE</a>) || <a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>) || <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(scene, pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>)))
<a name="l05092"></a>05092             <span class="keywordflow">return</span>;
<a name="l05093"></a>05093     
<a name="l05094"></a>05094     }
<a name="l05095"></a>05095 
<a name="l05096"></a>05096     <span class="comment">/* fill in stroke */</span>
<a name="l05097"></a>05097     <a class="code" href="../../d3/d10/rna__access_8c.html#a79f02ed37d6dff0e7fd3a13eed9c5c4f">RNA_collection_add</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;itemptr);
<a name="l05098"></a>05098 
<a name="l05099"></a>05099     mousef[0] = (float)(event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0]);
<a name="l05100"></a>05100     mousef[1] = (float)(event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l05101"></a>05101     <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(&amp;itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mousef);
<a name="l05102"></a>05102     <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(&amp;itemptr, <span class="stringliteral">&quot;time&quot;</span>, (<span class="keywordtype">float</span>)(time - pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a3b754ed6d6507b7435e119b061a10ec8">starttime</a>));
<a name="l05103"></a>05103     <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(&amp;itemptr, <span class="stringliteral">&quot;pressure&quot;</span>, pressure);
<a name="l05104"></a>05104 
<a name="l05105"></a>05105     <span class="comment">/* apply */</span>
<a name="l05106"></a>05106     <a class="code" href="../../df/d60/paint__image_8c.html#ab3cab5c0747515a47b893e34746b9273">paint_apply</a>(C, op, &amp;itemptr);
<a name="l05107"></a>05107 
<a name="l05108"></a>05108     pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#ad5c2ecc5f7bf9c4d154ae97374e0076c">prev_pressure</a> = pressure;
<a name="l05109"></a>05109 }
<a name="l05110"></a>05110 
<a name="l05111"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae71fb1ae92a5b211ded6e1c5e21b6f95">05111</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae71fb1ae92a5b211ded6e1c5e21b6f95">paint_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05112"></a>05112 {
<a name="l05113"></a>05113     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop;
<a name="l05114"></a>05114 
<a name="l05115"></a>05115     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d60/paint__image_8c.html#a8630e7495d839fca3cfad67693597798">texture_paint_init</a>(C, op)) {
<a name="l05116"></a>05116         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l05117"></a>05117         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05118"></a>05118     }
<a name="l05119"></a>05119     
<a name="l05120"></a>05120     <a class="code" href="../../df/d60/paint__image_8c.html#a97038ef493487ebdbad66acb823bb10c">paint_apply_event</a>(C, op, event);
<a name="l05121"></a>05121 
<a name="l05122"></a>05122     pop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l05123"></a>05123     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l05124"></a>05124 
<a name="l05125"></a>05125     <span class="keywordflow">if</span> (pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#a1dba754b2b49dd42bca2d599552e756a">s</a>.<a class="code" href="../../db/d04/structImagePaintState.html#ae3edcb614c88cd6843cc8f562bcae867">brush</a>-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a45f7d9dd35234376f5d6822ed734f162">flag</a> &amp; <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a54ce80e56a089d8035b76a3071e3b0baaf33942d16772316fcb0e94d4a77eaba2">BRUSH_AIRBRUSH</a>)
<a name="l05126"></a>05126         pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">timer</a> = <a class="code" href="../../d7/d6e/wm__window_8c.html#af5bdd7109c7ea81c77a89d9f41585f3a">WM_event_add_timer</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), <a class="code" href="../../d1/d40/wm__event__types_8h.html#a599217205dc3092c26567a2bd868ef3a">TIMER</a>, 0.01f);
<a name="l05127"></a>05127 
<a name="l05128"></a>05128     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05129"></a>05129 }
<a name="l05130"></a>05130 
<a name="l05131"></a><a class="code" href="../../df/d60/paint__image_8c.html#a683f275d7913271b100f5781577fddc2">05131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a683f275d7913271b100f5781577fddc2">paint_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05132"></a>05132 {
<a name="l05133"></a>05133     <a class="code" href="../../d9/da8/structPaintOperation.html">PaintOperation</a> *pop = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l05134"></a>05134 
<a name="l05135"></a>05135     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l05136"></a>05136         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>:
<a name="l05137"></a>05137         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a64d06d50176bcded7e70cd4ebbce0e12">MIDDLEMOUSE</a>:
<a name="l05138"></a>05138         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>: <span class="comment">// XXX hardcoded</span>
<a name="l05139"></a>05139             <a class="code" href="../../df/d60/paint__image_8c.html#ad4aab32155a8bc7335d225d146cf2b26">paint_exit</a>(C, op);
<a name="l05140"></a>05140             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05141"></a>05141         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l05142"></a>05142         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a99234bdab7c4336e174cd0db37044412">INBETWEEN_MOUSEMOVE</a>:
<a name="l05143"></a>05143             <a class="code" href="../../df/d60/paint__image_8c.html#a97038ef493487ebdbad66acb823bb10c">paint_apply_event</a>(C, op, event);
<a name="l05144"></a>05144             <span class="keywordflow">break</span>;
<a name="l05145"></a>05145         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a599217205dc3092c26567a2bd868ef3a">TIMER</a>:
<a name="l05146"></a>05146             <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#afe8f2bc4e7e67063e0e2a92b08056c17">customdata</a> == pop-&gt;<a class="code" href="../../d9/da8/structPaintOperation.html#abc352366bf9d2dab77e70bc8c5bef4ed">timer</a>)
<a name="l05147"></a>05147                 <a class="code" href="../../df/d60/paint__image_8c.html#a97038ef493487ebdbad66acb823bb10c">paint_apply_event</a>(C, op, event);
<a name="l05148"></a>05148             <span class="keywordflow">break</span>;
<a name="l05149"></a>05149     }
<a name="l05150"></a>05150 
<a name="l05151"></a>05151     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05152"></a>05152 }
<a name="l05153"></a>05153 
<a name="l05154"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3f6ace2d3b47469e99e3665e98ec4af7">05154</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3f6ace2d3b47469e99e3665e98ec4af7">paint_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05155"></a>05155 {
<a name="l05156"></a>05156     <a class="code" href="../../df/d60/paint__image_8c.html#ad4aab32155a8bc7335d225d146cf2b26">paint_exit</a>(C, op);
<a name="l05157"></a>05157 
<a name="l05158"></a>05158     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05159"></a>05159 }
<a name="l05160"></a>05160 
<a name="l05161"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#a580bac398ac256d780a6eeb467aceeee">05161</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ae8c75c95e9f99d7e92d0d0693e207912">PAINT_OT_image_paint</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05162"></a>05162 {
<a name="l05163"></a>05163     <span class="comment">/* identifiers */</span>
<a name="l05164"></a>05164     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Image Paint&quot;</span>;
<a name="l05165"></a>05165     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_image_paint&quot;</span>;
<a name="l05166"></a>05166     
<a name="l05167"></a>05167     <span class="comment">/* api callbacks */</span>
<a name="l05168"></a>05168     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#aed58f36fb13dcab673c2bd4b4f537c62">paint_exec</a>;
<a name="l05169"></a>05169     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../df/d60/paint__image_8c.html#ae71fb1ae92a5b211ded6e1c5e21b6f95">paint_invoke</a>;
<a name="l05170"></a>05170     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a683f275d7913271b100f5781577fddc2">paint_modal</a>;
<a name="l05171"></a>05171     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a3f6ace2d3b47469e99e3665e98ec4af7">paint_cancel</a>;
<a name="l05172"></a>05172     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>;
<a name="l05173"></a>05173 
<a name="l05174"></a>05174     <span class="comment">/* flags */</span>
<a name="l05175"></a>05175     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l05176"></a>05176 
<a name="l05177"></a>05177     <span class="comment">/* properties */</span>
<a name="l05178"></a>05178     <a class="code" href="../../dc/d7e/rna__define_8c.html#a5861cf8175d4ffb61082e2bbeff84fd0">RNA_def_collection_runtime</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a0c09154eb5eafa1601572b2cd89cf35a">RNA_OperatorStrokeElement</a>, <span class="stringliteral">&quot;Stroke&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05179"></a>05179 }
<a name="l05180"></a>05180 
<a name="l05181"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab4191584fda3660e6fd71bfe1590d515">05181</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab4191584fda3660e6fd71bfe1590d515">get_imapaint_zoom</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">float</span> *zoomx, <span class="keywordtype">float</span> *zoomy)
<a name="l05182"></a>05182 {
<a name="l05183"></a>05183     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l05184"></a>05184 
<a name="l05185"></a>05185     <span class="keywordflow">if</span> (!rv3d) {
<a name="l05186"></a>05186         <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima = <a class="code" href="../../df/d01/BKE__context_8h.html#ae04ae450dc98cc5d253c49530f5a2dd6">CTX_wm_space_image</a>(C);
<a name="l05187"></a>05187         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l05188"></a>05188         
<a name="l05189"></a>05189         <a class="code" href="../../de/d53/ED__image_8h.html#a6902c4f28acdbce0b7080dbbfbcbc4aa">ED_space_image_zoom</a>(sima, ar, zoomx, zoomy);
<a name="l05190"></a>05190 
<a name="l05191"></a>05191         <span class="keywordflow">return</span> 1;
<a name="l05192"></a>05192     }
<a name="l05193"></a>05193 
<a name="l05194"></a>05194     *zoomx = *zoomy = 1;
<a name="l05195"></a>05195 
<a name="l05196"></a>05196     <span class="keywordflow">return</span> 0;
<a name="l05197"></a>05197 }
<a name="l05198"></a>05198 
<a name="l05199"></a>05199 <span class="comment">/************************ cursor drawing *******************************/</span>
<a name="l05200"></a>05200 
<a name="l05201"></a><a class="code" href="../../df/d60/paint__image_8c.html#a852699bf81a3a634e5c5823796ede88f">05201</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a852699bf81a3a634e5c5823796ede88f">brush_drawcursor</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(customdata))
<a name="l05202"></a>05202 {
<a name="l05203"></a>05203 <span class="preprocessor">#define PX_SIZE_FADE_MAX 12.0f</span>
<a name="l05204"></a>05204 <span class="preprocessor"></span><span class="preprocessor">#define PX_SIZE_FADE_MIN 4.0f</span>
<a name="l05205"></a>05205 <span class="preprocessor"></span>
<a name="l05206"></a>05206     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05207"></a>05207     <span class="comment">//Brush *brush= image_paint_brush(C);</span>
<a name="l05208"></a>05208     <a class="code" href="../../d0/d6c/structPaint.html">Paint</a> *paint = <a class="code" href="../../d8/d86/BKE__paint_8h.html#a4b3c2e4641d652cc475f36b3de296334">paint_get_active</a>(scene);
<a name="l05209"></a>05209     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(paint);
<a name="l05210"></a>05210 
<a name="l05211"></a>05211     <span class="keywordflow">if</span> (paint &amp;&amp; brush &amp;&amp; paint-&gt;<a class="code" href="../../d0/d6c/structPaint.html#a89f27059527cc9fd7a8dec3e9e124183">flags</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5031a8567a0671de309866bb78b88f87a86fab31513af94207aada5bd51a2c9b6">PAINT_SHOW_BRUSH</a>) {
<a name="l05212"></a>05212         <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts;
<a name="l05213"></a>05213         <span class="keywordtype">float</span> zoomx, zoomy;
<a name="l05214"></a>05214         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = (float)<a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush);
<a name="l05215"></a>05215         <span class="keywordtype">short</span> use_zoom;
<a name="l05216"></a>05216         <span class="keywordtype">float</span> pixel_size;
<a name="l05217"></a>05217         <span class="keywordtype">float</span> alpha = 0.5f;
<a name="l05218"></a>05218 
<a name="l05219"></a>05219         ts = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l05220"></a>05220         use_zoom = <a class="code" href="../../df/d60/paint__image_8c.html#ab4191584fda3660e6fd71bfe1590d515">get_imapaint_zoom</a>(C, &amp;zoomx, &amp;zoomy) &amp;&amp;
<a name="l05221"></a>05221                    !(ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af7ce42dd5fcc7c52535ecc61842a7009">use_uv_sculpt</a> &amp;&amp; (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a5aed90bff10a0fd5ad47c9ee79ae4580">OB_MODE_EDIT</a>));
<a name="l05222"></a>05222 
<a name="l05223"></a>05223         <span class="keywordflow">if</span> (use_zoom) {
<a name="l05224"></a>05224             pixel_size = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(size * zoomx, size * zoomy);
<a name="l05225"></a>05225         }
<a name="l05226"></a>05226         <span class="keywordflow">else</span> {
<a name="l05227"></a>05227             pixel_size = <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l05228"></a>05228         }
<a name="l05229"></a>05229 
<a name="l05230"></a>05230         <span class="comment">/* fade out the brush (cheap trick to work around brush interfearing with sampling [#])*/</span>
<a name="l05231"></a>05231         <span class="keywordflow">if</span> (pixel_size &lt; <a class="code" href="../../df/d60/paint__image_8c.html#a9adc7f93391053f3486b278dda0c59f7">PX_SIZE_FADE_MIN</a>) {
<a name="l05232"></a>05232             <span class="keywordflow">return</span>;
<a name="l05233"></a>05233         }
<a name="l05234"></a>05234         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_size &lt; <a class="code" href="../../df/d60/paint__image_8c.html#affe19c8a1eb61fb3f2dc6147ac631c44">PX_SIZE_FADE_MAX</a>) {
<a name="l05235"></a>05235             alpha *= (pixel_size - <a class="code" href="../../df/d60/paint__image_8c.html#a9adc7f93391053f3486b278dda0c59f7">PX_SIZE_FADE_MIN</a>) / (<a class="code" href="../../df/d60/paint__image_8c.html#affe19c8a1eb61fb3f2dc6147ac631c44">PX_SIZE_FADE_MAX</a> - <a class="code" href="../../df/d60/paint__image_8c.html#a9adc7f93391053f3486b278dda0c59f7">PX_SIZE_FADE_MIN</a>);
<a name="l05236"></a>05236         }
<a name="l05237"></a>05237 
<a name="l05238"></a>05238         glPushMatrix();
<a name="l05239"></a>05239 
<a name="l05240"></a>05240         glTranslatef((<span class="keywordtype">float</span>)x, (<span class="keywordtype">float</span>)y, 0.0f);
<a name="l05241"></a>05241 
<a name="l05242"></a>05242         <span class="comment">/* No need to scale for uv sculpting, on the contrary it might be useful to keep unscaled */</span>
<a name="l05243"></a>05243         <span class="keywordflow">if</span> (use_zoom)
<a name="l05244"></a>05244             glScalef(zoomx, zoomy, 1.0f);
<a name="l05245"></a>05245 
<a name="l05246"></a>05246         glColor4f(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[0], brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[1], brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a3c63c7d97556220c0e4918b6c65fbb2f">add_col</a>[2], alpha);
<a name="l05247"></a>05247         glEnable(GL_LINE_SMOOTH);
<a name="l05248"></a>05248         glEnable(GL_BLEND);
<a name="l05249"></a>05249         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a86d799e333a90e03d5ab783640bde74a">glutil_draw_lined_arc</a>(0, (<span class="keywordtype">float</span>)(<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 2.0), size, 40);
<a name="l05250"></a>05250         glDisable(GL_BLEND);
<a name="l05251"></a>05251         glDisable(GL_LINE_SMOOTH);
<a name="l05252"></a>05252 
<a name="l05253"></a>05253         glPopMatrix();
<a name="l05254"></a>05254     }
<a name="l05255"></a>05255 <span class="preprocessor">#undef PX_SIZE_FADE_MAX</span>
<a name="l05256"></a>05256 <span class="preprocessor"></span><span class="preprocessor">#undef PX_SIZE_FADE_MIN</span>
<a name="l05257"></a>05257 <span class="preprocessor"></span>}
<a name="l05258"></a>05258 
<a name="l05259"></a><a class="code" href="../../df/d60/paint__image_8c.html#ade457760ddba6fff7a4767d8eab5a1da">05259</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ade457760ddba6fff7a4767d8eab5a1da">toggle_paint_cursor</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keywordtype">int</span> enable)
<a name="l05260"></a>05260 {
<a name="l05261"></a>05261     <a class="code" href="../../d4/dc3/structwmWindowManager.html">wmWindowManager</a> *wm = <a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C);
<a name="l05262"></a>05262     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05263"></a>05263     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l05264"></a>05264 
<a name="l05265"></a>05265     <span class="keywordflow">if</span> (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a> &amp;&amp; !enable) {
<a name="l05266"></a>05266         <a class="code" href="../../d6/dae/wm__operators_8c.html#a727fd4b9f550df05715220b35eeba023">WM_paint_cursor_end</a>(wm, settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a>);
<a name="l05267"></a>05267         settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05268"></a>05268     }
<a name="l05269"></a>05269     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enable)
<a name="l05270"></a>05270         settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a734142166fb62b582767fbe4974c70d4">WM_paint_cursor_activate</a>(wm, <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>, <a class="code" href="../../df/d60/paint__image_8c.html#a852699bf81a3a634e5c5823796ede88f">brush_drawcursor</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05271"></a>05271 }
<a name="l05272"></a>05272 
<a name="l05273"></a>05273 <span class="comment">/* enable the paint cursor if it isn&#39;t already.</span>
<a name="l05274"></a>05274 <span class="comment"> *</span>
<a name="l05275"></a>05275 <span class="comment"> * purpose is to make sure the paint cursor is shown if paint</span>
<a name="l05276"></a>05276 <span class="comment"> * mode is enabled in the image editor. the paint poll will</span>
<a name="l05277"></a>05277 <span class="comment"> * ensure that the cursor is hidden when not in paint mode */</span>
<a name="l05278"></a><a class="code" href="../../df/d60/paint__image_8c.html#ae19a452e97c3da107e1ba8ec9c604308">05278</a> <span class="keywordtype">void</span> <a class="code" href="../../de/d53/ED__image_8h.html#a9d072e54a02b05386b90c4826ee39d88">ED_space_image_paint_update</a>(<a class="code" href="../../d4/dc3/structwmWindowManager.html">wmWindowManager</a> *wm, <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings)
<a name="l05279"></a>05279 {
<a name="l05280"></a>05280     <a class="code" href="../../d1/d54/structImagePaintSettings.html">ImagePaintSettings</a> *imapaint = &amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>;
<a name="l05281"></a>05281 
<a name="l05282"></a>05282     <span class="keywordflow">if</span> (!imapaint-&gt;<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a>) {
<a name="l05283"></a>05283         imapaint-&gt;<a class="code" href="../../d1/d54/structImagePaintSettings.html#a0f84f3e7f50bd1a30c7cf36e52e3817a">paintcursor</a> =
<a name="l05284"></a>05284             <a class="code" href="../../d6/dae/wm__operators_8c.html#a734142166fb62b582767fbe4974c70d4">WM_paint_cursor_activate</a>(wm, <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>,
<a name="l05285"></a>05285                                      <a class="code" href="../../df/d60/paint__image_8c.html#a852699bf81a3a634e5c5823796ede88f">brush_drawcursor</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05286"></a>05286     }
<a name="l05287"></a>05287 }
<a name="l05288"></a>05288 
<a name="l05289"></a>05289 
<a name="l05290"></a><a class="code" href="../../df/d60/paint__image_8c.html#adc23cde80a5285a59df3a60a909698a3">05290</a> <span class="keywordtype">void</span> <a class="code" href="../../de/d53/ED__image_8h.html#a1389e2af124f9272f54f37366ec2065b">ED_space_image_uv_sculpt_update</a>(<a class="code" href="../../d4/dc3/structwmWindowManager.html">wmWindowManager</a> *wm, <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings)
<a name="l05291"></a>05291 {
<a name="l05292"></a>05292     <span class="keywordflow">if</span> (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#af7ce42dd5fcc7c52535ecc61842a7009">use_uv_sculpt</a>) {
<a name="l05293"></a>05293         <span class="keywordflow">if</span> (!settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>) {
<a name="l05294"></a>05294             settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>), <span class="stringliteral">&quot;UV Smooth paint&quot;</span>);
<a name="l05295"></a>05295             settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#afb53178ba8cbe2f1eb093a01c43f7a1f">uv_sculpt_tool</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae7f58246c6082772e6d952cdbf994b00">UV_SCULPT_TOOL_GRAB</a>;
<a name="l05296"></a>05296             settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#afd8aa6aceb5b943d136b8fe47a987960">uv_sculpt_settings</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a853abe551c55a521793b6df3771a6e18">UV_SCULPT_LOCK_BORDERS</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8763332fa9a03450b702b42e55b55786">UV_SCULPT_ALL_ISLANDS</a>;
<a name="l05297"></a>05297             settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a0b4892991f80f5a7cf71463f5008c8b2">uv_relax_method</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7dba7e55359e9ee1c7eb808ff99a3371">UV_SCULPT_TOOL_RELAX_LAPLACIAN</a>;
<a name="l05298"></a>05298         }
<a name="l05299"></a>05299 
<a name="l05300"></a>05300         <a class="code" href="../../d8/d86/BKE__paint_8h.html#a01e639cae3a45f6e88662083ba8bdd08">paint_init</a>(&amp;settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>-&gt;<a class="code" href="../../d6/dcf/structUvSculpt.html#acc76f2f5b6ea63dc6951b306d23e7426">paint</a>, <a class="code" href="../../d8/d86/BKE__paint_8h.html#a5c2f589b6976fb90df998b3e5c199a2b">PAINT_CURSOR_SCULPT</a>);
<a name="l05301"></a>05301 
<a name="l05302"></a>05302         <a class="code" href="../../d6/dae/wm__operators_8c.html#a734142166fb62b582767fbe4974c70d4">WM_paint_cursor_activate</a>(wm, <a class="code" href="../../df/d60/paint__image_8c.html#ac04444b53627bd2baaa8030d7a721066">uv_sculpt_brush_poll</a>,
<a name="l05303"></a>05303                                  <a class="code" href="../../df/d60/paint__image_8c.html#a852699bf81a3a634e5c5823796ede88f">brush_drawcursor</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05304"></a>05304     }
<a name="l05305"></a>05305     <span class="keywordflow">else</span> {
<a name="l05306"></a>05306         <span class="keywordflow">if</span> (settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>)
<a name="l05307"></a>05307             settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#ae213655363e0b6c06991bc62b04c346c">uvsculpt</a>-&gt;<a class="code" href="../../d6/dcf/structUvSculpt.html#acc76f2f5b6ea63dc6951b306d23e7426">paint</a>.<a class="code" href="../../d0/d6c/structPaint.html#a89f27059527cc9fd7a8dec3e9e124183">flags</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5031a8567a0671de309866bb78b88f87a86fab31513af94207aada5bd51a2c9b6">PAINT_SHOW_BRUSH</a>;
<a name="l05308"></a>05308     }
<a name="l05309"></a>05309 }
<a name="l05310"></a>05310 <span class="comment">/************************ grab clone operator ************************/</span>
<a name="l05311"></a>05311 
<a name="l05312"></a><a class="code" href="../../d3/d92/structGrabClone.html">05312</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d92/structGrabClone.html">GrabClone</a> {
<a name="l05313"></a><a class="code" href="../../d3/d92/structGrabClone.html#a458799fcf925086123e2dc9264b3c387">05313</a>     <span class="keywordtype">float</span> <a class="code" href="../../d3/d92/structGrabClone.html#a458799fcf925086123e2dc9264b3c387">startoffset</a>[2];
<a name="l05314"></a><a class="code" href="../../d3/d92/structGrabClone.html#a1be659de0c5e9aa94aa01f70d0d50d2a">05314</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d92/structGrabClone.html#ad5b1aae5aa29fca63efe12894a8d4c12">startx</a>, <a class="code" href="../../d3/d92/structGrabClone.html#a1be659de0c5e9aa94aa01f70d0d50d2a">starty</a>;
<a name="l05315"></a>05315 } <a class="code" href="../../df/d60/paint__image_8c.html#a50aea50b71fe5519f4dc263faa07f258">GrabClone</a>;
<a name="l05316"></a>05316 
<a name="l05317"></a><a class="code" href="../../df/d60/paint__image_8c.html#a97948b7d9c7be6001a390723a14d6d3f">05317</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a97948b7d9c7be6001a390723a14d6d3f">grab_clone_apply</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05318"></a>05318 {
<a name="l05319"></a>05319     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C);
<a name="l05320"></a>05320     <span class="keywordtype">float</span> delta[2];
<a name="l05321"></a>05321 
<a name="l05322"></a>05322     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;delta&quot;</span>, delta);
<a name="l05323"></a>05323     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a7f222b1bc110fa45434894fc9a919dec">add_v2_v2</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>, delta);
<a name="l05324"></a>05324     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l05325"></a>05325 }
<a name="l05326"></a>05326 
<a name="l05327"></a><a class="code" href="../../df/d60/paint__image_8c.html#a34ee334be85ae3ebb69e316698bb9913">05327</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a34ee334be85ae3ebb69e316698bb9913">grab_clone_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05328"></a>05328 {
<a name="l05329"></a>05329     <a class="code" href="../../df/d60/paint__image_8c.html#a97948b7d9c7be6001a390723a14d6d3f">grab_clone_apply</a>(C, op);
<a name="l05330"></a>05330 
<a name="l05331"></a>05331     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05332"></a>05332 }
<a name="l05333"></a>05333 
<a name="l05334"></a><a class="code" href="../../df/d60/paint__image_8c.html#a7cbd481bc38729ecda75c32f8c943ab7">05334</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a7cbd481bc38729ecda75c32f8c943ab7">grab_clone_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05335"></a>05335 {
<a name="l05336"></a>05336     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C);
<a name="l05337"></a>05337     <a class="code" href="../../d3/d92/structGrabClone.html">GrabClone</a> *cmv;
<a name="l05338"></a>05338 
<a name="l05339"></a>05339     cmv = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d92/structGrabClone.html">GrabClone</a>), <span class="stringliteral">&quot;GrabClone&quot;</span>);
<a name="l05340"></a>05340     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#a458799fcf925086123e2dc9264b3c387">startoffset</a>, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>);
<a name="l05341"></a>05341     cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#ad5b1aae5aa29fca63efe12894a8d4c12">startx</a> = <span class="keyword">event</span>-&gt;x;
<a name="l05342"></a>05342     cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#a1be659de0c5e9aa94aa01f70d0d50d2a">starty</a> = <span class="keyword">event</span>-&gt;y;
<a name="l05343"></a>05343     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = cmv;
<a name="l05344"></a>05344 
<a name="l05345"></a>05345     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l05346"></a>05346 
<a name="l05347"></a>05347     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05348"></a>05348 }
<a name="l05349"></a>05349 
<a name="l05350"></a><a class="code" href="../../df/d60/paint__image_8c.html#a6000d9715a4160f17106e802628b9bec">05350</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a6000d9715a4160f17106e802628b9bec">grab_clone_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05351"></a>05351 {
<a name="l05352"></a>05352     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C);
<a name="l05353"></a>05353     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l05354"></a>05354     <a class="code" href="../../d3/d92/structGrabClone.html">GrabClone</a> *cmv = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l05355"></a>05355     <span class="keywordtype">float</span> startfx, startfy, fx, fy, delta[2];
<a name="l05356"></a>05356     <span class="keywordtype">int</span> xmin = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, ymin = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l05357"></a>05357 
<a name="l05358"></a>05358     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l05359"></a>05359         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>:
<a name="l05360"></a>05360         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a64d06d50176bcded7e70cd4ebbce0e12">MIDDLEMOUSE</a>:
<a name="l05361"></a>05361         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>: <span class="comment">// XXX hardcoded</span>
<a name="l05362"></a>05362             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l05363"></a>05363             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05364"></a>05364         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l05365"></a>05365             <span class="comment">/* mouse moved, so move the clone image */</span>
<a name="l05366"></a>05366             <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#ad5b1aae5aa29fca63efe12894a8d4c12">startx</a> - xmin, cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#a1be659de0c5e9aa94aa01f70d0d50d2a">starty</a> - ymin, &amp;startfx, &amp;startfy);
<a name="l05367"></a>05367             <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(&amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aa6d806b03b666c8e88f6178303145cb1">x</a> - xmin, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a1f9bfd9ad3dda5768a94bad7a3c3fc1e">y</a> - ymin, &amp;fx, &amp;fy);
<a name="l05368"></a>05368 
<a name="l05369"></a>05369             delta[0] = fx - startfx;
<a name="l05370"></a>05370             delta[1] = fy - startfy;
<a name="l05371"></a>05371             <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;delta&quot;</span>, delta);
<a name="l05372"></a>05372 
<a name="l05373"></a>05373             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a9b86451d625ff7f0602291e4f3ca37cc">offset</a>, cmv-&gt;<a class="code" href="../../d3/d92/structGrabClone.html#a458799fcf925086123e2dc9264b3c387">startoffset</a>);
<a name="l05374"></a>05374 
<a name="l05375"></a>05375             <a class="code" href="../../df/d60/paint__image_8c.html#a97948b7d9c7be6001a390723a14d6d3f">grab_clone_apply</a>(C, op);
<a name="l05376"></a>05376             <span class="keywordflow">break</span>;
<a name="l05377"></a>05377     }
<a name="l05378"></a>05378 
<a name="l05379"></a>05379     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05380"></a>05380 }
<a name="l05381"></a>05381 
<a name="l05382"></a><a class="code" href="../../df/d60/paint__image_8c.html#a426df94e616212453302791ecf18981b">05382</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a426df94e616212453302791ecf18981b">grab_clone_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05383"></a>05383 {
<a name="l05384"></a>05384     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l05385"></a>05385     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05386"></a>05386 }
<a name="l05387"></a>05387 
<a name="l05388"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#a1c9bed1b7098cb0dee287f996f260a43">05388</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#ac3ef0d22357000818d5571e6e4596780">PAINT_OT_grab_clone</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05389"></a>05389 {
<a name="l05390"></a>05390     <span class="comment">/* identifiers */</span>
<a name="l05391"></a>05391     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Grab Clone&quot;</span>;
<a name="l05392"></a>05392     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_grab_clone&quot;</span>;
<a name="l05393"></a>05393     
<a name="l05394"></a>05394     <span class="comment">/* api callbacks */</span>
<a name="l05395"></a>05395     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a34ee334be85ae3ebb69e316698bb9913">grab_clone_exec</a>;
<a name="l05396"></a>05396     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a7cbd481bc38729ecda75c32f8c943ab7">grab_clone_invoke</a>;
<a name="l05397"></a>05397     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a6000d9715a4160f17106e802628b9bec">grab_clone_modal</a>;
<a name="l05398"></a>05398     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a426df94e616212453302791ecf18981b">grab_clone_cancel</a>;
<a name="l05399"></a>05399     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#add83b42539531a89e99aa833dfe4cbb4">image_paint_2d_clone_poll</a>;
<a name="l05400"></a>05400 
<a name="l05401"></a>05401     <span class="comment">/* flags */</span>
<a name="l05402"></a>05402     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l05403"></a>05403 
<a name="l05404"></a>05404     <span class="comment">/* properties */</span>
<a name="l05405"></a>05405     <a class="code" href="../../dc/d7e/rna__define_8c.html#a60e910dcfdccf2a1ede6471837912011">RNA_def_float_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;delta&quot;</span>, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <span class="stringliteral">&quot;Delta&quot;</span>, <span class="stringliteral">&quot;Delta offset of clone image in 0.0..1.0 coordinates&quot;</span>, -1.0f, 1.0f);
<a name="l05406"></a>05406 }
<a name="l05407"></a>05407 
<a name="l05408"></a>05408 <span class="comment">/******************** sample color operator ********************/</span>
<a name="l05409"></a>05409 
<a name="l05410"></a><a class="code" href="../../df/d60/paint__image_8c.html#a426105fbe341486449e67adffbf187da">05410</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a426105fbe341486449e67adffbf187da">sample_color_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05411"></a>05411 {
<a name="l05412"></a>05412     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05413"></a>05413     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../df/d60/paint__image_8c.html#a452d02176f8618156fe8016674196a36">image_paint_brush</a>(C);
<a name="l05414"></a>05414     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l05415"></a>05415     <span class="keywordtype">int</span> location[2];
<a name="l05416"></a>05416 
<a name="l05417"></a>05417     <a class="code" href="../../d3/d10/rna__access_8c.html#a1b4f34d2a7327fff936fef0827f88c82">RNA_int_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l05418"></a>05418     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a4ccd070f09a1adde6f2d97185d8e0d96">paint_sample_color</a>(scene, ar, location[0], location[1]);
<a name="l05419"></a>05419 
<a name="l05420"></a>05420     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a1f92a8bb850509b5eaec48a130689729">NC_BRUSH</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, brush);
<a name="l05421"></a>05421     
<a name="l05422"></a>05422     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05423"></a>05423 }
<a name="l05424"></a>05424 
<a name="l05425"></a><a class="code" href="../../df/d60/paint__image_8c.html#a1d33ed7c1f785ba5631883714cd2157a">05425</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a1d33ed7c1f785ba5631883714cd2157a">sample_color_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05426"></a>05426 {
<a name="l05427"></a>05427     <a class="code" href="../../d3/d10/rna__access_8c.html#a07d118fd9a475df360075da1d92f0c84">RNA_int_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>);
<a name="l05428"></a>05428     <a class="code" href="../../df/d60/paint__image_8c.html#a426105fbe341486449e67adffbf187da">sample_color_exec</a>(C, op);
<a name="l05429"></a>05429 
<a name="l05430"></a>05430     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l05431"></a>05431 
<a name="l05432"></a>05432     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05433"></a>05433 }
<a name="l05434"></a>05434 
<a name="l05435"></a><a class="code" href="../../df/d60/paint__image_8c.html#a011ce1f10a314cbd3c66e4539e77afe0">05435</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a011ce1f10a314cbd3c66e4539e77afe0">sample_color_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05436"></a>05436 {
<a name="l05437"></a>05437     <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l05438"></a>05438         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>:
<a name="l05439"></a>05439         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>: <span class="comment">// XXX hardcoded</span>
<a name="l05440"></a>05440             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05441"></a>05441         <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>:
<a name="l05442"></a>05442             <a class="code" href="../../d3/d10/rna__access_8c.html#a07d118fd9a475df360075da1d92f0c84">RNA_int_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>);
<a name="l05443"></a>05443             <a class="code" href="../../df/d60/paint__image_8c.html#a426105fbe341486449e67adffbf187da">sample_color_exec</a>(C, op);
<a name="l05444"></a>05444             <span class="keywordflow">break</span>;
<a name="l05445"></a>05445     }
<a name="l05446"></a>05446 
<a name="l05447"></a>05447     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l05448"></a>05448 }
<a name="l05449"></a>05449 
<a name="l05450"></a>05450 <span class="comment">/* same as image_paint_poll but fail when face mask mode is enabled */</span>
<a name="l05451"></a><a class="code" href="../../df/d60/paint__image_8c.html#acf3de6700cb3dd517e2a30c03817566f">05451</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#acf3de6700cb3dd517e2a30c03817566f">image_paint_sample_color_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05452"></a>05452 {
<a name="l05453"></a>05453     <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>(C)) {
<a name="l05454"></a>05454         <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C)) {
<a name="l05455"></a>05455             <a class="code" href="../../de/de7/structObject.html">Object</a> *obact = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l05456"></a>05456             <span class="keywordflow">if</span> (obact &amp;&amp; obact-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>) {
<a name="l05457"></a>05457                 <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(obact);
<a name="l05458"></a>05458                 <span class="keywordflow">if</span> (me) {
<a name="l05459"></a>05459                     <span class="keywordflow">return</span> !(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>);
<a name="l05460"></a>05460                 }
<a name="l05461"></a>05461             }
<a name="l05462"></a>05462         }
<a name="l05463"></a>05463 
<a name="l05464"></a>05464         <span class="keywordflow">return</span> 1;
<a name="l05465"></a>05465     }
<a name="l05466"></a>05466 
<a name="l05467"></a>05467     <span class="keywordflow">return</span> 0;
<a name="l05468"></a>05468 }
<a name="l05469"></a>05469 
<a name="l05470"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#ae77a51b74b5845be1a6cd896755079ff">05470</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a602b0515f2cb20157ee6a58c2cddc45b">PAINT_OT_sample_color</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05471"></a>05471 {
<a name="l05472"></a>05472     <span class="comment">/* identifiers */</span>
<a name="l05473"></a>05473     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Sample Color&quot;</span>;
<a name="l05474"></a>05474     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_sample_color&quot;</span>;
<a name="l05475"></a>05475     
<a name="l05476"></a>05476     <span class="comment">/* api callbacks */</span>
<a name="l05477"></a>05477     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a426105fbe341486449e67adffbf187da">sample_color_exec</a>;
<a name="l05478"></a>05478     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a1d33ed7c1f785ba5631883714cd2157a">sample_color_invoke</a>;
<a name="l05479"></a>05479     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a011ce1f10a314cbd3c66e4539e77afe0">sample_color_modal</a>;
<a name="l05480"></a>05480     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#acf3de6700cb3dd517e2a30c03817566f">image_paint_sample_color_poll</a>;
<a name="l05481"></a>05481 
<a name="l05482"></a>05482     <span class="comment">/* flags */</span>
<a name="l05483"></a>05483     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05484"></a>05484 
<a name="l05485"></a>05485     <span class="comment">/* properties */</span>
<a name="l05486"></a>05486     <a class="code" href="../../dc/d7e/rna__define_8c.html#a9226495b3032ffd1fe81dfe96c336ad9">RNA_def_int_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;location&quot;</span>, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, INT_MAX, <span class="stringliteral">&quot;Location&quot;</span>, <span class="stringliteral">&quot;Cursor location in region coordinates&quot;</span>, 0, 16384);
<a name="l05487"></a>05487 }
<a name="l05488"></a>05488 
<a name="l05489"></a>05489 <span class="comment">/******************** set clone cursor operator ********************/</span>
<a name="l05490"></a>05490 
<a name="l05491"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3468334f339ae8db2125ecf26b810e52">05491</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3468334f339ae8db2125ecf26b810e52">set_clone_cursor_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05492"></a>05492 {
<a name="l05493"></a>05493     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05494"></a>05494     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l05495"></a>05495     <span class="keywordtype">float</span> *cursor = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d);
<a name="l05496"></a>05496 
<a name="l05497"></a>05497     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, cursor);
<a name="l05498"></a>05498     
<a name="l05499"></a>05499     <a class="code" href="../../d1/d12/ED__screen_8h.html#a0982c011d985308b08320d5f9604418b">ED_area_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C));
<a name="l05500"></a>05500     
<a name="l05501"></a>05501     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05502"></a>05502 }
<a name="l05503"></a>05503 
<a name="l05504"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab801794382d325ab7c88000d6df76632">05504</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab801794382d325ab7c88000d6df76632">set_clone_cursor_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l05505"></a>05505 {
<a name="l05506"></a>05506     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05507"></a>05507     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l05508"></a>05508     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l05509"></a>05509     <span class="keywordtype">float</span> location[3];
<a name="l05510"></a>05510 
<a name="l05511"></a>05511     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l05512"></a>05512 
<a name="l05513"></a>05513     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6801b6b4744a26c8778c379be9172f53">ED_view3d_autodist</a>(scene, ar, v3d, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>, location))
<a name="l05514"></a>05514         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05515"></a>05515 
<a name="l05516"></a>05516     <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;location&quot;</span>, location);
<a name="l05517"></a>05517 
<a name="l05518"></a>05518     <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3468334f339ae8db2125ecf26b810e52">set_clone_cursor_exec</a>(C, op);
<a name="l05519"></a>05519 }
<a name="l05520"></a>05520 
<a name="l05521"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#a64c10db96298cce43f766fc7351ec4bf">05521</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a083bcc63a2b2d08db1e5510b11951011">PAINT_OT_clone_cursor_set</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05522"></a>05522 {
<a name="l05523"></a>05523     <span class="comment">/* identifiers */</span>
<a name="l05524"></a>05524     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Set Clone Cursor&quot;</span>;
<a name="l05525"></a>05525     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_clone_cursor_set&quot;</span>;
<a name="l05526"></a>05526     
<a name="l05527"></a>05527     <span class="comment">/* api callbacks */</span>
<a name="l05528"></a>05528     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a3468334f339ae8db2125ecf26b810e52">set_clone_cursor_exec</a>;
<a name="l05529"></a>05529     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../df/d60/paint__image_8c.html#ab801794382d325ab7c88000d6df76632">set_clone_cursor_invoke</a>;
<a name="l05530"></a>05530     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a064f9146cbe84b8b389694ac45d5042a">image_paint_3d_poll</a>;
<a name="l05531"></a>05531 
<a name="l05532"></a>05532     <span class="comment">/* flags */</span>
<a name="l05533"></a>05533     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05534"></a>05534 
<a name="l05535"></a>05535     <span class="comment">/* properties */</span>
<a name="l05536"></a>05536     <a class="code" href="../../dc/d7e/rna__define_8c.html#a60e910dcfdccf2a1ede6471837912011">RNA_def_float_vector</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;location&quot;</span>, 3, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>, <span class="stringliteral">&quot;Location&quot;</span>, <span class="stringliteral">&quot;Cursor location in world space coordinates&quot;</span>, -10000.0f, 10000.0f);
<a name="l05537"></a>05537 }
<a name="l05538"></a>05538 
<a name="l05539"></a>05539 <span class="comment">/******************** texture paint toggle operator ********************/</span>
<a name="l05540"></a>05540 
<a name="l05541"></a><a class="code" href="../../df/d60/paint__image_8c.html#a3bb82b1192de39a013d21b8492ad1d93">05541</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a3bb82b1192de39a013d21b8492ad1d93">texture_paint_toggle_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05542"></a>05542 {
<a name="l05543"></a>05543     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C))
<a name="l05544"></a>05544         <span class="keywordflow">return</span> 0;
<a name="l05545"></a>05545     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l05546"></a>05546         <span class="keywordflow">return</span> 0;
<a name="l05547"></a>05547 
<a name="l05548"></a>05548     <span class="keywordflow">return</span> 1;
<a name="l05549"></a>05549 }
<a name="l05550"></a>05550 
<a name="l05551"></a><a class="code" href="../../df/d60/paint__image_8c.html#a18d7381ab34969d0d5ccb7c71d0dcf98">05551</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a18d7381ab34969d0d5ccb7c71d0dcf98">texture_paint_toggle_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05552"></a>05552 {
<a name="l05553"></a>05553     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05554"></a>05554     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l05555"></a>05555     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05556"></a>05556     
<a name="l05557"></a>05557     <span class="keywordflow">if</span> (ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l05558"></a>05558         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05559"></a>05559     
<a name="l05560"></a>05560     <span class="keywordflow">if</span> (<a class="code" href="../../df/dac/BKE__object_8h.html#a7e66121d861c5070a2b6f9ed04ca87cb">object_data_is_libdata</a>(ob)) {
<a name="l05561"></a>05561         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can&#39;t edit external libdata&quot;</span>);
<a name="l05562"></a>05562         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05563"></a>05563     }
<a name="l05564"></a>05564 
<a name="l05565"></a>05565     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l05566"></a>05566 
<a name="l05567"></a>05567     <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>) &amp;&amp; !me) {
<a name="l05568"></a>05568         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Can only enter texture paint mode for mesh objects&quot;</span>);
<a name="l05569"></a>05569         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05570"></a>05570     }
<a name="l05571"></a>05571 
<a name="l05572"></a>05572     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>) {
<a name="l05573"></a>05573         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>;
<a name="l05574"></a>05574 
<a name="l05575"></a>05575         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.glreslimit != 0)
<a name="l05576"></a>05576             <a class="code" href="../../d3/df0/GPU__draw_8h.html#a644948e3c02370cf0a216e368a054030">GPU_free_images</a>();
<a name="l05577"></a>05577         <a class="code" href="../../d3/df0/GPU__draw_8h.html#a37eb8215f7291004ac4cc5ba98ea44c2">GPU_paint_set_mipmap</a>(1);
<a name="l05578"></a>05578 
<a name="l05579"></a>05579         <a class="code" href="../../df/d60/paint__image_8c.html#ade457760ddba6fff7a4767d8eab5a1da">toggle_paint_cursor</a>(C, 0);
<a name="l05580"></a>05580     }
<a name="l05581"></a>05581     <span class="keywordflow">else</span> {
<a name="l05582"></a>05582         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>;
<a name="l05583"></a>05583 
<a name="l05584"></a>05584         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l05585"></a>05585             me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>,
<a name="l05586"></a>05586                                               <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l05587"></a>05587 
<a name="l05588"></a>05588         <a class="code" href="../../d8/d86/BKE__paint_8h.html#a01e639cae3a45f6e88662083ba8bdd08">paint_init</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a2ef68c48836293b4bdbddd0dcedf958b">paint</a>, <a class="code" href="../../d8/d86/BKE__paint_8h.html#aa3a583de4359423b42929b953072cb1e">PAINT_CURSOR_TEXTURE_PAINT</a>);
<a name="l05589"></a>05589 
<a name="l05590"></a>05590         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.glreslimit != 0)
<a name="l05591"></a>05591             <a class="code" href="../../d3/df0/GPU__draw_8h.html#a644948e3c02370cf0a216e368a054030">GPU_free_images</a>();
<a name="l05592"></a>05592         <a class="code" href="../../d3/df0/GPU__draw_8h.html#a37eb8215f7291004ac4cc5ba98ea44c2">GPU_paint_set_mipmap</a>(0);
<a name="l05593"></a>05593 
<a name="l05594"></a>05594         <a class="code" href="../../df/d60/paint__image_8c.html#ade457760ddba6fff7a4767d8eab5a1da">toggle_paint_cursor</a>(C, 1);
<a name="l05595"></a>05595     }
<a name="l05596"></a>05596 
<a name="l05597"></a>05597     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l05598"></a>05598     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a53c798c29ec45386460a892c62769440">ND_MODE</a>, scene);
<a name="l05599"></a>05599 
<a name="l05600"></a>05600     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05601"></a>05601 }
<a name="l05602"></a>05602 
<a name="l05603"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#ae479cdc8c523fe6523e211582a00d217">05603</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#a68ed7c8258c39758ec15925850c03a78">PAINT_OT_texture_paint_toggle</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05604"></a>05604 {
<a name="l05605"></a>05605     <span class="comment">/* identifiers */</span>
<a name="l05606"></a>05606     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Texture Paint Toggle&quot;</span>;
<a name="l05607"></a>05607     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_texture_paint_toggle&quot;</span>;
<a name="l05608"></a>05608     
<a name="l05609"></a>05609     <span class="comment">/* api callbacks */</span>
<a name="l05610"></a>05610     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a18d7381ab34969d0d5ccb7c71d0dcf98">texture_paint_toggle_exec</a>;
<a name="l05611"></a>05611     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a3bb82b1192de39a013d21b8492ad1d93">texture_paint_toggle_poll</a>;
<a name="l05612"></a>05612 
<a name="l05613"></a>05613     <span class="comment">/* flags */</span>
<a name="l05614"></a>05614     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05615"></a>05615 }
<a name="l05616"></a>05616 
<a name="l05617"></a><a class="code" href="../../df/d60/paint__image_8c.html#ab85d3d40336513296fde5c6602d173b9">05617</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#ab85d3d40336513296fde5c6602d173b9">texture_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05618"></a>05618 {
<a name="l05619"></a>05619     <span class="keywordflow">if</span> (<a class="code" href="../../df/d60/paint__image_8c.html#a3bb82b1192de39a013d21b8492ad1d93">texture_paint_toggle_poll</a>(C))
<a name="l05620"></a>05620         <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C)-&gt;mode &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>)
<a name="l05621"></a>05621             <span class="keywordflow">return</span> 1;
<a name="l05622"></a>05622     
<a name="l05623"></a>05623     <span class="keywordflow">return</span> 0;
<a name="l05624"></a>05624 }
<a name="l05625"></a>05625 
<a name="l05626"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#ab65602b9d7b2215e6db16136d128717c">05626</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#adef2091e17699befa9ca8ba7da7033cf">image_texture_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05627"></a>05627 {
<a name="l05628"></a>05628     <span class="keywordflow">return</span> (<a class="code" href="../../df/d60/paint__image_8c.html#ab85d3d40336513296fde5c6602d173b9">texture_paint_poll</a>(C) || <a class="code" href="../../df/d60/paint__image_8c.html#ae5d4d523f1a8ea3bab5fd59a50f9bd3f">image_paint_poll</a>(C));
<a name="l05629"></a>05629 }
<a name="l05630"></a>05630 
<a name="l05631"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#afe498322b8546813361465899ed86282">05631</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a5b1d224c1c1ca030412d0f1a7b09105b">uv_sculpt_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05632"></a>05632 {
<a name="l05633"></a>05633     <span class="keywordflow">return</span> <a class="code" href="../../df/d60/paint__image_8c.html#ac04444b53627bd2baaa8030d7a721066">uv_sculpt_brush_poll</a>(C);
<a name="l05634"></a>05634 }
<a name="l05635"></a>05635 
<a name="l05636"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#af2b6ead312921f8364c955606b7f44c9">05636</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#af03d5d502eb1e604daebcdb6f537651f">facemask_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05637"></a>05637 {
<a name="l05638"></a>05638     <span class="keywordflow">return</span> <a class="code" href="../../d8/d86/BKE__paint_8h.html#a56fc7a16c6dcfa3dd82680c86385e45f">paint_facesel_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05639"></a>05639 }
<a name="l05640"></a>05640 
<a name="l05641"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#aa1924ef9a2208eb6803da430093ca04b">05641</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9d67f5488dd5c66209619bd03dc02f5d">vert_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05642"></a>05642 {
<a name="l05643"></a>05643     <span class="keywordflow">return</span> <a class="code" href="../../d8/d86/BKE__paint_8h.html#a347e2aab7dc47e1f5e58d0f43a8f2ca8">paint_vertsel_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05644"></a>05644 }
<a name="l05645"></a>05645 
<a name="l05646"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#ab434af081431fd3f78693e3efad73e3a">05646</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#aacca3ba6063ac3f2f58ba90f51463a2a">mask_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l05647"></a>05647 {
<a name="l05648"></a>05648     <span class="keywordflow">return</span> <a class="code" href="../../d8/d86/BKE__paint_8h.html#a56fc7a16c6dcfa3dd82680c86385e45f">paint_facesel_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C)) || <a class="code" href="../../d8/d86/BKE__paint_8h.html#a347e2aab7dc47e1f5e58d0f43a8f2ca8">paint_vertsel_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C));
<a name="l05649"></a>05649 }
<a name="l05650"></a>05650 <span class="comment">/* use project paint to re-apply an image */</span>
<a name="l05651"></a><a class="code" href="../../df/d60/paint__image_8c.html#a8ccc2c0d90be494627366ec335570c9e">05651</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a8ccc2c0d90be494627366ec335570c9e">texture_paint_camera_project_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05652"></a>05652 {
<a name="l05653"></a>05653     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C)-&gt;image, <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;image&quot;</span>));
<a name="l05654"></a>05654     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05655"></a>05655     <a class="code" href="../../d0/d4c/structProjPaintState.html">ProjPaintState</a> ps = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l05656"></a>05656     <span class="keywordtype">int</span> orig_brush_size;
<a name="l05657"></a>05657     <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *idgroup;
<a name="l05658"></a>05658     <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *view_data = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05659"></a>05659 
<a name="l05660"></a>05660     <a class="code" href="../../df/d60/paint__image_8c.html#acd740144727b703dd7fb65c822d50365">project_state_init</a>(C, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>, &amp;ps);
<a name="l05661"></a>05661 
<a name="l05662"></a>05662     <span class="keywordflow">if</span> (ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a33f6f1a7b96b63333b47656bc89ba78f">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l05663"></a>05663         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active mesh object&quot;</span>);
<a name="l05664"></a>05664         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05665"></a>05665     }
<a name="l05666"></a>05666 
<a name="l05667"></a>05667     <span class="keywordflow">if</span> (image == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05668"></a>05668         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Image could not be found&quot;</span>);
<a name="l05669"></a>05669         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05670"></a>05670     }
<a name="l05671"></a>05671 
<a name="l05672"></a>05672     ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#acfaf5c49e6159a42c0311a6cbf1ca3f5">reproject_image</a> = image;
<a name="l05673"></a>05673     ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(image, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05674"></a>05674 
<a name="l05675"></a>05675     <span class="keywordflow">if</span> (ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a81890aa7135d67b1990018f6e86379d1">reproject_ibuf</a>-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05676"></a>05676         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Image data could not be found&quot;</span>);
<a name="l05677"></a>05677         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05678"></a>05678     }
<a name="l05679"></a>05679 
<a name="l05680"></a>05680     idgroup = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#a6abd6d3d5bf8145c0b4d29166e938b11">IDP_GetProperties</a>(&amp;image-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, 0);
<a name="l05681"></a>05681 
<a name="l05682"></a>05682     <span class="keywordflow">if</span> (idgroup) {
<a name="l05683"></a>05683         view_data = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#a64bee8b920392c10852a9131a69e082a">IDP_GetPropertyTypeFromGroup</a>(idgroup, <a class="code" href="../../df/d60/paint__image_8c.html#aacaf081d26a03b460ceb39111eaa9194">PROJ_VIEW_DATA_ID</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a271555be6be919d1b73afc38fae790bb">IDP_ARRAY</a>);
<a name="l05684"></a>05684 
<a name="l05685"></a>05685         <span class="comment">/* type check to make sure its ok */</span>
<a name="l05686"></a>05686         <span class="keywordflow">if</span> (view_data-&gt;<a class="code" href="../../df/d42/structIDProperty.html#a29547849bca3ad9e553d7d6c715e86ca">len</a> != <a class="code" href="../../df/d60/paint__image_8c.html#a2508613f2e579874aa5fee40a69032b5">PROJ_VIEW_DATA_SIZE</a> || view_data-&gt;<a class="code" href="../../df/d42/structIDProperty.html#aec2d0f53108c1e8d492de12472c884f9">subtype</a> != <a class="code" href="../../d3/dfb/DNA__ID_8h.html#aae48343470e4420e7a5a3839f45e7c0a">IDP_FLOAT</a>) {
<a name="l05687"></a>05687             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Image project data invalid&quot;</span>);
<a name="l05688"></a>05688             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05689"></a>05689         }
<a name="l05690"></a>05690     }
<a name="l05691"></a>05691 
<a name="l05692"></a>05692     <span class="keywordflow">if</span> (view_data) {
<a name="l05693"></a>05693         <span class="comment">/* image has stored view projection info */</span>
<a name="l05694"></a>05694         ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a69cb721f7bda43a05e29c407e0eebf3e">PROJ_SRC_IMAGE_VIEW</a>;
<a name="l05695"></a>05695     }
<a name="l05696"></a>05696     <span class="keywordflow">else</span> {
<a name="l05697"></a>05697         ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a450e7b93bd370ef43e0410669f23530d">source</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a56b7a4e1251c26a2406c0ee3cda5d93c">PROJ_SRC_IMAGE_CAM</a>;
<a name="l05698"></a>05698 
<a name="l05699"></a>05699         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05700"></a>05700             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active camera set&quot;</span>);
<a name="l05701"></a>05701             <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05702"></a>05702         }
<a name="l05703"></a>05703     }
<a name="l05704"></a>05704 
<a name="l05705"></a>05705     <span class="comment">/* override */</span>
<a name="l05706"></a>05706     ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a49de763fb522a46abdbaad0c888f8e08">is_texbrush</a> = 0;
<a name="l05707"></a>05707     ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a85b405d753dbc3e5dd4b1cb23f79b343">is_airbrush</a> = 1;
<a name="l05708"></a>05708     orig_brush_size = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>);
<a name="l05709"></a>05709     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, 32); <span class="comment">/* cover the whole image */</span>
<a name="l05710"></a>05710 
<a name="l05711"></a>05711     ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#af3fca21ec3fd86ed7866b2d3036b4a96">tool</a> = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#a41bd38861e66f9dd43c7dcab9e7bb485">PAINT_TOOL_DRAW</a>; <span class="comment">/* so pixels are initialized with minimal info */</span>
<a name="l05712"></a>05712 
<a name="l05713"></a>05713     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9f3bb05546eeb62c063e6731ddb02ef4">IMAGEPAINT_DRAWING</a>;
<a name="l05714"></a>05714 
<a name="l05715"></a>05715     <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab8bed50dd373fb5e5192dfb78c561cda">undo_paint_push_begin</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#ae72eba1367367168e15c361226b6f8b5">UNDO_PAINT_IMAGE</a>, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a>,
<a name="l05716"></a>05716                           <a class="code" href="../../df/d60/paint__image_8c.html#a25817c3cd4284aa49818857455c8b5f7">image_undo_restore</a>, <a class="code" href="../../df/d60/paint__image_8c.html#ab48408e0b88f6dd23f5690a5a2823354">image_undo_free</a>);
<a name="l05717"></a>05717 
<a name="l05718"></a>05718     <span class="comment">/* allocate and initialize spacial data structures */</span>
<a name="l05719"></a>05719     <a class="code" href="../../df/d60/paint__image_8c.html#a34cdbe9457ea478ebb874465579b95ac">project_paint_begin</a>(&amp;ps);
<a name="l05720"></a>05720 
<a name="l05721"></a>05721     <span class="keywordflow">if</span> (ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#a5e5df9ebb919679461c83685cf9ff9fc">dm</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05722"></a>05722         <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, orig_brush_size);
<a name="l05723"></a>05723         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05724"></a>05724     }
<a name="l05725"></a>05725     <span class="keywordflow">else</span> {
<a name="l05726"></a>05726         <span class="keywordtype">float</span> pos[2] = {0.0, 0.0};
<a name="l05727"></a>05727         <span class="keywordtype">float</span> lastpos[2] = {0.0, 0.0};
<a name="l05728"></a>05728         <span class="keywordtype">int</span> a;
<a name="l05729"></a>05729 
<a name="l05730"></a>05730         <span class="keywordflow">for</span> (a = 0; a &lt; ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; a++)
<a name="l05731"></a>05731             <a class="code" href="../../df/d60/paint__image_8c.html#a4b2d6a9b45a4de5f188c81f2c2a94485">partial_redraw_array_init</a>(ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[a].<a class="code" href="../../dc/d64/structProjPaintImage.html#a3b5ef9e71f0651bbb946abc1ee24766a">partRedrawRect</a>);
<a name="l05732"></a>05732 
<a name="l05733"></a>05733         <a class="code" href="../../df/d60/paint__image_8c.html#ac6240e69a5f47dc2023d8a3e39531605">project_paint_op</a>(&amp;ps, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, lastpos, pos);
<a name="l05734"></a>05734 
<a name="l05735"></a>05735         <a class="code" href="../../df/d60/paint__image_8c.html#a1554f85f438e1cbc5ac4e49f7c37e006">project_image_refresh_tagged</a>(&amp;ps);
<a name="l05736"></a>05736 
<a name="l05737"></a>05737         <span class="keywordflow">for</span> (a = 0; a &lt; ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#ab9b5f33e05e789fd4c620a707c934a2f">image_tot</a>; a++) {
<a name="l05738"></a>05738             <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[a].<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>);
<a name="l05739"></a>05739             <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a86a44bfe4ef4915f026b4dd988498727">NC_IMAGE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#aadef13033fc62d800e9b25d93f5b96d0">projImages</a>[a].<a class="code" href="../../dc/d64/structProjPaintImage.html#ac8605496c21d1d6aac688b160199e824">ima</a>);
<a name="l05740"></a>05740         }
<a name="l05741"></a>05741     }
<a name="l05742"></a>05742 
<a name="l05743"></a>05743     <a class="code" href="../../df/d60/paint__image_8c.html#a87190dde8aa253de62b5b4032be51722">project_paint_end</a>(&amp;ps);
<a name="l05744"></a>05744 
<a name="l05745"></a>05745     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9f3bb05546eeb62c063e6731ddb02ef4">IMAGEPAINT_DRAWING</a>;
<a name="l05746"></a>05746     <a class="code" href="../../da/dc9/BKE__brush_8h.html#ae0954743a49aa014b39af43834c9af70">brush_set_size</a>(scene, ps.<a class="code" href="../../d0/d4c/structProjPaintState.html#abf5e0b213e13baf255f85049ae40e5b0">brush</a>, orig_brush_size);
<a name="l05747"></a>05747 
<a name="l05748"></a>05748     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05749"></a>05749 }
<a name="l05750"></a>05750 
<a name="l05751"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#a10aa3712e4bcf5f7208b4063be01c251">05751</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#abb555f44779309246068e5909a55bbc0">PAINT_OT_project_image</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05752"></a>05752 {
<a name="l05753"></a>05753     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l05754"></a>05754 
<a name="l05755"></a>05755     <span class="comment">/* identifiers */</span>
<a name="l05756"></a>05756     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Project Image&quot;</span>;
<a name="l05757"></a>05757     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_project_image&quot;</span>;
<a name="l05758"></a>05758     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Project an edited render from the active camera back onto the object&quot;</span>;
<a name="l05759"></a>05759 
<a name="l05760"></a>05760     <span class="comment">/* api callbacks */</span>
<a name="l05761"></a>05761     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a7fed5b2a4bd4179895d2e90c882ca3dd">WM_enum_search_invoke</a>;
<a name="l05762"></a>05762     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a8ccc2c0d90be494627366ec335570c9e">texture_paint_camera_project_exec</a>;
<a name="l05763"></a>05763 
<a name="l05764"></a>05764     <span class="comment">/* flags */</span>
<a name="l05765"></a>05765     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l05766"></a>05766 
<a name="l05767"></a>05767     prop = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;image&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#abf24cbff0dda06cfad896088d53288fe">DummyRNA_NULL_items</a>, 0, <span class="stringliteral">&quot;Image&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05768"></a>05768     <a class="code" href="../../dc/d7e/rna__define_8c.html#adb30c6a3157cbd3193ff1a8de159389f">RNA_def_enum_funcs</a>(prop, <a class="code" href="../../d5/d68/RNA__enum__types_8h.html#a8fc68a12579996defe78143002ed0f49">RNA_image_itemf</a>);
<a name="l05769"></a>05769     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = prop;
<a name="l05770"></a>05770 }
<a name="l05771"></a>05771 
<a name="l05772"></a><a class="code" href="../../df/d60/paint__image_8c.html#a9fc49a91011a83b5f77ffdaaee9088fc">05772</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d60/paint__image_8c.html#a9fc49a91011a83b5f77ffdaaee9088fc">texture_paint_image_from_view_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l05773"></a>05773 {
<a name="l05774"></a>05774     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image;
<a name="l05775"></a>05775     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l05776"></a>05776     <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l05777"></a>05777 
<a name="l05778"></a>05778     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l05779"></a>05779     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *settings = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l05780"></a>05780     <span class="keywordtype">int</span> w = settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#af01a7bb206ee6ef11f86f24d40597f43">screen_grab_size</a>[0];
<a name="l05781"></a>05781     <span class="keywordtype">int</span> h = settings-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#af01a7bb206ee6ef11f86f24d40597f43">screen_grab_size</a>[1];
<a name="l05782"></a>05782     <span class="keywordtype">int</span> maxsize;
<a name="l05783"></a>05783     <span class="keywordtype">char</span> err_out[256] = <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l05784"></a>05784 
<a name="l05785"></a>05785     <a class="code" href="../../d3/d10/rna__access_8c.html#a810e909d61281bbb2d9fe99f9f2219ab">RNA_string_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;filepath&quot;</span>, filename);
<a name="l05786"></a>05786 
<a name="l05787"></a>05787     glGetIntegerv(GL_MAX_TEXTURE_SIZE, &amp;maxsize);
<a name="l05788"></a>05788 
<a name="l05789"></a>05789     <span class="keywordflow">if</span> (w &gt; maxsize) w = maxsize;
<a name="l05790"></a>05790     <span class="keywordflow">if</span> (h &gt; maxsize) h = maxsize;
<a name="l05791"></a>05791 
<a name="l05792"></a>05792     ibuf = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a17f8f66dd5b0b3a2462093be68a2e954">ED_view3d_draw_offscreen_imbuf</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C), w, h, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, err_out);
<a name="l05793"></a>05793     <span class="keywordflow">if</span> (!ibuf) {
<a name="l05794"></a>05794         <span class="comment">/* Mostly happens when OpenGL offscreen buffer was failed to create, */</span>
<a name="l05795"></a>05795         <span class="comment">/* but could be other reasons. Should be handled in the future. nazgul */</span>
<a name="l05796"></a>05796         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Failed to create OpenGL offscreen buffer: %s&quot;</span>, err_out);
<a name="l05797"></a>05797         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l05798"></a>05798     }
<a name="l05799"></a>05799 
<a name="l05800"></a>05800     image = <a class="code" href="../../d2/d77/BKE__image_8h.html#a5d9ec8380d772a8039a783523231a0f1">BKE_add_image_imbuf</a>(ibuf);
<a name="l05801"></a>05801 
<a name="l05802"></a>05802     <span class="keywordflow">if</span> (image) {
<a name="l05803"></a>05803         <span class="comment">/* now for the trickyness. store the view projection here!</span>
<a name="l05804"></a>05804 <span class="comment">         * re-projection will reuse this */</span>
<a name="l05805"></a>05805         <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l05806"></a>05806         <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l05807"></a>05807 
<a name="l05808"></a>05808         <a class="code" href="../../df/d2e/unionIDPropertyTemplate.html">IDPropertyTemplate</a> val;
<a name="l05809"></a>05809         <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *idgroup = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#a6abd6d3d5bf8145c0b4d29166e938b11">IDP_GetProperties</a>(&amp;image-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, 1);
<a name="l05810"></a>05810         <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *view_data;
<a name="l05811"></a>05811         <span class="keywordtype">int</span> <a class="code" href="../../d8/d33/btConvexHull_8cpp.html#afce09874f19dc3bb6d742f1f52fd8bb0">orth</a>;
<a name="l05812"></a>05812         <span class="keywordtype">float</span> *<a class="code" href="../../d2/d41/classarray.html">array</a>;
<a name="l05813"></a>05813 
<a name="l05814"></a>05814         val.<a class="code" href="../../df/d2e/unionIDPropertyTemplate.html#a9955a6e4ecc473e7877e71aa4bc1cb77">array</a>.<a class="code" href="../../df/d2e/unionIDPropertyTemplate.html#a77ed867f249646211029a5f196cf3afe">len</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a2508613f2e579874aa5fee40a69032b5">PROJ_VIEW_DATA_SIZE</a>;
<a name="l05815"></a>05815         val.<a class="code" href="../../df/d2e/unionIDPropertyTemplate.html#a9955a6e4ecc473e7877e71aa4bc1cb77">array</a>.<a class="code" href="../../df/d2e/unionIDPropertyTemplate.html#af53fdea9afbef841a1d6ceb3658835f3">type</a> = <a class="code" href="../../d3/dfb/DNA__ID_8h.html#aae48343470e4420e7a5a3839f45e7c0a">IDP_FLOAT</a>;
<a name="l05816"></a>05816         view_data = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ab2130fe4ddfd0002e655dbee991d517e">IDP_New</a>(<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a271555be6be919d1b73afc38fae790bb">IDP_ARRAY</a>, &amp;val, <a class="code" href="../../df/d60/paint__image_8c.html#aacaf081d26a03b460ceb39111eaa9194">PROJ_VIEW_DATA_ID</a>);
<a name="l05817"></a>05817 
<a name="l05818"></a>05818         array = (<span class="keywordtype">float</span> *)<a class="code" href="../../d5/d95/BKE__idprop_8h.html#afcd801b64d87f8967273ddd406377549">IDP_Array</a>(view_data);
<a name="l05819"></a>05819         memcpy(array, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, <span class="keyword">sizeof</span>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>)); array += <span class="keyword">sizeof</span>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);
<a name="l05820"></a>05820         memcpy(array, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, <span class="keyword">sizeof</span>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>)); array += <span class="keyword">sizeof</span>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);
<a name="l05821"></a>05821         orth = <a class="code" href="../../df/d60/paint__image_8c.html#a9e7a7981ddcd6ac0cb6b5899ea208b35">project_paint_view_clip</a>(v3d, rv3d, &amp;array[0], &amp;array[1]);
<a name="l05822"></a>05822         array[2] = orth ? 1.0f : 0.0f; <span class="comment">/* using float for a bool is dodgy but since its an extra member in the array... easier then adding a single bool prop */</span>
<a name="l05823"></a>05823 
<a name="l05824"></a>05824         <a class="code" href="../../d5/d95/BKE__idprop_8h.html#a138d36796279ac5dfae6a2819e1aaa8d">IDP_AddToGroup</a>(idgroup, view_data);
<a name="l05825"></a>05825 
<a name="l05826"></a>05826         <a class="code" href="../../d8/db1/BKE__library_8h.html#a16cc53dc9c28e8f37500f0f255009876">rename_id</a>(&amp;image-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>, <span class="stringliteral">&quot;image_view&quot;</span>);
<a name="l05827"></a>05827     }
<a name="l05828"></a>05828 
<a name="l05829"></a>05829     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l05830"></a>05830 }
<a name="l05831"></a>05831 
<a name="l05832"></a><a class="code" href="../../d3/d6c/paint__intern_8h.html#ac8d100e5400027f8acf570bf5a80bbc7">05832</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d60/paint__image_8c.html#af8abcca2c880460a58eb21c417dc6c0b">PAINT_OT_image_from_view</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l05833"></a>05833 {
<a name="l05834"></a>05834     <span class="comment">/* identifiers */</span>
<a name="l05835"></a>05835     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Image from View&quot;</span>;
<a name="l05836"></a>05836     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_image_from_view&quot;</span>;
<a name="l05837"></a>05837     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Make an image from the current 3D view for re-projection&quot;</span>;
<a name="l05838"></a>05838 
<a name="l05839"></a>05839     <span class="comment">/* api callbacks */</span>
<a name="l05840"></a>05840     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../df/d60/paint__image_8c.html#a9fc49a91011a83b5f77ffdaaee9088fc">texture_paint_image_from_view_exec</a>;
<a name="l05841"></a>05841     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#ad3e4c76483a77957597951a50918f556">ED_operator_region_view3d_active</a>;
<a name="l05842"></a>05842 
<a name="l05843"></a>05843     <span class="comment">/* flags */</span>
<a name="l05844"></a>05844     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>;
<a name="l05845"></a>05845 
<a name="l05846"></a>05846     <a class="code" href="../../dc/d7e/rna__define_8c.html#a02395c5b21ed716d3ba724a608cb2ec5">RNA_def_string_file_name</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;filepath&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, <span class="stringliteral">&quot;File Path&quot;</span>, <span class="stringliteral">&quot;Name of the file&quot;</span>);
<a name="l05847"></a>05847 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:43 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
