<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: lattice.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">lattice.c</div>  </div>
</div>
<div class="contents">
<a href="../../df/d67/lattice_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd1/BLI__bpath_8h.html">BLI_bpath.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d88/DNA__curve__types_8h.html">DNA_curve_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8f/BKE__lattice_8h.html">BKE_lattice.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">//XXX #include &quot;BIF_editdeform.h&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="../../df/d67/lattice_8c.html#a6864cdf777d3ac562032c300bb2d804b">00070</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6864cdf777d3ac562032c300bb2d804b">calc_lat_fudu</a>(<span class="keywordtype">int</span> flag, <span class="keywordtype">int</span> res, <span class="keywordtype">float</span> *fu, <span class="keywordtype">float</span> *du)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072     <span class="keywordflow">if</span> (res==1) {
<a name="l00073"></a>00073         *fu= 0.0;
<a name="l00074"></a>00074         *du= 0.0;
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html#ace709a08071de8cb1fd0215c7279f099">LT_GRID</a>) {
<a name="l00077"></a>00077         *fu= -0.5f*(res-1);
<a name="l00078"></a>00078         *du= 1.0f;
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080     <span class="keywordflow">else</span> {
<a name="l00081"></a>00081         *fu= -1.0f;
<a name="l00082"></a>00082         *du= 2.0f/(res-1);
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="../../df/d67/lattice_8c.html#a6f5aad4079ccc0d4f5b17edd797f2f0f">00086</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a8ed4eeabc05100ff102ba16ad5d8cb4b">resizelattice</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt, <span class="keywordtype">int</span> uNew, <span class="keywordtype">int</span> vNew, <span class="keywordtype">int</span> wNew, <a class="code" href="../../de/de7/structObject.html">Object</a> *ltOb)
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l00089"></a>00089     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, u, v, w;
<a name="l00090"></a>00090     <span class="keywordtype">float</span> fu, fv, fw, uc, vc, wc, du=0.0, dv=0.0, dw=0.0;
<a name="l00091"></a>00091     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, (*vertexCos)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     <span class="comment">/* vertex weight groups are just freed all for now */</span>
<a name="l00094"></a>00094     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>) {
<a name="l00095"></a>00095         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#aa7b3531228000f544fdad9d531a64ed9">free_dverts</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>);
<a name="l00096"></a>00096         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098     
<a name="l00099"></a>00099     <span class="keywordflow">while</span> (uNew*vNew*wNew &gt; 32000) {
<a name="l00100"></a>00100         <span class="keywordflow">if</span> ( uNew&gt;=vNew &amp;&amp; uNew&gt;=wNew) uNew--;
<a name="l00101"></a>00101         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( vNew&gt;=uNew &amp;&amp; vNew&gt;=wNew) vNew--;
<a name="l00102"></a>00102         <span class="keywordflow">else</span> wNew--;
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     vertexCos = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(*vertexCos)*uNew*vNew*wNew, <span class="stringliteral">&quot;tmp_vcos&quot;</span>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6864cdf777d3ac562032c300bb2d804b">calc_lat_fudu</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a>, uNew, &amp;fu, &amp;du);
<a name="l00108"></a>00108     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6864cdf777d3ac562032c300bb2d804b">calc_lat_fudu</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a>, vNew, &amp;fv, &amp;dv);
<a name="l00109"></a>00109     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6864cdf777d3ac562032c300bb2d804b">calc_lat_fudu</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a>, wNew, &amp;fw, &amp;dw);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="comment">/* If old size is different then resolution changed in interface,</span>
<a name="l00112"></a>00112 <span class="comment">         * try to do clever reinit of points. Pretty simply idea, we just</span>
<a name="l00113"></a>00113 <span class="comment">         * deform new verts by old lattice, but scaling them to match old</span>
<a name="l00114"></a>00114 <span class="comment">         * size first.</span>
<a name="l00115"></a>00115 <span class="comment">         */</span>
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (ltOb) {
<a name="l00117"></a>00117         <span class="keywordflow">if</span> (uNew!=1 &amp;&amp; lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>!=1) {
<a name="l00118"></a>00118             fu = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a890bcf536b70a54bbf247eb106baa4f1">fu</a>;
<a name="l00119"></a>00119             du = (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>-1)*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac4eda643c836dbf1f71fee8b489c1f64">du</a>/(uNew-1);
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <span class="keywordflow">if</span> (vNew!=1 &amp;&amp; lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>!=1) {
<a name="l00123"></a>00123             fv = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ab25bf3c22d3b315338e9612c0fa11ade">fv</a>;
<a name="l00124"></a>00124             dv = (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>-1)*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a5840fb570824b6a0c0bf46b8e3a2bf3c">dv</a>/(vNew-1);
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (wNew!=1 &amp;&amp; lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>!=1) {
<a name="l00128"></a>00128             fw = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac8d406f2db096066240b9d96650de439">fw</a>;
<a name="l00129"></a>00129             dw = (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1)*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae7e004214556e3101ef9287bcbfe7fda">dw</a>/(wNew-1);
<a name="l00130"></a>00130         }
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     co = vertexCos[0];
<a name="l00134"></a>00134     <span class="keywordflow">for</span> (w=0,wc=fw; w&lt;wNew; w++,wc+=dw) {
<a name="l00135"></a>00135         <span class="keywordflow">for</span> (v=0,vc=fv; v&lt;vNew; v++,vc+=dv) {
<a name="l00136"></a>00136             <span class="keywordflow">for</span> (u=0,uc=fu; u&lt;uNew; u++,co+=3,uc+=du) {
<a name="l00137"></a>00137                 co[0] = uc;
<a name="l00138"></a>00138                 co[1] = vc;
<a name="l00139"></a>00139                 co[2] = wc;
<a name="l00140"></a>00140             }
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143     
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (ltOb) {
<a name="l00145"></a>00145         <span class="keywordtype">float</span> mat[4][4];
<a name="l00146"></a>00146         <span class="keywordtype">int</span> typeu = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a18bf3c7c7e650369119a1c692550a68b">typeu</a>, typev = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a02923f1966c6db5a49fadc6ac284d10e">typev</a>, typew = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#addd71448dfaba52e825e1b42924d68ab">typew</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148             <span class="comment">/* works best if we force to linear type (endpoints match) */</span>
<a name="l00149"></a>00149         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a18bf3c7c7e650369119a1c692550a68b">typeu</a> = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a02923f1966c6db5a49fadc6ac284d10e">typev</a> = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#addd71448dfaba52e825e1b42924d68ab">typew</a> = <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa6deed7f50e33ee925ec5b60255b97cb5">KEY_LINEAR</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151             <span class="comment">/* prevent using deformed locations */</span>
<a name="l00152"></a>00152         <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;ltOb-&gt;<a class="code" href="../../de/de7/structObject.html#a45d11e4826c3a8ba292c91691bb2885d">disp</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, ltOb-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00155"></a>00155         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(ltOb-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00156"></a>00156         <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a923f29b4941146247f6ca8489b57f316">lattice_deform_verts</a>(ltOb, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vertexCos, uNew*vNew*wNew, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1.0f);
<a name="l00157"></a>00157         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(ltOb-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, mat);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a18bf3c7c7e650369119a1c692550a68b">typeu</a> = typeu;
<a name="l00160"></a>00160         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a02923f1966c6db5a49fadc6ac284d10e">typev</a> = typev;
<a name="l00161"></a>00161         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#addd71448dfaba52e825e1b42924d68ab">typew</a> = typew;
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a890bcf536b70a54bbf247eb106baa4f1">fu</a> = fu;
<a name="l00165"></a>00165     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ab25bf3c22d3b315338e9612c0fa11ade">fv</a> = fv;
<a name="l00166"></a>00166     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac8d406f2db096066240b9d96650de439">fw</a> = fw;
<a name="l00167"></a>00167     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac4eda643c836dbf1f71fee8b489c1f64">du</a> = du;
<a name="l00168"></a>00168     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a5840fb570824b6a0c0bf46b8e3a2bf3c">dv</a> = dv;
<a name="l00169"></a>00169     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae7e004214556e3101ef9287bcbfe7fda">dw</a> = dw;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> = uNew;
<a name="l00172"></a>00172     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> = vNew;
<a name="l00173"></a>00173     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a> = wNew;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>);
<a name="l00176"></a>00176     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d51/structBPoint.html">BPoint</a>), <span class="stringliteral">&quot;lattice bp&quot;</span>);
<a name="l00177"></a>00177     
<a name="l00178"></a>00178     bp= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     <span class="keywordflow">for</span> (i=0; i&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>; i++,bp++) {
<a name="l00181"></a>00181         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>, vertexCos[i]);
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vertexCos);
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="../../df/d67/lattice_8c.html#a494036f0a0f36a34916918a03b899ba0">00187</a> <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *<a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a0fcee2d467c2b190279198243e426dc8">add_lattice</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt;
<a name="l00190"></a>00190     
<a name="l00191"></a>00191     lt= <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;latt, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ad058b07954b2795eadc855a7a354578b">ID_LT</a>, name);
<a name="l00192"></a>00192     
<a name="l00193"></a>00193     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a>= <a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html#ace709a08071de8cb1fd0215c7279f099">LT_GRID</a>;
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a18bf3c7c7e650369119a1c692550a68b">typeu</a>= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a02923f1966c6db5a49fadc6ac284d10e">typev</a>= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#addd71448dfaba52e825e1b42924d68ab">typew</a>= <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>;
<a name="l00196"></a>00196     
<a name="l00197"></a>00197     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d51/structBPoint.html">BPoint</a>), <span class="stringliteral">&quot;lattvert&quot;</span>); <span class="comment">/* temporary */</span>
<a name="l00198"></a>00198     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a8ed4eeabc05100ff102ba16ad5d8cb4b">resizelattice</a>(lt, 2, 2, 2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);   <span class="comment">/* creates a uniform lattice */</span>
<a name="l00199"></a>00199         
<a name="l00200"></a>00200     <span class="keywordflow">return</span> lt;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="../../df/d67/lattice_8c.html#abe586bdcaec28c17ee12760ae196a950">00203</a> <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *<a class="code" href="../../d8/d8f/BKE__lattice_8h.html#ab3e72adb7dac09b9207099ef6af6ea75">copy_lattice</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *ltn;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     ltn= <a class="code" href="../../d8/db1/BKE__library_8h.html#a0c0c1987364874c73cda326eace31efd">copy_libblock</a>(&amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>);
<a name="l00208"></a>00208     ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>= <a class="code" href="../../d5/d17/BKE__key_8h.html#a8fb643b558a887ed5f9b5020491e54aa">copy_key</a>(ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>);
<a name="l00211"></a>00211     <span class="keywordflow">if</span> (ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>) ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a>= (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ltn;
<a name="l00212"></a>00212     
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>) {
<a name="l00214"></a>00214         <span class="keywordtype">int</span> tot= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l00215"></a>00215         ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a> (<span class="keyword">sizeof</span> (<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a>)*tot, <span class="stringliteral">&quot;Lattice MDeformVert&quot;</span>);
<a name="l00216"></a>00216         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a672c5c9b1b2357a8c937c5ed97640fb4">copy_dverts</a>(ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>, tot);
<a name="l00217"></a>00217     }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     ltn-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">return</span> ltn;
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a><a class="code" href="../../df/d67/lattice_8c.html#af598fa720ff86cb22ac46ec465930e78">00224</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#ac5f669753df24aeec410de8de61ec2bc">free_lattice</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>);
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>) <a class="code" href="../../df/d7f/BKE__mesh_8h.html#aa7b3531228000f544fdad9d531a64ed9">free_dverts</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>);
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) {
<a name="l00229"></a>00229         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *editlt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (editlt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(editlt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>);
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (editlt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>) <a class="code" href="../../df/d7f/BKE__mesh_8h.html#aa7b3531228000f544fdad9d531a64ed9">free_dverts</a>(editlt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(editlt);
<a name="l00235"></a>00235         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>);
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237     
<a name="l00238"></a>00238     <span class="comment">/* free animation data */</span>
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#aefdb803caabd9962f7781773e027992e">adt</a>) {
<a name="l00240"></a>00240         <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a186ce67df8bf9873cc945eed480eaa49">BKE_free_animdata</a>(&amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>);
<a name="l00241"></a>00241         lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#aefdb803caabd9962f7781773e027992e">adt</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="../../df/d67/lattice_8c.html#a43b74bf80d14eebdefe798042641346c">00246</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#afb49305aed146961d304c5cd5ae4df6f">make_local_lattice</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main;
<a name="l00249"></a>00249     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00250"></a>00250     <span class="keywordtype">int</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="comment">/* - only lib users: do nothing</span>
<a name="l00253"></a>00253 <span class="comment">     * - only local users: set flag</span>
<a name="l00254"></a>00254 <span class="comment">     * - mixed: make copy</span>
<a name="l00255"></a>00255 <span class="comment">     */</span>
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>==1) {
<a name="l00259"></a>00259         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>);
<a name="l00260"></a>00260         <span class="keywordflow">return</span>;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262     
<a name="l00263"></a>00263     <span class="keywordflow">for</span> (ob= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, is_lib, is_local); ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00264"></a>00264         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>==lt) {
<a name="l00265"></a>00265             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00266"></a>00266             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     
<a name="l00270"></a>00270     <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib==<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00271"></a>00271         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>);
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib) {
<a name="l00274"></a>00274         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt_new= <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#ab3e72adb7dac09b9207099ef6af6ea75">copy_lattice</a>(lt);
<a name="l00275"></a>00275         lt_new-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>= 0;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         <span class="comment">/* Remap paths of new ID using old library as base. */</span>
<a name="l00278"></a>00278         <a class="code" href="../../d8/db1/BKE__library_8h.html#a28231f1e4d5edb6c8498db449bda4528">BKE_id_lib_local_paths</a>(bmain, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>, &amp;lt_new-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="keywordflow">for</span> (ob= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00281"></a>00281             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>==lt) {
<a name="l00282"></a>00282                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00283"></a>00283                     ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>= lt_new;
<a name="l00284"></a>00284                     lt_new-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00285"></a>00285                     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae0c6751398f7133b5b11e8ceb107fe37">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00286"></a>00286                 }
<a name="l00287"></a>00287             }
<a name="l00288"></a>00288         }
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="../../df/d67/lattice_8c.html#a37d63b4993c2d92aba46d71a9c402d53">00292</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a7fa9f353e4dd340039a3a500c1397622">init_latt_deform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *oblatt, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294         <span class="comment">/* we make an array with all differences */</span>
<a name="l00295"></a>00295     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00296"></a>00296     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l00297"></a>00297     <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl = <a class="code" href="../../d9/d12/BKE__displist_8h.html#ad5e487b875d521238ee319bfe8f659f8">find_displist</a>(&amp;oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#a45d11e4826c3a8ba292c91691bb2885d">disp</a>, <a class="code" href="../../d9/d12/BKE__displist_8h.html#a91ca502ecb1aec32fd6e83349c74a085">DL_VERTS</a>);
<a name="l00298"></a>00298     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = dl?dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>:<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00299"></a>00299     <span class="keywordtype">float</span> *fp, imat[4][4];
<a name="l00300"></a>00300     <span class="keywordtype">float</span> fu, fv, fw;
<a name="l00301"></a>00301     <span class="keywordtype">int</span> u, v, w;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) lt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l00304"></a>00304     bp = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l00305"></a>00305     
<a name="l00306"></a>00306     fp= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>, <span class="stringliteral">&quot;latticedata&quot;</span>);
<a name="l00307"></a>00307     
<a name="l00308"></a>00308         <span class="comment">/* for example with a particle system: ob==0 */</span>
<a name="l00309"></a>00309     <span class="keywordflow">if</span> (ob==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00310"></a>00310         <span class="comment">/* in deformspace, calc matrix  */</span>
<a name="l00311"></a>00311         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a58f75d477af30f5464d9ac370a99b678">latmat</a>, oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00312"></a>00312     
<a name="l00313"></a>00313         <span class="comment">/* back: put in deform array */</span>
<a name="l00314"></a>00314         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a58f75d477af30f5464d9ac370a99b678">latmat</a>);
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     <span class="keywordflow">else</span> {
<a name="l00317"></a>00317         <span class="comment">/* in deformspace, calc matrix */</span>
<a name="l00318"></a>00318         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00319"></a>00319         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a58f75d477af30f5464d9ac370a99b678">latmat</a>, imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00320"></a>00320     
<a name="l00321"></a>00321         <span class="comment">/* back: put in deform array */</span>
<a name="l00322"></a>00322         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a58f75d477af30f5464d9ac370a99b678">latmat</a>);
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="keywordflow">for</span> (w=0,fw=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac8d406f2db096066240b9d96650de439">fw</a>; w&lt;lt-&gt;pntsw; w++,fw+=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae7e004214556e3101ef9287bcbfe7fda">dw</a>) {
<a name="l00326"></a>00326         <span class="keywordflow">for</span> (v=0,fv=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ab25bf3c22d3b315338e9612c0fa11ade">fv</a>; v&lt;lt-&gt;pntsv; v++, fv+=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a5840fb570824b6a0c0bf46b8e3a2bf3c">dv</a>) {
<a name="l00327"></a>00327             <span class="keywordflow">for</span> (u=0,fu=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a890bcf536b70a54bbf247eb106baa4f1">fu</a>; u&lt;lt-&gt;pntsu; u++, bp++, co+=3, fp+=3, fu+=lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac4eda643c836dbf1f71fee8b489c1f64">du</a>) {
<a name="l00328"></a>00328                 <span class="keywordflow">if</span> (dl) {
<a name="l00329"></a>00329                     fp[0] = co[0] - fu;
<a name="l00330"></a>00330                     fp[1] = co[1] - fv;
<a name="l00331"></a>00331                     fp[2] = co[2] - fw;
<a name="l00332"></a>00332                 }
<a name="l00333"></a>00333                 <span class="keywordflow">else</span> {
<a name="l00334"></a>00334                     fp[0] = bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] - fu;
<a name="l00335"></a>00335                     fp[1] = bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] - fv;
<a name="l00336"></a>00336                     fp[2] = bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] - fw;
<a name="l00337"></a>00337                 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(imat, fp);
<a name="l00340"></a>00340             }
<a name="l00341"></a>00341         }
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="../../df/d67/lattice_8c.html#a23107e21572ba907319e7da157d2bf96">00345</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a8435b8f6a07c626be80af92647c0b0ef">calc_latt_deform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> weight)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00348"></a>00348     <span class="keywordtype">float</span> u, v, w, tu[4], tv[4], tw[4];
<a name="l00349"></a>00349     <span class="keywordtype">float</span> vec[3];
<a name="l00350"></a>00350     <span class="keywordtype">int</span> idx_w, idx_v, idx_u;
<a name="l00351"></a>00351     <span class="keywordtype">int</span> ui, vi, wi, uu, vv, ww;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="comment">/* vgroup influence */</span>
<a name="l00354"></a>00354     <span class="keywordtype">int</span> defgroup_nr= -1;
<a name="l00355"></a>00355     <span class="keywordtype">float</span> co_prev[3], weight_blend= 0.0f;
<a name="l00356"></a>00356     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert= <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#afa7e5d8e40cbe78518abe822b900249d">lattice_get_deform_verts</a>(ob);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) lt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l00360"></a>00360     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac3878a5cf695b7218b84a6d67119fac0">vgroup</a>[0] &amp;&amp; dvert) {
<a name="l00363"></a>00363         defgroup_nr= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a>(ob, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac3878a5cf695b7218b84a6d67119fac0">vgroup</a>);
<a name="l00364"></a>00364         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co_prev, co);
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="comment">/* co is in local coords, treat with latmat */</span>
<a name="l00368"></a>00368     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(vec, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a58f75d477af30f5464d9ac370a99b678">latmat</a>, co);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">/* u v w coords */</span>
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>&gt;1) {
<a name="l00373"></a>00373         u= (vec[0]-lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a890bcf536b70a54bbf247eb106baa4f1">fu</a>)/lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac4eda643c836dbf1f71fee8b489c1f64">du</a>;
<a name="l00374"></a>00374         ui= (<span class="keywordtype">int</span>)floor(u);
<a name="l00375"></a>00375         u -= ui;
<a name="l00376"></a>00376         <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(u, tu, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a18bf3c7c7e650369119a1c692550a68b">typeu</a>);
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378     <span class="keywordflow">else</span> {
<a name="l00379"></a>00379         tu[0]= tu[2]= tu[3]= 0.0; tu[1]= 1.0;
<a name="l00380"></a>00380         ui= 0;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>&gt;1) {
<a name="l00384"></a>00384         v= (vec[1]-lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ab25bf3c22d3b315338e9612c0fa11ade">fv</a>)/lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a5840fb570824b6a0c0bf46b8e3a2bf3c">dv</a>;
<a name="l00385"></a>00385         vi= (<span class="keywordtype">int</span>)floor(v);
<a name="l00386"></a>00386         v -= vi;
<a name="l00387"></a>00387         <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(v, tv, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a02923f1966c6db5a49fadc6ac284d10e">typev</a>);
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     <span class="keywordflow">else</span> {
<a name="l00390"></a>00390         tv[0]= tv[2]= tv[3]= 0.0; tv[1]= 1.0;
<a name="l00391"></a>00391         vi= 0;
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>&gt;1) {
<a name="l00395"></a>00395         w= (vec[2]-lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ac8d406f2db096066240b9d96650de439">fw</a>)/lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae7e004214556e3101ef9287bcbfe7fda">dw</a>;
<a name="l00396"></a>00396         wi= (<span class="keywordtype">int</span>)floor(w);
<a name="l00397"></a>00397         w -= wi;
<a name="l00398"></a>00398         <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(w, tw, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#addd71448dfaba52e825e1b42924d68ab">typew</a>);
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400     <span class="keywordflow">else</span> {
<a name="l00401"></a>00401         tw[0]= tw[2]= tw[3]= 0.0; tw[1]= 1.0;
<a name="l00402"></a>00402         wi= 0;
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (ww= wi-1; ww&lt;=wi+2; ww++) {
<a name="l00406"></a>00406         w= tw[ww-wi+1];
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         <span class="keywordflow">if</span> (w != 0.0f) {
<a name="l00409"></a>00409             <span class="keywordflow">if</span> (ww&gt;0) {
<a name="l00410"></a>00410                 <span class="keywordflow">if</span> (ww&lt;lt-&gt;pntsw) idx_w= ww*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>;
<a name="l00411"></a>00411                 <span class="keywordflow">else</span> idx_w= (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1)*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>;
<a name="l00412"></a>00412             }
<a name="l00413"></a>00413             <span class="keywordflow">else</span> idx_w= 0;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             <span class="keywordflow">for</span> (vv= vi-1; vv&lt;=vi+2; vv++) {
<a name="l00416"></a>00416                 v= w*tv[vv-vi+1];
<a name="l00417"></a>00417 
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (v != 0.0f) {
<a name="l00419"></a>00419                     <span class="keywordflow">if</span> (vv&gt;0) {
<a name="l00420"></a>00420                         <span class="keywordflow">if</span> (vv&lt;lt-&gt;pntsv) idx_v= idx_w + vv*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>;
<a name="l00421"></a>00421                         <span class="keywordflow">else</span> idx_v= idx_w + (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>-1)*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>;
<a name="l00422"></a>00422                     }
<a name="l00423"></a>00423                     <span class="keywordflow">else</span> idx_v= idx_w;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                     <span class="keywordflow">for</span> (uu= ui-1; uu&lt;=ui+2; uu++) {
<a name="l00426"></a>00426                         u= weight*v*tu[uu-ui+1];
<a name="l00427"></a>00427 
<a name="l00428"></a>00428                         <span class="keywordflow">if</span> (u != 0.0f) {
<a name="l00429"></a>00429                             <span class="keywordflow">if</span> (uu&gt;0) {
<a name="l00430"></a>00430                                 <span class="keywordflow">if</span> (uu&lt;lt-&gt;pntsu) idx_u= idx_v + uu;
<a name="l00431"></a>00431                                 <span class="keywordflow">else</span> idx_u= idx_v + (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>-1);
<a name="l00432"></a>00432                             }
<a name="l00433"></a>00433                             <span class="keywordflow">else</span> idx_u= idx_v;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, &amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>[idx_u * 3], u);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                             <span class="keywordflow">if</span> (defgroup_nr != -1)
<a name="l00438"></a>00438                                 weight_blend += (u * <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert + idx_u, defgroup_nr));
<a name="l00439"></a>00439                         }
<a name="l00440"></a>00440                     }
<a name="l00441"></a>00441                 }
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (defgroup_nr != -1)
<a name="l00447"></a>00447         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(co, co_prev, co, weight_blend);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00451"></a><a class="code" href="../../df/d67/lattice_8c.html#ab999172c0e71a98f8e1b7f854f48798b">00451</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00454"></a>00454     
<a name="l00455"></a>00455     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) lt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l00456"></a>00456     
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>)
<a name="l00458"></a>00458         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>);
<a name="l00459"></a>00459     lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ad25e4f579c8021b15f0210798a0b26b6">latticedata</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">/* calculations is in local space of deformed object</span>
<a name="l00463"></a>00463 <span class="comment">     * so we store in latmat transform from path coord inside object </span>
<a name="l00464"></a>00464 <span class="comment">     */</span>
<a name="l00465"></a><a class="code" href="../../d5/d99/structCurveDeform.html">00465</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00466"></a><a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">00466</a>     <span class="keywordtype">float</span> dmin[3], dmax[3];
<a name="l00467"></a><a class="code" href="../../d5/d99/structCurveDeform.html#adac89fed0da507ede88f6b06800d01ec">00467</a>     <span class="keywordtype">float</span> curvespace[4][4], objectspace[4][4], objectspace3[3][3];
<a name="l00468"></a><a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">00468</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">no_rot_axis</a>;
<a name="l00469"></a>00469 } <a class="code" href="../../d5/d99/structCurveDeform.html">CurveDeform</a>;
<a name="l00470"></a>00470 
<a name="l00471"></a><a class="code" href="../../df/d67/lattice_8c.html#aa80384754f30b564ddb2a7fafc9e3446">00471</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d67/lattice_8c.html#aa80384754f30b564ddb2a7fafc9e3446">init_curve_deform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *par, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d99/structCurveDeform.html">CurveDeform</a> *cd)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00474"></a>00474     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, par-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00475"></a>00475     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>);
<a name="l00476"></a>00476     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#adac89fed0da507ede88f6b06800d01ec">objectspace3</a>, cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>);
<a name="l00477"></a>00477     cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">no_rot_axis</a>= 0;
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">/* this makes sure we can extend for non-cyclic.</span>
<a name="l00481"></a>00481 <span class="comment"> *</span>
<a name="l00482"></a>00482 <span class="comment"> * returns OK: 1/0</span>
<a name="l00483"></a>00483 <span class="comment"> */</span>
<a name="l00484"></a><a class="code" href="../../df/d67/lattice_8c.html#a9552ba44dbf82c8f0d36a478e3d7c96d">00484</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d67/lattice_8c.html#a9552ba44dbf82c8f0d36a478e3d7c96d">where_on_path_deform</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> ctime, <span class="keywordtype">float</span> vec[4], <span class="keywordtype">float</span> dir[3], <span class="keywordtype">float</span> quat[4], <span class="keywordtype">float</span> *radius)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00487"></a>00487     <a class="code" href="../../da/d87/structBevList.html">BevList</a> *bl;
<a name="l00488"></a>00488     <span class="keywordtype">float</span> ctime1;
<a name="l00489"></a>00489     <span class="keywordtype">int</span> cycl=0;
<a name="l00490"></a>00490     
<a name="l00491"></a>00491     <span class="comment">/* test for cyclic */</span>
<a name="l00492"></a>00492     bl= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a70b76680fbc09de0e26f7eeec36be3f2">bev</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (!bl-&gt;<a class="code" href="../../da/d87/structBevList.html#adff305ce201b2987c8c9cb1eaf9bdfa8">nr</a>) <span class="keywordflow">return</span> 0;
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (bl &amp;&amp; bl-&gt;<a class="code" href="../../da/d87/structBevList.html#ab59610472c8b021334583bcf123bf1cb">poly</a>&gt; -1) cycl= 1;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (cycl==0) {
<a name="l00497"></a>00497         ctime1= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(ctime, 0.0f, 1.0f);
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <span class="keywordflow">else</span> ctime1= ctime;
<a name="l00500"></a>00500     
<a name="l00501"></a>00501     <span class="comment">/* vec needs 4 items */</span>
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (<a class="code" href="../../df/dd0/BKE__anim_8h.html#a36e926e41221928bb037b16aa04becc0">where_on_path</a>(ob, ctime1, vec, dir, quat, radius, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00503"></a>00503         
<a name="l00504"></a>00504         <span class="keywordflow">if</span> (cycl==0) {
<a name="l00505"></a>00505             <a class="code" href="../../d3/d20/structPath.html">Path</a> *path= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>;
<a name="l00506"></a>00506             <span class="keywordtype">float</span> dvec[3];
<a name="l00507"></a>00507             
<a name="l00508"></a>00508             <span class="keywordflow">if</span> (ctime &lt; 0.0f) {
<a name="l00509"></a>00509                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[1].<a class="code" href="../../d5/d8c/structPathPoint.html#ad5e34845133ceddaa52b6107095011b3">vec</a>, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[0].<a class="code" href="../../d5/d8c/structPathPoint.html#ad5e34845133ceddaa52b6107095011b3">vec</a>);
<a name="l00510"></a>00510                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvec, ctime*(<span class="keywordtype">float</span>)path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>);
<a name="l00511"></a>00511                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, dvec);
<a name="l00512"></a>00512                 <span class="keywordflow">if</span> (quat) <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(quat, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[0].<a class="code" href="../../d5/d8c/structPathPoint.html#aec77d2a0699378ba3d03a6a4aad61ad7">quat</a>);
<a name="l00513"></a>00513                 <span class="keywordflow">if</span> (radius) *radius= path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[0].<a class="code" href="../../d5/d8c/structPathPoint.html#a810b2902ac70db5fa6090b515627c560">radius</a>;
<a name="l00514"></a>00514             }
<a name="l00515"></a>00515             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ctime &gt; 1.0f) {
<a name="l00516"></a>00516                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>-1].<a class="code" href="../../d5/d8c/structPathPoint.html#ad5e34845133ceddaa52b6107095011b3">vec</a>, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>-2].<a class="code" href="../../d5/d8c/structPathPoint.html#ad5e34845133ceddaa52b6107095011b3">vec</a>);
<a name="l00517"></a>00517                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dvec, (ctime-1.0f)*(<span class="keywordtype">float</span>)path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>);
<a name="l00518"></a>00518                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, dvec);
<a name="l00519"></a>00519                 <span class="keywordflow">if</span> (quat) <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(quat, path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>-1].<a class="code" href="../../d5/d8c/structPathPoint.html#aec77d2a0699378ba3d03a6a4aad61ad7">quat</a>);
<a name="l00520"></a>00520                 <span class="keywordflow">if</span> (radius) *radius= path-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a>[path-&gt;<a class="code" href="../../d3/d20/structPath.html#a3495299d7cfe9c09f4559f3bf33d58e9">len</a>-1].<a class="code" href="../../d5/d8c/structPathPoint.html#a810b2902ac70db5fa6090b515627c560">radius</a>;
<a name="l00521"></a>00521                 <span class="comment">/* weight - not used but could be added */</span>
<a name="l00522"></a>00522             }
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524         <span class="keywordflow">return</span> 1;
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">return</span> 0;
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="comment">/* for each point, rotate &amp; translate to curve */</span>
<a name="l00530"></a>00530 <span class="comment">/* use path, since it has constant distances */</span>
<a name="l00531"></a>00531 <span class="comment">/* co: local coord, result local too */</span>
<a name="l00532"></a>00532 <span class="comment">/* returns quaternion for rotation, using cd-&gt;no_rot_axis */</span>
<a name="l00533"></a>00533 <span class="comment">/* axis is using another define!!! */</span>
<a name="l00534"></a><a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">00534</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *par, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3],
<a name="l00535"></a>00535                              <span class="keyword">const</span> <span class="keywordtype">short</span> axis, <a class="code" href="../../d5/d99/structCurveDeform.html">CurveDeform</a> *cd, <span class="keywordtype">float</span> quat_r[4])
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu= par-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00538"></a>00538     <span class="keywordtype">float</span> fac, loc[4], dir[3], new_quat[4], radius;
<a name="l00539"></a>00539     <span class="keywordtype">short</span> index;
<a name="l00540"></a>00540     <span class="keyword">const</span> <span class="keywordtype">int</span> is_neg_axis = (axis &gt; 2);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="comment">/* to be sure, mostly after file load */</span>
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00544"></a>00544         <a class="code" href="../../d9/d12/BKE__displist_8h.html#a5ca43234b8f9db71b0318b29716b5487">makeDispListCurveTypes</a>(scene, par, 0);
<a name="l00545"></a>00545         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> 0;   <span class="comment">// happens on append...</span>
<a name="l00546"></a>00546     }
<a name="l00547"></a>00547     
<a name="l00548"></a>00548     <span class="comment">/* options */</span>
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (is_neg_axis) {
<a name="l00550"></a>00550         index = axis - 3;
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a4b42e46efd35b8b37ce6225c0bf031bb">CU_STRETCH</a>)
<a name="l00552"></a>00552             fac= (-co[index]-cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[index])/(cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[index] - cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[index]);
<a name="l00553"></a>00553         <span class="keywordflow">else</span>
<a name="l00554"></a>00554             fac= - (co[index]-cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[index])/(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>-&gt;<a class="code" href="../../d3/d20/structPath.html#ac0bc2bd2f6fe492858b63a74005543af">totdist</a>);
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="keywordflow">else</span> {
<a name="l00557"></a>00557         index = axis;
<a name="l00558"></a>00558         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a4b42e46efd35b8b37ce6225c0bf031bb">CU_STRETCH</a>)
<a name="l00559"></a>00559             fac= (co[index]-cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[index])/(cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[index] - cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[index]);
<a name="l00560"></a>00560         <span class="keywordflow">else</span>
<a name="l00561"></a>00561             fac= + (co[index]-cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[index])/(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>-&gt;<a class="code" href="../../d3/d20/structPath.html#ac0bc2bd2f6fe492858b63a74005543af">totdist</a>);
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563     
<a name="l00564"></a>00564     <span class="keywordflow">if</span> ( <a class="code" href="../../df/d67/lattice_8c.html#a9552ba44dbf82c8f0d36a478e3d7c96d">where_on_path_deform</a>(par, fac, loc, dir, new_quat, &amp;radius)) { <span class="comment">/* returns OK */</span>
<a name="l00565"></a>00565         <span class="keywordtype">float</span> quat[4], cent[3];
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <span class="keywordflow">if</span> (cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">no_rot_axis</a>) {  <span class="comment">/* set by caller */</span>
<a name="l00568"></a>00568 
<a name="l00569"></a>00569             <span class="comment">/* this is not exactly the same as 2.4x, since the axis is having rotation removed rather than</span>
<a name="l00570"></a>00570 <span class="comment">             * changing the axis before calculating the tilt but serves much the same purpose */</span>
<a name="l00571"></a>00571             <span class="keywordtype">float</span> dir_flat[3]={0,0,0}, q[4];
<a name="l00572"></a>00572             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dir_flat, dir);
<a name="l00573"></a>00573             dir_flat[cd-&gt;<a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">no_rot_axis</a>-1]= 0.0f;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dir);
<a name="l00576"></a>00576             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dir_flat);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a1c43d6841215a62105c340b1418afb13">rotation_between_vecs_to_quat</a>(q, dir, dir_flat); <span class="comment">/* Could this be done faster? */</span>
<a name="l00579"></a>00579 
<a name="l00580"></a>00580             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(new_quat, q, new_quat);
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         <span class="comment">/* Logic for &#39;cent&#39; orientation *</span>
<a name="l00585"></a>00585 <span class="comment">         *</span>
<a name="l00586"></a>00586 <span class="comment">         * The way &#39;co&#39; is copied to &#39;cent&#39; may seem to have no meaning, but it does.</span>
<a name="l00587"></a>00587 <span class="comment">         *</span>
<a name="l00588"></a>00588 <span class="comment">         * Use a curve modifier to stretch a cube out, color each side RGB, positive side light, negative dark.</span>
<a name="l00589"></a>00589 <span class="comment">         * view with X up (default), from the angle that you can see 3 faces RGB colors (light), anti-clockwise</span>
<a name="l00590"></a>00590 <span class="comment">         * Notice X,Y,Z Up all have light colors and each ordered CCW.</span>
<a name="l00591"></a>00591 <span class="comment">         *</span>
<a name="l00592"></a>00592 <span class="comment">         * Now for Neg Up XYZ, the colors are all dark, and ordered clockwise - Campbell</span>
<a name="l00593"></a>00593 <span class="comment">         *</span>
<a name="l00594"></a>00594 <span class="comment">         * note: moved functions into quat_apply_track/vec_apply_track</span>
<a name="l00595"></a>00595 <span class="comment">         * */</span>
<a name="l00596"></a>00596         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(quat, new_quat);
<a name="l00597"></a>00597         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cent, co);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         <span class="comment">/* zero the axis which is not used,</span>
<a name="l00600"></a>00600 <span class="comment">         * the big block of text above now applies to these 3 lines */</span>
<a name="l00601"></a>00601         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ab4b4d60057709c6c0cae481f45d98afa">quat_apply_track</a>(quat, axis, (axis == 0 || axis == 2) ? 1:0); <span class="comment">/* up flag is a dummy, set so no rotation is done */</span>
<a name="l00602"></a>00602         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a1e059f575a2f4d5fd50527217e559f66">vec_apply_track</a>(cent, axis);
<a name="l00603"></a>00603         cent[index]= 0.0f;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         <span class="comment">/* scale if enabled */</span>
<a name="l00607"></a>00607         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a331c460f678f0c0ac8657ece2d2b89c2">CU_PATH_RADIUS</a>)
<a name="l00608"></a>00608             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cent, radius);
<a name="l00609"></a>00609         
<a name="l00610"></a>00610         <span class="comment">/* local rotation */</span>
<a name="l00611"></a>00611         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(quat);
<a name="l00612"></a>00612         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(quat, cent);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="comment">/* translation */</span>
<a name="l00615"></a>00615         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, cent, loc);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617         <span class="keywordflow">if</span> (quat_r)
<a name="l00618"></a>00618             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(quat_r, quat);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="keywordflow">return</span> 1;
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622     <span class="keywordflow">return</span> 0;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a><a class="code" href="../../df/d67/lattice_8c.html#a6b24b61f12e5e51ff3543192d89acbe4">00625</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6139e345f148e51fad3bf0dda98439f2">curve_deform_verts</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *cuOb, <a class="code" href="../../de/de7/structObject.html">Object</a> *target,
<a name="l00626"></a>00626                         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">float</span> (*vertexCos)[3],
<a name="l00627"></a>00627                         <span class="keywordtype">int</span> numVerts, <span class="keyword">const</span> <span class="keywordtype">char</span> *vgroup, <span class="keywordtype">short</span> defaxis)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu;
<a name="l00630"></a>00630     <span class="keywordtype">int</span> a, flag;
<a name="l00631"></a>00631     <a class="code" href="../../d5/d99/structCurveDeform.html">CurveDeform</a> cd;
<a name="l00632"></a>00632     <span class="keywordtype">int</span> use_vgroups;
<a name="l00633"></a>00633     <span class="keyword">const</span> <span class="keywordtype">int</span> is_neg_axis = (defaxis &gt; 2);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (cuOb-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>)
<a name="l00636"></a>00636         <span class="keywordflow">return</span>;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     cu = cuOb-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00639"></a>00639     flag = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a>;
<a name="l00640"></a>00640     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> |= (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ae59d98d3a2c7e6fddf4aa7fff72bcf88">CU_PATH</a>|<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a6e46f4b6302135168dd7630f1bfe6d2a">CU_FOLLOW</a>); <span class="comment">// needed for path &amp; bevlist</span>
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <a class="code" href="../../df/d67/lattice_8c.html#aa80384754f30b564ddb2a7fafc9e3446">init_curve_deform</a>(cuOb, target, &amp;cd);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="comment">/* dummy bounds, keep if CU_DEFORM_BOUNDS_OFF is set */</span>
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (is_neg_axis == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00646"></a>00646         cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[0]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[1]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[2]= 0.0f;
<a name="l00647"></a>00647         cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[0]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[1]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[2]= 1.0f;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649     <span class="keywordflow">else</span> {
<a name="l00650"></a>00650         <span class="comment">/* negative, these bounds give a good rest position */</span>
<a name="l00651"></a>00651         cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[0]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[1]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>[2]= -1.0f;
<a name="l00652"></a>00652         cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[0]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[1]= cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>[2]=  0.0f;
<a name="l00653"></a>00653     }
<a name="l00654"></a>00654     
<a name="l00655"></a>00655     <span class="comment">/* check whether to use vertex groups (only possible if target is a Mesh)</span>
<a name="l00656"></a>00656 <span class="comment">     * we want either a Mesh with no derived data, or derived data with</span>
<a name="l00657"></a>00657 <span class="comment">     * deformverts</span>
<a name="l00658"></a>00658 <span class="comment">     */</span>
<a name="l00659"></a>00659     <span class="keywordflow">if</span> (target &amp;&amp; target-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00660"></a>00660         <span class="comment">/* if there&#39;s derived data without deformverts, don&#39;t use vgroups */</span>
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (dm &amp;&amp; !dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, 0, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>))
<a name="l00662"></a>00662             use_vgroups = 0;
<a name="l00663"></a>00663         <span class="keywordflow">else</span>
<a name="l00664"></a>00664             use_vgroups = 1;
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     <span class="keywordflow">else</span> {
<a name="l00667"></a>00667         use_vgroups = 0;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669     
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (vgroup &amp;&amp; vgroup[0] &amp;&amp; use_vgroups) {
<a name="l00671"></a>00671         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= target-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00672"></a>00672         <span class="keywordtype">int</span> index= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a>(target, vgroup);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         <span class="keywordflow">if</span> (index != -1 &amp;&amp; (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> || dm)) {
<a name="l00675"></a>00675             <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00676"></a>00676             <span class="keywordtype">float</span> vec[3];
<a name="l00677"></a>00677             <span class="keywordtype">float</span> weight;
<a name="l00678"></a>00678     
<a name="l00679"></a>00679 
<a name="l00680"></a>00680             <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a03d9b5ed3b3d67af17d62b3b5f847e23">CU_DEFORM_BOUNDS_OFF</a>) {
<a name="l00681"></a>00681                 dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00682"></a>00682                 <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++, dvert++) {
<a name="l00683"></a>00683                     <span class="keywordflow">if</span> (dm) dvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, a, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00684"></a>00684                     weight= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, index);
<a name="l00685"></a>00685     
<a name="l00686"></a>00686                     <span class="keywordflow">if</span> (weight &gt; 0.0f) {
<a name="l00687"></a>00687                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, vertexCos[a]);
<a name="l00688"></a>00688                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, vertexCos[a]);
<a name="l00689"></a>00689                         <a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(scene, cuOb, vec, defaxis, &amp;cd, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00690"></a>00690                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(vertexCos[a], vertexCos[a], vec, weight);
<a name="l00691"></a>00691                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, vertexCos[a]);
<a name="l00692"></a>00692                     }
<a name="l00693"></a>00693                 }
<a name="l00694"></a>00694             }
<a name="l00695"></a>00695             <span class="keywordflow">else</span> {
<a name="l00696"></a>00696                 <span class="comment">/* set mesh min/max bounds */</span>
<a name="l00697"></a>00697                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>, cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>);
<a name="l00698"></a>00698     
<a name="l00699"></a>00699                 <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++, dvert++) {
<a name="l00700"></a>00700                     <span class="keywordflow">if</span> (dm) dvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, a, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00701"></a>00701                     
<a name="l00702"></a>00702                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, index) &gt; 0.0f) {
<a name="l00703"></a>00703                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, vertexCos[a]);
<a name="l00704"></a>00704                         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vertexCos[a], cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>, cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>);
<a name="l00705"></a>00705                     }
<a name="l00706"></a>00706                 }
<a name="l00707"></a>00707     
<a name="l00708"></a>00708                 dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00709"></a>00709                 <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++, dvert++) {
<a name="l00710"></a>00710                     <span class="keywordflow">if</span> (dm) dvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, a, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00711"></a>00711                     
<a name="l00712"></a>00712                     weight= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, index);
<a name="l00713"></a>00713     
<a name="l00714"></a>00714                     <span class="keywordflow">if</span> (weight &gt; 0.0f) {
<a name="l00715"></a>00715                         <span class="comment">/* already in &#39;cd.curvespace&#39;, prev for loop */</span>
<a name="l00716"></a>00716                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, vertexCos[a]);
<a name="l00717"></a>00717                         <a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(scene, cuOb, vec, defaxis, &amp;cd, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00718"></a>00718                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(vertexCos[a], vertexCos[a], vec, weight);
<a name="l00719"></a>00719                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, vertexCos[a]);
<a name="l00720"></a>00720                     }
<a name="l00721"></a>00721                 }
<a name="l00722"></a>00722             }
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725     <span class="keywordflow">else</span> {
<a name="l00726"></a>00726         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a03d9b5ed3b3d67af17d62b3b5f847e23">CU_DEFORM_BOUNDS_OFF</a>) {
<a name="l00727"></a>00727             <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++) {
<a name="l00728"></a>00728                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, vertexCos[a]);
<a name="l00729"></a>00729                 <a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(scene, cuOb, vertexCos[a], defaxis, &amp;cd, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00730"></a>00730                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, vertexCos[a]);
<a name="l00731"></a>00731             }
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733         <span class="keywordflow">else</span> {
<a name="l00734"></a>00734             <span class="comment">/* set mesh min max bounds */</span>
<a name="l00735"></a>00735             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>, cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>);
<a name="l00736"></a>00736                 
<a name="l00737"></a>00737             <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++) {
<a name="l00738"></a>00738                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, vertexCos[a]);
<a name="l00739"></a>00739                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vertexCos[a], cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>, cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>);
<a name="l00740"></a>00740             }
<a name="l00741"></a>00741     
<a name="l00742"></a>00742             <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++) {
<a name="l00743"></a>00743                 <span class="comment">/* already in &#39;cd.curvespace&#39;, prev for loop */</span>
<a name="l00744"></a>00744                 <a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(scene, cuOb, vertexCos[a], defaxis, &amp;cd, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00745"></a>00745                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, vertexCos[a]);
<a name="l00746"></a>00746             }
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> = flag;
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="comment">/* input vec and orco = local coord in armature space */</span>
<a name="l00753"></a>00753 <span class="comment">/* orco is original not-animated or deformed reference point */</span>
<a name="l00754"></a>00754 <span class="comment">/* result written in vec and mat */</span>
<a name="l00755"></a><a class="code" href="../../df/d67/lattice_8c.html#abbf001f65bd0268f32be7e95d925a97a">00755</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a80f8584d280abb72b6323997fe03f745">curve_deform_vector</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *cuOb, <a class="code" href="../../de/de7/structObject.html">Object</a> *target,
<a name="l00756"></a>00756                          <span class="keywordtype">float</span> orco[3], <span class="keywordtype">float</span> vec[3], <span class="keywordtype">float</span> mat[][3], <span class="keywordtype">int</span> no_rot_axis)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     <a class="code" href="../../d5/d99/structCurveDeform.html">CurveDeform</a> cd;
<a name="l00759"></a>00759     <span class="keywordtype">float</span> quat[4];
<a name="l00760"></a>00760     
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (cuOb-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>) {
<a name="l00762"></a>00762         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(mat);
<a name="l00763"></a>00763         <span class="keywordflow">return</span>;
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <a class="code" href="../../df/d67/lattice_8c.html#aa80384754f30b564ddb2a7fafc9e3446">init_curve_deform</a>(cuOb, target, &amp;cd);
<a name="l00767"></a>00767     cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a10ac5a8dfdbb5e2d8066c0e38efe26d1">no_rot_axis</a>= no_rot_axis;                <span class="comment">/* option to only rotate for XY, for example */</span>
<a name="l00768"></a>00768     
<a name="l00769"></a>00769     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a235344b7f99973108c5874a10035cd51">dmin</a>, orco);
<a name="l00770"></a>00770     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a38c4fb83f515a7e5109df104c9a5f731">dmax</a>, orco);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#acce5bc3dba0c241f0fd70d605447b0f1">curvespace</a>, vec);
<a name="l00773"></a>00773     
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (<a class="code" href="../../df/d67/lattice_8c.html#ad6478cbc41ed88b5eed06eed860aafe8">calc_curve_deform</a>(scene, cuOb, vec, target-&gt;<a class="code" href="../../de/de7/structObject.html#ad114fce525aa2f570e9b84abdd4076c2">trackflag</a>, &amp;cd, quat)) {
<a name="l00775"></a>00775         <span class="keywordtype">float</span> qmat[3][3];
<a name="l00776"></a>00776         
<a name="l00777"></a>00777         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ae0343d0ff2af81f054d3916277409507">quat_to_mat3</a>( qmat,quat);
<a name="l00778"></a>00778         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(mat, qmat, cd.<a class="code" href="../../d5/d99/structCurveDeform.html#adac89fed0da507ede88f6b06800d01ec">objectspace3</a>);
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780     <span class="keywordflow">else</span>
<a name="l00781"></a>00781         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(mat);
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cd.<a class="code" href="../../d5/d99/structCurveDeform.html#a21bbc375b9e04732c9a0e4e75b10d4f0">objectspace</a>, vec);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a><a class="code" href="../../df/d67/lattice_8c.html#a0ba72e622bf117e32c520a76f10c691b">00787</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a923f29b4941146247f6ca8489b57f316">lattice_deform_verts</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *laOb, <a class="code" href="../../de/de7/structObject.html">Object</a> *target, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l00788"></a>00788                           <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts, <span class="keyword">const</span> <span class="keywordtype">char</span> *vgroup, <span class="keywordtype">float</span> fac)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790     <span class="keywordtype">int</span> a;
<a name="l00791"></a>00791     <span class="keywordtype">int</span> use_vgroups;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (laOb-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)
<a name="l00794"></a>00794         <span class="keywordflow">return</span>;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a7fa9f353e4dd340039a3a500c1397622">init_latt_deform</a>(laOb, target);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="comment">/* check whether to use vertex groups (only possible if target is a Mesh)</span>
<a name="l00799"></a>00799 <span class="comment">     * we want either a Mesh with no derived data, or derived data with</span>
<a name="l00800"></a>00800 <span class="comment">     * deformverts</span>
<a name="l00801"></a>00801 <span class="comment">     */</span>
<a name="l00802"></a>00802     <span class="keywordflow">if</span> (target &amp;&amp; target-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00803"></a>00803         <span class="comment">/* if there&#39;s derived data without deformverts, don&#39;t use vgroups */</span>
<a name="l00804"></a>00804         <span class="keywordflow">if</span> (dm &amp;&amp; !dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, 0, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>))
<a name="l00805"></a>00805             use_vgroups = 0;
<a name="l00806"></a>00806         <span class="keywordflow">else</span>
<a name="l00807"></a>00807             use_vgroups = 1;
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809     <span class="keywordflow">else</span> {
<a name="l00810"></a>00810         use_vgroups = 0;
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812     
<a name="l00813"></a>00813     <span class="keywordflow">if</span> (vgroup &amp;&amp; vgroup[0] &amp;&amp; use_vgroups) {
<a name="l00814"></a>00814         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = target-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00815"></a>00815         <span class="keywordtype">int</span> index = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a>(target, vgroup);
<a name="l00816"></a>00816         <span class="keywordtype">float</span> weight;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> || dm)) {
<a name="l00819"></a>00819             <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00820"></a>00820             
<a name="l00821"></a>00821             <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++, dvert++) {
<a name="l00822"></a>00822                 <span class="keywordflow">if</span> (dm) dvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, a, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824                 weight= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, index);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826                 <span class="keywordflow">if</span> (weight &gt; 0.0f)
<a name="l00827"></a>00827                     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a8435b8f6a07c626be80af92647c0b0ef">calc_latt_deform</a>(laOb, vertexCos[a], weight * fac);
<a name="l00828"></a>00828             }
<a name="l00829"></a>00829         }
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831     <span class="keywordflow">else</span> {
<a name="l00832"></a>00832         <span class="keywordflow">for</span> (a = 0; a &lt; numVerts; a++) {
<a name="l00833"></a>00833             <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a8435b8f6a07c626be80af92647c0b0ef">calc_latt_deform</a>(laOb, vertexCos[a], fac);
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836     <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(laOb);
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a><a class="code" href="../../df/d67/lattice_8c.html#ae3ea11859be944f14fab58119e30872c">00839</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#ab26932571b2f800c12243ef77e04a65f">object_deform_mball</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *dispbase)
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0ed2df4a386ce2b22084aaaa701d73ff">partype</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#af88b95b0ce3123f10e88d858cbb50f05">PARSKEL</a>) {
<a name="l00842"></a>00842         <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844         <span class="keywordflow">for</span> (dl=dispbase-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dl; dl=dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a902acb76b3f3a2b20b0c9f755c652bf9">next</a>) {
<a name="l00845"></a>00845             <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a923f29b4941146247f6ca8489b57f316">lattice_deform_verts</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00846"></a>00846                                  (<span class="keywordtype">float</span>(*)[3]) dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>, dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1.0f);
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         <span class="keywordflow">return</span> 1;
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851     <span class="keywordflow">else</span> {
<a name="l00852"></a>00852         <span class="keywordflow">return</span> 0;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a><a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">00856</a> <span class="keyword">static</span> <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *<a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt, <span class="keywordtype">int</span> u, <span class="keywordtype">int</span> v, <span class="keywordtype">int</span> w)
<a name="l00857"></a>00857 {
<a name="l00858"></a>00858     <span class="keywordflow">return</span> &amp;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>[<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html#a075afe22f2b5801ac0856846febf03d6">LT_INDEX</a>(lt, u, v, w)];
<a name="l00859"></a>00859 }
<a name="l00860"></a>00860 
<a name="l00861"></a><a class="code" href="../../df/d67/lattice_8c.html#a0e8db183324dc8e32859e18a5c8119c5">00861</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af8fa82e4d9685bebc121ed33dad3d8c1">outside_lattice</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp, *bp1, *bp2;
<a name="l00864"></a>00864     <span class="keywordtype">int</span> u, v, w;
<a name="l00865"></a>00865     <span class="keywordtype">float</span> fac1, du=0.0, dv=0.0, dw=0.0;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a> &amp; <a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html#a88fd8efda477754bb80253fa2c1dbcfa">LT_OUTSIDE</a>) {
<a name="l00868"></a>00868         bp= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>&gt;1) du= 1.0f/((float)lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>-1);
<a name="l00871"></a>00871         <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>&gt;1) dv= 1.0f/((float)lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>-1);
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>&gt;1) dw= 1.0f/((float)lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1);
<a name="l00873"></a>00873             
<a name="l00874"></a>00874         <span class="keywordflow">for</span> (w=0; w&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>; w++) {
<a name="l00875"></a>00875             
<a name="l00876"></a>00876             <span class="keywordflow">for</span> (v=0; v&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>; v++) {
<a name="l00877"></a>00877             
<a name="l00878"></a>00878                 <span class="keywordflow">for</span> (u=0; u&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>; u++, bp++) {
<a name="l00879"></a>00879                     <span class="keywordflow">if</span> (u==0 || v==0 || w==0 || u==lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>-1 || v==lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>-1 || w==lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1);
<a name="l00880"></a>00880                     <span class="keywordflow">else</span> {
<a name="l00881"></a>00881                     
<a name="l00882"></a>00882                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a0ddb96e887d692d112fb415e00666318">hide</a>= 1;
<a name="l00883"></a>00883                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#aafe158be7befa08cebb7440997204cff">f1</a> &amp;= ~<a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l00884"></a>00884                         
<a name="l00885"></a>00885                         <span class="comment">/* u extrema */</span>
<a name="l00886"></a>00886                         bp1= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, 0, v, w);
<a name="l00887"></a>00887                         bp2= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>-1, v, w);
<a name="l00888"></a>00888                         
<a name="l00889"></a>00889                         fac1= du*u;
<a name="l00890"></a>00890                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0]= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0];
<a name="l00891"></a>00891                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1]= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1];
<a name="l00892"></a>00892                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2]= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2];
<a name="l00893"></a>00893                         
<a name="l00894"></a>00894                         <span class="comment">/* v extrema */</span>
<a name="l00895"></a>00895                         bp1= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, u, 0, w);
<a name="l00896"></a>00896                         bp2= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, u, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>-1, w);
<a name="l00897"></a>00897                         
<a name="l00898"></a>00898                         fac1= dv*v;
<a name="l00899"></a>00899                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0];
<a name="l00900"></a>00900                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1];
<a name="l00901"></a>00901                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2];
<a name="l00902"></a>00902                         
<a name="l00903"></a>00903                         <span class="comment">/* w extrema */</span>
<a name="l00904"></a>00904                         bp1= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, u, v, 0);
<a name="l00905"></a>00905                         bp2= <a class="code" href="../../df/d67/lattice_8c.html#a18f87f0aa460de54894b3531acf0eb8c">latt_bp</a>(lt, u, v, lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>-1);
<a name="l00906"></a>00906                         
<a name="l00907"></a>00907                         fac1= dw*w;
<a name="l00908"></a>00908                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0];
<a name="l00909"></a>00909                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1];
<a name="l00910"></a>00910                         bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2]+= (1.0f-fac1)*bp1-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] + fac1*bp2-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2];
<a name="l00911"></a>00911                         
<a name="l00912"></a>00912                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>, 0.3333333f);
<a name="l00913"></a>00913                         
<a name="l00914"></a>00914                     }
<a name="l00915"></a>00915                 }
<a name="l00916"></a>00916                 
<a name="l00917"></a>00917             }
<a name="l00918"></a>00918             
<a name="l00919"></a>00919         }
<a name="l00920"></a>00920     }
<a name="l00921"></a>00921     <span class="keywordflow">else</span> {
<a name="l00922"></a>00922         bp= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924         <span class="keywordflow">for</span> (w=0; w&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>; w++)
<a name="l00925"></a>00925             <span class="keywordflow">for</span> (v=0; v&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>; v++)
<a name="l00926"></a>00926                 <span class="keywordflow">for</span> (u=0; u&lt;lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>; u++, bp++)
<a name="l00927"></a>00927                     bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a0ddb96e887d692d112fb415e00666318">hide</a>= 0;
<a name="l00928"></a>00928     }
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a><a class="code" href="../../df/d67/lattice_8c.html#a826b40d6802e8a5a7b0d2b9b651a5882">00931</a> float (*<a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a826b40d6802e8a5a7b0d2b9b651a5882">lattice_getVertexCos</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> *numVerts_r))[3]
<a name="l00932"></a>00932 {
<a name="l00933"></a>00933     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;data;
<a name="l00934"></a>00934     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, numVerts;
<a name="l00935"></a>00935     float (*vertexCos)[3];
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) lt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l00938"></a>00938     numVerts = *numVerts_r = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l00939"></a>00939     
<a name="l00940"></a>00940     vertexCos = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(*vertexCos)*numVerts,<span class="stringliteral">&quot;lt_vcos&quot;</span>);
<a name="l00941"></a>00941     
<a name="l00942"></a>00942     <span class="keywordflow">for</span> (i=0; i&lt;numVerts; i++) {
<a name="l00943"></a>00943         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[i], lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>[i].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>);
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     <span class="keywordflow">return</span> vertexCos;
<a name="l00947"></a>00947 }
<a name="l00948"></a>00948 
<a name="l00949"></a><a class="code" href="../../df/d67/lattice_8c.html#a6f86a39867d96833b24aa0c89e32c530">00949</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a6f86a39867d96833b24aa0c89e32c530">lattice_applyVertexCos</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertexCos)[3])
<a name="l00950"></a>00950 {
<a name="l00951"></a>00951     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00952"></a>00952     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, numVerts = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="keywordflow">for</span> (i=0; i&lt;numVerts; i++) {
<a name="l00955"></a>00955         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>[i].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>, vertexCos[i]);
<a name="l00956"></a>00956     }
<a name="l00957"></a>00957 }
<a name="l00958"></a>00958 
<a name="l00959"></a><a class="code" href="../../df/d67/lattice_8c.html#a97e6ac98820015c1c7d1a6b922d7e271">00959</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#ac818dd36b732a8976182c4c12e6f575b">lattice_calc_modifiers</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00962"></a>00962     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a136f15cde944e4b0c5d938d946d975c9">modifiers_getVirtualModifierList</a>(ob);
<a name="l00963"></a>00963     float (*vertexCos)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00964"></a>00964     <span class="keywordtype">int</span> numVerts, editmode = (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a45d11e4826c3a8ba292c91691bb2885d">disp</a>);
<a name="l00967"></a>00967 
<a name="l00968"></a>00968     <span class="keywordflow">for</span> (; md; md=md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l00969"></a>00969         <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>= scene;
<a name="l00972"></a>00972         
<a name="l00973"></a>00973         <span class="keywordflow">if</span> (!(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a905ab5cd625053441b2e82efe47e95d1">mode</a>&amp;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>)) <span class="keywordflow">continue</span>;
<a name="l00974"></a>00974         <span class="keywordflow">if</span> (editmode &amp;&amp; !(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a905ab5cd625053441b2e82efe47e95d1">mode</a>&amp;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a9efe97c797f991a7bbbe3cfa81d08857">eModifierMode_Editmode</a>)) <span class="keywordflow">continue</span>;
<a name="l00975"></a>00975         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#ae365ec70b13b21228b7d53c132a1a9c1">isDisabled</a> &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#ae365ec70b13b21228b7d53c132a1a9c1">isDisabled</a>(md, 0)) <span class="keywordflow">continue</span>;
<a name="l00976"></a>00976         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a>!=<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>) <span class="keywordflow">continue</span>;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         <span class="keywordflow">if</span> (!vertexCos) vertexCos = <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a826b40d6802e8a5a7b0d2b9b651a5882">lattice_getVertexCos</a>(ob, &amp;numVerts);
<a name="l00979"></a>00979         mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vertexCos, numVerts, 0, 0);
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     <span class="comment">/* always displist to make this work like derivedmesh */</span>
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (!vertexCos) vertexCos = <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a826b40d6802e8a5a7b0d2b9b651a5882">lattice_getVertexCos</a>(ob, &amp;numVerts);
<a name="l00984"></a>00984     
<a name="l00985"></a>00985     {
<a name="l00986"></a>00986         <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*dl), <span class="stringliteral">&quot;lt_dl&quot;</span>);
<a name="l00987"></a>00987         dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a14a8a66c424ba6ecb972e49847b61483">type</a> = <a class="code" href="../../d9/d12/BKE__displist_8h.html#a91ca502ecb1aec32fd6e83349c74a085">DL_VERTS</a>;
<a name="l00988"></a>00988         dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a> = 1;
<a name="l00989"></a>00989         dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a> = numVerts;
<a name="l00990"></a>00990         dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a> = (<span class="keywordtype">float</span>*) vertexCos;
<a name="l00991"></a>00991         
<a name="l00992"></a>00992         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a45d11e4826c3a8ba292c91691bb2885d">disp</a>, dl);
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a><a class="code" href="../../df/d67/lattice_8c.html#a66ed34435b217d679cd6054eea507d1f">00996</a> <span class="keyword">struct </span><a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a>* <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#afa7e5d8e40cbe78518abe822b900249d">lattice_get_deform_verts</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *oblatt)
<a name="l00997"></a>00997 {
<a name="l00998"></a>00998     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = (<a class="code" href="../../dd/d40/structLattice.html">Lattice</a>*)oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00999"></a>00999     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(oblatt-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>);
<a name="l01000"></a>01000     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>) lt= lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a8b26fb4a2936b8ed7929cbffb12ac057">editlatt</a>-&gt;<a class="code" href="../../d5/d06/structEditLatt.html#ad6edc9c8b5a87d60189878e812587a9f">latt</a>;
<a name="l01001"></a>01001     <span class="keywordflow">return</span> lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>;
<a name="l01002"></a>01002 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:29 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
