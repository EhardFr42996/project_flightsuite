<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: solver_adap.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">solver_adap.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../df/dbf/solver__adap_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * El&#39;Beem - Free Surface Fluid Simulation with the Lattice Boltzmann Method</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright 2003-2006 Nils Thuerey</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Adaptivity functions</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *****************************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d24/solver__class_8h.html">solver_class.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d75/solver__relax_8h.html">solver_relax.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d69/particletracer_8h.html">particletracer.h</a>&quot;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">/*****************************************************************************/</span>
<a name="l00021"></a>00021 <span class="comment">/*****************************************************************************/</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a011f87da2814c6edcd0af14c33337650">00025</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a011f87da2814c6edcd0af14c33337650" title="update flux area values on coarse grids">LbmFsgrSolver::coarseCalculateFluxareas</a>(<span class="keywordtype">int</span> lev)
<a name="l00026"></a>00026 {
<a name="l00027"></a>00027     <a class="code" href="../../d1/d24/solver__class_8h.html#a809f84de6a5afc68c78eedc2bd37e498">FSGR_FORIJK_BOUNDS</a>(lev) {
<a name="l00028"></a>00028         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>) {
<a name="l00029"></a>00029             <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*2,j*2,k*2,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].setCurr) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) {
<a name="l00030"></a>00030                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> totArea = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af4d5e1dd40dc1ca7ca25cf3903f1aee8">mFsgrCellArea</a>[0]; <span class="comment">// for l=0</span>
<a name="l00031"></a>00031                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00032"></a>00032                     <span class="keywordtype">int</span> ni=(2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=(2*j)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=(2*k)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00033"></a>00033                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, ni,nj,nk, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].setCurr)&amp;
<a name="l00034"></a>00034                             (CFGrFromCoarse|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>) <span class="comment">//? (CFBnd|CFEmpty|CFGrFromCoarse|CFUnused)</span>
<a name="l00035"></a>00035                             ) { 
<a name="l00036"></a>00036                         totArea += <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af4d5e1dd40dc1ca7ca25cf3903f1aee8">mFsgrCellArea</a>[l];
<a name="l00037"></a>00037                     }
<a name="l00038"></a>00038                 } <span class="comment">// l</span>
<a name="l00039"></a>00039                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = totArea;
<a name="l00040"></a>00040                 <span class="comment">//continue;</span>
<a name="l00041"></a>00041             } <span class="keywordflow">else</span>
<a name="l00042"></a>00042             <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*2,j*2,k*2,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].setCurr) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>)) {
<a name="l00043"></a>00043                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = 1.0;
<a name="l00044"></a>00044                 <span class="comment">//continue;</span>
<a name="l00045"></a>00045             } <span class="keywordflow">else</span> {
<a name="l00046"></a>00046                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = 0.0;
<a name="l00047"></a>00047             }
<a name="l00048"></a>00048         <span class="comment">//errMsg(&quot;DFINI&quot;,&quot; at l&quot;&lt;&lt;lev&lt;&lt;&quot; &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; v:&quot;&lt;&lt;QCELL(lev, i,j,k,mLevel[lev].setCurr, dFlux) ); </span>
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050     } <span class="comment">// } TEST DEBUG</span>
<a name="l00051"></a>00051     <span class="keywordflow">if</span>(!this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;coarseCalculateFluxareas&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;level &quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; calculated&quot;</span>, 7); }
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053     
<a name="l00054"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac31e6ed4d719af9ba132a97331159ffe">00054</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac31e6ed4d719af9ba132a97331159ffe" title="advance coarse grid">LbmFsgrSolver::coarseAdvance</a>(<span class="keywordtype">int</span> lev)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> calcCurrentMass = 0.0;
<a name="l00057"></a>00057     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> calcCurrentVolume = 0.0;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *ccel = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00060"></a>00060     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *tcel = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00061"></a>00061     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00062"></a>00062     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho, ux, uy, uz, tmp, usqr, lcsmqo;
<a name="l00063"></a>00063 <span class="preprocessor">#if OPT3D==1 </span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>    <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqadd, lcsmeq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>], lcsmomega;
<a name="l00065"></a>00065 <span class="preprocessor">#endif // OPT3D==true </span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>    m[0] = tmp = usqr = 0.0;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a011f87da2814c6edcd0af14c33337650" title="update flux area values on coarse grids">coarseCalculateFluxareas</a>(lev);
<a name="l00069"></a>00069     <span class="comment">// copied from fineAdv.</span>
<a name="l00070"></a>00070     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *pFlagSrc = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, 1,1,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(),<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev));
<a name="l00071"></a>00071     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *pFlagDst = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, 1,1,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(),<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev));
<a name="l00072"></a>00072     pFlagSrc -= 1;
<a name="l00073"></a>00073     pFlagDst -= 1;
<a name="l00074"></a>00074     ccel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev, 1,1,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>() ,<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev)); <span class="comment">// QTEST</span>
<a name="l00075"></a>00075     ccel -= <a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>;
<a name="l00076"></a>00076     tcel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev, 1,1,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>() ,<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev)); <span class="comment">// QTEST</span>
<a name="l00077"></a>00077     tcel -= <a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>;
<a name="l00078"></a>00078     <span class="comment">//if(strstr(this-&gt;getName().c_str(),&quot;Debug&quot;)){ errMsg(&quot;DEBUG&quot;,&quot;DEBUG!!!!!!!!!!!!!!!!!!!!!!!&quot;); }</span>
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00081"></a>00081   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00082"></a>00082   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00083"></a>00083 <span class="preprocessor">#if FSGR_STRICT_DEBUG==1</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>        rho = ux = uy = uz = tmp = usqr = -100.0; <span class="comment">// DEBUG</span>
<a name="l00085"></a>00085 <span class="preprocessor">#endif</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>        pFlagSrc++;
<a name="l00087"></a>00087         pFlagDst++;
<a name="l00088"></a>00088         ccel += <a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>;
<a name="l00089"></a>00089         tcel += <a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="comment">// from coarse cells without unused nbs are not necessary...! -&gt; remove</span>
<a name="l00092"></a>00092         <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) ) { 
<a name="l00093"></a>00093             <span class="keywordtype">bool</span> invNb = <span class="keyword">false</span>;
<a name="l00094"></a>00094             <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev), l) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) { invNb = <span class="keyword">true</span>; } }   
<a name="l00095"></a>00095             <span class="keywordflow">if</span>(!invNb) {
<a name="l00096"></a>00096                 <span class="comment">// WARNING - this modifies source flag array...</span>
<a name="l00097"></a>00097                 *pFlagSrc = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00098"></a>00098 <span class="preprocessor">#if ELBEEM_PLUGIN!=1</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>                <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;coarseAdvance&quot;</span>,<span class="stringliteral">&quot;FC2NRM_CHECK Converted CFGrFromCoarse to Norm at &quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>);
<a name="l00100"></a>00100 <span class="preprocessor">#endif // ELBEEM_PLUGIN!=1</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>                <span class="comment">// move to perform coarsening?</span>
<a name="l00102"></a>00102             }
<a name="l00103"></a>00103         } <span class="comment">// */</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="preprocessor">#if FSGR_STRICT_DEBUG==1</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>        *pFlagDst = *pFlagSrc; <span class="comment">// always set other set...</span>
<a name="l00107"></a>00107 <span class="preprocessor">#else</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>        *pFlagDst = (*pFlagSrc &amp; (~<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6d2cab3b7a34e2e22f4a7e39859a3a37">CFGrCoarseInited</a>)); <span class="comment">// always set other set... , remove coarse inited flag</span>
<a name="l00109"></a>00109 <span class="preprocessor">#endif</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>
<a name="l00111"></a>00111         <span class="comment">// old INTCFCOARSETEST==1</span>
<a name="l00112"></a>00112         <span class="keywordflow">if</span>((*pFlagSrc) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) {  <span class="comment">// interpolateFineFromCoarse test!</span>
<a name="l00113"></a>00113             <span class="keywordflow">if</span>(( this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a> &amp; (1&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>-lev)) ) ==1) {
<a name="l00114"></a>00114                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }
<a name="l00115"></a>00115             } <span class="keywordflow">else</span> {
<a name="l00116"></a>00116                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>( lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), 0.0, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>, <span class="keyword">false</span>);
<a name="l00117"></a>00117                 this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>++;
<a name="l00118"></a>00118             }
<a name="l00119"></a>00119             <span class="keywordflow">continue</span>; <span class="comment">// interpolateFineFromCoarse test!</span>
<a name="l00120"></a>00120         } <span class="comment">// interpolateFineFromCoarse test! old INTCFCOARSETEST==1</span>
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>)) ) { 
<a name="l00123"></a>00123             ccel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k ,<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev)); 
<a name="l00124"></a>00124             tcel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k ,<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev));
<a name="l00125"></a>00125 
<a name="l00126"></a>00126             <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>)) ) { 
<a name="l00127"></a>00127                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }    <span class="comment">// always copy...?</span>
<a name="l00128"></a>00128                 <span class="keywordflow">continue</span>; <span class="comment">// comes from fine grid</span>
<a name="l00129"></a>00129             }
<a name="l00130"></a>00130             <span class="comment">// also ignore CFGrFromCoarse</span>
<a name="l00131"></a>00131             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) ) { 
<a name="l00132"></a>00132                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }    <span class="comment">// always copy...?</span>
<a name="l00133"></a>00133                 <span class="keywordflow">continue</span>; 
<a name="l00134"></a>00134             }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136             <a class="code" href="../../d2/d75/solver__relax_8h.html#aca0e7264a23365d760325084f5f20962">OPTIMIZED_STREAMCOLLIDE</a>;
<a name="l00137"></a>00137             *pFlagDst |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>; <span class="comment">// test?</span>
<a name="l00138"></a>00138             calcCurrentVolume += <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>); 
<a name="l00139"></a>00139             calcCurrentMass   += <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>)*rho;
<a name="l00140"></a>00140             <span class="comment">//ebugMarkCell(lev+1, 2*i+1,2*j+1,2*k  );</span>
<a name="l00141"></a>00141 <span class="preprocessor">#if FSGR_STRICT_DEBUG==1</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(rho&lt;-1.0){ <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k ); 
<a name="l00143"></a>00143                 <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;INVRHOCELL_CHECK&quot;</span>,<span class="stringliteral">&quot; l&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt; <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; rho:&quot;</span>&lt;&lt;rho ); 
<a name="l00144"></a>00144                 <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>;
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146 <span class="preprocessor">#endif // FSGR_STRICT_DEBUG==1</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>            this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>++;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150     } 
<a name="l00151"></a>00151     pFlagSrc+=2; <span class="comment">// after x</span>
<a name="l00152"></a>00152     pFlagDst+=2; <span class="comment">// after x</span>
<a name="l00153"></a>00153     ccel += (<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>*2);
<a name="l00154"></a>00154     tcel += (<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>*2);
<a name="l00155"></a>00155     } 
<a name="l00156"></a>00156     pFlagSrc+= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>*2; <span class="comment">// after y</span>
<a name="l00157"></a>00157     pFlagDst+= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>*2; <span class="comment">// after y</span>
<a name="l00158"></a>00158     ccel += (<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>*<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>*2);
<a name="l00159"></a>00159     tcel += (<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>*<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>*2);
<a name="l00160"></a>00160     } <span class="comment">// all cell loop k,j,i</span>
<a name="l00161"></a>00161     
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="comment">//errMsg(&quot;coarseAdvance&quot;,&quot;level &quot;&lt;&lt;lev&lt;&lt;&quot; stepped from &quot;&lt;&lt;mLevel[lev].setCurr&lt;&lt;&quot; to &quot;&lt;&lt;mLevel[lev].setOther);</span>
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(!this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;coarseAdvance&quot;</span>,<span class="stringliteral">&quot;level &quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; stepped from &quot;</span>&lt;&lt;<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev)&lt;&lt;<span class="stringliteral">&quot; to &quot;</span>&lt;&lt;<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev)); }
<a name="l00165"></a>00165     <span class="comment">// */</span>
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="comment">// update other set</span>
<a name="l00168"></a>00168   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a969dc4eebe3ff743980e099cad72240a" title="target/other set of dist funcs">setOther</a>   = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00169"></a>00169   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>   ^= 1;
<a name="l00170"></a>00170   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a71ed2e9133bd4102bf1d3be8e29b97a0" title="step count">lsteps</a>++;
<a name="l00171"></a>00171   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2fd0a63e02aeb6ca2b93e19040fbd07f" title="mass&amp;volume for this level">lmass</a>   = calcCurrentMass   * <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a81435c55b002d65b7e0ca201a1fef155">lcellfactor</a>;
<a name="l00172"></a>00172   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ad24148aecd9abb90cd0100eabb440703">lvolume</a> = calcCurrentVolume * <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a81435c55b002d65b7e0ca201a1fef155">lcellfactor</a>;
<a name="l00173"></a>00173 <span class="preprocessor">#if ELBEEM_PLUGIN!=1</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>  <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::coarseAdvance&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>, <span class="stringliteral">&quot;mass: lev=&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; m=&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lmass&lt;&lt;<span class="stringliteral">&quot; c=&quot;</span>&lt;&lt;calcCurrentMass&lt;&lt;<span class="stringliteral">&quot;  lcf=&quot;</span>&lt;&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lcellfactor, 8 );
<a name="l00175"></a>00175   <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::coarseAdvance&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>, <span class="stringliteral">&quot;volume: lev=&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; v=&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lvolume&lt;&lt;<span class="stringliteral">&quot; c=&quot;</span>&lt;&lt;calcCurrentVolume&lt;&lt;<span class="stringliteral">&quot;  lcf=&quot;</span>&lt;&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lcellfactor, 8 );
<a name="l00176"></a>00176 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>}
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">/*****************************************************************************/</span>
<a name="l00181"></a>00181 <span class="comment">/*****************************************************************************/</span>
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="comment">// get dfs from level (lev+1) to (lev) coarse border nodes</span>
<a name="l00185"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97c57a11db77306909c68df328272ca6">00185</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97c57a11db77306909c68df328272ca6" title="multi level functions">LbmFsgrSolver::coarseRestrictFromFine</a>(<span class="keywordtype">int</span> lev)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     <span class="keywordflow">if</span>((lev&lt;0) || ((lev+1)&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>)) <span class="keywordflow">return</span>;
<a name="l00188"></a>00188 <span class="preprocessor">#if FSGR_STRICT_DEBUG==1</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>    <span class="comment">// reset all unused cell values to invalid</span>
<a name="l00190"></a>00190     <span class="keywordtype">int</span> unuCnt = 0;
<a name="l00191"></a>00191     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00192"></a>00192     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00193"></a>00193     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00194"></a>00194         <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *pFlagSrc = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr);
<a name="l00195"></a>00195         <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>)) == (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) ) { 
<a name="l00196"></a>00196             <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr, l) = -10000.0;    }
<a name="l00197"></a>00197             unuCnt++;
<a name="l00198"></a>00198             <span class="comment">// set here</span>
<a name="l00199"></a>00199         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>)) == (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>) ) { 
<a name="l00200"></a>00200             <span class="comment">// simulated...</span>
<a name="l00201"></a>00201         } <span class="keywordflow">else</span> {
<a name="l00202"></a>00202             <span class="comment">// reset in interpolation</span>
<a name="l00203"></a>00203             <span class="comment">//errMsg(&quot;coarseRestrictFromFine&quot;,&quot; reset l&quot;&lt;&lt;lev&lt;&lt;&quot; &quot;&lt;&lt;PRINT_IJK);</span>
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205         <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>)) ) {  <span class="comment">// test, also reset?</span>
<a name="l00206"></a>00206             <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr, l) = -10000.0;    }
<a name="l00207"></a>00207         } <span class="comment">// test</span>
<a name="l00208"></a>00208     } } }
<a name="l00209"></a>00209     <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;coarseRestrictFromFine&quot;</span>,<span class="stringliteral">&quot; reset l&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; fluid|coarseBorder cells: &quot;</span>&lt;&lt;unuCnt);
<a name="l00210"></a>00210 <span class="preprocessor">#endif // FSGR_STRICT_DEBUG==1</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">int</span> srcSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00212"></a>00212     <span class="keyword">const</span> <span class="keywordtype">int</span> dstSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="comment">//restrict</span>
<a name="l00215"></a>00215     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00216"></a>00216     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00217"></a>00217     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00218"></a>00218         <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *pFlagSrc = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,dstSet);
<a name="l00219"></a>00219         <span class="keywordflow">if</span>((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>)) { 
<a name="l00220"></a>00220             <span class="keywordflow">if</span>( ((*pFlagSrc) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>)) == (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) ) { 
<a name="l00221"></a>00221                 <span class="comment">// do resctriction</span>
<a name="l00222"></a>00222                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a892c4c850e08c8b2c3cdefe271941c75" title="fluid stats">mNumInterdCells</a>++;
<a name="l00223"></a>00223                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aebf6979d9c02f7da128219f667c4da28" title="cell restriction and prolongation">coarseRestrictCell</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,srcSet,dstSet);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225                 this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>++;
<a name="l00226"></a>00226             } <span class="comment">// from fine &amp; fluid</span>
<a name="l00227"></a>00227             <span class="keywordflow">else</span> {
<a name="l00228"></a>00228                 <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, 2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,2*j,2*k,srcSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) {
<a name="l00229"></a>00229                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,dstSet) |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>;
<a name="l00230"></a>00230                 } <span class="keywordflow">else</span> {
<a name="l00231"></a>00231                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,dstSet) &amp;= (~<a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>);
<a name="l00232"></a>00232                 }
<a name="l00233"></a>00233             }
<a name="l00234"></a>00234         } <span class="comment">// &amp; fluid</span>
<a name="l00235"></a>00235     }}}
<a name="l00236"></a>00236     <span class="keywordflow">if</span>(!this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;coarseRestrictFromFine&quot;</span>,<span class="stringliteral">&quot; from l&quot;</span>&lt;&lt;(lev+1)&lt;&lt;<span class="stringliteral">&quot;,s&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].setCurr&lt;&lt;<span class="stringliteral">&quot; to l&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot;,s&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr); }
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4c7cb0e8a03c580e65ccc368dcb401e3">00239</a> <span class="keywordtype">bool</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4c7cb0e8a03c580e65ccc368dcb401e3">LbmFsgrSolver::adaptGrid</a>(<span class="keywordtype">int</span> lev) {
<a name="l00240"></a>00240     <span class="keywordflow">if</span>((lev&lt;0) || ((lev+1)&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00241"></a>00241     <span class="keywordtype">bool</span> change = <span class="keyword">false</span>;
<a name="l00242"></a>00242     { <span class="comment">// refinement, PASS 1-3</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="comment">//bool nbsok;</span>
<a name="l00245"></a>00245     <span class="comment">// FIXME remove TIMEINTORDER ?</span>
<a name="l00246"></a>00246     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> interTime = 0.0;
<a name="l00247"></a>00247     <span class="comment">// update curr from other, as streaming afterwards works on curr</span>
<a name="l00248"></a>00248     <span class="comment">// thus read only from srcSet, modify other</span>
<a name="l00249"></a>00249     <span class="keyword">const</span> <span class="keywordtype">int</span> srcSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a969dc4eebe3ff743980e099cad72240a" title="target/other set of dist funcs">setOther</a>;
<a name="l00250"></a>00250     <span class="keyword">const</span> <span class="keywordtype">int</span> dstSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00251"></a>00251     <span class="keyword">const</span> <span class="keywordtype">int</span> srcFineSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00252"></a>00252     <span class="keyword">const</span> <span class="keywordtype">bool</span> debugRefinement = <span class="keyword">false</span>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">// use //template functions for 2D/3D</span>
<a name="l00255"></a>00255             <span class="comment">/*if(strstr(this-&gt;getName().c_str(),&quot;Debug&quot;))</span>
<a name="l00256"></a>00256 <span class="comment">            if(lev+1==mMaxRefine) { // mixborder</span>
<a name="l00257"></a>00257 <span class="comment">                for(int l=0;((l&lt;this-&gt;cDirNum) &amp;&amp; (!removeFromFine)); l++) {  // FARBORD</span>
<a name="l00258"></a>00258 <span class="comment">                    int ni=2*i+2*this-&gt;dfVecX[l], nj=2*j+2*this-&gt;dfVecY[l], nk=2*k+2*this-&gt;dfVecZ[l];</span>
<a name="l00259"></a>00259 <span class="comment">                    if(RFLAG(lev+1, ni,nj,nk, srcFineSet)&amp;CFBnd) { // NEWREFT</span>
<a name="l00260"></a>00260 <span class="comment">                        removeFromFine=true;</span>
<a name="l00261"></a>00261 <span class="comment">                    }</span>
<a name="l00262"></a>00262 <span class="comment">                }</span>
<a name="l00263"></a>00263 <span class="comment">            } // FARBORD */</span>
<a name="l00264"></a>00264     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00265"></a>00265   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00266"></a>00266   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) {
<a name="l00269"></a>00269             <span class="keywordtype">bool</span> removeFromFine = <span class="keyword">false</span>;
<a name="l00270"></a>00270             <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> notAllowed = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>);
<a name="l00271"></a>00271             <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00272"></a>00272             <span class="keywordflow">if</span>(lev+1==<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>;
<a name="l00273"></a>00273             
<a name="l00274"></a>00274             <span class="keywordflow">if</span>(   (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, (2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>),(2*j),(2*k), srcFineSet) &amp; reqType) &amp;&amp;
<a name="l00275"></a>00275                 (!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, (2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>),(2*j),(2*k), srcFineSet) &amp; (notAllowed)) )  ){ <span class="comment">// ok</span>
<a name="l00276"></a>00276             } <span class="keywordflow">else</span> {
<a name="l00277"></a>00277                 removeFromFine=<span class="keyword">true</span>;
<a name="l00278"></a>00278             }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280             <span class="keywordflow">if</span>(removeFromFine) {
<a name="l00281"></a>00281                 <span class="comment">// dont turn CFGrFromFine above interface cells into CFGrNorm</span>
<a name="l00282"></a>00282                 <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Removing CFGrFromFine on lev&quot;&lt;&lt;lev&lt;&lt;&quot; &quot; &lt;&lt;PRINT_IJK&lt;&lt;&quot; srcflag:&quot;&lt;&lt;convertCellFlagType2String(RFLAG(lev+1, (2*i),(2*j),(2*k), srcFineSet)) &lt;&lt;&quot; set:&quot;&lt;&lt;dstSet );</span>
<a name="l00283"></a>00283                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>;
<a name="l00284"></a>00284 <span class="preprocessor">#if FSGR_STRICT_DEBUG==1</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>                <span class="comment">// for interpolation later on during fine grid fixing</span>
<a name="l00286"></a>00286                 <span class="comment">// these cells are still correctly inited</span>
<a name="l00287"></a>00287                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6d2cab3b7a34e2e22f4a7e39859a3a37">CFGrCoarseInited</a>;  <span class="comment">// remove later on? FIXME?</span>
<a name="l00288"></a>00288 <span class="preprocessor">#endif // FSGR_STRICT_DEBUG==1</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>                <span class="comment">//RFLAG(lev, i,j,k, mLevel[lev].setOther) = CFEmpty; // FLAGTEST</span>
<a name="l00290"></a>00290                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k); 
<a name="l00291"></a>00291                 change=<span class="keyword">true</span>;
<a name="l00292"></a>00292                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00293"></a>00293                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00294"></a>00294                     <span class="keywordtype">int</span> ni=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00295"></a>00295                     <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;On lev:&quot;&lt;&lt;lev&lt;&lt;&quot; check: &quot;&lt;&lt;PRINT_VEC(ni,nj,nk)&lt;&lt;&quot; set:&quot;&lt;&lt;dstSet&lt;&lt;&quot; = &quot;&lt;&lt;convertCellFlagType2String(RFLAG(lev, ni,nj,nk, srcSet)) );</span>
<a name="l00296"></a>00296                     <span class="keywordflow">if</span>( (  <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, srcSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>      ) &amp;&amp;
<a name="l00297"></a>00297                             (!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, srcSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>)) ) { <span class="comment">// dont change status of nb. from fine cells</span>
<a name="l00298"></a>00298                         <span class="comment">// tag as inited for debugging, cell contains fluid DFs anyway</span>
<a name="l00299"></a>00299                         <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, dstSet) = CFFluid|CFGrFromFine|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6d2cab3b7a34e2e22f4a7e39859a3a37">CFGrCoarseInited</a>;
<a name="l00300"></a>00300                         <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;On lev:&quot;&lt;&lt;lev&lt;&lt;&quot; set to from fine: &quot;&lt;&lt;PRINT_VEC(ni,nj,nk)&lt;&lt;&quot; set:&quot;&lt;&lt;dstSet);</span>
<a name="l00301"></a>00301                         <span class="comment">//if((LBMDIM==2)&amp;&amp;(debugRefinement)) debugMarkCell(lev,ni,nj,nk); </span>
<a name="l00302"></a>00302                     }
<a name="l00303"></a>00303                 } <span class="comment">// l </span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305                 <span class="comment">// FIXME fix fine level?</span>
<a name="l00306"></a>00306             }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308             <span class="comment">// recheck from fine flag</span>
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310     }}} <span class="comment">// TEST</span>
<a name="l00311"></a>00311     <span class="comment">// PASS 1 */</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="comment">/*if( ((*pFlagSrc) &amp; (CFGrFromCoarse)) ) { </span>
<a name="l00315"></a>00315 <span class="comment">            bool invNb = false;</span>
<a name="l00316"></a>00316 <span class="comment">            FORDF1 { </span>
<a name="l00317"></a>00317 <span class="comment">                if(RFLAG_NB(lev, i, j, k, SRCS(lev), l) &amp; CFUnused) { invNb = true; }</span>
<a name="l00318"></a>00318 <span class="comment">            }   </span>
<a name="l00319"></a>00319 <span class="comment">            if(!invNb) {</span>
<a name="l00320"></a>00320 <span class="comment">                *pFlagSrc = CFFluid|CFGrNorm;</span>
<a name="l00321"></a>00321 <span class="comment">                errMsg(&quot;coarseAdvance&quot;,&quot;FC2NRM_CHECK Converted CFGrFromCoarse to Norm at &quot;&lt;&lt;lev&lt;&lt;&quot; &quot;&lt;&lt;PRINT_IJK);</span>
<a name="l00322"></a>00322 <span class="comment">            }</span>
<a name="l00323"></a>00323 <span class="comment">        } // */</span>
<a name="l00324"></a>00324     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) { <span class="comment">// TEST</span>
<a name="l00325"></a>00325   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) { <span class="comment">// TEST</span>
<a name="l00326"></a>00326   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) { <span class="comment">// TEST</span>
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="comment">// test from coarseAdvance</span>
<a name="l00329"></a>00329         <span class="comment">// from coarse cells without unused nbs are not necessary...! -&gt; remove</span>
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) {
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             <span class="comment">// from coarse cells without unused nbs are not necessary...! -&gt; remove</span>
<a name="l00334"></a>00334             <span class="keywordtype">bool</span> invNb = <span class="keyword">false</span>;
<a name="l00335"></a>00335             <span class="keywordtype">bool</span> fluidNb = <span class="keyword">false</span>;
<a name="l00336"></a>00336             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00337"></a>00337                 <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, srcSet, l) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) { invNb = <span class="keyword">true</span>; }
<a name="l00338"></a>00338                 <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, srcSet, l) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>)) { fluidNb = <span class="keyword">true</span>; }
<a name="l00339"></a>00339             }   
<a name="l00340"></a>00340             <span class="keywordflow">if</span>(!invNb) {
<a name="l00341"></a>00341                 <span class="comment">// no unused cells around -&gt; calculate normally from now on</span>
<a name="l00342"></a>00342                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00343"></a>00343                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k); 
<a name="l00344"></a>00344                 change=<span class="keyword">true</span>;
<a name="l00345"></a>00345                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00346"></a>00346             } <span class="comment">// from advance </span>
<a name="l00347"></a>00347             <span class="keywordflow">if</span>(!fluidNb) {
<a name="l00348"></a>00348                 <span class="comment">// no fluid cells near -&gt; no transfer necessary</span>
<a name="l00349"></a>00349                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>;
<a name="l00350"></a>00350                 <span class="comment">//RFLAG(lev, i,j,k, mLevel[lev].setOther) = CFUnused; // FLAGTEST</span>
<a name="l00351"></a>00351                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k); 
<a name="l00352"></a>00352                 change=<span class="keyword">true</span>;
<a name="l00353"></a>00353                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00354"></a>00354             } <span class="comment">// from advance </span>
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00357"></a>00357             <span class="comment">// dont allow double transfer</span>
<a name="l00358"></a>00358             <span class="comment">// this might require fixing the neighborhood</span>
<a name="l00359"></a>00359             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, 2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,2*j,2*k, srcFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) { 
<a name="l00360"></a>00360                 <span class="comment">// dont turn CFGrFromFine above interface cells into CFGrNorm</span>
<a name="l00361"></a>00361                 <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Removing CFGrFromCoarse on lev&quot;&lt;&lt;lev&lt;&lt;&quot; &quot; &lt;&lt;PRINT_IJK&lt;&lt;&quot; due to finer from coarse cell &quot; );</span>
<a name="l00362"></a>00362                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00363"></a>00363                 <span class="keywordflow">if</span>(lev&gt;0) <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev-1, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>/2,j/2,k/2, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev-1].setCurr) &amp;= (~<a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>); <span class="comment">// TODO add more of these?</span>
<a name="l00364"></a>00364                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k); 
<a name="l00365"></a>00365                 change=<span class="keyword">true</span>;
<a name="l00366"></a>00366                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00367"></a>00367                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00368"></a>00368                     <span class="keywordtype">int</span> ni=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00369"></a>00369                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>)) { <span class="comment">//ok</span>
<a name="l00370"></a>00370                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m=1; m&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; m++) { 
<a name="l00371"></a>00371                             <span class="keywordtype">int</span> mi=  ni +this-&gt;dfVecX[m], mj=  nj +this-&gt;dfVecY[m], mk=  nk +this-&gt;dfVecZ[m];
<a name="l00372"></a>00372                             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,  mi, mj, mk, srcSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) {
<a name="l00373"></a>00373                                 <span class="comment">// norm cells in neighborhood with unused nbs have to be new border...</span>
<a name="l00374"></a>00374                                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, dstSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>;
<a name="l00375"></a>00375                                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev,ni,nj,nk); 
<a name="l00376"></a>00376                             }
<a name="l00377"></a>00377                         }
<a name="l00378"></a>00378                         <span class="comment">// these alreay have valid values...</span>
<a name="l00379"></a>00379                     }
<a name="l00380"></a>00380                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>)) { <span class="comment">//ok</span>
<a name="l00381"></a>00381                         <span class="comment">// this should work because we have a valid neighborhood here for now</span>
<a name="l00382"></a>00382                         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>(lev,  ni, nj, nk, dstSet, interTime, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>, <span class="keyword">false</span>);
<a name="l00383"></a>00383                         <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev,ni,nj,nk); 
<a name="l00384"></a>00384                         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00385"></a>00385                     }
<a name="l00386"></a>00386                 } <span class="comment">// l </span>
<a name="l00387"></a>00387             } <span class="comment">// double transer</span>
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         } <span class="comment">// from coarse</span>
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     } } }
<a name="l00392"></a>00392     <span class="comment">// PASS 2 */</span>
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">// fix dstSet from fine cells here</span>
<a name="l00396"></a>00396     <span class="comment">// warning - checks CFGrFromFine on dstset changed before!</span>
<a name="l00397"></a>00397     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) { <span class="comment">// TEST</span>
<a name="l00398"></a>00398   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) { <span class="comment">// TEST</span>
<a name="l00399"></a>00399   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) { <span class="comment">// TEST</span>
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="comment">//if(RFLAG(lev, i,j,k, srcSet) &amp; CFGrFromFine) {</span>
<a name="l00402"></a>00402         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, dstSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) {
<a name="l00403"></a>00403             <span class="comment">// modify finer level border</span>
<a name="l00404"></a>00404             <span class="keywordflow">if</span>((<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, 2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,2*j,2*k, srcFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>))) { 
<a name="l00405"></a>00405                 <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Removing CFGrFromCoarse on lev&quot;&lt;&lt;(lev+1)&lt;&lt;&quot; from l&quot;&lt;&lt;lev&lt;&lt;&quot; &quot; &lt;&lt;PRINT_IJK );</span>
<a name="l00406"></a>00406                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> setf = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>;
<a name="l00407"></a>00407                 <span class="keywordflow">if</span>(lev+1 &lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) setf = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00408"></a>00408                 <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, 2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,2*j,2*k, srcFineSet)=setf;
<a name="l00409"></a>00409                 change=<span class="keyword">true</span>;
<a name="l00410"></a>00410                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00411"></a>00411                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00412"></a>00412                     <span class="keywordtype">int</span> bi=(2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], bj=(2*j)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], bk=(2*k)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00413"></a>00413                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  bi, bj, bk, srcFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) {
<a name="l00414"></a>00414                         <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Removing CFGrFromCoarse on lev&quot;&lt;&lt;(lev+1)&lt;&lt;&quot; &quot;&lt;&lt;PRINT_VEC(bi,bj,bk) );</span>
<a name="l00415"></a>00415                         <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  bi, bj, bk, srcFineSet) = setf;
<a name="l00416"></a>00416                         <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev+1,bi,bj,bk); 
<a name="l00417"></a>00417                     }
<a name="l00418"></a>00418                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  bi, bj, bk, srcFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>      )) { 
<a name="l00419"></a>00419                         <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Removing CFUnused on lev&quot;&lt;&lt;(lev+1)&lt;&lt;&quot; &quot;&lt;&lt;PRINT_VEC(bi,bj,bk) );</span>
<a name="l00420"></a>00420                         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>(lev+1,  bi, bj, bk, srcFineSet, interTime, setf, <span class="keyword">false</span>);
<a name="l00421"></a>00421                         <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev+1,bi,bj,bk); 
<a name="l00422"></a>00422                         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00423"></a>00423                     }
<a name="l00424"></a>00424                 }
<a name="l00425"></a>00425                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00426"></a>00426                     <span class="keywordtype">int</span> bi=(2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], bj=(2*j)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], bk=(2*k)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00427"></a>00427                     <span class="keywordflow">if</span>(   (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  bi, bj, bk, srcFineSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>       ) &amp;&amp;
<a name="l00428"></a>00428                             (!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  bi, bj, bk, srcFineSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) ) {
<a name="l00429"></a>00429                         <span class="comment">// all unused nbs now of coarse have to be from coarse</span>
<a name="l00430"></a>00430                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m=1; m&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; m++) { 
<a name="l00431"></a>00431                             <span class="keywordtype">int</span> mi=  bi +this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[m], mj=  bj +this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[m], mk=  bk +this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[m];
<a name="l00432"></a>00432                             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1,  mi, mj, mk, srcFineSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) {
<a name="l00433"></a>00433                                 <span class="comment">//errMsg(&quot;performRefinement&quot;,&quot;Changing CFUnused on lev&quot;&lt;&lt;(lev+1)&lt;&lt;&quot; &quot;&lt;&lt;PRINT_VEC(mi,mj,mk) );</span>
<a name="l00434"></a>00434                                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>(lev+1,  mi, mj, mk, srcFineSet, interTime, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|CFGrFromCoarse, <span class="keyword">false</span>);
<a name="l00435"></a>00435                                 <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugRefinement)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev+1,mi,mj,mk); 
<a name="l00436"></a>00436                                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00437"></a>00437                             }
<a name="l00438"></a>00438                         }
<a name="l00439"></a>00439                         <span class="comment">// nbs prepared...</span>
<a name="l00440"></a>00440                     }
<a name="l00441"></a>00441                 }
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443             
<a name="l00444"></a>00444         } <span class="comment">// convert regions of from fine</span>
<a name="l00445"></a>00445     }}} <span class="comment">// TEST</span>
<a name="l00446"></a>00446     <span class="comment">// PASS 3 */</span>
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="keywordflow">if</span>(!this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;performRefinement&quot;</span>,<span class="stringliteral">&quot; for l&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; done (&quot;</span>&lt;&lt;change&lt;&lt;<span class="stringliteral">&quot;) &quot;</span> ); }
<a name="l00449"></a>00449     } <span class="comment">// PASS 1-3</span>
<a name="l00450"></a>00450     <span class="comment">// refinement done</span>
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="comment">//LbmFsgrSolver::performCoarsening(int lev) {</span>
<a name="l00453"></a>00453     { <span class="comment">// PASS 4,5</span>
<a name="l00454"></a>00454     <span class="keywordtype">bool</span> nbsok;
<a name="l00455"></a>00455     <span class="comment">// WARNING</span>
<a name="l00456"></a>00456     <span class="comment">// now work on modified curr set</span>
<a name="l00457"></a>00457     <span class="keyword">const</span> <span class="keywordtype">int</span> srcSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00458"></a>00458     <span class="keyword">const</span> <span class="keywordtype">int</span> dstlev = lev+1;
<a name="l00459"></a>00459     <span class="keyword">const</span> <span class="keywordtype">int</span> dstFineSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[dstlev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00460"></a>00460     <span class="keyword">const</span> <span class="keywordtype">bool</span> debugCoarsening = <span class="keyword">false</span>;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">// PASS 5 test DEBUG</span>
<a name="l00463"></a>00463     <span class="comment">/*if(this-&gt;mInitDone) {</span>
<a name="l00464"></a>00464 <span class="comment">    for(int k= getForZMin1(); k&lt; getForZMax1(lev); ++k) {</span>
<a name="l00465"></a>00465 <span class="comment">  for(int j=1;j&lt;mLevel[lev].lSizey-1;++j) {</span>
<a name="l00466"></a>00466 <span class="comment">  for(int i=1;i&lt;mLevel[lev].lSizex-1;++i) {</span>
<a name="l00467"></a>00467 <span class="comment">            if(RFLAG(lev, i,j,k, srcSet) &amp; CFEmpty) {</span>
<a name="l00468"></a>00468 <span class="comment">                // check empty -&gt; from fine conversion</span>
<a name="l00469"></a>00469 <span class="comment">                bool changeToFromFine = false;</span>
<a name="l00470"></a>00470 <span class="comment">                const CellFlagType notAllowed = (CFInter|CFGrFromFine|CFGrToFine);</span>
<a name="l00471"></a>00471 <span class="comment">                CellFlagType reqType = CFGrNorm;</span>
<a name="l00472"></a>00472 <span class="comment">                if(lev+1==mMaxRefine) reqType = CFNoBndFluid;</span>
<a name="l00473"></a>00473 <span class="comment">                if(   (RFLAG(lev+1, (2*i),(2*j),(2*k), dstFineSet) &amp; reqType) &amp;&amp;</span>
<a name="l00474"></a>00474 <span class="comment">                    (!(RFLAG(lev+1, (2*i),(2*j),(2*k), dstFineSet) &amp; (notAllowed)) )  ){</span>
<a name="l00475"></a>00475 <span class="comment">                    changeToFromFine=true; }</span>
<a name="l00476"></a>00476 <span class="comment">                if(changeToFromFine) {</span>
<a name="l00477"></a>00477 <span class="comment">                    change = true;</span>
<a name="l00478"></a>00478 <span class="comment">                    mNumFsgrChanges++;</span>
<a name="l00479"></a>00479 <span class="comment">                    RFLAG(lev, i,j,k, srcSet) = CFFluid|CFGrFromFine;</span>
<a name="l00480"></a>00480 <span class="comment">                    if((LBMDIM==2)&amp;&amp;(debugCoarsening)) debugMarkCell(lev,i,j,k); </span>
<a name="l00481"></a>00481 <span class="comment">                    // same as restr from fine func! not necessary ?!</span>
<a name="l00482"></a>00482 <span class="comment">                    // coarseRestrictFromFine part </span>
<a name="l00483"></a>00483 <span class="comment">                    coarseRestrictCell(lev, i,j,k,srcSet, dstFineSet);</span>
<a name="l00484"></a>00484 <span class="comment">                }</span>
<a name="l00485"></a>00485 <span class="comment">            } // only check empty cells</span>
<a name="l00486"></a>00486 <span class="comment">    }}} // TEST!</span>
<a name="l00487"></a>00487 <span class="comment">    } // PASS 5 */</span>
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="comment">// use //template functions for 2D/3D</span>
<a name="l00490"></a>00490                     <span class="comment">/*if(strstr(this-&gt;getName().c_str(),&quot;Debug&quot;))</span>
<a name="l00491"></a>00491 <span class="comment">                    if((nbsok)&amp;&amp;(lev+1==mMaxRefine)) { // mixborder</span>
<a name="l00492"></a>00492 <span class="comment">                        for(int l=0;((l&lt;this-&gt;cDirNum) &amp;&amp; (nbsok)); l++) {  // FARBORD</span>
<a name="l00493"></a>00493 <span class="comment">                            int ni=2*i+2*this-&gt;dfVecX[l], nj=2*j+2*this-&gt;dfVecY[l], nk=2*k+2*this-&gt;dfVecZ[l];</span>
<a name="l00494"></a>00494 <span class="comment">                            if(RFLAG(lev+1, ni,nj,nk, dstFineSet)&amp;CFBnd) { // NEWREFT</span>
<a name="l00495"></a>00495 <span class="comment">                                nbsok=false;</span>
<a name="l00496"></a>00496 <span class="comment">                            }</span>
<a name="l00497"></a>00497 <span class="comment">                        }</span>
<a name="l00498"></a>00498 <span class="comment">                    } // FARBORD */</span>
<a name="l00499"></a>00499     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00500"></a>00500   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00501"></a>00501   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00502"></a>00502 
<a name="l00503"></a>00503             <span class="comment">// from coarse cells without unused nbs are not necessary...! -&gt; remove</span>
<a name="l00504"></a>00504             <span class="comment">// perform check from coarseAdvance here?</span>
<a name="l00505"></a>00505             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) {
<a name="l00506"></a>00506                 <span class="comment">// remove from fine cells now that are completely in fluid</span>
<a name="l00507"></a>00507                 <span class="comment">// FIXME? check that new from fine in performRefinement never get deleted here afterwards?</span>
<a name="l00508"></a>00508                 <span class="comment">// or more general, one cell never changed more than once?</span>
<a name="l00509"></a>00509                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> notAllowed = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>);
<a name="l00510"></a>00510                 <span class="comment">//const CellFlagType notNbAllowed = (CFInter|CFBnd|CFGrFromFine); unused</span>
<a name="l00511"></a>00511                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00512"></a>00512                 <span class="keywordflow">if</span>(lev+1==<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514                 nbsok = <span class="keyword">true</span>;
<a name="l00515"></a>00515                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a> &amp;&amp; nbsok; l++) { 
<a name="l00516"></a>00516                     <span class="keywordtype">int</span> ni=(2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=(2*j)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=(2*k)+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00517"></a>00517                     <span class="keywordflow">if</span>(   (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, ni,nj,nk, dstFineSet) &amp; reqType) &amp;&amp;
<a name="l00518"></a>00518                             (!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, ni,nj,nk, dstFineSet) &amp; (notAllowed)) )  ){
<a name="l00519"></a>00519                         <span class="comment">// ok</span>
<a name="l00520"></a>00520                     } <span class="keywordflow">else</span> {
<a name="l00521"></a>00521                         nbsok=<span class="keyword">false</span>;
<a name="l00522"></a>00522                     }
<a name="l00523"></a>00523                     <span class="comment">// FARBORD</span>
<a name="l00524"></a>00524                 }
<a name="l00525"></a>00525                 <span class="comment">// dont turn CFGrFromFine above interface cells into CFGrNorm</span>
<a name="l00526"></a>00526                 <span class="comment">// now check nbs on same level</span>
<a name="l00527"></a>00527                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a> &amp;&amp; nbsok; l++) { 
<a name="l00528"></a>00528                     <span class="keywordtype">int</span> ni=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00529"></a>00529                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, ni,nj,nk, srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>)) { <span class="comment">//ok</span>
<a name="l00530"></a>00530                     } <span class="keywordflow">else</span> {
<a name="l00531"></a>00531                         nbsok = <span class="keyword">false</span>;
<a name="l00532"></a>00532                     }
<a name="l00533"></a>00533                 } <span class="comment">// l</span>
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                 <span class="keywordflow">if</span>(nbsok) {
<a name="l00536"></a>00536                     <span class="comment">// conversion to coarse fluid cell</span>
<a name="l00537"></a>00537                     change = <span class="keyword">true</span>;
<a name="l00538"></a>00538                     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00539"></a>00539                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00540"></a>00540                     <span class="comment">// dfs are already ok...</span>
<a name="l00541"></a>00541                     <span class="comment">//if(this-&gt;mInitDone) errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine changed to CFGrNorm at lev&quot;&lt;&lt;lev&lt;&lt;&quot; &quot; &lt;&lt;PRINT_IJK );</span>
<a name="l00542"></a>00542                     <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugCoarsening)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k); 
<a name="l00543"></a>00543 
<a name="l00544"></a>00544                     <span class="comment">// only check complete cubes</span>
<a name="l00545"></a>00545                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dx=-1;dx&lt;=1;dx+=2) {
<a name="l00546"></a>00546                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dy=-1;dy&lt;=1;dy+=2) {
<a name="l00547"></a>00547                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dz=-1*(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>&amp;1);dz&lt;=1*(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>&amp;1);dz+=2) { <span class="comment">// 2d/3d</span>
<a name="l00548"></a>00548                         <span class="comment">// check for norm and from coarse, as the coarse level might just have been refined...</span>
<a name="l00549"></a>00549                         <span class="keywordflow">if</span>( 
<a name="l00550"></a>00550                                 <span class="comment">// we now the flag of the current cell! ( RFLAG(lev, i   , j   , k   ,  srcSet)&amp;(CFGrNorm)) &amp;&amp;</span>
<a name="l00551"></a>00551                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+dx, j   , k   ,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00552"></a>00552                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>   , j+dy, k   ,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00553"></a>00553                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>   , j   , k+dz,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+dx, j+dy, k   ,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00556"></a>00556                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+dx, j   , k+dz,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00557"></a>00557                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>   , j+dy, k+dz,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) &amp;&amp;
<a name="l00558"></a>00558                                 ( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+dx, j+dy, k+dz,  srcSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) 
<a name="l00559"></a>00559                             ) {
<a name="l00560"></a>00560                             <span class="comment">// middle source node on higher level</span>
<a name="l00561"></a>00561                             <span class="keywordtype">int</span> dstx = (2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)+dx;
<a name="l00562"></a>00562                             <span class="keywordtype">int</span> dsty = (2*j)+dy;
<a name="l00563"></a>00563                             <span class="keywordtype">int</span> dstz = (2*k)+dz;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565                             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00566"></a>00566                             <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstx,dsty,dstz, dstFineSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>;
<a name="l00567"></a>00567                             <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstx,dsty,dstz, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[dstlev].setOther) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>; <span class="comment">// FLAGTEST</span>
<a name="l00568"></a>00568                             <span class="comment">//if(this-&gt;mInitDone) errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine subcube init center unused set l&quot;&lt;&lt;dstlev&lt;&lt;&quot; at &quot;&lt;&lt;PRINT_VEC(dstx,dsty,dstz) );</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570                             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00571"></a>00571                                 <span class="keywordtype">int</span> dstni=dstx+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], dstnj=dsty+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], dstnk=dstz+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00572"></a>00572                                 <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>)) { 
<a name="l00573"></a>00573                                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>;
<a name="l00574"></a>00574                                 }
<a name="l00575"></a>00575                                 <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) { 
<a name="l00576"></a>00576                                     <span class="comment">//if(this-&gt;mInitDone) errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine subcube init CHECK Warning - deleting interface cell...&quot;);</span>
<a name="l00577"></a>00577                                     this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a> += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>( dstlev, dstni,dstnj,dstnk, dstFineSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>);
<a name="l00578"></a>00578                                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>;
<a name="l00579"></a>00579                                 }
<a name="l00580"></a>00580                             } <span class="comment">// l</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582                             <span class="comment">// again check nb flags of all surrounding cells to see if any from coarse</span>
<a name="l00583"></a>00583                             <span class="comment">// can be convted to unused</span>
<a name="l00584"></a>00584                             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; l++) { 
<a name="l00585"></a>00585                                 <span class="keywordtype">int</span> dstni=dstx+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], dstnj=dsty+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], dstnk=dstz+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00586"></a>00586                                 <span class="comment">// have to be at least from coarse here...</span>
<a name="l00587"></a>00587                                 <span class="comment">//errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine subcube init unused check l&quot;&lt;&lt;dstlev&lt;&lt;&quot; at &quot;&lt;&lt;PRINT_VEC(dstni,dstnj,dstnk)&lt;&lt;&quot; &quot;&lt;&lt; convertCellFlagType2String(RFLAG(dstlev, dstni,dstnj,dstnk, dstFineSet)) );</span>
<a name="l00588"></a>00588                                 <span class="keywordflow">if</span>(!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) )) { 
<a name="l00589"></a>00589                                     <span class="keywordtype">bool</span> delok = <span class="keyword">true</span>;
<a name="l00590"></a>00590                                     <span class="comment">// careful long range here... check domain bounds?</span>
<a name="l00591"></a>00591                                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> m=1; m&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>; m++) {                                        
<a name="l00592"></a>00592                                         <span class="keywordtype">int</span> chkni=dstni+this-&gt;dfVecX[m], chknj=dstnj+this-&gt;dfVecY[m], chknk=dstnk+this-&gt;dfVecZ[m];
<a name="l00593"></a>00593                                         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, chkni,chknj,chknk, dstFineSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) { 
<a name="l00594"></a>00594                                             <span class="comment">// this nb cell is ok for deletion</span>
<a name="l00595"></a>00595                                         } <span class="keywordflow">else</span> { 
<a name="l00596"></a>00596                                             delok=<span class="keyword">false</span>; <span class="comment">// keep it!</span>
<a name="l00597"></a>00597                                         }
<a name="l00598"></a>00598                                         <span class="comment">//errMsg(&quot;performCoarsening&quot;,&quot; CHECK &quot;&lt;&lt;PRINT_VEC(dstni,dstnj,dstnk)&lt;&lt;&quot; to &quot;&lt;&lt;PRINT_VEC( chkni,chknj,chknk )&lt;&lt;&quot; f:&quot;&lt;&lt; convertCellFlagType2String( RFLAG(dstlev, chkni,chknj,chknk, dstFineSet))&lt;&lt;&quot; nbsok&quot;&lt;&lt;delok );</span>
<a name="l00599"></a>00599                                     }
<a name="l00600"></a>00600                                     <span class="comment">//errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine subcube init unused check l&quot;&lt;&lt;dstlev&lt;&lt;&quot; at &quot;&lt;&lt;PRINT_VEC(dstni,dstnj,dstnk)&lt;&lt;&quot; ok&quot;&lt;&lt;delok );</span>
<a name="l00601"></a>00601                                     <span class="keywordflow">if</span>(delok) {
<a name="l00602"></a>00602                                         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00603"></a>00603                                         <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, dstFineSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>;
<a name="l00604"></a>00604                                         <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(dstlev, dstni,dstnj,dstnk, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[dstlev].setOther) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>; <span class="comment">// FLAGTEST</span>
<a name="l00605"></a>00605                                         <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugCoarsening)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(dstlev,dstni,dstnj,dstnk); 
<a name="l00606"></a>00606                                     }
<a name="l00607"></a>00607                                 }
<a name="l00608"></a>00608                             } <span class="comment">// l</span>
<a name="l00609"></a>00609                             <span class="comment">// treat subcube</span>
<a name="l00610"></a>00610                             <span class="comment">//ebugMarkCell(lev,i+dx,j+dy,k+dz); </span>
<a name="l00611"></a>00611                             <span class="comment">//if(this-&gt;mInitDone) errMsg(&quot;performCoarsening&quot;,&quot;CFGrFromFine subcube init, dir:&quot;&lt;&lt;PRINT_VEC(dx,dy,dz) );</span>
<a name="l00612"></a>00612                         }
<a name="l00613"></a>00613                     } } }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615                 }   <span class="comment">// ?</span>
<a name="l00616"></a>00616             } <span class="comment">// convert regions of from fine</span>
<a name="l00617"></a>00617     }}} <span class="comment">// TEST!</span>
<a name="l00618"></a>00618     <span class="comment">// PASS 4 */</span>
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="comment">// reinit cell area value</span>
<a name="l00621"></a>00621         <span class="comment">/*if( RFLAG(lev, i,j,k,srcSet) &amp; CFFluid) {</span>
<a name="l00622"></a>00622 <span class="comment">            if( RFLAG(lev+1, i*2,j*2,k*2,dstFineSet) &amp; CFGrFromCoarse) {</span>
<a name="l00623"></a>00623 <span class="comment">                LbmFloat totArea = mFsgrCellArea[0]; // for l=0</span>
<a name="l00624"></a>00624 <span class="comment">                for(int l=1; l&lt;this-&gt;cDirNum; l++) { </span>
<a name="l00625"></a>00625 <span class="comment">                    int ni=(2*i)+this-&gt;dfVecX[l], nj=(2*j)+this-&gt;dfVecY[l], nk=(2*k)+this-&gt;dfVecZ[l];</span>
<a name="l00626"></a>00626 <span class="comment">                    if(RFLAG(lev+1, ni,nj,nk, dstFineSet)&amp;</span>
<a name="l00627"></a>00627 <span class="comment">                            (CFGrFromCoarse|CFUnused|CFEmpty) //? (CFBnd|CFEmpty|CFGrFromCoarse|CFUnused)</span>
<a name="l00628"></a>00628 <span class="comment">                            //(CFUnused|CFEmpty) //? (CFBnd|CFEmpty|CFGrFromCoarse|CFUnused)</span>
<a name="l00629"></a>00629 <span class="comment">                            ) { </span>
<a name="l00630"></a>00630 <span class="comment">                        //LbmFloat area = 0.25; if(this-&gt;dfVecX[l]!=0) area *= 0.5; if(this-&gt;dfVecY[l]!=0) area *= 0.5; if(this-&gt;dfVecZ[l]!=0) area *= 0.5;</span>
<a name="l00631"></a>00631 <span class="comment">                        totArea += mFsgrCellArea[l];</span>
<a name="l00632"></a>00632 <span class="comment">                    }</span>
<a name="l00633"></a>00633 <span class="comment">                } // l</span>
<a name="l00634"></a>00634 <span class="comment">                QCELL(lev, i,j,k,mLevel[lev].setOther, dFlux) = </span>
<a name="l00635"></a>00635 <span class="comment">                QCELL(lev, i,j,k,srcSet, dFlux) = totArea;</span>
<a name="l00636"></a>00636 <span class="comment">            } else {</span>
<a name="l00637"></a>00637 <span class="comment">                QCELL(lev, i,j,k,mLevel[lev].setOther, dFlux) = </span>
<a name="l00638"></a>00638 <span class="comment">                QCELL(lev, i,j,k,srcSet, dFlux) = 1.0;</span>
<a name="l00639"></a>00639 <span class="comment">            }</span>
<a name="l00640"></a>00640 <span class="comment">            //errMsg(&quot;DFINI&quot;,&quot; at l&quot;&lt;&lt;lev&lt;&lt;&quot; &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; v:&quot;&lt;&lt;QCELL(lev, i,j,k,srcSet, dFlux) );</span>
<a name="l00641"></a>00641 <span class="comment">        }</span>
<a name="l00642"></a>00642 <span class="comment">    // */</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="comment">// PASS 5 org</span>
<a name="l00646"></a>00646     <span class="comment">/*if(strstr(this-&gt;getName().c_str(),&quot;Debug&quot;))</span>
<a name="l00647"></a>00647 <span class="comment">    if((changeToFromFine)&amp;&amp;(lev+1==mMaxRefine)) { // mixborder</span>
<a name="l00648"></a>00648 <span class="comment">        for(int l=0;((l&lt;this-&gt;cDirNum) &amp;&amp; (changeToFromFine)); l++) {  // FARBORD</span>
<a name="l00649"></a>00649 <span class="comment">            int ni=2*i+2*this-&gt;dfVecX[l], nj=2*j+2*this-&gt;dfVecY[l], nk=2*k+2*this-&gt;dfVecZ[l];</span>
<a name="l00650"></a>00650 <span class="comment">            if(RFLAG(lev+1, ni,nj,nk, dstFineSet)&amp;CFBnd) { // NEWREFT</span>
<a name="l00651"></a>00651 <span class="comment">                changeToFromFine=false; }</span>
<a name="l00652"></a>00652 <span class="comment">        } </span>
<a name="l00653"></a>00653 <span class="comment">    }// FARBORD */</span>
<a name="l00654"></a>00654     <span class="comment">//if(!this-&gt;mInitDone) {</span>
<a name="l00655"></a>00655     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k= <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>(); k&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(lev); ++k) {
<a name="l00656"></a>00656   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=1;j&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1;++j) {
<a name="l00657"></a>00657   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-1;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 
<a name="l00660"></a>00660             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>) {
<a name="l00661"></a>00661                 <span class="comment">// check empty -&gt; from fine conversion</span>
<a name="l00662"></a>00662                 <span class="keywordtype">bool</span> changeToFromFine = <span class="keyword">false</span>;
<a name="l00663"></a>00663                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> notAllowed = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#afb5b5e7719b4153bfbf061015f9d491a">CFGrToFine</a>);
<a name="l00664"></a>00664                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>;
<a name="l00665"></a>00665                 <span class="keywordflow">if</span>(lev+1==<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) reqType = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667                 <span class="keywordflow">if</span>(   (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, (2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>),(2*j),(2*k), dstFineSet) &amp; reqType) &amp;&amp;
<a name="l00668"></a>00668                     (!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev+1, (2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>),(2*j),(2*k), dstFineSet) &amp; (notAllowed)) )  ){
<a name="l00669"></a>00669                     <span class="comment">// DEBUG </span>
<a name="l00670"></a>00670                     changeToFromFine=<span class="keyword">true</span>;
<a name="l00671"></a>00671                 }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673                 <span class="comment">// FARBORD</span>
<a name="l00674"></a>00674 
<a name="l00675"></a>00675                 <span class="keywordflow">if</span>(changeToFromFine) {
<a name="l00676"></a>00676                     change = <span class="keyword">true</span>;
<a name="l00677"></a>00677                     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>++;
<a name="l00678"></a>00678                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, srcSet) = <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>;
<a name="l00679"></a>00679                     <span class="keywordflow">if</span>((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==2)&amp;&amp;(debugCoarsening)) <a class="code" href="../../d1/d24/solver__class_8h.html#acb6b7fb0324ec761f88d893b53b5dd08">debugMarkCell</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k); 
<a name="l00680"></a>00680                     <span class="comment">// same as restr from fine func! not necessary ?!</span>
<a name="l00681"></a>00681                     <span class="comment">// coarseRestrictFromFine part </span>
<a name="l00682"></a>00682                 }
<a name="l00683"></a>00683             } <span class="comment">// only check empty cells</span>
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     }}} <span class="comment">// TEST!</span>
<a name="l00686"></a>00686     <span class="comment">//} // init done</span>
<a name="l00687"></a>00687     <span class="comment">// PASS 5 */</span>
<a name="l00688"></a>00688     } <span class="comment">// coarsening, PASS 4,5</span>
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="keywordflow">if</span>(!this-&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;adaptGrid&quot;</span>,<span class="stringliteral">&quot; for l&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; done &quot;</span> ); }
<a name="l00691"></a>00691     <span class="keywordflow">return</span> change;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">/*****************************************************************************/</span>
<a name="l00696"></a>00696 <span class="comment">/*****************************************************************************/</span>
<a name="l00697"></a>00697 
<a name="l00698"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aebf6979d9c02f7da128219f667c4da28">00698</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aebf6979d9c02f7da128219f667c4da28" title="cell restriction and prolongation">LbmFsgrSolver::coarseRestrictCell</a>(<span class="keywordtype">int</span> lev, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,<span class="keywordtype">int</span> j,<span class="keywordtype">int</span> k, <span class="keywordtype">int</span> srcSet, <span class="keywordtype">int</span> dstSet)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *ccel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev+1, 2*i,2*j,2*k,srcSet);
<a name="l00701"></a>00701     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *tcel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev  , i,j,k      ,dstSet);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho=0.0, ux=0.0, uy=0.0, uz=0.0;           
<a name="l00704"></a>00704     <span class="comment">//LbmFloat *ccel = NULL;</span>
<a name="l00705"></a>00705     <span class="comment">//LbmFloat *tcel = NULL;</span>
<a name="l00706"></a>00706 <span class="preprocessor">#if OPT3D==1 </span>
<a name="l00707"></a>00707 <span class="preprocessor"></span>    <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00708"></a>00708     <span class="comment">// for macro add</span>
<a name="l00709"></a>00709     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> usqr;
<a name="l00710"></a>00710     <span class="comment">//LbmFloat *addfcel, *dstcell;</span>
<a name="l00711"></a>00711     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqadd, lcsmqo, lcsmeq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00712"></a>00712     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmDstOmega, lcsmSrcOmega, lcsmdfscale;
<a name="l00713"></a>00713 <span class="preprocessor">#else // OPT3D==true </span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>    <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> df[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00715"></a>00715     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> omegaDst, omegaSrc;
<a name="l00716"></a>00716     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> feq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00717"></a>00717     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dfScale = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#afd13b945ab42fedc8082630dcd416014">mDfScaleUp</a>;
<a name="l00718"></a>00718 <span class="preprocessor">#endif // OPT3D==true </span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>
<a name="l00720"></a>00720 <span class="preprocessor">#               if OPT3D==0</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span>    <span class="comment">// add up weighted dfs</span>
<a name="l00722"></a>00722     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ df[l] = 0.0;}
<a name="l00723"></a>00723     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n=0;(n&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>); n++) { 
<a name="l00724"></a>00724         <span class="keywordtype">int</span> ni=2*i+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[n], nj=2*j+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[n], nk=2*k+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[n];
<a name="l00725"></a>00725         ccel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev+1, ni,nj,nk,srcSet);<span class="comment">// CFINTTEST</span>
<a name="l00726"></a>00726         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> weight = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60387fa1b8899deb8c6a484ab35a2939">mGaussw</a>[n];
<a name="l00727"></a>00727         <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{
<a name="l00728"></a>00728             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> cdf = weight * <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l);
<a name="l00729"></a>00729 <span class="preprocessor">#                       if FSGR_STRICT_DEBUG==1</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( cdf&lt;-1.0 ){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;INVDFCREST_DFCHECK&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; s&quot;</span>&lt;&lt;dstSet&lt;&lt;<span class="stringliteral">&quot; from &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#aa1f5d23ceba93fcb09cf2c2258fb3ba5">PRINT_VEC</a>(2*i,2*j,2*k)&lt;&lt;<span class="stringliteral">&quot; s&quot;</span>&lt;&lt;srcSet&lt;&lt;<span class="stringliteral">&quot; df&quot;</span>&lt;&lt;l&lt;&lt;<span class="stringliteral">&quot;:&quot;</span>&lt;&lt; df[l]); }
<a name="l00731"></a>00731 <span class="preprocessor">#                       endif</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>            <span class="comment">//errMsg(&quot;INVDFCREST_DFCHECK&quot;, PRINT_IJK&lt;&lt;&quot; s&quot;&lt;&lt;dstSet&lt;&lt;&quot; from &quot;&lt;&lt;PRINT_VEC(2*i,2*j,2*k)&lt;&lt;&quot; s&quot;&lt;&lt;srcSet&lt;&lt;&quot; df&quot;&lt;&lt;l&lt;&lt;&quot;:&quot;&lt;&lt; df[l]&lt;&lt;&quot; = &quot;&lt;&lt;cdf&lt;&lt;&quot; , w&quot;&lt;&lt;weight); </span>
<a name="l00733"></a>00733             df[l] += cdf;
<a name="l00734"></a>00734         }
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     <span class="comment">// calc rho etc. from weighted dfs</span>
<a name="l00738"></a>00738     rho = ux  = uy  = uz  = 0.0;
<a name="l00739"></a>00739     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{
<a name="l00740"></a>00740         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> cdf = df[l];
<a name="l00741"></a>00741         rho += cdf; 
<a name="l00742"></a>00742         ux  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*cdf); 
<a name="l00743"></a>00743         uy  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*cdf);  
<a name="l00744"></a>00744         uz  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*cdf);  
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ feq[l] = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, rho,ux,uy,uz); }
<a name="l00748"></a>00748     <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev  ].lcsmago&gt;0.0) {
<a name="l00749"></a>00749         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> Qo = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa41d1ea95667a655d2815455df964cdc">getLesNoneqTensorCoeff</a>(df,feq);
<a name="l00750"></a>00750         omegaDst  = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac8696739d80b280d9106e0edc1fd2491">getLesOmega</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev  ].omega,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev  ].lcsmago,Qo);
<a name="l00751"></a>00751         omegaSrc = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac8696739d80b280d9106e0edc1fd2491">getLesOmega</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].omega,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].lcsmago,Qo);
<a name="l00752"></a>00752     } <span class="keywordflow">else</span> {
<a name="l00753"></a>00753         omegaDst = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+0].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ac6762159f4cf08bae1f6209cdc8af72f" title="quadtree node relaxation parameter">omega</a>; <span class="comment">/* NEWSMAGOT*/</span> 
<a name="l00754"></a>00754         omegaSrc = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ac6762159f4cf08bae1f6209cdc8af72f" title="quadtree node relaxation parameter">omega</a>;
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756     dfScale   = (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev  ].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>)* (1.0/omegaDst-1.0)/ (1.0/omegaSrc-1.0); <span class="comment">// yu</span>
<a name="l00757"></a>00757     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{
<a name="l00758"></a>00758         <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = feq[l]+ (df[l]-feq[l])*dfScale;
<a name="l00759"></a>00759     } 
<a name="l00760"></a>00760 <span class="preprocessor">#               else // OPT3D</span>
<a name="l00761"></a>00761 <span class="preprocessor"></span>    <span class="comment">// similar to OPTIMIZED_STREAMCOLLIDE_UNUSED</span>
<a name="l00762"></a>00762                                 
<a name="l00763"></a>00763     <span class="comment">//rho = ux = uy = uz = 0.0;</span>
<a name="l00764"></a>00764     <a class="code" href="../../d2/d75/solver__relax_8h.html#ab44ddba9bf97d88cb5dd04a334619cc9">MSRC_C</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#a57c46eebd04425d755f164ff241e195a">CCELG_C</a>(0) ;
<a name="l00765"></a>00765     <a class="code" href="../../d2/d75/solver__relax_8h.html#af181a6fa81952fda1d26ea93e3e29453">MSRC_N</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#a33f138c78c7ae9f7c0ac390d1b762edc">CCELG_N</a>(0) ;
<a name="l00766"></a>00766     <a class="code" href="../../d2/d75/solver__relax_8h.html#a51ab534e760b44bd5c3cf43e6752e58b">MSRC_S</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#acd07c1326aaebe0fe66a78844c9636a3">CCELG_S</a>(0) ;
<a name="l00767"></a>00767     <a class="code" href="../../d2/d75/solver__relax_8h.html#a41c72e349125d505e4a3188fec24a025">MSRC_E</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#acf4b0e36f2dedfa9c5516b1bda3184e2">CCELG_E</a>(0) ;
<a name="l00768"></a>00768     <a class="code" href="../../d2/d75/solver__relax_8h.html#ac1a9710fbbbc71c7a9d8368518271dcb">MSRC_W</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#ae93299a77b665908ceabfd61c4d82a74">CCELG_W</a>(0) ;
<a name="l00769"></a>00769     <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d53cfd57f41ec9b0f236b4e08564a7f">MSRC_T</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#a0cd1def359c89976030177ba174a062e">CCELG_T</a>(0) ;
<a name="l00770"></a>00770     <a class="code" href="../../d2/d75/solver__relax_8h.html#a09a4b9690cd4c8b926598fb2bae3fa49">MSRC_B</a>  = <a class="code" href="../../d2/d75/solver__relax_8h.html#a9529331a296876d0b650aa9595565c40">CCELG_B</a>(0) ;
<a name="l00771"></a>00771     <a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a02b3519435b8e36df01c4a2538307367">CCELG_NE</a>(0);
<a name="l00772"></a>00772     <a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a64664ca4596629bfb33f897921d9d0d1">CCELG_NW</a>(0);
<a name="l00773"></a>00773     <a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#abe38994bf170d4f6d2687ff9a38f0f79">CCELG_SE</a>(0);
<a name="l00774"></a>00774     <a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a470e497bf0b6844dfb742b6fb748203a">CCELG_SW</a>(0);
<a name="l00775"></a>00775     <a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a8e84d4e0a493d7d1849b2a5196edaf66">CCELG_NT</a>(0);
<a name="l00776"></a>00776     <a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a713f4094cf7d31cdc8ec537654ecb6ce">CCELG_NB</a>(0);
<a name="l00777"></a>00777     <a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#ab75052c17d325da73c61ac65daa1d647">CCELG_ST</a>(0);
<a name="l00778"></a>00778     <a class="code" href="../../d2/d75/solver__relax_8h.html#a82cba2b66ae866f35533a0836440564f">MSRC_SB</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#ae44631c140a48b70bb29c1fde749aa29">CCELG_SB</a>(0);
<a name="l00779"></a>00779     <a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#aadf4d9ac4b5af6b5fb2fa48696dea7b7">CCELG_ET</a>(0);
<a name="l00780"></a>00780     <a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#a98bdde8586408680a1bd364cafee4311">CCELG_EB</a>(0);
<a name="l00781"></a>00781     <a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#aabd9f3e7ed09276d46016689c5107be7">CCELG_WT</a>(0);
<a name="l00782"></a>00782     <a class="code" href="../../d2/d75/solver__relax_8h.html#a25e545f58c560153b0f85739ec926047">MSRC_WB</a> = <a class="code" href="../../d2/d75/solver__relax_8h.html#aaf7f503f05d1445299be4e3edfc724fc">CCELG_WB</a>(0);
<a name="l00783"></a>00783     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n=1;(n&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad318550ee64256981c6300907035b054" title="direction vector contain vecs for all spatial dirs, even if not used for LBM model">cDirNum</a>); n++) { 
<a name="l00784"></a>00784         ccel = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(lev+1,  2*i+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[n], 2*j+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[n], 2*k+1*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[n]  ,srcSet);
<a name="l00785"></a>00785         <a class="code" href="../../d2/d75/solver__relax_8h.html#ab44ddba9bf97d88cb5dd04a334619cc9">MSRC_C</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#a57c46eebd04425d755f164ff241e195a">CCELG_C</a>(n) ;
<a name="l00786"></a>00786         <a class="code" href="../../d2/d75/solver__relax_8h.html#af181a6fa81952fda1d26ea93e3e29453">MSRC_N</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#a33f138c78c7ae9f7c0ac390d1b762edc">CCELG_N</a>(n) ;
<a name="l00787"></a>00787         <a class="code" href="../../d2/d75/solver__relax_8h.html#a51ab534e760b44bd5c3cf43e6752e58b">MSRC_S</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#acd07c1326aaebe0fe66a78844c9636a3">CCELG_S</a>(n) ;
<a name="l00788"></a>00788         <a class="code" href="../../d2/d75/solver__relax_8h.html#a41c72e349125d505e4a3188fec24a025">MSRC_E</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#acf4b0e36f2dedfa9c5516b1bda3184e2">CCELG_E</a>(n) ;
<a name="l00789"></a>00789         <a class="code" href="../../d2/d75/solver__relax_8h.html#ac1a9710fbbbc71c7a9d8368518271dcb">MSRC_W</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#ae93299a77b665908ceabfd61c4d82a74">CCELG_W</a>(n) ;
<a name="l00790"></a>00790         <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d53cfd57f41ec9b0f236b4e08564a7f">MSRC_T</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#a0cd1def359c89976030177ba174a062e">CCELG_T</a>(n) ;
<a name="l00791"></a>00791         <a class="code" href="../../d2/d75/solver__relax_8h.html#a09a4b9690cd4c8b926598fb2bae3fa49">MSRC_B</a>  += <a class="code" href="../../d2/d75/solver__relax_8h.html#a9529331a296876d0b650aa9595565c40">CCELG_B</a>(n) ;
<a name="l00792"></a>00792         <a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a02b3519435b8e36df01c4a2538307367">CCELG_NE</a>(n);
<a name="l00793"></a>00793         <a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a64664ca4596629bfb33f897921d9d0d1">CCELG_NW</a>(n);
<a name="l00794"></a>00794         <a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#abe38994bf170d4f6d2687ff9a38f0f79">CCELG_SE</a>(n);
<a name="l00795"></a>00795         <a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a470e497bf0b6844dfb742b6fb748203a">CCELG_SW</a>(n);
<a name="l00796"></a>00796         <a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a8e84d4e0a493d7d1849b2a5196edaf66">CCELG_NT</a>(n);
<a name="l00797"></a>00797         <a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a713f4094cf7d31cdc8ec537654ecb6ce">CCELG_NB</a>(n);
<a name="l00798"></a>00798         <a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#ab75052c17d325da73c61ac65daa1d647">CCELG_ST</a>(n);
<a name="l00799"></a>00799         <a class="code" href="../../d2/d75/solver__relax_8h.html#a82cba2b66ae866f35533a0836440564f">MSRC_SB</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#ae44631c140a48b70bb29c1fde749aa29">CCELG_SB</a>(n);
<a name="l00800"></a>00800         <a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#aadf4d9ac4b5af6b5fb2fa48696dea7b7">CCELG_ET</a>(n);
<a name="l00801"></a>00801         <a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#a98bdde8586408680a1bd364cafee4311">CCELG_EB</a>(n);
<a name="l00802"></a>00802         <a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#aabd9f3e7ed09276d46016689c5107be7">CCELG_WT</a>(n);
<a name="l00803"></a>00803         <a class="code" href="../../d2/d75/solver__relax_8h.html#a25e545f58c560153b0f85739ec926047">MSRC_WB</a> += <a class="code" href="../../d2/d75/solver__relax_8h.html#aaf7f503f05d1445299be4e3edfc724fc">CCELG_WB</a>(n);
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805     rho = <a class="code" href="../../d2/d75/solver__relax_8h.html#ab44ddba9bf97d88cb5dd04a334619cc9">MSRC_C</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#af181a6fa81952fda1d26ea93e3e29453">MSRC_N</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a51ab534e760b44bd5c3cf43e6752e58b">MSRC_S</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a41c72e349125d505e4a3188fec24a025">MSRC_E</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#ac1a9710fbbbc71c7a9d8368518271dcb">MSRC_W</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d53cfd57f41ec9b0f236b4e08564a7f">MSRC_T</a>  
<a name="l00806"></a>00806         + <a class="code" href="../../d2/d75/solver__relax_8h.html#a09a4b9690cd4c8b926598fb2bae3fa49">MSRC_B</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a> 
<a name="l00807"></a>00807         + <a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a82cba2b66ae866f35533a0836440564f">MSRC_SB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a25e545f58c560153b0f85739ec926047">MSRC_WB</a>; 
<a name="l00808"></a>00808     ux = <a class="code" href="../../d2/d75/solver__relax_8h.html#a41c72e349125d505e4a3188fec24a025">MSRC_E</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#ac1a9710fbbbc71c7a9d8368518271dcb">MSRC_W</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a> 
<a name="l00809"></a>00809         + <a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a25e545f58c560153b0f85739ec926047">MSRC_WB</a>;  
<a name="l00810"></a>00810     uy = <a class="code" href="../../d2/d75/solver__relax_8h.html#af181a6fa81952fda1d26ea93e3e29453">MSRC_N</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a51ab534e760b44bd5c3cf43e6752e58b">MSRC_S</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a> 
<a name="l00811"></a>00811         + <a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a82cba2b66ae866f35533a0836440564f">MSRC_SB</a>;  
<a name="l00812"></a>00812     uz = <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d53cfd57f41ec9b0f236b4e08564a7f">MSRC_T</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a09a4b9690cd4c8b926598fb2bae3fa49">MSRC_B</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a> - MSRC_SB 
<a name="l00813"></a>00813         + <a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a> - <a class="code" href="../../d2/d75/solver__relax_8h.html#a25e545f58c560153b0f85739ec926047">MSRC_WB</a>;  
<a name="l00814"></a>00814     usqr = 1.5 * (ux*ux + uy*uy + uz*uz);  \
<a name="l00815"></a>00815     \
<a name="l00816"></a>00816     lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a1bf027f76ae496c8acba42aeaf5c4a00">EQC</a> ; \
<a name="l00817"></a>00817     COLL_CALCULATE_DFEQ(lcsmeq); \
<a name="l00818"></a>00818     COLL_CALCULATE_NONEQTENSOR(lev+0, MSRC_ )\
<a name="l00819"></a>00819     COLL_CALCULATE_CSMOMEGAVAL(lev+0, lcsmDstOmega); \
<a name="l00820"></a>00820     COLL_CALCULATE_CSMOMEGAVAL(lev+1, lcsmSrcOmega); \
<a name="l00821"></a>00821     \
<a name="l00822"></a>00822     lcsmdfscale   = (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+0].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev+1].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>)* (1.0/lcsmDstOmega-1.0)/ (1.0/lcsmSrcOmega-1.0);  \
<a name="l00823"></a>00823     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#ab44ddba9bf97d88cb5dd04a334619cc9">MSRC_C</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a> ] )*lcsmdfscale);
<a name="l00824"></a>00824     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#af181a6fa81952fda1d26ea93e3e29453">MSRC_N</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> ] )*lcsmdfscale);
<a name="l00825"></a>00825     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a51ab534e760b44bd5c3cf43e6752e58b">MSRC_S</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ] )*lcsmdfscale);
<a name="l00826"></a>00826     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a41c72e349125d505e4a3188fec24a025">MSRC_E</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> ] )*lcsmdfscale);
<a name="l00827"></a>00827     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#ac1a9710fbbbc71c7a9d8368518271dcb">MSRC_W</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ] )*lcsmdfscale);
<a name="l00828"></a>00828     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d53cfd57f41ec9b0f236b4e08564a7f">MSRC_T</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> ] )*lcsmdfscale);
<a name="l00829"></a>00829     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a09a4b9690cd4c8b926598fb2bae3fa49">MSRC_B</a> -lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ] )*lcsmdfscale);
<a name="l00830"></a>00830     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a871ce2dc9e5bbb322c336c269bb4fd0e">MSRC_NE</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>] )*lcsmdfscale);
<a name="l00831"></a>00831     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#ac36d19dbbbc36f4ebb8cb0d7f6fcf0bd">MSRC_NW</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>] )*lcsmdfscale);
<a name="l00832"></a>00832     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a5ef90caaabc1b46a1c424990065a9fb7">MSRC_SE</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>] )*lcsmdfscale);
<a name="l00833"></a>00833     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a3ca748555859dfda4d0bb23a09458197">MSRC_SW</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>] )*lcsmdfscale);
<a name="l00834"></a>00834     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a4673aaa45649d305881e9aa5aa0e8edf">MSRC_NT</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>] )*lcsmdfscale);
<a name="l00835"></a>00835     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#abfa854478e08a3b69a156ef021b19774">MSRC_NB</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>] )*lcsmdfscale);
<a name="l00836"></a>00836     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#ac7ca45b17fce4c6dcfc5dca90a3b4f95">MSRC_ST</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>] )*lcsmdfscale);
<a name="l00837"></a>00837     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>] + (MSRC_SB-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>] )*lcsmdfscale);
<a name="l00838"></a>00838     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a34ea173bc81cb30721af0a8db9fa0d07">MSRC_ET</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>] )*lcsmdfscale);
<a name="l00839"></a>00839     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#a0f043c83bc012a696552b3e49cbc0edb">MSRC_EB</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>] )*lcsmdfscale);
<a name="l00840"></a>00840     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>] + (<a class="code" href="../../d2/d75/solver__relax_8h.html#adc55528a0cdd1763a9f4685ce5f242cb">MSRC_WT</a>-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>] )*lcsmdfscale);
<a name="l00841"></a>00841     <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>) = (lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>] + (MSRC_WB-lcsmeq[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>] )*lcsmdfscale);
<a name="l00842"></a>00842 <span class="preprocessor">#               endif // OPT3D==0</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span>}
<a name="l00844"></a>00844 
<a name="l00845"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114">00845</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">LbmFsgrSolver::interpolateCellFromCoarse</a>(<span class="keywordtype">int</span> lev, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <span class="keywordtype">int</span> j,<span class="keywordtype">int</span> k, <span class="keywordtype">int</span> dstSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> t, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagSet, <span class="keywordtype">bool</span> markNbs) {
<a name="l00846"></a>00846     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho=0.0, ux=0.0, uy=0.0, uz=0.0;
<a name="l00847"></a>00847     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> intDf[19] = { 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 <span class="preprocessor">#if OPT3D==1 </span>
<a name="l00850"></a>00850 <span class="preprocessor"></span>    <span class="comment">// for macro add</span>
<a name="l00851"></a>00851     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> addDfFacT, addVal, usqr;
<a name="l00852"></a>00852     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *addfcel, *dstcell;
<a name="l00853"></a>00853     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqadd, lcsmqo, lcsmeq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00854"></a>00854     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmDstOmega, lcsmSrcOmega, lcsmdfscale;
<a name="l00855"></a>00855 <span class="preprocessor">#endif // OPT3D==true </span>
<a name="l00856"></a>00856 <span class="preprocessor"></span>
<a name="l00857"></a>00857     <span class="comment">// SET required nbs to from coarse (this might overwrite flag several times)</span>
<a name="l00858"></a>00858     <span class="comment">// this is not necessary for interpolateFineFromCoarse</span>
<a name="l00859"></a>00859     <span class="keywordflow">if</span>(markNbs) {
<a name="l00860"></a>00860     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a>{ 
<a name="l00861"></a>00861         <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l00862"></a>00862         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,ni,nj,nk,dstSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>) {
<a name="l00863"></a>00863             <span class="comment">// parents have to be inited!</span>
<a name="l00864"></a>00864             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>(lev, ni, nj, nk, dstSet, t, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>, <span class="keyword">false</span>);
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866     } }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">// change flag of cell to be interpolated</span>
<a name="l00869"></a>00869     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,i,j,k, dstSet) = flagSet;
<a name="l00870"></a>00870     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a892c4c850e08c8b2c3cdefe271941c75" title="fluid stats">mNumInterdCells</a>++;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <span class="comment">// interpolation lines...</span>
<a name="l00873"></a>00873     <span class="keywordtype">int</span> betx = i&amp;1;
<a name="l00874"></a>00874     <span class="keywordtype">int</span> bety = j&amp;1;
<a name="l00875"></a>00875     <span class="keywordtype">int</span> betz = k&amp;1;
<a name="l00876"></a>00876     
<a name="l00877"></a>00877     <span class="keywordflow">if</span>((!betx) &amp;&amp; (!bety) &amp;&amp; (!betz)) {
<a name="l00878"></a>00878         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, i/2  ,j/2  ,k/2  , 0.0, 1.0);
<a name="l00879"></a>00879     }
<a name="l00880"></a>00880     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(( betx) &amp;&amp; (!bety) &amp;&amp; (!betz)) {
<a name="l00881"></a>00881         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00882"></a>00882         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((!betx) &amp;&amp; ( bety) &amp;&amp; (!betz)) {
<a name="l00885"></a>00885         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00886"></a>00886         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((!betx) &amp;&amp; (!bety) &amp;&amp; ( betz)) {
<a name="l00889"></a>00889         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00890"></a>00890         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#ad8d55c6b37106e3ce9fdc428f7bea6ae">WO1D1</a>);
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(( betx) &amp;&amp; ( bety) &amp;&amp; (!betz)) {
<a name="l00893"></a>00893         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00894"></a>00894         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00895"></a>00895         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00896"></a>00896         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00897"></a>00897     }
<a name="l00898"></a>00898     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((!betx) &amp;&amp; ( bety) &amp;&amp; ( betz)) {
<a name="l00899"></a>00899         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00900"></a>00900         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00901"></a>00901         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00902"></a>00902         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(( betx) &amp;&amp; (!bety) &amp;&amp; ( betz)) {
<a name="l00905"></a>00905         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00906"></a>00906         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00907"></a>00907         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00908"></a>00908         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a279dd6efc978bd18f588509229ab64ea">WO1D2</a>);
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(( betx) &amp;&amp; ( bety) &amp;&amp; ( betz)) {
<a name="l00911"></a>00911         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00912"></a>00912         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00913"></a>00913         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00914"></a>00914         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)  ,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00915"></a>00915         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00916"></a>00916         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)+1,(k/2)  , t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00917"></a>00917         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)  ,(j/2)+1,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00918"></a>00918         <a class="code" href="../../d2/d75/solver__relax_8h.html#aac6dbf2f47fab0f073e12b19bf6e5913">ADD_INT_DFS</a>(lev-1, (i/2)+1,(j/2)+1,(k/2)+1, t, <a class="code" href="../../d2/d75/solver__relax_8h.html#a9ef972bf9c21dbe48bb84fbd87296e01">WO1D3</a>);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920     <span class="keywordflow">else</span> {
<a name="l00921"></a>00921         <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>;
<a name="l00922"></a>00922         <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;interpolateCellFromCoarse&quot;</span>,<span class="stringliteral">&quot;Invalid!?&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#af2f6eab59be57681799dbee88ff4c4a7">SIMWORLD_GENERICERROR</a>);   
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="../../d2/d75/solver__relax_8h.html#a18c311f181e79d2df5383d81fa00cae0">IDF_WRITEBACK</a>;
<a name="l00926"></a>00926     <span class="keywordflow">return</span>;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <span class="comment">// required globals</span>
<a name="l00932"></a>00932 <span class="keyword">extern</span> <span class="keywordtype">bool</span> <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>;
<a name="l00933"></a>00933 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#ab6ff78cb4ce2a353f47a92a3c21018f8">glob_mpnum</a>, <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>;
<a name="l00934"></a><a class="code" href="../../df/dbf/solver__adap_8cpp.html#a0099d8724db6caad1a3c8188f5a73a8c">00934</a> <span class="preprocessor">#define MPTADAP_INTERV 4</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>
<a name="l00936"></a>00936 <span class="comment">/*****************************************************************************/</span>
<a name="l00938"></a>00938 <span class="comment">/*****************************************************************************/</span>
<a name="l00939"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac54636f91eb5017737efb7598baf53b3">00939</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac54636f91eb5017737efb7598baf53b3">LbmFsgrSolver::adaptTimestep</a>() {
<a name="l00940"></a>00940     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> massTOld=0.0, massTNew=0.0;
<a name="l00941"></a>00941     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> volTOld=0.0, volTNew=0.0;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="keywordtype">bool</span> rescale = <span class="keyword">false</span>;  <span class="comment">// do any rescale at all?</span>
<a name="l00944"></a>00944     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> scaleFac = -1.0; <span class="comment">// timestep scaling</span>
<a name="l00945"></a>00945     <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a951ca2c1f15762c719324dfb525a6c31">mPanic</a>) <span class="keywordflow">return</span>;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> levOldOmega[<a class="code" href="../../d1/d24/solver__class_8h.html#a941a5274e5be5fa2452b380a17449c38" title="maxmimum no. of grid levels">FSGR_MAXNOOFLEVELS</a>];
<a name="l00948"></a>00948     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> levOldStepsize[<a class="code" href="../../d1/d24/solver__class_8h.html#a941a5274e5be5fa2452b380a17449c38" title="maxmimum no. of grid levels">FSGR_MAXNOOFLEVELS</a>];
<a name="l00949"></a>00949     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>; lev&gt;=0 ; lev--) {
<a name="l00950"></a>00950         levOldOmega[lev] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ac6762159f4cf08bae1f6209cdc8af72f" title="quadtree node relaxation parameter">omega</a>;
<a name="l00951"></a>00951         levOldStepsize[lev] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>;
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> reduceFac = 0.8;          <span class="comment">// modify time step by 20%, TODO? do multiple times for large changes?</span>
<a name="l00955"></a>00955     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> diffPercent = 0.05; <span class="comment">// dont scale if less than 5%</span>
<a name="l00956"></a>00956     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> allowMax = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#adabdfa5ad1fdaae5517c0610c4a67c46">getTadapMaxSpeed</a>();  <span class="comment">// maximum allowed velocity</span>
<a name="l00957"></a>00957     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nextmax = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a352a07d62c218dc7e8f8ce6526c752c2">getSimulationMaxSpeed</a>() + <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].gravity);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="comment">// sync nextmax</span>
<a name="l00960"></a>00960 <span class="preprocessor">#if LBM_INCLUDE_TESTSOLVERS==1</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>) {
<a name="l00962"></a>00962         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lsteps % <a class="code" href="../../df/dbf/solver__adap_8cpp.html#a0099d8724db6caad1a3c8188f5a73a8c">MPTADAP_INTERV</a> != <a class="code" href="../../df/dbf/solver__adap_8cpp.html#a0099d8724db6caad1a3c8188f5a73a8c">MPTADAP_INTERV</a>-1) {
<a name="l00963"></a>00963             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::TAdp&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <span class="stringliteral">&quot;mpact:&quot;</span>&lt;&lt;<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>&lt;&lt;<span class="stringliteral">&quot;/&quot;</span>&lt;&lt;<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#ab6ff78cb4ce2a353f47a92a3c21018f8">glob_mpnum</a>&lt;&lt;<span class="stringliteral">&quot; step:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lsteps&lt;&lt;<span class="stringliteral">&quot; skipping tadap...&quot;</span>,8);
<a name="l00964"></a>00964             <span class="keywordflow">return</span>;
<a name="l00965"></a>00965         }
<a name="l00966"></a>00966         nextmax = mrInitTadap(nextmax);
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968 <span class="preprocessor">#endif // LBM_INCLUDE_TESTSOLVERS==1</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>
<a name="l00970"></a>00970     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> newdt = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>(); <span class="comment">// newtr</span>
<a name="l00971"></a>00971     <span class="keywordflow">if</span>(nextmax &gt; allowMax/reduceFac) {
<a name="l00972"></a>00972         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a65e01463bba126f4563cb9a8207764da">mTimeMaxvelStepCnt</a>++; }
<a name="l00973"></a>00973     <span class="keywordflow">else</span> { <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a65e01463bba126f4563cb9a8207764da">mTimeMaxvelStepCnt</a>=0; }
<a name="l00974"></a>00974     
<a name="l00975"></a>00975     <span class="comment">// emergency, or 10 steps with high vel</span>
<a name="l00976"></a>00976     <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a65e01463bba126f4563cb9a8207764da">mTimeMaxvelStepCnt</a>&gt;5) || (nextmax&gt; (1.0/3.0)) || (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2801d5f27fdcfb5709e3cd735fdff8ad" title="force smaller timestep for next LBM step? (eg for mov obj)">mForceTimeStepReduce</a>) ) {
<a name="l00977"></a>00977         newdt = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>() * reduceFac;
<a name="l00978"></a>00978     } <span class="keywordflow">else</span> {
<a name="l00979"></a>00979         <span class="keywordflow">if</span>(nextmax&lt;allowMax*reduceFac) {
<a name="l00980"></a>00980             newdt = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>() / reduceFac;
<a name="l00981"></a>00981         }
<a name="l00982"></a>00982     } <span class="comment">// newtr</span>
<a name="l00983"></a>00983     <span class="comment">//errMsg(&quot;LbmFsgrSolver::adaptTimestep&quot;,&quot;nextmax=&quot;&lt;&lt;nextmax&lt;&lt;&quot; allowMax=&quot;&lt;&lt;allowMax&lt;&lt;&quot; fac=&quot;&lt;&lt;reduceFac&lt;&lt;&quot; simmaxv=&quot;&lt;&lt; mpParam-&gt;getSimulationMaxSpeed() );</span>
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <span class="keywordtype">bool</span> minCutoff = <span class="keyword">false</span>;
<a name="l00986"></a>00986     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> desireddt = newdt;
<a name="l00987"></a>00987     <span class="keywordflow">if</span>(newdt&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a76db5c9a46030c9efdb74271353eb149">getMaxTimestep</a>()){ newdt = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a76db5c9a46030c9efdb74271353eb149">getMaxTimestep</a>(); }
<a name="l00988"></a>00988     <span class="keywordflow">if</span>(newdt&lt;mpParam-&gt;getMinTimestep()){ 
<a name="l00989"></a>00989         newdt = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a04254e9ea1ed18c6e9a01950e3aac121">getMinTimestep</a>(); 
<a name="l00990"></a>00990         <span class="keywordflow">if</span>(nextmax&gt;allowMax/reduceFac){ minCutoff=<span class="keyword">true</span>; } <span class="comment">// only if really large vels...</span>
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dtdiff = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(newdt - <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>());
<a name="l00994"></a>00994     <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>) {
<a name="l00995"></a>00995         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::TAdp&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <span class="stringliteral">&quot;new&quot;</span>&lt;&lt;newdt
<a name="l00996"></a>00996             &lt;&lt;<span class="stringliteral">&quot; max&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a76db5c9a46030c9efdb74271353eb149">getMaxTimestep</a>()&lt;&lt;<span class="stringliteral">&quot; min&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a04254e9ea1ed18c6e9a01950e3aac121">getMinTimestep</a>()&lt;&lt;<span class="stringliteral">&quot; diff&quot;</span>&lt;&lt;dtdiff
<a name="l00997"></a>00997             &lt;&lt;<span class="stringliteral">&quot; simt:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>&lt;&lt;<span class="stringliteral">&quot; minsteps:&quot;</span>&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa8adf8187f0332ae52746f563d6c792f">mMaxTimestep</a>)&lt;&lt;<span class="stringliteral">&quot; maxsteps:&quot;</span>&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af54e1db87b22ae425684466e014f16f6" title="smallest and largest step size so far">mMinTimestep</a>)&lt;&lt;
<a name="l00998"></a>00998             <span class="stringliteral">&quot; olddt&quot;</span>&lt;&lt;levOldStepsize[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>]&lt;&lt;<span class="stringliteral">&quot; redlock&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0a5a1a59b8b32e12d86235f444e09007" title="lock time step down switching">mTimestepReduceLock</a> 
<a name="l00999"></a>00999             , 10); }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001     <span class="comment">// in range, and more than X% change?</span>
<a name="l01002"></a>01002     <span class="comment">//if( newdt &lt;  mpParam-&gt;getTimestep() ) // DEBUG</span>
<a name="l01003"></a>01003     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rhoAvg = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadde2333da700e8b59fdec8ce3a2a21d">mCurrentVolume</a>;
<a name="l01004"></a>01004     <span class="keywordflow">if</span>( (newdt&lt;=mpParam-&gt;getMaxTimestep()) &amp;&amp; (newdt&gt;=<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a04254e9ea1ed18c6e9a01950e3aac121">getMinTimestep</a>()) 
<a name="l01005"></a>01005             &amp;&amp; (dtdiff&gt;(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>()*diffPercent)) ) {
<a name="l01006"></a>01006         <span class="keywordflow">if</span>((newdt&gt;levOldStepsize[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>])&amp;&amp;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0a5a1a59b8b32e12d86235f444e09007" title="lock time step down switching">mTimestepReduceLock</a>)) {
<a name="l01007"></a>01007             <span class="comment">// wait some more...</span>
<a name="l01008"></a>01008             <span class="comment">//debMsgNnl(&quot;LbmFsgrSolver::TAdp&quot;,DM_NOTIFY,&quot; Delayed... &quot;&lt;&lt;mTimestepReduceLock&lt;&lt;&quot; &quot;,10);</span>
<a name="l01009"></a>01009             <a class="code" href="../../de/df0/utilities_8h.html#a53a891c94e097c591c694e21d6aaded4">debMsgDirect</a>(<span class="stringliteral">&quot;D&quot;</span>);
<a name="l01010"></a>01010         } <span class="keywordflow">else</span> {
<a name="l01011"></a>01011             <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a09d065df07cd4e772f9ae8bfffa1b0b6">setDesiredTimestep</a>( newdt );
<a name="l01012"></a>01012             rescale = <span class="keyword">true</span>;
<a name="l01013"></a>01013             <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>) {
<a name="l01014"></a>01014                 <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::TAdp&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;\n\n\n\n&quot;</span>,10);
<a name="l01015"></a>01015                 <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::TAdp&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;Timestep changing: new=&quot;</span>&lt;&lt;newdt&lt;&lt;<span class="stringliteral">&quot; old=&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>()
<a name="l01016"></a>01016                         &lt;&lt;<span class="stringliteral">&quot; maxSpeed:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a352a07d62c218dc7e8f8ce6526c752c2">getSimulationMaxSpeed</a>()&lt;&lt;<span class="stringliteral">&quot; next:&quot;</span>&lt;&lt;nextmax&lt;&lt;<span class="stringliteral">&quot; step:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>, 10 );
<a name="l01017"></a>01017                 <span class="comment">//debMsgStd(&quot;LbmFsgrSolver::TAdp&quot;,DM_NOTIFY,&quot;Timestep changing: &quot;&lt;&lt; &quot;rhoAvg=&quot;&lt;&lt;rhoAvg&lt;&lt;&quot; cMass=&quot;&lt;&lt;mCurrentMass&lt;&lt;&quot; cVol=&quot;&lt;&lt;mCurrentVolume,10);</span>
<a name="l01018"></a>01018             }
<a name="l01019"></a>01019         } <span class="comment">// really change dt</span>
<a name="l01020"></a>01020     }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0a5a1a59b8b32e12d86235f444e09007" title="lock time step down switching">mTimestepReduceLock</a>&gt;0) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0a5a1a59b8b32e12d86235f444e09007" title="lock time step down switching">mTimestepReduceLock</a>--;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     
<a name="l01025"></a>01025     <span class="comment">// forced back and forth switchting (for testing)</span>
<a name="l01026"></a>01026     <span class="comment">/*const int tadtogInter = 100;</span>
<a name="l01027"></a>01027 <span class="comment">    const double tadtogSwitch = 0.66;</span>
<a name="l01028"></a>01028 <span class="comment">    errMsg(&quot;TIMESWITCHTOGGLETEST&quot;,&quot;warning enabled &quot;&lt;&lt; tadtogSwitch&lt;&lt;&quot;,&quot;&lt;&lt;tadtogSwitch&lt;&lt;&quot; !!!!!!!!!!!!!!!!!!!&quot;);</span>
<a name="l01029"></a>01029 <span class="comment">    if( ((mStepCnt% tadtogInter)== (tadtogInter/4*1)-1) ||</span>
<a name="l01030"></a>01030 <span class="comment">        ((mStepCnt% tadtogInter)== (tadtogInter/4*2)-1) ){</span>
<a name="l01031"></a>01031 <span class="comment">        rescale = true; minCutoff = false;</span>
<a name="l01032"></a>01032 <span class="comment">        newdt = tadtogSwitch * mpParam-&gt;getTimestep();</span>
<a name="l01033"></a>01033 <span class="comment">        mpParam-&gt;setDesiredTimestep( newdt );</span>
<a name="l01034"></a>01034 <span class="comment">    } else </span>
<a name="l01035"></a>01035 <span class="comment">    if( ((mStepCnt% tadtogInter)== (tadtogInter/4*3)-1) ||</span>
<a name="l01036"></a>01036 <span class="comment">        ((mStepCnt% tadtogInter)== (tadtogInter/4*4)-1) ){</span>
<a name="l01037"></a>01037 <span class="comment">        rescale = true; minCutoff = false;</span>
<a name="l01038"></a>01038 <span class="comment">        newdt = mpParam-&gt;getTimestep()/tadtogSwitch ;</span>
<a name="l01039"></a>01039 <span class="comment">        mpParam-&gt;setDesiredTimestep( newdt );</span>
<a name="l01040"></a>01040 <span class="comment">    } else {</span>
<a name="l01041"></a>01041 <span class="comment">        rescale = false; minCutoff = false;</span>
<a name="l01042"></a>01042 <span class="comment">    }</span>
<a name="l01043"></a>01043 <span class="comment">    // */</span>
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="comment">// test mass rescale</span>
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     scaleFac = newdt/<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>();
<a name="l01048"></a>01048     <span class="keywordflow">if</span>(rescale) {
<a name="l01049"></a>01049         <span class="comment">// perform acutal rescaling...</span>
<a name="l01050"></a>01050         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a65e01463bba126f4563cb9a8207764da">mTimeMaxvelStepCnt</a>=0; 
<a name="l01051"></a>01051         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2801d5f27fdcfb5709e3cd735fdff8ad" title="force smaller timestep for next LBM step? (eg for mov obj)">mForceTimeStepReduce</a> = <span class="keyword">false</span>;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         <span class="comment">// FIXME - approximate by averaging, take gravity direction here?</span>
<a name="l01054"></a>01054         <span class="comment">//mTimestepReduceLock = 4*(mLevel[mMaxRefine].lSizey+mLevel[mMaxRefine].lSizez+mLevel[mMaxRefine].lSizex)/3;</span>
<a name="l01055"></a>01055         <span class="comment">// use z as gravity direction</span>
<a name="l01056"></a>01056         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0a5a1a59b8b32e12d86235f444e09007" title="lock time step down switching">mTimestepReduceLock</a> = 4*<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2991956e53ba783f0c875bc177ce74da">lSizez</a>;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7f5edad200c90c474a24dbe5594cd2a3" title="count no. of switches">mTimeSwitchCounts</a>++;
<a name="l01059"></a>01059         <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ae56423aa4fc6327fdbbc79f1b0ea959f">calculateAllMissingValues</a>( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>, <a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a> );
<a name="l01060"></a>01060         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a82c5192861cccab2c23bb463a6b200ff" title="init mObjectSpeeds for current parametrization">recalculateObjectSpeeds</a>();
<a name="l01061"></a>01061         <span class="comment">// calc omega, force for all levels</span>
<a name="l01062"></a>01062         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a995fb2471db6427a7fa58c1ddbc61b10">mLastOmega</a>=1e10; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad7006537d517844b481f420234d4651b">mLastGravity</a>=1e10;
<a name="l01063"></a>01063         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1eedd6b2c8bd318a4cdd4e868d41c1eb" title="Initialize omegas and forces on all levels (for init/timestep change)">initLevelOmegas</a>();
<a name="l01064"></a>01064         <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>()&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af54e1db87b22ae425684466e014f16f6" title="smallest and largest step size so far">mMinTimestep</a>) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af54e1db87b22ae425684466e014f16f6" title="smallest and largest step size so far">mMinTimestep</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>();
<a name="l01065"></a>01065         <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>()&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa8adf8187f0332ae52746f563d6c792f">mMaxTimestep</a>) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa8adf8187f0332ae52746f563d6c792f">mMaxTimestep</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>();
<a name="l01066"></a>01066 
<a name="l01067"></a>01067         <span class="comment">// this might be called during init, before we have any particles</span>
<a name="l01068"></a>01068         <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a5bbaae326effab891ecad2f6f9bf4b0d" title="store particle tracer">mpParticles</a>) { <a class="code" href="../../db/dff/classLbmSolverInterface.html#a5bbaae326effab891ecad2f6f9bf4b0d" title="store particle tracer">mpParticles</a>-&gt;<a class="code" href="../../de/db7/classParticleTracer.html#a20ff86cb74c651cadf86703405eac868" title="adapt time step by rescaling velocities">adaptPartTimestep</a>(scaleFac); }
<a name="l01069"></a>01069 <span class="preprocessor">#if LBM_INCLUDE_TESTSOLVERS==1</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>        <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3cbbe08b78aafee0bf1572e5bae2d811">mUseTestdata</a>)&amp;&amp;(mpTest)) { 
<a name="l01071"></a>01071             mpTest-&gt;adaptTimestep(scaleFac, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].omega, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].timestep, <a class="code" href="../../d2/d3c/solver__interface_8h.html#af54079b72428ed222b2063d35bb5a88d">vec2L</a>( <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ab7bb4a73d49cd7ad9e7a304f272ac7b6">calculateGravity</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>)) ); 
<a name="l01072"></a>01072             mpTest-&gt;mGrav3d = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aee10f28f4bb002854da33f2d08053df1" title="gravity force for this level">gravity</a>;
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074 <span class="preprocessor">#endif // LBM_INCLUDE_TESTSOLVERS!=1</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span>    
<a name="l01076"></a>01076         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>; lev&gt;=0 ; lev--) {
<a name="l01077"></a>01077             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> newSteptime = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>;
<a name="l01078"></a>01078             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dfScaleFac = (newSteptime/1.0)/(levOldStepsize[lev]/levOldOmega[lev]);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080             <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>) {
<a name="l01081"></a>01081                 <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::TAdp&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;Level: &quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; Timestep chlevel: &quot;</span>&lt;&lt;
<a name="l01082"></a>01082                         <span class="stringliteral">&quot; scaleFac=&quot;</span>&lt;&lt;dfScaleFac&lt;&lt;<span class="stringliteral">&quot; newDt=&quot;</span>&lt;&lt;newSteptime&lt;&lt;<span class="stringliteral">&quot; newOmega=&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].omega,10);
<a name="l01083"></a>01083             }
<a name="l01084"></a>01084             <span class="keywordflow">if</span>(lev!=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a011f87da2814c6edcd0af14c33337650" title="update flux area values on coarse grids">coarseCalculateFluxareas</a>(lev);
<a name="l01085"></a>01085 
<a name="l01086"></a>01086             <span class="keywordtype">int</span> wss = 0, wse = 1;
<a name="l01087"></a>01087             <span class="comment">// only change currset (necessary for compressed grids, better for non-compr.gr.)</span>
<a name="l01088"></a>01088             wss = wse = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l01089"></a>01089             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> workSet = wss; workSet&lt;=wse; workSet++) { <span class="comment">// COMPRT</span>
<a name="l01090"></a>01090                     <span class="comment">// warning - check sets for higher levels...?</span>
<a name="l01091"></a>01091                 <a class="code" href="../../d1/d24/solver__class_8h.html#a1cd53306465fab36f6bc4c1d8ef9d291">FSGR_FORIJK1</a>(lev) {
<a name="l01092"></a>01092                     <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a3da81e6afe79d9cbe4361ebb7d099172">CFBndMoving</a>) ) {
<a name="l01093"></a>01093                         <span class="comment">/*</span>
<a name="l01094"></a>01094 <span class="comment">                        // paranoid check - shouldnt be necessary!</span>
<a name="l01095"></a>01095 <span class="comment">                        if(QCELL(lev, i, j, k, workSet, dFlux)!=mSimulationTime) {</span>
<a name="l01096"></a>01096 <span class="comment">                            errMsg(&quot;TTTT&quot;,&quot;found invalid bnd cell.... removing at &quot;&lt;&lt;PRINT_IJK);</span>
<a name="l01097"></a>01097 <span class="comment">                            RFLAG(lev,i,j,k, workSet) = CFInter;</span>
<a name="l01098"></a>01098 <span class="comment">                            // init empty zero vel  interface cell...</span>
<a name="l01099"></a>01099 <span class="comment">                            initVelocityCell(lev, i,j,k, CFInter, 1.0, 0.01, LbmVec(0.) );</span>
<a name="l01100"></a>01100 <span class="comment">                        } else {// */</span>
<a name="l01101"></a>01101                             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01102"></a>01102                                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, l)* scaleFac; 
<a name="l01103"></a>01103                             }
<a name="l01104"></a>01104                         <span class="comment">//} //  ok</span>
<a name="l01105"></a>01105                         <span class="keywordflow">continue</span>;
<a name="l01106"></a>01106                     }
<a name="l01107"></a>01107                     <span class="keywordflow">if</span>( 
<a name="l01108"></a>01108                             (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>) || 
<a name="l01109"></a>01109                             (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) ||
<a name="l01110"></a>01110                             (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) || 
<a name="l01111"></a>01111                             (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) || 
<a name="l01112"></a>01112                             (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>) 
<a name="l01113"></a>01113                             ) {
<a name="l01114"></a>01114                         <span class="comment">// these cells have to be scaled...</span>
<a name="l01115"></a>01115                     } <span class="keywordflow">else</span> {
<a name="l01116"></a>01116                         <span class="keywordflow">continue</span>;
<a name="l01117"></a>01117                     }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119                     <span class="comment">// collide on current set</span>
<a name="l01120"></a>01120                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rhoOld;
<a name="l01121"></a>01121                     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> velOld;
<a name="l01122"></a>01122                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho, ux,uy,uz;
<a name="l01123"></a>01123                     rho=0.0; ux =  uy = uz = 0.0;
<a name="l01124"></a>01124                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01125"></a>01125                         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, l); 
<a name="l01126"></a>01126                         rho += m;
<a name="l01127"></a>01127                         ux  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*m);
<a name="l01128"></a>01128                         uy  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*m); 
<a name="l01129"></a>01129                         uz  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*m); 
<a name="l01130"></a>01130                     } 
<a name="l01131"></a>01131                     rhoOld = rho;
<a name="l01132"></a>01132                     velOld = <a class="code" href="../../d2/d3c/solver__interface_8h.html#abde65d221fe8c68b1ec7abebb43726f5">LbmVec</a>(ux,uy,uz);
<a name="l01133"></a>01133 
<a name="l01134"></a>01134                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rhoNew = (rhoOld-rhoAvg)*scaleFac +rhoAvg;
<a name="l01135"></a>01135                     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> velNew = velOld * scaleFac;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> df[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01138"></a>01138                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> feqOld[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01139"></a>01139                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> feqNew[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01140"></a>01140                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01141"></a>01141                         feqOld[l] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l,rhoOld, velOld[0],velOld[1],velOld[2] );
<a name="l01142"></a>01142                         feqNew[l] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l,rhoNew, velNew[0],velNew[1],velNew[2] );
<a name="l01143"></a>01143                         df[l] = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, l);
<a name="l01144"></a>01144                     }
<a name="l01145"></a>01145                     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> Qo = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa41d1ea95667a655d2815455df964cdc">getLesNoneqTensorCoeff</a>(df,feqOld);
<a name="l01146"></a>01146                     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> oldOmega = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac8696739d80b280d9106e0edc1fd2491">getLesOmega</a>(levOldOmega[lev], <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lcsmago,Qo);
<a name="l01147"></a>01147                     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> newOmega = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac8696739d80b280d9106e0edc1fd2491">getLesOmega</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].omega,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].lcsmago,Qo);
<a name="l01148"></a>01148                     <span class="comment">//newOmega = mLevel[lev].omega; // FIXME debug test</span>
<a name="l01149"></a>01149 
<a name="l01150"></a>01150                     <span class="comment">//LbmFloat dfScaleFac = (newSteptime/1.0)/(levOldStepsize[lev]/levOldOmega[lev]);</span>
<a name="l01151"></a>01151                     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dfScale = (newSteptime/newOmega)/(levOldStepsize[lev]/oldOmega);
<a name="l01152"></a>01152                     <span class="comment">//dfScale = dfScaleFac/newOmega;</span>
<a name="l01153"></a>01153                     
<a name="l01154"></a>01154                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01155"></a>01155                         <span class="comment">// org scaling</span>
<a name="l01156"></a>01156                         <span class="comment">//df = eqOld + (df-eqOld)*dfScale; df *= (eqNew/eqOld); // non-eq. scaling, important</span>
<a name="l01157"></a>01157                         <span class="comment">// new scaling</span>
<a name="l01158"></a>01158                         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dfn = feqNew[l] + (df[l]-feqOld[l])*dfScale*feqNew[l]/feqOld[l]; <span class="comment">// non-eq. scaling, important</span>
<a name="l01159"></a>01159                         <span class="comment">//df = eqNew + (df-eqOld)*dfScale; // modified ig scaling, no real difference?</span>
<a name="l01160"></a>01160                         <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, l) = dfn;
<a name="l01161"></a>01161                     }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; CFInter) {
<a name="l01164"></a>01164                         <span class="comment">//if(workSet==mLevel[lev].setCurr) </span>
<a name="l01165"></a>01165                         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> area = 1.0;
<a name="l01166"></a>01166                         <span class="keywordflow">if</span>(lev!=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) area = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>);
<a name="l01167"></a>01167                         massTOld += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) * area;
<a name="l01168"></a>01168                         volTOld += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170                         <span class="comment">// wrong... QCELL(i,j,k,workSet, dMass] = (QCELL(i,j,k,workSet, dFfrac]*rhoNew);</span>
<a name="l01171"></a>01171                         <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = (<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>)/rhoOld*rhoNew);
<a name="l01172"></a>01172                         <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = (<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>)/rhoNew);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                         <span class="comment">//if(workSet==mLevel[lev].setCurr) </span>
<a name="l01175"></a>01175                         massTNew += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>);
<a name="l01176"></a>01176                         volTNew += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>);
<a name="l01177"></a>01177                     }
<a name="l01178"></a>01178                     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; CFFluid) { <span class="comment">// DEBUG</span>
<a name="l01179"></a>01179                         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; (CFGrFromFine|CFGrFromCoarse)) { <span class="comment">// DEBUG</span>
<a name="l01180"></a>01180                             <span class="comment">// dont include </span>
<a name="l01181"></a>01181                         } <span class="keywordflow">else</span> {
<a name="l01182"></a>01182                             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> area = 1.0;
<a name="l01183"></a>01183                             <span class="keywordflow">if</span>(lev!=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) area = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) * <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a81435c55b002d65b7e0ca201a1fef155">lcellfactor</a>;
<a name="l01184"></a>01184                             <span class="comment">//if(workSet==mLevel[lev].setCurr) </span>
<a name="l01185"></a>01185                             massTOld += rhoOld*area;
<a name="l01186"></a>01186                             <span class="comment">//if(workSet==mLevel[lev].setCurr) </span>
<a name="l01187"></a>01187                             massTNew += rhoNew*area;
<a name="l01188"></a>01188                             volTOld += area;
<a name="l01189"></a>01189                             volTNew += area;
<a name="l01190"></a>01190                         }
<a name="l01191"></a>01191                     }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193                 } <span class="comment">// IJK</span>
<a name="l01194"></a>01194             } <span class="comment">// workSet</span>
<a name="l01195"></a>01195 
<a name="l01196"></a>01196         } <span class="comment">// lev</span>
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>) {
<a name="l01199"></a>01199             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::step&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;REINIT DONE &quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>&lt;&lt;
<a name="l01200"></a>01200                     <span class="stringliteral">&quot; no&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7f5edad200c90c474a24dbe5594cd2a3" title="count no. of switches">mTimeSwitchCounts</a>&lt;&lt;<span class="stringliteral">&quot; maxdt&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aa8adf8187f0332ae52746f563d6c792f">mMaxTimestep</a>&lt;&lt;
<a name="l01201"></a>01201                     <span class="stringliteral">&quot; mindt&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#af54e1db87b22ae425684466e014f16f6" title="smallest and largest step size so far">mMinTimestep</a>&lt;&lt;<span class="stringliteral">&quot; currdt&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].timestep, 10);
<a name="l01202"></a>01202             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::step&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;REINIT DONE  masst:&quot;</span>&lt;&lt;massTNew&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;massTOld&lt;&lt;<span class="stringliteral">&quot; org:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>&lt;&lt;<span class="stringliteral">&quot;; &quot;</span>&lt;&lt;
<a name="l01203"></a>01203                     <span class="stringliteral">&quot; volt:&quot;</span>&lt;&lt;volTNew&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;volTOld&lt;&lt;<span class="stringliteral">&quot; org:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadde2333da700e8b59fdec8ce3a2a21d">mCurrentVolume</a>, 10);
<a name="l01204"></a>01204         } <span class="keywordflow">else</span> {
<a name="l01205"></a>01205             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;\nLbmOptSolver::step&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Timestep changed by &quot;</span>&lt;&lt; (newdt/levOldStepsize[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>]) &lt;&lt;<span class="stringliteral">&quot; newDt:&quot;</span>&lt;&lt;newdt
<a name="l01206"></a>01206                     &lt;&lt;<span class="stringliteral">&quot;, oldDt:&quot;</span>&lt;&lt;levOldStepsize[mMaxRefine]&lt;&lt;<span class="stringliteral">&quot; newOmega:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a05c2c96e47bd1e16cf283c1faecbb81a">mOmega</a>&lt;&lt;<span class="stringliteral">&quot; gStar:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ab5f00626630175d4909583d6c131c267">getCurrentGStar</a>()&lt;&lt;<span class="stringliteral">&quot;, step:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a> , 10);
<a name="l01207"></a>01207         }
<a name="l01208"></a>01208     } <span class="comment">// rescale?</span>
<a name="l01209"></a>01209     <span class="comment">//NEWDEBCHECK(&quot;tt2&quot;);</span>
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     <span class="comment">//errMsg(&quot;adaptTimestep&quot;,&quot;Warning - brute force rescale off!&quot;); minCutoff = false; // DEBUG</span>
<a name="l01212"></a>01212     <span class="keywordflow">if</span>(minCutoff) {
<a name="l01213"></a>01213         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;adaptTimestep&quot;</span>,<span class="stringliteral">&quot;Warning - performing Brute-Force rescale... (sim:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aa07d7718f9fe8054024b89a4105964f8">mName</a>&lt;&lt;<span class="stringliteral">&quot; step:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>&lt;&lt;<span class="stringliteral">&quot; newdt=&quot;</span>&lt;&lt;desireddt&lt;&lt;<span class="stringliteral">&quot; mindt=&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a04254e9ea1ed18c6e9a01950e3aac121">getMinTimestep</a>()&lt;&lt;<span class="stringliteral">&quot;) &quot;</span> );
<a name="l01214"></a>01214         <span class="comment">//brute force resacle all the time?</span>
<a name="l01215"></a>01215 
<a name="l01216"></a>01216         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>; lev&gt;=0 ; lev--) {
<a name="l01217"></a>01217         <span class="keywordtype">int</span> rescs=0;
<a name="l01218"></a>01218         <span class="keywordtype">int</span> wss = 0, wse = 1;
<a name="l01219"></a>01219 <span class="preprocessor">#if COMPRESSGRIDS==1</span>
<a name="l01220"></a>01220 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(lev== <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) wss = wse = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l01221"></a>01221 <span class="preprocessor">#endif // COMPRESSGRIDS==1</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> workSet = wss; workSet&lt;=wse; workSet++) { <span class="comment">// COMPRT</span>
<a name="l01223"></a>01223         <span class="comment">//for(int workSet = 0; workSet&lt;=1; workSet++) {</span>
<a name="l01224"></a>01224         <a class="code" href="../../d1/d24/solver__class_8h.html#a1cd53306465fab36f6bc4c1d8ef9d291">FSGR_FORIJK1</a>(lev) {
<a name="l01225"></a>01225 
<a name="l01226"></a>01226             <span class="comment">//if( (RFLAG(lev, i,j,k, workSet) &amp; CFFluid) || (RFLAG(lev, i,j,k, workSet) &amp; CFInter) ) {</span>
<a name="l01227"></a>01227             <span class="keywordflow">if</span>( 
<a name="l01228"></a>01228                     (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>) || 
<a name="l01229"></a>01229                     (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) ||
<a name="l01230"></a>01230                     (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>) || 
<a name="l01231"></a>01231                     (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>) || 
<a name="l01232"></a>01232                     (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>) 
<a name="l01233"></a>01233                     ) {
<a name="l01234"></a>01234                 <span class="comment">// these cells have to be scaled...</span>
<a name="l01235"></a>01235             } <span class="keywordflow">else</span> {
<a name="l01236"></a>01236                 <span class="keywordflow">continue</span>;
<a name="l01237"></a>01237             }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239             <span class="comment">// collide on current set</span>
<a name="l01240"></a>01240             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho, ux,uy,uz;
<a name="l01241"></a>01241             rho=0.0; ux =  uy = uz = 0.0;
<a name="l01242"></a>01242             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01243"></a>01243                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, l); 
<a name="l01244"></a>01244                 rho += m;
<a name="l01245"></a>01245                 ux  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*m);
<a name="l01246"></a>01246                 uy  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*m); 
<a name="l01247"></a>01247                 uz  += (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*m); 
<a name="l01248"></a>01248             } 
<a name="l01249"></a>01249 <span class="preprocessor">#ifndef WIN32</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!finite(rho)) {
<a name="l01251"></a>01251                 <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;adaptTimestep&quot;</span>,<span class="stringliteral">&quot;Brute force non-finite rho at&quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>);  <span class="comment">// DEBUG!</span>
<a name="l01252"></a>01252                 rho = 1.0;
<a name="l01253"></a>01253                 ux = uy = uz = 0.0;
<a name="l01254"></a>01254                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = 1.0;
<a name="l01255"></a>01255                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = 1.0;
<a name="l01256"></a>01256             }
<a name="l01257"></a>01257 <span class="preprocessor">#endif // WIN32</span>
<a name="l01258"></a>01258 <span class="preprocessor"></span>
<a name="l01259"></a>01259             <span class="keywordflow">if</span>( (ux*ux+uy*uy+uz*uz)&gt; (allowMax*allowMax) ) {
<a name="l01260"></a>01260                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> cfac = allowMax/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(ux*ux+uy*uy+uz*uz);
<a name="l01261"></a>01261                 ux *= cfac;
<a name="l01262"></a>01262                 uy *= cfac;
<a name="l01263"></a>01263                 uz *= cfac;
<a name="l01264"></a>01264                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l01265"></a>01265                     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, workSet, l) = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, rho, ux,uy,uz); }
<a name="l01266"></a>01266                 rescs++;
<a name="l01267"></a>01267                 <a class="code" href="../../de/df0/utilities_8h.html#a53a891c94e097c591c694e21d6aaded4">debMsgDirect</a>(<span class="stringliteral">&quot;B&quot;</span>);
<a name="l01268"></a>01268             }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270         } } 
<a name="l01271"></a>01271             <span class="comment">//if(rescs&gt;0) { errMsg(&quot;adaptTimestep&quot;,&quot;!!!!! Brute force rescaling was necessary !!!!!!!&quot;); }</span>
<a name="l01272"></a>01272             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;adaptTimestep&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Brute force rescale done. level:&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; rescs:&quot;</span>&lt;&lt;rescs, 1);
<a name="l01273"></a>01273         <span class="comment">//TTT mNumProblems += rescs; // add to problem display...</span>
<a name="l01274"></a>01274         } <span class="comment">// lev,set,ijk</span>
<a name="l01275"></a>01275 
<a name="l01276"></a>01276     } <span class="comment">// try brute force rescale?</span>
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <span class="comment">// time adap done...</span>
<a name="l01279"></a>01279 }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:55 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
