<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: bvh_build.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">bvh_build.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../df/dfe/bvh__build_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Adapted from code copyright 2009-2010 NVIDIA Corporation</span>
<a name="l00003"></a>00003 <span class="comment"> * Modifications Copyright 2011, Blender Foundation.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> * limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d2b/bvh__build_8h.html">bvh_build.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d69/bvh__node_8h.html">bvh_node.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/de1/bvh__params_8h.html">bvh_params.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/da6/bvh__sort_8h.html">bvh_sort.h</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d3b/mesh_8h.html">mesh.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d10/object_8h.html">object.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d83/scene_8h.html">scene.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../df/da0/util__algorithm_8h.html">util_algorithm.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d42/util__foreach_8h.html">util_foreach.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d74/util__progress_8h.html">util_progress.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d3f/util__time_8h.html">util_time.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a127a92451281fa5863da396ed5cd581a">CCL_NAMESPACE_BEGIN</a>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">/* Constructor / Destructor */</span>
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a4be9319d64deeb96756cb5306614f38e">00036</a> <a class="code" href="../../d9/d83/classBVHBuild.html#a4be9319d64deeb96756cb5306614f38e">BVHBuild::BVHBuild</a>(<span class="keyword">const</span> vector&lt;Object*&gt;&amp; objects_,
<a name="l00037"></a>00037     vector&lt;int&gt;&amp; prim_index_, vector&lt;int&gt;&amp; prim_object_,
<a name="l00038"></a>00038     <span class="keyword">const</span> <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a>&amp; params_, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress_)
<a name="l00039"></a>00039 : <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>(objects_),
<a name="l00040"></a>00040   prim_index(prim_index_),
<a name="l00041"></a>00041   prim_object(prim_object_),
<a name="l00042"></a>00042   <a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>(params_),
<a name="l00043"></a>00043   progress(progress_),
<a name="l00044"></a>00044   progress_start_time(0.0)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046     <a class="code" href="../../d9/d83/classBVHBuild.html#a9ef2cf656aecd2e28656383cff7046c9">spatial_min_overlap</a> = 0.0f;
<a name="l00047"></a>00047     <a class="code" href="../../d9/d83/classBVHBuild.html#aa357a901b3f1bfd43ede6aba9d0e6e40">progress_num_duplicates</a> = 0;
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="../../d9/d83/classBVHBuild.html#aee007240b9e54777a8d3730d9048f32e">00050</a> <a class="code" href="../../d9/d83/classBVHBuild.html#aee007240b9e54777a8d3730d9048f32e">BVHBuild::~BVHBuild</a>()
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">/* Adding References */</span>
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a147d322f8be1f9047aa3658dfe87feb5">00056</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a147d322f8be1f9047aa3658dfe87feb5">BVHBuild::add_reference_mesh</a>(<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; root, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058     <span class="keywordflow">for</span>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> j = 0; j &lt; mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size(); j++) {
<a name="l00059"></a>00059         <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Mesh::Triangle</a> t = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[j];
<a name="l00060"></a>00060         <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> ref;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = 0; k &lt; 3; k++) {
<a name="l00063"></a>00063             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> pt = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[k]];
<a name="l00064"></a>00064             ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(pt);
<a name="l00065"></a>00065         }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="keywordflow">if</span>(ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a0af6f16297901cfb91cace9e11baf95a">valid</a>()) {
<a name="l00068"></a>00068             ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a> = j;
<a name="l00069"></a>00069             ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071             <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.push_back(ref);
<a name="l00072"></a>00072             root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00073"></a>00073         }
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a60c0c52892a0cf22b61099b2e137e2aa">00077</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a60c0c52892a0cf22b61099b2e137e2aa">BVHBuild::add_reference_object</a>(<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; root, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> ref;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a> = -1;
<a name="l00082"></a>00082     ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00083"></a>00083     ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a> = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a77b70fcd563fc1a77ad9d332012e8440">bounds</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.push_back(ref);
<a name="l00086"></a>00086     root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="../../d9/d83/classBVHBuild.html#af33877cf4a71d65c43068b27181eee32">00089</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#af33877cf4a71d65c43068b27181eee32">BVHBuild::add_references</a>(<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; root)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="comment">/* init root spec */</span>
<a name="l00092"></a>00092     root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = 0;
<a name="l00093"></a>00093     root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab2ec67620cd61743133e46a16d88ae4a">BoundBox</a>();
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="comment">/* add objects */</span>
<a name="l00096"></a>00096     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d9/d83/classBVHBuild.html#a766ac322f3fa48b14e71a07283caeb3c">objects</a>) {
<a name="l00099"></a>00099         <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>) {
<a name="l00100"></a>00100             <span class="keywordflow">if</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>)
<a name="l00101"></a>00101                 <a class="code" href="../../d9/d83/classBVHBuild.html#a147d322f8be1f9047aa3658dfe87feb5">add_reference_mesh</a>(root, ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>, i);
<a name="l00102"></a>00102             <span class="keywordflow">else</span>
<a name="l00103"></a>00103                 <a class="code" href="../../d9/d83/classBVHBuild.html#a60c0c52892a0cf22b61099b2e137e2aa">add_reference_object</a>(root, ob, i);
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         <span class="keywordflow">else</span>
<a name="l00106"></a>00106             <a class="code" href="../../d9/d83/classBVHBuild.html#a147d322f8be1f9047aa3658dfe87feb5">add_reference_mesh</a>(root, ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>, i);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         i++;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="comment">/* happens mostly on empty meshes */</span>
<a name="l00114"></a>00114     <span class="keywordflow">if</span>(!root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a0af6f16297901cfb91cace9e11baf95a">valid</a>())
<a name="l00115"></a>00115         root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(0.0f, 0.0f, 0.0f));
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size();
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">/* Build */</span>
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a64fa142b742d3723340bca4f87a950a6">00122</a> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* <a class="code" href="../../d9/d83/classBVHBuild.html#a64fa142b742d3723340bca4f87a950a6">BVHBuild::run</a>()
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a> root;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="comment">/* add references */</span>
<a name="l00127"></a>00127     <a class="code" href="../../d9/d83/classBVHBuild.html#af33877cf4a71d65c43068b27181eee32">add_references</a>(root);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="comment">/* init spatial splits */</span>
<a name="l00132"></a>00132     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>) <span class="comment">/* todo: get rid of this */</span>
<a name="l00133"></a>00133         <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a496eb122cef31cc965cd6570992daa8b">use_spatial_split</a> = <span class="keyword">false</span>;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <a class="code" href="../../d9/d83/classBVHBuild.html#a9ef2cf656aecd2e28656383cff7046c9">spatial_min_overlap</a> = root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a3c942f57c35b8b5568f5b1ae58a35405">spatial_split_alpha</a>;
<a name="l00136"></a>00136     <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>.clear();
<a name="l00137"></a>00137     <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>.resize(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(root.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>, (<span class="keywordtype">int</span>)<a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a>) - 1);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">/* init progress updates */</span>
<a name="l00140"></a>00140     <a class="code" href="../../d9/d83/classBVHBuild.html#aa357a901b3f1bfd43ede6aba9d0e6e40">progress_num_duplicates</a> = 0;
<a name="l00141"></a>00141     <a class="code" href="../../d9/d83/classBVHBuild.html#ad6ba32d0ef72f7ecbba90d3dfe155a72">progress_start_time</a> = <a class="code" href="../../da/d61/util__time_8cpp.html#ad932bfc17a5116cdf54147357347ab88">time_dt</a>();
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="comment">/* build recursively */</span>
<a name="l00144"></a>00144     <span class="keywordflow">return</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a4508de3fb74894a1c5341cb69916ed4f">build_node</a>(root, 0, 0.0f, 1.0f);
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a9322eaeabf5c4dce8cc7f63544029587">00147</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a9322eaeabf5c4dce8cc7f63544029587">BVHBuild::progress_update</a>(<span class="keywordtype">float</span> progress_start, <span class="keywordtype">float</span> progress_end)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149     <span class="keywordflow">if</span>(<a class="code" href="../../da/d61/util__time_8cpp.html#ad932bfc17a5116cdf54147357347ab88">time_dt</a>() - <a class="code" href="../../d9/d83/classBVHBuild.html#ad6ba32d0ef72f7ecbba90d3dfe155a72">progress_start_time</a> &lt; 0.25f)
<a name="l00150"></a>00150         <span class="keywordflow">return</span>;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="keywordtype">float</span> duplicates = (float)<a class="code" href="../../d9/d83/classBVHBuild.html#aa357a901b3f1bfd43ede6aba9d0e6e40">progress_num_duplicates</a>/(<span class="keywordtype">float</span>)<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size();
<a name="l00153"></a>00153     <span class="keywordtype">string</span> msg = <a class="code" href="../../df/d14/util__string_8cpp.html#a9975215953965d1131e6dccd370e4351">string_printf</a>(<span class="stringliteral">&quot;Building BVH %.0f%%, duplicates %.0f%%&quot;</span>,
<a name="l00154"></a>00154         progress_start*100.0f, duplicates*100.0f);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(msg);
<a name="l00157"></a>00157     <a class="code" href="../../d9/d83/classBVHBuild.html#ad6ba32d0ef72f7ecbba90d3dfe155a72">progress_start_time</a> = <a class="code" href="../../da/d61/util__time_8cpp.html#ad932bfc17a5116cdf54147357347ab88">time_dt</a>();
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a4508de3fb74894a1c5341cb69916ed4f">00160</a> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* <a class="code" href="../../d9/d83/classBVHBuild.html#a4508de3fb74894a1c5341cb69916ed4f">BVHBuild::build_node</a>(<span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>, <span class="keywordtype">int</span> level, <span class="keywordtype">float</span> progress_start, <span class="keywordtype">float</span> progress_end)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <span class="comment">/* progress update */</span>
<a name="l00163"></a>00163     <a class="code" href="../../d9/d83/classBVHBuild.html#a9322eaeabf5c4dce8cc7f63544029587">progress_update</a>(progress_start, progress_end);
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">/* small enough or too deep =&gt; create leaf. */</span>
<a name="l00167"></a>00167     <span class="keywordflow">if</span>(spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> &lt;= <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa2b4f71c395b2606893f2d48281147d8">min_leaf_size</a> || level &gt;= <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afa3b43826c0613fcb1c51690e5d45459b0">BVHParams::MAX_DEPTH</a>)
<a name="l00168"></a>00168         <span class="keywordflow">return</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a955e91208aafb1892bafe98275da3651">create_leaf_node</a>(spec);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">/* find split candidates. */</span>
<a name="l00171"></a>00171     <span class="keywordtype">float</span> area = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>();
<a name="l00172"></a>00172     <span class="keywordtype">float</span> leafSAH = area * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>);
<a name="l00173"></a>00173     <span class="keywordtype">float</span> nodeSAH = area * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#ac78920fcddeec72de8c42a23695ed5fc">node_cost</a>(2);
<a name="l00174"></a>00174     <a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html">ObjectSplit</a> <span class="keywordtype">object</span> = <a class="code" href="../../d9/d83/classBVHBuild.html#a0f4780376cbdc2edd8360c1d8baa2bcd">find_object_split</a>(spec, nodeSAH);
<a name="l00175"></a>00175     <a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html">SpatialSplit</a> spatial;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a496eb122cef31cc965cd6570992daa8b">use_spatial_split</a> &amp;&amp; level &lt; <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afa3e752f396ef7f17adcccd32b1c62e63f">BVHParams::MAX_SPATIAL_DEPTH</a>) {
<a name="l00178"></a>00178         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> overlap = <span class="keywordtype">object</span>.left_bounds;
<a name="l00179"></a>00179         overlap.<a class="code" href="../../d3/d8a/structBoundBox.html#acb88ccb365e5b5dcd5c88f9a5b5d4e70">intersect</a>(<span class="keywordtype">object</span>.right_bounds);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="keywordflow">if</span>(overlap.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() &gt;= <a class="code" href="../../d9/d83/classBVHBuild.html#a9ef2cf656aecd2e28656383cff7046c9">spatial_min_overlap</a>)
<a name="l00182"></a>00182             spatial = <a class="code" href="../../d9/d83/classBVHBuild.html#a0a34dae0fe298de3f50960c73ac9bb63">find_spatial_split</a>(spec, nodeSAH);
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="comment">/* leaf SAH is the lowest =&gt; create leaf. */</span>
<a name="l00186"></a>00186     <span class="keywordtype">float</span> minSAH = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(leafSAH, <span class="keywordtype">object</span>.sah), spatial.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#adf2065e52485badc2e9f672a131fae1d">sah</a>);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">if</span>(minSAH == leafSAH &amp;&amp; spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> &lt;= <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a712d91ee9a76adb711283bbace3980c8">max_leaf_size</a>)
<a name="l00189"></a>00189         <span class="keywordflow">return</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a955e91208aafb1892bafe98275da3651">create_leaf_node</a>(spec);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment">/* perform split. */</span>
<a name="l00192"></a>00192     <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a> <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, right;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a496eb122cef31cc965cd6570992daa8b">use_spatial_split</a> &amp;&amp; minSAH == spatial.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#adf2065e52485badc2e9f672a131fae1d">sah</a>)
<a name="l00195"></a>00195         <a class="code" href="../../d9/d83/classBVHBuild.html#abbe6ec8711c6d03d89db2413d4df6917">do_spatial_split</a>(left, right, spec, spatial);
<a name="l00196"></a>00196     <span class="keywordflow">if</span>(!left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> || !right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>)
<a name="l00197"></a>00197         <a class="code" href="../../d9/d83/classBVHBuild.html#ab8608aed1d3d672aad314c1ce7d6b5b5">do_object_split</a>(left, right, spec, <span class="keywordtype">object</span>);
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="comment">/* create inner node. */</span>
<a name="l00200"></a>00200     <a class="code" href="../../d9/d83/classBVHBuild.html#aa357a901b3f1bfd43ede6aba9d0e6e40">progress_num_duplicates</a> += left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> + right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordtype">float</span> progress_mid = <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(progress_start, progress_end, (<span class="keywordtype">float</span>)right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> / (<span class="keywordtype">float</span>)(left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> + right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>));
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* rightNode = <a class="code" href="../../d9/d83/classBVHBuild.html#a4508de3fb74894a1c5341cb69916ed4f">build_node</a>(right, level + 1, progress_start, progress_mid);
<a name="l00205"></a>00205     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) {
<a name="l00206"></a>00206         <span class="keywordflow">if</span>(rightNode) rightNode-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00207"></a>00207         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* leftNode = <a class="code" href="../../d9/d83/classBVHBuild.html#a4508de3fb74894a1c5341cb69916ed4f">build_node</a>(left, level + 1, progress_mid, progress_end);
<a name="l00211"></a>00211     <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a7b02139e3c64c77cf7d82b09f6468f16">progress</a>.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) {
<a name="l00212"></a>00212         <span class="keywordflow">if</span>(leftNode) leftNode-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00213"></a>00213         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d3/da6/classInnerNode.html">InnerNode</a>(spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>, leftNode, rightNode);
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="../../d9/d83/classBVHBuild.html#ac0b59f710e1051205da8be794d3c1461">00219</a> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *<a class="code" href="../../d9/d83/classBVHBuild.html#ac0b59f710e1051205da8be794d3c1461">BVHBuild::create_object_leaf_nodes</a>(<span class="keyword">const</span> <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> *ref, <span class="keywordtype">int</span> num)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <span class="keywordflow">if</span>(num == 0) {
<a name="l00222"></a>00222         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>;
<a name="l00223"></a>00223         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>(bounds, 0, 0, 0);
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(num == 1) {
<a name="l00226"></a>00226         <a class="code" href="../../d9/d83/classBVHBuild.html#a9632635a353b9268a407dc894953ad04">prim_index</a>.push_back(ref[0].<a class="code" href="../../d9/d83/classBVHBuild.html#a9632635a353b9268a407dc894953ad04">prim_index</a>);
<a name="l00227"></a>00227         <a class="code" href="../../d9/d83/classBVHBuild.html#a55d0331b0c2d34b3d34aaee81db770b1">prim_object</a>.push_back(ref[0].<a class="code" href="../../d9/d83/classBVHBuild.html#a55d0331b0c2d34b3d34aaee81db770b1">prim_object</a>);
<a name="l00228"></a>00228         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility = <a class="code" href="../../d9/d83/classBVHBuild.html#a766ac322f3fa48b14e71a07283caeb3c">objects</a>[ref[0].<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a>]-&gt;visibility;
<a name="l00229"></a>00229         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>(ref[0].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>, visibility, prim_index.size()-1, prim_index.size());
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231     <span class="keywordflow">else</span> {
<a name="l00232"></a>00232         <span class="keywordtype">int</span> mid = num/2;
<a name="l00233"></a>00233         <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *leaf0 = <a class="code" href="../../d9/d83/classBVHBuild.html#ac0b59f710e1051205da8be794d3c1461">create_object_leaf_nodes</a>(ref, mid); 
<a name="l00234"></a>00234         <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *leaf1 = <a class="code" href="../../d9/d83/classBVHBuild.html#ac0b59f710e1051205da8be794d3c1461">create_object_leaf_nodes</a>(ref+mid, num-mid); 
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>;
<a name="l00237"></a>00237         bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(leaf0-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>);
<a name="l00238"></a>00238         bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(leaf1-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d3/da6/classInnerNode.html">InnerNode</a>(bounds, leaf0, leaf1);
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a955e91208aafb1892bafe98275da3651">00244</a> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* <a class="code" href="../../d9/d83/classBVHBuild.html#a955e91208aafb1892bafe98275da3651">BVHBuild::create_leaf_node</a>(<span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     vector&lt;int&gt;&amp; p_index = <a class="code" href="../../d9/d83/classBVHBuild.html#a9632635a353b9268a407dc894953ad04">prim_index</a>;
<a name="l00247"></a>00247     vector&lt;int&gt;&amp; p_object = <a class="code" href="../../d9/d83/classBVHBuild.html#a55d0331b0c2d34b3d34aaee81db770b1">prim_object</a>;
<a name="l00248"></a>00248     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>;
<a name="l00249"></a>00249     <span class="keywordtype">int</span> num = 0;
<a name="l00250"></a>00250     <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility = 0;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00253"></a>00253         <span class="keywordflow">if</span>(<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back().prim_index != -1) {
<a name="l00254"></a>00254             p_index.push_back(<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back().prim_index);
<a name="l00255"></a>00255             p_object.push_back(<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back().prim_object);
<a name="l00256"></a>00256             bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back().bounds);
<a name="l00257"></a>00257             visibility |= <a class="code" href="../../d9/d83/classBVHBuild.html#a766ac322f3fa48b14e71a07283caeb3c">objects</a>[<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back().prim_object]-&gt;visibility;
<a name="l00258"></a>00258             <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.pop_back();
<a name="l00259"></a>00259             num++;
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *leaf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00264"></a>00264     
<a name="l00265"></a>00265     <span class="keywordflow">if</span>(num &gt; 0) {
<a name="l00266"></a>00266         leaf = <span class="keyword">new</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>(bounds, visibility, p_index.size() - num, p_index.size());
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="keywordflow">if</span>(num == spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>)
<a name="l00269"></a>00269             <span class="keywordflow">return</span> leaf;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* while there may be multiple triangles in a leaf, for object primitives</span>
<a name="l00273"></a>00273 <span class="comment">     * we want them to be the only one, so we  */</span>
<a name="l00274"></a>00274     <span class="keywordtype">int</span> ob_num = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> - num;
<a name="l00275"></a>00275     <span class="keyword">const</span> <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> *ref = (ob_num)? &amp;<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.back() - (ob_num - 1): <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00276"></a>00276     <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *oleaf = <a class="code" href="../../d9/d83/classBVHBuild.html#ac0b59f710e1051205da8be794d3c1461">create_object_leaf_nodes</a>(ref, ob_num);
<a name="l00277"></a>00277     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; ob_num; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00278"></a>00278         <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.pop_back();
<a name="l00279"></a>00279     
<a name="l00280"></a>00280     <span class="keywordflow">if</span>(leaf)
<a name="l00281"></a>00281         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d3/da6/classInnerNode.html">InnerNode</a>(spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>, leaf, oleaf);
<a name="l00282"></a>00282     <span class="keywordflow">else</span>
<a name="l00283"></a>00283         <span class="keywordflow">return</span> oleaf;
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="comment">/* Object Split */</span>
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a0f4780376cbdc2edd8360c1d8baa2bcd">00288</a> <a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html">BVHBuild::ObjectSplit</a> <a class="code" href="../../d9/d83/classBVHBuild.html#a0f4780376cbdc2edd8360c1d8baa2bcd">BVHBuild::find_object_split</a>(<span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>, <span class="keywordtype">float</span> nodeSAH)
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290     <a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html">ObjectSplit</a> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>;
<a name="l00291"></a>00291     <span class="keyword">const</span> <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> *ref_ptr = &amp;<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>[<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size() - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>];
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dim = 0; dim &lt; 3; dim++) {
<a name="l00294"></a>00294         <span class="comment">/* sort references */</span>
<a name="l00295"></a>00295         <a class="code" href="../../d5/df5/bvh__sort_8cpp.html#a9ebfa5475f0dd1fb3732370e98458e25">bvh_reference_sort</a>(<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size() - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>, <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size(), &amp;<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>[0], dim);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="comment">/* sweep right to left and determine bounds. */</span>
<a name="l00298"></a>00298         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> right_bounds;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> - 1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &gt; 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>--) {
<a name="l00301"></a>00301             right_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(ref_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00302"></a>00302             <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1] = right_bounds;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="comment">/* sweep left to right and select lowest SAH. */</span>
<a name="l00306"></a>00306         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> left_bounds;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00309"></a>00309             left_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(ref_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00310"></a>00310             right_bounds = <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1];
<a name="l00311"></a>00311 
<a name="l00312"></a>00312             <span class="keywordtype">float</span> sah = nodeSAH +
<a name="l00313"></a>00313                 left_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) +
<a name="l00314"></a>00314                 right_bounds.area() * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> - <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316             <span class="keywordflow">if</span>(sah &lt; split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a7607db3cbf43269f375d4daff9b11a41">sah</a>) {
<a name="l00317"></a>00317                 split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a7607db3cbf43269f375d4daff9b11a41">sah</a> = sah;
<a name="l00318"></a>00318                 split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a17ae13602810b108fd918b6b063fda73">dim</a> = dim;
<a name="l00319"></a>00319                 split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a5dc601bfb2745c1ac8bd1fae7a48c2ba">num_left</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00320"></a>00320                 split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#aea886fd7ed3a10498a12288ed807829a">left_bounds</a> = left_bounds;
<a name="l00321"></a>00321                 split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a7251ff7d8337495086ee299194fbfe7d">right_bounds</a> = right_bounds;
<a name="l00322"></a>00322             }
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="keywordflow">return</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>;
<a name="l00327"></a>00327 }
<a name="l00328"></a>00328 
<a name="l00329"></a><a class="code" href="../../d9/d83/classBVHBuild.html#ab8608aed1d3d672aad314c1ce7d6b5b5">00329</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#ab8608aed1d3d672aad314c1ce7d6b5b5">BVHBuild::do_object_split</a>(<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; right, <span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>, <span class="keyword">const</span> <a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html">ObjectSplit</a>&amp; <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>)
<a name="l00330"></a>00330 {
<a name="l00331"></a>00331     <span class="comment">/* sort references according to split */</span>
<a name="l00332"></a>00332     <span class="keywordtype">int</span> start = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size() - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>;
<a name="l00333"></a>00333     <span class="keywordtype">int</span> end = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size(); <span class="comment">/* todo: is this right? */</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <a class="code" href="../../d5/df5/bvh__sort_8cpp.html#a9ebfa5475f0dd1fb3732370e98458e25">bvh_reference_sort</a>(start, end, &amp;<a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>[0], split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a17ae13602810b108fd918b6b063fda73">dim</a>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">/* split node specs */</span>
<a name="l00338"></a>00338     left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a5dc601bfb2745c1ac8bd1fae7a48c2ba">num_left</a>;
<a name="l00339"></a>00339     left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#aea886fd7ed3a10498a12288ed807829a">left_bounds</a>;
<a name="l00340"></a>00340     right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> - split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a5dc601bfb2745c1ac8bd1fae7a48c2ba">num_left</a>;
<a name="l00341"></a>00341     right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = split.<a class="code" href="../../dc/d02/structBVHBuild_1_1ObjectSplit.html#a7251ff7d8337495086ee299194fbfe7d">right_bounds</a>;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="comment">/* Spatial Split */</span>
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a0a34dae0fe298de3f50960c73ac9bb63">00346</a> <a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html">BVHBuild::SpatialSplit</a> <a class="code" href="../../d9/d83/classBVHBuild.html#a0a34dae0fe298de3f50960c73ac9bb63">BVHBuild::find_spatial_split</a>(<span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>, <span class="keywordtype">float</span> nodeSAH)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348     <span class="comment">/* initialize bins. */</span>
<a name="l00349"></a>00349     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> origin = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>;
<a name="l00350"></a>00350     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> binSize = (spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a> - origin) * (1.0f / (<span class="keywordtype">float</span>)<a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a>);
<a name="l00351"></a>00351     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> invBinSize = 1.0f / binSize;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dim = 0; dim &lt; 3; dim++) {
<a name="l00354"></a>00354         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00355"></a>00355             <a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html">SpatialBin</a>&amp; bin = <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00356"></a>00356 
<a name="l00357"></a>00357             bin.<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#ac0596b9bb853314aaa7b79d5294f43d2">bounds</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab2ec67620cd61743133e46a16d88ae4a">BoundBox</a>();
<a name="l00358"></a>00358             bin.<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a002713398939351f17d405606f701c58">enter</a> = 0;
<a name="l00359"></a>00359             bin.<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a63e2d7472b3392d3dccf3e48c99f5f40">exit</a> = 0;
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">/* chop references into bins. */</span>
<a name="l00364"></a>00364     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> refIdx = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size() - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>; refIdx &lt; <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>.size(); refIdx++) {
<a name="l00365"></a>00365         <span class="keyword">const</span> <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a>&amp; ref = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>[refIdx];
<a name="l00366"></a>00366         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> firstBinf = (ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a> - origin) * invBinSize;
<a name="l00367"></a>00367         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> lastBinf = (ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a> - origin) * invBinSize;
<a name="l00368"></a>00368         <a class="code" href="../../d2/d6e/structint3.html">int3</a> firstBin = <a class="code" href="../../d7/dad/util__types_8h.html#a3e5520e035fc08835857eb3903ef0f73">make_int3</a>((<span class="keywordtype">int</span>)firstBinf.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, (<span class="keywordtype">int</span>)firstBinf.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, (<span class="keywordtype">int</span>)firstBinf.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>);
<a name="l00369"></a>00369         <a class="code" href="../../d2/d6e/structint3.html">int3</a> lastBin = <a class="code" href="../../d7/dad/util__types_8h.html#a3e5520e035fc08835857eb3903ef0f73">make_int3</a>((<span class="keywordtype">int</span>)lastBinf.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, (<span class="keywordtype">int</span>)lastBinf.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, (<span class="keywordtype">int</span>)lastBinf.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         firstBin = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>(firstBin, 0, <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a> - 1);
<a name="l00372"></a>00372         lastBin = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>(lastBin, firstBin, <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a> - 1);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dim = 0; dim &lt; 3; dim++) {
<a name="l00375"></a>00375             <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> currRef = ref;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = firstBin[dim]; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; lastBin[dim]; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00378"></a>00378                 <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> leftRef, rightRef;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                 <a class="code" href="../../d9/d83/classBVHBuild.html#a5b554529b6428b705738b06895baf2b8">split_reference</a>(leftRef, rightRef, currRef, dim, origin[dim] + binSize[dim] * (<span class="keywordtype">float</span>)(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> + 1));
<a name="l00381"></a>00381                 <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#ac0596b9bb853314aaa7b79d5294f43d2">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(leftRef.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00382"></a>00382                 currRef = rightRef;
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][lastBin[dim]].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#ac0596b9bb853314aaa7b79d5294f43d2">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(currRef.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00386"></a>00386             <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][firstBin[dim]].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a002713398939351f17d405606f701c58">enter</a>++;
<a name="l00387"></a>00387             <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][lastBin[dim]].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a63e2d7472b3392d3dccf3e48c99f5f40">exit</a>++;
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389     }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="comment">/* select best split plane. */</span>
<a name="l00392"></a>00392     <a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html">SpatialSplit</a> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> dim = 0; dim &lt; 3; dim++) {
<a name="l00395"></a>00395         <span class="comment">/* sweep right to left and determine bounds. */</span>
<a name="l00396"></a>00396         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> right_bounds;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a> - 1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &gt; 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>--) {
<a name="l00399"></a>00399             right_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00400"></a>00400             <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1] = right_bounds;
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403         <span class="comment">/* sweep left to right and select lowest SAH. */</span>
<a name="l00404"></a>00404         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> left_bounds;
<a name="l00405"></a>00405         <span class="keywordtype">int</span> leftNum = 0;
<a name="l00406"></a>00406         <span class="keywordtype">int</span> rightNum = spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="../../d2/d2f/classBVHParams.html#a542b0adb67b31203e748083981b2b5afabf0c09f90514f1a45e415514947351ef">BVHParams::NUM_SPATIAL_BINS</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00409"></a>00409             left_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00410"></a>00410             leftNum += <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a002713398939351f17d405606f701c58">enter</a>;
<a name="l00411"></a>00411             rightNum -= <a class="code" href="../../d9/d83/classBVHBuild.html#a0c98e94077ce3adee08ea3de1ef6402d">spatial_bins</a>[dim][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1].<a class="code" href="../../d9/d8a/structBVHBuild_1_1SpatialBin.html#a63e2d7472b3392d3dccf3e48c99f5f40">exit</a>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             <span class="keywordtype">float</span> sah = nodeSAH +
<a name="l00414"></a>00414                 left_bounds.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(leftNum) +
<a name="l00415"></a>00415                 <a class="code" href="../../d9/d83/classBVHBuild.html#a602b9c61ca14589bb727f6fc5e988466">spatial_right_bounds</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1].area() * <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(rightNum);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417             <span class="keywordflow">if</span>(sah &lt; split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#adf2065e52485badc2e9f672a131fae1d">sah</a>) {
<a name="l00418"></a>00418                 split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#adf2065e52485badc2e9f672a131fae1d">sah</a> = sah;
<a name="l00419"></a>00419                 split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a95fe7888fad4542ce238411925d8fb05">dim</a> = dim;
<a name="l00420"></a>00420                 split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a145843ba4ec7f2acd839d5b07d7af43e">pos</a> = origin[dim] + binSize[dim] * (float)<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00421"></a>00421             }
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="keywordflow">return</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="../../d9/d83/classBVHBuild.html#abbe6ec8711c6d03d89db2413d4df6917">00428</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#abbe6ec8711c6d03d89db2413d4df6917">BVHBuild::do_spatial_split</a>(<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; right, <span class="keyword">const</span> <a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html">NodeSpec</a>&amp; <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>, <span class="keyword">const</span> <a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html">SpatialSplit</a>&amp; <a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     <span class="comment">/* Categorize references and compute bounds.</span>
<a name="l00431"></a>00431 <span class="comment">     *</span>
<a name="l00432"></a>00432 <span class="comment">     * Left-hand side:          [left_start, left_end[</span>
<a name="l00433"></a>00433 <span class="comment">     * Uncategorized/split:     [left_end, right_start[</span>
<a name="l00434"></a>00434 <span class="comment">     * Right-hand side:         [right_start, refs.size()[ */</span>
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     vector&lt;Reference&gt;&amp; refs = <a class="code" href="../../d9/d83/classBVHBuild.html#a8121b246c1fd91f3274fc92cf72a1381">references</a>;
<a name="l00437"></a>00437     <span class="keywordtype">int</span> left_start = refs.size() - spec.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a>;
<a name="l00438"></a>00438     <span class="keywordtype">int</span> left_end = left_start;
<a name="l00439"></a>00439     <span class="keywordtype">int</span> right_start = refs.size();
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab2ec67620cd61743133e46a16d88ae4a">BoundBox</a>();
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = left_end; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; right_start; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00444"></a>00444         <span class="keywordflow">if</span>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>.max[split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a95fe7888fad4542ce238411925d8fb05">dim</a>] &lt;= split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a145843ba4ec7f2acd839d5b07d7af43e">pos</a>) {
<a name="l00445"></a>00445             <span class="comment">/* entirely on the left-hand side */</span>
<a name="l00446"></a>00446             left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00447"></a>00447             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a8c6a16881d4ab28d222f7ac896ced037">swap</a>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>], refs[left_end++]);
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>.min[split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a95fe7888fad4542ce238411925d8fb05">dim</a>] &gt;= split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a145843ba4ec7f2acd839d5b07d7af43e">pos</a>) {
<a name="l00450"></a>00450             <span class="comment">/* entirely on the right-hand side */</span>
<a name="l00451"></a>00451             right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00452"></a>00452             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a8c6a16881d4ab28d222f7ac896ced037">swap</a>(refs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>--], refs[--right_start]);
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/* duplicate or unsplit references intersecting both sides. */</span>
<a name="l00457"></a>00457     <span class="keywordflow">while</span>(left_end &lt; right_start) {
<a name="l00458"></a>00458         <span class="comment">/* split reference. */</span>
<a name="l00459"></a>00459         <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a> lref, rref;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         <a class="code" href="../../d9/d83/classBVHBuild.html#a5b554529b6428b705738b06895baf2b8">split_reference</a>(lref, rref, refs[left_end], split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a95fe7888fad4542ce238411925d8fb05">dim</a>, split.<a class="code" href="../../df/dc1/structBVHBuild_1_1SpatialSplit.html#a145843ba4ec7f2acd839d5b07d7af43e">pos</a>);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="comment">/* compute SAH for duplicate/unsplit candidates. */</span>
<a name="l00464"></a>00464         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> lub = left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>;     <span class="comment">// Unsplit to left:     new left-hand bounds.</span>
<a name="l00465"></a>00465         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> rub = right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>;    <span class="comment">// Unsplit to right:    new right-hand bounds.</span>
<a name="l00466"></a>00466         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> ldb = left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>;     <span class="comment">// Duplicate:           new left-hand bounds.</span>
<a name="l00467"></a>00467         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> rdb = right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>;    <span class="comment">// Duplicate:           new right-hand bounds.</span>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         lub.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(refs[left_end].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>);
<a name="l00470"></a>00470         rub.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(refs[left_end].bounds);
<a name="l00471"></a>00471         ldb.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(lref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00472"></a>00472         rdb.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(rref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <span class="keywordtype">float</span> lac = <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(left_end - left_start);
<a name="l00475"></a>00475         <span class="keywordtype">float</span> rac = <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(refs.size() - right_start);
<a name="l00476"></a>00476         <span class="keywordtype">float</span> lbc = <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(left_end - left_start + 1);
<a name="l00477"></a>00477         <span class="keywordtype">float</span> rbc = <a class="code" href="../../d9/d83/classBVHBuild.html#a97e731c2f068bf0650e3375399747bf9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#a07070ea8d72d78f8ae1dddab27f6b435">triangle_cost</a>(refs.size() - right_start + 1);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         <span class="keywordtype">float</span> unsplitLeftSAH = lub.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * lbc + right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * rac;
<a name="l00480"></a>00480         <span class="keywordtype">float</span> unsplitRightSAH = left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * lac + rub.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * rbc;
<a name="l00481"></a>00481         <span class="keywordtype">float</span> duplicateSAH = ldb.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * lbc + rdb.<a class="code" href="../../d3/d8a/structBoundBox.html#af55db57bb4051595cf9a718ba150f72e">area</a>() * rbc;
<a name="l00482"></a>00482         <span class="keywordtype">float</span> minSAH = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(unsplitLeftSAH, unsplitRightSAH), duplicateSAH);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <span class="keywordflow">if</span>(minSAH == unsplitLeftSAH) {
<a name="l00485"></a>00485             <span class="comment">/* unsplit to left */</span>
<a name="l00486"></a>00486             left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = lub;
<a name="l00487"></a>00487             left_end++;
<a name="l00488"></a>00488         }
<a name="l00489"></a>00489         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(minSAH == unsplitRightSAH) {
<a name="l00490"></a>00490             <span class="comment">/* unsplit to right */</span>
<a name="l00491"></a>00491             right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = rub;
<a name="l00492"></a>00492             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a8c6a16881d4ab28d222f7ac896ced037">swap</a>(refs[left_end], refs[--right_start]);
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494         <span class="keywordflow">else</span> {
<a name="l00495"></a>00495             <span class="comment">/* duplicate */</span>
<a name="l00496"></a>00496             left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = ldb;
<a name="l00497"></a>00497             right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a1a651bd038bf7fd0af44c2e5aa183a97">bounds</a> = rdb;
<a name="l00498"></a>00498             refs[left_end++] = lref;
<a name="l00499"></a>00499             refs.push_back(rref);
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     left.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = left_end - left_start;
<a name="l00504"></a>00504     right.<a class="code" href="../../de/d77/structBVHBuild_1_1NodeSpec.html#a93608c414d4adfb8ae7406eca0208a7d">num</a> = refs.size() - right_start;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="../../d9/d83/classBVHBuild.html#a5b554529b6428b705738b06895baf2b8">00507</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d83/classBVHBuild.html#a5b554529b6428b705738b06895baf2b8">BVHBuild::split_reference</a>(<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a>&amp; <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a>&amp; right, <span class="keyword">const</span> <a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html">Reference</a>&amp; ref, <span class="keywordtype">int</span> dim, <span class="keywordtype">float</span> pos)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <span class="comment">/* initialize references. */</span>
<a name="l00510"></a>00510     left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a> = right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a> = ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a>;
<a name="l00511"></a>00511     left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a> = right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a> = ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a>;
<a name="l00512"></a>00512     left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a> = right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab2ec67620cd61743133e46a16d88ae4a">BoundBox</a>();
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <span class="comment">/* loop over vertices/edges. */</span>
<a name="l00515"></a>00515     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../d9/d83/classBVHBuild.html#a766ac322f3fa48b14e71a07283caeb3c">objects</a>[ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad68e2f59947dfb60ccafef9d7e9ee110">prim_object</a>];
<a name="l00516"></a>00516     <span class="keyword">const</span> <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>;
<a name="l00517"></a>00517     <span class="keyword">const</span> <span class="keywordtype">int</span> *inds = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ad4c7c2dfad015feaa74565bddef9559f">prim_index</a>].v;
<a name="l00518"></a>00518     <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *verts = &amp;mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0];
<a name="l00519"></a>00519     <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a>* v1 = &amp;verts[inds[2]];
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; 3; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00522"></a>00522         <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a>* v0 = v1;
<a name="l00523"></a>00523         <span class="keywordtype">int</span> vindex = inds[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00524"></a>00524         v1 = &amp;verts[vindex];
<a name="l00525"></a>00525         <span class="keywordtype">float</span> v0p = (*v0)[dim];
<a name="l00526"></a>00526         <span class="keywordtype">float</span> v1p = (*v1)[dim];
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="comment">/* insert vertex to the boxes it belongs to. */</span>
<a name="l00529"></a>00529         <span class="keywordflow">if</span>(v0p &lt;= pos)
<a name="l00530"></a>00530             left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(*v0);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         <span class="keywordflow">if</span>(v0p &gt;= pos)
<a name="l00533"></a>00533             right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(*v0);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="comment">/* edge intersects the plane =&gt; insert intersection to both boxes. */</span>
<a name="l00536"></a>00536         <span class="keywordflow">if</span>((v0p &lt; pos &amp;&amp; v1p &gt; pos) || (v0p &gt; pos &amp;&amp; v1p &lt; pos)) {
<a name="l00537"></a>00537             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> t = <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(*v0, *v1, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>((pos - v0p) / (v1p - v0p), 0.0f, 1.0f));
<a name="l00538"></a>00538             left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(t);
<a name="l00539"></a>00539             right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(t);
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">/* intersect with original bounds. */</span>
<a name="l00544"></a>00544     left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>[dim] = pos;
<a name="l00545"></a>00545     right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>[dim] = pos;
<a name="l00546"></a>00546     left.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#acb88ccb365e5b5dcd5c88f9a5b5d4e70">intersect</a>(ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00547"></a>00547     right.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#acb88ccb365e5b5dcd5c88f9a5b5d4e70">intersect</a>(ref.<a class="code" href="../../d5/d59/structBVHBuild_1_1Reference.html#ab3611dfde9d2a26a6494ce6a8a6c00f1">bounds</a>);
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#ae0c27e57708248c67409956ddc159e18">CCL_NAMESPACE_END</a>
<a name="l00551"></a>00551 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:10 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
