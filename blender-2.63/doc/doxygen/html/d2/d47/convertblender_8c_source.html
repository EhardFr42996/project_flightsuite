<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: convertblender.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">convertblender.c</div>  </div>
</div>
<div class="contents">
<a href="../../d2/d47/convertblender_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributors: 2004/2005/2006 Blender Foundation, full recode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d88/DNA__curve__types_8h.html">DNA_curve_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d8e/DNA__effect__types_8h.html">DNA_effect_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d94/DNA__image__types_8h.html">DNA_image_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d40/DNA__meta__types_8h.html">DNA_meta_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html">DNA_modifier_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d60/DNA__object__force_8h.html">DNA_object_force.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html">DNA_object_fluidsim.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html">DNA_particle_types.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html">DNA_view3d_types.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d5e/BKE__customdata_8h.html" title="CustomData interface, see also DNA_customdata_types.h.">BKE_customdata.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d65/BKE__effect_8h.html">BKE_effect.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/df5/BKE__group_8h.html">BKE_group.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d48/BKE__ipo_8h.html">BKE_ipo.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8f/BKE__lattice_8h.html">BKE_lattice.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dae/BKE__mball_8h.html">BKE_mball.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dca/BKE__particle_8h.html">BKE_particle.h</a>&quot;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d35/BKE__world_8h.html">BKE_world.h</a>&quot;</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00101"></a>00101 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3f/envmap_8h.html">envmap.h</a>&quot;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d3a/occlusion_8h.html">occlusion.h</a>&quot;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/def/pointdensity_8h.html">pointdensity.h</a>&quot;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd0/voxeldata_8h.html">voxeldata.h</a>&quot;</span>
<a name="l00107"></a>00107 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00108"></a>00108 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00111"></a>00111 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00112"></a>00112 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00113"></a>00113 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dda/strand_8h.html">strand.h</a>&quot;</span>
<a name="l00114"></a>00114 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00115"></a>00115 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d62/volume__precache_8h.html">volume_precache.h</a>&quot;</span>
<a name="l00116"></a>00116 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d59/sss_8h.html">sss.h</a>&quot;</span>
<a name="l00117"></a>00117 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dda/strand_8h.html">strand.h</a>&quot;</span>
<a name="l00118"></a>00118 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00119"></a>00119 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d88/sunsky_8h.html">sunsky.h</a>&quot;</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/* 10 times larger than normal epsilon, test it on default nurbs sphere with ray_transp (for quad detection) */</span>
<a name="l00123"></a>00123 <span class="comment">/* or for checking vertex normal flips */</span>
<a name="l00124"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">00124</a> <span class="preprocessor">#define FLT_EPSILON10 1.19209290e-06F</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>
<a name="l00126"></a>00126 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="comment">/* Stuff for stars. This sits here because it uses gl-things. Part of</span>
<a name="l00129"></a>00129 <span class="comment"> * this code may move down to the converter.  */</span>
<a name="l00130"></a>00130 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00131"></a>00131 <span class="comment">/* this is a bad beast, since it is misused by the 3d view drawing as well. */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a02ec2a7265432274afa1d16364277fd9">00133</a> <span class="keyword">static</span> <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#a02ec2a7265432274afa1d16364277fd9">initstar</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">float</span> *vec, <span class="keywordtype">float</span> hasize)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har;
<a name="l00136"></a>00136     <span class="keywordtype">float</span> hoco[4];
<a name="l00137"></a>00137     
<a name="l00138"></a>00138     <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>(vec, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, hoco);
<a name="l00139"></a>00139     
<a name="l00140"></a>00140     har= <a class="code" href="../../d0/db6/renderdatabase_8h.html#adaea89fa49687a4d41d76ca990e18aca">RE_findOrAddHalo</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>++);
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     <span class="comment">/* projectvert is done in function zbufvlaggen again, because of parts */</span>
<a name="l00143"></a>00143     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ae6c5e70c8bccbccfa3e5eef8bc8b2529">co</a>, vec);
<a name="l00144"></a>00144     har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a663b6c98c2cae6bdcbbc0d27b3b7a122">hasize</a>= hasize;
<a name="l00145"></a>00145     
<a name="l00146"></a>00146     har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a65f59dc267d1701b80d439f8beff9e1a">zd</a>= 0.0;
<a name="l00147"></a>00147     
<a name="l00148"></a>00148     <span class="keywordflow">return</span> har;
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">/* there must be a &#39;fixed&#39; amount of stars generated between</span>
<a name="l00152"></a>00152 <span class="comment"> *         near and far</span>
<a name="l00153"></a>00153 <span class="comment"> * all stars must by preference lie on the far and solely</span>
<a name="l00154"></a>00154 <span class="comment"> *        differ in clarity/color</span>
<a name="l00155"></a>00155 <span class="comment"> */</span>
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a970b29df56fc6adea99a70c31cdfdbb9">00157</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ac4d3d24f538e74cab2213a294bdac8a1">RE_make_stars</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scenev3d, <span class="keywordtype">void</span> (*initfunc)(<span class="keywordtype">void</span>),
<a name="l00158"></a>00158                    <span class="keywordtype">void</span> (*vertexfunc)(<span class="keywordtype">float</span>*),  <span class="keywordtype">void</span> (*termfunc)(<span class="keywordtype">void</span>))
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160     <span class="keyword">extern</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>[512];
<a name="l00161"></a>00161     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00162"></a>00162     <a class="code" href="../../d7/d3f/structWorld.html">World</a> *wrld= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00163"></a>00163     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har;
<a name="l00164"></a>00164     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l00165"></a>00165     <a class="code" href="../../de/de7/structObject.html">Object</a> *camera;
<a name="l00166"></a>00166     <a class="code" href="../../d7/d7e/structCamera.html">Camera</a> *cam;
<a name="l00167"></a>00167     <span class="keywordtype">double</span> dblrand, hlfrand;
<a name="l00168"></a>00168     <span class="keywordtype">float</span> vec[4], fx, fy, fz;
<a name="l00169"></a>00169     <span class="keywordtype">float</span> fac, starmindist, clipend;
<a name="l00170"></a>00170     <span class="keywordtype">float</span> mat[4][4], stargrid, maxrand, maxjit, force, alpha;
<a name="l00171"></a>00171     <span class="keywordtype">int</span> x, y, z, sx, sy, sz, ex, ey, ez, done = 0;
<a name="l00172"></a>00172     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> totstar= 0;
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (initfunc) {
<a name="l00175"></a>00175         scene= scenev3d;
<a name="l00176"></a>00176         wrld= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>;
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     <span class="keywordflow">else</span> {
<a name="l00179"></a>00179         scene= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>;
<a name="l00180"></a>00180         wrld= &amp;(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     stargrid = wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a5ece08f651fdff9273a5af272b4d0291">stardist</a>;          <span class="comment">/* distance between stars */</span>
<a name="l00184"></a>00184     maxrand = 2.0;                      <span class="comment">/* amount a star can be shifted (in grid units) */</span>
<a name="l00185"></a>00185     maxjit = (wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ac06ddc109686cd60124b86db49f40390">starcolnoise</a>);      <span class="comment">/* amount a color is being shifted */</span>
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     <span class="comment">/* size of stars */</span>
<a name="l00188"></a>00188     force = ( wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#aa0579890ef61a61dcf8b5fbf8b264a98">starsize</a> );
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     <span class="comment">/* minimal free space (starting at camera) */</span>
<a name="l00191"></a>00191     starmindist= wrld-&gt;<a class="code" href="../../d7/d3f/structWorld.html#af78c95ac35785e960b6ddff7e0c8c111">starmindist</a>;
<a name="l00192"></a>00192     
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (stargrid &lt;= 0.10f) <span class="keywordflow">return</span>;
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (re) re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ad758d53fba824ee16d02d838040740d5">R_HALO</a>;
<a name="l00196"></a>00196     <span class="keywordflow">else</span> stargrid *= 1.0f;              <span class="comment">/* then it draws fewer */</span>
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (re) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l00199"></a>00199     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(mat);
<a name="l00200"></a>00200     
<a name="l00201"></a>00201     <span class="comment">/* BOUNDING BOX CALCULATION</span>
<a name="l00202"></a>00202 <span class="comment">     * bbox goes from z = loc_near_var | loc_far_var,</span>
<a name="l00203"></a>00203 <span class="comment">     * x = -z | +z,</span>
<a name="l00204"></a>00204 <span class="comment">     * y = -z | +z</span>
<a name="l00205"></a>00205 <span class="comment">     */</span>
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     camera= re ? <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a079fedad6d703b0a3022a3541c77a1ac">RE_GetCamera</a>(re) : scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (camera==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || camera-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#afd7fa4376c670f245aeed7a7116c7005">OB_CAMERA</a>)
<a name="l00210"></a>00210         <span class="keywordflow">return</span>;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     cam = camera-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00213"></a>00213     clipend = cam-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a394ace3dbfbcb6a755adb8690fe76288">clipend</a>;
<a name="l00214"></a>00214     
<a name="l00215"></a>00215     <span class="comment">/* convert to grid coordinates */</span>
<a name="l00216"></a>00216     
<a name="l00217"></a>00217     sx = ((mat[3][0] - clipend) / stargrid) - maxrand;
<a name="l00218"></a>00218     sy = ((mat[3][1] - clipend) / stargrid) - maxrand;
<a name="l00219"></a>00219     sz = ((mat[3][2] - clipend) / stargrid) - maxrand;
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     ex = ((mat[3][0] + clipend) / stargrid) + maxrand;
<a name="l00222"></a>00222     ey = ((mat[3][1] + clipend) / stargrid) + maxrand;
<a name="l00223"></a>00223     ez = ((mat[3][2] + clipend) / stargrid) + maxrand;
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     dblrand = maxrand * stargrid;
<a name="l00226"></a>00226     hlfrand = 2.0 * dblrand;
<a name="l00227"></a>00227     
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (initfunc) {
<a name="l00229"></a>00229         initfunc(); 
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (re) <span class="comment">/* add render object for stars */</span>
<a name="l00233"></a>00233         obr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a7ed1c61a9f360b6f0d29e5cdc7f77ff5">RE_addRenderObject</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, 0);
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     <span class="keywordflow">for</span> (x = sx, fx = sx * stargrid; x &lt;= ex; x++, fx += stargrid) {
<a name="l00236"></a>00236         <span class="keywordflow">for</span> (y = sy, fy = sy * stargrid; y &lt;= ey ; y++, fy += stargrid) {
<a name="l00237"></a>00237             <span class="keywordflow">for</span> (z = sz, fz = sz * stargrid; z &lt;= ez; z++, fz += stargrid) {
<a name="l00238"></a>00238 
<a name="l00239"></a>00239                 <a class="code" href="../../d3/d88/BLI__rand_8h.html#a60a4a9e4b37c435f7f7a122c001f7e74">BLI_srand</a>((hash[z &amp; 0xff] &lt;&lt; 24) + (hash[y &amp; 0xff] &lt;&lt; 16) + (hash[x &amp; 0xff] &lt;&lt; 8));
<a name="l00240"></a>00240                 vec[0] = fx + (hlfrand * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) - dblrand;
<a name="l00241"></a>00241                 vec[1] = fy + (hlfrand * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) - dblrand;
<a name="l00242"></a>00242                 vec[2] = fz + (hlfrand * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) - dblrand;
<a name="l00243"></a>00243                 vec[3] = 1.0;
<a name="l00244"></a>00244                 
<a name="l00245"></a>00245                 <span class="keywordflow">if</span> (vertexfunc) {
<a name="l00246"></a>00246                     <span class="keywordflow">if</span> (done &amp; 1) vertexfunc(vec);
<a name="l00247"></a>00247                     done++;
<a name="l00248"></a>00248                 }
<a name="l00249"></a>00249                 <span class="keywordflow">else</span> {
<a name="l00250"></a>00250                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vec);
<a name="l00251"></a>00251                     
<a name="l00252"></a>00252                     <span class="comment">/* in vec are global coordinates</span>
<a name="l00253"></a>00253 <span class="comment">                     * calculate distance to camera</span>
<a name="l00254"></a>00254 <span class="comment">                     * and using that, define the alpha</span>
<a name="l00255"></a>00255 <span class="comment">                     */</span>
<a name="l00256"></a>00256                     
<a name="l00257"></a>00257                     {
<a name="l00258"></a>00258                         <span class="keywordtype">float</span> tx, ty, <a class="code" href="../../d3/d31/cloth_8c.html#a8d92eb5365bf866b9f88bfb28c8ac25a">tz</a>;
<a name="l00259"></a>00259                         
<a name="l00260"></a>00260                         tx = vec[0];
<a name="l00261"></a>00261                         ty = vec[1];
<a name="l00262"></a>00262                         tz = vec[2];
<a name="l00263"></a>00263                         
<a name="l00264"></a>00264                         alpha = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(tx * tx + ty * ty + tz * tz);
<a name="l00265"></a>00265                         
<a name="l00266"></a>00266                         <span class="keywordflow">if</span> (alpha &gt;= clipend) alpha = 0.0;
<a name="l00267"></a>00267                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (alpha &lt;= starmindist) alpha = 0.0;
<a name="l00268"></a>00268                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (alpha &lt;= 2.0f * starmindist) {
<a name="l00269"></a>00269                             alpha = (alpha - starmindist) / starmindist;
<a name="l00270"></a>00270                         }
<a name="l00271"></a>00271                         <span class="keywordflow">else</span> {
<a name="l00272"></a>00272                             alpha -= 2.0f * starmindist;
<a name="l00273"></a>00273                             alpha /= (clipend - 2.0f * starmindist);
<a name="l00274"></a>00274                             alpha = 1.0f - alpha;
<a name="l00275"></a>00275                         }
<a name="l00276"></a>00276                     }
<a name="l00277"></a>00277                     
<a name="l00278"></a>00278                     
<a name="l00279"></a>00279                     <span class="keywordflow">if</span> (alpha != 0.0f) {
<a name="l00280"></a>00280                         fac = force * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>();
<a name="l00281"></a>00281                         
<a name="l00282"></a>00282                         har = <a class="code" href="../../d2/d47/convertblender_8c.html#a02ec2a7265432274afa1d16364277fd9">initstar</a>(re, obr, vec, fac);
<a name="l00283"></a>00283                         
<a name="l00284"></a>00284                         <span class="keywordflow">if</span> (har) {
<a name="l00285"></a>00285                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a68d719be1aed339ef904c34afa550ab4">alfa</a> = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(alpha));
<a name="l00286"></a>00286                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a9c7c81ff8780b10ac42dc01ebc53e443">add</a>= 255;
<a name="l00287"></a>00287                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a> = har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a> = har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a> = 1.0;
<a name="l00288"></a>00288                             <span class="keywordflow">if</span> (maxjit) {
<a name="l00289"></a>00289                                 har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a> += ((maxjit * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) ) - maxjit;
<a name="l00290"></a>00290                                 har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a> += ((maxjit * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) ) - maxjit;
<a name="l00291"></a>00291                                 har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a> += ((maxjit * <a class="code" href="../../d3/d88/BLI__rand_8h.html#a8df6b48dcc5087d80d3053d11faf7c0b">BLI_drand</a>()) ) - maxjit;
<a name="l00292"></a>00292                             }
<a name="l00293"></a>00293                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ac33c1ea4cecf2ecc66b448986f0e1693">hard</a> = 32;
<a name="l00294"></a>00294                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4846848b366b4f085ce68cf576e2b411">lay</a>= -1;
<a name="l00295"></a>00295                             har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> |= <a class="code" href="../../d0/db6/renderdatabase_8h.html#aca296043eb7e9833b210a663ad55f2c8">HA_ONLYSKY</a>;
<a name="l00296"></a>00296                             done++;
<a name="l00297"></a>00297                         }
<a name="l00298"></a>00298                     }
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 <span class="comment">/* break out of the loop if generating stars takes too long */</span>
<a name="l00302"></a>00302                 <span class="keywordflow">if</span> (re &amp;&amp; !(totstar % 1000000)) {
<a name="l00303"></a>00303                     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l00304"></a>00304                         x= ex + 1;
<a name="l00305"></a>00305                         y= ey + 1;
<a name="l00306"></a>00306                         z= ez + 1;
<a name="l00307"></a>00307                     }
<a name="l00308"></a>00308                 }
<a name="l00309"></a>00309                 
<a name="l00310"></a>00310                 totstar++;
<a name="l00311"></a>00311             }
<a name="l00312"></a>00312             <span class="comment">/* do not call blender_test_break() here, since it is used in UI as well, confusing the callback system */</span>
<a name="l00313"></a>00313             <span class="comment">/* main cause is G.afbreek of course, a global again... (ton) */</span>
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (termfunc) termfunc();
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (obr)
<a name="l00319"></a>00319         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00324"></a>00324 <span class="comment">/* tool functions/defines for ad hoc simplification and possible future </span>
<a name="l00325"></a>00325 <span class="comment"> * cleanup      */</span>
<a name="l00326"></a>00326 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">00328</a> <span class="preprocessor">#define UVTOINDEX(u,v) (startvlak + (u) * sizev + (v))</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00330"></a>00330 <span class="comment"></span>
<a name="l00331"></a>00331 <span class="comment">NOTE THAT U/V COORDINATES ARE SOMETIMES SWAPPED !!</span>
<a name="l00332"></a>00332 <span class="comment">    </span>
<a name="l00333"></a>00333 <span class="comment">^   ()----p4----p3----()</span>
<a name="l00334"></a>00334 <span class="comment">|   |     |     |     |</span>
<a name="l00335"></a>00335 <span class="comment">u   |     |  F1 |  F2 |</span>
<a name="l00336"></a>00336 <span class="comment">    |     |     |     |</span>
<a name="l00337"></a>00337 <span class="comment">    ()----p1----p2----()</span>
<a name="l00338"></a>00338 <span class="comment">           v -&gt;</span>
<a name="l00339"></a>00339 <span class="comment">*/</span>
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00342"></a>00342 
<a name="l00343"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ab2cfee3d472b1bc4eab095d976a49c97">00343</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ab2cfee3d472b1bc4eab095d976a49c97">split_v_renderfaces</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> startvlak, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(startvert), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(usize), <span class="keywordtype">int</span> vsize, <span class="keywordtype">int</span> uIndex, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cyclu), <span class="keywordtype">int</span> cyclv)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="keywordtype">int</span> vLen = vsize-1+(!!cyclv);
<a name="l00346"></a>00346     <span class="keywordtype">int</span> v;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="keywordflow">for</span> (v=0; v&lt;vLen; v++) {
<a name="l00349"></a>00349         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, startvlak + vLen*uIndex + v);
<a name="l00350"></a>00350         <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *vert = <a class="code" href="../../d0/db6/renderdatabase_8h.html#abc41d308bc020e7fb109508c7eef9997">RE_vertren_copy</a>(obr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="keywordflow">if</span> (cyclv) {
<a name="l00353"></a>00353             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a> = vert;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355             <span class="keywordflow">if</span> (v==vLen-1) {
<a name="l00356"></a>00356                 <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, startvlak + vLen*uIndex + 0);
<a name="l00357"></a>00357                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a> = vert;
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359             <span class="keywordflow">else</span> {
<a name="l00360"></a>00360                 <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, startvlak + vLen*uIndex + v+1);
<a name="l00361"></a>00361                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a> = vert;
<a name="l00362"></a>00362             }
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364         <span class="keywordflow">else</span> {
<a name="l00365"></a>00365             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a> = vert;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (v&lt;vLen-1) {
<a name="l00368"></a>00368                 <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, startvlak + vLen*uIndex + v+1);
<a name="l00369"></a>00369                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a> = vert;
<a name="l00370"></a>00370             }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372             <span class="keywordflow">if</span> (v==0) {
<a name="l00373"></a>00373                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a> = <a class="code" href="../../d0/db6/renderdatabase_8h.html#abc41d308bc020e7fb109508c7eef9997">RE_vertren_copy</a>(obr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>);
<a name="l00374"></a>00374             } 
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00380"></a>00380 <span class="comment">/* Stress, tangents and normals                                              */</span>
<a name="l00381"></a>00381 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00382"></a>00382 
<a name="l00383"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">00383</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(<span class="keywordtype">float</span> *accum, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v2)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>)/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>);
<a name="l00386"></a>00386     <span class="keywordtype">float</span> *acc;
<a name="l00387"></a>00387     
<a name="l00388"></a>00388     acc= accum + 2*v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>;
<a name="l00389"></a>00389     acc[0]+= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00390"></a>00390     acc[1]+= 1.0f;
<a name="l00391"></a>00391     
<a name="l00392"></a>00392     acc= accum + 2*v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>;
<a name="l00393"></a>00393     acc[0]+= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00394"></a>00394     acc[1]+= 1.0f;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a><a class="code" href="../../d2/d47/convertblender_8c.html#acd53955310315f45da98c98ab09ca05c">00397</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#acd53955310315f45da98c98ab09ca05c">calc_edge_stress</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <span class="keywordtype">float</span> loc[3], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[3], *accum, *acc, *accumoffs, *stress;
<a name="l00400"></a>00400     <span class="keywordtype">int</span> a;
<a name="l00401"></a>00401     
<a name="l00402"></a>00402     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>==0) <span class="keywordflow">return</span>;
<a name="l00403"></a>00403     
<a name="l00404"></a>00404     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#ac4f3c3b63da7e1e65a49d259a39bb7a4">mesh_get_texspace</a>(me, loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, size);
<a name="l00405"></a>00405     
<a name="l00406"></a>00406     accum= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(2*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>, <span class="stringliteral">&quot;temp accum for stress&quot;</span>);
<a name="l00407"></a>00407     
<a name="l00408"></a>00408     <span class="comment">/* de-normalize orco */</span>
<a name="l00409"></a>00409     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l00410"></a>00410         <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>) {
<a name="l00412"></a>00412             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[0]= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[0]*size[0] +loc[0];
<a name="l00413"></a>00413             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[1]= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[1]*size[1] +loc[1];
<a name="l00414"></a>00414             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[2]= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[2]*size[2] +loc[2];
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417     
<a name="l00418"></a>00418     <span class="comment">/* add stress values */</span>
<a name="l00419"></a>00419     accumoffs= accum;   <span class="comment">/* so we can use vertex index */</span>
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00421"></a>00421         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a> &amp;&amp; vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l00424"></a>00424             <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>);
<a name="l00425"></a>00425             <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>);
<a name="l00426"></a>00426             <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>);
<a name="l00427"></a>00427             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l00428"></a>00428                 <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>);
<a name="l00429"></a>00429                 <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>);
<a name="l00430"></a>00430                 <a class="code" href="../../d2/d47/convertblender_8c.html#aa69d98a45dd65a01a7b86d97c4234990">calc_edge_stress_add</a>(accumoffs, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>);
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l00436"></a>00436         <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>) {
<a name="l00438"></a>00438             <span class="comment">/* find stress value */</span>
<a name="l00439"></a>00439             acc= accumoffs + 2*ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>;
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (acc[1]!=0.0f)
<a name="l00441"></a>00441                 acc[0]/= acc[1];
<a name="l00442"></a>00442             stress= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac6265369f1b2b43fe1c4586fe4b55d6e">RE_vertren_get_stress</a>(obr, ver, 1);
<a name="l00443"></a>00443             *stress= *acc;
<a name="l00444"></a>00444             
<a name="l00445"></a>00445             <span class="comment">/* restore orcos */</span>
<a name="l00446"></a>00446             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[0] = (ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[0]-loc[0])/size[0];
<a name="l00447"></a>00447             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[1] = (ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[1]-loc[1])/size[1];
<a name="l00448"></a>00448             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[2] = (ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[2]-loc[2])/size[2];
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     
<a name="l00452"></a>00452     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(accum);
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="comment">/* gets tangent from tface or orco */</span>
<a name="l00456"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a4bf7cb2b3f95d81c24a13d672da33b93">00456</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a4bf7cb2b3f95d81c24a13d672da33b93">calc_tangent_vector</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> **vtangents, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">int</span> do_nmap_tangent, <span class="keywordtype">int</span> do_tangent)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a8b8dcf45053513ce813d68866c66c983">actmtface</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00459"></a>00459     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>, *v2=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, *v3=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, *v4=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l00460"></a>00460     <span class="keywordtype">float</span> tang[3], *tav;
<a name="l00461"></a>00461     <span class="keywordtype">float</span> *uv1, *uv2, *uv3, *uv4;
<a name="l00462"></a>00462     <span class="keywordtype">float</span> uv[4][2];
<a name="l00463"></a>00463     
<a name="l00464"></a>00464     <span class="keywordflow">if</span> (tface) {
<a name="l00465"></a>00465         uv1= tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0];
<a name="l00466"></a>00466         uv2= tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1];
<a name="l00467"></a>00467         uv3= tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l00468"></a>00468         uv4= tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3];
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>) {
<a name="l00471"></a>00471         uv1= uv[0]; uv2= uv[1]; uv3= uv[2]; uv4= uv[3];
<a name="l00472"></a>00472         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[0][0], &amp;uv[0][1],v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[0], v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[1], v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>[2]);
<a name="l00473"></a>00473         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[1][0], &amp;uv[1][1],v2-&gt;orco[0], v2-&gt;orco[1], v2-&gt;orco[2]);
<a name="l00474"></a>00474         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[2][0], &amp;uv[2][1],v3-&gt;orco[0], v3-&gt;orco[1], v3-&gt;orco[2]);
<a name="l00475"></a>00475         <span class="keywordflow">if</span> (v4)
<a name="l00476"></a>00476             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[3][0], &amp;uv[3][1],v4-&gt;orco[0], v4-&gt;orco[1], v4-&gt;orco[2]);
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <span class="keywordflow">else</span> <span class="keywordflow">return</span>;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaba45324d81462685b3b3b650ea84e3f">tangent_from_uv</a>(uv1, uv2, uv3, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v2-&gt;co, v3-&gt;co, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, tang);
<a name="l00481"></a>00481     
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (do_tangent) {
<a name="l00483"></a>00483         tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v1, 1);
<a name="l00484"></a>00484         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00485"></a>00485         tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v2, 1);
<a name="l00486"></a>00486         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00487"></a>00487         tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v3, 1);
<a name="l00488"></a>00488         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490     
<a name="l00491"></a>00491     <span class="keywordflow">if</span> (do_nmap_tangent) {
<a name="l00492"></a>00492         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>], tang, uv1);
<a name="l00493"></a>00493         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v2-&gt;index], tang, uv2);
<a name="l00494"></a>00494         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v3-&gt;index], tang, uv3);
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (v4) {
<a name="l00498"></a>00498         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaba45324d81462685b3b3b650ea84e3f">tangent_from_uv</a>(uv1, uv3, uv4, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v3-&gt;co, v4-&gt;co, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, tang);
<a name="l00499"></a>00499         
<a name="l00500"></a>00500         <span class="keywordflow">if</span> (do_tangent) {
<a name="l00501"></a>00501             tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v1, 1);
<a name="l00502"></a>00502             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00503"></a>00503             tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v3, 1);
<a name="l00504"></a>00504             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00505"></a>00505             tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, v4, 1);
<a name="l00506"></a>00506             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tav, tang);
<a name="l00507"></a>00507         }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (do_nmap_tangent) {
<a name="l00510"></a>00510             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>], tang, uv1);
<a name="l00511"></a>00511             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v3-&gt;index], tang, uv3);
<a name="l00512"></a>00512             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[v4-&gt;index], tang, uv4);
<a name="l00513"></a>00513         }
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="comment">/****************************************************************</span>
<a name="l00520"></a>00520 <span class="comment"> ************ tangent space generation interface ****************</span>
<a name="l00521"></a>00521 <span class="comment"> ****************************************************************/</span>
<a name="l00522"></a>00522 
<a name="l00523"></a><a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">00523</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l00524"></a>00524 {
<a name="l00525"></a><a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">00525</a>     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 } <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a>;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529 <span class="comment">// interface</span>
<a name="l00530"></a>00530 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d68/mikktspace_8h.html">mikktspace.h</a>&quot;</span>
<a name="l00531"></a>00531 
<a name="l00532"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">00532</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">GetNumFaces</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext)
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00535"></a>00535     <span class="keywordflow">return</span> pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">00538</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">GetNumVertsOfFace</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keyword">const</span> <span class="keywordtype">int</span> face_num)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00541"></a>00541     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, face_num);
<a name="l00542"></a>00542     <span class="keywordflow">return</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ? 4 : 3;
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">00545</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">GetPosition</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fPos[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l00546"></a>00546 {
<a name="l00547"></a>00547     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l00548"></a>00548     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00549"></a>00549     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, face_num);
<a name="l00550"></a>00550     <span class="keyword">const</span> <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= (&amp;vlr-&gt;v1)[vert_index]-&gt;co;
<a name="l00551"></a>00551     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fPos, co);
<a name="l00552"></a>00552 }
<a name="l00553"></a>00553 
<a name="l00554"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a29515ce64a75f208fbc86d676f61d5ca">00554</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a29515ce64a75f208fbc86d676f61d5ca">GetTextureCoordinate</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fUV[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l00557"></a>00557     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00558"></a>00558     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, face_num);
<a name="l00559"></a>00559     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, vlr, pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a8b8dcf45053513ce813d68866c66c983">actmtface</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00560"></a>00560     <span class="keyword">const</span> <span class="keywordtype">float</span> *coord;
<a name="l00561"></a>00561     
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (tface != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)  {
<a name="l00563"></a>00563         coord= tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[vert_index];
<a name="l00564"></a>00564         fUV[0]= coord[0]; fUV[1]= coord[1];
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((coord= (&amp;vlr-&gt;v1)[vert_index]-&gt;orco)) {
<a name="l00567"></a>00567         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>(&amp;fUV[0], &amp;fUV[1], coord[0], coord[1], coord[2]);
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <span class="keywordflow">else</span> { <span class="comment">/* else we get un-initialized value, 0.0 ok default? */</span>
<a name="l00570"></a>00570         fUV[0]= fUV[1]= 0.0f;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">00574</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">GetNormal</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fNorm[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l00575"></a>00575 {
<a name="l00576"></a>00576     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l00577"></a>00577     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00578"></a>00578     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, face_num);
<a name="l00579"></a>00579     <span class="keyword">const</span> <span class="keywordtype">float</span> *n= (&amp;vlr-&gt;v1)[vert_index]-&gt;n;
<a name="l00580"></a>00580     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fNorm, n);
<a name="l00581"></a>00581 }
<a name="l00582"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a81e0648485f316732cd9bf91f02abe98">00582</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a81e0648485f316732cd9bf91f02abe98">SetTSpace</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keyword">const</span> <span class="keywordtype">float</span> fvTangent[], <span class="keyword">const</span> <span class="keywordtype">float</span> fSign, <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> iVert)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l00585"></a>00585     <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> * pMesh = (<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l00586"></a>00586     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, face_num);
<a name="l00587"></a>00587     <span class="keywordtype">float</span> * ftang= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8e129a349c1f27fc71e85572f29d765a">RE_vlakren_get_nmap_tangent</a>(pMesh-&gt;<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a>, vlr, 1);
<a name="l00588"></a>00588     <span class="keywordflow">if</span> (ftang!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)    {
<a name="l00589"></a>00589         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(&amp;ftang[iVert*4+0], fvTangent);
<a name="l00590"></a>00590         ftang[iVert*4+3]=fSign;
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">00594</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> do_tangent, <span class="keywordtype">int</span> do_nmap_tangent)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00597"></a>00597     <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> **vtangents= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00598"></a>00598     <span class="keywordtype">int</span> a;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="keywordflow">if</span> (do_nmap_tangent) {
<a name="l00601"></a>00601         arena= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;nmap tangent arena&quot;</span>);
<a name="l00602"></a>00602         <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(arena);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         vtangents= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a>*)*obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>, <span class="stringliteral">&quot;VertexTangent&quot;</span>);
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         <span class="comment">/* clear all vertex normals */</span>
<a name="l00608"></a>00608     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l00609"></a>00609         <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00610"></a>00610         ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[0]=ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[1]=ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[2]= 0.0f;
<a name="l00611"></a>00611     }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         <span class="comment">/* calculate cos of angles and point-masses, use as weight factor to</span>
<a name="l00614"></a>00614 <span class="comment">         * add face normal to vertex */</span>
<a name="l00615"></a>00615     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00616"></a>00616         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l00617"></a>00617         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>) {
<a name="l00618"></a>00618             <span class="keywordtype">float</span> *n4= (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)? vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00619"></a>00619             <span class="keywordtype">float</span> *c4= (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)? vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8073e47ed0bac54057de95147ec575db">accumulate_vertex_normals</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n4,
<a name="l00622"></a>00622                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, c4);
<a name="l00623"></a>00623         }
<a name="l00624"></a>00624         <span class="keywordflow">if</span> (do_nmap_tangent || do_tangent) {
<a name="l00625"></a>00625             <span class="comment">/* tangents still need to be calculated for flat faces too */</span>
<a name="l00626"></a>00626             <span class="comment">/* weighting removed, they are not vertexnormals */</span>
<a name="l00627"></a>00627             <a class="code" href="../../d2/d47/convertblender_8c.html#a4bf7cb2b3f95d81c24a13d672da33b93">calc_tangent_vector</a>(obr, vtangents, arena, vlr, do_nmap_tangent, do_tangent);
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <span class="comment">/* do solid faces */</span>
<a name="l00632"></a>00632     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00633"></a>00633         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         <span class="keywordflow">if</span> ((vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>)==0) {
<a name="l00636"></a>00636             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>)) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l00637"></a>00637             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>)) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l00638"></a>00638             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>)) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l00639"></a>00639             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>)) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l00640"></a>00640         }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (do_nmap_tangent) {
<a name="l00643"></a>00643             <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>, *v2=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, *v3=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, *v4=vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l00644"></a>00644             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a8b8dcf45053513ce813d68866c66c983">actmtface</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646             <span class="keywordflow">if</span> (tface) {
<a name="l00647"></a>00647                 <span class="keywordtype">int</span> k=0;
<a name="l00648"></a>00648                 <span class="keywordtype">float</span> *vtang, *ftang= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8e129a349c1f27fc71e85572f29d765a">RE_vlakren_get_nmap_tangent</a>(obr, vlr, 1);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650                 vtang= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(vtangents[v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>], tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0]);
<a name="l00651"></a>00651                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ftang, vtang);
<a name="l00652"></a>00652                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ftang);
<a name="l00653"></a>00653                 vtang= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(vtangents[v2-&gt;index], tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1]);
<a name="l00654"></a>00654                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ftang+4, vtang);
<a name="l00655"></a>00655                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ftang+4);
<a name="l00656"></a>00656                 vtang= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(vtangents[v3-&gt;index], tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2]);
<a name="l00657"></a>00657                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ftang+8, vtang);
<a name="l00658"></a>00658                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ftang+8);
<a name="l00659"></a>00659                 <span class="keywordflow">if</span> (v4) {
<a name="l00660"></a>00660                     vtang= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(vtangents[v4-&gt;index], tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3]);
<a name="l00661"></a>00661                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ftang+12, vtang);
<a name="l00662"></a>00662                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ftang+12);
<a name="l00663"></a>00663                 }
<a name="l00664"></a>00664                 <span class="keywordflow">for</span> (k=0; k&lt;4; k++) ftang[4*k+3]=1;
<a name="l00665"></a>00665             }
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667     }
<a name="l00668"></a>00668     
<a name="l00669"></a>00669     <span class="comment">/* normalize vertex normals */</span>
<a name="l00670"></a>00670     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l00671"></a>00671         <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00672"></a>00672         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l00673"></a>00673         <span class="keywordflow">if</span> (do_tangent) {
<a name="l00674"></a>00674             <span class="keywordtype">float</span> *tav= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a67ee5df39880141bf8324b579aab163b">RE_vertren_get_tangent</a>(obr, ver, 0);
<a name="l00675"></a>00675             <span class="keywordflow">if</span> (tav) {
<a name="l00676"></a>00676                 <span class="comment">/* orthonorm. */</span>
<a name="l00677"></a>00677                 <span class="keyword">const</span> <span class="keywordtype">float</span> tdn = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(tav, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l00678"></a>00678                 tav[0] -= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[0]*tdn;
<a name="l00679"></a>00679                 tav[1] -= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[1]*tdn;
<a name="l00680"></a>00680                 tav[2] -= ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[2]*tdn;
<a name="l00681"></a>00681                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tav);
<a name="l00682"></a>00682             }
<a name="l00683"></a>00683         }
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (do_nmap_tangent != 0) {
<a name="l00687"></a>00687         <a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a> mesh2tangent;
<a name="l00688"></a>00688         <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> sContext;
<a name="l00689"></a>00689         <a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html">SMikkTSpaceInterface</a> sInterface;
<a name="l00690"></a>00690         memset(&amp;mesh2tangent, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html">SRenderMeshToTangent</a>));
<a name="l00691"></a>00691         memset(&amp;sContext, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a>));
<a name="l00692"></a>00692         memset(&amp;sInterface, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html">SMikkTSpaceInterface</a>));
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         mesh2tangent.<a class="code" href="../../de/d0d/structSRenderMeshToTangent.html#a666e23bca3b80036e5e1b26eb9a23c8e">obr</a> = obr;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         sContext.<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a> = &amp;mesh2tangent;
<a name="l00697"></a>00697         sContext.<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a06f3a644c8b3236e23e7254863e85490">m_pInterface</a> = &amp;sInterface;
<a name="l00698"></a>00698         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a9fdecb1f66d99797e33d82c951581604">m_getNumFaces</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">GetNumFaces</a>;
<a name="l00699"></a>00699         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a5c2aee0b507cd4358d2e788dd879c688">m_getNumVerticesOfFace</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">GetNumVertsOfFace</a>;
<a name="l00700"></a>00700         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#ad5cccc1210db6ca934dec70756825faa">m_getPosition</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">GetPosition</a>;
<a name="l00701"></a>00701         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#ad5839c559cfb6db6c4a0a2b30a30c12e">m_getTexCoord</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#a29515ce64a75f208fbc86d676f61d5ca">GetTextureCoordinate</a>;
<a name="l00702"></a>00702         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a39461c5429112f6eeac3bc8e2398a4ec">m_getNormal</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">GetNormal</a>;
<a name="l00703"></a>00703         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a23ae8ce236e6ba34c16599db4a364f48">m_setTSpaceBasic</a> = <a class="code" href="../../d2/d47/convertblender_8c.html#a81e0648485f316732cd9bf91f02abe98">SetTSpace</a>;
<a name="l00704"></a>00704 
<a name="l00705"></a>00705         <a class="code" href="../../d8/d91/mikktspace_8c.html#a89f845f84dc134105236dc7f568115d6">genTangSpaceDefault</a>(&amp;sContext);
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (arena)
<a name="l00709"></a>00709         <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(arena);
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (vtangents)
<a name="l00711"></a>00711         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vtangents);
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00715"></a>00715 <span class="comment">/* Autosmoothing:                                                            */</span>
<a name="l00716"></a>00716 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="../../de/d4a/structASvert.html">00718</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../de/d4a/structASvert.html">ASvert</a> {
<a name="l00719"></a><a class="code" href="../../de/d4a/structASvert.html#ac661d2a1e13c40fe36de1f28cf29f604">00719</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/d4a/structASvert.html#ac661d2a1e13c40fe36de1f28cf29f604">totface</a>;
<a name="l00720"></a><a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">00720</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>;
<a name="l00721"></a>00721 } <a class="code" href="../../d2/d47/convertblender_8c.html#a7cba0d850b80b2ae1d0bd9db6aef456e">ASvert</a>;
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="../../d7/d91/structASface.html">00723</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d91/structASface.html">ASface</a> {
<a name="l00724"></a><a class="code" href="../../d7/d91/structASface.html#a1d8bf94203ae9f2da26aecf6a975f189">00724</a>     <span class="keyword">struct </span><a class="code" href="../../d7/d91/structASface.html">ASface</a> *<a class="code" href="../../d7/d91/structASface.html#a74dc68293aeff21449bd5bf07980779f">next</a>, *<a class="code" href="../../d7/d91/structASface.html#a1d8bf94203ae9f2da26aecf6a975f189">prev</a>;
<a name="l00725"></a><a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">00725</a>     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[4];
<a name="l00726"></a><a class="code" href="../../d7/d91/structASface.html#ac1eb62b8466b479abd4fc11dfe48ca57">00726</a>     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *<a class="code" href="../../d7/d91/structASface.html#ac1eb62b8466b479abd4fc11dfe48ca57">nver</a>[4];
<a name="l00727"></a>00727 } <a class="code" href="../../d2/d47/convertblender_8c.html#a502f73eb8a8df5a50754e89f46a0fc49">ASface</a>;
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">00729</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">as_addvert</a>(<a class="code" href="../../de/d4a/structASvert.html">ASvert</a> *asv, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>)
<a name="l00730"></a>00730 {
<a name="l00731"></a>00731     <a class="code" href="../../d7/d91/structASface.html">ASface</a> *asf;
<a name="l00732"></a>00732     <span class="keywordtype">int</span> a;
<a name="l00733"></a>00733     
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (v1 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     <span class="keywordflow">if</span> (asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00737"></a>00737         asf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d91/structASface.html">ASface</a>), <span class="stringliteral">&quot;asface&quot;</span>);
<a name="l00738"></a>00738         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>, asf);
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     asf= asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00742"></a>00742     <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00744"></a>00744             asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]= <a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>;
<a name="l00745"></a>00745             asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#ac661d2a1e13c40fe36de1f28cf29f604">totface</a>++;
<a name="l00746"></a>00746             <span class="keywordflow">break</span>;
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     
<a name="l00750"></a>00750     <span class="comment">/* new face struct */</span>
<a name="l00751"></a>00751     <span class="keywordflow">if</span> (a==4) {
<a name="l00752"></a>00752         asf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d91/structASface.html">ASface</a>), <span class="stringliteral">&quot;asface&quot;</span>);
<a name="l00753"></a>00753         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>, asf);
<a name="l00754"></a>00754         asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[0]= <a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>;
<a name="l00755"></a>00755         asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#ac661d2a1e13c40fe36de1f28cf29f604">totface</a>++;
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ab1f087794d2bac04312b31a287d5f2ea">00759</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ab1f087794d2bac04312b31a287d5f2ea">as_testvertex</a>(<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ver), <a class="code" href="../../de/d4a/structASvert.html">ASvert</a> *asv, <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>)
<a name="l00760"></a>00760 {
<a name="l00761"></a>00761     <span class="comment">/* return 1: vertex needs a copy */</span>
<a name="l00762"></a>00762     <a class="code" href="../../d7/d91/structASface.html">ASface</a> *asf;
<a name="l00763"></a>00763     <span class="keywordtype">float</span> inp;
<a name="l00764"></a>00764     <span class="keywordtype">int</span> a;
<a name="l00765"></a>00765     
<a name="l00766"></a>00766     <span class="keywordflow">if</span> (vlr==0) <span class="keywordflow">return</span> 0;
<a name="l00767"></a>00767     
<a name="l00768"></a>00768     asf= asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00769"></a>00769     <span class="keywordflow">while</span> (asf) {
<a name="l00770"></a>00770         <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l00771"></a>00771             <span class="keywordflow">if</span> (asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a] &amp;&amp; asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]!=vlr) {
<a name="l00772"></a>00772                 inp = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>));
<a name="l00773"></a>00773                 <span class="keywordflow">if</span> (inp &lt; thresh) <span class="keywordflow">return</span> 1;
<a name="l00774"></a>00774             }
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776         asf= asf-&gt;<a class="code" href="../../d7/d91/structASface.html#a74dc68293aeff21449bd5bf07980779f">next</a>;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778     
<a name="l00779"></a>00779     <span class="keywordflow">return</span> 0;
<a name="l00780"></a>00780 }
<a name="l00781"></a>00781 
<a name="l00782"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a39b2908a468218378113435981816cd2">00782</a> <span class="keyword">static</span> <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#a39b2908a468218378113435981816cd2">as_findvertex</a>(<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ver), <a class="code" href="../../de/d4a/structASvert.html">ASvert</a> *asv, <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>)
<a name="l00783"></a>00783 {
<a name="l00784"></a>00784     <span class="comment">/* return when new vertex already was made */</span>
<a name="l00785"></a>00785     <a class="code" href="../../d7/d91/structASface.html">ASface</a> *asf;
<a name="l00786"></a>00786     <span class="keywordtype">float</span> inp;
<a name="l00787"></a>00787     <span class="keywordtype">int</span> a;
<a name="l00788"></a>00788     
<a name="l00789"></a>00789     asf= asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00790"></a>00790     <span class="keywordflow">while</span> (asf) {
<a name="l00791"></a>00791         <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l00792"></a>00792             <span class="keywordflow">if</span> (asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a] &amp;&amp; asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]!=vlr) {
<a name="l00793"></a>00793                 <span class="comment">/* this face already made a copy for this vertex! */</span>
<a name="l00794"></a>00794                 <span class="keywordflow">if</span> (asf-&gt;<a class="code" href="../../d7/d91/structASface.html#ac1eb62b8466b479abd4fc11dfe48ca57">nver</a>[a]) {
<a name="l00795"></a>00795                     inp = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[a]-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>));
<a name="l00796"></a>00796                     <span class="keywordflow">if</span> (inp &gt;= thresh) {
<a name="l00797"></a>00797                         <span class="keywordflow">return</span> asf-&gt;<a class="code" href="../../d7/d91/structASface.html#ac1eb62b8466b479abd4fc11dfe48ca57">nver</a>[a];
<a name="l00798"></a>00798                     }
<a name="l00799"></a>00799                 }
<a name="l00800"></a>00800             }
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802         asf= asf-&gt;<a class="code" href="../../d7/d91/structASface.html#a74dc68293aeff21449bd5bf07980779f">next</a>;
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804     
<a name="l00805"></a>00805     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808 <span class="comment">/* note; autosmooth happens in object space still, after applying autosmooth we rotate */</span>
<a name="l00809"></a>00809 <span class="comment">/* note2; actually, when original mesh and displist are equal sized, face normals are from original mesh */</span>
<a name="l00810"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a3711f2b306dd7770e8e1c1d4a943dd10">00810</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a3711f2b306dd7770e8e1c1d4a943dd10">autosmooth</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">int</span> degr)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812     <a class="code" href="../../de/d4a/structASvert.html">ASvert</a> *asv, *asverts;
<a name="l00813"></a>00813     <a class="code" href="../../d7/d91/structASface.html">ASface</a> *asf;
<a name="l00814"></a>00814     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver, *v1;
<a name="l00815"></a>00815     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>;
<a name="l00816"></a>00816     <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>;
<a name="l00817"></a>00817     <span class="keywordtype">int</span> a, b, totvert;
<a name="l00818"></a>00818     
<a name="l00819"></a>00819     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>==0) <span class="keywordflow">return</span>;
<a name="l00820"></a>00820     asverts= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d4a/structASvert.html">ASvert</a>)*obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>, <span class="stringliteral">&quot;all smooth verts&quot;</span>);
<a name="l00821"></a>00821     
<a name="l00822"></a>00822     thresh= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(<a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>((0.5f + (<span class="keywordtype">float</span>)degr)));
<a name="l00823"></a>00823     
<a name="l00824"></a>00824     <span class="comment">/* step zero: give faces normals of original mesh, if this is provided */</span>
<a name="l00825"></a>00825     
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     <span class="comment">/* step one: construct listbase of all vertices and pointers to faces */</span>
<a name="l00828"></a>00828     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00829"></a>00829         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l00830"></a>00830         <span class="comment">/* skip wire faces */</span>
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a> != vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>) {
<a name="l00832"></a>00832             <a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">as_addvert</a>(asverts+vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>, vlr);
<a name="l00833"></a>00833             <a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">as_addvert</a>(asverts+vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, vlr);
<a name="l00834"></a>00834             <a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">as_addvert</a>(asverts+vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, vlr);
<a name="l00835"></a>00835             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l00836"></a>00836                 <a class="code" href="../../d2/d47/convertblender_8c.html#a853cc6687d8d721931711ab108d7da70">as_addvert</a>(asverts+vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>, vlr);
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     totvert= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l00841"></a>00841     <span class="comment">/* we now test all vertices, when faces have a normal too much different: they get a new vertex */</span>
<a name="l00842"></a>00842     <span class="keywordflow">for</span> (a=0, asv=asverts; a&lt;totvert; a++, asv++) {
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (asv &amp;&amp; asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#ac661d2a1e13c40fe36de1f28cf29f604">totface</a>&gt;1) {
<a name="l00844"></a>00844             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846             asf= asv-&gt;<a class="code" href="../../de/d4a/structASvert.html#a9e320ba5e9afb607ea40bd8732289779">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00847"></a>00847             <span class="keywordflow">while</span> (asf) {
<a name="l00848"></a>00848                 <span class="keywordflow">for</span> (b=0; b&lt;4; b++) {
<a name="l00849"></a>00849                 
<a name="l00850"></a>00850                     <span class="comment">/* is there a reason to make a new vertex? */</span>
<a name="l00851"></a>00851                     vlr= asf-&gt;<a class="code" href="../../d7/d91/structASface.html#aeb3e93c8d7682b2ef699de2809e3a5d3">vlr</a>[b];
<a name="l00852"></a>00852                     <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d47/convertblender_8c.html#ab1f087794d2bac04312b31a287d5f2ea">as_testvertex</a>(vlr, ver, asv, thresh) ) {
<a name="l00853"></a>00853                         
<a name="l00854"></a>00854                         <span class="comment">/* already made a new vertex within threshold? */</span>
<a name="l00855"></a>00855                         v1= <a class="code" href="../../d2/d47/convertblender_8c.html#a39b2908a468218378113435981816cd2">as_findvertex</a>(vlr, ver, asv, thresh);
<a name="l00856"></a>00856                         <span class="keywordflow">if</span> (v1==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00857"></a>00857                             <span class="comment">/* make a new vertex */</span>
<a name="l00858"></a>00858                             v1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#abc41d308bc020e7fb109508c7eef9997">RE_vertren_copy</a>(obr, ver);
<a name="l00859"></a>00859                         }
<a name="l00860"></a>00860                         asf-&gt;<a class="code" href="../../d7/d91/structASface.html#ac1eb62b8466b479abd4fc11dfe48ca57">nver</a>[b]= v1;
<a name="l00861"></a>00861                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>==ver) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v1;
<a name="l00862"></a>00862                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>==ver) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v1;
<a name="l00863"></a>00863                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>==ver) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= v1;
<a name="l00864"></a>00864                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>==ver) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= v1;
<a name="l00865"></a>00865                     }
<a name="l00866"></a>00866                 }
<a name="l00867"></a>00867                 asf= asf-&gt;<a class="code" href="../../d7/d91/structASface.html#a74dc68293aeff21449bd5bf07980779f">next</a>;
<a name="l00868"></a>00868             }
<a name="l00869"></a>00869         }
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871     
<a name="l00872"></a>00872     <span class="comment">/* free */</span>
<a name="l00873"></a>00873     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++) {
<a name="l00874"></a>00874         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;asverts[a].faces);
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(asverts);
<a name="l00877"></a>00877     
<a name="l00878"></a>00878     <span class="comment">/* rotate vertices and calculate normal of faces */</span>
<a name="l00879"></a>00879     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l00880"></a>00880         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00881"></a>00881         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00884"></a>00884         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l00885"></a>00885         
<a name="l00886"></a>00886         <span class="comment">/* skip wire faces */</span>
<a name="l00887"></a>00887         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a> != vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>) {
<a name="l00888"></a>00888             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l00889"></a>00889                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00890"></a>00890             <span class="keywordflow">else</span> 
<a name="l00891"></a>00891                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893     }       
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00897"></a>00897 <span class="comment">/* Orco hash and Materials                                                   */</span>
<a name="l00898"></a>00898 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00899"></a>00899 
<a name="l00900"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ad56296da8b74deccdcd514baf9a80df9">00900</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d2/d47/convertblender_8c.html#ad56296da8b74deccdcd514baf9a80df9">get_object_orco</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00901"></a>00901 {
<a name="l00902"></a>00902     <span class="keywordtype">float</span> *orco;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>)
<a name="l00905"></a>00905         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;get_object_orco gh&quot;</span>);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907     orco = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>, ob);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="keywordflow">if</span> (!orco) {
<a name="l00910"></a>00910         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1a94162b6fc469957966a01d41ff71d6">OB_FONT</a>)) {
<a name="l00911"></a>00911             orco = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#ae880524adbd5635089ac6750409f67ae">make_orco_curve</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob);
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>) {
<a name="l00914"></a>00914             orco = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a9dda72d82c2cedb90cb0085118e3b6b5">make_orco_surf</a>(ob);
<a name="l00915"></a>00915         }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (orco)
<a name="l00918"></a>00918             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>, ob, orco);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="keywordflow">return</span> orco;
<a name="l00922"></a>00922 }
<a name="l00923"></a>00923 
<a name="l00924"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">00924</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">void</span> *ob, <span class="keywordtype">float</span> *orco)
<a name="l00925"></a>00925 {
<a name="l00926"></a>00926     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>)
<a name="l00927"></a>00927         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;set_object_orco gh&quot;</span>);
<a name="l00928"></a>00928     
<a name="l00929"></a>00929     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>, ob, orco);
<a name="l00930"></a>00930 }
<a name="l00931"></a>00931 
<a name="l00932"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a677d2d504a3dc8d8ab8e0290a8ca4dd6">00932</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a677d2d504a3dc8d8ab8e0290a8ca4dd6">free_mesh_orco_hash</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re) 
<a name="l00933"></a>00933 {
<a name="l00934"></a>00934     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>) {
<a name="l00935"></a>00935         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a53210a0b5c7bd4568f50f16dd85f04a6">GHashValFreeFP</a>)<a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>);
<a name="l00936"></a>00936         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8b5e089024b28c29f185414a92b6840c">orco_hash</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00937"></a>00937     }
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a550e3b4787300a52580eda42146e37a9">00940</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a550e3b4787300a52580eda42146e37a9">check_material_mapto</a>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma)
<a name="l00941"></a>00941 {
<a name="l00942"></a>00942     <span class="keywordtype">int</span> a;
<a name="l00943"></a>00943     ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> = 0;
<a name="l00944"></a>00944     
<a name="l00945"></a>00945     <span class="comment">/* cache which inputs are actually textured.</span>
<a name="l00946"></a>00946 <span class="comment">     * this can avoid a bit of time spent iterating through all the texture slots, map inputs and map tos</span>
<a name="l00947"></a>00947 <span class="comment">     * every time a property which may or may not be textured is accessed */</span>
<a name="l00948"></a>00948     
<a name="l00949"></a>00949     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; a++) {
<a name="l00950"></a>00950         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a] &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l00951"></a>00951             <span class="comment">/* currently used only in volume render, so we&#39;ll check for those flags */</span>
<a name="l00952"></a>00952             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>;
<a name="l00953"></a>00953             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>;
<a name="l00954"></a>00954             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>;
<a name="l00955"></a>00955             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>;
<a name="l00956"></a>00956             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>;
<a name="l00957"></a>00957             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a30f1fd2b082cfd91b07340e3afbee2d7">MAP_REFLECTION</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a30f1fd2b082cfd91b07340e3afbee2d7">MAP_REFLECTION</a>;
<a name="l00958"></a>00958             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>;
<a name="l00959"></a>00959         }
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 }
<a name="l00962"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a979f80a624d364017429ac77c1430544">00962</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a979f80a624d364017429ac77c1430544">flag_render_node_material</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *ntree)
<a name="l00963"></a>00963 {
<a name="l00964"></a>00964     <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <span class="keywordflow">for</span> (node=ntree-&gt;<a class="code" href="../../d9/da9/structbNodeTree.html#ac928f4eb3314d2b9ce2d9c6a49c1f233">nodes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; node; node= node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a978093ed3cb2529e1f932bc8c5081968">next</a>) {
<a name="l00967"></a>00967         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>) {
<a name="l00968"></a>00968             <span class="keywordflow">if</span> (<a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)==<a class="code" href="../../d3/dfb/DNA__ID_8h.html#acf5020c901e2793a056ffca95ec8195a">ID_MA</a>) {
<a name="l00969"></a>00969                 <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= (<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *)node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>))
<a name="l00972"></a>00972                     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a9ad1ed9bc41f431a697de317b4983242">R_ZTRA</a>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974                 ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a145316c1cc6a6568128aa09228545c59">flag</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a02138613928a045dcae96d1cde832c24">MA_IS_USED</a>;
<a name="l00975"></a>00975             }
<a name="l00976"></a>00976             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a95416f774e5a5a27105522a1b74e5989">type</a>==<a class="code" href="../../d4/d91/BKE__node_8h.html#ab9f16ff5fded11f644b983a041c97edd">NODE_GROUP</a>)
<a name="l00977"></a>00977                 <a class="code" href="../../d2/d47/convertblender_8c.html#a979f80a624d364017429ac77c1430544">flag_render_node_material</a>(re, (<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *)node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>);
<a name="l00978"></a>00978         }
<a name="l00979"></a>00979     }
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">00982</a> <span class="keyword">static</span> <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">short</span> nr)
<a name="l00983"></a>00983 {
<a name="l00984"></a>00984     <span class="keyword">extern</span> <a class="code" href="../../d2/d10/structMaterial.html">Material</a> <a class="code" href="../../de/d87/material_8c.html#a685518354e9af381cf9881b703cad017">defmaterial</a>;    <span class="comment">/* material.c */</span>
<a name="l00985"></a>00985     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l00986"></a>00986     
<a name="l00987"></a>00987     ma= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(ob, nr);
<a name="l00988"></a>00988     <span class="keywordflow">if</span> (ma==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00989"></a>00989         ma= &amp;<a class="code" href="../../de/d87/material_8c.html#a685518354e9af381cf9881b703cad017">defmaterial</a>;
<a name="l00990"></a>00990     
<a name="l00991"></a>00991     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3ec1fac33b9d44c9c2a26c72e5425019">R_SPEED</a>) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#adcdab551c953414f6adbce65d9ebdc58">NEED_UV</a>;
<a name="l00992"></a>00992     
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>) {
<a name="l00994"></a>00994         ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>;
<a name="l00995"></a>00995         ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp;= ~<a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>;
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997     <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>))
<a name="l00998"></a>00998         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a9ad1ed9bc41f431a697de317b4983242">R_ZTRA</a>;
<a name="l00999"></a>00999     
<a name="l01000"></a>01000     <span class="comment">/* for light groups and SSS */</span>
<a name="l01001"></a>01001     ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a145316c1cc6a6568128aa09228545c59">flag</a> |= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a02138613928a045dcae96d1cde832c24">MA_IS_USED</a>;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a> &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae5c87659b1f4bd186431d96361ade966">use_nodes</a>)
<a name="l01004"></a>01004         <a class="code" href="../../d2/d47/convertblender_8c.html#a979f80a624d364017429ac77c1430544">flag_render_node_material</a>(re, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a535477b1fb0d8090cc56a0541c5ff467">nodetree</a>);
<a name="l01005"></a>01005     
<a name="l01006"></a>01006     <a class="code" href="../../d2/d47/convertblender_8c.html#a550e3b4787300a52580eda42146e37a9">check_material_mapto</a>(ma);
<a name="l01007"></a>01007     
<a name="l01008"></a>01008     <span class="keywordflow">return</span> ma;
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01012"></a>01012 <span class="comment">/* Particles                                                                 */</span>
<a name="l01013"></a>01013 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01014"></a><a class="code" href="../../d7/dee/structParticleStrandData.html">01014</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a>
<a name="l01015"></a>01015 {
<a name="l01016"></a><a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">01016</a>     <span class="keyword">struct </span><a class="code" href="../../db/d33/structMCol.html">MCol</a> *<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>;
<a name="l01017"></a><a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">01017</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>, *<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>, *<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>;
<a name="l01018"></a><a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">01018</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#adb4ffafff3b2a3a1b332aa020fa420c5">adapt_angle</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#af23992d44b4ee381c47071f695eaba54">adapt_pix</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#ae256653a85951805d99a285d82833e24">size</a>;
<a name="l01019"></a><a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">01019</a>     <span class="keywordtype">int</span> <a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>;
<a name="l01020"></a><a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">01020</a>     <span class="keywordtype">int</span> <a class="code" href="../../d7/dee/structParticleStrandData.html#a8cbc19f1efca0a0901c3d7f4969c5f03">first</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#a037b2039083dbc378a8a6113d8d05f64">line</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a>, <a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>;
<a name="l01021"></a>01021 }
<a name="l01022"></a>01022 <a class="code" href="../../d2/d47/convertblender_8c.html#ae349b3dcb9f6ddc7322040e90570a900">ParticleStrandData</a>;
<a name="l01023"></a>01023 <span class="comment">/* future thread problem... */</span>
<a name="l01024"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a49d554424ca9f614721cc2dd498b6f87">01024</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a49d554424ca9f614721cc2dd498b6f87">static_particle_strand</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a> *sd, <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keyword">const</span> <span class="keywordtype">float</span> vec1[3])
<a name="l01025"></a>01025 {
<a name="l01026"></a>01026     <span class="keyword">static</span> <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *v2= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01027"></a>01027     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01028"></a>01028     <span class="keywordtype">float</span> nor[3], <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[3], crosslen, w, dx, dy, width;
<a name="l01029"></a>01029     <span class="keyword">static</span> <span class="keywordtype">float</span> anor[3], avec[3];
<a name="l01030"></a>01030     <span class="keywordtype">int</span> flag, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01031"></a>01031     <span class="keyword">static</span> <span class="keywordtype">int</span> second=0;
<a name="l01032"></a>01032     
<a name="l01033"></a>01033     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, vec, vec1);
<a name="l01034"></a>01034     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);      <span class="comment">// nor needed as tangent </span>
<a name="l01035"></a>01035     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, vec, nor);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="comment">/* turn cross in pixelsize */</span>
<a name="l01038"></a>01038     w= vec[2]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[2][3] + re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[3][3];
<a name="l01039"></a>01039     dx= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>*cross[0]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[0][0];
<a name="l01040"></a>01040     dy= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>*cross[1]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[1][1];
<a name="l01041"></a>01041     w= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dx*dx + dy*dy)/w;
<a name="l01042"></a>01042     
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (w!=0.0f) {
<a name="l01044"></a>01044         <span class="keywordtype">float</span> fac;
<a name="l01045"></a>01045         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>!=0.0f) {
<a name="l01046"></a>01046             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>&lt;0.0f)
<a name="l01047"></a>01047                 fac= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a>, 1.0f+ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>);
<a name="l01048"></a>01048             <span class="keywordflow">else</span>
<a name="l01049"></a>01049                 fac= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a>, 1.0f/(1.0f-ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>));
<a name="l01050"></a>01050         }
<a name="l01051"></a>01051         <span class="keywordflow">else</span> fac= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a>;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         width= ((1.0f-fac)*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa72afccc378741af6e29de2e20084420">strand_sta</a> + (fac)*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac6a6784cdee68d2bafdea858c57dffcd">strand_end</a>);
<a name="l01054"></a>01054 
<a name="l01055"></a>01055         <span class="comment">/* use actual Blender units for strand width and fall back to minimum width */</span>
<a name="l01056"></a>01056         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#adde252671ae4d143681435d1b318d0cd">MA_STR_B_UNITS</a>) {
<a name="l01057"></a>01057             crosslen= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(cross);
<a name="l01058"></a>01058             w= 2.0f*crosslen*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac81de8a6b5d49fa2a9fefec3914f04a0">strand_min</a>/w;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060             <span class="keywordflow">if</span> (width &lt; w)
<a name="l01061"></a>01061                 width= w;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063             <span class="comment">/*cross is the radius of the strand so we want it to be half of full width */</span>
<a name="l01064"></a>01064             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cross,0.5f/crosslen);
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066         <span class="keywordflow">else</span>
<a name="l01067"></a>01067             width/=w;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cross, width);
<a name="l01070"></a>01070     }
<a name="l01071"></a>01071     
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a993de724ede213103155201135760761">MA_TANGENT_STR</a>)
<a name="l01073"></a>01073         flag= <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>|<a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>;
<a name="l01074"></a>01074     <span class="keywordflow">else</span>
<a name="l01075"></a>01075         flag= <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>;
<a name="l01076"></a>01076     
<a name="l01077"></a>01077     <span class="comment">/* only 1 pixel wide strands filled in as quads now, otherwise zbuf errors */</span>
<a name="l01078"></a>01078     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa72afccc378741af6e29de2e20084420">strand_sta</a>==1.0f)
<a name="l01079"></a>01079         flag |= <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>;
<a name="l01080"></a>01080     
<a name="l01081"></a>01081     <span class="comment">/* single face line */</span>
<a name="l01082"></a>01082     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a037b2039083dbc378a8a6113d8d05f64">line</a>) {
<a name="l01083"></a>01083         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01084"></a>01084         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= flag;
<a name="l01085"></a>01085         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01086"></a>01086         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01087"></a>01087         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01088"></a>01088         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01089"></a>01089         
<a name="l01090"></a>01090         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01091"></a>01091         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01092"></a>01092         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01093"></a>01093         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01094"></a>01094         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= -1.0f;  <span class="comment">// accum abuse for strand texco</span>
<a name="l01095"></a>01095         
<a name="l01096"></a>01096         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01097"></a>01097         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01098"></a>01098         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01099"></a>01099         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01100"></a>01100         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec1);
<a name="l01103"></a>01103         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01104"></a>01104         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01105"></a>01105         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01106"></a>01106         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= 1.0f;   <span class="comment">// accum abuse for strand texco</span>
<a name="l01107"></a>01107         
<a name="l01108"></a>01108         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec1);
<a name="l01109"></a>01109         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01110"></a>01110         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01111"></a>01111         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01112"></a>01112         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01115"></a>01115         
<a name="l01116"></a>01116         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l01117"></a>01117         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>;
<a name="l01118"></a>01118 
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>) {
<a name="l01120"></a>01120             <span class="keywordtype">float</span> *snor= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a56a93c3d83b29c975604694e60bb0994">RE_vlakren_get_surfnor</a>(obr, vlr, 1);
<a name="l01121"></a>01121             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(snor, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>);
<a name="l01122"></a>01122         }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>) {
<a name="l01125"></a>01125             <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>; i++) {
<a name="l01126"></a>01126                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtf;
<a name="l01127"></a>01127                 mtf=<a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr,vlr,i,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,1);
<a name="l01128"></a>01128                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0]=
<a name="l01129"></a>01129                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0]=(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>+2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)[0];
<a name="l01130"></a>01130                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1]=
<a name="l01131"></a>01131                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1]=(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>+2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)[1];
<a name="l01132"></a>01132             }
<a name="l01133"></a>01133             <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>&gt;=0) {
<a name="l01134"></a>01134                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtf;
<a name="l01135"></a>01135                 mtf=<a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr,vlr,sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,0);
<a name="l01136"></a>01136                 
<a name="l01137"></a>01137                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0]=0.0f;
<a name="l01138"></a>01138                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0]=1.0f;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1]=0.0f;
<a name="l01141"></a>01141                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1]=1.0f;
<a name="l01142"></a>01142             }
<a name="l01143"></a>01143         }
<a name="l01144"></a>01144         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>) {
<a name="l01145"></a>01145             <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>; i++) {
<a name="l01146"></a>01146                 <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mc;
<a name="l01147"></a>01147                 mc=<a class="code" href="../../d0/db6/renderdatabase_8h.html#a9b31c14085f27f3fe35e7dd5f2546728">RE_vlakren_get_mcol</a>(obr,vlr,i,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,1);
<a name="l01148"></a>01148                 mc[0]=mc[1]=mc[2]=mc[3]=sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01149"></a>01149                 mc[0]=mc[1]=mc[2]=mc[3]=sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01150"></a>01150             }
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153     <span class="comment">/* first two vertices of a strand */</span>
<a name="l01154"></a>01154     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a8cbc19f1efca0a0901c3d7f4969c5f03">first</a>) {
<a name="l01155"></a>01155         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a>) {
<a name="l01156"></a>01156             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(anor, nor);
<a name="l01157"></a>01157             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(avec, vec);
<a name="l01158"></a>01158             second=1;
<a name="l01159"></a>01159         }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161         v1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01162"></a>01162         v2= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01163"></a>01163         
<a name="l01164"></a>01164         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01165"></a>01165         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01166"></a>01166         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01167"></a>01167         v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01168"></a>01168         v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= -1.0f;   <span class="comment">// accum abuse for strand texco</span>
<a name="l01169"></a>01169         
<a name="l01170"></a>01170         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2-&gt;co, vec);
<a name="l01171"></a>01171         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v2-&gt;co, v2-&gt;co, cross);
<a name="l01172"></a>01172         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2-&gt;n, nor);
<a name="l01173"></a>01173         v2-&gt;orco= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01174"></a>01174         v2-&gt;accum= v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>;
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176     <span class="comment">/* more vertices &amp; faces to strand */</span>
<a name="l01177"></a>01177     <span class="keywordflow">else</span> {
<a name="l01178"></a>01178         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a>==0 || second) {
<a name="l01179"></a>01179             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01180"></a>01180             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= flag;
<a name="l01181"></a>01181             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v1;
<a name="l01182"></a>01182             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v2;
<a name="l01183"></a>01183             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01184"></a>01184             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01185"></a>01185             
<a name="l01186"></a>01186             v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>; <span class="comment">// cycle</span>
<a name="l01187"></a>01187             v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>; <span class="comment">// cycle</span>
<a name="l01188"></a>01188 
<a name="l01189"></a>01189             
<a name="l01190"></a>01190             <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a>) {
<a name="l01191"></a>01191                 second=0;
<a name="l01192"></a>01192                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(anor,nor);
<a name="l01193"></a>01193                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(avec,vec);
<a name="l01194"></a>01194             }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a>) {
<a name="l01198"></a>01198             <span class="keywordtype">float</span> dvec[3],pvec[3];
<a name="l01199"></a>01199             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec,avec,vec);
<a name="l01200"></a>01200             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(pvec,dvec,vec);
<a name="l01201"></a>01201             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dvec,dvec,pvec);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203             w= vec[2]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[2][3] + re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[3][3];
<a name="l01204"></a>01204             dx= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>*dvec[0]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[0][0]/w;
<a name="l01205"></a>01205             dy= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>*dvec[1]*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[1][1]/w;
<a name="l01206"></a>01206             w= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dx*dx + dy*dy);
<a name="l01207"></a>01207             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(anor,nor)&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#adb4ffafff3b2a3a1b332aa020fa420c5">adapt_angle</a> &amp;&amp; w&gt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#af23992d44b4ee381c47071f695eaba54">adapt_pix</a>) {
<a name="l01208"></a>01208                 vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01209"></a>01209                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= flag;
<a name="l01210"></a>01210                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v1;
<a name="l01211"></a>01211                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v2;
<a name="l01212"></a>01212                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01213"></a>01213                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01214"></a>01214                 
<a name="l01215"></a>01215                 v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>; <span class="comment">// cycle</span>
<a name="l01216"></a>01216                 v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>; <span class="comment">// cycle</span>
<a name="l01217"></a>01217 
<a name="l01218"></a>01218                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(anor,nor);
<a name="l01219"></a>01219                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(avec,vec);
<a name="l01220"></a>01220             }
<a name="l01221"></a>01221             <span class="keywordflow">else</span> {
<a name="l01222"></a>01222                 vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>-1);
<a name="l01223"></a>01223             }
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225     
<a name="l01226"></a>01226         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01227"></a>01227         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01228"></a>01228         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01229"></a>01229         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01230"></a>01230         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= -1.0f + 2.0f*sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a>;  <span class="comment">// accum abuse for strand texco</span>
<a name="l01231"></a>01231         
<a name="l01232"></a>01232         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01233"></a>01233         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, cross);
<a name="l01234"></a>01234         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, nor);
<a name="l01235"></a>01235         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>;
<a name="l01236"></a>01236         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>;
<a name="l01237"></a>01237         
<a name="l01238"></a>01238         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01239"></a>01239         
<a name="l01240"></a>01240         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l01241"></a>01241         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>) {
<a name="l01244"></a>01244             <span class="keywordtype">float</span> *snor= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a56a93c3d83b29c975604694e60bb0994">RE_vlakren_get_surfnor</a>(obr, vlr, 1);
<a name="l01245"></a>01245             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(snor, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>);
<a name="l01246"></a>01246         }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>) {
<a name="l01249"></a>01249             <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>; i++) {
<a name="l01250"></a>01250                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtf;
<a name="l01251"></a>01251                 mtf=<a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr,vlr,i,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,1);
<a name="l01252"></a>01252                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0]=
<a name="l01253"></a>01253                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0]=(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>+2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)[0];
<a name="l01254"></a>01254                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1]=
<a name="l01255"></a>01255                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1]=(sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>+2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)[1];
<a name="l01256"></a>01256             }
<a name="l01257"></a>01257             <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>&gt;=0) {
<a name="l01258"></a>01258                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtf;
<a name="l01259"></a>01259                 mtf=<a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr,vlr,sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,0);
<a name="l01260"></a>01260                 
<a name="l01261"></a>01261                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0]=0.0f;
<a name="l01262"></a>01262                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0]=1.0f;
<a name="l01263"></a>01263 
<a name="l01264"></a>01264                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1]=(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>+1.0f)/2.0f;
<a name="l01265"></a>01265                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1]=mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1]=(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>+1.0f)/2.0f;
<a name="l01266"></a>01266             }
<a name="l01267"></a>01267         }
<a name="l01268"></a>01268         <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>) {
<a name="l01269"></a>01269             <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>; i++) {
<a name="l01270"></a>01270                 <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mc;
<a name="l01271"></a>01271                 mc=<a class="code" href="../../d0/db6/renderdatabase_8h.html#a9b31c14085f27f3fe35e7dd5f2546728">RE_vlakren_get_mcol</a>(obr,vlr,i,<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,1);
<a name="l01272"></a>01272                 mc[0]=mc[1]=mc[2]=mc[3]=sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01273"></a>01273                 mc[0]=mc[1]=mc[2]=mc[3]=sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01274"></a>01274             }
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 }
<a name="l01278"></a>01278 
<a name="l01279"></a><a class="code" href="../../d2/d47/convertblender_8c.html#acb20fbc5364090eae227287ac4fd65fd">01279</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#acb20fbc5364090eae227287ac4fd65fd">static_particle_wire</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keyword">const</span> <span class="keywordtype">float</span> vec1[3], <span class="keywordtype">int</span> first, <span class="keywordtype">int</span> line)
<a name="l01280"></a>01280 {
<a name="l01281"></a>01281     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l01282"></a>01282     <span class="keyword">static</span> <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (line) {
<a name="l01285"></a>01285         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01286"></a>01286         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01287"></a>01287         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01288"></a>01288         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l01289"></a>01289         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01290"></a>01290         
<a name="l01291"></a>01291         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01292"></a>01292         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec1);
<a name="l01293"></a>01293         
<a name="l01294"></a>01294         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vec, vec1);
<a name="l01295"></a>01295         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01296"></a>01296         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01297"></a>01297         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01298"></a>01298         
<a name="l01299"></a>01299         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l01300"></a>01300         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (first) {
<a name="l01304"></a>01304         v1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01305"></a>01305         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01306"></a>01306     }
<a name="l01307"></a>01307     <span class="keywordflow">else</span> {
<a name="l01308"></a>01308         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01309"></a>01309         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v1;
<a name="l01310"></a>01310         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01311"></a>01311         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l01312"></a>01312         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01313"></a>01313         
<a name="l01314"></a>01314         v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>; <span class="comment">// cycle</span>
<a name="l01315"></a>01315         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vec);
<a name="l01316"></a>01316         
<a name="l01317"></a>01317         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vec, vec1);
<a name="l01318"></a>01318         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01319"></a>01319         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01320"></a>01320         
<a name="l01321"></a>01321         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l01322"></a>01322         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>;
<a name="l01323"></a>01323     }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01327"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aa4d9e0cefaf21f379aa2088418dc7894">01327</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aa4d9e0cefaf21f379aa2088418dc7894">particle_curve</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a> *sd, <span class="keywordtype">float</span> *loc, <span class="keywordtype">float</span> *loc1,  <span class="keywordtype">int</span> seed, <span class="keywordtype">float</span> *pa_co)
<a name="l01328"></a>01328 {
<a name="l01329"></a>01329     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har=0;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)
<a name="l01332"></a>01332         <a class="code" href="../../d2/d47/convertblender_8c.html#acb20fbc5364090eae227287ac4fd65fd">static_particle_wire</a>(obr, ma, loc, loc1, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a8cbc19f1efca0a0901c3d7f4969c5f03">first</a>, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a037b2039083dbc378a8a6113d8d05f64">line</a>);
<a name="l01333"></a>01333     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a263f8a32d8cbe3456366b40cb01deab1">MA_TYPE_HALO</a>) {
<a name="l01334"></a>01334         har= <a class="code" href="../../d0/db6/renderdatabase_8h.html#afd7fa16c52d15683cd6666c16c35eeb8">RE_inithalo_particle</a>(re, obr, dm, ma, loc, loc1, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#ae256653a85951805d99a285d82833e24">size</a>, 1.0, seed, pa_co);
<a name="l01335"></a>01335         <span class="keywordflow">if</span> (har) har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4846848b366b4f085ce68cf576e2b411">lay</a>= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>;
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     <span class="keywordflow">else</span>
<a name="l01338"></a>01338         <a class="code" href="../../d2/d47/convertblender_8c.html#a49d554424ca9f614721cc2dd498b6f87">static_particle_strand</a>(re, obr, ma, sd, loc, loc1);
<a name="l01339"></a>01339 }
<a name="l01340"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a4220698597903078d882a7132fa180ab">01340</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a4220698597903078d882a7132fa180ab">particle_billboard</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <a class="code" href="../../d0/d06/structParticleBillboardData.html">ParticleBillboardData</a> *bb)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l01343"></a>01343     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtf;
<a name="l01344"></a>01344     <span class="keywordtype">float</span> xvec[3], yvec[3], zvec[3], bb_center[3];
<a name="l01345"></a>01345     <span class="comment">/* Number of tiles */</span>
<a name="l01346"></a>01346     <span class="keywordtype">int</span> totsplit = bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a> * bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a>;
<a name="l01347"></a>01347     <span class="keywordtype">int</span> tile, x, y;
<a name="l01348"></a>01348     <span class="comment">/* Tile offsets */</span>
<a name="l01349"></a>01349     <span class="keywordtype">float</span> uvx = 0.0f, uvy = 0.0f, uvdx = 1.0f, uvdy = 1.0f, time = 0.0f;
<a name="l01350"></a>01350 
<a name="l01351"></a>01351     vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l01352"></a>01352     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01353"></a>01353     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01354"></a>01354     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01355"></a>01355     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <a class="code" href="../../db/dca/BKE__particle_8h.html#abb28932764fe0f4944cf3e7f2eeb7314">psys_make_billboard</a>(bb, xvec, yvec, zvec, bb_center);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, bb_center, xvec);
<a name="l01360"></a>01360     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, yvec);
<a name="l01361"></a>01361     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, bb_center, xvec);
<a name="l01364"></a>01364     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, yvec);
<a name="l01365"></a>01365     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, bb_center, xvec);
<a name="l01368"></a>01368     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, yvec);
<a name="l01369"></a>01369     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01370"></a>01370 
<a name="l01371"></a>01371     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, bb_center, xvec);
<a name="l01372"></a>01372     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, yvec);
<a name="l01373"></a>01373     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01376"></a>01376     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01377"></a>01377     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01378"></a>01378     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01379"></a>01379     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l01380"></a>01380     
<a name="l01381"></a>01381     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l01382"></a>01382     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384     <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a> &gt; 1) {
<a name="l01385"></a>01385         uvdx = uvdy = 1.0f / (float)bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a>;
<a name="l01386"></a>01386 
<a name="l01387"></a>01387         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a2831ab76c3e994bb050bf23f016b3044">anim</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a709995c8e25d57aa4c2ed049f7162c98">PART_BB_ANIM_AGE</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a490fb015b46167795ee961b303fa8974">PART_BB_ANIM_FRAME</a>)) {
<a name="l01388"></a>01388             <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a2831ab76c3e994bb050bf23f016b3044">anim</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a490fb015b46167795ee961b303fa8974">PART_BB_ANIM_FRAME</a>)
<a name="l01389"></a>01389                 time = ((int)(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac0204e98d02c54487c6fc257e7e00372">time</a> * bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a7bfe898820fbdfc4d26ab21f468cf81e">lifetime</a>) % totsplit)/(<span class="keywordtype">float</span>)totsplit;
<a name="l01390"></a>01390             <span class="keywordflow">else</span>
<a name="l01391"></a>01391                 time = bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac0204e98d02c54487c6fc257e7e00372">time</a>;
<a name="l01392"></a>01392         }
<a name="l01393"></a>01393         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a2831ab76c3e994bb050bf23f016b3044">anim</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a73b28144e23de09f9108ec24827bb72a">PART_BB_ANIM_ANGLE</a>) {
<a name="l01394"></a>01394             <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af0b0d7f8ba5d133a3e8a040cc7d997c8">align</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#abbd07007d3d76b0967db7f8a2f485e6c">PART_BB_VIEW</a>) {
<a name="l01395"></a>01395                 time = (float)fmod((bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a855befd8b0e77597769b9634bdb64e73">tilt</a> + 1.0f) / 2.0f, 1.0);
<a name="l01396"></a>01396             }
<a name="l01397"></a>01397             <span class="keywordflow">else</span> {
<a name="l01398"></a>01398                 <span class="keywordtype">float</span> axis1[3] = {0.0f,0.0f,0.0f};
<a name="l01399"></a>01399                 <span class="keywordtype">float</span> axis2[3] = {0.0f,0.0f,0.0f};
<a name="l01400"></a>01400 
<a name="l01401"></a>01401                 axis1[(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af0b0d7f8ba5d133a3e8a040cc7d997c8">align</a> + 1) % 3] = 1.0f;
<a name="l01402"></a>01402                 axis2[(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af0b0d7f8ba5d133a3e8a040cc7d997c8">align</a> + 2) % 3] = 1.0f;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404                 <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a28b539cdfb04a1d71e5f86078bd75592">lock</a> == 0) {
<a name="l01405"></a>01405                     zvec[bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af0b0d7f8ba5d133a3e8a040cc7d997c8">align</a>] = 0.0f;
<a name="l01406"></a>01406                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(zvec);
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408                 
<a name="l01409"></a>01409                 time = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(zvec, axis1)) / (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l01410"></a>01410                 
<a name="l01411"></a>01411                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(zvec, axis2) &lt; 0.0f)
<a name="l01412"></a>01412                     time = 1.0f - time / 2.0f;
<a name="l01413"></a>01413                 <span class="keywordflow">else</span>
<a name="l01414"></a>01414                     time /= 2.0f;
<a name="l01415"></a>01415             }
<a name="l01416"></a>01416         }
<a name="l01417"></a>01417 
<a name="l01418"></a>01418         <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aa8bc3c69415a2d08cf9c280aaa5c447e">split_offset</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a16fc641ee3bff39d670e0098b86c8660">PART_BB_OFF_LINEAR</a>)
<a name="l01419"></a>01419             time = (float)fmod(time + (<span class="keywordtype">float</span>)bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aae60158000c6fa5de26f707103cd703f">num</a> / (float)totsplit, 1.0f);
<a name="l01420"></a>01420         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aa8bc3c69415a2d08cf9c280aaa5c447e">split_offset</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7b5a0cd77a1887d79b3bc557c47f08f3">PART_BB_OFF_RANDOM</a>)
<a name="l01421"></a>01421             time = (float)fmod(time + bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a78acfbb2fbcedd50f0844afba008d418">random</a>, 1.0f);
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="comment">/* Find the coordinates in tile space (integer), then convert to UV</span>
<a name="l01424"></a>01424 <span class="comment">         * space (float). Note that Y is flipped. */</span>
<a name="l01425"></a>01425         tile = (int)((time + <a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a>) * totsplit);
<a name="l01426"></a>01426         x = tile % bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a>;
<a name="l01427"></a>01427         y = tile / bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a>;
<a name="l01428"></a>01428         y = (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a> - 1) - y;
<a name="l01429"></a>01429         uvx = uvdx * x;
<a name="l01430"></a>01430         uvy = uvdy * y;
<a name="l01431"></a>01431     }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="comment">/* normal UVs */</span>
<a name="l01434"></a>01434     <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0] &gt;= 0) {
<a name="l01435"></a>01435         mtf = <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01436"></a>01436         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0] = 1.0f;
<a name="l01437"></a>01437         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1] = 1.0f;
<a name="l01438"></a>01438         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0] = 0.0f;
<a name="l01439"></a>01439         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1] = 1.0f;
<a name="l01440"></a>01440         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0] = 0.0f;
<a name="l01441"></a>01441         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1] = 0.0f;
<a name="l01442"></a>01442         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0] = 1.0f;
<a name="l01443"></a>01443         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1] = 0.0f;
<a name="l01444"></a>01444     }
<a name="l01445"></a>01445 
<a name="l01446"></a>01446     <span class="comment">/* time-index UVs */</span>
<a name="l01447"></a>01447     <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[1] &gt;= 0) {
<a name="l01448"></a>01448         mtf = <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[1], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01449"></a>01449         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0] = bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac0204e98d02c54487c6fc257e7e00372">time</a>;
<a name="l01450"></a>01450         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1] = mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1] = (float)bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aae60158000c6fa5de26f707103cd703f">num</a>/(<span class="keywordtype">float</span>)bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#a60df9342e823b8abd32cd6d0c08aaa02">totnum</a>;
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="comment">/* split UVs */</span>
<a name="l01454"></a>01454     <span class="keywordflow">if</span> (bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a> &gt; 1 &amp;&amp; bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[2] &gt;= 0) {
<a name="l01455"></a>01455         mtf = <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01456"></a>01456         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0] = uvx + uvdx;
<a name="l01457"></a>01457         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1] = uvy + uvdy;
<a name="l01458"></a>01458         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0] = uvx;
<a name="l01459"></a>01459         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1] = uvy + uvdy;
<a name="l01460"></a>01460         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0] = uvx;
<a name="l01461"></a>01461         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1] = uvy;
<a name="l01462"></a>01462         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0] = uvx + uvdx;
<a name="l01463"></a>01463         mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1] = uvy;
<a name="l01464"></a>01464     }
<a name="l01465"></a>01465 }
<a name="l01466"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af4d8b992f1f91ec91579be6f8c511456">01466</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af4d8b992f1f91ec91579be6f8c511456">particle_normal_ren</a>(<span class="keywordtype">short</span> ren_as, <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part, <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a> *sd, <a class="code" href="../../d0/d06/structParticleBillboardData.html">ParticleBillboardData</a> *bb, <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>, <span class="keywordtype">int</span> seed, <span class="keywordtype">float</span> hasize, <span class="keywordtype">float</span> *pa_co)
<a name="l01467"></a>01467 {
<a name="l01468"></a>01468     <span class="keywordtype">float</span> loc[3], loc0[3], loc1[3], vel[3];
<a name="l01469"></a>01469     
<a name="l01470"></a>01470     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l01471"></a>01471 
<a name="l01472"></a>01472     <span class="keywordflow">if</span> (ren_as != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>)
<a name="l01473"></a>01473         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, loc);
<a name="l01474"></a>01474 
<a name="l01475"></a>01475     <span class="keywordflow">switch</span>(ren_as) {
<a name="l01476"></a>01476         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0095bb5a5fb10ba1e61d296723c451ff">PART_DRAW_LINE</a>:
<a name="l01477"></a>01477             sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a037b2039083dbc378a8a6113d8d05f64">line</a> = 1;
<a name="l01478"></a>01478             sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a> = 0.0f;
<a name="l01479"></a>01479             sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#ae256653a85951805d99a285d82833e24">size</a> = hasize;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vel, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01482"></a>01482             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, vel);
<a name="l01483"></a>01483             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vel);
<a name="l01484"></a>01484 
<a name="l01485"></a>01485             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ace6b318ca43451b7c9faca362907f3c9">PART_DRAW_VEL_LENGTH</a>)
<a name="l01486"></a>01486                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vel, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>));
<a name="l01487"></a>01487 
<a name="l01488"></a>01488             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(loc0, loc, vel, -part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7461f5318b0513e5c424046ceebff77b">draw_line</a>[0]);
<a name="l01489"></a>01489             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(loc1, loc, vel, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7461f5318b0513e5c424046ceebff77b">draw_line</a>[1]);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491             <a class="code" href="../../d2/d47/convertblender_8c.html#aa4d9e0cefaf21f379aa2088418dc7894">particle_curve</a>(re, obr, dm, ma, sd, loc0, loc1, seed, pa_co);
<a name="l01492"></a>01492 
<a name="l01493"></a>01493             <span class="keywordflow">break</span>;
<a name="l01494"></a>01494 
<a name="l01495"></a>01495         <span class="keywordflow">case</span> <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>:
<a name="l01496"></a>01496 
<a name="l01497"></a>01497             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac5613f70bcdcefc5455ea2c4aff65f3c">vec</a>, loc);
<a name="l01498"></a>01498             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb-&gt;<a class="code" href="../../d0/d06/structParticleBillboardData.html#ad341449bef17e96969999a1eb2ea043a">vel</a>, state-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500             <a class="code" href="../../d2/d47/convertblender_8c.html#a4220698597903078d882a7132fa180ab">particle_billboard</a>(re, obr, ma, bb);
<a name="l01501"></a>01501 
<a name="l01502"></a>01502             <span class="keywordflow">break</span>;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504         <span class="keywordflow">default</span>:
<a name="l01505"></a>01505         {
<a name="l01506"></a>01506             <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har=0;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508             har = <a class="code" href="../../d0/db6/renderdatabase_8h.html#afd7fa16c52d15683cd6666c16c35eeb8">RE_inithalo_particle</a>(re, obr, dm, ma, loc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>, hasize, 0.0, seed, pa_co);
<a name="l01509"></a>01509             
<a name="l01510"></a>01510             <span class="keywordflow">if</span> (har) har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4846848b366b4f085ce68cf576e2b411">lay</a>= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>;
<a name="l01511"></a>01511 
<a name="l01512"></a>01512             <span class="keywordflow">break</span>;
<a name="l01513"></a>01513         }
<a name="l01514"></a>01514     }
<a name="l01515"></a>01515 }
<a name="l01516"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aeee0644dd617d2444637f96aa8c694a3">01516</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aeee0644dd617d2444637f96aa8c694a3">get_particle_uvco_mcol</a>(<span class="keywordtype">short</span> from, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">float</span> *fuv, <span class="keywordtype">int</span> num, <a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a> *sd)
<a name="l01517"></a>01517 {
<a name="l01518"></a>01518     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     <span class="comment">/* get uvco */</span>
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(from,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>)) {
<a name="l01522"></a>01522         <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>; i++) {
<a name="l01523"></a>01523             <span class="keywordflow">if</span> (num != <a class="code" href="../../db/dca/BKE__particle_8h.html#a2f2c3e768f77e84b7ef667b814b7ac43">DMCACHE_NOTFOUND</a>) {
<a name="l01524"></a>01524                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm, num, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l01525"></a>01525                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface = (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa4f16a171b314c81058a73acdd45388b">CustomData_get_layer_n</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, i);
<a name="l01526"></a>01526                 mtface += num;
<a name="l01527"></a>01527                 
<a name="l01528"></a>01528                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a6140551631baf90b2c606d7997a756c1">psys_interpolate_uvs</a>(mtface, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, fuv, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a> + 2 * i);
<a name="l01529"></a>01529             }
<a name="l01530"></a>01530             <span class="keywordflow">else</span> {
<a name="l01531"></a>01531                 sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>[2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l01532"></a>01532                 sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>[2*i + 1] = 0.0f;
<a name="l01533"></a>01533             }
<a name="l01534"></a>01534         }
<a name="l01535"></a>01535     }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="comment">/* get mcol */</span>
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(from,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>,<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0885d4a10e03f8db92a6e510b300943f">PART_FROM_VOLUME</a>)) {
<a name="l01539"></a>01539         <span class="keywordflow">for</span> (i=0; i&lt;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>; i++) {
<a name="l01540"></a>01540             <span class="keywordflow">if</span> (num != <a class="code" href="../../db/dca/BKE__particle_8h.html#a2f2c3e768f77e84b7ef667b814b7ac43">DMCACHE_NOTFOUND</a>) {
<a name="l01541"></a>01541                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a>(dm, num, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l01542"></a>01542                 <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mc = (<a class="code" href="../../db/d33/structMCol.html">MCol</a>*)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa4f16a171b314c81058a73acdd45388b">CustomData_get_layer_n</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>, i);
<a name="l01543"></a>01543                 mc += num * 4;
<a name="l01544"></a>01544 
<a name="l01545"></a>01545                 <a class="code" href="../../db/dca/BKE__particle_8h.html#ae252d659b6931be78d8a12e6194414c3">psys_interpolate_mcol</a>(mc, mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, fuv, sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a> + i);
<a name="l01546"></a>01546             }
<a name="l01547"></a>01547             <span class="keywordflow">else</span>
<a name="l01548"></a>01548                 memset(&amp;sd-&gt;<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[i], 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d33/structMCol.html">MCol</a>));
<a name="l01549"></a>01549         }
<a name="l01550"></a>01550     }
<a name="l01551"></a>01551 }
<a name="l01552"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a695399c6e10af233bb3699755d086647">01552</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a695399c6e10af233bb3699755d086647">render_new_particle_system</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys, <span class="keywordtype">int</span> timeoffset)
<a name="l01553"></a>01553 {
<a name="l01554"></a>01554     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l01555"></a>01555 <span class="comment">//  Object *tob=0;</span>
<a name="l01556"></a>01556     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma=0;
<a name="l01557"></a>01557     <a class="code" href="../../d7/da3/structParticleSystemModifierData.html">ParticleSystemModifierData</a> *psmd;
<a name="l01558"></a>01558     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *tpsys=0;
<a name="l01559"></a>01559     <a class="code" href="../../df/da6/structParticleSettings.html">ParticleSettings</a> *part, *tpart=0;
<a name="l01560"></a>01560     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pars, *pa=0,*tpa=0;
<a name="l01561"></a>01561     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *states=0;
<a name="l01562"></a>01562     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> <a class="code" href="../../d3/d41/mathutils__noise_8c.html#a1ac338c8291400e2f2785ef2cb7a5458">state</a>;
<a name="l01563"></a>01563     <a class="code" href="../../d1/d8d/structParticleCacheKey.html">ParticleCacheKey</a> *cache=0;
<a name="l01564"></a>01564     <a class="code" href="../../d0/d06/structParticleBillboardData.html">ParticleBillboardData</a> bb;
<a name="l01565"></a>01565     <a class="code" href="../../de/df5/structParticleSimulationData.html">ParticleSimulationData</a> sim = {0};
<a name="l01566"></a>01566     <a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a> sd;
<a name="l01567"></a>01567     <a class="code" href="../../de/d59/structStrandBuffer.html">StrandBuffer</a> *strandbuf=0;
<a name="l01568"></a>01568     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert=0;
<a name="l01569"></a>01569     <a class="code" href="../../db/d4b/structStrandBound.html">StrandBound</a> *sbound= 0;
<a name="l01570"></a>01570     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand=0;
<a name="l01571"></a>01571     <a class="code" href="../../d0/d3e/structRNG.html">RNG</a> *rng= 0;
<a name="l01572"></a>01572     <span class="keywordtype">float</span> loc[3],loc1[3],loc0[3],mat[4][4],nmat[3][3],<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3],nor[3],duplimat[4][4];
<a name="l01573"></a>01573     <span class="keywordtype">float</span> strandlen=0.0f, curlen=0.0f;
<a name="l01574"></a>01574     <span class="keywordtype">float</span> hasize, pa_size, r_tilt, r_length;
<a name="l01575"></a>01575     <span class="keywordtype">float</span> pa_time, pa_birthtime, pa_dietime;
<a name="l01576"></a>01576     <span class="keywordtype">float</span> <a class="code" href="../../d4/d44/frames_8inl.html#a9f76654728449cbb330e854b25f77ec3" title="addDelta operator for displacement rotational velocity.">random</a>, simplify[2], pa_co[3];
<a name="l01577"></a>01577     <span class="keyword">const</span> <span class="keywordtype">float</span> cfra= <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>);
<a name="l01578"></a>01578     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, k, max_k=0, totpart, dosimplify = 0, dosurfacecache = 0, use_duplimat = 0;
<a name="l01579"></a>01579     <span class="keywordtype">int</span> totchild=0;
<a name="l01580"></a>01580     <span class="keywordtype">int</span> seed, path_nbr=0, orco1=0, num;
<a name="l01581"></a>01581     <span class="keywordtype">int</span> totface, *origindex = 0;
<a name="l01582"></a>01582     <span class="keywordtype">char</span> **uv_name=0;
<a name="l01583"></a>01583 
<a name="l01584"></a>01584 <span class="comment">/* 1. check that everything is ok &amp; updated */</span>
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (psys==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01586"></a>01586         <span class="keywordflow">return</span> 0;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     part=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>;
<a name="l01589"></a>01589     pars=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     <span class="keywordflow">if</span> (part==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || pars==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || !<a class="code" href="../../db/dca/BKE__particle_8h.html#ae1ec21bf7aea2fdbe47e71514b97d919">psys_check_enabled</a>(ob, psys))
<a name="l01592"></a>01592         <span class="keywordflow">return</span> 0;
<a name="l01593"></a>01593     
<a name="l01594"></a>01594     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2506fdc9f159583f812c900402c5ec54">PART_DRAW_OB</a> || part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ababc8a40b78ea25bfdb9cd7b85c83f19">PART_DRAW_GR</a> || part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a55688d6811f05b2d3fc30fcfe9805218">PART_DRAW_NOT</a>)
<a name="l01595"></a>01595         <span class="keywordflow">return</span> 1;
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 <span class="comment">/* 2. start initializing things */</span>
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     <span class="comment">/* last possibility to bail out! */</span>
<a name="l01600"></a>01600     psmd = <a class="code" href="../../db/dca/BKE__particle_8h.html#abb46b353cec8d54be258c683d352fc1d">psys_get_modifier</a>(ob,psys);
<a name="l01601"></a>01601     <span class="keywordflow">if</span> (!(psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a622edf3edbf2840992c249aa7122283a">modifier</a>.<a class="code" href="../../db/ddd/structModifierData.html#a905ab5cd625053441b2e82efe47e95d1">mode</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a35b98a06484384dcc7e907ca646e5918">eModifierMode_Render</a>))
<a name="l01602"></a>01602         <span class="keywordflow">return</span> 0;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a67a1b17ea6660e168f92a49bd9a7ba9b">scene</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>;
<a name="l01605"></a>01605     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#af6baa9791f72b02831c66ea185b28b62">ob</a>= ob;
<a name="l01606"></a>01606     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a98365d240570a76067ad5d707ba70ce8">psys</a>= psys;
<a name="l01607"></a>01607     sim.<a class="code" href="../../de/df5/structParticleSimulationData.html#a470ad1081b08b55049d9036438efba8d">psmd</a>= psmd;
<a name="l01608"></a>01608 
<a name="l01609"></a>01609     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>)
<a name="l01610"></a>01610         <a class="code" href="../../db/dca/BKE__particle_8h.html#a367eaf7149486c4f3ef97ffc0d61b48e">psys_count_keyed_targets</a>(&amp;sim);
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     totchild=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#adb71b544d204f084dc3534a9a09052e5">totchild</a>;
<a name="l01613"></a>01613 
<a name="l01614"></a>01614     <span class="comment">/* can happen for disconnected/global hair */</span>
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; !psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aa4bf1fe43162b6ea089fdd908773ec94">childcache</a>)
<a name="l01616"></a>01616         totchild= 0;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering == 0) { <span class="comment">/* preview render */</span>
<a name="l01619"></a>01619         totchild = (int)((<span class="keywordtype">float</span>)totchild * (float)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae487721b04b5b6187f39a9e768d4630b">disp</a> / 100.0f);
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a62f17f5c32eeb28429a0b04904213b75">PSYS_DRAWING</a>;
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     rng= <a class="code" href="../../d3/d88/BLI__rand_8h.html#adf17633489552c8dd24245b3a9e02ea4">rng_new</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af37463864387a7082f54deefb1d2bdff">seed</a>);
<a name="l01625"></a>01625 
<a name="l01626"></a>01626     totpart=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628     memset(&amp;sd, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/dee/structParticleStrandData.html">ParticleStrandData</a>));
<a name="l01629"></a>01629     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a> = -1;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631 <span class="comment">/* 2.1 setup material stff */</span>
<a name="l01632"></a>01632     ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8d022766b802cfbac21330d486f89469">omat</a>);
<a name="l01633"></a>01633     
<a name="l01634"></a>01634 <span class="preprocessor">#if 0 // XXX old animation system</span>
<a name="l01635"></a>01635 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ma-&gt;ipo) {
<a name="l01636"></a>01636         calc_ipo(ma-&gt;ipo, cfra);
<a name="l01637"></a>01637         execute_ipo((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ma, ma-&gt;ipo);
<a name="l01638"></a>01638     }
<a name="l01639"></a>01639 <span class="preprocessor">#endif // XXX old animation system</span>
<a name="l01640"></a>01640 <span class="preprocessor"></span>
<a name="l01641"></a>01641     hasize = ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a556412ddf197bfe4cfbad58d370b6043">hasize</a>;
<a name="l01642"></a>01642     seed = ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1a9403d97555c8ad196577d4efdeb967">seed1</a>;
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ad758d53fba824ee16d02d838040740d5">R_HALO</a>;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646     <a class="code" href="../../d0/db6/renderdatabase_8h.html#a190f06eb5d3142831c818fc7955dcdd7">RE_set_customdata_names</a>(obr, &amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>);
<a name="l01647"></a>01647     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01648"></a>01648     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>);
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a> &amp;&amp; sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>) {
<a name="l01651"></a>01651         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a> * 2 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;particle_uvs&quot;</span>);
<a name="l01652"></a>01652 
<a name="l01653"></a>01653         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a69cb40ae6d5b800f1c3c2eabc875c1dc">strand_uvname</a>[0]) {
<a name="l01654"></a>01654             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a69cb40ae6d5b800f1c3c2eabc875c1dc">strand_uvname</a>);
<a name="l01655"></a>01655             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a> -= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01656"></a>01656         }
<a name="l01657"></a>01657     }
<a name="l01658"></a>01658     <span class="keywordflow">else</span>
<a name="l01659"></a>01659         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>)
<a name="l01662"></a>01662         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d33/structMCol.html">MCol</a>), <span class="stringliteral">&quot;particle_mcols&quot;</span>);
<a name="l01663"></a>01663 
<a name="l01664"></a>01664 <span class="comment">/* 2.2 setup billboards */</span>
<a name="l01665"></a>01665     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>) {
<a name="l01666"></a>01666         <span class="keywordtype">int</span> first_uv = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0] = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a5f77eeabad7bd94c15a98b00e3d12e4c">bb_uvname</a>[0]);
<a name="l01669"></a>01669         <span class="keywordflow">if</span> (bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0] &lt; 0)
<a name="l01670"></a>01670             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0] = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01671"></a>01671 
<a name="l01672"></a>01672         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[1] = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a5f77eeabad7bd94c15a98b00e3d12e4c">bb_uvname</a>[1]);
<a name="l01673"></a>01673 
<a name="l01674"></a>01674         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[2] = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(&amp;psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a5f77eeabad7bd94c15a98b00e3d12e4c">bb_uvname</a>[2]);
<a name="l01675"></a>01675 
<a name="l01676"></a>01676         <span class="keywordflow">if</span> (first_uv &gt;= 0) {
<a name="l01677"></a>01677             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[0] -= first_uv;
<a name="l01678"></a>01678             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[1] -= first_uv;
<a name="l01679"></a>01679             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af3b3a8322b29f07d757513e56dc4c08c">uv</a>[2] -= first_uv;
<a name="l01680"></a>01680         }
<a name="l01681"></a>01681 
<a name="l01682"></a>01682         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#af0b0d7f8ba5d133a3e8a040cc7d997c8">align</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa5e839fe2565853c676f08b7c1bbddcd">bb_align</a>;
<a name="l01683"></a>01683         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a2831ab76c3e994bb050bf23f016b3044">anim</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afdda34843924a25a00f0483cf7a72fa5">bb_anim</a>;
<a name="l01684"></a>01684         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a28b539cdfb04a1d71e5f86078bd75592">lock</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5a951252b1159b0d8250669edf0eb68d">PART_DRAW_BB_LOCK</a>;
<a name="l01685"></a>01685         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#ad6cc4f0f36f765ad6e2fa197c7421f82">ob</a> = (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4558fec04ca4894122276ad8980afc57">bb_ob</a> ? part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4558fec04ca4894122276ad8980afc57">bb_ob</a> : <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a079fedad6d703b0a3022a3541c77a1ac">RE_GetCamera</a>(re));
<a name="l01686"></a>01686         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#aa8bc3c69415a2d08cf9c280aaa5c447e">split_offset</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae5d7bdd2dd11b0734f0c21cd32b01eb4">bb_split_offset</a>;
<a name="l01687"></a>01687         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a60df9342e823b8abd32cd6d0c08aaa02">totnum</a> = totpart+totchild;
<a name="l01688"></a>01688         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#aac70c76925052fc3df76b2a340dc7e5f">uv_split</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a86e7f3a2fb0169dcdabaef911b35f4c7">bb_uv_split</a>;
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690     
<a name="l01691"></a>01691 <span class="comment">/* 2.5 setup matrices */</span>
<a name="l01692"></a>01692     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01693"></a>01693     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);    <span class="comment">/* need to be that way, for imat texture */</span>
<a name="l01694"></a>01694     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(nmat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l01695"></a>01695     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(nmat);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8b8c8709faf8d9e56ae92e3a3b1b5c22">PSYS_USE_IMAT</a>) {
<a name="l01698"></a>01698         <span class="comment">/* psys-&gt;imat is the original emitter&#39;s inverse matrix, ob-&gt;obmat is the duplicated object&#39;s matrix */</span>
<a name="l01699"></a>01699         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(duplimat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a365fda1e3579186b77768df8dfbd00ed">imat</a>);
<a name="l01700"></a>01700         use_duplimat = 1;
<a name="l01701"></a>01701     }
<a name="l01702"></a>01702 
<a name="l01703"></a>01703 <span class="comment">/* 2.6 setup strand rendering */</span>
<a name="l01704"></a>01704     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ae097f6afc34289ef7ef3a6d6741070ad">pathcache</a>) {
<a name="l01705"></a>01705         path_nbr=(int)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(2.0,(<span class="keywordtype">double</span>) part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a6a1ea7215d8954c0b91be04e954e07cd">ren_step</a>);
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         <span class="keywordflow">if</span> (path_nbr) {
<a name="l01708"></a>01708             <span class="keywordflow">if</span> (!<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a263f8a32d8cbe3456366b40cb01deab1">MA_TYPE_HALO</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)) {
<a name="l01709"></a>01709                 sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(3*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(totpart+totchild), <span class="stringliteral">&quot;particle orcos&quot;</span>);
<a name="l01710"></a>01710                 <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(re, psys, sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>);
<a name="l01711"></a>01711             }
<a name="l01712"></a>01712         }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acea868250d7aa262f408646ec0972116">PART_DRAW_REN_ADAPT</a>) {
<a name="l01715"></a>01715             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9a18f4ecb56704e32a835f381a7d496d">adapt</a> = 1;
<a name="l01716"></a>01716             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#af23992d44b4ee381c47071f695eaba54">adapt_pix</a> = (float)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a19a3dff4fa71b78666952c9c6c7d56a5">adapt_pix</a>;
<a name="l01717"></a>01717             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#adb4ffafff3b2a3a1b332aa020fa420c5">adapt_angle</a> = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(<a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>((<span class="keywordtype">float</span>)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a51398fc6777f3db107adc078a9c868dd">adapt_angle</a>));
<a name="l01718"></a>01718         }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a92b4de1f7fed973f8bd1aa5132965156">PART_DRAW_REN_STRAND</a>) {
<a name="l01721"></a>01721             strandbuf= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ab02839b42540e785e5273ca1b4c46614">RE_addStrandBuffer</a>(obr, (totpart+totchild)*(path_nbr+1));
<a name="l01722"></a>01722             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>= ma;
<a name="l01723"></a>01723             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a09b2691a6cbbfdf69783798db24db9c3">lay</a>= ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>;
<a name="l01724"></a>01724             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l01725"></a>01725             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ae0265e66e1fd71209f05feac678de81b">winx</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>;
<a name="l01726"></a>01726             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a8026d950bbd43253551e536b26d6fffb">winy</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>;
<a name="l01727"></a>01727             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a4b60440e76a41cc800085d7de2a8b635">maxdepth</a>= 2;
<a name="l01728"></a>01728             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a23b915de538dd5c68a1d8f8f7dc335c6">adaptcos</a>= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(<a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>((<span class="keywordtype">float</span>)part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a51398fc6777f3db107adc078a9c868dd">adapt_angle</a>));
<a name="l01729"></a>01729             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a47726a5a65797e9f2f923131dbd2f8d9">overrideuv</a>= sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>;
<a name="l01730"></a>01730             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a3f4950d765020fde67a2a94c72b210ef">minwidth</a>= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac81de8a6b5d49fa2a9fefec3914f04a0">strand_min</a>;
<a name="l01731"></a>01731 
<a name="l01732"></a>01732             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4abaa447ff154f47b0f1fc0c2fdfb3ca">strand_widthfade</a> == 0.0f)
<a name="l01733"></a>01733                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a780bc46fc42cf5b1865e286152f3b788">widthfade</a>= 0.0f;
<a name="l01734"></a>01734             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4abaa447ff154f47b0f1fc0c2fdfb3ca">strand_widthfade</a> &gt;= 1.0f)
<a name="l01735"></a>01735                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a780bc46fc42cf5b1865e286152f3b788">widthfade</a>= 2.0f - ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4abaa447ff154f47b0f1fc0c2fdfb3ca">strand_widthfade</a>;
<a name="l01736"></a>01736             <span class="keywordflow">else</span>
<a name="l01737"></a>01737                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a780bc46fc42cf5b1865e286152f3b788">widthfade</a>= 1.0f/<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4abaa447ff154f47b0f1fc0c2fdfb3ca">strand_widthfade</a>, 1e-5f);
<a name="l01738"></a>01738 
<a name="l01739"></a>01739             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a888e5a2325f4e196a35cb9239128630f">PART_HAIR_BSPLINE</a>)
<a name="l01740"></a>01740                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ad4c20ea25767776b4e98e9302dcfc9ca">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a3eb39e98f95d744e8ef0fd9e5d0023f3">R_STRAND_BSPLINE</a>;
<a name="l01741"></a>01741             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#adde252671ae4d143681435d1b318d0cd">MA_STR_B_UNITS</a>)
<a name="l01742"></a>01742                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ad4c20ea25767776b4e98e9302dcfc9ca">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a57ef394e8a613e63da8a0734424c5627">R_STRAND_B_UNITS</a>;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744             svert= strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ab5b45b76e6487d504e3f25ce25094bd3">vert</a>;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3ec1fac33b9d44c9c2a26c72e5425019">R_SPEED</a>)
<a name="l01747"></a>01747                 dosurfacecache= 1;
<a name="l01748"></a>01748             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>)) &amp;&amp; (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a0d14a3fe319ff85a891e8616759c3469">ao_gather_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>))
<a name="l01749"></a>01749                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a870998ec12271918c097d9077d771aef">amb</a> != 0.0f)
<a name="l01750"></a>01750                     dosurfacecache= 1;
<a name="l01751"></a>01751 
<a name="l01752"></a>01752             totface= psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>);
<a name="l01753"></a>01753             origindex= psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01754"></a>01754             <span class="keywordflow">for</span> (a=0; a&lt;totface; a++)
<a name="l01755"></a>01755                 strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>, (origindex)? origindex[a]: a);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>++;
<a name="l01758"></a>01758             strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d4b/structStrandBound.html">StrandBound</a>)*strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>, <span class="stringliteral">&quot;StrandBound&quot;</span>);
<a name="l01759"></a>01759             sbound= strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>;
<a name="l01760"></a>01760             sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#ab08575b8cb6f47ae376afa33239360f6">start</a>= sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#aec84e7214cacedfee3b4bb7010c9d5e1">end</a>= 0;
<a name="l01761"></a>01761         }
<a name="l01762"></a>01762     }
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a> == 0) {
<a name="l01765"></a>01765         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;particle orco&quot;</span>);
<a name="l01766"></a>01766         orco1 = 1;
<a name="l01767"></a>01767     }
<a name="l01768"></a>01768 
<a name="l01769"></a>01769     <span class="keywordflow">if</span> (path_nbr == 0)
<a name="l01770"></a>01770         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a> = <a class="code" href="../../db/dca/BKE__particle_8h.html#a7f29db3949d983f1e222f2c5bb1a2a91">psys_get_lattice</a>(&amp;sim);
<a name="l01771"></a>01771 
<a name="l01772"></a>01772 <span class="comment">/* 3. start creating renderable things */</span>
<a name="l01773"></a>01773     <span class="keywordflow">for</span> (a=0,pa=pars; a&lt;totpart+totchild; a++, pa++, seed++) {
<a name="l01774"></a>01774         random = <a class="code" href="../../d3/d88/BLI__rand_8h.html#ab057c7a77c085d764280bae1b48aa85e">rng_getFloat</a>(rng);
<a name="l01775"></a>01775         <span class="comment">/* setup per particle individual stuff */</span>
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (a&lt;totpart) {
<a name="l01777"></a>01777             <span class="keywordflow">if</span> (pa-&gt;flag &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a3fafe1ff48e0742fd0c2e5ba4e69b4b1">PARS_UNEXIST</a>) <span class="keywordflow">continue</span>;
<a name="l01778"></a>01778 
<a name="l01779"></a>01779             pa_time=(cfra-pa-&gt;time)/pa-&gt;lifetime;
<a name="l01780"></a>01780             pa_birthtime = pa-&gt;time;
<a name="l01781"></a>01781             pa_dietime = pa-&gt;dietime;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783             hasize = ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a556412ddf197bfe4cfbad58d370b6043">hasize</a>;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785             <span class="comment">/* XXX &#39;tpsys&#39; is alwyas NULL, this code won&#39;t run! */</span>
<a name="l01786"></a>01786             <span class="comment">/* get orco */</span>
<a name="l01787"></a>01787             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (tpsys &amp;&amp; part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aaaa65883b0fd34e1f66db33d0e55ef9e">PART_PHYS_NO</a>) {
<a name="l01788"></a>01788                 tpa = tpsys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>;
<a name="l01789"></a>01789                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(psmd,tpart-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,tpa-&gt;num,pa-&gt;num_dmcache,tpa-&gt;fuv,tpa-&gt;foffset,co,nor,0,0,sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>,0);
<a name="l01790"></a>01790             }
<a name="l01791"></a>01791             <span class="keywordflow">else</span>
<a name="l01792"></a>01792                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(psmd,part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,pa-&gt;num,pa-&gt;num_dmcache,pa-&gt;fuv,pa-&gt;foffset,co,nor,0,0,sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>,0);
<a name="l01793"></a>01793 
<a name="l01794"></a>01794             <span class="comment">/* get uvco &amp; mcol */</span>
<a name="l01795"></a>01795             num= pa-&gt;num_dmcache;
<a name="l01796"></a>01796 
<a name="l01797"></a>01797             <span class="keywordflow">if</span> (num == <a class="code" href="../../db/dca/BKE__particle_8h.html#a2f2c3e768f77e84b7ef667b814b7ac43">DMCACHE_NOTFOUND</a>)
<a name="l01798"></a>01798                 <span class="keywordflow">if</span> (pa-&gt;num &lt; psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>))
<a name="l01799"></a>01799                     num= pa-&gt;num;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801             <a class="code" href="../../d2/d47/convertblender_8c.html#aeee0644dd617d2444637f96aa8c694a3">get_particle_uvco_mcol</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, pa-&gt;fuv, num, &amp;sd);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803             pa_size = pa-&gt;size;
<a name="l01804"></a>01804 
<a name="l01805"></a>01805             r_tilt = 2.0f*(<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(a) - 0.5f);
<a name="l01806"></a>01806             r_length = <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(a+1);
<a name="l01807"></a>01807 
<a name="l01808"></a>01808             <span class="keywordflow">if</span> (path_nbr) {
<a name="l01809"></a>01809                 cache = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ae097f6afc34289ef7ef3a6d6741070ad">pathcache</a>[<a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>];
<a name="l01810"></a>01810                 max_k = (int)cache-&gt;<a class="code" href="../../d1/d8d/structParticleCacheKey.html#a62384f087dce67cd6bc170116446f531">steps</a>;
<a name="l01811"></a>01811             }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813             <span class="keywordflow">if</span> (totchild &amp;&amp; (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a>&amp;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a189fdf56761a6c68b121bb493cad75e3">PART_DRAW_PARENT</a>)==0) <span class="keywordflow">continue</span>;
<a name="l01814"></a>01814         }
<a name="l01815"></a>01815         <span class="keywordflow">else</span> {
<a name="l01816"></a>01816             <a class="code" href="../../d9/ded/structChildParticle.html">ChildParticle</a> *cpa= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0b2c69153aaaa2095eef823b6f030713">child</a>+a-totpart;
<a name="l01817"></a>01817 
<a name="l01818"></a>01818             <span class="keywordflow">if</span> (path_nbr) {
<a name="l01819"></a>01819                 cache = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aa4bf1fe43162b6ea089fdd908773ec94">childcache</a>[a-totpart];
<a name="l01820"></a>01820 
<a name="l01821"></a>01821                 <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d1/d8d/structParticleCacheKey.html#a62384f087dce67cd6bc170116446f531">steps</a> &lt; 0)
<a name="l01822"></a>01822                     <span class="keywordflow">continue</span>;
<a name="l01823"></a>01823 
<a name="l01824"></a>01824                 max_k = (int)cache-&gt;<a class="code" href="../../d1/d8d/structParticleCacheKey.html#a62384f087dce67cd6bc170116446f531">steps</a>;
<a name="l01825"></a>01825             }
<a name="l01826"></a>01826             
<a name="l01827"></a>01827             pa_time = <a class="code" href="../../db/dca/BKE__particle_8h.html#a7e530bd4e2c24bf2360c0ef1d6d94fae">psys_get_child_time</a>(psys, cpa, cfra, &amp;pa_birthtime, &amp;pa_dietime);
<a name="l01828"></a>01828             pa_size = <a class="code" href="../../db/dca/BKE__particle_8h.html#accaa14591eeac19fc0e8596c38c541cc">psys_get_child_size</a>(psys, cpa, cfra, &amp;pa_time);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830             r_tilt = 2.0f*(<a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(a + 21) - 0.5f);
<a name="l01831"></a>01831             r_length = <a class="code" href="../../db/dca/BKE__particle_8h.html#a7c026f5b7959546e115a594622f6da29">PSYS_FRAND</a>(a + 22);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833             num = cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>;
<a name="l01834"></a>01834 
<a name="l01835"></a>01835             <span class="comment">/* get orco */</span>
<a name="l01836"></a>01836             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7abd73329b3203429f5cc4e4782b7296">PART_CHILD_FACES</a>) {
<a name="l01837"></a>01837                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(psmd,
<a name="l01838"></a>01838                     <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>, cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>,<a class="code" href="../../db/dca/BKE__particle_8h.html#ac984be3edf343c7fbc2c73b49d0048b4">DMCACHE_ISCHILD</a>,
<a name="l01839"></a>01839                     cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>,cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a60ac3dbb770e8bb819a8de45749dfe2a">foffset</a>,co,nor,0,0,sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>,0);
<a name="l01840"></a>01840             }
<a name="l01841"></a>01841             <span class="keywordflow">else</span> {
<a name="l01842"></a>01842                 <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *par = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ab2c1496d7cac367b2e04cf9f908e9580">parent</a>;
<a name="l01843"></a>01843                 <a class="code" href="../../db/dca/BKE__particle_8h.html#a24653ef000153b146ea30bdcac0eb7ad">psys_particle_on_emitter</a>(psmd, part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>,
<a name="l01844"></a>01844                     par-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>,<a class="code" href="../../db/dca/BKE__particle_8h.html#ac984be3edf343c7fbc2c73b49d0048b4">DMCACHE_ISCHILD</a>,par-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>,
<a name="l01845"></a>01845                     par-&gt;<a class="code" href="../../dc/d76/structParticleData.html#afe6c97f99dfdf10f30513d37f6aa4212">foffset</a>,co,nor,0,0,sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>,0);
<a name="l01846"></a>01846             }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848             <span class="comment">/* get uvco &amp; mcol */</span>
<a name="l01849"></a>01849             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a30faab7ba125bed62e7c851cc28ff4c8">childtype</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a7abd73329b3203429f5cc4e4782b7296">PART_CHILD_FACES</a>) {
<a name="l01850"></a>01850                 <a class="code" href="../../d2/d47/convertblender_8c.html#aeee0644dd617d2444637f96aa8c694a3">get_particle_uvco_mcol</a>(<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1126cd14d8be21a93187d99b6ab90c70">PART_FROM_FACE</a>, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a57977590d93053ef553aebabe2bd4beb">fuv</a>, cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>, &amp;sd);
<a name="l01851"></a>01851             }
<a name="l01852"></a>01852             <span class="keywordflow">else</span> {
<a name="l01853"></a>01853                 <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *parent = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#ab2c1496d7cac367b2e04cf9f908e9580">parent</a>;
<a name="l01854"></a>01854                 num = parent-&gt;<a class="code" href="../../dc/d76/structParticleData.html#abd27ee5e6b3a527ab7110c3b95c45a7e">num_dmcache</a>;
<a name="l01855"></a>01855 
<a name="l01856"></a>01856                 <span class="keywordflow">if</span> (num == <a class="code" href="../../db/dca/BKE__particle_8h.html#a2f2c3e768f77e84b7ef667b814b7ac43">DMCACHE_NOTFOUND</a>)
<a name="l01857"></a>01857                     <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a> &lt; psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>))
<a name="l01858"></a>01858                         num = parent-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ac824b915f80d2c951df82f3ea0e26db6">num</a>;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860                 <a class="code" href="../../d2/d47/convertblender_8c.html#aeee0644dd617d2444637f96aa8c694a3">get_particle_uvco_mcol</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9cc01cd6e1bd8ad9943e9d6052b26b1">from</a>, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, parent-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a897cf5343f7d61bb9e7d57598bf8fd79">fuv</a>, num, &amp;sd);
<a name="l01861"></a>01861             }
<a name="l01862"></a>01862 
<a name="l01863"></a>01863             dosimplify = <a class="code" href="../../db/dca/BKE__particle_8h.html#aec850b98953e6241c5c0287b99b7c1f5">psys_render_simplify_params</a>(psys, cpa, simplify);
<a name="l01864"></a>01864 
<a name="l01865"></a>01865             <span class="keywordflow">if</span> (strandbuf) {
<a name="l01866"></a>01866                 <span class="keywordtype">int</span> orignum= (origindex)? origindex[cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>]: cpa-&gt;<a class="code" href="../../d9/ded/structChildParticle.html#a0d4b035e8279158aa7f9a18395029534">num</a>;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (orignum &gt; sbound - strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>) {
<a name="l01869"></a>01869                     sbound= strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a> + orignum;
<a name="l01870"></a>01870                     sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#ab08575b8cb6f47ae376afa33239360f6">start</a>= sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#aec84e7214cacedfee3b4bb7010c9d5e1">end</a>= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>;
<a name="l01871"></a>01871                 }
<a name="l01872"></a>01872             }
<a name="l01873"></a>01873         }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875         <span class="comment">/* TEXCO_PARTICLE */</span>
<a name="l01876"></a>01876         pa_co[0] = pa_time;
<a name="l01877"></a>01877         pa_co[1] = 0.f;
<a name="l01878"></a>01878         pa_co[2] = 0.f;
<a name="l01879"></a>01879 
<a name="l01880"></a>01880         <span class="comment">/* surface normal shading setup */</span>
<a name="l01881"></a>01881         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#accc32fc2ffecb51a06017eb26d579997">MA_STR_SURFDIFF</a>) {
<a name="l01882"></a>01882             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(nmat, nor);
<a name="l01883"></a>01883             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>= nor;
<a name="l01884"></a>01884         }
<a name="l01885"></a>01885         <span class="keywordflow">else</span>
<a name="l01886"></a>01886             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01887"></a>01887 
<a name="l01888"></a>01888         <span class="comment">/* strand render setup */</span>
<a name="l01889"></a>01889         <span class="keywordflow">if</span> (strandbuf) {
<a name="l01890"></a>01890             strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>++);
<a name="l01891"></a>01891             strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>= strandbuf;
<a name="l01892"></a>01892             strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>= svert;
<a name="l01893"></a>01893             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a012198a75072bdf65cbf849f226fff2b">orco</a>, sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>);
<a name="l01894"></a>01894 
<a name="l01895"></a>01895             <span class="keywordflow">if</span> (dosimplify) {
<a name="l01896"></a>01896                 <span class="keywordtype">float</span> *ssimplify= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a26c0241dd085faa502fa29c40ab0dfab">RE_strandren_get_simplify</a>(obr, strand, 1);
<a name="l01897"></a>01897                 ssimplify[0]= simplify[0];
<a name="l01898"></a>01898                 ssimplify[1]= simplify[1];
<a name="l01899"></a>01899             }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901             <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>) {
<a name="l01902"></a>01902                 <span class="keywordtype">float</span> *snor= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a2e955713d37b68414b7b03bea6a612e8">RE_strandren_get_surfnor</a>(obr, strand, 1);
<a name="l01903"></a>01903                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(snor, sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a84612bf928ce42977d177804e576c1f2">surfnor</a>);
<a name="l01904"></a>01904             }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906             <span class="keywordflow">if</span> (dosurfacecache &amp;&amp; num &gt;= 0) {
<a name="l01907"></a>01907                 <span class="keywordtype">int</span> *facenum= <a class="code" href="../../d0/db6/renderdatabase_8h.html#aa1a1f05f460a62b6c0dba354c1f5302f">RE_strandren_get_face</a>(obr, strand, 1);
<a name="l01908"></a>01908                 *facenum= num;
<a name="l01909"></a>01909             }
<a name="l01910"></a>01910 
<a name="l01911"></a>01911             <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>) {
<a name="l01912"></a>01912                 <span class="keywordflow">for</span> (i=0; i&lt;sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a78cb60ccc2bf7985df86f2f0d01a0000">totuv</a>; i++) {
<a name="l01913"></a>01913                     <span class="keywordflow">if</span> (i != sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a9bd7bc4452d4641bb77927e78f962910">override_uv</a>) {
<a name="l01914"></a>01914                         <span class="keywordtype">float</span> *uv= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8109cee7789cdf55dac4d08c6f90dd74">RE_strandren_get_uv</a>(obr, strand, i, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01915"></a>01915 
<a name="l01916"></a>01916                         uv[0]= sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>[2*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01917"></a>01917                         uv[1]= sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>[2*i+1];
<a name="l01918"></a>01918                     }
<a name="l01919"></a>01919                 }
<a name="l01920"></a>01920             }
<a name="l01921"></a>01921             <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>) {
<a name="l01922"></a>01922                 <span class="keywordflow">for</span> (i=0; i&lt;sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#ae6f81ed90a21f7bf14afca6c5bfdd25e">totcol</a>; i++) {
<a name="l01923"></a>01923                     <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mc= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a30551bb6a69ef730a82d85969b3b8987">RE_strandren_get_mcol</a>(obr, strand, i, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01924"></a>01924                     *mc = sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01925"></a>01925                 }
<a name="l01926"></a>01926             }
<a name="l01927"></a>01927 
<a name="l01928"></a>01928             sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#aec84e7214cacedfee3b4bb7010c9d5e1">end</a>++;
<a name="l01929"></a>01929         }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="comment">/* strandco computation setup */</span>
<a name="l01932"></a>01932         <span class="keywordflow">if</span> (path_nbr) {
<a name="l01933"></a>01933             strandlen= 0.0f;
<a name="l01934"></a>01934             curlen= 0.0f;
<a name="l01935"></a>01935             <span class="keywordflow">for</span> (k=1; k&lt;=path_nbr; k++)
<a name="l01936"></a>01936                 <span class="keywordflow">if</span> (k&lt;=max_k)
<a name="l01937"></a>01937                     strandlen += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>((cache+k-1)-&gt;co, (cache+k)-&gt;co);
<a name="l01938"></a>01938         }
<a name="l01939"></a>01939 
<a name="l01940"></a>01940         <span class="keywordflow">if</span> (path_nbr) {
<a name="l01941"></a>01941             <span class="comment">/* render strands */</span>
<a name="l01942"></a>01942             <span class="keywordflow">for</span> (k=0; k&lt;=path_nbr; k++) {
<a name="l01943"></a>01943                 <span class="keywordtype">float</span> time;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945                 <span class="keywordflow">if</span> (k&lt;=max_k) {
<a name="l01946"></a>01946                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>,(cache+k)-&gt;co);
<a name="l01947"></a>01947                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(state.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>,(cache+k)-&gt;vel);
<a name="l01948"></a>01948                 }
<a name="l01949"></a>01949                 <span class="keywordflow">else</span>
<a name="l01950"></a>01950                     <span class="keywordflow">continue</span>;   
<a name="l01951"></a>01951 
<a name="l01952"></a>01952                 <span class="keywordflow">if</span> (k &gt; 0)
<a name="l01953"></a>01953                     curlen += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>((cache+k-1)-&gt;co, (cache+k)-&gt;co);
<a name="l01954"></a>01954                 time= curlen/strandlen;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc,state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l01957"></a>01957                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>,loc);
<a name="l01958"></a>01958 
<a name="l01959"></a>01959                 <span class="keywordflow">if</span> (strandbuf) {
<a name="l01960"></a>01960                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(svert-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, loc);
<a name="l01961"></a>01961                     svert-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>= -1.0f + 2.0f*time;
<a name="l01962"></a>01962                     svert++;
<a name="l01963"></a>01963                     strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>++;
<a name="l01964"></a>01964                 }
<a name="l01965"></a>01965                 <span class="keywordflow">else</span> {
<a name="l01966"></a>01966                     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#ae256653a85951805d99a285d82833e24">size</a> = hasize;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                     <span class="keywordflow">if</span> (k==1) {
<a name="l01969"></a>01969                         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a8cbc19f1efca0a0901c3d7f4969c5f03">first</a> = 1;
<a name="l01970"></a>01970                         sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a> = 0.0f;
<a name="l01971"></a>01971                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(loc0,loc1,loc);
<a name="l01972"></a>01972                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(loc0,loc1,loc0);
<a name="l01973"></a>01973 
<a name="l01974"></a>01974                         <a class="code" href="../../d2/d47/convertblender_8c.html#aa4d9e0cefaf21f379aa2088418dc7894">particle_curve</a>(re, obr, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, ma, &amp;sd, loc1, loc0, seed, pa_co);
<a name="l01975"></a>01975                     }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977                     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a8cbc19f1efca0a0901c3d7f4969c5f03">first</a> = 0;
<a name="l01978"></a>01978                     sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a084b13e6d7a48fb9ce569a8dece72d28">time</a> = time;
<a name="l01979"></a>01979 
<a name="l01980"></a>01980                     <span class="keywordflow">if</span> (k)
<a name="l01981"></a>01981                         <a class="code" href="../../d2/d47/convertblender_8c.html#aa4d9e0cefaf21f379aa2088418dc7894">particle_curve</a>(re, obr, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, ma, &amp;sd, loc, loc1, seed, pa_co);
<a name="l01982"></a>01982 
<a name="l01983"></a>01983                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc1,loc);
<a name="l01984"></a>01984                 }
<a name="l01985"></a>01985             }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987         }
<a name="l01988"></a>01988         <span class="keywordflow">else</span> {
<a name="l01989"></a>01989             <span class="comment">/* render normal particles */</span>
<a name="l01990"></a>01990             <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa71e16f10d575c3ec34ea6d934f66d1d">trail_count</a> &gt; 1) {
<a name="l01991"></a>01991                 <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a15135d6b7e6634c4b7411a842b64a4ad">path_end</a> * (1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7164c579cde3741895d0dd4ee2a41e61">randlength</a> * r_length);
<a name="l01992"></a>01992                 <span class="keywordtype">int</span> trail_count = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa71e16f10d575c3ec34ea6d934f66d1d">trail_count</a> * (1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a7164c579cde3741895d0dd4ee2a41e61">randlength</a> * r_length);
<a name="l01993"></a>01993                 <span class="keywordtype">float</span> ct = (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a09c59607aa0f7c01fd4fe7fbb34c7039">PART_ABS_PATH_TIME</a>) ? cfra : pa_time;
<a name="l01994"></a>01994                 <span class="keywordtype">float</span> dt = length / (trail_count ? (float)trail_count : 1.0f);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996                 <span class="comment">/* make sure we have pointcache in memory before getting particle on path */</span>
<a name="l01997"></a>01997                 <a class="code" href="../../db/dca/BKE__particle_8h.html#aac4e8f186d54a552936b89431ce86c04">psys_make_temp_pointcache</a>(ob, psys);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999                 <span class="keywordflow">for</span> (i=0; i &lt; trail_count; i++, ct -= dt) {
<a name="l02000"></a>02000                     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a09c59607aa0f7c01fd4fe7fbb34c7039">PART_ABS_PATH_TIME</a>) {
<a name="l02001"></a>02001                         <span class="keywordflow">if</span> (ct &lt; pa_birthtime || ct &gt; pa_dietime)
<a name="l02002"></a>02002                             <span class="keywordflow">continue</span>;
<a name="l02003"></a>02003                     }
<a name="l02004"></a>02004                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ct &lt; 0.0f || ct &gt; 1.0f)
<a name="l02005"></a>02005                         <span class="keywordflow">continue</span>;
<a name="l02006"></a>02006 
<a name="l02007"></a>02007                     state.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a09c59607aa0f7c01fd4fe7fbb34c7039">PART_ABS_PATH_TIME</a>) ? -ct : ct;
<a name="l02008"></a>02008                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a062a65390dae74a14fe41b2a22c67bea">psys_get_particle_on_path</a>(&amp;sim,a,&amp;state,1);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010                     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac31ded3785aa33d38c83e1dc93156fea">parent</a>)
<a name="l02011"></a>02011                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac31ded3785aa33d38c83e1dc93156fea">parent</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02012"></a>02012 
<a name="l02013"></a>02013                     <span class="keywordflow">if</span> (use_duplimat)
<a name="l02014"></a>02014                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(duplimat, state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02015"></a>02015 
<a name="l02016"></a>02016                     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>) {
<a name="l02017"></a>02017                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a78acfbb2fbcedd50f0844afba008d418">random</a> = <a class="code" href="../../d4/d44/frames_8inl.html#a9f76654728449cbb330e854b25f77ec3" title="addDelta operator for displacement rotational velocity.">random</a>;
<a name="l02018"></a>02018                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[0] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#adc2a4787fc4fb6c47506b6cac21eef72">bb_offset</a>[0];
<a name="l02019"></a>02019                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#adc2a4787fc4fb6c47506b6cac21eef72">bb_offset</a>[1];
<a name="l02020"></a>02020                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[0] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[0] * pa_size;
<a name="l02021"></a>02021                         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa5e839fe2565853c676f08b7c1bbddcd">bb_align</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5910cb4e6c113fc8e4328f567a413086">PART_BB_VEL</a>) {
<a name="l02022"></a>02022                             <span class="keywordtype">float</span> pa_vel = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(state.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02023"></a>02023                             <span class="keywordtype">float</span> head = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9916f8f8768f9864473ad993bd4b249">bb_vel_head</a>*pa_vel;
<a name="l02024"></a>02024                             <span class="keywordtype">float</span> tail = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a54f85cb00348993ac06a64e0dbaf8cb1">bb_vel_tail</a>*pa_vel;
<a name="l02025"></a>02025                             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[1]*pa_size + head + tail;
<a name="l02026"></a>02026                             <span class="comment">/* use offset to adjust the particle center. this is relative to size, so need to divide! */</span>
<a name="l02027"></a>02027                             <span class="keywordflow">if</span> (bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] &gt; 0.0f)
<a name="l02028"></a>02028                                 bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[1] += (head-tail) / bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1];
<a name="l02029"></a>02029                         }
<a name="l02030"></a>02030                         <span class="keywordflow">else</span>
<a name="l02031"></a>02031                             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[1] * pa_size;
<a name="l02032"></a>02032                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a855befd8b0e77597769b9634bdb64e73">tilt</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#abfd06f71fb5dbd817c8cb5ff0923edc5">bb_tilt</a> * (1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa12de1d7cb10a4fe6b5a15206f0f217d">bb_rand_tilt</a> * r_tilt);
<a name="l02033"></a>02033                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac0204e98d02c54487c6fc257e7e00372">time</a> = ct;
<a name="l02034"></a>02034                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#aae60158000c6fa5de26f707103cd703f">num</a> = <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>;
<a name="l02035"></a>02035                     }
<a name="l02036"></a>02036 
<a name="l02037"></a>02037                     pa_co[0] = (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a09c59607aa0f7c01fd4fe7fbb34c7039">PART_ABS_PATH_TIME</a>) ? (ct-pa_birthtime)/(pa_dietime-pa_birthtime) : ct;
<a name="l02038"></a>02038                     pa_co[1] = (float)i/(<span class="keywordtype">float</span>)(trail_count-1);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040                     <a class="code" href="../../d2/d47/convertblender_8c.html#af4d8b992f1f91ec91579be6f8c511456">particle_normal_ren</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, part, re, obr, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, ma, &amp;sd, &amp;bb, &amp;state, seed, hasize, pa_co);
<a name="l02041"></a>02041                 }
<a name="l02042"></a>02042             }
<a name="l02043"></a>02043             <span class="keywordflow">else</span> {
<a name="l02044"></a>02044                 state.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>=cfra;
<a name="l02045"></a>02045                 <span class="keywordflow">if</span> (<a class="code" href="../../db/dca/BKE__particle_8h.html#a954cd827b2145d733493e4fd5f33ab9f">psys_get_particle_state</a>(&amp;sim,a,&amp;state,0)==0)
<a name="l02046"></a>02046                     <span class="keywordflow">continue</span>;
<a name="l02047"></a>02047 
<a name="l02048"></a>02048                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac31ded3785aa33d38c83e1dc93156fea">parent</a>)
<a name="l02049"></a>02049                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ac31ded3785aa33d38c83e1dc93156fea">parent</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02050"></a>02050 
<a name="l02051"></a>02051                 <span class="keywordflow">if</span> (use_duplimat)
<a name="l02052"></a>02052                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(duplimat, state.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l02053"></a>02053 
<a name="l02054"></a>02054                 <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>) {
<a name="l02055"></a>02055                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a78acfbb2fbcedd50f0844afba008d418">random</a> = <a class="code" href="../../d4/d44/frames_8inl.html#a9f76654728449cbb330e854b25f77ec3" title="addDelta operator for displacement rotational velocity.">random</a>;
<a name="l02056"></a>02056                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[0] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#adc2a4787fc4fb6c47506b6cac21eef72">bb_offset</a>[0];
<a name="l02057"></a>02057                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#adc2a4787fc4fb6c47506b6cac21eef72">bb_offset</a>[1];
<a name="l02058"></a>02058                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[0] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[0] * pa_size;
<a name="l02059"></a>02059                     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa5e839fe2565853c676f08b7c1bbddcd">bb_align</a>==<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5910cb4e6c113fc8e4328f567a413086">PART_BB_VEL</a>) {
<a name="l02060"></a>02060                         <span class="keywordtype">float</span> pa_vel = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(state.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l02061"></a>02061                         <span class="keywordtype">float</span> head = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad9916f8f8768f9864473ad993bd4b249">bb_vel_head</a>*pa_vel;
<a name="l02062"></a>02062                         <span class="keywordtype">float</span> tail = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a54f85cb00348993ac06a64e0dbaf8cb1">bb_vel_tail</a>*pa_vel;
<a name="l02063"></a>02063                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[1]*pa_size + head + tail;
<a name="l02064"></a>02064                         <span class="comment">/* use offset to adjust the particle center. this is relative to size, so need to divide! */</span>
<a name="l02065"></a>02065                         <span class="keywordflow">if</span> (bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] &gt; 0.0f)
<a name="l02066"></a>02066                             bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a395816e04f3038efc6030b75732139ae">offset</a>[1] += (head-tail) / bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1];
<a name="l02067"></a>02067                     }
<a name="l02068"></a>02068                     <span class="keywordflow">else</span>
<a name="l02069"></a>02069                         bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a83eae9a35401e80bc2b582e1fcbe5459">size</a>[1] = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a8c0b29bcecae8c2d4a86b20096589f2c">bb_size</a>[1] * pa_size;
<a name="l02070"></a>02070                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a855befd8b0e77597769b9634bdb64e73">tilt</a> = part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#abfd06f71fb5dbd817c8cb5ff0923edc5">bb_tilt</a> * (1.0f - part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#aa12de1d7cb10a4fe6b5a15206f0f217d">bb_rand_tilt</a> * r_tilt);
<a name="l02071"></a>02071                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#ac0204e98d02c54487c6fc257e7e00372">time</a> = pa_time;
<a name="l02072"></a>02072                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#aae60158000c6fa5de26f707103cd703f">num</a> = <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>;
<a name="l02073"></a>02073                     bb.<a class="code" href="../../d0/d06/structParticleBillboardData.html#a7bfe898820fbdfc4d26ab21f468cf81e">lifetime</a> = pa_dietime-pa_birthtime;
<a name="l02074"></a>02074                 }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076                 <a class="code" href="../../d2/d47/convertblender_8c.html#af4d8b992f1f91ec91579be6f8c511456">particle_normal_ren</a>(part-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, part, re, obr, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, ma, &amp;sd, &amp;bb, &amp;state, seed, hasize, pa_co);
<a name="l02077"></a>02077             }
<a name="l02078"></a>02078         }
<a name="l02079"></a>02079 
<a name="l02080"></a>02080         <span class="keywordflow">if</span> (orco1==0)
<a name="l02081"></a>02081             sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>+=3;
<a name="l02082"></a>02082 
<a name="l02083"></a>02083         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l02084"></a>02084             <span class="keywordflow">break</span>;
<a name="l02085"></a>02085     }
<a name="l02086"></a>02086 
<a name="l02087"></a>02087     <span class="keywordflow">if</span> (dosurfacecache)
<a name="l02088"></a>02088         strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00758fa5bf0a222c4d4bf64849a6780d">surface</a>= <a class="code" href="../../d3/dda/strand_8h.html#a54f5f8bfb6f829e604db6598f67ff6e7">cache_strand_surface</a>(re, obr, psmd-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#a60596392ae65e3953f6adbc107498bf5">dm</a>, mat, timeoffset);
<a name="l02089"></a>02089 
<a name="l02090"></a>02090 <span class="comment">/* 4. clean up */</span>
<a name="l02091"></a>02091 <span class="preprocessor">#if 0 // XXX old animation system</span>
<a name="l02092"></a>02092 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ma) do_mat_ipo(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ma);
<a name="l02093"></a>02093 <span class="preprocessor">#endif // XXX old animation system</span>
<a name="l02094"></a>02094 <span class="preprocessor"></span>    
<a name="l02095"></a>02095     <span class="keywordflow">if</span> (orco1)
<a name="l02096"></a>02096         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#abcb4cc3b2db645649539b990ef9bc1c6">orco</a>);
<a name="l02097"></a>02097 
<a name="l02098"></a>02098     <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>)
<a name="l02099"></a>02099         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#aa08ffc2a562dede9dad4f8c90b056a9e">uvco</a>);
<a name="l02100"></a>02100     
<a name="l02101"></a>02101     <span class="keywordflow">if</span> (sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>)
<a name="l02102"></a>02102         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sd.<a class="code" href="../../d7/dee/structParticleStrandData.html#a97f49437bccc25e32a827975277ea118">mcol</a>);
<a name="l02103"></a>02103 
<a name="l02104"></a>02104     <span class="keywordflow">if</span> (uv_name)
<a name="l02105"></a>02105         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(uv_name);
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <span class="keywordflow">if</span> (states)
<a name="l02108"></a>02108         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(states);
<a name="l02109"></a>02109     
<a name="l02110"></a>02110     <a class="code" href="../../d3/d88/BLI__rand_8h.html#af2fb0bfbfbf970240b7a1dcaa3130196">rng_free</a>(rng);
<a name="l02111"></a>02111 
<a name="l02112"></a>02112     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a62f17f5c32eeb28429a0b04904213b75">PSYS_DRAWING</a>;
<a name="l02113"></a>02113 
<a name="l02114"></a>02114     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>) {
<a name="l02115"></a>02115         <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af27478b3dea330c98efca2fec9bf70a3">end_latt_deform</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>);
<a name="l02116"></a>02116         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#aea69f41b4be4c08a4e87060a1769fba5">lattice</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02117"></a>02117     }
<a name="l02118"></a>02118 
<a name="l02119"></a>02119     <span class="keywordflow">if</span> (path_nbr &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a993de724ede213103155201135760761">MA_TANGENT_STR</a>)==0)
<a name="l02120"></a>02120         <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(re, obr, 0, 0);
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <span class="keywordflow">return</span> 1;
<a name="l02123"></a>02123 }
<a name="l02124"></a>02124 
<a name="l02125"></a>02125 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02126"></a>02126 <span class="comment">/* Halo&#39;s                                                                    */</span>
<a name="l02127"></a>02127 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02128"></a>02128 
<a name="l02129"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ad5c7cf8020467481d762b13f91ab7f48">02129</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ad5c7cf8020467481d762b13f91ab7f48">make_render_halos</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(me), <span class="keywordtype">int</span> totvert, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <span class="keywordtype">float</span> *orco)
<a name="l02130"></a>02130 {
<a name="l02131"></a>02131     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02132"></a>02132     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har;
<a name="l02133"></a>02133     <span class="keywordtype">float</span> xn, yn, zn, nor[3], view[3];
<a name="l02134"></a>02134     <span class="keywordtype">float</span> vec[3], hasize, mat[4][4], imat[3][3];
<a name="l02135"></a>02135     <span class="keywordtype">int</span> <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, ok, seed= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1a9403d97555c8ad196577d4efdeb967">seed1</a>;
<a name="l02136"></a>02136 
<a name="l02137"></a>02137     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02138"></a>02138     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l02139"></a>02139 
<a name="l02140"></a>02140     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ad758d53fba824ee16d02d838040740d5">R_HALO</a>;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++, mvert++) {
<a name="l02143"></a>02143         ok= 1;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145         <span class="keywordflow">if</span> (ok) {
<a name="l02146"></a>02146             hasize= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a556412ddf197bfe4cfbad58d370b6043">hasize</a>;
<a name="l02147"></a>02147 
<a name="l02148"></a>02148             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02149"></a>02149             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, vec);
<a name="l02150"></a>02150 
<a name="l02151"></a>02151             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ae6312baac7f71a49cd6c761601476f30">MA_HALOPUNO</a>) {
<a name="l02152"></a>02152                 xn= mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[0];
<a name="l02153"></a>02153                 yn= mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[1];
<a name="l02154"></a>02154                 zn= mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[2];
<a name="l02155"></a>02155 
<a name="l02156"></a>02156                 <span class="comment">/* transpose ! */</span>
<a name="l02157"></a>02157                 nor[0]= imat[0][0]*xn+imat[0][1]*yn+imat[0][2]*zn;
<a name="l02158"></a>02158                 nor[1]= imat[1][0]*xn+imat[1][1]*yn+imat[1][2]*zn;
<a name="l02159"></a>02159                 nor[2]= imat[2][0]*xn+imat[2][1]*yn+imat[2][2]*zn;
<a name="l02160"></a>02160                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02161"></a>02161 
<a name="l02162"></a>02162                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(view, vec);
<a name="l02163"></a>02163                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165                 zn = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, view);
<a name="l02166"></a>02166                 <span class="keywordflow">if</span> (zn&gt;=0.0f) hasize= 0.0f;
<a name="l02167"></a>02167                 <span class="keywordflow">else</span> hasize*= zn*zn*zn*zn;
<a name="l02168"></a>02168             }
<a name="l02169"></a>02169 
<a name="l02170"></a>02170             <span class="keywordflow">if</span> (orco) har= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a06d0c0e5efa543b1d2b5d66f7b87fe3f">RE_inithalo</a>(re, obr, ma, vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, orco, hasize, 0.0, seed);
<a name="l02171"></a>02171             <span class="keywordflow">else</span> har= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a06d0c0e5efa543b1d2b5d66f7b87fe3f">RE_inithalo</a>(re, obr, ma, vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, hasize, 0.0, seed);
<a name="l02172"></a>02172             <span class="keywordflow">if</span> (har) har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4846848b366b4f085ce68cf576e2b411">lay</a>= ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>;
<a name="l02173"></a>02173         }
<a name="l02174"></a>02174         <span class="keywordflow">if</span> (orco) orco+= 3;
<a name="l02175"></a>02175         seed++;
<a name="l02176"></a>02176     }
<a name="l02177"></a>02177 }
<a name="l02178"></a>02178 
<a name="l02179"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a98dc17d2dc105fe37c2262c02d94873d">02179</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a98dc17d2dc105fe37c2262c02d94873d">verghalo</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a1, <span class="keyword">const</span> <span class="keywordtype">void</span> *a2)
<a name="l02180"></a>02180 {
<a name="l02181"></a>02181     <span class="keyword">const</span> <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har1= *(<span class="keyword">const</span> <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a>**)a1;
<a name="l02182"></a>02182     <span class="keyword">const</span> <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har2= *(<span class="keyword">const</span> <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a>**)a2;
<a name="l02183"></a>02183     
<a name="l02184"></a>02184     <span class="keywordflow">if</span> (har1-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a> &lt; har2-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a>) <span class="keywordflow">return</span> 1;
<a name="l02185"></a>02185     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (har1-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a> &gt; har2-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a>) <span class="keywordflow">return</span> -1;
<a name="l02186"></a>02186     <span class="keywordflow">return</span> 0;
<a name="l02187"></a>02187 }
<a name="l02188"></a>02188 
<a name="l02189"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a44bf7a78b98eccd15755e86a43a44d53">02189</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a44bf7a78b98eccd15755e86a43a44d53">sort_halos</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">int</span> totsort)
<a name="l02190"></a>02190 {
<a name="l02191"></a>02191     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l02192"></a>02192     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, **haso;
<a name="l02193"></a>02193     <span class="keywordtype">int</span> <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>;
<a name="l02194"></a>02194 
<a name="l02195"></a>02195     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>==0) <span class="keywordflow">return</span>;
<a name="l02196"></a>02196 
<a name="l02197"></a>02197     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a>*)*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>, <span class="stringliteral">&quot;sorthalos&quot;</span>);
<a name="l02198"></a>02198     haso= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>;
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>) {
<a name="l02201"></a>02201         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>; a++) {
<a name="l02202"></a>02202             <span class="keywordflow">if</span> ((a &amp; 255)==0) har= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a757e0854631bc43f0888cca915688d10">bloha</a>[a&gt;&gt;8];
<a name="l02203"></a>02203             <span class="keywordflow">else</span> har++;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205             *(haso++)= har;
<a name="l02206"></a>02206         }
<a name="l02207"></a>02207     }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209     qsort(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>, totsort, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a>*), <a class="code" href="../../d2/d47/convertblender_8c.html#a98dc17d2dc105fe37c2262c02d94873d">verghalo</a>);
<a name="l02210"></a>02210 }
<a name="l02211"></a>02211 
<a name="l02212"></a>02212 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02213"></a>02213 <span class="comment">/* Displacement Mapping                                                      */</span>
<a name="l02214"></a>02214 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02215"></a>02215 
<a name="l02216"></a><a class="code" href="../../d2/d47/convertblender_8c.html#afc4a5bc2d6b4770f1d4c077f75a246a4">02216</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d2/d47/convertblender_8c.html#afc4a5bc2d6b4770f1d4c077f75a246a4">test_for_displace</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02217"></a>02217 {
<a name="l02218"></a>02218     <span class="comment">/* return 1 when this object uses displacement textures. */</span>
<a name="l02219"></a>02219     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l02220"></a>02220     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02221"></a>02221     
<a name="l02222"></a>02222     <span class="keywordflow">for</span> (i=1; i&lt;=ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; i++) {
<a name="l02223"></a>02223         ma=<a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, i);
<a name="l02224"></a>02224         <span class="comment">/* ma-&gt;mapto is ORed total of all mapto channels */</span>
<a name="l02225"></a>02225         <span class="keywordflow">if</span> (ma &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab563b1bb0f09cea5297c729d8d582c80">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a6c854338c5f616f758046219cf45b454">MAP_DISPLACE</a>)) <span class="keywordflow">return</span> 1;
<a name="l02226"></a>02226     }
<a name="l02227"></a>02227     <span class="keywordflow">return</span> 0;
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 
<a name="l02230"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">02230</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">displace_render_vert</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *vr, <span class="keywordtype">int</span> vindex, <span class="keywordtype">float</span> *scale, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">float</span> imat[][3])
<a name="l02231"></a>02231 {
<a name="l02232"></a>02232     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface;
<a name="l02233"></a>02233     <span class="keywordtype">short</span> texco= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a>;
<a name="l02234"></a>02234     <span class="keywordtype">float</span> sample=0, displace[3];
<a name="l02235"></a>02235     <span class="keywordtype">char</span> *name;
<a name="l02236"></a>02236     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02237"></a>02237 
<a name="l02238"></a>02238     <span class="comment">/* shi-&gt;co is current render coord, just make sure at least some vector is here */</span>
<a name="l02239"></a>02239     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02240"></a>02240     <span class="comment">/* vertex normal is used for textures type &#39;col&#39; and &#39;var&#39; */</span>
<a name="l02241"></a>02241     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243     <span class="keywordflow">if</span> (mat)
<a name="l02244"></a>02244         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02245"></a>02245 
<a name="l02246"></a>02246     <span class="keywordflow">if</span> (imat) {
<a name="l02247"></a>02247         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[0], vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02248"></a>02248         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[1], vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02249"></a>02249         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[2], vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02250"></a>02250     }
<a name="l02251"></a>02251 
<a name="l02252"></a>02252     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>) {
<a name="l02253"></a>02253         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7bc618e140f97186f3d736795511a6a3">totuv</a>= 0;
<a name="l02254"></a>02254         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac83061350468fa98d31884e34086fb78">actuv</a>= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a8b8dcf45053513ce813d68866c66c983">actmtface</a>;
<a name="l02255"></a>02255 
<a name="l02256"></a>02256         <span class="keywordflow">for</span> (i=0; (tface=<a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, i, &amp;name, 0)); i++) {
<a name="l02257"></a>02257             <a class="code" href="../../d9/dbd/structShadeInputUV.html">ShadeInputUV</a> *suv= &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02258"></a>02258 
<a name="l02259"></a>02259             <span class="comment">/* shi.uv needs scale correction from tface uv */</span>
<a name="l02260"></a>02260             suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[0]= 2*tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[vindex][0]-1.0f;
<a name="l02261"></a>02261             suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[1]= 2*tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[vindex][1]-1.0f;
<a name="l02262"></a>02262             suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[2]= 0.0f;
<a name="l02263"></a>02263             suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97c1ee0ff9f1462a3bd02f2352698809">name</a>= name;
<a name="l02264"></a>02264             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7bc618e140f97186f3d736795511a6a3">totuv</a>++;
<a name="l02265"></a>02265         }
<a name="l02266"></a>02266     }
<a name="l02267"></a>02267 
<a name="l02268"></a>02268     <span class="comment">/* set all rendercoords, &#39;texco&#39; is an ORed value for all textures needed */</span>
<a name="l02269"></a>02269     <span class="keywordflow">if</span> ((texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>) &amp;&amp; (vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>)) {
<a name="l02270"></a>02270         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb54b5adec3827670a144c48b94abb48">lo</a>, vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>);
<a name="l02271"></a>02271     }
<a name="l02272"></a>02272     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a60edf27e1e829323a1caa8f0c2318047">TEXCO_STICKY</a>) {
<a name="l02273"></a>02273         <span class="keywordtype">float</span> *sticky= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a94de0c766725e8a10a4fe37639eca128">RE_vertren_get_sticky</a>(obr, vr, 0);
<a name="l02274"></a>02274         <span class="keywordflow">if</span> (sticky) {
<a name="l02275"></a>02275             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1481c782eba3468a124f6096ec544c32">sticky</a>[0]= sticky[0];
<a name="l02276"></a>02276             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1481c782eba3468a124f6096ec544c32">sticky</a>[1]= sticky[1];
<a name="l02277"></a>02277             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1481c782eba3468a124f6096ec544c32">sticky</a>[2]= 0.0f;
<a name="l02278"></a>02278         }
<a name="l02279"></a>02279     }
<a name="l02280"></a>02280     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) {
<a name="l02281"></a>02281         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02282"></a>02282         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>);
<a name="l02283"></a>02283     }
<a name="l02284"></a>02284     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aaa5de8ec9022fb2d91875b60047eecb1">TEXCO_NORM</a>) {
<a name="l02285"></a>02285         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a26b05dc2892589038568bc54023ffda2">orn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l02286"></a>02286     }
<a name="l02287"></a>02287     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a29019e3a840bac8047994ce5829b07d6">TEXCO_REFL</a>) {
<a name="l02288"></a>02288         <span class="comment">/* not (yet?) */</span>
<a name="l02289"></a>02289     }
<a name="l02290"></a>02290     <span class="keywordflow">if</span> (texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8f7e277845f209165fd27712f95e3fc">TEXCO_STRESS</a>) {
<a name="l02291"></a>02291         <span class="keywordtype">float</span> *s= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac6265369f1b2b43fe1c4586fe4b55d6e">RE_vertren_get_stress</a>(obr, vr, 0);
<a name="l02292"></a>02292 
<a name="l02293"></a>02293         <span class="keywordflow">if</span> (s) {
<a name="l02294"></a>02294             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>= *s;
<a name="l02295"></a>02295             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>&lt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>-= 1.0f;
<a name="l02296"></a>02296             <span class="keywordflow">else</span> shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>-1.0f)/shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>;
<a name="l02297"></a>02297         }
<a name="l02298"></a>02298         <span class="keywordflow">else</span>
<a name="l02299"></a>02299             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>= 0.0f;
<a name="l02300"></a>02300     }
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]= 0.0;
<a name="l02303"></a>02303     
<a name="l02304"></a>02304     <a class="code" href="../../d8/d7c/gpu__material_8c.html#ab09827a486fe37e91a118c621f94cfdd">do_material_tex</a>(shi, re);
<a name="l02305"></a>02305     
<a name="l02306"></a>02306     <span class="comment">//printf(&quot;no=%f, %f, %f\nbefore co=%f, %f, %f\n&quot;, vr-&gt;n[0], vr-&gt;n[1], vr-&gt;n[2], </span>
<a name="l02307"></a>02307     <span class="comment">//vr-&gt;co[0], vr-&gt;co[1], vr-&gt;co[2]);</span>
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     displace[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0] * scale[0];
<a name="l02310"></a>02310     displace[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1] * scale[1];
<a name="l02311"></a>02311     displace[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2] * scale[2];
<a name="l02312"></a>02312     
<a name="l02313"></a>02313     <span class="keywordflow">if</span> (mat)
<a name="l02314"></a>02314         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, displace);
<a name="l02315"></a>02315 
<a name="l02316"></a>02316     <span class="comment">/* 0.5 could become button once?  */</span>
<a name="l02317"></a>02317     vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[0] += displace[0]; 
<a name="l02318"></a>02318     vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[1] += displace[1];
<a name="l02319"></a>02319     vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[2] += displace[2];
<a name="l02320"></a>02320     
<a name="l02321"></a>02321     <span class="comment">//printf(&quot;after co=%f, %f, %f\n&quot;, vr-&gt;co[0], vr-&gt;co[1], vr-&gt;co[2]); </span>
<a name="l02322"></a>02322     
<a name="l02323"></a>02323     <span class="comment">/* we just don&#39;t do this vertex again, bad luck for other face using same vertex with</span>
<a name="l02324"></a>02324 <span class="comment">     * different material... */</span>
<a name="l02325"></a>02325     vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a> |= 1;
<a name="l02326"></a>02326     
<a name="l02327"></a>02327     <span class="comment">/* Pass sample back so displace_face can decide which way to split the quad */</span>
<a name="l02328"></a>02328     sample  = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0];
<a name="l02329"></a>02329     sample += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1];
<a name="l02330"></a>02330     sample += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2];
<a name="l02331"></a>02331     
<a name="l02332"></a>02332     vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>=sample; 
<a name="l02333"></a>02333     <span class="comment">/* Should be sqrt(sample), but I&#39;m only looking for &quot;bigger&quot;.  Save the cycles. */</span>
<a name="l02334"></a>02334     <span class="keywordflow">return</span>;
<a name="l02335"></a>02335 }
<a name="l02336"></a>02336 
<a name="l02337"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a566ef27297240a3b732d23a1bb5dc7bd">02337</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a566ef27297240a3b732d23a1bb5dc7bd">displace_render_face</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">float</span> *scale, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">float</span> imat[][3])
<a name="l02338"></a>02338 {
<a name="l02339"></a>02339     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi;
<a name="l02340"></a>02340 
<a name="l02341"></a>02341     <span class="comment">/* Warning, This is not that nice, and possibly a bit slow,</span>
<a name="l02342"></a>02342 <span class="comment">     * however some variables were not initialized properly in, unless using shade_input_initialize(...), we need to do a memset */</span>
<a name="l02343"></a>02343     memset(&amp;shi, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a>)); 
<a name="l02344"></a>02344     <span class="comment">/* end warning! - Campbell */</span>
<a name="l02345"></a>02345     
<a name="l02346"></a>02346     <span class="comment">/* set up shadeinput struct for multitex() */</span>
<a name="l02347"></a>02347     
<a name="l02348"></a>02348     <span class="comment">/* memset above means we don&#39;t need this */</span>
<a name="l02349"></a>02349     <span class="comment">/*shi.osatex= 0;*/</span>      <span class="comment">/* signal not to use dx[] and dy[] texture AA vectors */</span>
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>= obr;
<a name="l02352"></a>02352     shi.<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>= vlr;       <span class="comment">/* current render face */</span>
<a name="l02353"></a>02353     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;      <span class="comment">/* current input material */</span>
<a name="l02354"></a>02354     shi.<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>= 0;
<a name="l02355"></a>02355     
<a name="l02356"></a>02356     <span class="comment">/* TODO, assign these, displacement with new bumpmap is skipped without - campbell */</span>
<a name="l02357"></a>02357 <span class="preprocessor">#if 0</span>
<a name="l02358"></a>02358 <span class="preprocessor"></span>    <span class="comment">/* order is not known ? */</span>
<a name="l02359"></a>02359     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l02360"></a>02360     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l02361"></a>02361     shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l02362"></a>02362 <span class="preprocessor">#endif</span>
<a name="l02363"></a>02363 <span class="preprocessor"></span>
<a name="l02364"></a>02364     <span class="comment">/* Displace the verts, flag is set when done */</span>
<a name="l02365"></a>02365     <span class="keywordflow">if</span> (!vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a>)
<a name="l02366"></a>02366         <a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">displace_render_vert</a>(re, obr, &amp;shi, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>,0,  scale, mat, imat);
<a name="l02367"></a>02367     
<a name="l02368"></a>02368     <span class="keywordflow">if</span> (!vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a>)
<a name="l02369"></a>02369         <a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">displace_render_vert</a>(re, obr, &amp;shi, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>, 1, scale, mat, imat);
<a name="l02370"></a>02370 
<a name="l02371"></a>02371     <span class="keywordflow">if</span> (!vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a>)
<a name="l02372"></a>02372         <a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">displace_render_vert</a>(re, obr, &amp;shi, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>, 2, scale, mat, imat);
<a name="l02373"></a>02373 
<a name="l02374"></a>02374     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02375"></a>02375         <span class="keywordflow">if</span> (!vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a>)
<a name="l02376"></a>02376             <a class="code" href="../../d2/d47/convertblender_8c.html#a0d824401f8656e1d8fd36322aa0e35b7">displace_render_vert</a>(re, obr, &amp;shi, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>, 3, scale, mat, imat);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378         <span class="comment">/*  closest in displace value.  This will help smooth edges.   */</span> 
<a name="l02379"></a>02379         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a> - vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a> - vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ae0dab38b58be5b76107521fc4c24e824">accum</a>)) 
<a name="l02380"></a>02380             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l02381"></a>02381         <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l02382"></a>02382     }
<a name="l02383"></a>02383     
<a name="l02384"></a>02384     <span class="comment">/* Recalculate the face normal  - if flipped before, flip now */</span>
<a name="l02385"></a>02385     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02386"></a>02386         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02387"></a>02387     }   
<a name="l02388"></a>02388     <span class="keywordflow">else</span> {
<a name="l02389"></a>02389         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02390"></a>02390     }
<a name="l02391"></a>02391 }
<a name="l02392"></a>02392 
<a name="l02393"></a><a class="code" href="../../d2/d47/convertblender_8c.html#abc6702a65404f735fccec4cac6a0be5c">02393</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#abc6702a65404f735fccec4cac6a0be5c">do_displacement</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">float</span> imat[][3])
<a name="l02394"></a>02394 {
<a name="l02395"></a>02395     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *vr;
<a name="l02396"></a>02396     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l02397"></a>02397 <span class="comment">//  float min[3]={1e30, 1e30, 1e30}, max[3]={-1e30, -1e30, -1e30};</span>
<a name="l02398"></a>02398     <span class="keywordtype">float</span> scale[3]={1.0f, 1.0f, 1.0f}, temp[3];<span class="comment">//, xn</span>
<a name="l02399"></a>02399     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; <span class="comment">//, texflag=0;</span>
<a name="l02400"></a>02400     <a class="code" href="../../de/de7/structObject.html">Object</a> *obt;
<a name="l02401"></a>02401         
<a name="l02402"></a>02402     <span class="comment">/* Object Size with parenting */</span>
<a name="l02403"></a>02403     obt=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02404"></a>02404     <span class="keywordflow">while</span> (obt) {
<a name="l02405"></a>02405         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(temp, obt-&gt;<a class="code" href="../../de/de7/structObject.html#a46e0f5309f8c13d85e16fa6436acf9f8">size</a>, obt-&gt;<a class="code" href="../../de/de7/structObject.html#ac0afd409155d40dcdbedb76aa45b8ee2">dscale</a>);
<a name="l02406"></a>02406         scale[0]*=temp[0]; scale[1]*=temp[1]; scale[2]*=temp[2];
<a name="l02407"></a>02407         obt=obt-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>;
<a name="l02408"></a>02408     }
<a name="l02409"></a>02409     
<a name="l02410"></a>02410     <span class="comment">/* Clear all flags */</span>
<a name="l02411"></a>02411     <span class="keywordflow">for</span> (i=0; i&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; i++) {
<a name="l02412"></a>02412         vr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, i);
<a name="l02413"></a>02413         vr-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a0cae20ddd0f10b24c72a1b6ce2720d4a">flag</a>= 0;
<a name="l02414"></a>02414     }
<a name="l02415"></a>02415 
<a name="l02416"></a>02416     <span class="keywordflow">for</span> (i=0; i&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; i++) {
<a name="l02417"></a>02417         vlr=<a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, i);
<a name="l02418"></a>02418         <a class="code" href="../../d2/d47/convertblender_8c.html#a566ef27297240a3b732d23a1bb5dc7bd">displace_render_face</a>(re, obr, vlr, scale, mat, imat);
<a name="l02419"></a>02419     }
<a name="l02420"></a>02420     
<a name="l02421"></a>02421     <span class="comment">/* Recalc vertex normals */</span>
<a name="l02422"></a>02422     <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(re, obr, 0, 0);
<a name="l02423"></a>02423 }
<a name="l02424"></a>02424 
<a name="l02425"></a>02425 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02426"></a>02426 <span class="comment">/* Metaball                                                                  */</span>
<a name="l02427"></a>02427 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02428"></a>02428 
<a name="l02429"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af77ff76cb463a4ae9676699b05049082">02429</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af77ff76cb463a4ae9676699b05049082">init_render_mball</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l02430"></a>02430 {
<a name="l02431"></a>02431     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02432"></a>02432     <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl;
<a name="l02433"></a>02433     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver;
<a name="l02434"></a>02434     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, *vlr1;
<a name="l02435"></a>02435     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l02436"></a>02436     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, *nors, *orco=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mat[4][4], imat[3][3], xn, yn, zn;
<a name="l02437"></a>02437     <span class="keywordtype">int</span> <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, need_orco, vlakindex, *index, negative_scale;
<a name="l02438"></a>02438     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> dispbase= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02439"></a>02439 
<a name="l02440"></a>02440     <span class="keywordflow">if</span> (ob!=<a class="code" href="../../df/dae/BKE__mball_8h.html#acd6cd7889caaf039ef167e52af35639a" title="This function finds basic MetaBall.">find_basis_mball</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob))
<a name="l02441"></a>02441         <span class="keywordflow">return</span>;
<a name="l02442"></a>02442 
<a name="l02443"></a>02443     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02444"></a>02444     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l02445"></a>02445     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l02446"></a>02446     negative_scale = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6f80f6c6c2dfac5c69d2a27d06d18c23">is_negative_m4</a>(mat);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448     ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, 1);
<a name="l02449"></a>02449 
<a name="l02450"></a>02450     need_orco= 0;
<a name="l02451"></a>02451     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>) {
<a name="l02452"></a>02452         need_orco= 1;
<a name="l02453"></a>02453     }
<a name="l02454"></a>02454 
<a name="l02455"></a>02455     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a71c335090cec4162f3a0e3acf89ad310">makeDispListMBall_forRender</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, &amp;dispbase);
<a name="l02456"></a>02456     dl= dispbase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02457"></a>02457     <span class="keywordflow">if</span> (dl==0) <span class="keywordflow">return</span>;
<a name="l02458"></a>02458 
<a name="l02459"></a>02459     data= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>;
<a name="l02460"></a>02460     nors= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#aa979db9e4f514999a21f547dab4caa19">nors</a>;
<a name="l02461"></a>02461     <span class="keywordflow">if</span> (need_orco) {
<a name="l02462"></a>02462         orco= <a class="code" href="../../d2/d47/convertblender_8c.html#ad56296da8b74deccdcd514baf9a80df9">get_object_orco</a>(re, ob);
<a name="l02463"></a>02463 
<a name="l02464"></a>02464         <span class="keywordflow">if</span> (!orco) {
<a name="l02465"></a>02465             <span class="comment">/* orco hasn&#39;t been found in cache - create new one and add to cache */</span>
<a name="l02466"></a>02466             orco= <a class="code" href="../../df/dae/BKE__mball_8h.html#a97c7a731502b6f63b5d2391345232dab">make_orco_mball</a>(ob, &amp;dispbase);
<a name="l02467"></a>02467             <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(re, ob, orco);
<a name="l02468"></a>02468         }
<a name="l02469"></a>02469     }
<a name="l02470"></a>02470 
<a name="l02471"></a>02471     <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>; a++, data+=3, nors+=3) {
<a name="l02472"></a>02472 
<a name="l02473"></a>02473         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02474"></a>02474         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, data);
<a name="l02475"></a>02475         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02476"></a>02476 
<a name="l02477"></a>02477         <span class="comment">/* render normals are inverted */</span>
<a name="l02478"></a>02478         xn= -nors[0];
<a name="l02479"></a>02479         yn= -nors[1];
<a name="l02480"></a>02480         zn= -nors[2];
<a name="l02481"></a>02481 
<a name="l02482"></a>02482         <span class="comment">/* transpose ! */</span>
<a name="l02483"></a>02483         ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[0]= imat[0][0]*xn+imat[0][1]*yn+imat[0][2]*zn;
<a name="l02484"></a>02484         ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[1]= imat[1][0]*xn+imat[1][1]*yn+imat[1][2]*zn;
<a name="l02485"></a>02485         ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>[2]= imat[2][0]*xn+imat[2][1]*yn+imat[2][2]*zn;
<a name="l02486"></a>02486         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02487"></a>02487         <span class="comment">//if (ob-&gt;transflag &amp; OB_NEG_SCALE) negate_v3(ver-&gt;n);</span>
<a name="l02488"></a>02488         
<a name="l02489"></a>02489         <span class="keywordflow">if</span> (need_orco) {
<a name="l02490"></a>02490             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco;
<a name="l02491"></a>02491             orco+=3;
<a name="l02492"></a>02492         }
<a name="l02493"></a>02493     }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495     index= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a6c3c9ad7f71c3ee1a79e23af0c6cef42">index</a>;
<a name="l02496"></a>02496     <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>; a++, index+=4) {
<a name="l02497"></a>02497 
<a name="l02498"></a>02498         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l02499"></a>02499         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, index[0]);
<a name="l02500"></a>02500         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, index[1]);
<a name="l02501"></a>02501         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, index[2]);
<a name="l02502"></a>02502         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= 0;
<a name="l02503"></a>02503 
<a name="l02504"></a>02504         <span class="keywordflow">if</span> (negative_scale)
<a name="l02505"></a>02505             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02506"></a>02506         <span class="keywordflow">else</span>
<a name="l02507"></a>02507             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02508"></a>02508 
<a name="l02509"></a>02509         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l02510"></a>02510         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>;
<a name="l02511"></a>02511         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= 0;
<a name="l02512"></a>02512 
<a name="l02513"></a>02513         <span class="comment">/* mball -too bad- always has triangles, because quads can be non-planar */</span>
<a name="l02514"></a>02514         <span class="keywordflow">if</span> (index[3] &amp;&amp; index[3]!=index[2]) {
<a name="l02515"></a>02515             vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l02516"></a>02516             vlakindex= vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af721989ef4a8a22ba8a0f80e6d2960ee">index</a>;
<a name="l02517"></a>02517             *vlr1= *vlr;
<a name="l02518"></a>02518             vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af721989ef4a8a22ba8a0f80e6d2960ee">index</a>= vlakindex;
<a name="l02519"></a>02519             vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l02520"></a>02520             vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, index[3]);
<a name="l02521"></a>02521             <span class="keywordflow">if</span> (negative_scale)
<a name="l02522"></a>02522                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02523"></a>02523             <span class="keywordflow">else</span>
<a name="l02524"></a>02524                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02525"></a>02525         }
<a name="l02526"></a>02526     }
<a name="l02527"></a>02527 
<a name="l02528"></a>02528     <span class="comment">/* enforce display lists remade */</span>
<a name="l02529"></a>02529     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;dispbase);
<a name="l02530"></a>02530 }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02533"></a>02533 <span class="comment">/* Surfaces and Curves                                                       */</span>
<a name="l02534"></a>02534 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02535"></a>02535 
<a name="l02536"></a>02536 <span class="comment">/* returns amount of vertices added for orco */</span>
<a name="l02537"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ab23111db5ac4cb4bd8e5faac51a880f1">02537</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ab23111db5ac4cb4bd8e5faac51a880f1">dl_surf_to_renderdata</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> **matar, <span class="keywordtype">float</span> *orco, <span class="keywordtype">float</span> mat[4][4])
<a name="l02538"></a>02538 {
<a name="l02539"></a>02539     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, *v2, *v3, *v4, *ver;
<a name="l02540"></a>02540     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, *vlr1, *vlr2, *vlr3;
<a name="l02541"></a>02541     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, n1[3];
<a name="l02542"></a>02542     <span class="keywordtype">int</span> u, v, orcoret= 0;
<a name="l02543"></a>02543     <span class="keywordtype">int</span> p1, p2, p3, p4, <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>;
<a name="l02544"></a>02544     <span class="keywordtype">int</span> sizeu, nsizeu, sizev, nsizev;
<a name="l02545"></a>02545     <span class="keywordtype">int</span> startvert, startvlak;
<a name="l02546"></a>02546     
<a name="l02547"></a>02547     startvert= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l02548"></a>02548     nsizeu = sizeu = dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>; nsizev = sizev = dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>; 
<a name="l02549"></a>02549     
<a name="l02550"></a>02550     data= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>;
<a name="l02551"></a>02551     <span class="keywordflow">for</span> (u = 0; u &lt; sizeu; u++) {
<a name="l02552"></a>02552         v1 = <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++); <span class="comment">/* save this for possible V wrapping */</span>
<a name="l02553"></a>02553         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, data); data += 3;
<a name="l02554"></a>02554         <span class="keywordflow">if</span> (orco) {
<a name="l02555"></a>02555             v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco; orco+= 3; orcoret++;
<a name="l02556"></a>02556         }   
<a name="l02557"></a>02557         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02558"></a>02558         
<a name="l02559"></a>02559         <span class="keywordflow">for</span> (v = 1; v &lt; sizev; v++) {
<a name="l02560"></a>02560             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02561"></a>02561             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, data); data += 3;
<a name="l02562"></a>02562             <span class="keywordflow">if</span> (orco) {
<a name="l02563"></a>02563                 ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco; orco+= 3; orcoret++;
<a name="l02564"></a>02564             }   
<a name="l02565"></a>02565             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02566"></a>02566         }
<a name="l02567"></a>02567         <span class="comment">/* if V-cyclic, add extra vertices at end of the row */</span>
<a name="l02568"></a>02568         <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>) {
<a name="l02569"></a>02569             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02570"></a>02570             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02571"></a>02571             <span class="keywordflow">if</span> (orco) {
<a name="l02572"></a>02572                 ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco; orco+=3; orcoret++; <span class="comment">//orcobase + 3*(u*sizev + 0);</span>
<a name="l02573"></a>02573             }
<a name="l02574"></a>02574         }   
<a name="l02575"></a>02575     }   
<a name="l02576"></a>02576     
<a name="l02577"></a>02577     <span class="comment">/* Done before next loop to get corner vert */</span>
<a name="l02578"></a>02578     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>) nsizev++;
<a name="l02579"></a>02579     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>) nsizeu++;
<a name="l02580"></a>02580     
<a name="l02581"></a>02581     <span class="comment">/* if U cyclic, add extra row at end of column */</span>
<a name="l02582"></a>02582     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>) {
<a name="l02583"></a>02583         <span class="keywordflow">for</span> (v = 0; v &lt; nsizev; v++) {
<a name="l02584"></a>02584             v1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, startvert + v);
<a name="l02585"></a>02585             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02586"></a>02586             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02587"></a>02587             <span class="keywordflow">if</span> (orco) {
<a name="l02588"></a>02588                 ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco; orco+=3; orcoret++; <span class="comment">//ver-&gt;orco= orcobase + 3*(0*sizev + v);</span>
<a name="l02589"></a>02589             }
<a name="l02590"></a>02590         }
<a name="l02591"></a>02591     }
<a name="l02592"></a>02592     
<a name="l02593"></a>02593     sizeu = nsizeu;
<a name="l02594"></a>02594     sizev = nsizev;
<a name="l02595"></a>02595     
<a name="l02596"></a>02596     startvlak= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l02597"></a>02597     
<a name="l02598"></a>02598     <span class="keywordflow">for</span> (u = 0; u &lt; sizeu - 1; u++) {
<a name="l02599"></a>02599         p1 = startvert + u * sizev; <span class="comment">/* walk through face list */</span>
<a name="l02600"></a>02600         p2 = p1 + 1;
<a name="l02601"></a>02601         p3 = p2 + sizev;
<a name="l02602"></a>02602         p4 = p3 - 1;
<a name="l02603"></a>02603         
<a name="l02604"></a>02604         <span class="keywordflow">for</span> (v = 0; v &lt; sizev - 1; v++) {
<a name="l02605"></a>02605             v1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p1);
<a name="l02606"></a>02606             v2= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p2);
<a name="l02607"></a>02607             v3= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p3);
<a name="l02608"></a>02608             v4= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p4);
<a name="l02609"></a>02609             
<a name="l02610"></a>02610             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l02611"></a>02611             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v1; vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v2; vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= v3; vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= v4;
<a name="l02612"></a>02612             
<a name="l02613"></a>02613             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( n1,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02614"></a>02614             
<a name="l02615"></a>02615             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, n1);
<a name="l02616"></a>02616             
<a name="l02617"></a>02617             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= matar[ dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a2a8fc9734898234863f4a432e05233ec">col</a>];
<a name="l02618"></a>02618             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>+<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>;
<a name="l02619"></a>02619             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a8455b7d194d33c1c0868c7bfe946189f">rt</a>;
<a name="l02620"></a>02620             
<a name="l02621"></a>02621             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02622"></a>02622             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02623"></a>02623             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02624"></a>02624             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02625"></a>02625             
<a name="l02626"></a>02626             p1++; p2++; p3++; p4++;
<a name="l02627"></a>02627         }
<a name="l02628"></a>02628     }   
<a name="l02629"></a>02629     <span class="comment">/* fix normals for U resp. V cyclic faces */</span>
<a name="l02630"></a>02630     sizeu--; sizev--;  <span class="comment">/* dec size for face array */</span>
<a name="l02631"></a>02631     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>) {
<a name="l02632"></a>02632         
<a name="l02633"></a>02633         <span class="keywordflow">for</span> (v = 0; v &lt; sizev; v++)
<a name="l02634"></a>02634         {
<a name="l02635"></a>02635             <span class="comment">/* optimize! :*/</span>
<a name="l02636"></a>02636             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(sizeu - 1, v));
<a name="l02637"></a>02637             vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(0, v));
<a name="l02638"></a>02638             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02639"></a>02639             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02640"></a>02640             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02641"></a>02641             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02642"></a>02642         }
<a name="l02643"></a>02643     }
<a name="l02644"></a>02644     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>) {
<a name="l02645"></a>02645         
<a name="l02646"></a>02646         <span class="keywordflow">for</span> (u = 0; u &lt; sizeu; u++)
<a name="l02647"></a>02647         {
<a name="l02648"></a>02648             <span class="comment">/* optimize! :*/</span>
<a name="l02649"></a>02649             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(u, 0));
<a name="l02650"></a>02650             vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(u, sizev-1));
<a name="l02651"></a>02651             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02652"></a>02652             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02653"></a>02653             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02654"></a>02654             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02655"></a>02655         }
<a name="l02656"></a>02656     }
<a name="l02657"></a>02657 
<a name="l02658"></a>02658     <span class="comment">/* last vertex is an extra case: </span>
<a name="l02659"></a>02659 <span class="comment">     *</span>
<a name="l02660"></a>02660 <span class="comment">     *     ^     ()----()----()----()</span>
<a name="l02661"></a>02661 <span class="comment">     *     |     |     |     ||     |</span>
<a name="l02662"></a>02662 <span class="comment">     *     u     |     |(0,n)||(0,0)|</span>
<a name="l02663"></a>02663 <span class="comment">     *     |     |     ||     |</span>
<a name="l02664"></a>02664 <span class="comment">     *     ()====()====[]====()</span>
<a name="l02665"></a>02665 <span class="comment">     *     |     |     ||     |</span>
<a name="l02666"></a>02666 <span class="comment">     *     |     |(m,n)||(m,0)|</span>
<a name="l02667"></a>02667 <span class="comment">     *     |     |     ||     |</span>
<a name="l02668"></a>02668 <span class="comment">     *     ()----()----()----()</span>
<a name="l02669"></a>02669 <span class="comment">     *     v -&gt;</span>
<a name="l02670"></a>02670 <span class="comment">     *  </span>
<a name="l02671"></a>02671 <span class="comment">     *  vertex [] is no longer shared, therefore distribute</span>
<a name="l02672"></a>02672 <span class="comment">     *  normals of the surrounding faces to all of the duplicates of []</span>
<a name="l02673"></a>02673 <span class="comment">     */</span>
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     <span class="keywordflow">if</span> ((dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>) &amp;&amp; (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>)) {
<a name="l02676"></a>02676         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(sizeu - 1, sizev - 1)); <span class="comment">/* (m,n) */</span>
<a name="l02677"></a>02677         vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(0,0));  <span class="comment">/* (0,0) */</span>
<a name="l02678"></a>02678         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(n1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02679"></a>02679         vlr2= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(0, sizev-1)); <span class="comment">/* (0,n) */</span>
<a name="l02680"></a>02680         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(n1, vlr2-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02681"></a>02681         vlr3= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../d2/d47/convertblender_8c.html#a06ebd260f03222d38bb3f324ea3c7489">UVTOINDEX</a>(sizeu-1, 0)); <span class="comment">/* (m,0) */</span>
<a name="l02682"></a>02682         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(n1, vlr3-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02683"></a>02683         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02684"></a>02684         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02685"></a>02685         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr2-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02686"></a>02686         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr3-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, n1);
<a name="l02687"></a>02687     }
<a name="l02688"></a>02688     <span class="keywordflow">for</span> (a = startvert; a &lt; obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l02689"></a>02689         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l02690"></a>02690         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02691"></a>02691     }
<a name="l02692"></a>02692     
<a name="l02693"></a>02693     
<a name="l02694"></a>02694     <span class="keywordflow">return</span> orcoret;
<a name="l02695"></a>02695 }
<a name="l02696"></a>02696 
<a name="l02697"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a56e4998055170753677d3767584ab30e">02697</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a56e4998055170753677d3767584ab30e">init_render_dm</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr,
<a name="l02698"></a>02698     <span class="keywordtype">int</span> timeoffset, <span class="keywordtype">float</span> *orco, <span class="keywordtype">float</span> mat[4][4])
<a name="l02699"></a>02699 {
<a name="l02700"></a>02700     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02701"></a>02701     <span class="keywordtype">int</span> <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, end, totvert, vertofs;
<a name="l02702"></a>02702     <span class="keywordtype">short</span> mat_iter;
<a name="l02703"></a>02703     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver;
<a name="l02704"></a>02704     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l02705"></a>02705     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02706"></a>02706     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l02707"></a>02707     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l02708"></a>02708     <span class="comment">/* Curve *cu= ELEM(ob-&gt;type, OB_FONT, OB_CURVE) ? ob-&gt;data : NULL; */</span>
<a name="l02709"></a>02709 
<a name="l02710"></a>02710     mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l02711"></a>02711     totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l02712"></a>02712 
<a name="l02713"></a>02713     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++, mvert++) {
<a name="l02714"></a>02714         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02715"></a>02715         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02716"></a>02716         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02717"></a>02717 
<a name="l02718"></a>02718         <span class="keywordflow">if</span> (orco) {
<a name="l02719"></a>02719             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco;
<a name="l02720"></a>02720             orco+=3;
<a name="l02721"></a>02721         }
<a name="l02722"></a>02722     }
<a name="l02723"></a>02723 
<a name="l02724"></a>02724     <span class="keywordflow">if</span> (!timeoffset) {
<a name="l02725"></a>02725         <span class="comment">/* store customdata names, because DerivedMesh is freed */</span>
<a name="l02726"></a>02726         <a class="code" href="../../d0/db6/renderdatabase_8h.html#a190f06eb5d3142831c818fc7955dcdd7">RE_set_customdata_names</a>(obr, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>);
<a name="l02727"></a>02727 
<a name="l02728"></a>02728         <span class="comment">/* still to do for keys: the correct local texture coordinate */</span>
<a name="l02729"></a>02729 
<a name="l02730"></a>02730         <span class="comment">/* faces in order of color blocks */</span>
<a name="l02731"></a>02731         vertofs= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a> - totvert;
<a name="l02732"></a>02732         <span class="keywordflow">for</span> (mat_iter= 0; (mat_iter &lt; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a> || (mat_iter==0 &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>==0)); mat_iter++) {
<a name="l02733"></a>02733 
<a name="l02734"></a>02734             ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, mat_iter+1);
<a name="l02735"></a>02735             end= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l02736"></a>02736             mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l02737"></a>02737 
<a name="l02738"></a>02738             <span class="keywordflow">for</span> (a=0; a&lt;end; a++, mface++) {
<a name="l02739"></a>02739                 <span class="keywordtype">int</span> v1, v2, v3, v4, flag;
<a name="l02740"></a>02740 
<a name="l02741"></a>02741                 <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> == mat_iter) {
<a name="l02742"></a>02742                     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02743"></a>02743 
<a name="l02744"></a>02744                     v1= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l02745"></a>02745                     v2= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l02746"></a>02746                     v3= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l02747"></a>02747                     v4= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l02748"></a>02748                     flag= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>;
<a name="l02749"></a>02749 
<a name="l02750"></a>02750                     vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l02751"></a>02751                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v1);
<a name="l02752"></a>02752                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v2);
<a name="l02753"></a>02753                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v3);
<a name="l02754"></a>02754                     <span class="keywordflow">if</span> (v4) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v4);
<a name="l02755"></a>02755                     <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= 0;
<a name="l02756"></a>02756 
<a name="l02757"></a>02757                     <span class="comment">/* render normals are inverted in render */</span>
<a name="l02758"></a>02758                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l02759"></a>02759                         len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02760"></a>02760                     <span class="keywordflow">else</span>
<a name="l02761"></a>02761                         len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02762"></a>02762 
<a name="l02763"></a>02763                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l02764"></a>02764                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= flag;
<a name="l02765"></a>02765                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= 0; <span class="comment">/* mesh edges rendered separately */</span>
<a name="l02766"></a>02766 
<a name="l02767"></a>02767                     <span class="keywordflow">if</span> (len==0) obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>--;
<a name="l02768"></a>02768                     <span class="keywordflow">else</span> {
<a name="l02769"></a>02769                         <a class="code" href="../../d5/d97/structCustomDataLayer.html">CustomDataLayer</a> *layer;
<a name="l02770"></a>02770                         <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface, *mtf;
<a name="l02771"></a>02771                         <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mcol, *mc;
<a name="l02772"></a>02772                         <span class="keywordtype">int</span> index, mtfn= 0, mcn= 0;
<a name="l02773"></a>02773                         <span class="keywordtype">char</span> *name;
<a name="l02774"></a>02774 
<a name="l02775"></a>02775                         <span class="keywordflow">for</span> (index=0; index&lt;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#ae5b4833527392742d84e8f7b46f5f264">totlayer</a>; index++) {
<a name="l02776"></a>02776                             layer= &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[index];
<a name="l02777"></a>02777                             name= layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#aa8ef26f614b5037233d4ba102e3286d8">name</a>;
<a name="l02778"></a>02778 
<a name="l02779"></a>02779                             <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a> &amp;&amp; mtfn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae22819cd79515b97f4f20edf7efcc762">MAX_MTFACE</a>) {
<a name="l02780"></a>02780                                 mtf= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, mtfn++, &amp;name, 1);
<a name="l02781"></a>02781                                 mtface= (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02782"></a>02782                                 *mtf= mtface[a];
<a name="l02783"></a>02783                             }
<a name="l02784"></a>02784                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a> &amp;&amp; mcn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5398e8b5970d1d384b30aa928068cebd">MAX_MCOL</a>) {
<a name="l02785"></a>02785                                 mc= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a9b31c14085f27f3fe35e7dd5f2546728">RE_vlakren_get_mcol</a>(obr, vlr, mcn++, &amp;name, 1);
<a name="l02786"></a>02786                                 mcol= (<a class="code" href="../../db/d33/structMCol.html">MCol</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02787"></a>02787                                 memcpy(mc, &amp;mcol[a*4], <span class="keyword">sizeof</span>(<a class="code" href="../../db/d33/structMCol.html">MCol</a>)*4);
<a name="l02788"></a>02788                             }
<a name="l02789"></a>02789                         }
<a name="l02790"></a>02790                     }
<a name="l02791"></a>02791                 }
<a name="l02792"></a>02792             }
<a name="l02793"></a>02793         }
<a name="l02794"></a>02794 
<a name="l02795"></a>02795         <span class="comment">/* Normals */</span>
<a name="l02796"></a>02796         <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(re, obr, 0, 0);
<a name="l02797"></a>02797     }
<a name="l02798"></a>02798 
<a name="l02799"></a>02799 }
<a name="l02800"></a>02800 
<a name="l02801"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a39a542087b3fed2aee3fbcbe27d49a25">02801</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a39a542087b3fed2aee3fbcbe27d49a25">init_render_surf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> timeoffset)
<a name="l02802"></a>02802 {
<a name="l02803"></a>02803     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02804"></a>02804     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu=0;
<a name="l02805"></a>02805     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu;
<a name="l02806"></a>02806     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> displist= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02807"></a>02807     <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl;
<a name="l02808"></a>02808     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> **matar;
<a name="l02809"></a>02809     <span class="keywordtype">float</span> *orco=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mat[4][4];
<a name="l02810"></a>02810     <span class="keywordtype">int</span> <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, totmat, need_orco=0;
<a name="l02811"></a>02811     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02812"></a>02812 
<a name="l02813"></a>02813     cu= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02814"></a>02814     nu= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02815"></a>02815     <span class="keywordflow">if</span> (nu==0) <span class="keywordflow">return</span>;
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02818"></a>02818     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l02819"></a>02819 
<a name="l02820"></a>02820     <span class="comment">/* material array */</span>
<a name="l02821"></a>02821     totmat= ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>+1;
<a name="l02822"></a>02822     matar= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a>*)*totmat, <span class="stringliteral">&quot;init_render_surf matar&quot;</span>);
<a name="l02823"></a>02823 
<a name="l02824"></a>02824     <span class="keywordflow">for</span> (a=0; a&lt;totmat; a++) {
<a name="l02825"></a>02825         matar[<a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>]= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, a+1);
<a name="l02826"></a>02826 
<a name="l02827"></a>02827         <span class="keywordflow">if</span> (matar[a] &amp;&amp; matar[a]-&gt;texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>)
<a name="l02828"></a>02828             need_orco= 1;
<a name="l02829"></a>02829     }
<a name="l02830"></a>02830 
<a name="l02831"></a>02831     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) need_orco= 1;
<a name="l02832"></a>02832 
<a name="l02833"></a>02833     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a59d434fe957439e304369a6bffd46e5d">makeDispListSurf</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, &amp;displist, &amp;dm, 1, 0);
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     <span class="keywordflow">if</span> (dm) {
<a name="l02836"></a>02836         <span class="keywordflow">if</span> (need_orco) {
<a name="l02837"></a>02837             orco= <a class="code" href="../../d9/d12/BKE__displist_8h.html#a940aad8fdfe14056944283d9449f0b13">makeOrcoDispList</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, dm, 1);
<a name="l02838"></a>02838             <span class="keywordflow">if</span> (orco) {
<a name="l02839"></a>02839                 <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(re, ob, orco);
<a name="l02840"></a>02840             }
<a name="l02841"></a>02841         }
<a name="l02842"></a>02842 
<a name="l02843"></a>02843         <a class="code" href="../../d2/d47/convertblender_8c.html#a56e4998055170753677d3767584ab30e">init_render_dm</a>(dm, re, obr, timeoffset, orco, mat);
<a name="l02844"></a>02844         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02845"></a>02845     }
<a name="l02846"></a>02846     <span class="keywordflow">else</span> {
<a name="l02847"></a>02847         <span class="keywordflow">if</span> (need_orco) {
<a name="l02848"></a>02848             orco= <a class="code" href="../../d2/d47/convertblender_8c.html#ad56296da8b74deccdcd514baf9a80df9">get_object_orco</a>(re, ob);
<a name="l02849"></a>02849         }
<a name="l02850"></a>02850 
<a name="l02851"></a>02851         <span class="comment">/* walk along displaylist and create rendervertices/-faces */</span>
<a name="l02852"></a>02852         <span class="keywordflow">for</span> (dl=displist.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dl; dl=dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a902acb76b3f3a2b20b0c9f755c652bf9">next</a>) {
<a name="l02853"></a>02853             <span class="comment">/* watch out: u ^= y, v ^= x !! */</span>
<a name="l02854"></a>02854             <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a14a8a66c424ba6ecb972e49847b61483">type</a>==<a class="code" href="../../d9/d12/BKE__displist_8h.html#aa264a2c12f3c058a0b62f7ea6dccbefa">DL_SURF</a>)
<a name="l02855"></a>02855                 orco+= 3*<a class="code" href="../../d2/d47/convertblender_8c.html#ab23111db5ac4cb4bd8e5faac51a880f1">dl_surf_to_renderdata</a>(obr, dl, matar, orco, mat);
<a name="l02856"></a>02856         }
<a name="l02857"></a>02857     }
<a name="l02858"></a>02858 
<a name="l02859"></a>02859     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;displist);
<a name="l02860"></a>02860 
<a name="l02861"></a>02861     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(matar);
<a name="l02862"></a>02862 }
<a name="l02863"></a>02863 
<a name="l02864"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aecb220b4d49e353cd53e4ca3d06e65ac">02864</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aecb220b4d49e353cd53e4ca3d06e65ac">init_render_curve</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> timeoffset)
<a name="l02865"></a>02865 {
<a name="l02866"></a>02866     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l02867"></a>02867     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu;
<a name="l02868"></a>02868     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver;
<a name="l02869"></a>02869     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l02870"></a>02870     <a class="code" href="../../d5/d2f/structDispList.html">DispList</a> *dl;
<a name="l02871"></a>02871     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02872"></a>02872     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> disp={<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02873"></a>02873     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> **matar;
<a name="l02874"></a>02874     <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, *fp, *orco=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02875"></a>02875     <span class="keywordtype">float</span> n[3], mat[4][4];
<a name="l02876"></a>02876     <span class="keywordtype">int</span> nr, startvert, <a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>, <a class="code" href="../../db/d33/structMCol.html#a0c1e111507e18eecd82a9add920295d0">b</a>;
<a name="l02877"></a>02877     <span class="keywordtype">int</span> need_orco=0, totmat;
<a name="l02878"></a>02878 
<a name="l02879"></a>02879     cu= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02880"></a>02880     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1a94162b6fc469957966a01d41ff71d6">OB_FONT</a> &amp;&amp; cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ab0b4dc5959c529381dbc6a954a8a39b6">str</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02881"></a>02881     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a> &amp;&amp; cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02882"></a>02882 
<a name="l02883"></a>02883     <a class="code" href="../../d9/d12/BKE__displist_8h.html#ad3c2aea8dfb62e81cb04fdfbfa5a51a3">makeDispListCurveTypes_forRender</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, &amp;disp, &amp;dm, 0);
<a name="l02884"></a>02884     dl= disp.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02885"></a>02885     <span class="keywordflow">if</span> (dl==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02886"></a>02886     
<a name="l02887"></a>02887     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02888"></a>02888     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l02889"></a>02889 
<a name="l02890"></a>02890     <span class="comment">/* material array */</span>
<a name="l02891"></a>02891     totmat= ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>+1;
<a name="l02892"></a>02892     matar= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a>*)*totmat, <span class="stringliteral">&quot;init_render_surf matar&quot;</span>);
<a name="l02893"></a>02893 
<a name="l02894"></a>02894     <span class="keywordflow">for</span> (a=0; a&lt;totmat; a++) {
<a name="l02895"></a>02895         matar[<a class="code" href="../../db/d33/structMCol.html#ae1f8644ca2b94cebaac551081fcc20e1">a</a>]= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, a+1);
<a name="l02896"></a>02896 
<a name="l02897"></a>02897         <span class="keywordflow">if</span> (matar[a] &amp;&amp; matar[a]-&gt;texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>)
<a name="l02898"></a>02898             need_orco= 1;
<a name="l02899"></a>02899     }
<a name="l02900"></a>02900 
<a name="l02901"></a>02901     <span class="keywordflow">if</span> (dm) {
<a name="l02902"></a>02902         <span class="keywordflow">if</span> (need_orco) {
<a name="l02903"></a>02903             orco= <a class="code" href="../../d9/d12/BKE__displist_8h.html#a940aad8fdfe14056944283d9449f0b13">makeOrcoDispList</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, dm, 1);
<a name="l02904"></a>02904             <span class="keywordflow">if</span> (orco) {
<a name="l02905"></a>02905                 <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(re, ob, orco);
<a name="l02906"></a>02906             }
<a name="l02907"></a>02907         }
<a name="l02908"></a>02908 
<a name="l02909"></a>02909         <a class="code" href="../../d2/d47/convertblender_8c.html#a56e4998055170753677d3767584ab30e">init_render_dm</a>(dm, re, obr, timeoffset, orco, mat);
<a name="l02910"></a>02910         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02911"></a>02911     }
<a name="l02912"></a>02912     <span class="keywordflow">else</span> {
<a name="l02913"></a>02913         <span class="keywordflow">if</span> (need_orco) {
<a name="l02914"></a>02914           orco= <a class="code" href="../../d2/d47/convertblender_8c.html#ad56296da8b74deccdcd514baf9a80df9">get_object_orco</a>(re, ob);
<a name="l02915"></a>02915         }
<a name="l02916"></a>02916 
<a name="l02917"></a>02917         <span class="keywordflow">while</span> (dl) {
<a name="l02918"></a>02918             <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a2a8fc9734898234863f4a432e05233ec">col</a> &gt; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>) {
<a name="l02919"></a>02919                 <span class="comment">/* pass */</span>
<a name="l02920"></a>02920             }
<a name="l02921"></a>02921             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a14a8a66c424ba6ecb972e49847b61483">type</a>==<a class="code" href="../../d9/d12/BKE__displist_8h.html#a8fdfde765231c4dfbe1df3f263abdd02">DL_INDEX3</a>) {
<a name="l02922"></a>02922                 <span class="keywordtype">int</span> *index;
<a name="l02923"></a>02923 
<a name="l02924"></a>02924                 startvert= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l02925"></a>02925                 data= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>;
<a name="l02926"></a>02926 
<a name="l02927"></a>02927                 <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>; a++, data+=3) {
<a name="l02928"></a>02928                     ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02929"></a>02929                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, data);
<a name="l02930"></a>02930 
<a name="l02931"></a>02931                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02932"></a>02932 
<a name="l02933"></a>02933                     <span class="keywordflow">if</span> (orco) {
<a name="l02934"></a>02934                         ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a> = orco;
<a name="l02935"></a>02935                         orco += 3;
<a name="l02936"></a>02936                     }
<a name="l02937"></a>02937                 }
<a name="l02938"></a>02938 
<a name="l02939"></a>02939                 <span class="keywordflow">if</span> (timeoffset==0) {
<a name="l02940"></a>02940                     <span class="keywordtype">float</span> tmp[3];
<a name="l02941"></a>02941                     <span class="keyword">const</span> <span class="keywordtype">int</span> startvlak= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l02942"></a>02942 
<a name="l02943"></a>02943                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(n);
<a name="l02944"></a>02944                     index= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a6c3c9ad7f71c3ee1a79e23af0c6cef42">index</a>;
<a name="l02945"></a>02945                     <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>; a++, index+=3) {
<a name="l02946"></a>02946                         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l02947"></a>02947                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, startvert+index[0]);
<a name="l02948"></a>02948                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, startvert+index[1]);
<a name="l02949"></a>02949                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, startvert+index[2]);
<a name="l02950"></a>02950                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02951"></a>02951 
<a name="l02952"></a>02952                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>)&gt;FLT_EPSILON) {
<a name="l02953"></a>02953                             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(tmp, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02954"></a>02954                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(n, tmp);
<a name="l02955"></a>02955                         }
<a name="l02956"></a>02956 
<a name="l02957"></a>02957                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= matar[ dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a2a8fc9734898234863f4a432e05233ec">col</a> ];
<a name="l02958"></a>02958                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= 0;
<a name="l02959"></a>02959                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= 0;
<a name="l02960"></a>02960                     }
<a name="l02961"></a>02961 
<a name="l02962"></a>02962                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l02963"></a>02963 
<a name="l02964"></a>02964                     <span class="comment">/* vertex normals */</span>
<a name="l02965"></a>02965                     <span class="keywordflow">for</span> (a= startvlak; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l02966"></a>02966                         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l02967"></a>02967 
<a name="l02968"></a>02968                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, n);
<a name="l02969"></a>02969                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02970"></a>02970                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02971"></a>02971                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l02972"></a>02972                     }
<a name="l02973"></a>02973                     <span class="keywordflow">for</span> (a=startvert; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l02974"></a>02974                         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l02975"></a>02975                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l02976"></a>02976                     }
<a name="l02977"></a>02977                 }
<a name="l02978"></a>02978             }
<a name="l02979"></a>02979             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a14a8a66c424ba6ecb972e49847b61483">type</a>==<a class="code" href="../../d9/d12/BKE__displist_8h.html#aa264a2c12f3c058a0b62f7ea6dccbefa">DL_SURF</a>) {
<a name="l02980"></a>02980 
<a name="l02981"></a>02981                 <span class="comment">/* cyclic U means an extruded full circular curve, we skip bevel splitting then */</span>
<a name="l02982"></a>02982                 <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a> &amp; <a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>) {
<a name="l02983"></a>02983                     orco+= 3*<a class="code" href="../../d2/d47/convertblender_8c.html#ab23111db5ac4cb4bd8e5faac51a880f1">dl_surf_to_renderdata</a>(obr, dl, matar, orco, mat);
<a name="l02984"></a>02984                 }
<a name="l02985"></a>02985                 <span class="keywordflow">else</span> {
<a name="l02986"></a>02986                     <span class="keywordtype">int</span> p1,p2,p3,p4;
<a name="l02987"></a>02987 
<a name="l02988"></a>02988                     fp= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a43f6598aca5bb0f893aa32f09e1b9b07">verts</a>;
<a name="l02989"></a>02989                     startvert= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l02990"></a>02990                     nr= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>*dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>;
<a name="l02991"></a>02991 
<a name="l02992"></a>02992                     <span class="keywordflow">while</span> (nr--) {
<a name="l02993"></a>02993                         ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l02994"></a>02994 
<a name="l02995"></a>02995                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, fp);
<a name="l02996"></a>02996                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02997"></a>02997                         fp+= 3;
<a name="l02998"></a>02998 
<a name="l02999"></a>02999                         <span class="keywordflow">if</span> (orco) {
<a name="l03000"></a>03000                             ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a> = orco;
<a name="l03001"></a>03001                             orco += 3;
<a name="l03002"></a>03002                         }
<a name="l03003"></a>03003                     }
<a name="l03004"></a>03004 
<a name="l03005"></a>03005                     <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#aeeaa3a8867a77154d94dd3461c8aaa13">bevelSplitFlag</a> || timeoffset==0) {
<a name="l03006"></a>03006                         <span class="keyword">const</span> <span class="keywordtype">int</span> startvlak= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l03007"></a>03007 
<a name="l03008"></a>03008                         <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>; a++) {
<a name="l03009"></a>03009 
<a name="l03010"></a>03010                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d12/BKE__displist_8h.html#ab219170b18bed3bb6089d1116f784023">surfindex_displist</a>(dl, a, &amp;b, &amp;p1, &amp;p2, &amp;p3, &amp;p4)==0)
<a name="l03011"></a>03011                                 <span class="keywordflow">break</span>;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013                             p1+= startvert;
<a name="l03014"></a>03014                             p2+= startvert;
<a name="l03015"></a>03015                             p3+= startvert;
<a name="l03016"></a>03016                             p4+= startvert;
<a name="l03017"></a>03017 
<a name="l03018"></a>03018                             <span class="keywordflow">for</span> (; b&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>; b++) {
<a name="l03019"></a>03019                                 vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l03020"></a>03020                                 <span class="comment">/* important 1 offset in order is kept [#24913] */</span>
<a name="l03021"></a>03021                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p2);
<a name="l03022"></a>03022                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p1);
<a name="l03023"></a>03023                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p3);
<a name="l03024"></a>03024                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, p4);
<a name="l03025"></a>03025                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>+<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#ab3e2f26d87fb0176c50cf219942ba4dc">ME_V3V4</a>;
<a name="l03026"></a>03026                                 <span class="keywordflow">if</span> (a==0) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>+= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>;
<a name="l03027"></a>03027 
<a name="l03028"></a>03028                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a8455b7d194d33c1c0868c7bfe946189f">rt</a>;
<a name="l03029"></a>03029 
<a name="l03030"></a>03030                                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l03031"></a>03031                                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= matar[ dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a2a8fc9734898234863f4a432e05233ec">col</a> ];
<a name="l03032"></a>03032 
<a name="l03033"></a>03033                                 p4= p3;
<a name="l03034"></a>03034                                 p3++;
<a name="l03035"></a>03035                                 p2= p1;
<a name="l03036"></a>03036                                 p1++;
<a name="l03037"></a>03037                             }
<a name="l03038"></a>03038                         }
<a name="l03039"></a>03039 
<a name="l03040"></a>03040                         <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#aeeaa3a8867a77154d94dd3461c8aaa13">bevelSplitFlag</a>) {
<a name="l03041"></a>03041                             <span class="keywordflow">for</span> (a=0; a&lt;dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>-1+!!(dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a>&amp;<a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>); a++)
<a name="l03042"></a>03042                                 <span class="keywordflow">if</span> (dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#aeeaa3a8867a77154d94dd3461c8aaa13">bevelSplitFlag</a>[a&gt;&gt;5]&amp;(1&lt;&lt;(a&amp;0x1F)))
<a name="l03043"></a>03043                                     <a class="code" href="../../d2/d47/convertblender_8c.html#ab2cfee3d472b1bc4eab095d976a49c97">split_v_renderfaces</a>(obr, startvlak, startvert, dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a90540d3d4399d33b9dbdb9c03ab403f0">parts</a>, dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a0943092aadac633bbdd4c566e6956538">nr</a>, a, dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a>&amp;<a class="code" href="../../d9/d12/BKE__displist_8h.html#ac44be4fcc9a60be5fc4dc0074cee889c">DL_CYCL_V</a>, dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#ab71643e664ff559f5e798fc7fc4cfe55">flag</a>&amp;<a class="code" href="../../d9/d12/BKE__displist_8h.html#aa455c760328fd01bc0e18aa819f4bb10">DL_CYCL_U</a>);
<a name="l03044"></a>03044                         }
<a name="l03045"></a>03045 
<a name="l03046"></a>03046                         <span class="comment">/* vertex normals */</span>
<a name="l03047"></a>03047                         <span class="keywordflow">for</span> (a= startvlak; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l03048"></a>03048                             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l03049"></a>03049 
<a name="l03050"></a>03050                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l03051"></a>03051                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l03052"></a>03052                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l03053"></a>03053                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l03054"></a>03054                         }
<a name="l03055"></a>03055                         <span class="keywordflow">for</span> (a=startvert; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l03056"></a>03056                             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l03057"></a>03057                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l03058"></a>03058                         }
<a name="l03059"></a>03059                     }
<a name="l03060"></a>03060                 }
<a name="l03061"></a>03061             }
<a name="l03062"></a>03062 
<a name="l03063"></a>03063             dl= dl-&gt;<a class="code" href="../../d5/d2f/structDispList.html#a902acb76b3f3a2b20b0c9f755c652bf9">next</a>;
<a name="l03064"></a>03064         }
<a name="l03065"></a>03065     }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;disp);
<a name="l03068"></a>03068 
<a name="l03069"></a>03069     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(matar);
<a name="l03070"></a>03070 }
<a name="l03071"></a>03071 
<a name="l03072"></a>03072 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03073"></a>03073 <span class="comment">/* Mesh                                                                      */</span>
<a name="l03074"></a>03074 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03075"></a>03075 
<a name="l03076"></a>03076 <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> {
<a name="l03077"></a>03077     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a>, <a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a>;
<a name="l03078"></a><a class="code" href="../../d1/d1a/structedgesort.html#aa855b1d6c1f4a24ccdf648e911bd1fbb">03078</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d1a/structedgesort.html#aa855b1d6c1f4a24ccdf648e911bd1fbb">f</a>;
<a name="l03079"></a><a class="code" href="../../d1/d1a/structedgesort.html#a88b2cc81356a38c5aa630c098ed7724b">03079</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d1a/structedgesort.html#a923febea5ec849088003697065b75115">i1</a>, <a class="code" href="../../d1/d1a/structedgesort.html#a88b2cc81356a38c5aa630c098ed7724b">i2</a>;
<a name="l03080"></a>03080 };
<a name="l03081"></a>03081 
<a name="l03082"></a>03082 <span class="comment">/* edges have to be added with lowest index first for sorting */</span>
<a name="l03083"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">03083</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *ed,
<a name="l03084"></a>03084                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i2,
<a name="l03085"></a>03085                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> v1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> f)
<a name="l03086"></a>03086 {
<a name="l03087"></a>03087     <span class="keywordflow">if</span> (v1 &gt; v2) {
<a name="l03088"></a>03088         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, v1, v2);
<a name="l03089"></a>03089         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, i1, i2);
<a name="l03090"></a>03090     }
<a name="l03091"></a>03091 
<a name="l03092"></a>03092     ed-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a>= v1;
<a name="l03093"></a>03093     ed-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a>= v2;
<a name="l03094"></a>03094     ed-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a923febea5ec849088003697065b75115">i1</a>= i1;
<a name="l03095"></a>03095     ed-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a88b2cc81356a38c5aa630c098ed7724b">i2</a>= i2;
<a name="l03096"></a>03096     ed-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#aa855b1d6c1f4a24ccdf648e911bd1fbb">f</a> = f;
<a name="l03097"></a>03097 }
<a name="l03098"></a>03098 
<a name="l03099"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a4a5c70322e76b6f17e60810362ee17fc">03099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a4a5c70322e76b6f17e60810362ee17fc">vergedgesort</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *v1, <span class="keyword">const</span> <span class="keywordtype">void</span> *v2)
<a name="l03100"></a>03100 {
<a name="l03101"></a>03101     <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *x1=<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a>, *x2=<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a>;
<a name="l03102"></a>03102 
<a name="l03103"></a>03103     <span class="keywordflow">if</span> ( x1-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a> &gt; x2-&gt;v1) <span class="keywordflow">return</span> 1;
<a name="l03104"></a>03104     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( x1-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a> &lt; x2-&gt;v1) <span class="keywordflow">return</span> -1;
<a name="l03105"></a>03105     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( x1-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a> &gt; x2-&gt;v2) <span class="keywordflow">return</span> 1;
<a name="l03106"></a>03106     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( x1-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a> &lt; x2-&gt;v2) <span class="keywordflow">return</span> -1;
<a name="l03107"></a>03107 
<a name="l03108"></a>03108     <span class="keywordflow">return</span> 0;
<a name="l03109"></a>03109 }
<a name="l03110"></a>03110 
<a name="l03111"></a><a class="code" href="../../d2/d47/convertblender_8c.html#afd493bc08c80e43a4e99937466037e96">03111</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#afd493bc08c80e43a4e99937466037e96">make_mesh_edge_lookup</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> *totedgesort)
<a name="l03112"></a>03112 {
<a name="l03113"></a>03113     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf, *mface;
<a name="l03114"></a>03114     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03115"></a>03115     <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *edsort, *ed;
<a name="l03116"></a>03116     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *mcol=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03117"></a>03117     <span class="keywordtype">int</span> a, totedge=0, totface;
<a name="l03118"></a>03118 
<a name="l03119"></a>03119     mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l03120"></a>03120     totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l03121"></a>03121     tface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l03122"></a>03122     mcol= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>);
<a name="l03123"></a>03123 
<a name="l03124"></a>03124     <span class="keywordflow">if</span> (mcol==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; tface==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03125"></a>03125 
<a name="l03126"></a>03126     <span class="comment">/* make sorted table with edges and face indices in it */</span>
<a name="l03127"></a>03127     <span class="keywordflow">for</span> (a= totface, mf= mface; a&gt;0; a--, mf++) {
<a name="l03128"></a>03128         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) totedge+=4;
<a name="l03129"></a>03129         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>) totedge+=3;
<a name="l03130"></a>03130     }
<a name="l03131"></a>03131 
<a name="l03132"></a>03132     <span class="keywordflow">if</span> (totedge==0)
<a name="l03133"></a>03133         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03134"></a>03134 
<a name="l03135"></a>03135     ed= edsort= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totedge*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a>), <span class="stringliteral">&quot;edgesort&quot;</span>);
<a name="l03136"></a>03136 
<a name="l03137"></a>03137     <span class="keywordflow">for</span> (a=0, mf=mface; a&lt;totface; a++, mf++) {
<a name="l03138"></a>03138         <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(ed++, 0, 1, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, a);
<a name="l03139"></a>03139         <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(ed++, 1, 2, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, a);
<a name="l03140"></a>03140         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l03141"></a>03141             <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(ed++, 2, 3, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, a);
<a name="l03142"></a>03142             <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(ed++, 3, 0, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, a);
<a name="l03143"></a>03143         }
<a name="l03144"></a>03144         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>)
<a name="l03145"></a>03145             <a class="code" href="../../d2/d47/convertblender_8c.html#a3fa38365a6a9480f93a79bc9c03a393a">to_edgesort</a>(ed++, 2, 3, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, a);
<a name="l03146"></a>03146     }
<a name="l03147"></a>03147 
<a name="l03148"></a>03148     qsort(edsort, totedge, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a>), <a class="code" href="../../d2/d47/convertblender_8c.html#a4a5c70322e76b6f17e60810362ee17fc">vergedgesort</a>);
<a name="l03149"></a>03149 
<a name="l03150"></a>03150     *totedgesort= totedge;
<a name="l03151"></a>03151 
<a name="l03152"></a>03152     <span class="keywordflow">return</span> edsort;
<a name="l03153"></a>03153 }
<a name="l03154"></a>03154 
<a name="l03155"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a933d223003e170d3edaa5f6a159b4760">03155</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a933d223003e170d3edaa5f6a159b4760">use_mesh_edge_lookup</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keyword">struct</span> <a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *edgetable, <span class="keywordtype">int</span> totedge)
<a name="l03156"></a>03156 {
<a name="l03157"></a>03157     <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> ed, *edp;
<a name="l03158"></a>03158     <a class="code" href="../../d5/d97/structCustomDataLayer.html">CustomDataLayer</a> *layer;
<a name="l03159"></a>03159     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface, *mtf;
<a name="l03160"></a>03160     <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mcol, *mc;
<a name="l03161"></a>03161     <span class="keywordtype">int</span> index, mtfn, mcn;
<a name="l03162"></a>03162     <span class="keywordtype">char</span> *name;
<a name="l03163"></a>03163 
<a name="l03164"></a>03164     <span class="keywordflow">if</span> (medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a> &lt; medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>) {
<a name="l03165"></a>03165         ed.<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>;
<a name="l03166"></a>03166         ed.<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>;
<a name="l03167"></a>03167     }
<a name="l03168"></a>03168     <span class="keywordflow">else</span> {
<a name="l03169"></a>03169         ed.<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>;
<a name="l03170"></a>03170         ed.<a class="code" href="../../d1/d1a/structedgesort.html#a5992cdb3351ff802f632db2fe08020cd">v2</a>= medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>;
<a name="l03171"></a>03171     }
<a name="l03172"></a>03172 
<a name="l03173"></a>03173     edp= bsearch(&amp;ed, edgetable, totedge, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a>), <a class="code" href="../../d2/d47/convertblender_8c.html#a4a5c70322e76b6f17e60810362ee17fc">vergedgesort</a>);
<a name="l03174"></a>03174 
<a name="l03175"></a>03175     <span class="comment">/* since edges have different index ordering, we have to duplicate mcol and tface */</span>
<a name="l03176"></a>03176     <span class="keywordflow">if</span> (edp) {
<a name="l03177"></a>03177         mtfn= mcn= 0;
<a name="l03178"></a>03178 
<a name="l03179"></a>03179         <span class="keywordflow">for</span> (index=0; index&lt;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#ae5b4833527392742d84e8f7b46f5f264">totlayer</a>; index++) {
<a name="l03180"></a>03180             layer= &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[index];
<a name="l03181"></a>03181             name= layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#aa8ef26f614b5037233d4ba102e3286d8">name</a>;
<a name="l03182"></a>03182 
<a name="l03183"></a>03183             <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a> &amp;&amp; mtfn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae22819cd79515b97f4f20edf7efcc762">MAX_MTFACE</a>) {
<a name="l03184"></a>03184                 mtface= &amp;((<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>)[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#aa855b1d6c1f4a24ccdf648e911bd1fbb">f</a>];
<a name="l03185"></a>03185                 mtf= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, mtfn++, &amp;name, 1);
<a name="l03186"></a>03186 
<a name="l03187"></a>03187                 *mtf= *mtface;
<a name="l03188"></a>03188 
<a name="l03189"></a>03189                 memcpy(mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0], mtface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a923febea5ec849088003697065b75115">i1</a>], <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*2);
<a name="l03190"></a>03190                 memcpy(mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1], mtface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a88b2cc81356a38c5aa630c098ed7724b">i2</a>], <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*2);
<a name="l03191"></a>03191                 memcpy(mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2], mtface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1], <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*2);
<a name="l03192"></a>03192                 memcpy(mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3], mtface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1], <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*2);
<a name="l03193"></a>03193             }
<a name="l03194"></a>03194             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a> &amp;&amp; mcn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5398e8b5970d1d384b30aa928068cebd">MAX_MCOL</a>) {
<a name="l03195"></a>03195                 mcol= &amp;((<a class="code" href="../../db/d33/structMCol.html">MCol</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>)[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#aa855b1d6c1f4a24ccdf648e911bd1fbb">f</a>*4];
<a name="l03196"></a>03196                 mc= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a9b31c14085f27f3fe35e7dd5f2546728">RE_vlakren_get_mcol</a>(obr, vlr, mcn++, &amp;name, 1);
<a name="l03197"></a>03197 
<a name="l03198"></a>03198                 mc[0]= mcol[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a923febea5ec849088003697065b75115">i1</a>];
<a name="l03199"></a>03199                 mc[1]= mc[2]= mc[3]= mcol[edp-&gt;<a class="code" href="../../d1/d1a/structedgesort.html#a88b2cc81356a38c5aa630c098ed7724b">i2</a>];
<a name="l03200"></a>03200             }
<a name="l03201"></a>03201         }
<a name="l03202"></a>03202     }
<a name="l03203"></a>03203 }
<a name="l03204"></a>03204 
<a name="l03205"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a1c9718caa2b6e9b4e152fb9e2a67ce2e">03205</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a1c9718caa2b6e9b4e152fb9e2a67ce2e">free_camera_inside_volumes</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l03206"></a>03206 {
<a name="l03207"></a>03207     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a2e923c6ef624c4bea759df7237da69fd">render_volumes_inside</a>);
<a name="l03208"></a>03208 }
<a name="l03209"></a>03209 
<a name="l03210"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a41d06c1202cfca1920e76633e8d8b222">03210</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a41d06c1202cfca1920e76633e8d8b222">init_camera_inside_volumes</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l03211"></a>03211 {
<a name="l03212"></a>03212     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l03213"></a>03213     <a class="code" href="../../db/d05/structVolumeOb.html">VolumeOb</a> *vo;
<a name="l03214"></a>03214     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3] = {0.f, 0.f, 0.f};
<a name="l03215"></a>03215 
<a name="l03216"></a>03216     <span class="keywordflow">for</span> (vo= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aebc1bbfbdfcd4e0679283cde867622bf">volumes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; vo; vo= vo-&gt;<a class="code" href="../../db/d05/structVolumeOb.html#a43bfea2f7899fabf72b980486843651b">next</a>) {
<a name="l03217"></a>03217         <span class="keywordflow">for</span> (obi= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l03218"></a>03218             <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a> == vo-&gt;<a class="code" href="../../db/d05/structVolumeOb.html#a87012958d18785b67480913d1dce2826">obr</a>) {
<a name="l03219"></a>03219                 <span class="keywordflow">if</span> (<a class="code" href="../../dd/d62/volume__precache_8h.html#aac0c0671167ab053980a1f1f457d223c">point_inside_volume_objectinstance</a>(re, obi, co)) {
<a name="l03220"></a>03220                     <a class="code" href="../../d8/db1/structMatInside.html">MatInside</a> *mi;
<a name="l03221"></a>03221 
<a name="l03222"></a>03222                     mi = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/db1/structMatInside.html">MatInside</a>), <span class="stringliteral">&quot;camera inside material&quot;</span>);
<a name="l03223"></a>03223                     mi-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a28ab970c778d8554c0d18d03982b38bf">ma</a> = vo-&gt;<a class="code" href="../../db/d05/structVolumeOb.html#ad9358af605e49ce2baf61d7fc1925818">ma</a>;
<a name="l03224"></a>03224                     mi-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a9e7b1dfcf879010389704c0a7b8926a7">obi</a> = obi;
<a name="l03225"></a>03225 
<a name="l03226"></a>03226                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a2e923c6ef624c4bea759df7237da69fd">render_volumes_inside</a>), mi);
<a name="l03227"></a>03227                 }
<a name="l03228"></a>03228             }
<a name="l03229"></a>03229         }
<a name="l03230"></a>03230     }
<a name="l03231"></a>03231 
<a name="l03232"></a>03232     <span class="comment">/* debug {</span>
<a name="l03233"></a>03233 <span class="comment">    MatInside *m;</span>
<a name="l03234"></a>03234 <span class="comment">    for (m=re-&gt;render_volumes_inside.first; m; m=m-&gt;next) {</span>
<a name="l03235"></a>03235 <span class="comment">        printf(&quot;matinside: ma: %s\n&quot;, m-&gt;ma-&gt;id.name+2);</span>
<a name="l03236"></a>03236 <span class="comment">    }</span>
<a name="l03237"></a>03237 <span class="comment">    }*/</span>
<a name="l03238"></a>03238 }
<a name="l03239"></a>03239 
<a name="l03240"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a96bb94d8202b999446003a7213674c3f">03240</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a96bb94d8202b999446003a7213674c3f">add_volume</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma)
<a name="l03241"></a>03241 {
<a name="l03242"></a>03242     <span class="keyword">struct </span><a class="code" href="../../db/d05/structVolumeOb.html">VolumeOb</a> *vo;
<a name="l03243"></a>03243 
<a name="l03244"></a>03244     vo = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d05/structVolumeOb.html">VolumeOb</a>), <span class="stringliteral">&quot;volume object&quot;</span>);
<a name="l03245"></a>03245 
<a name="l03246"></a>03246     vo-&gt;<a class="code" href="../../db/d05/structVolumeOb.html#ad9358af605e49ce2baf61d7fc1925818">ma</a> = <a class="code" href="../../db/d05/structVolumeOb.html#ad9358af605e49ce2baf61d7fc1925818">ma</a>;
<a name="l03247"></a>03247     vo-&gt;<a class="code" href="../../db/d05/structVolumeOb.html#a87012958d18785b67480913d1dce2826">obr</a> = <a class="code" href="../../db/d05/structVolumeOb.html#a87012958d18785b67480913d1dce2826">obr</a>;
<a name="l03248"></a>03248 
<a name="l03249"></a>03249     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aebc1bbfbdfcd4e0679283cde867622bf">volumes</a>, vo);
<a name="l03250"></a>03250 }
<a name="l03251"></a>03251 
<a name="l03252"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ae8d18d77515c50e29ab388166d065a57">03252</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ae8d18d77515c50e29ab388166d065a57">init_render_mesh</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> timeoffset)
<a name="l03253"></a>03253 {
<a name="l03254"></a>03254     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l03255"></a>03255     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l03256"></a>03256     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03257"></a>03257     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l03258"></a>03258     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr; <span class="comment">//, *vlr1;</span>
<a name="l03259"></a>03259     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver;
<a name="l03260"></a>03260     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *<a class="code" href="../../db/d05/structVolumeOb.html#ad9358af605e49ce2baf61d7fc1925818">ma</a>;
<a name="l03261"></a>03261     <a class="code" href="../../da/d0c/structMSticky.html">MSticky</a> *ms = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03262"></a>03262     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l03263"></a>03263     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask;
<a name="l03264"></a>03264     <span class="keywordtype">float</span> xn, yn, zn,  imat[3][3], mat[4][4];  <span class="comment">//nor[3],</span>
<a name="l03265"></a>03265     <span class="keywordtype">float</span> *orco=0;
<a name="l03266"></a>03266     <span class="keywordtype">int</span> need_orco=0, need_stress=0, need_nmap_tangent=0, need_tangent=0;
<a name="l03267"></a>03267     <span class="keywordtype">int</span> a, a1, ok, vertofs;
<a name="l03268"></a>03268     <span class="keywordtype">int</span> end, do_autosmooth=0, totvert = 0;
<a name="l03269"></a>03269     <span class="keywordtype">int</span> use_original_normals= 0;
<a name="l03270"></a>03270     <span class="keywordtype">int</span> recalc_normals = 0; <span class="comment">// false by default</span>
<a name="l03271"></a>03271     <span class="keywordtype">int</span> negative_scale;
<a name="l03272"></a>03272 
<a name="l03273"></a>03273     me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03274"></a>03274 
<a name="l03275"></a>03275     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03276"></a>03276     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l03277"></a>03277     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l03278"></a>03278     negative_scale= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6f80f6c6c2dfac5c69d2a27d06d18c23">is_negative_m4</a>(mat);
<a name="l03279"></a>03279 
<a name="l03280"></a>03280     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>==0)
<a name="l03281"></a>03281         <span class="keywordflow">return</span>;
<a name="l03282"></a>03282     
<a name="l03283"></a>03283     need_orco= 0;
<a name="l03284"></a>03284     <span class="keywordflow">for</span> (a=1; a&lt;=ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; a++) {
<a name="l03285"></a>03285         ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, a);
<a name="l03286"></a>03286         <span class="keywordflow">if</span> (ma) {
<a name="l03287"></a>03287             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>|<a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8f7e277845f209165fd27712f95e3fc">TEXCO_STRESS</a>))
<a name="l03288"></a>03288                 need_orco= 1;
<a name="l03289"></a>03289             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8f7e277845f209165fd27712f95e3fc">TEXCO_STRESS</a>)
<a name="l03290"></a>03290                 need_stress= 1;
<a name="l03291"></a>03291             <span class="comment">/* normalmaps, test if tangents needed, separated from shading */</span>
<a name="l03292"></a>03292             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>) {
<a name="l03293"></a>03293                 need_tangent= 1;
<a name="l03294"></a>03294                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03295"></a>03295                     need_orco= 1;
<a name="l03296"></a>03296             }
<a name="l03297"></a>03297             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a23811367ed4f7b32bdc698978b1fadeb">mode_l</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a926ad275bf090eaa4b418b89449236a8">MA_NORMAP_TANG</a>) {
<a name="l03298"></a>03298                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03299"></a>03299                     need_orco= 1;
<a name="l03300"></a>03300                     need_tangent= 1;
<a name="l03301"></a>03301                 }
<a name="l03302"></a>03302                 need_nmap_tangent= 1;
<a name="l03303"></a>03303             }
<a name="l03304"></a>03304         }
<a name="l03305"></a>03305     }
<a name="l03306"></a>03306 
<a name="l03307"></a>03307     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a15936453588e2fe16ea23308b846b267">R_NEED_TANGENT</a>) {
<a name="l03308"></a>03308         <span class="comment">/* exception for tangent space baking */</span>
<a name="l03309"></a>03309         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03310"></a>03310             need_orco= 1;
<a name="l03311"></a>03311             need_tangent= 1;
<a name="l03312"></a>03312         }
<a name="l03313"></a>03313         need_nmap_tangent= 1;
<a name="l03314"></a>03314     }
<a name="l03315"></a>03315     
<a name="l03316"></a>03316     <span class="comment">/* check autosmooth and displacement, we then have to skip only-verts optimize */</span>
<a name="l03317"></a>03317     do_autosmooth |= (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a941cdd9a07c81485677efb6b444eb8ad">flag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#aa4493bee2b08682f95236d4fe2cf2539">ME_AUTOSMOOTH</a>);
<a name="l03318"></a>03318     <span class="keywordflow">if</span> (do_autosmooth)
<a name="l03319"></a>03319         timeoffset= 0;
<a name="l03320"></a>03320     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#afc4a5bc2d6b4770f1d4c077f75a246a4">test_for_displace</a>(re, ob ) )
<a name="l03321"></a>03321         timeoffset= 0;
<a name="l03322"></a>03322     
<a name="l03323"></a>03323     mask= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>;
<a name="l03324"></a>03324     <span class="keywordflow">if</span> (!timeoffset)
<a name="l03325"></a>03325         <span class="keywordflow">if</span> (need_orco)
<a name="l03326"></a>03326             mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>;
<a name="l03327"></a>03327 
<a name="l03328"></a>03328     dm= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aeade9a199706a910fa3a5593b49cdbdf">mesh_create_derived_render</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, mask);
<a name="l03329"></a>03329     <span class="keywordflow">if</span> (dm==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;   <span class="comment">/* in case duplicated object fails? */</span>
<a name="l03330"></a>03330 
<a name="l03331"></a>03331     <span class="keywordflow">if</span> (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>) {
<a name="l03332"></a>03332         orco= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l03333"></a>03333         <span class="keywordflow">if</span> (orco) {
<a name="l03334"></a>03334             orco= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(orco);
<a name="l03335"></a>03335             <a class="code" href="../../d2/d47/convertblender_8c.html#aec3a23ea314d5e6fae4d0ce56f9d2d06">set_object_orco</a>(re, ob, orco);
<a name="l03336"></a>03336         }
<a name="l03337"></a>03337     }
<a name="l03338"></a>03338 
<a name="l03339"></a>03339     mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l03340"></a>03340     totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l03341"></a>03341 
<a name="l03342"></a>03342     <span class="comment">/* attempt to autsmooth on original mesh, only without subsurf */</span>
<a name="l03343"></a>03343     <span class="keywordflow">if</span> (do_autosmooth &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>==totvert &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>==dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm))
<a name="l03344"></a>03344         use_original_normals= 1;
<a name="l03345"></a>03345     
<a name="l03346"></a>03346     ms = (totvert==me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>)?me-&gt;<a class="code" href="../../da/d29/structMesh.html#a79dc3a13e37ce76df15ae04453a1f58d">msticky</a>:<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03347"></a>03347     
<a name="l03348"></a>03348     ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, 1);
<a name="l03349"></a>03349 
<a name="l03350"></a>03350 
<a name="l03351"></a>03351     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a263f8a32d8cbe3456366b40cb01deab1">MA_TYPE_HALO</a>) {
<a name="l03352"></a>03352         <a class="code" href="../../d2/d47/convertblender_8c.html#ad5c7cf8020467481d762b13f91ab7f48">make_render_halos</a>(re, obr, me, totvert, mvert, ma, orco);
<a name="l03353"></a>03353     }
<a name="l03354"></a>03354     <span class="keywordflow">else</span> {
<a name="l03355"></a>03355 
<a name="l03356"></a>03356         <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++, mvert++) {
<a name="l03357"></a>03357             ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>++);
<a name="l03358"></a>03358             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03359"></a>03359             <span class="keywordflow">if</span> (do_autosmooth==0) { <span class="comment">/* autosmooth on original unrotated data to prevent differences between frames */</span>
<a name="l03360"></a>03360                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>);
<a name="l03361"></a>03361                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l03362"></a>03362                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0ce5d2c9c86dbf7fb4cb3822de3fa751">mul_transposed_m3_v3</a>(imat, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l03363"></a>03363                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l03364"></a>03364                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l03365"></a>03365             }
<a name="l03366"></a>03366   
<a name="l03367"></a>03367             <span class="keywordflow">if</span> (orco) {
<a name="l03368"></a>03368                 ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>= orco;
<a name="l03369"></a>03369                 orco+=3;
<a name="l03370"></a>03370             }
<a name="l03371"></a>03371             <span class="keywordflow">if</span> (ms) {
<a name="l03372"></a>03372                 <span class="keywordtype">float</span> *sticky= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a94de0c766725e8a10a4fe37639eca128">RE_vertren_get_sticky</a>(obr, ver, 1);
<a name="l03373"></a>03373                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(sticky, ms-&gt;<a class="code" href="../../da/d0c/structMSticky.html#a840213a441aa53ac542f4bdd102670a6">co</a>);
<a name="l03374"></a>03374                 ms++;
<a name="l03375"></a>03375             }
<a name="l03376"></a>03376         }
<a name="l03377"></a>03377         
<a name="l03378"></a>03378         <span class="keywordflow">if</span> (!timeoffset) {
<a name="l03379"></a>03379             <span class="comment">/* store customdata names, because DerivedMesh is freed */</span>
<a name="l03380"></a>03380             <a class="code" href="../../d0/db6/renderdatabase_8h.html#a190f06eb5d3142831c818fc7955dcdd7">RE_set_customdata_names</a>(obr, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>);
<a name="l03381"></a>03381 
<a name="l03382"></a>03382             <span class="comment">/* add tangent layer if we need one */</span>
<a name="l03383"></a>03383             <span class="keywordflow">if</span> (need_nmap_tangent!=0 &amp;&amp; <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>) == -1)
<a name="l03384"></a>03384                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a63408f7aaa01a246352ce26d0123d480">DM_add_tangent_layer</a>(dm);
<a name="l03385"></a>03385             
<a name="l03386"></a>03386             <span class="comment">/* still to do for keys: the correct local texture coordinate */</span>
<a name="l03387"></a>03387 
<a name="l03388"></a>03388             <span class="comment">/* faces in order of color blocks */</span>
<a name="l03389"></a>03389             vertofs= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a> - totvert;
<a name="l03390"></a>03390             <span class="keywordflow">for</span> (a1=0; (a1&lt;ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a> || (a1==0 &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>==0)); a1++) {
<a name="l03391"></a>03391 
<a name="l03392"></a>03392                 ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, a1+1);
<a name="l03393"></a>03393                 
<a name="l03394"></a>03394                 <span class="comment">/* test for 100% transparant */</span>
<a name="l03395"></a>03395                 ok= 1;
<a name="l03396"></a>03396                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac0f2eb80623ad884c7fa770e47ae92a2">alpha</a>==0.0f &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad7a631699c3066f84932744a295e9fce">spectra</a>==0.0f &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae3cc1249d3289da88aeb71ba7caf1066">filter</a>==0.0f &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a726661eedc26b958c4cbfdef14dbca54">MA_RAYMIRROR</a>)==0) {
<a name="l03397"></a>03397                     ok= 0;
<a name="l03398"></a>03398                     <span class="comment">/* texture on transparency? */</span>
<a name="l03399"></a>03399                     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; a++) {
<a name="l03400"></a>03400                         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a] &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l03401"></a>03401                             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) ok= 1;
<a name="l03402"></a>03402                         }
<a name="l03403"></a>03403                     }
<a name="l03404"></a>03404                 }
<a name="l03405"></a>03405                 
<a name="l03406"></a>03406                 <span class="comment">/* if wire material, and we got edges, don&#39;t do the faces */</span>
<a name="l03407"></a>03407                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>) {
<a name="l03408"></a>03408                     end= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm);
<a name="l03409"></a>03409                     <span class="keywordflow">if</span> (end) ok= 0;
<a name="l03410"></a>03410                 }
<a name="l03411"></a>03411 
<a name="l03412"></a>03412                 <span class="keywordflow">if</span> (ok) {
<a name="l03413"></a>03413                     end= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l03414"></a>03414                     mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l03415"></a>03415                     
<a name="l03416"></a>03416                     <span class="keywordflow">for</span> (a=0; a&lt;end; a++, mface++) {
<a name="l03417"></a>03417                         <span class="keywordtype">int</span> v1, v2, v3, v4, flag;
<a name="l03418"></a>03418                         
<a name="l03419"></a>03419                         <span class="keywordflow">if</span> ( mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a>==a1 ) {
<a name="l03420"></a>03420                             <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l03421"></a>03421                             <span class="keywordtype">int</span> reverse_verts = negative_scale!=0 &amp;&amp; do_autosmooth==0;
<a name="l03422"></a>03422                             <span class="keywordtype">int</span> rev_tab[] = {reverse_verts==0 ? 0 : 2, 1, reverse_verts==0 ? 2 : 0, 3};
<a name="l03423"></a>03423                             v1= reverse_verts==0 ? mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> : mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l03424"></a>03424                             v2= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l03425"></a>03425                             v3= reverse_verts==0 ? mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> : mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l03426"></a>03426                             v4= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l03427"></a>03427                             flag= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>;
<a name="l03428"></a>03428 
<a name="l03429"></a>03429                             vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l03430"></a>03430                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v1);
<a name="l03431"></a>03431                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v2);
<a name="l03432"></a>03432                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v3);
<a name="l03433"></a>03433                             <span class="keywordflow">if</span> (v4) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+v4);
<a name="l03434"></a>03434                             <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= 0;
<a name="l03435"></a>03435 
<a name="l03436"></a>03436                             <span class="comment">/* render normals are inverted in render */</span>
<a name="l03437"></a>03437                             <span class="keywordflow">if</span> (use_original_normals) {
<a name="l03438"></a>03438                                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>+a;
<a name="l03439"></a>03439                                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l03440"></a>03440                                 
<a name="l03441"></a>03441                                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l03442"></a>03442                                     len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03443"></a>03443                                 <span class="keywordflow">else</span> 
<a name="l03444"></a>03444                                     len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mv[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03445"></a>03445                             }
<a name="l03446"></a>03446                             <span class="keywordflow">else</span> {
<a name="l03447"></a>03447                                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l03448"></a>03448                                     len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l03449"></a>03449                                 <span class="keywordflow">else</span> 
<a name="l03450"></a>03450                                     len= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l03451"></a>03451                             }
<a name="l03452"></a>03452 
<a name="l03453"></a>03453                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= <a class="code" href="../../db/d05/structVolumeOb.html#ad9358af605e49ce2baf61d7fc1925818">ma</a>;
<a name="l03454"></a>03454                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= flag;
<a name="l03455"></a>03455                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= 0; <span class="comment">/* mesh edges rendered separately */</span>
<a name="l03456"></a>03456 
<a name="l03457"></a>03457                             <span class="keywordflow">if</span> (len==0) obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>--;
<a name="l03458"></a>03458                             <span class="keywordflow">else</span> {
<a name="l03459"></a>03459                                 <a class="code" href="../../d5/d97/structCustomDataLayer.html">CustomDataLayer</a> *layer;
<a name="l03460"></a>03460                                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface, *mtf;
<a name="l03461"></a>03461                                 <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mcol, *mc;
<a name="l03462"></a>03462                                 <span class="keywordtype">int</span> index, mtfn= 0, mcn= 0, mtng=0, vindex;
<a name="l03463"></a>03463                                 <span class="keywordtype">char</span> *name;
<a name="l03464"></a>03464                                 <span class="keywordtype">int</span> nr_verts = v4!=0 ? 4 : 3;
<a name="l03465"></a>03465 
<a name="l03466"></a>03466                                 <span class="keywordflow">for</span> (index=0; index&lt;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#ae5b4833527392742d84e8f7b46f5f264">totlayer</a>; index++) {
<a name="l03467"></a>03467                                     layer= &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[index];
<a name="l03468"></a>03468                                     name= layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#aa8ef26f614b5037233d4ba102e3286d8">name</a>;
<a name="l03469"></a>03469                                     
<a name="l03470"></a>03470                                     <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a> &amp;&amp; mtfn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae22819cd79515b97f4f20edf7efcc762">MAX_MTFACE</a>) {
<a name="l03471"></a>03471                                         <span class="keywordtype">int</span> t;
<a name="l03472"></a>03472                                         mtf= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(obr, vlr, mtfn++, &amp;name, 1);
<a name="l03473"></a>03473                                         mtface= (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l03474"></a>03474                                         *mtf= mtface[a];    <span class="comment">// copy face info</span>
<a name="l03475"></a>03475                                         for (vindex=0; vindex&lt;nr_verts; vindex++)
<a name="l03476"></a>03476                                             <span class="keywordflow">for</span> (t=0; t&lt;2; t++)
<a name="l03477"></a>03477                                                 mtf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[vindex][t]=mtface[a].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[rev_tab[vindex]][t];
<a name="l03478"></a>03478                                     }
<a name="l03479"></a>03479                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a> &amp;&amp; mcn &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5398e8b5970d1d384b30aa928068cebd">MAX_MCOL</a>) {
<a name="l03480"></a>03480                                         mc= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a9b31c14085f27f3fe35e7dd5f2546728">RE_vlakren_get_mcol</a>(obr, vlr, mcn++, &amp;name, 1);
<a name="l03481"></a>03481                                         mcol= (<a class="code" href="../../db/d33/structMCol.html">MCol</a>*)layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l03482"></a>03482                                         for (vindex=0; vindex&lt;nr_verts; vindex++)
<a name="l03483"></a>03483                                             mc[vindex]=mcol[a*4+rev_tab[vindex]];
<a name="l03484"></a>03484                                     }
<a name="l03485"></a>03485                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a> &amp;&amp; mtng &lt; 1) {
<a name="l03486"></a>03486                                         <span class="keywordflow">if</span> (need_nmap_tangent != 0) {
<a name="l03487"></a>03487                                             <span class="keyword">const</span> <span class="keywordtype">float</span> * tangent = (<span class="keyword">const</span> <span class="keywordtype">float</span> *) layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l03488"></a>03488                                             <span class="keywordtype">float</span> * ftang = <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8e129a349c1f27fc71e85572f29d765a">RE_vlakren_get_nmap_tangent</a>(obr, vlr, 1);
<a name="l03489"></a>03489                                             <span class="keywordflow">for</span> (vindex=0; vindex&lt;nr_verts; vindex++)
<a name="l03490"></a>03490                                             {
<a name="l03491"></a>03491                                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(ftang+vindex*4, tangent+a*16+rev_tab[vindex]*4);
<a name="l03492"></a>03492                                                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(mat, ftang+vindex*4);
<a name="l03493"></a>03493                                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ftang+vindex*4);
<a name="l03494"></a>03494                                             }
<a name="l03495"></a>03495                                         }
<a name="l03496"></a>03496                                     }
<a name="l03497"></a>03497                                 }
<a name="l03498"></a>03498                             }
<a name="l03499"></a>03499                         }
<a name="l03500"></a>03500                     }
<a name="l03501"></a>03501                 }
<a name="l03502"></a>03502             }
<a name="l03503"></a>03503             
<a name="l03504"></a>03504             <span class="comment">/* exception... we do edges for wire mode. potential conflict when faces exist... */</span>
<a name="l03505"></a>03505             end= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm);
<a name="l03506"></a>03506             mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l03507"></a>03507             ma= <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, 1);
<a name="l03508"></a>03508             <span class="keywordflow">if</span> (end &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)) {
<a name="l03509"></a>03509                 <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge;
<a name="l03510"></a>03510                 <span class="keyword">struct </span><a class="code" href="../../d1/d1a/structedgesort.html">edgesort</a> *edgetable;
<a name="l03511"></a>03511                 <span class="keywordtype">int</span> totedge= 0;
<a name="l03512"></a>03512                 recalc_normals= 1;
<a name="l03513"></a>03513                 
<a name="l03514"></a>03514                 medge= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5b98f2e9b75d92be2854b7ab25e5521">getEdgeArray</a>(dm);
<a name="l03515"></a>03515                 
<a name="l03516"></a>03516                 <span class="comment">/* we want edges to have UV and vcol too... */</span>
<a name="l03517"></a>03517                 edgetable= <a class="code" href="../../d2/d47/convertblender_8c.html#afd493bc08c80e43a4e99937466037e96">make_mesh_edge_lookup</a>(dm, &amp;totedge);
<a name="l03518"></a>03518                 
<a name="l03519"></a>03519                 <span class="keywordflow">for</span> (a1=0; a1&lt;end; a1++, medge++) {
<a name="l03520"></a>03520                     <span class="keywordflow">if</span> (medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a5c86d036e926ac7e671699d149a75da0">flag</a>&amp;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#ad5f8ca60993edb480a855925c98e353a">ME_EDGERENDER</a>) {
<a name="l03521"></a>03521                         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v0 = &amp;mvert[medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>];
<a name="l03522"></a>03522                         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../d1/d1a/structedgesort.html#ac13ca11ae5b63327fb39c78a1dd212b5">v1</a> = &amp;mvert[medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>];
<a name="l03523"></a>03523 
<a name="l03524"></a>03524                         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>++);
<a name="l03525"></a>03525                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a>);
<a name="l03526"></a>03526                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, vertofs+medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a>);
<a name="l03527"></a>03527                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l03528"></a>03528                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03529"></a>03529                         
<a name="l03530"></a>03530                         <span class="keywordflow">if</span> (edgetable)
<a name="l03531"></a>03531                             <a class="code" href="../../d2/d47/convertblender_8c.html#a933d223003e170d3edaa5f6a159b4760">use_mesh_edge_lookup</a>(obr, dm, medge, vlr, edgetable, totedge);
<a name="l03532"></a>03532                         
<a name="l03533"></a>03533                         xn= -(v0-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[0]+v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[0]);
<a name="l03534"></a>03534                         yn= -(v0-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[1]+v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[1]);
<a name="l03535"></a>03535                         zn= -(v0-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[2]+v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[2]);
<a name="l03536"></a>03536                         <span class="comment">/* transpose ! */</span>
<a name="l03537"></a>03537                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[0]= imat[0][0]*xn+imat[0][1]*yn+imat[0][2]*zn;
<a name="l03538"></a>03538                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[1]= imat[1][0]*xn+imat[1][1]*yn+imat[1][2]*zn;
<a name="l03539"></a>03539                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[2]= imat[2][0]*xn+imat[2][1]*yn+imat[2][2]*zn;
<a name="l03540"></a>03540                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l03541"></a>03541                         
<a name="l03542"></a>03542                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>= ma;
<a name="l03543"></a>03543                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= 0;
<a name="l03544"></a>03544                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>;
<a name="l03545"></a>03545                     }
<a name="l03546"></a>03546                 }
<a name="l03547"></a>03547                 <span class="keywordflow">if</span> (edgetable)
<a name="l03548"></a>03548                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(edgetable);
<a name="l03549"></a>03549             }
<a name="l03550"></a>03550         }
<a name="l03551"></a>03551     }
<a name="l03552"></a>03552     
<a name="l03553"></a>03553     <span class="keywordflow">if</span> (!timeoffset) {
<a name="l03554"></a>03554         <span class="keywordflow">if</span> (need_stress)
<a name="l03555"></a>03555             <a class="code" href="../../d2/d47/convertblender_8c.html#acd53955310315f45da98c98ab09ca05c">calc_edge_stress</a>(re, obr, me);
<a name="l03556"></a>03556 
<a name="l03557"></a>03557         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#afc4a5bc2d6b4770f1d4c077f75a246a4">test_for_displace</a>(re, ob ) ) {
<a name="l03558"></a>03558             recalc_normals= 1;
<a name="l03559"></a>03559             <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(re, obr, 0, 0);
<a name="l03560"></a>03560             <span class="keywordflow">if</span> (do_autosmooth)
<a name="l03561"></a>03561                 <a class="code" href="../../d2/d47/convertblender_8c.html#abc6702a65404f735fccec4cac6a0be5c">do_displacement</a>(re, obr, mat, imat);
<a name="l03562"></a>03562             <span class="keywordflow">else</span>
<a name="l03563"></a>03563                 <a class="code" href="../../d2/d47/convertblender_8c.html#abc6702a65404f735fccec4cac6a0be5c">do_displacement</a>(re, obr, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03564"></a>03564         }
<a name="l03565"></a>03565 
<a name="l03566"></a>03566         <span class="keywordflow">if</span> (do_autosmooth) {
<a name="l03567"></a>03567             recalc_normals= 1;
<a name="l03568"></a>03568             <a class="code" href="../../d2/d47/convertblender_8c.html#a3711f2b306dd7770e8e1c1d4a943dd10">autosmooth</a>(re, obr, mat, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad97b68a3564c0ae6104727c0e854e7da">smoothresh</a>);
<a name="l03569"></a>03569         }
<a name="l03570"></a>03570 
<a name="l03571"></a>03571         <span class="keywordflow">if</span> (recalc_normals!=0 || need_tangent!=0)
<a name="l03572"></a>03572             <a class="code" href="../../d2/d47/convertblender_8c.html#aff6578e4797a68915844751ac5bfa620">calc_vertexnormals</a>(re, obr, need_tangent, need_nmap_tangent);
<a name="l03573"></a>03573     }
<a name="l03574"></a>03574 
<a name="l03575"></a>03575     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l03576"></a>03576 }
<a name="l03577"></a>03577 
<a name="l03578"></a>03578 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03579"></a>03579 <span class="comment">/* Lamps and Shadowbuffers                                                   */</span>
<a name="l03580"></a>03580 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03581"></a>03581 
<a name="l03582"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af304d8ef33f3e8d303e2477521bcab51">03582</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af304d8ef33f3e8d303e2477521bcab51">initshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> mat[][4])
<a name="l03583"></a>03583 {
<a name="l03584"></a>03584     <span class="keyword">struct </span><a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb;
<a name="l03585"></a>03585     <span class="keywordtype">float</span> viewinv[4][4];
<a name="l03586"></a>03586     
<a name="l03587"></a>03587     <span class="comment">/* if (la-&gt;spsi&lt;16) return; */</span>
<a name="l03588"></a>03588     
<a name="l03589"></a>03589     <span class="comment">/* memory alloc */</span>
<a name="l03590"></a>03590     shb= (<span class="keyword">struct </span><a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a>),<span class="stringliteral">&quot;initshadbuf&quot;</span>);
<a name="l03591"></a>03591     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>= shb;
<a name="l03592"></a>03592     
<a name="l03593"></a>03593     <span class="keywordflow">if</span> (shb==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l03594"></a>03594     
<a name="l03595"></a>03595     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ab886ff2552bb2b5c919d440d1c3d3adb">VECCOPY</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a9da728a77edf2c3c681f92e69a238b01">co</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>); <span class="comment">/* int copy */</span>
<a name="l03596"></a>03596     
<a name="l03597"></a>03597     <span class="comment">/* percentage render: keep track of min and max */</span>
<a name="l03598"></a>03598     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>= (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5281063833ccf0c5ef28e57a57e2bfe0">bufsize</a>*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a>)/100;
<a name="l03599"></a>03599     
<a name="l03600"></a>03600     <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>&lt;512) shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>= 512;
<a name="l03601"></a>03601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a> &gt; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5281063833ccf0c5ef28e57a57e2bfe0">bufsize</a>) shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5281063833ccf0c5ef28e57a57e2bfe0">bufsize</a>;
<a name="l03602"></a>03602     
<a name="l03603"></a>03603     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a> &amp;= ~15;   <span class="comment">/* make sure its multiples of 16 */</span>
<a name="l03604"></a>03604     
<a name="l03605"></a>03605     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a2f9893cfb0b535c3a6fa3346f7c7b79b">samp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3cf567e503112a150f4209f643a300a3">samp</a>;
<a name="l03606"></a>03606     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a402c5e66dea73848bb2d758f5e277429">soft</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#adfd26f400590d814acc727633d82e377">soft</a>;
<a name="l03607"></a>03607     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a099fa714332e75e4d2eec81e7b9a3904">shadhalostep</a>;
<a name="l03608"></a>03608     
<a name="l03609"></a>03609     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(mat);
<a name="l03610"></a>03610     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, mat); <span class="comment">/* winmat is temp */</span>
<a name="l03611"></a>03611     
<a name="l03612"></a>03612     <span class="comment">/* matrix: combination of inverse view and lampmat */</span>
<a name="l03613"></a>03613     <span class="comment">/* calculate again: the ortho-render has no correct viewinv */</span>
<a name="l03614"></a>03614     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(viewinv, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l03615"></a>03615     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac60eb776f17863e2e49eb745c2de382c">viewmat</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, viewinv);
<a name="l03616"></a>03616     
<a name="l03617"></a>03617     <span class="comment">/* projection */</span>
<a name="l03618"></a>03618     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a01fb870e42d9156a0652efec4ca7916e">d</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad6212b72bf2041f77f73e679eafe333b">clipsta</a>;
<a name="l03619"></a>03619     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a4641c5202eb0dd7996aab19e58c8f4ed">clipend</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a0776d980bc866638e62fba74ea2ff501">clipend</a>;
<a name="l03620"></a>03620     
<a name="l03621"></a>03621     <span class="comment">/* bias is percentage, made 2x larger because of correction for angle of incidence */</span>
<a name="l03622"></a>03622     <span class="comment">/* when a ray is closer to parallel of a face, bias value is increased during render */</span>
<a name="l03623"></a>03623     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>= (0.02f*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad3a0588d27c920597fc2b4b03f33cf73">bias</a>)*0x7FFFFFFF;
<a name="l03624"></a>03624     
<a name="l03625"></a>03625     <span class="comment">/* halfway method (average of first and 2nd z) reduces bias issues */</span>
<a name="l03626"></a>03626     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a04f7a5531fb598ef1de609b9f3dec4e6">LA_SHADBUF_HALFWAY</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3cbc315c04ee863dd6824193d617381e">LA_SHADBUF_DEEP</a>))
<a name="l03627"></a>03627         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>= 0.1f*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>;
<a name="l03628"></a>03628     
<a name="l03629"></a>03629     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a5694fd352fb297566c4eabd3f99da595">compressthresh</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4288a18ce31d9d3c5475001a2cff8e18">compressthresh</a>;
<a name="l03630"></a>03630 }
<a name="l03631"></a>03631 
<a name="l03632"></a><a class="code" href="../../d2/d47/convertblender_8c.html#afb4eca38a352bebb7e05318d4fdff22d">03632</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#afb4eca38a352bebb7e05318d4fdff22d">area_lamp_vectors</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l03633"></a>03633 {
<a name="l03634"></a>03634     <span class="keywordtype">float</span> xsize= 0.5f*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>, ysize= 0.5f*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>, multifac;
<a name="l03635"></a>03635 
<a name="l03636"></a>03636     <span class="comment">/* make it smaller, so area light can be multisampled */</span>
<a name="l03637"></a>03637     multifac= 1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>((<span class="keywordtype">float</span>)lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>);
<a name="l03638"></a>03638     xsize *= multifac;
<a name="l03639"></a>03639     ysize *= multifac;
<a name="l03640"></a>03640     
<a name="l03641"></a>03641     <span class="comment">/* corner vectors */</span>
<a name="l03642"></a>03642     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[0][0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][0] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][0];
<a name="l03643"></a>03643     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[0][1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][1] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][1];
<a name="l03644"></a>03644     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[0][2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][2] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][2];  
<a name="l03645"></a>03645 
<a name="l03646"></a>03646     <span class="comment">/* corner vectors */</span>
<a name="l03647"></a>03647     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[1][0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][0] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][0];
<a name="l03648"></a>03648     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[1][1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][1] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][1];
<a name="l03649"></a>03649     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[1][2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2] - xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][2] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][2];  
<a name="l03650"></a>03650 
<a name="l03651"></a>03651     <span class="comment">/* corner vectors */</span>
<a name="l03652"></a>03652     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[2][0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][0] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][0];
<a name="l03653"></a>03653     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[2][1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][1] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][1];
<a name="l03654"></a>03654     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[2][2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][2] + ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][2];  
<a name="l03655"></a>03655 
<a name="l03656"></a>03656     <span class="comment">/* corner vectors */</span>
<a name="l03657"></a>03657     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[3][0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][0] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][0];
<a name="l03658"></a>03658     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[3][1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][1] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][1];
<a name="l03659"></a>03659     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[3][2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2] + xsize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[0][2] - ysize*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>[1][2];  
<a name="l03660"></a>03660     <span class="comment">/* only for correction button size, matrix size works on energy */</span>
<a name="l03661"></a>03661     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a936157286f093a91f329e44848983c82">areasize</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>/(4.0f*xsize*ysize);
<a name="l03662"></a>03662 }
<a name="l03663"></a>03663 
<a name="l03664"></a>03664 <span class="comment">/* If lar takes more lamp data, the decoupling will be better. */</span>
<a name="l03665"></a><a class="code" href="../../d2/d47/convertblender_8c.html#adadc53503b72b3ba8f5fd6ccffd4fe0a">03665</a> <span class="keyword">static</span> <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#adadc53503b72b3ba8f5fd6ccffd4fe0a">add_render_lamp</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03666"></a>03666 {
<a name="l03667"></a>03667     <a class="code" href="../../d5/d72/structLamp.html">Lamp</a> *la= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03668"></a>03668     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l03669"></a>03669     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l03670"></a>03670     <span class="keywordtype">float</span> mat[4][4], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, xn, yn;
<a name="l03671"></a>03671     <span class="keywordtype">float</span> vec[3];
<a name="l03672"></a>03672     <span class="keywordtype">int</span> c;
<a name="l03673"></a>03673 
<a name="l03674"></a>03674     <span class="comment">/* previewrender sets this to zero... prevent accidents */</span>
<a name="l03675"></a>03675     <span class="keywordflow">if</span> (la==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03676"></a>03676     
<a name="l03677"></a>03677     <span class="comment">/* prevent only shadow from rendering light */</span>
<a name="l03678"></a>03678     <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1998f8f61376aff315a6b618e8aa6bba">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>)
<a name="l03679"></a>03679         <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)==0)
<a name="l03680"></a>03680             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03681"></a>03681     
<a name="l03682"></a>03682     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>++;
<a name="l03683"></a>03683     
<a name="l03684"></a>03684     <span class="comment">/* groups is used to unify support for lightgroups, this is the global lightgroup */</span>
<a name="l03685"></a>03685     go= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a>), <span class="stringliteral">&quot;groupobject&quot;</span>);
<a name="l03686"></a>03686     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>, go);
<a name="l03687"></a>03687     go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>= ob;
<a name="l03688"></a>03688     <span class="comment">/* lamprens are in own list, for freeing */</span>
<a name="l03689"></a>03689     lar= (<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a>),<span class="stringliteral">&quot;lampren&quot;</span>);
<a name="l03690"></a>03690     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>, lar);
<a name="l03691"></a>03691     go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>= lar;
<a name="l03692"></a>03692 
<a name="l03693"></a>03693     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03694"></a>03694     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l03695"></a>03695 
<a name="l03696"></a>03696     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>, mat);
<a name="l03697"></a>03697     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l03698"></a>03698 
<a name="l03699"></a>03699     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5281063833ccf0c5ef28e57a57e2bfe0">bufsize</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a86dcd43988f13b58b2a13ae8f348a217">bufsize</a>;
<a name="l03700"></a>03700     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3cf567e503112a150f4209f643a300a3">samp</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a29a2e419d15ae749a75c72893598a949">samp</a>;
<a name="l03701"></a>03701     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a26ae7b2dabe29efbf27d4a8df48c0db6">buffers</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a7adcdd4f09af4fc5f72e8bf815fd0c51">buffers</a>;
<a name="l03702"></a>03702     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a26ae7b2dabe29efbf27d4a8df48c0db6">buffers</a>==0) lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a26ae7b2dabe29efbf27d4a8df48c0db6">buffers</a>= 1;
<a name="l03703"></a>03703     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a4ea1cac84142c452be2abe8bb9b27901">buftype</a>;
<a name="l03704"></a>03704     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6b9deafce0f3aaa480198addf2f5c7f0">filtertype</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a9be7413ccd88afb26a093f0aeaaae7da">filtertype</a>;
<a name="l03705"></a>03705     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#adfd26f400590d814acc727633d82e377">soft</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a2e08f2975026a7e9103d0cf760924694">soft</a>;
<a name="l03706"></a>03706     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a099fa714332e75e4d2eec81e7b9a3904">shadhalostep</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a59e2a2de49755294b304e061f21d4536">shadhalostep</a>;
<a name="l03707"></a>03707     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad6212b72bf2041f77f73e679eafe333b">clipsta</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a156245e4d5ec132d205a5d08afe6657d">clipsta</a>;
<a name="l03708"></a>03708     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a0776d980bc866638e62fba74ea2ff501">clipend</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ab6fadfcc03d2ecc3b5fa8058dc016e10">clipend</a>;
<a name="l03709"></a>03709     
<a name="l03710"></a>03710     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad3a0588d27c920597fc2b4b03f33cf73">bias</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a7308d47d33be47de7d5aaaf8fc9b8343">bias</a>;
<a name="l03711"></a>03711     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4288a18ce31d9d3c5475001a2cff8e18">compressthresh</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ac8e0d1df3ac8ed1526436cbaa7d000ed">compressthresh</a>;
<a name="l03712"></a>03712 
<a name="l03713"></a>03713     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>;
<a name="l03714"></a>03714     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1998f8f61376aff315a6b618e8aa6bba">mode</a>;
<a name="l03715"></a>03715 
<a name="l03716"></a>03716     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a92ccf572420771f58d0907c0ae410c42">energy</a>;
<a name="l03717"></a>03717     <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1998f8f61376aff315a6b618e8aa6bba">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a51f4b25b6ef31b95d74fd251b103bd7f">LA_NEG</a>) lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l03718"></a>03718 
<a name="l03719"></a>03719     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0]= -mat[2][0];
<a name="l03720"></a>03720     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1]= -mat[2][1];
<a name="l03721"></a>03721     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2]= -mat[2][2];
<a name="l03722"></a>03722     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>);
<a name="l03723"></a>03723     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0]= mat[3][0];
<a name="l03724"></a>03724     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1]= mat[3][1];
<a name="l03725"></a>03725     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2]= mat[3][2];
<a name="l03726"></a>03726     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a7dfb335997197bb8a645e3540a91bf4d">dist</a>;
<a name="l03727"></a>03727     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a48596cd2e91be96f0b3ae173e92aef64">haint</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ab43daaf9f3440271d8918d0def3d380f">haint</a>;
<a name="l03728"></a>03728     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac87d813965f10bca880aa6b30e8d7974">distkw</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>;
<a name="l03729"></a>03729     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>*la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a78ed635336937d2f878451f2ad65e849">r</a>;
<a name="l03730"></a>03730     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac459abfab45ae7ccecdf626896763675">g</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>*la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ae84f4026e3ea64b20481dfcfa0c66f3f">g</a>;
<a name="l03731"></a>03731     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8df1307b7133d24f3a3b64a1e5eabf11">b</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>*la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a2dee0a9717f05d6faff57abed6dd39dc">b</a>;
<a name="l03732"></a>03732     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a74bda1b10a7cf9499475d3f00c93063a">shdwr</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ae45cfaceca5d882fe9e02d8a38fca603">shdwr</a>;
<a name="l03733"></a>03733     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b058db79555224c97b8606c5c1d52f0">shdwg</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a9165f09dafa19b377d774091e86fafaa">shdwg</a>;
<a name="l03734"></a>03734     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ab932cefb313863f8e1d69d99d9f18a28">shdwb</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a784023dfd9a6beb55aa95cd2cee0a28b">shdwb</a>;
<a name="l03735"></a>03735     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5bea0db868cd90a0df6c8550f6ea5471">k</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a22b3fe7b8602fb88d85a674a808c7931">k</a>;
<a name="l03736"></a>03736 
<a name="l03737"></a>03737     <span class="comment">// area</span>
<a name="l03738"></a>03738     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#af22ba38163822e17a233759d29c5a8ee">ray_samp</a>;
<a name="l03739"></a>03739     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a05b1996ee3d1c8f940c9c7e66b69ddf3">ray_sampy</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1eab2e0a0269c41a83c6731e8836d8ec">ray_sampy</a>;
<a name="l03740"></a>03740     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af7ea78696076d88b0cfe5dcfc643720f">ray_sampz</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6075ce6e5a2515afff50c800ebb70aa1">ray_sampz</a>;
<a name="l03741"></a>03741     
<a name="l03742"></a>03742     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#aafbcbc0e9154c1edc86646246268f4c3">area_size</a>;
<a name="l03743"></a>03743     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a120b92de2b45623dac956c9caddaeac4">area_sizey</a>;
<a name="l03744"></a>03744     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad2ce8ea4f6964dd801fda2b79d8d010f">area_sizez</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ac5790fd0667da23f396f8c041557caaa">area_sizez</a>;
<a name="l03745"></a>03745 
<a name="l03746"></a>03746     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a804cbfb71c3cbb0c1803a42778080532">area_shape</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a10975ef9c9b83e75e9b3020fe71890e7">area_shape</a>;
<a name="l03747"></a>03747     
<a name="l03748"></a>03748     <span class="comment">/* Annoying, lamp UI does this, but the UI might not have been used? - add here too.</span>
<a name="l03749"></a>03749 <span class="comment">     * make sure this matches buttons_shading.c&#39;s logic */</span>
<a name="l03750"></a>03750     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab67de808c369ec7696aff85a24eace8e">LA_LOCAL</a>) &amp;&amp; (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1998f8f61376aff315a6b618e8aa6bba">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>))
<a name="l03751"></a>03751         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab67de808c369ec7696aff85a24eace8e">LA_LOCAL</a>))
<a name="l03752"></a>03752             <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a5ce31cf4991ca37ac2ee7837fafc877b">ray_samp_method</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3ff7b8015bb3297c57a6fd03d24432b3">LA_SAMP_CONSTANT</a>) la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a5ce31cf4991ca37ac2ee7837fafc877b">ray_samp_method</a> = <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2158ca4037c0d0dfdd43cea8e8d4a210">LA_SAMP_HALTON</a>;
<a name="l03753"></a>03753     
<a name="l03754"></a>03754     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a5ce31cf4991ca37ac2ee7837fafc877b">ray_samp_method</a>;
<a name="l03755"></a>03755     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af9d58311395b67c104fbaea5bcaed5bc">ray_samp_type</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#adb6b2d658f5cfe3b623f944a72550cea">ray_samp_type</a>;
<a name="l03756"></a>03756     
<a name="l03757"></a>03757     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#acd86400ad3159e196e574fc47141c1cd">adapt_thresh</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add27c699fe523c032f1c186eb5746a6c">adapt_thresh</a>;
<a name="l03758"></a>03758     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03759"></a>03759     
<a name="l03760"></a>03760     <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab67de808c369ec7696aff85a24eace8e">LA_LOCAL</a>)) {
<a name="l03761"></a>03761         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03762"></a>03762         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a804cbfb71c3cbb0c1803a42778080532">area_shape</a> = <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a65c4ef5fe117046408686d043ebafd63">LA_AREA_SQUARE</a>;
<a name="l03763"></a>03763         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l03764"></a>03764     }
<a name="l03765"></a>03765     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>) {
<a name="l03766"></a>03766         <span class="keywordflow">switch</span>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a804cbfb71c3cbb0c1803a42778080532">area_shape</a>) {
<a name="l03767"></a>03767         <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a65c4ef5fe117046408686d043ebafd63">LA_AREA_SQUARE</a>:
<a name="l03768"></a>03768             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03769"></a>03769             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a05b1996ee3d1c8f940c9c7e66b69ddf3">ray_sampy</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03770"></a>03770             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l03771"></a>03771             <span class="keywordflow">break</span>;
<a name="l03772"></a>03772         <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aceb2f6f4db39df851f0a556dfb25fd4a">LA_AREA_RECT</a>:
<a name="l03773"></a>03773             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a05b1996ee3d1c8f940c9c7e66b69ddf3">ray_sampy</a>;
<a name="l03774"></a>03774             <span class="keywordflow">break</span>;
<a name="l03775"></a>03775         <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a386e7bfae40c937bed3138c1fceb3a66">LA_AREA_CUBE</a>:
<a name="l03776"></a>03776             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03777"></a>03777             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a05b1996ee3d1c8f940c9c7e66b69ddf3">ray_sampy</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03778"></a>03778             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af7ea78696076d88b0cfe5dcfc643720f">ray_sampz</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03779"></a>03779             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l03780"></a>03780             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad2ce8ea4f6964dd801fda2b79d8d010f">area_sizez</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l03781"></a>03781             <span class="keywordflow">break</span>;
<a name="l03782"></a>03782         <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3e676bb8921631dfbe178b9daf27ccc2">LA_AREA_BOX</a>:
<a name="l03783"></a>03783             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a05b1996ee3d1c8f940c9c7e66b69ddf3">ray_sampy</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af7ea78696076d88b0cfe5dcfc643720f">ray_sampz</a>;
<a name="l03784"></a>03784             <span class="keywordflow">break</span>;
<a name="l03785"></a>03785         }
<a name="l03786"></a>03786 
<a name="l03787"></a>03787         <a class="code" href="../../d2/d47/convertblender_8c.html#afb4eca38a352bebb7e05318d4fdff22d">area_lamp_vectors</a>(lar);
<a name="l03788"></a>03788         <a class="code" href="../../d0/d0e/rendercore_8h.html#a04dff19d6d3dc316e5d70b04df795512">init_jitter_plane</a>(lar); <span class="comment">// subsamples</span>
<a name="l03789"></a>03789     }
<a name="l03790"></a>03790     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a>) {
<a name="l03791"></a>03791         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9c21226d0bf76f98f70e10d2c50044a7">ray_samp</a>;
<a name="l03792"></a>03792         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a804cbfb71c3cbb0c1803a42778080532">area_shape</a> = <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a65c4ef5fe117046408686d043ebafd63">LA_AREA_SQUARE</a>;
<a name="l03793"></a>03793         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a25b676f7473d9bea4b8588a1e17525cc">area_sizey</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afa72c33e98b915ee2e68883b4825902e">area_size</a>;
<a name="l03794"></a>03794 
<a name="l03795"></a>03795         <span class="keywordflow">if</span> ((la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a24f8a2566a937e0d6e71b654981155b7">sun_effect_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7a634c6683d6ac9a1214bc85f4baf561">LA_SUN_EFFECT_SKY</a>) ||
<a name="l03796"></a>03796                 (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a24f8a2566a937e0d6e71b654981155b7">sun_effect_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2a3f1af08c87f9874eeebec57bf5bd16">LA_SUN_EFFECT_AP</a>)) {
<a name="l03797"></a>03797             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a> = (<span class="keyword">struct </span><a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a>), <span class="stringliteral">&quot;sunskyren&quot;</span>);
<a name="l03798"></a>03798             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac6d6c031fe6fd039f98c5fcc695a2247">effect_type</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a24f8a2566a937e0d6e71b654981155b7">sun_effect_type</a>;
<a name="l03799"></a>03799         
<a name="l03800"></a>03800             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec,ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[2]);
<a name="l03801"></a>03801             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l03802"></a>03802 
<a name="l03803"></a>03803             <a class="code" href="../../dc/d88/sunsky_8h.html#a320aaf01c0443f4b14a0d6302dc0e4fd">InitSunSky</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a57704fb95867650e3cd5ccd3f8e8e7a5">atm_turbidity</a>, vec, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#aeeca86969386970112fbedcb4d062b46">horizon_brightness</a>, 
<a name="l03804"></a>03804                     la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a58c58abc764824dd8a9105493ed315da">spread</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a886cdc0af5a053e4cc18fb5c7cc29656">sun_brightness</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ac7679fe5d6d432623b397074142e763e">sun_size</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#af657e9af8c9cd30a9d3f67a1cbde6c26">backscattered_light</a>,
<a name="l03805"></a>03805                        la-&gt;<a class="code" href="../../d5/d72/structLamp.html#aaf1c0a0b108ae09435ab393b85eb67ea">skyblendfac</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a4d7951e6944fc10ad9984eeecf11f47a">skyblendtype</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a5ad9d5d11b7d1b3c64ca40c63d599982">sky_exposure</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a9829ec4d02e8dfe7fdac72593a9d94ee">sky_colorspace</a>);
<a name="l03806"></a>03806             
<a name="l03807"></a>03807             <a class="code" href="../../dc/d88/sunsky_8h.html#af3a60aad8494a03ce09ee469cf29dd57">InitAtmosphere</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ade5c6e06edfa2cf2c8214d8f639b7fca">sun_intensity</a>, 1.0, 1.0, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a2f34b114dde0ef2017269b54e5d25cbf">atm_inscattering_factor</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a3453aa42999f6e85a196136230a99d79">atm_extinction_factor</a>,
<a name="l03808"></a>03808                     la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a0cc554c5691da901eec00e78060ea1fd">atm_distance_factor</a>);
<a name="l03809"></a>03809         }
<a name="l03810"></a>03810     }
<a name="l03811"></a>03811     <span class="keywordflow">else</span> lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>= 0;
<a name="l03812"></a>03812     
<a name="l03813"></a>03813     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#afbf90c480b2728c3b48a5680dd4a9487">spotsize</a>;
<a name="l03814"></a>03814     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a66b81fd98d8f8b3dc52a71f8791a73a9">LA_HALO</a>) {
<a name="l03815"></a>03815         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>&gt;170.0f) lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>= 170.0f;
<a name="l03816"></a>03816     }
<a name="l03817"></a>03817     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>( (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>/360.0f );
<a name="l03818"></a>03818     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a2a5b4e6535eb9e727d0331696ff975ce">spotbl</a>= (1.0f-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>)*la-&gt;<a class="code" href="../../d5/d72/structLamp.html#afa8564cb927dc5cf1398f89526db5fc1">spotblend</a>;
<a name="l03819"></a>03819 
<a name="l03820"></a>03820     memcpy(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a653926316f1da3f0b94db0c09f0b52d9">mtex</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l03821"></a>03821 
<a name="l03822"></a>03822     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>= ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> &amp; 0xFFFFFF;   <span class="comment">// higher 8 bits are localview layers</span>
<a name="l03823"></a>03823 
<a name="l03824"></a>03824     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a552e96ad4c0b8645dfbe85c9aa6eb921">falloff_type</a> = la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a52235987337869d42c3ad6edfd333fc5">falloff_type</a>;
<a name="l03825"></a>03825     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aa426d637e8e7dbe8cbd851c2d5b91d42">ld1</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ac71d383b39dc0e0dfc6bb6243756471f">att1</a>;
<a name="l03826"></a>03826     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad534b1e39f44bfa3def6c9edc21cad50">ld2</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a74abd39c5f30e406fddd65cd33ae63a3">att2</a>;
<a name="l03827"></a>03827     lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a23d95b62c92cf51999ddb7e90adcdf8a">curfalloff</a> = <a class="code" href="../../d4/dca/BKE__colortools_8h.html#abf02c86e7ad7564ba85ff1adc9c34641">curvemapping_copy</a>(la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ae75f87abb3b95ca23081c5e7cd008340">curfalloff</a>);
<a name="l03828"></a>03828 
<a name="l03829"></a>03829     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>) {
<a name="l03830"></a>03830 
<a name="l03831"></a>03831         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[0]);
<a name="l03832"></a>03832         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[1]);
<a name="l03833"></a>03833         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[2]);
<a name="l03834"></a>03834 
<a name="l03835"></a>03835         xn= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>);
<a name="l03836"></a>03836         xn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(xn)/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(xn);
<a name="l03837"></a>03837         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b0a00085e1c30f39892f8e066d92d0">spottexfac</a>= 1.0f/(xn);
<a name="l03838"></a>03838 
<a name="l03839"></a>03839         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>) {
<a name="l03840"></a>03840             <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a6d46bae4e340f7043f9507eaf1293c72">LA_SHAD_BUF</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>))==0) lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> -= <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>;
<a name="l03841"></a>03841         }
<a name="l03842"></a>03842 
<a name="l03843"></a>03843     }
<a name="l03844"></a>03844 
<a name="l03845"></a>03845     <span class="comment">/* set flag for spothalo en initvars */</span>
<a name="l03846"></a>03846     <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a> &amp;&amp; (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a1998f8f61376aff315a6b618e8aa6bba">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a66b81fd98d8f8b3dc52a71f8791a73a9">LA_HALO</a>) &amp;&amp; (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a4ea1cac84142c452be2abe8bb9b27901">buftype</a> != <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3cbc315c04ee863dd6824193d617381e">LA_SHADBUF_DEEP</a>)) {
<a name="l03847"></a>03847         <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ab43daaf9f3440271d8918d0def3d380f">haint</a>&gt;0.0f) {
<a name="l03848"></a>03848             re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a27f1abe07680d03bf8521c9359d04841">R_LAMPHALO</a>;
<a name="l03849"></a>03849 
<a name="l03850"></a>03850             <span class="comment">/* camera position (0,0,0) rotate around lamp */</span>
<a name="l03851"></a>03851             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[0]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0];
<a name="l03852"></a>03852             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[1]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1];
<a name="l03853"></a>03853             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[2]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2];
<a name="l03854"></a>03854             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>);
<a name="l03855"></a>03855 
<a name="l03856"></a>03856             <span class="comment">/* z factor, for a normalized volume */</span>
<a name="l03857"></a>03857             angle= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>);
<a name="l03858"></a>03858             xn= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>;
<a name="l03859"></a>03859             yn= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(angle);
<a name="l03860"></a>03860             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>= yn/xn;
<a name="l03861"></a>03861             <span class="comment">/* pre-scale */</span>
<a name="l03862"></a>03862             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[2]*= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l03863"></a>03863 
<a name="l03864"></a>03864             <span class="comment">/* halfway shadow buffer doesn&#39;t work for volumetric effects */</span>
<a name="l03865"></a>03865             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a04f7a5531fb598ef1de609b9f3dec4e6">LA_SHADBUF_HALFWAY</a>)
<a name="l03866"></a>03866                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a> = <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ae107928b769864b5f00b97be13e28338">LA_SHADBUF_REGULAR</a>;
<a name="l03867"></a>03867 
<a name="l03868"></a>03868         }
<a name="l03869"></a>03869     }
<a name="l03870"></a>03870     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l03871"></a>03871         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp;= ~(<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a6d46bae4e340f7043f9507eaf1293c72">LA_SHAD_BUF</a>);
<a name="l03872"></a>03872     }
<a name="l03873"></a>03873 
<a name="l03874"></a>03874     <span class="keywordflow">for</span> (c=0; c&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; c++) {
<a name="l03875"></a>03875         <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>[c] &amp;&amp; la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>[c]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l03876"></a>03876             <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>[c]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aae63e37d7dddc407c68288610486ffd6">LAMAP_COL</a>) 
<a name="l03877"></a>03877                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> |= <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>;
<a name="l03878"></a>03878             <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>[c]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aad74125b6ea0c029453815dbc7171a88">LAMAP_SHAD</a>)
<a name="l03879"></a>03879                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> |= <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a151fc803e1c480ea3746f302284d3b41">LA_SHAD_TEX</a>;
<a name="l03880"></a>03880 
<a name="l03881"></a>03881             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering) {
<a name="l03882"></a>03882                 <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>) {
<a name="l03883"></a>03883                     <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#add02e1f88fe6e0ab0f54de00fd02b49e">mtex</a>[c]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> |= <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aacf03d280f4150768590d86d7ac3a542">LA_OSATEX</a>;
<a name="l03884"></a>03884                 }
<a name="l03885"></a>03885             }
<a name="l03886"></a>03886         }
<a name="l03887"></a>03887     }
<a name="l03888"></a>03888 
<a name="l03889"></a>03889     <span class="comment">/* old code checked for internal render (aka not yafray) */</span>
<a name="l03890"></a>03890     {
<a name="l03891"></a>03891         <span class="comment">/* to make sure we can check ray shadow easily in the render code */</span>
<a name="l03892"></a>03892         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) {
<a name="l03893"></a>03893             <span class="keywordflow">if</span> ( (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>)==0)
<a name="l03894"></a>03894                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp;= ~<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>;
<a name="l03895"></a>03895         }
<a name="l03896"></a>03896     
<a name="l03897"></a>03897 
<a name="l03898"></a>03898         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>) {
<a name="l03899"></a>03899             
<a name="l03900"></a>03900             <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a> &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a70b7b6838bbdfda00a526fd236e49d55">ray_samp_method</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3ff7b8015bb3297c57a6fd03d24432b3">LA_SAMP_CONSTANT</a>)) {
<a name="l03901"></a>03901                 <a class="code" href="../../d0/d0e/rendercore_8h.html#a04dff19d6d3dc316e5d70b04df795512">init_jitter_plane</a>(lar);
<a name="l03902"></a>03902             }
<a name="l03903"></a>03903             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a6c8bfeca1d8a74252bfe284de7d754cb">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a> &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a6d46bae4e340f7043f9507eaf1293c72">LA_SHAD_BUF</a>) ) {
<a name="l03904"></a>03904                 <span class="comment">/* Per lamp, one shadow buffer is made. */</span>
<a name="l03905"></a>03905                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af4f46b1eb94f0ddc1a3b233ca25ee387">bufflag</a>= la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a2ae4d8cc12e191ab17de4aa4c6a8554c">bufflag</a>;
<a name="l03906"></a>03906                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03907"></a>03907                 <a class="code" href="../../d2/d47/convertblender_8c.html#af304d8ef33f3e8d303e2477521bcab51">initshadowbuf</a>(re, lar, mat);    <span class="comment">// mat is altered</span>
<a name="l03908"></a>03908             }
<a name="l03909"></a>03909             
<a name="l03910"></a>03910             
<a name="l03911"></a>03911             <span class="comment">/* this is the way used all over to check for shadow */</span>
<a name="l03912"></a>03912             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> || (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>)) {
<a name="l03913"></a>03913                 <a class="code" href="../../d8/d3e/structLampShadowSample.html">LampShadowSample</a> *ls;
<a name="l03914"></a>03914                 <a class="code" href="../../db/dcd/structLampShadowSubSample.html">LampShadowSubSample</a> *lss;
<a name="l03915"></a>03915                 <span class="keywordtype">int</span> a, b;
<a name="l03916"></a>03916 
<a name="l03917"></a>03917                 memset(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#af9cf9373405bb854bf2d0003394e12be">shadowsamplenr</a>, 0, <span class="keyword">sizeof</span>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#af9cf9373405bb854bf2d0003394e12be">shadowsamplenr</a>));
<a name="l03918"></a>03918                 
<a name="l03919"></a>03919                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a860a59b39afa231fbffc678adef05b9a">shadsamp</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d3e/structLampShadowSample.html">LampShadowSample</a>), <span class="stringliteral">&quot;lamp shadow sample&quot;</span>);
<a name="l03920"></a>03920                 ls= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a860a59b39afa231fbffc678adef05b9a">shadsamp</a>;
<a name="l03921"></a>03921 
<a name="l03922"></a>03922                 <span class="comment">/* shadfacs actually mean light, let&#39;s put them to 1 to prevent unitialized accidents */</span>
<a name="l03923"></a>03923                 <span class="keywordflow">for</span> (a=0; a&lt;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>; a++, ls++) {
<a name="l03924"></a>03924                     lss= ls-&gt;<a class="code" href="../../d8/d3e/structLampShadowSample.html#a7e64f7ba02b3e73f90f38cea4212571f">s</a>;
<a name="l03925"></a>03925                     <span class="keywordflow">for</span> (b=0; b&lt;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9f9743267b1d3ba032f5e0d1a81a4073">osa</a>; b++, lss++) {
<a name="l03926"></a>03926                         lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#a410c17c7cb3762e41138a08df4537929">samplenr</a>= -1;  <span class="comment">/* used to detect whether we store or read */</span>
<a name="l03927"></a>03927                         lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>[0]= 1.0f;
<a name="l03928"></a>03928                         lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>[1]= 1.0f;
<a name="l03929"></a>03929                         lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>[2]= 1.0f;
<a name="l03930"></a>03930                         lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>[3]= 1.0f;
<a name="l03931"></a>03931                     }
<a name="l03932"></a>03932                 }
<a name="l03933"></a>03933             }
<a name="l03934"></a>03934         }
<a name="l03935"></a>03935     }
<a name="l03936"></a>03936     
<a name="l03937"></a>03937     <span class="keywordflow">return</span> go;
<a name="l03938"></a>03938 }
<a name="l03939"></a>03939 
<a name="l03940"></a>03940 <span class="comment">/* layflag: allows material group to ignore layerflag */</span>
<a name="l03941"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a3238b1c51144444a674f8b8f4178bd38">03941</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a3238b1c51144444a674f8b8f4178bd38">add_lightgroup</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d91/structGroup.html">Group</a> *group, <span class="keywordtype">int</span> exclusive)
<a name="l03942"></a>03942 {
<a name="l03943"></a>03943     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go, *gol;
<a name="l03944"></a>03944     
<a name="l03945"></a>03945     group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l03946"></a>03946 
<a name="l03947"></a>03947     <span class="comment">/* it&#39;s a bit too many loops in loops... but will survive */</span>
<a name="l03948"></a>03948     <span class="comment">/* note that &#39;exclusive&#39; will remove it from the global list */</span>
<a name="l03949"></a>03949     <span class="keywordflow">for</span> (go= group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ad757bf69b6fd15b1d4e0980089d13be1">gobject</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l03950"></a>03950         go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03951"></a>03951         
<a name="l03952"></a>03952         <span class="keywordflow">if</span> (go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> &amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>) {
<a name="l03953"></a>03953             <span class="keywordflow">if</span> (go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a> &amp;&amp; go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>) {
<a name="l03954"></a>03954                 <span class="keywordflow">for</span> (gol= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; gol; gol= gol-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l03955"></a>03955                     <span class="keywordflow">if</span> (gol-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>==go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>) {
<a name="l03956"></a>03956                         go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>= gol-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l03957"></a>03957                         <span class="keywordflow">break</span>;
<a name="l03958"></a>03958                     }
<a name="l03959"></a>03959                 }
<a name="l03960"></a>03960                 <span class="keywordflow">if</span> (go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03961"></a>03961                     gol= <a class="code" href="../../d2/d47/convertblender_8c.html#adadc53503b72b3ba8f5fd6ccffd4fe0a">add_render_lamp</a>(re, go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>);
<a name="l03962"></a>03962                 <span class="keywordflow">if</span> (gol &amp;&amp; exclusive) {
<a name="l03963"></a>03963                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>, gol);
<a name="l03964"></a>03964                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(gol);
<a name="l03965"></a>03965                 }
<a name="l03966"></a>03966             }
<a name="l03967"></a>03967         }
<a name="l03968"></a>03968     }
<a name="l03969"></a>03969 }
<a name="l03970"></a>03970 
<a name="l03971"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a997e44476011234e8d03d981bbd3a8a3">03971</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a997e44476011234e8d03d981bbd3a8a3">set_material_lightgroups</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l03972"></a>03972 {
<a name="l03973"></a>03973     <a class="code" href="../../d4/d91/structGroup.html">Group</a> *group;
<a name="l03974"></a>03974     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l03975"></a>03975     
<a name="l03976"></a>03976     <span class="comment">/* not for preview render */</span>
<a name="l03977"></a>03977     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad40c9887f83dc3ac92440b0895ae2413">R_PREVIEWBUTS</a>)
<a name="l03978"></a>03978         <span class="keywordflow">return</span>;
<a name="l03979"></a>03979     
<a name="l03980"></a>03980     <span class="keywordflow">for</span> (group= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a267e87055868d88574ec121db05cc8c7">group</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; group; group=group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l03981"></a>03981         group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l03982"></a>03982     
<a name="l03983"></a>03983     <span class="comment">/* it&#39;s a bit too many loops in loops... but will survive */</span>
<a name="l03984"></a>03984     <span class="comment">/* hola! materials not in use...? */</span>
<a name="l03985"></a>03985     <span class="keywordflow">for</span> (ma= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#afbcb0c6e7f10e562d567fe016fc6c5a5">mat</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ma; ma=ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a3fc06eed9b3244922dd05906dcc58cde">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l03986"></a>03986         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a67df82e791d0a7e8d62425b4d2cbc364">group</a> &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a67df82e791d0a7e8d62425b4d2cbc364">group</a>-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp; <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>))
<a name="l03987"></a>03987             <a class="code" href="../../d2/d47/convertblender_8c.html#a3238b1c51144444a674f8b8f4178bd38">add_lightgroup</a>(re, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a67df82e791d0a7e8d62425b4d2cbc364">group</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a30736c5872c2ced5b8c30199dbb90379">MA_GROUP_NOLAY</a>);
<a name="l03988"></a>03988     }
<a name="l03989"></a>03989 }
<a name="l03990"></a>03990 
<a name="l03991"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a99b07b1cb4a8e36a8f27a30ef4d8ddec">03991</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a99b07b1cb4a8e36a8f27a30ef4d8ddec">set_renderlayer_lightgroups</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce)
<a name="l03992"></a>03992 {
<a name="l03993"></a>03993     <a class="code" href="../../d1/d51/structSceneRenderLayer.html">SceneRenderLayer</a> *srl;
<a name="l03994"></a>03994     
<a name="l03995"></a>03995     <span class="keywordflow">for</span> (srl= sce-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a235b7b4bed2d2d73189d3e12c219672a">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; srl; srl= srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#a9363918698634136fa21bafcabd79d27">next</a>) {
<a name="l03996"></a>03996         <span class="keywordflow">if</span> (srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#a94cbd24a166c1c093fccd583e08cd3ae">light_override</a>)
<a name="l03997"></a>03997             <a class="code" href="../../d2/d47/convertblender_8c.html#a3238b1c51144444a674f8b8f4178bd38">add_lightgroup</a>(re, srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#a94cbd24a166c1c093fccd583e08cd3ae">light_override</a>, 0);
<a name="l03998"></a>03998     }
<a name="l03999"></a>03999 }
<a name="l04000"></a>04000 
<a name="l04001"></a>04001 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04002"></a>04002 <span class="comment">/* World                                                                     */</span>
<a name="l04003"></a>04003 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04004"></a>04004 
<a name="l04005"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a60a634e8ea9b98602b0e207691ab6bb4">04005</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/db6/renderdatabase_8h.html#a60a634e8ea9b98602b0e207691ab6bb4">init_render_world</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l04006"></a>04006 {
<a name="l04007"></a>04007     <span class="keywordtype">int</span> a;
<a name="l04008"></a>04008     <span class="keywordtype">char</span> *cp;
<a name="l04009"></a>04009     
<a name="l04010"></a>04010     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a> &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>) {
<a name="l04011"></a>04011         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>= *(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>);
<a name="l04012"></a>04012         
<a name="l04013"></a>04013         cp= (<span class="keywordtype">char</span> *)&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#afd92b7e1448ab842a4e79680b78934b4">fastcol</a>;
<a name="l04014"></a>04014         
<a name="l04015"></a>04015         cp[0]= 255.0f*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a>;
<a name="l04016"></a>04016         cp[1]= 255.0f*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a5a4b17af92505404808f2edc8154ad62">horg</a>;
<a name="l04017"></a>04017         cp[2]= 255.0f*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ab6522efbf6e1ae8daf0cd5f95a6024d3">horb</a>;
<a name="l04018"></a>04018         cp[3]= 1;
<a name="l04019"></a>04019         
<a name="l04020"></a>04020         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a6bf0db97e581a6aac25c9dfb18518110">grvec</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>[2]);
<a name="l04021"></a>04021         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a6bf0db97e581a6aac25c9dfb18518110">grvec</a>);
<a name="l04022"></a>04022         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ace3a2e645f5e2444ade24b8b562dbace">imat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>);
<a name="l04023"></a>04023         
<a name="l04024"></a>04024         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; a++)
<a name="l04025"></a>04025             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aa41e14c520e87635c6c9a748dd144e25">mtex</a>[a] &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aa41e14c520e87635c6c9a748dd144e25">mtex</a>[a]-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ad0e8538523c8efaa970b97dc077004ee">skytype</a> |= <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab33a2cd9d8570434339bbfd7a3664a0a">WO_SKYTEX</a>;
<a name="l04026"></a>04026         
<a name="l04027"></a>04027         <span class="comment">/* AO samples should be OSA minimum */</span>
<a name="l04028"></a>04028         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>)
<a name="l04029"></a>04029             <span class="keywordflow">while</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a055acb019560e974d4f42928edbbbb3e">aosamp</a>*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a055acb019560e974d4f42928edbbbb3e">aosamp</a> &lt; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>)
<a name="l04030"></a>04030                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a055acb019560e974d4f42928edbbbb3e">aosamp</a>++;
<a name="l04031"></a>04031         <span class="keywordflow">if</span> (!(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) &amp;&amp; (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a0d14a3fe319ff85a891e8616759c3469">ao_gather_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a758cb9bee0a690aeab9eca5128e635b0">WO_AOGATHER_RAYTRACE</a>))
<a name="l04032"></a>04032             re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp;= ~(<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>);
<a name="l04033"></a>04033     }
<a name="l04034"></a>04034     <span class="keywordflow">else</span> {
<a name="l04035"></a>04035         memset(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3f/structWorld.html">World</a>));
<a name="l04036"></a>04036         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aab83b185894b81783e517cb7af3442c7">exp</a>= 0.0f;
<a name="l04037"></a>04037         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a8463b6c20ef9df165c862137d4781b8e">range</a>= 1.0f;
<a name="l04038"></a>04038         
<a name="l04039"></a>04039         <span class="comment">/* for mist pass */</span>
<a name="l04040"></a>04040         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a8b2f1072744743ef7a09b2a06d9538a8">miststa</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa1811a2e46b1335c04ab55d01f56b0da">clipsta</a>;
<a name="l04041"></a>04041         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ac2af5c5407c4c13815f9f95a10535224">mistdist</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9d51c1c3fb3a8ee8398083bde57a228e">clipend</a>-re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa1811a2e46b1335c04ab55d01f56b0da">clipsta</a>;
<a name="l04042"></a>04042         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a4681edaa1f8c367e685d02ac2eb5ae31">misi</a>= 1.0f;
<a name="l04043"></a>04043     }
<a name="l04044"></a>04044     
<a name="l04045"></a>04045     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a2f1a4f35b758207c80fd009bb55ffa81">linfac</a>= 1.0f + <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>((2.0f*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aab83b185894b81783e517cb7af3442c7">exp</a> + 0.5f), -10);
<a name="l04046"></a>04046     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aa09db17fbe1d9f9b681e8173e8fa1460">logfac</a>= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a85962e624e1b5fdeacb6d0cb257ae715">logf</a>((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a2f1a4f35b758207c80fd009bb55ffa81">linfac</a>-1.0f)/re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a2f1a4f35b758207c80fd009bb55ffa81">linfac</a>) / re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a8463b6c20ef9df165c862137d4781b8e">range</a>;
<a name="l04047"></a>04047 }
<a name="l04048"></a>04048 
<a name="l04049"></a>04049 
<a name="l04050"></a>04050 
<a name="l04051"></a>04051 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04052"></a>04052 <span class="comment">/* Object Finalization                                                       */</span>
<a name="l04053"></a>04053 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04054"></a>04054 
<a name="l04055"></a>04055 <span class="comment">/* prevent phong interpolation for giving ray shadow errors (terminator problem) */</span>
<a name="l04056"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a7ed82126c67fa82b008c512f036decfb">04056</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a7ed82126c67fa82b008c512f036decfb">set_phong_threshold</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l04057"></a>04057 {
<a name="l04058"></a>04058 <span class="comment">//  VertRen *ver;</span>
<a name="l04059"></a>04059     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l04060"></a>04060     <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>= 0.0, <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>;
<a name="l04061"></a>04061     <span class="keywordtype">int</span> tot=0, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l04062"></a>04062     
<a name="l04063"></a>04063     <span class="comment">/* Added check for &#39;pointy&#39; situations, only dotproducts of 0.9 and larger </span>
<a name="l04064"></a>04064 <span class="comment">     * are taken into account. This threshold is meant to work on smooth geometry, not</span>
<a name="l04065"></a>04065 <span class="comment">     * for extreme cases (ton) */</span>
<a name="l04066"></a>04066     
<a name="l04067"></a>04067     <span class="keywordflow">for</span> (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l04068"></a>04068         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l04069"></a>04069         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>) {
<a name="l04070"></a>04070             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04071"></a>04071             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>);
<a name="l04072"></a>04072             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>&gt;0.9f) {
<a name="l04073"></a>04073                 thresh+= <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>; tot++;
<a name="l04074"></a>04074             }
<a name="l04075"></a>04075             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04076"></a>04076             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>);
<a name="l04077"></a>04077             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>&gt;0.9f) {
<a name="l04078"></a>04078                 thresh+= <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>; tot++;
<a name="l04079"></a>04079             }
<a name="l04080"></a>04080 
<a name="l04081"></a>04081             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04082"></a>04082             <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>);
<a name="l04083"></a>04083             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>&gt;0.9f) {
<a name="l04084"></a>04084                 thresh+= <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>; tot++;
<a name="l04085"></a>04085             }
<a name="l04086"></a>04086 
<a name="l04087"></a>04087             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l04088"></a>04088                 <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04089"></a>04089                 <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>);
<a name="l04090"></a>04090                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>&gt;0.9f) {
<a name="l04091"></a>04091                     thresh+= <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>; tot++;
<a name="l04092"></a>04092                 }
<a name="l04093"></a>04093             }
<a name="l04094"></a>04094         }
<a name="l04095"></a>04095     }
<a name="l04096"></a>04096     
<a name="l04097"></a>04097     <span class="keywordflow">if</span> (tot) {
<a name="l04098"></a>04098         thresh/= (float)tot;
<a name="l04099"></a>04099         obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2cf2f167ccb0a07c33ae196131cac32a">smoothresh</a>= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(0.5f*(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>-<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(thresh));
<a name="l04100"></a>04100     }
<a name="l04101"></a>04101 }
<a name="l04102"></a>04102 
<a name="l04103"></a>04103 <span class="comment">/* per face check if all samples should be taken.</span>
<a name="l04104"></a>04104 <span class="comment"> * if raytrace or multisample, do always for raytraced material, or when material full_osa set */</span>
<a name="l04105"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a07f7d476bf43d1d0e733afaca8eeab30">04105</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a07f7d476bf43d1d0e733afaca8eeab30">set_fullsample_trace_flag</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l04106"></a>04106 {
<a name="l04107"></a>04107     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l04108"></a>04108     <span class="keywordtype">int</span> a, <a class="code" href="../../d5/d8e/Value_8h.html#a6de19da2ce2b0236858a617a31873b7f">trace</a>, mode, osa;
<a name="l04109"></a>04109 
<a name="l04110"></a>04110     osa= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>;
<a name="l04111"></a>04111     trace= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>;
<a name="l04112"></a>04112     
<a name="l04113"></a>04113     <span class="keywordflow">for</span> (a=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>-1; a&gt;=0; a--) {
<a name="l04114"></a>04114         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l04115"></a>04115         mode= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a>;
<a name="l04116"></a>04116 
<a name="l04117"></a>04117         <span class="keywordflow">if</span> (trace &amp;&amp; (mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acda2cb9524d4e603dae82a0ae552c1a2">MA_TRACEBLE</a>))
<a name="l04118"></a>04118             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab3bc3d9ccd012df4f5e37d9086c3bc1e">R_TRACEBLE</a>;
<a name="l04119"></a>04119         
<a name="l04120"></a>04120         <span class="keywordflow">if</span> (osa) {
<a name="l04121"></a>04121             <span class="keywordflow">if</span> (mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aceefd6b9aa061ad283bf30a485640b3e">MA_FULL_OSA</a>) {
<a name="l04122"></a>04122                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#af99e9bbaa81b1dd1c3b8c010da102bbd">R_FULL_OSA</a>;
<a name="l04123"></a>04123             }
<a name="l04124"></a>04124             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (trace) {
<a name="l04125"></a>04125                 <span class="keywordflow">if</span> (mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a711a44cc51cfb78f529c3ac59306e756">MA_SHLESS</a>);
<a name="l04126"></a>04126                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>);
<a name="l04127"></a>04127                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a726661eedc26b958c4cbfdef14dbca54">MA_RAYMIRROR</a>) || ((mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (mode &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2f301bfe492802b8461b969fc72b3652">MA_RAYTRANSP</a>))) {
<a name="l04128"></a>04128                     <span class="comment">/* for blurry reflect/refract, better to take more samples </span>
<a name="l04129"></a>04129 <span class="comment">                     * inside the raytrace than as OSA samples */</span>
<a name="l04130"></a>04130                     <span class="keywordflow">if</span> ((vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae9c4f4e3b999725bf1e19a4e4c7159b1">gloss_mir</a> == 1.0f) &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a17886fc73bb73e837d2d9e323723aa76">gloss_tra</a> == 1.0f))
<a name="l04131"></a>04131                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#af99e9bbaa81b1dd1c3b8c010da102bbd">R_FULL_OSA</a>;
<a name="l04132"></a>04132                 }
<a name="l04133"></a>04133             }
<a name="l04134"></a>04134         }
<a name="l04135"></a>04135     }
<a name="l04136"></a>04136 }
<a name="l04137"></a>04137 
<a name="l04138"></a>04138 <span class="comment">/* split quads for predictable baking</span>
<a name="l04139"></a>04139 <span class="comment"> * dir 1 == (0,1,2) (0,2,3),  2 == (1,3,0) (1,2,3) </span>
<a name="l04140"></a>04140 <span class="comment"> */</span>
<a name="l04141"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ae32c4d57ffb713a00e1dbfdddb7b5087">04141</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ae32c4d57ffb713a00e1dbfdddb7b5087">split_quads</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> dir) 
<a name="l04142"></a>04142 {
<a name="l04143"></a>04143     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, *vlr1;
<a name="l04144"></a>04144     <span class="keywordtype">int</span> a;
<a name="l04145"></a>04145 
<a name="l04146"></a>04146     <span class="keywordflow">for</span> (a=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>-1; a&gt;=0; a--) {
<a name="l04147"></a>04147         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l04148"></a>04148         
<a name="l04149"></a>04149         <span class="comment">/* test if rendering as a quad or triangle, skip wire */</span>
<a name="l04150"></a>04150         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)==0 &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> != <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)) {
<a name="l04151"></a>04151             
<a name="l04152"></a>04152             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l04153"></a>04153 
<a name="l04154"></a>04154                 vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a82082dd8c88a849d3e98d7c532cf6f50">RE_vlakren_copy</a>(obr, vlr);
<a name="l04155"></a>04155                 vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab28027078d87215bd79ce8e046da84ff">R_FACE_SPLIT</a>;
<a name="l04156"></a>04156                 
<a name="l04157"></a>04157                 <span class="keywordflow">if</span> ( dir==2 ) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04158"></a>04158                 <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04159"></a>04159 
<a name="l04160"></a>04160                 <span class="comment">/* new vertex pointers */</span>
<a name="l04161"></a>04161                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>) {
<a name="l04162"></a>04162                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l04163"></a>04163                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l04164"></a>04164                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04165"></a>04165 
<a name="l04166"></a>04166                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a> = vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04167"></a>04167                     
<a name="l04168"></a>04168                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04169"></a>04169                 }
<a name="l04170"></a>04170                 <span class="keywordflow">else</span> {
<a name="l04171"></a>04171                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l04172"></a>04172                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l04173"></a>04173                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04174"></a>04174                     
<a name="l04175"></a>04175                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04176"></a>04176                 }
<a name="l04177"></a>04177                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> = vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04178"></a>04178                 
<a name="l04179"></a>04179                 <span class="comment">/* new normals */</span>
<a name="l04180"></a>04180                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04181"></a>04181                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04182"></a>04182             }
<a name="l04183"></a>04183             <span class="comment">/* clear the flag when not divided */</span>
<a name="l04184"></a>04184             <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04185"></a>04185         }
<a name="l04186"></a>04186     }
<a name="l04187"></a>04187 }
<a name="l04188"></a>04188 
<a name="l04189"></a><a class="code" href="../../d2/d47/convertblender_8c.html#adb6fc8d40185c460da72949dd9a21230">04189</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#adb6fc8d40185c460da72949dd9a21230">check_non_flat_quads</a>(<a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l04190"></a>04190 {
<a name="l04191"></a>04191     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, *vlr1;
<a name="l04192"></a>04192     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, *v2, *v3, *v4;
<a name="l04193"></a>04193     <span class="keywordtype">float</span> nor[3], xn, flen;
<a name="l04194"></a>04194     <span class="keywordtype">int</span> a;
<a name="l04195"></a>04195 
<a name="l04196"></a>04196     <span class="keywordflow">for</span> (a=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>-1; a&gt;=0; a--) {
<a name="l04197"></a>04197         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, a);
<a name="l04198"></a>04198         
<a name="l04199"></a>04199         <span class="comment">/* test if rendering as a quad or triangle, skip wire */</span>
<a name="l04200"></a>04200         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)==0 &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> != <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>)) {
<a name="l04201"></a>04201             
<a name="l04202"></a>04202             <span class="comment">/* check if quad is actually triangle */</span>
<a name="l04203"></a>04203             v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l04204"></a>04204             v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l04205"></a>04205             v3= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l04206"></a>04206             v4= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04207"></a>04207             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04208"></a>04208             <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[0])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp;  <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[1])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[2])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> ) {
<a name="l04209"></a>04209                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= v2;
<a name="l04210"></a>04210                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v3;
<a name="l04211"></a>04211                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= v4;
<a name="l04212"></a>04212                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04213"></a>04213             }
<a name="l04214"></a>04214             <span class="keywordflow">else</span> {
<a name="l04215"></a>04215                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04216"></a>04216                 <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[0])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp;  <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[1])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[2])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> ) {
<a name="l04217"></a>04217                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= v3;
<a name="l04218"></a>04218                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= v4;
<a name="l04219"></a>04219                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04220"></a>04220                 }
<a name="l04221"></a>04221                 <span class="keywordflow">else</span> {
<a name="l04222"></a>04222                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04223"></a>04223                     <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[0])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp;  <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[1])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[2])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> ) {
<a name="l04224"></a>04224                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04225"></a>04225                     }
<a name="l04226"></a>04226                     <span class="keywordflow">else</span> {
<a name="l04227"></a>04227                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(nor, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04228"></a>04228                         <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[0])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp;  <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[1])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(nor[2])&lt;<a class="code" href="../../d2/d47/convertblender_8c.html#a9d9fc91dbaf632d18b68011ec3c71e53">FLT_EPSILON10</a> ) {
<a name="l04229"></a>04229                             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04230"></a>04230                         }
<a name="l04231"></a>04231                     }
<a name="l04232"></a>04232                 }
<a name="l04233"></a>04233             }
<a name="l04234"></a>04234             
<a name="l04235"></a>04235             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l04236"></a>04236                 
<a name="l04237"></a>04237                 <span class="comment">/* Face is divided along edge with the least gradient       */</span>
<a name="l04238"></a>04238                 <span class="comment">/* Flagged with R_DIVIDE_24 if divide is from vert 2 to 4   */</span>
<a name="l04239"></a>04239                 <span class="comment">/*      4---3       4---3 */</span>
<a name="l04240"></a>04240                 <span class="comment">/*      |\ 1|   or  |1 /| */</span>
<a name="l04241"></a>04241                 <span class="comment">/*      |0\ |       |/ 0| */</span>
<a name="l04242"></a>04242                 <span class="comment">/*      1---2       1---2   0 = orig face, 1 = new face */</span>
<a name="l04243"></a>04243                 
<a name="l04244"></a>04244                 <span class="comment">/* render normals are inverted in render! we calculate normal of single tria here */</span>
<a name="l04245"></a>04245                 flen= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04246"></a>04246                 <span class="keywordflow">if</span> (flen==0.0f) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04247"></a>04247                 
<a name="l04248"></a>04248                 xn = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>);
<a name="l04249"></a>04249 
<a name="l04250"></a>04250                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(xn) &lt; 0.999995f ) { <span class="comment">// checked on noisy fractal grid</span>
<a name="l04251"></a>04251                     
<a name="l04252"></a>04252                     <span class="keywordtype">float</span> d1, d2;
<a name="l04253"></a>04253 
<a name="l04254"></a>04254                     vlr1= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a82082dd8c88a849d3e98d7c532cf6f50">RE_vlakren_copy</a>(obr, vlr);
<a name="l04255"></a>04255                     vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab28027078d87215bd79ce8e046da84ff">R_FACE_SPLIT</a>;
<a name="l04256"></a>04256                     
<a name="l04257"></a>04257                     <span class="comment">/* split direction based on vnorms */</span>
<a name="l04258"></a>04258                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04259"></a>04259                     d1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04260"></a>04260 
<a name="l04261"></a>04261                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04262"></a>04262                     d2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a5a3f61df3fb5271547b5ff57facef654">n</a>);
<a name="l04263"></a>04263 
<a name="l04264"></a>04264                     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(d1) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(d2) ) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04265"></a>04265                     <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04266"></a>04266 
<a name="l04267"></a>04267                     <span class="comment">/* new vertex pointers */</span>
<a name="l04268"></a>04268                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>) {
<a name="l04269"></a>04269                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l04270"></a>04270                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l04271"></a>04271                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04272"></a>04272 
<a name="l04273"></a>04273                         vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a> = vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04274"></a>04274                         
<a name="l04275"></a>04275                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04276"></a>04276                     }
<a name="l04277"></a>04277                     <span class="keywordflow">else</span> {
<a name="l04278"></a>04278                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l04279"></a>04279                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l04280"></a>04280                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l04281"></a>04281                         
<a name="l04282"></a>04282                         vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04283"></a>04283                     }
<a name="l04284"></a>04284                     vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> = vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04285"></a>04285                     
<a name="l04286"></a>04286                     <span class="comment">/* new normals */</span>
<a name="l04287"></a>04287                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04288"></a>04288                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>,vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr1-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l04289"></a>04289                 }
<a name="l04290"></a>04290                 <span class="comment">/* clear the flag when not divided */</span>
<a name="l04291"></a>04291                 <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#ab385ee25cd397a129f7b8274347a20d1">R_DIVIDE_24</a>;
<a name="l04292"></a>04292             }
<a name="l04293"></a>04293         }
<a name="l04294"></a>04294     }
<a name="l04295"></a>04295 }
<a name="l04296"></a>04296 
<a name="l04297"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a2060dbdf74e5101dc5976a5d0b999580">04297</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a2060dbdf74e5101dc5976a5d0b999580">finalize_render_object</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> timeoffset)
<a name="l04298"></a>04298 {
<a name="l04299"></a>04299     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l04300"></a>04300     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04301"></a>04301     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04302"></a>04302     <a class="code" href="../../db/d4b/structStrandBound.html">StrandBound</a> *sbound= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04303"></a>04303     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], smin[3], smax[3];
<a name="l04304"></a>04304     <span class="keywordtype">int</span> a, b;
<a name="l04305"></a>04305 
<a name="l04306"></a>04306     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a> || obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a> || obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a> || obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>) {
<a name="l04307"></a>04307         <span class="comment">/* the exception below is because displace code now is in init_render_mesh call, </span>
<a name="l04308"></a>04308 <span class="comment">         * I will look at means to have autosmooth enabled for all object types</span>
<a name="l04309"></a>04309 <span class="comment">         * and have it as general postprocess, like displace */</span>
<a name="l04310"></a>04310         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a> &amp;&amp; <a class="code" href="../../d2/d47/convertblender_8c.html#afc4a5bc2d6b4770f1d4c077f75a246a4">test_for_displace</a>(re, ob))
<a name="l04311"></a>04311             <a class="code" href="../../d2/d47/convertblender_8c.html#abc6702a65404f735fccec4cac6a0be5c">do_displacement</a>(re, obr, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04312"></a>04312     
<a name="l04313"></a>04313         <span class="keywordflow">if</span> (!timeoffset) {
<a name="l04314"></a>04314             <span class="comment">/* phong normal interpolation can cause error in tracing</span>
<a name="l04315"></a>04315 <span class="comment">             * (terminator problem) */</span>
<a name="l04316"></a>04316             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a2cf2f167ccb0a07c33ae196131cac32a">smoothresh</a>= 0.0;
<a name="l04317"></a>04317             <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) &amp;&amp; (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>))
<a name="l04318"></a>04318                 <a class="code" href="../../d2/d47/convertblender_8c.html#a7ed82126c67fa82b008c512f036decfb">set_phong_threshold</a>(obr);
<a name="l04319"></a>04319             
<a name="l04320"></a>04320             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#ad644b8447f228800e1fcd1adfaafe076">R_BAKING</a> &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad175b3b42d5e1db00aa65146885a494d">bake_quad_split</a> != 0) {
<a name="l04321"></a>04321                 <span class="comment">/* Baking lets us define a quad split order */</span>
<a name="l04322"></a>04322                 <a class="code" href="../../d2/d47/convertblender_8c.html#ae32c4d57ffb713a00e1dbfdddb7b5087">split_quads</a>(obr, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad175b3b42d5e1db00aa65146885a494d">bake_quad_split</a>);
<a name="l04323"></a>04323             }
<a name="l04324"></a>04324             <span class="keywordflow">else</span> {
<a name="l04325"></a>04325                 <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad445d144465b42b6486adb0297fd77f8">R_SIMPLIFY</a> &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a6531d0e2cc7c3f23d96c8289932c0684">simplify_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a863ea576d4dcd2b4f3da28c319356f48">R_SIMPLE_NO_TRIANGULATE</a>) == 0)
<a name="l04326"></a>04326                     <a class="code" href="../../d2/d47/convertblender_8c.html#adb6fc8d40185c460da72949dd9a21230">check_non_flat_quads</a>(obr);
<a name="l04327"></a>04327             }
<a name="l04328"></a>04328             
<a name="l04329"></a>04329             <a class="code" href="../../d2/d47/convertblender_8c.html#a07f7d476bf43d1d0e733afaca8eeab30">set_fullsample_trace_flag</a>(re, obr);
<a name="l04330"></a>04330 
<a name="l04331"></a>04331             <span class="comment">/* compute bounding boxes for clipping */</span>
<a name="l04332"></a>04332             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l04333"></a>04333             <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l04334"></a>04334                 <span class="keywordflow">if</span> ((a &amp; 255)==0) ver= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae182ad2642ffd40fa7b4457bb5f857fe">vertnodes</a>[a&gt;&gt;8].<a class="code" href="../../d3/d86/structVertTableNode.html#a1e7b72f1c711cb5e6e7938bd839c86aa">vert</a>;
<a name="l04335"></a>04335                 <span class="keywordflow">else</span> ver++;
<a name="l04336"></a>04336 
<a name="l04337"></a>04337                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, min, max);
<a name="l04338"></a>04338             }
<a name="l04339"></a>04339 
<a name="l04340"></a>04340             <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>) {
<a name="l04341"></a>04341                 <span class="keywordtype">float</span> width;
<a name="l04342"></a>04342                 
<a name="l04343"></a>04343                 <span class="comment">/* compute average bounding box of strandpoint itself (width) */</span>
<a name="l04344"></a>04344                 <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ad4c20ea25767776b4e98e9302dcfc9ca">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57ef394e8a613e63da8a0734424c5627">R_STRAND_B_UNITS</a>)
<a name="l04345"></a>04345                     obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#adc27b2e50869f389b7a34e804845acac">maxwidth</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa72afccc378741af6e29de2e20084420">strand_sta</a>, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac6a6784cdee68d2bafdea858c57dffcd">strand_end</a>);
<a name="l04346"></a>04346                 <span class="keywordflow">else</span>
<a name="l04347"></a>04347                     obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#adc27b2e50869f389b7a34e804845acac">maxwidth</a>= 0.0f;
<a name="l04348"></a>04348                 
<a name="l04349"></a>04349                 width= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#adc27b2e50869f389b7a34e804845acac">maxwidth</a>;
<a name="l04350"></a>04350                 sbound= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>;
<a name="l04351"></a>04351                 <span class="keywordflow">for</span> (b=0; b&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>; b++, sbound++) {
<a name="l04352"></a>04352                     
<a name="l04353"></a>04353                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(smin, smax);
<a name="l04354"></a>04354 
<a name="l04355"></a>04355                     <span class="keywordflow">for</span> (a=sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#ab08575b8cb6f47ae376afa33239360f6">start</a>; a&lt;sbound-&gt;end; a++) {
<a name="l04356"></a>04356                         strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, a);
<a name="l04357"></a>04357                         <a class="code" href="../../d3/dda/strand_8h.html#a9b7689ad448361a2258a0c0dfe82bf3c">strand_minmax</a>(strand, smin, smax, width);
<a name="l04358"></a>04358                     }
<a name="l04359"></a>04359 
<a name="l04360"></a>04360                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#a10cefb70292f40dc1d2ff66530c5e4b4">boundbox</a>[0], smin);
<a name="l04361"></a>04361                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#a10cefb70292f40dc1d2ff66530c5e4b4">boundbox</a>[1], smax);
<a name="l04362"></a>04362 
<a name="l04363"></a>04363                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(smin, min, max);
<a name="l04364"></a>04364                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(smax, min, max);
<a name="l04365"></a>04365                 }
<a name="l04366"></a>04366             }
<a name="l04367"></a>04367 
<a name="l04368"></a>04368             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>[0], min);
<a name="l04369"></a>04369             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>[1], max);
<a name="l04370"></a>04370         }
<a name="l04371"></a>04371     }
<a name="l04372"></a>04372 }
<a name="l04373"></a>04373 
<a name="l04374"></a>04374 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04375"></a>04375 <span class="comment">/* Database                                                                  */</span>
<a name="l04376"></a>04376 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l04377"></a>04377 
<a name="l04378"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a0f53be682144c6ed920b202801dd9523">04378</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a0f53be682144c6ed920b202801dd9523">render_object_type</a>(<span class="keywordtype">short</span> type)
<a name="l04379"></a>04379 {
<a name="l04380"></a>04380     <span class="keywordflow">return</span> <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#abf9f4da65997948a5d69c7195223897d">OB_TYPE_SUPPORT_MATERIAL</a>(type);
<a name="l04381"></a>04381 }
<a name="l04382"></a>04382 
<a name="l04383"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">04383</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">find_dupli_instances</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l04384"></a>04384 {
<a name="l04385"></a>04385     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l04386"></a>04386     <span class="keywordtype">float</span> imat[4][4], obmat[4][4], obimat[4][4], nmat[3][3];
<a name="l04387"></a>04387     <span class="keywordtype">int</span> first = 1;
<a name="l04388"></a>04388 
<a name="l04389"></a>04389     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af39643195728d6a3c31151d5a1511251">obmat</a>);
<a name="l04390"></a>04390     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, obmat);
<a name="l04391"></a>04391 
<a name="l04392"></a>04392     <span class="comment">/* for objects instanced by dupliverts/faces/particles, we go over the</span>
<a name="l04393"></a>04393 <span class="comment">     * list of instances to find ones that instance obr, and setup their</span>
<a name="l04394"></a>04394 <span class="comment">     * matrices and obr pointer */</span>
<a name="l04395"></a>04395     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a2577fdbc6e3c370d60e222b2a098c0e4">prev</a>) {
<a name="l04396"></a>04396         <span class="keywordflow">if</span> (!obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a> &amp;&amp; obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a> == obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> &amp;&amp; obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a6427c8a18ce573b5b14c2bf981ee1a50">psysindex</a> == obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a245dab06151bbbb39c27187f9d853dd9">psysindex</a>) {
<a name="l04397"></a>04397             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>= obr;
<a name="l04398"></a>04398 
<a name="l04399"></a>04399             <span class="comment">/* compute difference between object matrix and</span>
<a name="l04400"></a>04400 <span class="comment">             * object matrix with dupli transform, in viewspace */</span>
<a name="l04401"></a>04401             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obimat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l04402"></a>04402             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, obimat, imat);
<a name="l04403"></a>04403 
<a name="l04404"></a>04404             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(nmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l04405"></a>04405             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, nmat);
<a name="l04406"></a>04406             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>);
<a name="l04407"></a>04407 
<a name="l04408"></a>04408             <span class="keywordflow">if</span> (!first) {
<a name="l04409"></a>04409                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l04410"></a>04410                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l04411"></a>04411                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>;
<a name="l04412"></a>04412                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>;
<a name="l04413"></a>04413             }
<a name="l04414"></a>04414             <span class="keywordflow">else</span>
<a name="l04415"></a>04415                 first= 0;
<a name="l04416"></a>04416         }
<a name="l04417"></a>04417     }
<a name="l04418"></a>04418 }
<a name="l04419"></a>04419 
<a name="l04420"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a2fe8c9b3f364ee811219cbfc1653e5fe">04420</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a2fe8c9b3f364ee811219cbfc1653e5fe">assign_dupligroup_dupli</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr)
<a name="l04421"></a>04421 {
<a name="l04422"></a>04422     <span class="keywordtype">float</span> imat[4][4], obmat[4][4], obimat[4][4], nmat[3][3];
<a name="l04423"></a>04423 
<a name="l04424"></a>04424     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af39643195728d6a3c31151d5a1511251">obmat</a>);
<a name="l04425"></a>04425     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, obmat);
<a name="l04426"></a>04426 
<a name="l04427"></a>04427     obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>= obr;
<a name="l04428"></a>04428 
<a name="l04429"></a>04429     <span class="comment">/* compute difference between object matrix and</span>
<a name="l04430"></a>04430 <span class="comment">     * object matrix with dupli transform, in viewspace */</span>
<a name="l04431"></a>04431     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obimat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l04432"></a>04432     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, obimat, imat);
<a name="l04433"></a>04433 
<a name="l04434"></a>04434     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(nmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l04435"></a>04435     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, nmat);
<a name="l04436"></a>04436     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>);
<a name="l04437"></a>04437 
<a name="l04438"></a>04438     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l04439"></a>04439     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l04440"></a>04440     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>;
<a name="l04441"></a>04441     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>;
<a name="l04442"></a>04442 }
<a name="l04443"></a>04443 
<a name="l04444"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a40b7ba47972ad8a236a5a048c6705188">04444</a> <span class="keyword">static</span> <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *<a class="code" href="../../d2/d47/convertblender_8c.html#a40b7ba47972ad8a236a5a048c6705188">find_dupligroup_dupli</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> psysindex)
<a name="l04445"></a>04445 {
<a name="l04446"></a>04446     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l04447"></a>04447 
<a name="l04448"></a>04448     <span class="comment">/* if the object is itself instanced, we don&#39;t want to create an instance</span>
<a name="l04449"></a>04449 <span class="comment">     * for it */</span>
<a name="l04450"></a>04450     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)
<a name="l04451"></a>04451         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04452"></a>04452 
<a name="l04453"></a>04453     <span class="comment">/* try to find an object that was already created so we can reuse it</span>
<a name="l04454"></a>04454 <span class="comment">     * and save memory */</span>
<a name="l04455"></a>04455     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>)
<a name="l04456"></a>04456         <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> == ob &amp;&amp; obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a245dab06151bbbb39c27187f9d853dd9">psysindex</a> == psysindex &amp;&amp; (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a1454c50819431b7b18d8ef84ee494784">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#aeb7210f61bce559cd668c34e6bcaa3ac">R_INSTANCEABLE</a>))
<a name="l04457"></a>04457             <span class="keywordflow">return</span> obr;
<a name="l04458"></a>04458     
<a name="l04459"></a>04459     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04460"></a>04460 }
<a name="l04461"></a>04461 
<a name="l04462"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">04462</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob)
<a name="l04463"></a>04463 {
<a name="l04464"></a>04464     <span class="comment">/* For duplis we need to have a matrix that transform the coordinate back</span>
<a name="l04465"></a>04465 <span class="comment">     * to it&#39;s original position, without the dupli transforms. We also check</span>
<a name="l04466"></a>04466 <span class="comment">     * the matrix is actually needed, to save memory on lots of dupliverts for</span>
<a name="l04467"></a>04467 <span class="comment">     * example */</span>
<a name="l04468"></a>04468     <span class="keyword">static</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *lastob= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04469"></a>04469     <span class="keyword">static</span> <span class="keywordtype">int</span> needtexmat= 0;
<a name="l04470"></a>04470 
<a name="l04471"></a>04471     <span class="comment">/* init */</span>
<a name="l04472"></a>04472     <span class="keywordflow">if</span> (!re) {
<a name="l04473"></a>04473         lastob= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04474"></a>04474         needtexmat= 0;
<a name="l04475"></a>04475         <span class="keywordflow">return</span>;
<a name="l04476"></a>04476     }
<a name="l04477"></a>04477 
<a name="l04478"></a>04478     <span class="comment">/* check if we actually need it */</span>
<a name="l04479"></a>04479     <span class="keywordflow">if</span> (lastob != dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>) {
<a name="l04480"></a>04480         <a class="code" href="../../d2/d10/structMaterial.html">Material</a> ***material;
<a name="l04481"></a>04481         <span class="keywordtype">short</span> a, *totmaterial;
<a name="l04482"></a>04482 
<a name="l04483"></a>04483         lastob= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>;
<a name="l04484"></a>04484         needtexmat= 0;
<a name="l04485"></a>04485 
<a name="l04486"></a>04486         totmaterial= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a11593c21969f7c374bb82b5aa75630b3">give_totcolp</a>(dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>);
<a name="l04487"></a>04487         material= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a3c6ad3e5c07858e4809487fc11af38eb">give_matarar</a>(dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>);
<a name="l04488"></a>04488 
<a name="l04489"></a>04489         <span class="keywordflow">if</span> (totmaterial &amp;&amp; material)
<a name="l04490"></a>04490             <span class="keywordflow">for</span> (a= 0; a&lt;*totmaterial; a++)
<a name="l04491"></a>04491                 <span class="keywordflow">if</span> ((*material)[a] &amp;&amp; (*material)[a]-&gt;texco &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>)
<a name="l04492"></a>04492                     needtexmat= 1;
<a name="l04493"></a>04493     }
<a name="l04494"></a>04494 
<a name="l04495"></a>04495     <span class="keywordflow">if</span> (needtexmat) {
<a name="l04496"></a>04496         <span class="keywordtype">float</span> imat[4][4];
<a name="l04497"></a>04497 
<a name="l04498"></a>04498         obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*4*4);
<a name="l04499"></a>04499         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>);
<a name="l04500"></a>04500         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af547c5e7af68fd96cdfa4614bd77d47e">omat</a>, imat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, 0, 0, 0, 0);
<a name="l04501"></a>04501     }
<a name="l04502"></a>04502 }
<a name="l04503"></a>04503 
<a name="l04504"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a4ba453fb763e9423f70125e8ef7cfc5a">04504</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a4ba453fb763e9423f70125e8ef7cfc5a">init_render_object_data</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <span class="keywordtype">int</span> timeoffset)
<a name="l04505"></a>04505 {
<a name="l04506"></a>04506     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l04507"></a>04507     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l04508"></a>04508     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l04509"></a>04509 
<a name="l04510"></a>04510     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a245dab06151bbbb39c27187f9d853dd9">psysindex</a>) {
<a name="l04511"></a>04511         <span class="keywordflow">if</span> ((!obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a7d7441e44c538ffa5e61534bea3e4bc8">prev</a> || obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a7d7441e44c538ffa5e61534bea3e4bc8">prev</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> != ob || (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a7d7441e44c538ffa5e61534bea3e4bc8">prev</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a1454c50819431b7b18d8ef84ee494784">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#aeb7210f61bce559cd668c34e6bcaa3ac">R_INSTANCEABLE</a>)==0) &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l04512"></a>04512             <span class="comment">/* the emitter mesh wasn&#39;t rendered so the modifier stack wasn&#39;t</span>
<a name="l04513"></a>04513 <span class="comment">             * evaluated with render settings */</span>
<a name="l04514"></a>04514             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l04515"></a>04515             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aeade9a199706a910fa3a5593b49cdbdf">mesh_create_derived_render</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob,  <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>);
<a name="l04516"></a>04516             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l04517"></a>04517         }
<a name="l04518"></a>04518 
<a name="l04519"></a>04519         <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i=0; i&lt;obr-&gt;psysindex-1; i++)
<a name="l04520"></a>04520             psys= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>;
<a name="l04521"></a>04521 
<a name="l04522"></a>04522         <a class="code" href="../../d2/d47/convertblender_8c.html#a695399c6e10af233bb3699755d086647">render_new_particle_system</a>(re, obr, psys, timeoffset);
<a name="l04523"></a>04523     }
<a name="l04524"></a>04524     <span class="keywordflow">else</span> {
<a name="l04525"></a>04525         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1a94162b6fc469957966a01d41ff71d6">OB_FONT</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>))
<a name="l04526"></a>04526             <a class="code" href="../../d2/d47/convertblender_8c.html#aecb220b4d49e353cd53e4ca3d06e65ac">init_render_curve</a>(re, obr, timeoffset);
<a name="l04527"></a>04527         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)
<a name="l04528"></a>04528             <a class="code" href="../../d2/d47/convertblender_8c.html#a39a542087b3fed2aee3fbcbe27d49a25">init_render_surf</a>(re, obr, timeoffset);
<a name="l04529"></a>04529         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>)
<a name="l04530"></a>04530             <a class="code" href="../../d2/d47/convertblender_8c.html#ae8d18d77515c50e29ab388166d065a57">init_render_mesh</a>(re, obr, timeoffset);
<a name="l04531"></a>04531         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a046d883c32490b5c5ca4c5e7b6504e35">OB_MBALL</a>)
<a name="l04532"></a>04532             <a class="code" href="../../d2/d47/convertblender_8c.html#af77ff76cb463a4ae9676699b05049082">init_render_mball</a>(re, obr);
<a name="l04533"></a>04533     }
<a name="l04534"></a>04534 
<a name="l04535"></a>04535     <a class="code" href="../../d2/d47/convertblender_8c.html#a2060dbdf74e5101dc5976a5d0b999580">finalize_render_object</a>(re, obr, timeoffset);
<a name="l04536"></a>04536 
<a name="l04537"></a>04537     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l04538"></a>04538     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>;
<a name="l04539"></a>04539     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>;
<a name="l04540"></a>04540     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a> += obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>;
<a name="l04541"></a>04541 }
<a name="l04542"></a>04542 
<a name="l04543"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a33907936ac25fea1aef8798cea5d4482">04543</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a33907936ac25fea1aef8798cea5d4482">add_render_object</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *par, <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob, <span class="keywordtype">int</span> timeoffset)
<a name="l04544"></a>04544 {
<a name="l04545"></a>04545     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l04546"></a>04546     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l04547"></a>04547     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l04548"></a>04548     <span class="keywordtype">int</span> show_emitter, allow_render= 1, index, psysindex, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l04549"></a>04549 
<a name="l04550"></a>04550     index= (dob)? dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a47a802d4d6b9602f04097c6ee5562f3b">index</a>: 0;
<a name="l04551"></a>04551 
<a name="l04552"></a>04552     <span class="comment">/* the emitter has to be processed first (render levels of modifiers) */</span>
<a name="l04553"></a>04553     <span class="comment">/* so here we only check if the emitter should be rendered */</span>
<a name="l04554"></a>04554     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l04555"></a>04555         show_emitter= 0;
<a name="l04556"></a>04556         <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l04557"></a>04557             show_emitter += psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ae7a7916f69a4fc69561faf787f6160c7">draw</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a02fd6ffe389911bce7838d256312b383">PART_DRAW_EMITTER</a>;
<a name="l04558"></a>04558             <a class="code" href="../../db/dca/BKE__particle_8h.html#a2ff8a19d90143549c1f412cb457dfc89">psys_render_set</a>(ob, psys, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>, timeoffset);
<a name="l04559"></a>04559         }
<a name="l04560"></a>04560 
<a name="l04561"></a>04561         <span class="comment">/* if no psys has &quot;show emitter&quot; selected don&#39;t render emitter */</span>
<a name="l04562"></a>04562         <span class="keywordflow">if</span> (show_emitter == 0)
<a name="l04563"></a>04563             allow_render= 0;
<a name="l04564"></a>04564     }
<a name="l04565"></a>04565 
<a name="l04566"></a>04566     <span class="comment">/* one render object for the data itself */</span>
<a name="l04567"></a>04567     <span class="keywordflow">if</span> (allow_render) {
<a name="l04568"></a>04568         obr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a7ed1c61a9f360b6f0d29e5cdc7f77ff5">RE_addRenderObject</a>(re, ob, par, index, 0, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04569"></a>04569         <span class="keywordflow">if</span> ((dob &amp;&amp; !dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#aea68a9daf208f633c3028a360e6c0230">animated</a>) || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)) {
<a name="l04570"></a>04570             obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a1454c50819431b7b18d8ef84ee494784">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#aeb7210f61bce559cd668c34e6bcaa3ac">R_INSTANCEABLE</a>;
<a name="l04571"></a>04571             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af39643195728d6a3c31151d5a1511251">obmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l04572"></a>04572         }
<a name="l04573"></a>04573         <a class="code" href="../../d2/d47/convertblender_8c.html#a4ba453fb763e9423f70125e8ef7cfc5a">init_render_object_data</a>(re, obr, timeoffset);
<a name="l04574"></a>04574 
<a name="l04575"></a>04575         <span class="comment">/* only add instance for objects that have not been used for dupli */</span>
<a name="l04576"></a>04576         <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)) {
<a name="l04577"></a>04577             obi= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a20f6a35f7d49aed6a73bb33146d7102c">RE_addRenderInstance</a>(re, obr, ob, par, index, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04578"></a>04578             <span class="keywordflow">if</span> (dob) <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(re, obi, dob);
<a name="l04579"></a>04579         }
<a name="l04580"></a>04580         <span class="keywordflow">else</span>
<a name="l04581"></a>04581             <a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">find_dupli_instances</a>(re, obr);
<a name="l04582"></a>04582             
<a name="l04583"></a>04583         <span class="keywordflow">for</span> (i=1; i&lt;=ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; i++) {
<a name="l04584"></a>04584             <a class="code" href="../../d2/d10/structMaterial.html">Material</a>* ma = <a class="code" href="../../d2/d47/convertblender_8c.html#a654bc184ee1712a4e6945a366ccd127b">give_render_material</a>(re, ob, i);
<a name="l04585"></a>04585             <span class="keywordflow">if</span> (ma &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>)
<a name="l04586"></a>04586                 <a class="code" href="../../d2/d47/convertblender_8c.html#a96bb94d8202b999446003a7213674c3f">add_volume</a>(re, obr, ma);
<a name="l04587"></a>04587         }
<a name="l04588"></a>04588     }
<a name="l04589"></a>04589 
<a name="l04590"></a>04590     <span class="comment">/* and one render object per particle system */</span>
<a name="l04591"></a>04591     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l04592"></a>04592         psysindex= 1;
<a name="l04593"></a>04593         <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>, psysindex++) {
<a name="l04594"></a>04594             obr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a7ed1c61a9f360b6f0d29e5cdc7f77ff5">RE_addRenderObject</a>(re, ob, par, index, psysindex, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04595"></a>04595             <span class="keywordflow">if</span> ((dob &amp;&amp; !dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#aea68a9daf208f633c3028a360e6c0230">animated</a>) || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)) {
<a name="l04596"></a>04596                 obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a1454c50819431b7b18d8ef84ee494784">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#aeb7210f61bce559cd668c34e6bcaa3ac">R_INSTANCEABLE</a>;
<a name="l04597"></a>04597                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af39643195728d6a3c31151d5a1511251">obmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l04598"></a>04598             }
<a name="l04599"></a>04599             <span class="keywordflow">if</span> (dob)
<a name="l04600"></a>04600                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8b8c8709faf8d9e56ae92e3a3b1b5c22">PSYS_USE_IMAT</a>;
<a name="l04601"></a>04601             <a class="code" href="../../d2/d47/convertblender_8c.html#a4ba453fb763e9423f70125e8ef7cfc5a">init_render_object_data</a>(re, obr, timeoffset);
<a name="l04602"></a>04602             <a class="code" href="../../db/dca/BKE__particle_8h.html#a3bbe6d899d3310546735f082b57bc78f">psys_render_restore</a>(ob, psys);
<a name="l04603"></a>04603             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a947c785248ab9746099a34c8bc093e8f">flag</a> &amp;= ~<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a8b8c8709faf8d9e56ae92e3a3b1b5c22">PSYS_USE_IMAT</a>;
<a name="l04604"></a>04604 
<a name="l04605"></a>04605             <span class="comment">/* only add instance for objects that have not been used for dupli */</span>
<a name="l04606"></a>04606             <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)) {
<a name="l04607"></a>04607                 obi= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a20f6a35f7d49aed6a73bb33146d7102c">RE_addRenderInstance</a>(re, obr, ob, par, index, psysindex, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04608"></a>04608                 <span class="keywordflow">if</span> (dob) <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(re, obi, dob);
<a name="l04609"></a>04609             }
<a name="l04610"></a>04610             <span class="keywordflow">else</span>
<a name="l04611"></a>04611                 <a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">find_dupli_instances</a>(re, obr);
<a name="l04612"></a>04612         }
<a name="l04613"></a>04613     }
<a name="l04614"></a>04614 }
<a name="l04615"></a>04615 
<a name="l04616"></a>04616 <span class="comment">/* par = pointer to duplicator parent, needed for object lookup table */</span>
<a name="l04617"></a>04617 <span class="comment">/* index = when duplicater copies same object (particle), the counter */</span>
<a name="l04618"></a><a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">04618</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *par, <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob, <span class="keywordtype">int</span> timeoffset)
<a name="l04619"></a>04619 {
<a name="l04620"></a>04620     <span class="keyword">static</span> <span class="keywordtype">double</span> lasttime= 0.0;
<a name="l04621"></a>04621     <span class="keywordtype">double</span> time;
<a name="l04622"></a>04622     <span class="keywordtype">float</span> mat[4][4];
<a name="l04623"></a>04623 
<a name="l04624"></a>04624     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>)
<a name="l04625"></a>04625         <a class="code" href="../../d2/d47/convertblender_8c.html#adadc53503b72b3ba8f5fd6ccffd4fe0a">add_render_lamp</a>(re, ob);
<a name="l04626"></a>04626     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0f53be682144c6ed920b202801dd9523">render_object_type</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>))
<a name="l04627"></a>04627         <a class="code" href="../../d2/d47/convertblender_8c.html#a33907936ac25fea1aef8798cea5d4482">add_render_object</a>(re, ob, par, dob, timeoffset);
<a name="l04628"></a>04628     <span class="keywordflow">else</span> {
<a name="l04629"></a>04629         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l04630"></a>04630         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l04631"></a>04631     }
<a name="l04632"></a>04632     
<a name="l04633"></a>04633     time= <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l04634"></a>04634     <span class="keywordflow">if</span> (time - lasttime &gt; 1.0) {
<a name="l04635"></a>04635         lasttime= time;
<a name="l04636"></a>04636         <span class="comment">/* clumsy copying still */</span>
<a name="l04637"></a>04637         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae66d39447c70cfc439ad8a4ad7a45cbc">totvert</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>;
<a name="l04638"></a>04638         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a691be84fe09cfa55d24a0d19dc4e3acc">totface</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>;
<a name="l04639"></a>04639         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a516984d7536ef7735ebcda7bfa1780a9">totstrand</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>;
<a name="l04640"></a>04640         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a4ad78695c78823cc0904c46fe266eaa0">tothalo</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>;
<a name="l04641"></a>04641         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a8186aea4bf851b2647eb2ce5ed419159">totlamp</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>;
<a name="l04642"></a>04642         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l04643"></a>04643     }
<a name="l04644"></a>04644 
<a name="l04645"></a>04645     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1c1ed6161d5bbdeda432f34e6758050b">OB_DONE</a>;
<a name="l04646"></a>04646 }
<a name="l04647"></a>04647 
<a name="l04648"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af196f0770dbe77f2d5ad85519f5da7ed">04648</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b3a3e3c89e9a1cf1dfe2f410be89067">RE_Database_Free</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l04649"></a>04649 {
<a name="l04650"></a>04650     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l04651"></a>04651     
<a name="l04652"></a>04652     <span class="comment">/* statistics for debugging render memory usage */</span>
<a name="l04653"></a>04653     <span class="keywordflow">if</span> ((<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) &amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering)) {
<a name="l04654"></a>04654         <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad40c9887f83dc3ac92440b0895ae2413">R_PREVIEWBUTS</a>)==0) {
<a name="l04655"></a>04655             <a class="code" href="../../d2/d77/BKE__image_8h.html#abe47c60e8fc373818be4e1472dd6633a">BKE_image_print_memlist</a>();
<a name="l04656"></a>04656             <a class="code" href="../../da/d2b/mallocn_8c.html#a33020bab7753c42267aa76f77d105b03">MEM_printmemlist_stats</a>();
<a name="l04657"></a>04657         }
<a name="l04658"></a>04658     }
<a name="l04659"></a>04659 
<a name="l04660"></a>04660     <span class="comment">/* FREE */</span>
<a name="l04661"></a>04661     
<a name="l04662"></a>04662     <span class="keywordflow">for</span> (lar= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>) {
<a name="l04663"></a>04663         <a class="code" href="../../d9/d30/shadbuf_8h.html#a3b4d8f31d04b053984b2e3249f369871">freeshadowbuf</a>(lar);
<a name="l04664"></a>04664         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>);
<a name="l04665"></a>04665         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a860a59b39afa231fbffc678adef05b9a">shadsamp</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a860a59b39afa231fbffc678adef05b9a">shadsamp</a>);
<a name="l04666"></a>04666         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>);
<a name="l04667"></a>04667         <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a2814c1eea529822b51a36d9cfe3348cf">curvemapping_free</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a23d95b62c92cf51999ddb7e90adcdf8a">curfalloff</a>);
<a name="l04668"></a>04668     }
<a name="l04669"></a>04669     
<a name="l04670"></a>04670     <a class="code" href="../../dd/d62/volume__precache_8h.html#ac49ddf8a41365de1572182ee680a0a96">free_volume_precache</a>(re);
<a name="l04671"></a>04671     
<a name="l04672"></a>04672     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>);
<a name="l04673"></a>04673     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>);
<a name="l04674"></a>04674 
<a name="l04675"></a>04675     <a class="code" href="../../d0/db6/renderdatabase_8h.html#aa31d3bdf71c7c37a02593c3d99498dce">free_renderdata_tables</a>(re);
<a name="l04676"></a>04676 
<a name="l04677"></a>04677     <span class="comment">/* free orco */</span>
<a name="l04678"></a>04678     <a class="code" href="../../d2/d47/convertblender_8c.html#a677d2d504a3dc8d8ab8e0290a8ca4dd6">free_mesh_orco_hash</a>(re);
<a name="l04679"></a>04679 
<a name="l04680"></a>04680     <a class="code" href="../../d4/d0f/BKE__material_8h.html#a9795cb87ab85954629b14b004ae51627">end_render_materials</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>);
<a name="l04681"></a>04681     <a class="code" href="../../df/dba/texture_8h.html#ae701010fc53f6c8667857175f4f30563">end_render_textures</a>(re);
<a name="l04682"></a>04682     
<a name="l04683"></a>04683     <a class="code" href="../../d7/def/pointdensity_8h.html#aae3df5f1c0e86cf378617a4fcc91aa70">free_pointdensities</a>(re);
<a name="l04684"></a>04684     
<a name="l04685"></a>04685     <a class="code" href="../../d2/d47/convertblender_8c.html#a1c9718caa2b6e9b4e152fb9e2a67ce2e">free_camera_inside_volumes</a>(re);
<a name="l04686"></a>04686     
<a name="l04687"></a>04687     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>) {
<a name="l04688"></a>04688         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>);
<a name="l04689"></a>04689         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04690"></a>04690         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#ae365703ea53ec2d556d10fecc31b67ac">aosphere</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04691"></a>04691     }
<a name="l04692"></a>04692     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#acedba6a8263913d2e7662b0b430a36f3">aotables</a>) {
<a name="l04693"></a>04693         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#acedba6a8263913d2e7662b0b430a36f3">aotables</a>);
<a name="l04694"></a>04694         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#acedba6a8263913d2e7662b0b430a36f3">aotables</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04695"></a>04695         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#acedba6a8263913d2e7662b0b430a36f3">aotables</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04696"></a>04696     }
<a name="l04697"></a>04697     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>)
<a name="l04698"></a>04698         <a class="code" href="../../d0/d0e/rendercore_8h.html#a3446cf8963a286e4e6b0a9a4cdec2c61">free_render_qmcsampler</a>(re);
<a name="l04699"></a>04699     
<a name="l04700"></a>04700     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) <a class="code" href="../../d0/d0e/rendercore_8h.html#a656d598b93806e92c9723b93472b5bac">freeraytree</a>(re);
<a name="l04701"></a>04701 
<a name="l04702"></a>04702     <a class="code" href="../../d8/d59/sss_8h.html#ad5dc7181f73c80be2534cd75c417e405">free_sss</a>(re);
<a name="l04703"></a>04703     <a class="code" href="../../d2/d3a/occlusion_8h.html#aea80338f1dca4aa15fca8a840ab4a071">free_occ</a>(re);
<a name="l04704"></a>04704     <a class="code" href="../../d3/dda/strand_8h.html#a4a7c6760f1d3ef525640a5f91361de04">free_strand_surface</a>(re);
<a name="l04705"></a>04705     
<a name="l04706"></a>04706     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= 0;
<a name="l04707"></a>04707     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a6a2735f0c780f3e70f61d8f029cf8267">convertdone</a>= 0;
<a name="l04708"></a>04708 
<a name="l04709"></a>04709     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae00733601196d3bd9e10548085b691f8">bakebuf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04710"></a>04710 
<a name="l04711"></a>04711     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>)
<a name="l04712"></a>04712         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a79bc73354817e1a8e8ae270dc8edc5f7">R_FREE_IMAGE</a>)
<a name="l04713"></a>04713             <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad40c9887f83dc3ac92440b0895ae2413">R_PREVIEWBUTS</a>)==0)
<a name="l04714"></a>04714                 <a class="code" href="../../d2/d77/BKE__image_8h.html#a72aac25ba73ae00c116e01b8c4efab8e">BKE_image_free_all_textures</a>();
<a name="l04715"></a>04715 
<a name="l04716"></a>04716     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a>) {
<a name="l04717"></a>04717         <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a>);
<a name="l04718"></a>04718         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04719"></a>04719     }
<a name="l04720"></a>04720 }
<a name="l04721"></a>04721 
<a name="l04722"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">04722</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> nolamps, <span class="keywordtype">int</span> onlyselected, <a class="code" href="../../de/de7/structObject.html">Object</a> *actob)
<a name="l04723"></a>04723 {
<a name="l04724"></a>04724     <span class="comment">/* override not showing object when duplis are used with particles */</span>
<a name="l04725"></a>04725     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a4bbbd0230e5c35a5d939a40131bd2df1">OB_DUPLIPARTS</a>)
<a name="l04726"></a>04726         ; <span class="comment">/* let particle system(s) handle showing vs. not showing */</span>
<a name="l04727"></a>04727     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) &amp;&amp; !(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a6c3422f0e1693e138649fc704384429b">OB_DUPLIFRAMES</a>))
<a name="l04728"></a>04728         <span class="keywordflow">return</span> 0;
<a name="l04729"></a>04729     
<a name="l04730"></a>04730     <span class="comment">/* don&#39;t add non-basic meta objects, ends up having renderobjects with no geometry */</span>
<a name="l04731"></a>04731     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a046d883c32490b5c5ca4c5e7b6504e35">OB_MBALL</a> &amp;&amp; ob!=<a class="code" href="../../df/dae/BKE__mball_8h.html#acd6cd7889caaf039ef167e52af35639a" title="This function finds basic MetaBall.">find_basis_mball</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob))
<a name="l04732"></a>04732         <span class="keywordflow">return</span> 0;
<a name="l04733"></a>04733     
<a name="l04734"></a>04734     <span class="keywordflow">if</span> (nolamps &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>))
<a name="l04735"></a>04735         <span class="keywordflow">return</span> 0;
<a name="l04736"></a>04736     
<a name="l04737"></a>04737     <span class="keywordflow">if</span> (onlyselected &amp;&amp; (ob!=actob &amp;&amp; !(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>)))
<a name="l04738"></a>04738         <span class="keywordflow">return</span> 0;
<a name="l04739"></a>04739     
<a name="l04740"></a>04740     <span class="keywordflow">return</span> 1;
<a name="l04741"></a>04741 }
<a name="l04742"></a>04742 
<a name="l04743"></a><a class="code" href="../../d2/d47/convertblender_8c.html#acb837997b7d341d627a0eb94ee01313d">04743</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#acb837997b7d341d627a0eb94ee01313d">allow_render_dupli_instance</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob, <a class="code" href="../../de/de7/structObject.html">Object</a> *obd)
<a name="l04744"></a>04744 {
<a name="l04745"></a>04745     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l04746"></a>04746     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l04747"></a>04747     <span class="keywordtype">short</span> a, *totmaterial;
<a name="l04748"></a>04748 
<a name="l04749"></a>04749     <span class="comment">/* don&#39;t allow objects with halos. we need to have</span>
<a name="l04750"></a>04750 <span class="comment">     * all halo&#39;s to sort them globally in advance */</span>
<a name="l04751"></a>04751     totmaterial= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a11593c21969f7c374bb82b5aa75630b3">give_totcolp</a>(obd);
<a name="l04752"></a>04752 
<a name="l04753"></a>04753     <span class="keywordflow">if</span> (totmaterial) {
<a name="l04754"></a>04754         <span class="keywordflow">for</span> (a= 0; a&lt;*totmaterial; a++) {
<a name="l04755"></a>04755             ma= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(obd, a);
<a name="l04756"></a>04756             <span class="keywordflow">if</span> (ma &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a263f8a32d8cbe3456366b40cb01deab1">MA_TYPE_HALO</a>))
<a name="l04757"></a>04757                 <span class="keywordflow">return</span> 0;
<a name="l04758"></a>04758         }
<a name="l04759"></a>04759     }
<a name="l04760"></a>04760 
<a name="l04761"></a>04761     <span class="keywordflow">for</span> (psys=obd-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>)
<a name="l04762"></a>04762         <span class="keywordflow">if</span> (!<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a94fe4335845faafd0b969e89a13d8c76">ELEM5</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ae46a1d9cf35516920db6554623ff6369">PART_DRAW_BB</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0095bb5a5fb10ba1e61d296723c451ff">PART_DRAW_LINE</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a0a6e2b5b7e3602b7647433415494031d">PART_DRAW_PATH</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2506fdc9f159583f812c900402c5ec54">PART_DRAW_OB</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ababc8a40b78ea25bfdb9cd7b85c83f19">PART_DRAW_GR</a>))
<a name="l04763"></a>04763             <span class="keywordflow">return</span> 0;
<a name="l04764"></a>04764 
<a name="l04765"></a>04765     <span class="comment">/* don&#39;t allow lamp, animated duplis, or radio render */</span>
<a name="l04766"></a>04766     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0f53be682144c6ed920b202801dd9523">render_object_type</a>(obd-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>) &amp;&amp;
<a name="l04767"></a>04767             (!(dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a>) || !dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#aea68a9daf208f633c3028a360e6c0230">animated</a>));
<a name="l04768"></a>04768 }
<a name="l04769"></a>04769 
<a name="l04770"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af7cd670b3bd22b8ce75738b20b3ddcf3">04770</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af7cd670b3bd22b8ce75738b20b3ddcf3">dupli_render_particle_set</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> timeoffset, <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> enable)
<a name="l04771"></a>04771 {
<a name="l04772"></a>04772     <span class="comment">/* ugly function, but we need to set particle systems to their render</span>
<a name="l04773"></a>04773 <span class="comment">     * settings before calling object_duplilist, to get render level duplis */</span>
<a name="l04774"></a>04774     <a class="code" href="../../d4/d91/structGroup.html">Group</a> *group;
<a name="l04775"></a>04775     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l04776"></a>04776     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l04777"></a>04777     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l04778"></a>04778 
<a name="l04779"></a>04779     <span class="keywordflow">if</span> (level &gt;= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36a22093e79e04fd2df49aaf650c10ce">MAX_DUPLI_RECUR</a>)
<a name="l04780"></a>04780         <span class="keywordflow">return</span>;
<a name="l04781"></a>04781     
<a name="l04782"></a>04782     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a4bbbd0230e5c35a5d939a40131bd2df1">OB_DUPLIPARTS</a>) {
<a name="l04783"></a>04783         <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l04784"></a>04784             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a1a44c6ba58be14e0084b4f71c87d66a2">ren_as</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a2506fdc9f159583f812c900402c5ec54">PART_DRAW_OB</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ababc8a40b78ea25bfdb9cd7b85c83f19">PART_DRAW_GR</a>)) {
<a name="l04785"></a>04785                 <span class="keywordflow">if</span> (enable)
<a name="l04786"></a>04786                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a2ff8a19d90143549c1f412cb457dfc89">psys_render_set</a>(ob, psys, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>, timeoffset);
<a name="l04787"></a>04787                 <span class="keywordflow">else</span>
<a name="l04788"></a>04788                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a3bbe6d899d3310546735f082b57bc78f">psys_render_restore</a>(ob, psys);
<a name="l04789"></a>04789             }
<a name="l04790"></a>04790         }
<a name="l04791"></a>04791 
<a name="l04792"></a>04792         <span class="keywordflow">if</span> (enable) {
<a name="l04793"></a>04793             <span class="comment">/* this is to make sure we get render level duplis in groups:</span>
<a name="l04794"></a>04794 <span class="comment">             * the derivedmesh must be created before init_render_mesh,</span>
<a name="l04795"></a>04795 <span class="comment">             * since object_duplilist does dupliparticles before that */</span>
<a name="l04796"></a>04796             dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aeade9a199706a910fa3a5593b49cdbdf">mesh_create_derived_render</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>);
<a name="l04797"></a>04797             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l04798"></a>04798 
<a name="l04799"></a>04799             <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>)
<a name="l04800"></a>04800                 <a class="code" href="../../db/dca/BKE__particle_8h.html#abb46b353cec8d54be258c683d352fc1d">psys_get_modifier</a>(ob, psys)-&gt;<a class="code" href="../../d7/da3/structParticleSystemModifierData.html#abc843013a6e93e2d94b3f45ac8fed2c9">flag</a> &amp;= ~<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a4f03f9ddb8ddeabea182daaa994650afaabaaf7f2d3b45ec49fb96b09b99615a3">eParticleSystemFlag_psys_updated</a>;
<a name="l04801"></a>04801         }
<a name="l04802"></a>04802     }
<a name="l04803"></a>04803 
<a name="l04804"></a>04804     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l04805"></a>04805     group= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a>;
<a name="l04806"></a>04806 
<a name="l04807"></a>04807     <span class="keywordflow">for</span> (go= group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ad757bf69b6fd15b1d4e0980089d13be1">gobject</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>)
<a name="l04808"></a>04808         <a class="code" href="../../d2/d47/convertblender_8c.html#af7cd670b3bd22b8ce75738b20b3ddcf3">dupli_render_particle_set</a>(re, go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>, timeoffset, level+1, enable);
<a name="l04809"></a>04809 }
<a name="l04810"></a>04810 
<a name="l04811"></a><a class="code" href="../../d2/d47/convertblender_8c.html#adaa20270133de612d22a5223c77fe378">04811</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#adaa20270133de612d22a5223c77fe378">get_vector_renderlayers</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce)
<a name="l04812"></a>04812 {
<a name="l04813"></a>04813     <a class="code" href="../../d1/d51/structSceneRenderLayer.html">SceneRenderLayer</a> *srl;
<a name="l04814"></a>04814     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay= 0;
<a name="l04815"></a>04815 
<a name="l04816"></a>04816     <span class="keywordflow">for</span> (srl= sce-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a235b7b4bed2d2d73189d3e12c219672a">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; srl; srl= srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#a9363918698634136fa21bafcabd79d27">next</a>)
<a name="l04817"></a>04817         <span class="keywordflow">if</span> (srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#a88f32fbd005f0f6204f0ed0ffc625b36">passflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>)
<a name="l04818"></a>04818             lay |= srl-&gt;<a class="code" href="../../d1/d51/structSceneRenderLayer.html#add5911ed3ed1caae5224b8c063be6939">lay</a>;
<a name="l04819"></a>04819 
<a name="l04820"></a>04820     <span class="keywordflow">return</span> lay;
<a name="l04821"></a>04821 }
<a name="l04822"></a>04822 
<a name="l04823"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a3542f977297ee51a4c2630ce61c96154">04823</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a3542f977297ee51a4c2630ce61c96154">add_group_render_dupli_obs</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d91/structGroup.html">Group</a> *group, <span class="keywordtype">int</span> nolamps, <span class="keywordtype">int</span> onlyselected, <a class="code" href="../../de/de7/structObject.html">Object</a> *actob, <span class="keywordtype">int</span> timeoffset, <span class="keywordtype">int</span> level)
<a name="l04824"></a>04824 {
<a name="l04825"></a>04825     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l04826"></a>04826     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l04827"></a>04827 
<a name="l04828"></a>04828     <span class="comment">/* simple preventing of too deep nested groups */</span>
<a name="l04829"></a>04829     <span class="keywordflow">if</span> (level&gt;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36a22093e79e04fd2df49aaf650c10ce">MAX_DUPLI_RECUR</a>) <span class="keywordflow">return</span>;
<a name="l04830"></a>04830 
<a name="l04831"></a>04831     <span class="comment">/* recursively go into dupligroups to find objects with OB_RENDER_DUPLI</span>
<a name="l04832"></a>04832 <span class="comment">     * that were not created yet */</span>
<a name="l04833"></a>04833     <span class="keywordflow">for</span> (go= group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ad757bf69b6fd15b1d4e0980089d13be1">gobject</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l04834"></a>04834         ob= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#aeafe134dbf1980f42045d1fc191f2967">ob</a>;
<a name="l04835"></a>04835 
<a name="l04836"></a>04836         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1c1ed6161d5bbdeda432f34e6758050b">OB_DONE</a>) {
<a name="l04837"></a>04837             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>) {
<a name="l04838"></a>04838                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(re, ob, nolamps, onlyselected, actob)) {
<a name="l04839"></a>04839                     <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, timeoffset);
<a name="l04840"></a>04840                     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>;
<a name="l04841"></a>04841 
<a name="l04842"></a>04842                     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a>)
<a name="l04843"></a>04843                         <a class="code" href="../../d2/d47/convertblender_8c.html#a3542f977297ee51a4c2630ce61c96154">add_group_render_dupli_obs</a>(re, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a>, nolamps, onlyselected, actob, timeoffset, level+1);
<a name="l04844"></a>04844                 }
<a name="l04845"></a>04845             }
<a name="l04846"></a>04846         }
<a name="l04847"></a>04847     }
<a name="l04848"></a>04848 }
<a name="l04849"></a>04849 
<a name="l04850"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a6f965a2f9ae1b2069787dc4893d5fdb5">04850</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a6f965a2f9ae1b2069787dc4893d5fdb5">database_init_objects</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> renderlay, <span class="keywordtype">int</span> nolamps, <span class="keywordtype">int</span> onlyselected, <a class="code" href="../../de/de7/structObject.html">Object</a> *actob, <span class="keywordtype">int</span> timeoffset)
<a name="l04851"></a>04851 {
<a name="l04852"></a>04852     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l04853"></a>04853     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l04854"></a>04854     <a class="code" href="../../d4/d91/structGroup.html">Group</a> *group;
<a name="l04855"></a>04855     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l04856"></a>04856     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter;
<a name="l04857"></a>04857     <span class="keywordtype">float</span> mat[4][4];
<a name="l04858"></a>04858     <span class="keywordtype">int</span> lay, vectorlay;
<a name="l04859"></a>04859 
<a name="l04860"></a>04860     <span class="comment">/* for duplis we need the Object texture mapping to work as if</span>
<a name="l04861"></a>04861 <span class="comment">     * untransformed, set_dupli_tex_mat sets the matrix to allow that</span>
<a name="l04862"></a>04862 <span class="comment">     * NULL is just for init */</span>
<a name="l04863"></a>04863     <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04864"></a>04864 
<a name="l04865"></a>04865     <span class="comment">/* loop over all objects rather then using SETLOOPER because we may</span>
<a name="l04866"></a>04866 <span class="comment">     * reference an mtex-mapped object which isn&#39;t rendered or is an</span>
<a name="l04867"></a>04867 <span class="comment">     * empty in a dupli group. We could scan all render material/lamp/world</span>
<a name="l04868"></a>04868 <span class="comment">     * mtex&#39;s for mapto objects but its easier just to set the</span>
<a name="l04869"></a>04869 <span class="comment">     * &#39;imat&#39; / &#39;imat_ren&#39; on all and unlikely to be a performance hit</span>
<a name="l04870"></a>04870 <span class="comment">     * See bug: [#28744] - campbell */</span>
<a name="l04871"></a>04871     <span class="keywordflow">for</span> (ob= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob; ob= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l04872"></a>04872         <span class="comment">/* imat objects has to be done here, since displace can have texture using Object map-input */</span>
<a name="l04873"></a>04873         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l04874"></a>04874         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, mat);
<a name="l04875"></a>04875         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>);
<a name="l04876"></a>04876         <span class="comment">/* each object should only be rendered once */</span>
<a name="l04877"></a>04877         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1c1ed6161d5bbdeda432f34e6758050b">OB_DONE</a>;
<a name="l04878"></a>04878         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>;
<a name="l04879"></a>04879     }
<a name="l04880"></a>04880 
<a name="l04881"></a>04881     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, sce_iter, base)) {
<a name="l04882"></a>04882         ob= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l04883"></a>04883 
<a name="l04884"></a>04884         <span class="comment">/* in the prev/next pass for making speed vectors, avoid creating</span>
<a name="l04885"></a>04885 <span class="comment">         * objects that are not on a renderlayer with a vector pass, can</span>
<a name="l04886"></a>04886 <span class="comment">         * save a lot of time in complex scenes */</span>
<a name="l04887"></a>04887         vectorlay= <a class="code" href="../../d2/d47/convertblender_8c.html#adaa20270133de612d22a5223c77fe378">get_vector_renderlayers</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>);
<a name="l04888"></a>04888         lay= (timeoffset)? renderlay &amp; vectorlay: renderlay;
<a name="l04889"></a>04889 
<a name="l04890"></a>04890         <span class="comment">/* if the object has been restricted from rendering in the outliner, ignore it */</span>
<a name="l04891"></a>04891         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#afc7a8aca0c2cf33c6323883e313362b0">restrictflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab94b52225b1bb3d5083e9855b32902d0">OB_RESTRICT_RENDER</a>) <span class="keywordflow">continue</span>;
<a name="l04892"></a>04892 
<a name="l04893"></a>04893         <span class="comment">/* OB_DONE means the object itself got duplicated, so was already converted */</span>
<a name="l04894"></a>04894         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1c1ed6161d5bbdeda432f34e6758050b">OB_DONE</a>) {
<a name="l04895"></a>04895             <span class="comment">/* OB_RENDER_DUPLI means instances for it were already created, now</span>
<a name="l04896"></a>04896 <span class="comment">             * it still needs to create the ObjectRen containing the data */</span>
<a name="l04897"></a>04897             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>) {
<a name="l04898"></a>04898                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(re, ob, nolamps, onlyselected, actob)) {
<a name="l04899"></a>04899                     <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, timeoffset);
<a name="l04900"></a>04900                     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>;
<a name="l04901"></a>04901                 }
<a name="l04902"></a>04902             }
<a name="l04903"></a>04903         }
<a name="l04904"></a>04904         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; lay) || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a> &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>)) ) {
<a name="l04905"></a>04905             <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a046d883c32490b5c5ca4c5e7b6504e35">OB_MBALL</a>)) {
<a name="l04906"></a>04906                 <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob;
<a name="l04907"></a>04907                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb;
<a name="l04908"></a>04908 
<a name="l04909"></a>04909                 <span class="comment">/* create list of duplis generated by this object, particle</span>
<a name="l04910"></a>04910 <span class="comment">                 * system need to have render settings set for dupli particles */</span>
<a name="l04911"></a>04911                 <a class="code" href="../../d2/d47/convertblender_8c.html#af7cd670b3bd22b8ce75738b20b3ddcf3">dupli_render_particle_set</a>(re, ob, timeoffset, 0, 1);
<a name="l04912"></a>04912                 lb= <a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, ob);
<a name="l04913"></a>04913                 <a class="code" href="../../d2/d47/convertblender_8c.html#af7cd670b3bd22b8ce75738b20b3ddcf3">dupli_render_particle_set</a>(re, ob, timeoffset, 0, 0);
<a name="l04914"></a>04914 
<a name="l04915"></a>04915                 <span class="keywordflow">for</span> (dob= lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dob; dob= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>) {
<a name="l04916"></a>04916                     <a class="code" href="../../de/de7/structObject.html">Object</a> *obd= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>;
<a name="l04917"></a>04917                     
<a name="l04918"></a>04918                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obd-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>);
<a name="l04919"></a>04919 
<a name="l04920"></a>04920                     <span class="comment">/* group duplis need to set ob matrices correct, for deform. so no_draw is part handled */</span>
<a name="l04921"></a>04921                     <span class="keywordflow">if</span> (!(obd-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>) &amp;&amp; dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a773b85a90ed4f86fe3fbaac4f97aae30">no_draw</a>)
<a name="l04922"></a>04922                         <span class="keywordflow">continue</span>;
<a name="l04923"></a>04923 
<a name="l04924"></a>04924                     <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="../../de/de7/structObject.html#afc7a8aca0c2cf33c6323883e313362b0">restrictflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab94b52225b1bb3d5083e9855b32902d0">OB_RESTRICT_RENDER</a>)
<a name="l04925"></a>04925                         <span class="keywordflow">continue</span>;
<a name="l04926"></a>04926 
<a name="l04927"></a>04927                     <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a046d883c32490b5c5ca4c5e7b6504e35">OB_MBALL</a>)
<a name="l04928"></a>04928                         <span class="keywordflow">continue</span>;
<a name="l04929"></a>04929 
<a name="l04930"></a>04930                     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(re, obd, nolamps, onlyselected, actob))
<a name="l04931"></a>04931                         <span class="keywordflow">continue</span>;
<a name="l04932"></a>04932 
<a name="l04933"></a>04933                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#acb837997b7d341d627a0eb94ee01313d">allow_render_dupli_instance</a>(re, dob, obd)) {
<a name="l04934"></a>04934                         <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l04935"></a>04935                         <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04936"></a>04936                         <span class="keywordtype">int</span> psysindex;
<a name="l04937"></a>04937                         <span class="keywordtype">float</span> mat[4][4];
<a name="l04938"></a>04938 
<a name="l04939"></a>04939                         obi=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04940"></a>04940 
<a name="l04941"></a>04941                         <span class="comment">/* instances instead of the actual object are added in two cases, either</span>
<a name="l04942"></a>04942 <span class="comment">                         * this is a duplivert/face/particle, or it is a non-animated object in</span>
<a name="l04943"></a>04943 <span class="comment">                         * a dupligroup that has already been created before */</span>
<a name="l04944"></a>04944                         <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a> || (obr=<a class="code" href="../../d2/d47/convertblender_8c.html#a40b7ba47972ad8a236a5a048c6705188">find_dupligroup_dupli</a>(re, obd, 0))) {
<a name="l04945"></a>04945                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>);
<a name="l04946"></a>04946                             obi= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a20f6a35f7d49aed6a73bb33146d7102c">RE_addRenderInstance</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obd, ob, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a47a802d4d6b9602f04097c6ee5562f3b">index</a>, 0, mat, obd-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04947"></a>04947 
<a name="l04948"></a>04948                             <span class="comment">/* fill in instance variables for texturing */</span>
<a name="l04949"></a>04949                             <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(re, obi, dob);
<a name="l04950"></a>04950                             <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a>) {
<a name="l04951"></a>04951                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#ad7c4401f28ccfddb166755c4976ac24e">dupliorco</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#ac194af7f0a66a329c6c92a2779e71179">orco</a>);
<a name="l04952"></a>04952                                 obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a719e0f065c8536f1a12313a6f70e1e75">dupliuv</a>[0]= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a2509560ae57cea192708226e79b9b1a6">uv</a>[0];
<a name="l04953"></a>04953                                 obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a719e0f065c8536f1a12313a6f70e1e75">dupliuv</a>[1]= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a2509560ae57cea192708226e79b9b1a6">uv</a>[1];
<a name="l04954"></a>04954                             }
<a name="l04955"></a>04955                             <span class="keywordflow">else</span> {
<a name="l04956"></a>04956                                 <span class="comment">/* for the second case, setup instance to point to the already</span>
<a name="l04957"></a>04957 <span class="comment">                                 * created object, and possibly setup instances if this object</span>
<a name="l04958"></a>04958 <span class="comment">                                 * itself was duplicated. for the first case find_dupli_instances</span>
<a name="l04959"></a>04959 <span class="comment">                                 * will be called later. */</span>
<a name="l04960"></a>04960                                 <a class="code" href="../../d2/d47/convertblender_8c.html#a2fe8c9b3f364ee811219cbfc1653e5fe">assign_dupligroup_dupli</a>(re, obi, obr);
<a name="l04961"></a>04961                                 <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)
<a name="l04962"></a>04962                                     <a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">find_dupli_instances</a>(re, obr);
<a name="l04963"></a>04963                             }
<a name="l04964"></a>04964                         }
<a name="l04965"></a>04965 
<a name="l04966"></a>04966                         <span class="comment">/* same logic for particles, each particle system has it&#39;s own object, so</span>
<a name="l04967"></a>04967 <span class="comment">                         * need to go over them separately */</span>
<a name="l04968"></a>04968                         psysindex= 1;
<a name="l04969"></a>04969                         <span class="keywordflow">for</span> (psys=obd-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l04970"></a>04970                             <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a> || (obr=<a class="code" href="../../d2/d47/convertblender_8c.html#a40b7ba47972ad8a236a5a048c6705188">find_dupligroup_dupli</a>(re, obd, psysindex))) {
<a name="l04971"></a>04971                                 <span class="keywordflow">if</span> (obi == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04972"></a>04972                                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>);
<a name="l04973"></a>04973                                 obi= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a20f6a35f7d49aed6a73bb33146d7102c">RE_addRenderInstance</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obd, ob, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a47a802d4d6b9602f04097c6ee5562f3b">index</a>, psysindex++, mat, obd-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>);
<a name="l04974"></a>04974 
<a name="l04975"></a>04975                                 <a class="code" href="../../d2/d47/convertblender_8c.html#aa1f07171b3705640fcf89df7545ee6d1">set_dupli_tex_mat</a>(re, obi, dob);
<a name="l04976"></a>04976                                 <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a>) {
<a name="l04977"></a>04977                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#ad7c4401f28ccfddb166755c4976ac24e">dupliorco</a>, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#ac194af7f0a66a329c6c92a2779e71179">orco</a>);
<a name="l04978"></a>04978                                     obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a719e0f065c8536f1a12313a6f70e1e75">dupliuv</a>[0]= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a2509560ae57cea192708226e79b9b1a6">uv</a>[0];
<a name="l04979"></a>04979                                     obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a719e0f065c8536f1a12313a6f70e1e75">dupliuv</a>[1]= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a2509560ae57cea192708226e79b9b1a6">uv</a>[1];
<a name="l04980"></a>04980                                 }
<a name="l04981"></a>04981                                 <span class="keywordflow">else</span> {
<a name="l04982"></a>04982                                     <a class="code" href="../../d2/d47/convertblender_8c.html#a2fe8c9b3f364ee811219cbfc1653e5fe">assign_dupligroup_dupli</a>(re, obi, obr);
<a name="l04983"></a>04983                                     <span class="keywordflow">if</span> (obd-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>)
<a name="l04984"></a>04984                                         <a class="code" href="../../d2/d47/convertblender_8c.html#a3bac76b925426880e774de59c93b57cd">find_dupli_instances</a>(re, obr);
<a name="l04985"></a>04985                                 }
<a name="l04986"></a>04986                             }
<a name="l04987"></a>04987                         }
<a name="l04988"></a>04988 
<a name="l04989"></a>04989                         <span class="keywordflow">if</span> (obi==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04990"></a>04990                             <span class="comment">/* can&#39;t instance, just create the object */</span>
<a name="l04991"></a>04991                             <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, obd, ob, dob, timeoffset);
<a name="l04992"></a>04992                         
<a name="l04993"></a>04993                         <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a1792031c8b4630c30f1c71cea8a157d2">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a>) {
<a name="l04994"></a>04994                             obd-&gt;<a class="code" href="../../de/de7/structObject.html#a4cb926ee8d882f0a18f0a2dbdea46e73">flag</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1c1ed6161d5bbdeda432f34e6758050b">OB_DONE</a>;
<a name="l04995"></a>04995                             obd-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8044ebd256beabfaf03d35175486b360">OB_RENDER_DUPLI</a>;
<a name="l04996"></a>04996                         }
<a name="l04997"></a>04997                     }
<a name="l04998"></a>04998                     <span class="keywordflow">else</span>
<a name="l04999"></a>04999                         <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, obd, ob, dob, timeoffset);
<a name="l05000"></a>05000                     
<a name="l05001"></a>05001                     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <span class="keywordflow">break</span>;
<a name="l05002"></a>05002                 }
<a name="l05003"></a>05003                 <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb);
<a name="l05004"></a>05004 
<a name="l05005"></a>05005                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(re, ob, nolamps, onlyselected, actob))
<a name="l05006"></a>05006                     <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, timeoffset);
<a name="l05007"></a>05007             }
<a name="l05008"></a>05008             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d47/convertblender_8c.html#a0ae6fe180137ac0b576330482609e51a">allow_render_object</a>(re, ob, nolamps, onlyselected, actob))
<a name="l05009"></a>05009                 <a class="code" href="../../d2/d47/convertblender_8c.html#abb4d9a3d08aaa43cf181d6ee8e5e62a8">init_render_object</a>(re, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, timeoffset);
<a name="l05010"></a>05010         }
<a name="l05011"></a>05011 
<a name="l05012"></a>05012         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <span class="keywordflow">break</span>;
<a name="l05013"></a>05013     }
<a name="l05014"></a>05014 
<a name="l05015"></a>05015     <span class="comment">/* objects in groups with OB_RENDER_DUPLI set still need to be created,</span>
<a name="l05016"></a>05016 <span class="comment">     * since they may not be part of the scene */</span>
<a name="l05017"></a>05017     <span class="keywordflow">for</span> (group= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a267e87055868d88574ec121db05cc8c7">group</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; group; group=group-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l05018"></a>05018         <a class="code" href="../../d2/d47/convertblender_8c.html#a3542f977297ee51a4c2630ce61c96154">add_group_render_dupli_obs</a>(re, group, nolamps, onlyselected, actob, timeoffset, 0);
<a name="l05019"></a>05019 
<a name="l05020"></a>05020     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05021"></a>05021         <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae6679926e898b5b6aa4cdfb9284c4c41">RE_makeRenderInstances</a>(re);
<a name="l05022"></a>05022 }
<a name="l05023"></a>05023 
<a name="l05024"></a>05024 <span class="comment">/* used to be &#39;rotate scene&#39; */</span>
<a name="l05025"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a4bfaa709941f54d3568f54783bf5cba2">05025</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aaddef3ed714b6ed160c4dac834c08120">RE_Database_FromScene</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keywordtype">int</span> use_camera_view)
<a name="l05026"></a>05026 {
<a name="l05027"></a>05027     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce;
<a name="l05028"></a>05028     <span class="keywordtype">float</span> mat[4][4];
<a name="l05029"></a>05029     <span class="keywordtype">float</span> amb[3];
<a name="l05030"></a>05030     <a class="code" href="../../de/de7/structObject.html">Object</a> *camera= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a079fedad6d703b0a3022a3541c77a1ac">RE_GetCamera</a>(re);
<a name="l05031"></a>05031 
<a name="l05032"></a>05032     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>= bmain;
<a name="l05033"></a>05033     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>= scene;
<a name="l05034"></a>05034     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>= lay;
<a name="l05035"></a>05035     
<a name="l05036"></a>05036     <span class="comment">/* per second, per object, stats print this */</span>
<a name="l05037"></a>05037     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Preparing Scene data&quot;</span>;
<a name="l05038"></a>05038     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a3f14266f4deda901988c3e0d8a97de48">cfra</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l05039"></a>05039     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#abe435ad5afa89766e6060b214f6b36bc">scenename</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, <span class="keyword">sizeof</span>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#abe435ad5afa89766e6060b214f6b36bc">scenename</a>));
<a name="l05040"></a>05040     
<a name="l05041"></a>05041     <span class="comment">/* XXX add test if dbase was filled already? */</span>
<a name="l05042"></a>05042     
<a name="l05043"></a>05043     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;render db arena&quot;</span>);
<a name="l05044"></a>05044     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= 0;
<a name="l05045"></a>05045     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05046"></a>05046     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05047"></a>05047     
<a name="l05048"></a>05048     <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a>= 0;
<a name="l05049"></a>05049     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a7ee59cf583139b550b8e3dabd0aab11b">partsdone</a>= 0; <span class="comment">/* signal now in use for previewrender */</span>
<a name="l05050"></a>05050     
<a name="l05051"></a>05051     <span class="comment">/* in localview, lamps are using normal layers, objects only local bits */</span>
<a name="l05052"></a>05052     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a> &amp; 0xFF000000)
<a name="l05053"></a>05053         lay &amp;= 0xFF000000;
<a name="l05054"></a>05054     
<a name="l05055"></a>05055     <span class="comment">/* applies changes fully */</span>
<a name="l05056"></a>05056     <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac2be740497e894e7a2b2bc73d9a255fb">R_NO_FRAME_UPDATE</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad40c9887f83dc3ac92440b0895ae2413">R_PREVIEWBUTS</a>))==0)
<a name="l05057"></a>05057         <a class="code" href="../../d8/d53/BKE__scene_8h.html#af6ab7bd3a6bb91b84e1b6cffc995640f">scene_update_for_newframe</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, lay);
<a name="l05058"></a>05058     
<a name="l05059"></a>05059     <span class="comment">/* if no camera, viewmat should have been set! */</span>
<a name="l05060"></a>05060     <span class="keywordflow">if</span> (use_camera_view &amp;&amp; camera) {
<a name="l05061"></a>05061         <span class="comment">/* called before but need to call again in case of lens animation from the</span>
<a name="l05062"></a>05062 <span class="comment">         * above call to scene_update_for_newframe, fixes bug. [#22702].</span>
<a name="l05063"></a>05063 <span class="comment">         * following calls don&#39;t depend on &#39;RE_SetCamera&#39; */</span>
<a name="l05064"></a>05064         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ac535e8f972cf47aeed2c7f76ef6bb827">RE_SetCamera</a>(re, camera);
<a name="l05065"></a>05065 
<a name="l05066"></a>05066         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05067"></a>05067         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05068"></a>05068         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2737263fe27f6cd43262f03df6b2cdfe">RE_SetView</a>(re, mat);
<a name="l05069"></a>05069         camera-&gt;<a class="code" href="../../de/de7/structObject.html#a1bed6d05de7a141e9271fd0985b25a9c">recalc</a>= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a189b3a96923b2425ee7c0990c0b3fd20">OB_RECALC_OB</a>; <span class="comment">/* force correct matrix for scaled cameras */</span>
<a name="l05070"></a>05070     }
<a name="l05071"></a>05071     
<a name="l05072"></a>05072     <a class="code" href="../../d0/db6/renderdatabase_8h.html#a60a634e8ea9b98602b0e207691ab6bb4">init_render_world</a>(re);  <span class="comment">/* do first, because of ambient. also requires re-&gt;osa set correct */</span>
<a name="l05073"></a>05073     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) {
<a name="l05074"></a>05074         <a class="code" href="../../d0/d0e/rendercore_8h.html#a2cd9717bc841d83c6f45aa6861ead413">init_render_qmcsampler</a>(re);
<a name="l05075"></a>05075 
<a name="l05076"></a>05076         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>))
<a name="l05077"></a>05077             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a82cd86b95a27d403b6f0bd2df37aba98">ao_samp_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a77c9804ffd340b77c103022307fc35f8">WO_AOSAMP_CONSTANT</a>)
<a name="l05078"></a>05078                 <a class="code" href="../../d0/d0e/rendercore_8h.html#addbfc82578dc6fdc226e5941647214a5">init_ao_sphere</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>);
<a name="l05079"></a>05079     }
<a name="l05080"></a>05080     
<a name="l05081"></a>05081     <span class="comment">/* still bad... doing all */</span>
<a name="l05082"></a>05082     <a class="code" href="../../df/dba/texture_8h.html#a7e81c2330dc3b0edad1d51f3df5a1365">init_render_textures</a>(re);
<a name="l05083"></a>05083     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(amb, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#afe57a3755ed6c82d7e6462e7bc0c0525">ambr</a>);
<a name="l05084"></a>05084     <a class="code" href="../../d4/d0f/BKE__material_8h.html#a6c52de3316d51adaff7ed83caa8dc3aa">init_render_materials</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a>, amb);
<a name="l05085"></a>05085     <a class="code" href="../../d4/d91/BKE__node_8h.html#a6cacbcbc8d8bb5da1c715db4aaa8abe0">set_node_shader_lamp_loop</a>(<a class="code" href="../../da/d3d/shading_8h.html#a1091bd5b76b59935ebd79d3a42e129d4">shade_material_loop</a>);
<a name="l05086"></a>05086 
<a name="l05087"></a>05087     <span class="comment">/* MAKE RENDER DATA */</span>
<a name="l05088"></a>05088     <a class="code" href="../../d2/d47/convertblender_8c.html#a6f965a2f9ae1b2069787dc4893d5fdb5">database_init_objects</a>(re, lay, 0, 0, 0, 0);
<a name="l05089"></a>05089     
<a name="l05090"></a>05090     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l05091"></a>05091         <span class="keywordtype">int</span> tothalo;
<a name="l05092"></a>05092 
<a name="l05093"></a>05093         <a class="code" href="../../d2/d47/convertblender_8c.html#a997e44476011234e8d03d981bbd3a8a3">set_material_lightgroups</a>(re);
<a name="l05094"></a>05094         <span class="keywordflow">for</span> (sce= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>; sce; sce= sce-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>)
<a name="l05095"></a>05095             <a class="code" href="../../d2/d47/convertblender_8c.html#a99b07b1cb4a8e36a8f27a30ef4d8ddec">set_renderlayer_lightgroups</a>(re, sce);
<a name="l05096"></a>05096         
<a name="l05097"></a>05097         <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a>= 1;
<a name="l05098"></a>05098         
<a name="l05099"></a>05099         <span class="comment">/* for now some clumsy copying still */</span>
<a name="l05100"></a>05100         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae66d39447c70cfc439ad8a4ad7a45cbc">totvert</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>;
<a name="l05101"></a>05101         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a691be84fe09cfa55d24a0d19dc4e3acc">totface</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>;
<a name="l05102"></a>05102         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a516984d7536ef7735ebcda7bfa1780a9">totstrand</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>;
<a name="l05103"></a>05103         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a4ad78695c78823cc0904c46fe266eaa0">tothalo</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>;
<a name="l05104"></a>05104         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a8186aea4bf851b2647eb2ce5ed419159">totlamp</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>;
<a name="l05105"></a>05105         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l05106"></a>05106         
<a name="l05107"></a>05107         <span class="comment">/* don&#39;t sort stars */</span>
<a name="l05108"></a>05108         tothalo= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>;
<a name="l05109"></a>05109         <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l05110"></a>05110             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a79f2ef6e8ebb56410e467840c5527254">WO_STARS</a>) {
<a name="l05111"></a>05111                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Creating Starfield&quot;</span>;
<a name="l05112"></a>05112                 re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l05113"></a>05113                 <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ac4d3d24f538e74cab2213a294bdac8a1">RE_make_stars</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05114"></a>05114             }
<a name="l05115"></a>05115         }
<a name="l05116"></a>05116         <a class="code" href="../../d2/d47/convertblender_8c.html#a44bf7a78b98eccd15755e86a43a44d53">sort_halos</a>(re, tothalo);
<a name="l05117"></a>05117         
<a name="l05118"></a>05118         <a class="code" href="../../d2/d47/convertblender_8c.html#a41d06c1202cfca1920e76633e8d8b222">init_camera_inside_volumes</a>(re);
<a name="l05119"></a>05119         
<a name="l05120"></a>05120         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Creating Shadowbuffers&quot;</span>;
<a name="l05121"></a>05121         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l05122"></a>05122 
<a name="l05123"></a>05123         <span class="comment">/* SHADOW BUFFER */</span>
<a name="l05124"></a>05124         <a class="code" href="../../d9/d30/shadbuf_8h.html#abe33e41b98914c843082883abbd8b81a">threaded_makeshadowbufs</a>(re);
<a name="l05125"></a>05125 
<a name="l05126"></a>05126         <span class="comment">/* old code checked for internal render (aka not yafray) */</span>
<a name="l05127"></a>05127         {
<a name="l05128"></a>05128             <span class="comment">/* raytree */</span>
<a name="l05129"></a>05129             <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l05130"></a>05130                 <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) {
<a name="l05131"></a>05131                     <a class="code" href="../../d0/d0e/rendercore_8h.html#a97241e0a4a6ebc105bf9130189beac3b">makeraytree</a>(re);
<a name="l05132"></a>05132                 }
<a name="l05133"></a>05133             }
<a name="l05134"></a>05134             <span class="comment">/* ENVIRONMENT MAPS */</span>
<a name="l05135"></a>05135             <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05136"></a>05136                 <a class="code" href="../../d7/d3f/envmap_8h.html#ae923be36bc2a94151e8597158da3b2eb">make_envmaps</a>(re);
<a name="l05137"></a>05137                 
<a name="l05138"></a>05138             <span class="comment">/* point density texture */</span>
<a name="l05139"></a>05139             <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05140"></a>05140                 <a class="code" href="../../d7/def/pointdensity_8h.html#a3a9415aa3876163d3e7b8a5382c2920a">make_pointdensities</a>(re);
<a name="l05141"></a>05141             <span class="comment">/* voxel data texture */</span>
<a name="l05142"></a>05142             <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05143"></a>05143                 <a class="code" href="../../d5/dd0/voxeldata_8h.html#ae4d37b2352b8593726bac4b3016d9032">make_voxeldata</a>(re);
<a name="l05144"></a>05144         }
<a name="l05145"></a>05145         
<a name="l05146"></a>05146         <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05147"></a>05147             <a class="code" href="../../d0/db6/renderdatabase_8h.html#a6cf4b70d1aee8e6d407276721137556b">project_renderdata</a>(re, <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a734c49fbcb5788988d667052995f4fa0">R_PANORAMA</a>, 0, 1);
<a name="l05148"></a>05148         
<a name="l05149"></a>05149         <span class="comment">/* Occlusion */</span>
<a name="l05150"></a>05150         <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>)) &amp;&amp; !re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05151"></a>05151             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a0d14a3fe319ff85a891e8616759c3469">ao_gather_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>)
<a name="l05152"></a>05152                 <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)
<a name="l05153"></a>05153                     <a class="code" href="../../d2/d3a/occlusion_8h.html#acdcc581028d4df27fb1e8888e198f1a6">make_occ_tree</a>(re);
<a name="l05154"></a>05154 
<a name="l05155"></a>05155         <span class="comment">/* SSS */</span>
<a name="l05156"></a>05156         <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a516c9c9cdf6193e6556b3850eca85510">R_SSS</a>) &amp;&amp; !re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05157"></a>05157             <a class="code" href="../../d8/d59/sss_8h.html#a2e40fdebfd02f57dd1def961a43bb260">make_sss_tree</a>(re);
<a name="l05158"></a>05158         
<a name="l05159"></a>05159         <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05160"></a>05160             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>)
<a name="l05161"></a>05161                 <a class="code" href="../../dd/d62/volume__precache_8h.html#ad8d088f0badce8f74f8dd61eb4e9bc01">volume_precache</a>(re);
<a name="l05162"></a>05162         
<a name="l05163"></a>05163     }
<a name="l05164"></a>05164     
<a name="l05165"></a>05165     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05166"></a>05166         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b3a3e3c89e9a1cf1dfe2f410be89067">RE_Database_Free</a>(re);
<a name="l05167"></a>05167     <span class="keywordflow">else</span>
<a name="l05168"></a>05168         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a6a2735f0c780f3e70f61d8f029cf8267">convertdone</a>= 1;
<a name="l05169"></a>05169     
<a name="l05170"></a>05170     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05171"></a>05171     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l05172"></a>05172 }
<a name="l05173"></a>05173 
<a name="l05174"></a>05174 <span class="comment">/* exported call to recalculate hoco for vertices, when winmat changed */</span>
<a name="l05175"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a66f577bd9586aa69179752ef6009d901">05175</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b696ffb92cb0a57e6eefad30bd17b2d">RE_DataBase_ApplyWindow</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l05176"></a>05176 {
<a name="l05177"></a>05177     <a class="code" href="../../d0/db6/renderdatabase_8h.html#a6cf4b70d1aee8e6d407276721137556b">project_renderdata</a>(re, <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>, 0, 0, 0);
<a name="l05178"></a>05178 }
<a name="l05179"></a>05179 
<a name="l05180"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af78e79f580cc1f9a528a5738e1d57d92">05180</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aa49864152ccd94a332189561e6f6ba3f">RE_DataBase_GetView</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> mat[][4])
<a name="l05181"></a>05181 {
<a name="l05182"></a>05182     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l05183"></a>05183 }
<a name="l05184"></a>05184 
<a name="l05185"></a>05185 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05186"></a>05186 <span class="comment">/* Speed Vectors                                                             */</span>
<a name="l05187"></a>05187 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05188"></a>05188 
<a name="l05189"></a><a class="code" href="../../d2/d47/convertblender_8c.html#acfcb28b624a0a4b0f00ad1a2643ced51">05189</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#acfcb28b624a0a4b0f00ad1a2643ced51">database_fromscene_vectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keywordtype">int</span> timeoffset)
<a name="l05190"></a>05190 {
<a name="l05191"></a>05191     <a class="code" href="../../de/de7/structObject.html">Object</a> *camera= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a079fedad6d703b0a3022a3541c77a1ac">RE_GetCamera</a>(re);
<a name="l05192"></a>05192     <span class="keywordtype">float</span> mat[4][4];
<a name="l05193"></a>05193     
<a name="l05194"></a>05194     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>= scene;
<a name="l05195"></a>05195     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>= lay;
<a name="l05196"></a>05196     
<a name="l05197"></a>05197     <span class="comment">/* XXX add test if dbase was filled already? */</span>
<a name="l05198"></a>05198     
<a name="l05199"></a>05199     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;vector render db arena&quot;</span>);
<a name="l05200"></a>05200     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= 0;
<a name="l05201"></a>05201     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a691be84fe09cfa55d24a0d19dc4e3acc">totface</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae66d39447c70cfc439ad8a4ad7a45cbc">totvert</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a516984d7536ef7735ebcda7bfa1780a9">totstrand</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a8186aea4bf851b2647eb2ce5ed419159">totlamp</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#a4ad78695c78823cc0904c46fe266eaa0">tothalo</a>= 0;
<a name="l05202"></a>05202     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05203"></a>05203 
<a name="l05204"></a>05204     <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a>= 0;
<a name="l05205"></a>05205     
<a name="l05206"></a>05206     <span class="comment">/* in localview, lamps are using normal layers, objects only local bits */</span>
<a name="l05207"></a>05207     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a> &amp; 0xFF000000)
<a name="l05208"></a>05208         lay &amp;= 0xFF000000;
<a name="l05209"></a>05209     
<a name="l05210"></a>05210     <span class="comment">/* applies changes fully */</span>
<a name="l05211"></a>05211     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> += timeoffset;
<a name="l05212"></a>05212     <a class="code" href="../../d8/d53/BKE__scene_8h.html#af6ab7bd3a6bb91b84e1b6cffc995640f">scene_update_for_newframe</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>, lay);
<a name="l05213"></a>05213     
<a name="l05214"></a>05214     <span class="comment">/* if no camera, viewmat should have been set! */</span>
<a name="l05215"></a>05215     <span class="keywordflow">if</span> (camera) {
<a name="l05216"></a>05216         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05217"></a>05217         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05218"></a>05218         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2737263fe27f6cd43262f03df6b2cdfe">RE_SetView</a>(re, mat);
<a name="l05219"></a>05219     }
<a name="l05220"></a>05220     
<a name="l05221"></a>05221     <span class="comment">/* MAKE RENDER DATA */</span>
<a name="l05222"></a>05222     <a class="code" href="../../d2/d47/convertblender_8c.html#a6f965a2f9ae1b2069787dc4893d5fdb5">database_init_objects</a>(re, lay, 0, 0, 0, timeoffset);
<a name="l05223"></a>05223     
<a name="l05224"></a>05224     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05225"></a>05225         <a class="code" href="../../d0/db6/renderdatabase_8h.html#a6cf4b70d1aee8e6d407276721137556b">project_renderdata</a>(re, <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a734c49fbcb5788988d667052995f4fa0">R_PANORAMA</a>, 0, 1);
<a name="l05226"></a>05226 
<a name="l05227"></a>05227     <span class="comment">/* do this in end, particles for example need cfra */</span>
<a name="l05228"></a>05228     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> -= timeoffset;
<a name="l05229"></a>05229 }
<a name="l05230"></a>05230 
<a name="l05231"></a>05231 <span class="comment">/* choose to use static, to prevent giving too many args to this call */</span>
<a name="l05232"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">05232</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> zco[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ho[4])
<a name="l05233"></a>05233 {
<a name="l05234"></a>05234     <span class="keyword">static</span> <span class="keywordtype">float</span> pixelphix=0.0f, pixelphiy=0.0f, zmulx=0.0f, zmuly=0.0f;
<a name="l05235"></a>05235     <span class="keyword">static</span> <span class="keywordtype">int</span> pano= 0;
<a name="l05236"></a>05236     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l05237"></a>05237     
<a name="l05238"></a>05238     <span class="comment">/* initialize */</span>
<a name="l05239"></a>05239     <span class="keywordflow">if</span> (re) {
<a name="l05240"></a>05240         pano= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a734c49fbcb5788988d667052995f4fa0">R_PANORAMA</a>;
<a name="l05241"></a>05241         
<a name="l05242"></a>05242         <span class="comment">/* precalculate amount of radians 1 pixel rotates */</span>
<a name="l05243"></a>05243         <span class="keywordflow">if</span> (pano) {
<a name="l05244"></a>05244             <span class="comment">/* size of 1 pixel mapped to viewplane coords */</span>
<a name="l05245"></a>05245             <span class="keywordtype">float</span> psize= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad919c0c490e55b5057bbd1183b89a8b2">viewplane</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>-re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad919c0c490e55b5057bbd1183b89a8b2">viewplane</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)/(<span class="keywordtype">float</span>)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>;
<a name="l05246"></a>05246             <span class="comment">/* x angle of a pixel */</span>
<a name="l05247"></a>05247             pixelphix= <a class="code" href="../../d0/dbc/namespaceKDL.html#a08cb2c52ea1d8701f35cee392a8ef5a3">atan</a>(psize/re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa1811a2e46b1335c04ab55d01f56b0da">clipsta</a>);
<a name="l05248"></a>05248             
<a name="l05249"></a>05249             psize= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad919c0c490e55b5057bbd1183b89a8b2">viewplane</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>-re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad919c0c490e55b5057bbd1183b89a8b2">viewplane</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)/(<span class="keywordtype">float</span>)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>;
<a name="l05250"></a>05250             <span class="comment">/* y angle of a pixel */</span>
<a name="l05251"></a>05251             pixelphiy= <a class="code" href="../../d0/dbc/namespaceKDL.html#a08cb2c52ea1d8701f35cee392a8ef5a3">atan</a>(psize/re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa1811a2e46b1335c04ab55d01f56b0da">clipsta</a>);
<a name="l05252"></a>05252         }
<a name="l05253"></a>05253         zmulx= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>/2;
<a name="l05254"></a>05254         zmuly= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>/2;
<a name="l05255"></a>05255         
<a name="l05256"></a>05256         <span class="keywordflow">return</span>;
<a name="l05257"></a>05257     }
<a name="l05258"></a>05258     
<a name="l05259"></a>05259     <span class="comment">/* now map hocos to screenspace, uses very primitive clip still */</span>
<a name="l05260"></a>05260     <span class="keywordflow">if</span> (ho[3]&lt;0.1f) div= 10.0f;
<a name="l05261"></a>05261     <span class="keywordflow">else</span> div= 1.0f/ho[3];
<a name="l05262"></a>05262     
<a name="l05263"></a>05263     <span class="comment">/* use cylinder projection */</span>
<a name="l05264"></a>05264     <span class="keywordflow">if</span> (pano) {
<a name="l05265"></a>05265         <span class="keywordtype">float</span> vec[3], ang;
<a name="l05266"></a>05266         <span class="comment">/* angle between (0,0,-1) and (co) */</span>
<a name="l05267"></a>05267         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, co);
<a name="l05268"></a>05268 
<a name="l05269"></a>05269         ang= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(-vec[2]/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(vec[0]*vec[0] + vec[2]*vec[2]));
<a name="l05270"></a>05270         <span class="keywordflow">if</span> (vec[0]&lt;0.0f) ang= -ang;
<a name="l05271"></a>05271         zco[0]= ang/pixelphix + zmulx;
<a name="l05272"></a>05272         
<a name="l05273"></a>05273         ang= 0.5f*(float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(vec[1] / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vec));
<a name="l05274"></a>05274         zco[1]= ang/pixelphiy + zmuly;
<a name="l05275"></a>05275         
<a name="l05276"></a>05276     }
<a name="l05277"></a>05277     <span class="keywordflow">else</span> {
<a name="l05278"></a>05278         zco[0]= zmulx*(1.0f+ho[0]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l05279"></a>05279         zco[1]= zmuly*(1.0f+ho[1]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l05280"></a>05280     }
<a name="l05281"></a>05281 }
<a name="l05282"></a>05282 
<a name="l05283"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a0cabe3f76d13267ecb61959f6b4f1fa7">05283</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#a0cabe3f76d13267ecb61959f6b4f1fa7">calculate_speedvector</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> vectors[2], <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, <span class="keywordtype">float</span> winsq, <span class="keywordtype">float</span> winroot, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> ho[4], <span class="keywordtype">float</span> speed[4])
<a name="l05284"></a>05284 {
<a name="l05285"></a>05285     <span class="keywordtype">float</span> zco[2], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l05286"></a>05286 
<a name="l05287"></a>05287     <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, zco, co, ho);
<a name="l05288"></a>05288     
<a name="l05289"></a>05289     zco[0]= vectors[0] - zco[0];
<a name="l05290"></a>05290     zco[1]= vectors[1] - zco[1];
<a name="l05291"></a>05291     
<a name="l05292"></a>05292     <span class="comment">/* enable nice masks for hardly moving stuff or float inaccuracy */</span>
<a name="l05293"></a>05293     <span class="keywordflow">if</span> (zco[0]&lt;0.1f &amp;&amp; zco[0]&gt;-0.1f &amp;&amp; zco[1]&lt;0.1f &amp;&amp; zco[1]&gt;-0.1f ) {
<a name="l05294"></a>05294         zco[0]= 0.0f;
<a name="l05295"></a>05295         zco[1]= 0.0f;
<a name="l05296"></a>05296     }
<a name="l05297"></a>05297     
<a name="l05298"></a>05298     <span class="comment">/* maximize speed for image width, otherwise it never looks good */</span>
<a name="l05299"></a>05299     len= zco[0]*zco[0] + zco[1]*zco[1];
<a name="l05300"></a>05300     <span class="keywordflow">if</span> (len &gt; winsq) {
<a name="l05301"></a>05301         len= winroot/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(len);
<a name="l05302"></a>05302         zco[0]*= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l05303"></a>05303         zco[1]*= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l05304"></a>05304     }
<a name="l05305"></a>05305     
<a name="l05306"></a>05306     <span class="comment">/* note; in main vecblur loop speedvec is negated again */</span>
<a name="l05307"></a>05307     <span class="keywordflow">if</span> (step) {
<a name="l05308"></a>05308         speed[2]= -zco[0];
<a name="l05309"></a>05309         speed[3]= -zco[1];
<a name="l05310"></a>05310     }
<a name="l05311"></a>05311     <span class="keywordflow">else</span> {
<a name="l05312"></a>05312         speed[0]= zco[0];
<a name="l05313"></a>05313         speed[1]= zco[1];
<a name="l05314"></a>05314     }
<a name="l05315"></a>05315 }
<a name="l05316"></a>05316 
<a name="l05317"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ae48527ddee0c94cc0f9e51ec4341d862">05317</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d2/d47/convertblender_8c.html#ae48527ddee0c94cc0f9e51ec4341d862">calculate_strandsurface_speedvectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh)
<a name="l05318"></a>05318 {
<a name="l05319"></a>05319     <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a> &amp;&amp; mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a> &amp;&amp; mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>) {
<a name="l05320"></a>05320         <span class="keywordtype">float</span> winsq= (float)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>*(<span class="keywordtype">float</span>)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>; <span class="comment">/* int&#39;s can wrap on large images */</span>
<a name="l05321"></a>05321         <span class="keywordtype">float</span> winroot= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(winsq);
<a name="l05322"></a>05322         float (*winspeed)[4];
<a name="l05323"></a>05323         <span class="keywordtype">float</span> ho[4], prevho[4], nextho[4], winmat[4][4], vec[2];
<a name="l05324"></a>05324         <span class="keywordtype">int</span> a;
<a name="l05325"></a>05325 
<a name="l05326"></a>05326         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l05327"></a>05327             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l05328"></a>05328         <span class="keywordflow">else</span>
<a name="l05329"></a>05329             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l05330"></a>05330 
<a name="l05331"></a>05331         winspeed= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*4*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfWin&quot;</span>);
<a name="l05332"></a>05332 
<a name="l05333"></a>05333         <span class="keywordflow">for</span> (a=0; a&lt;mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>; a++) {
<a name="l05334"></a>05334             <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[a], winmat, ho);
<a name="l05335"></a>05335 
<a name="l05336"></a>05336             <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>[a], winmat, prevho);
<a name="l05337"></a>05337             <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vec, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>[a], prevho);
<a name="l05338"></a>05338             <a class="code" href="../../d2/d47/convertblender_8c.html#a0cabe3f76d13267ecb61959f6b4f1fa7">calculate_speedvector</a>(vec, 0, winsq, winroot, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[a], ho, winspeed[a]);
<a name="l05339"></a>05339 
<a name="l05340"></a>05340             <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>[a], winmat, nextho);
<a name="l05341"></a>05341             <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vec, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>[a], nextho);
<a name="l05342"></a>05342             <a class="code" href="../../d2/d47/convertblender_8c.html#a0cabe3f76d13267ecb61959f6b4f1fa7">calculate_speedvector</a>(vec, 1, winsq, winroot, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[a], ho, winspeed[a]);
<a name="l05343"></a>05343         }
<a name="l05344"></a>05344 
<a name="l05345"></a>05345         <span class="keywordflow">return</span> (<span class="keywordtype">float</span>*)winspeed;
<a name="l05346"></a>05346     }
<a name="l05347"></a>05347 
<a name="l05348"></a>05348     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05349"></a>05349 }
<a name="l05350"></a>05350 
<a name="l05351"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af6cfb025acb1433aa2beb74f81c217ac">05351</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af6cfb025acb1433aa2beb74f81c217ac">calculate_speedvectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <span class="keywordtype">float</span> *vectors, <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>)
<a name="l05352"></a>05352 {
<a name="l05353"></a>05353     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l05354"></a>05354     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05355"></a>05355     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05356"></a>05356     <a class="code" href="../../de/d59/structStrandBuffer.html">StrandBuffer</a> *strandbuf;
<a name="l05357"></a>05357     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05358"></a>05358     <span class="keywordtype">float</span> *speed, (*winspeed)[4]=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ho[4], winmat[4][4];
<a name="l05359"></a>05359     <span class="keywordtype">float</span> *co1, *co2, *co3, *co4, w[4];
<a name="l05360"></a>05360     <span class="keywordtype">float</span> winsq= (float)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>*(<span class="keywordtype">float</span>)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>, winroot= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(winsq);  <span class="comment">/* int&#39;s can wrap on large images */</span>
<a name="l05361"></a>05361     <span class="keywordtype">int</span> a, *face, *index;
<a name="l05362"></a>05362 
<a name="l05363"></a>05363     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l05364"></a>05364         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l05365"></a>05365     <span class="keywordflow">else</span>
<a name="l05366"></a>05366         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l05367"></a>05367 
<a name="l05368"></a>05368     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae182ad2642ffd40fa7b4457bb5f857fe">vertnodes</a>) {
<a name="l05369"></a>05369         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++, vectors+=2) {
<a name="l05370"></a>05370             <span class="keywordflow">if</span> ((a &amp; 255)==0) ver= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae182ad2642ffd40fa7b4457bb5f857fe">vertnodes</a>[a&gt;&gt;8].<a class="code" href="../../d3/d86/structVertTableNode.html#a1e7b72f1c711cb5e6e7938bd839c86aa">vert</a>;
<a name="l05371"></a>05371             <span class="keywordflow">else</span> ver++;
<a name="l05372"></a>05372 
<a name="l05373"></a>05373             speed= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a473ecdb98013201636c651b0fb7aeed2">RE_vertren_get_winspeed</a>(obi, ver, 1);
<a name="l05374"></a>05374             <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, ho);
<a name="l05375"></a>05375             <a class="code" href="../../d2/d47/convertblender_8c.html#a0cabe3f76d13267ecb61959f6b4f1fa7">calculate_speedvector</a>(vectors, step, winsq, winroot, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho, speed);
<a name="l05376"></a>05376         }
<a name="l05377"></a>05377     }
<a name="l05378"></a>05378 
<a name="l05379"></a>05379     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aae27b25a528ddef9b65f6f3c626fa5bc">strandnodes</a>) {
<a name="l05380"></a>05380         strandbuf= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>;
<a name="l05381"></a>05381         mesh= (strandbuf)? strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00758fa5bf0a222c4d4bf64849a6780d">surface</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05382"></a>05382 
<a name="l05383"></a>05383         <span class="comment">/* compute speed vectors at surface vertices */</span>
<a name="l05384"></a>05384         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (mesh)
<a name="l05385"></a>05385             winspeed= (float(*)[4])<a class="code" href="../../d2/d47/convertblender_8c.html#ae48527ddee0c94cc0f9e51ec4341d862">calculate_strandsurface_speedvectors</a>(re, obi, mesh);
<a name="l05386"></a>05386 
<a name="l05387"></a>05387         <span class="keywordflow">if</span> (winspeed) {
<a name="l05388"></a>05388             <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a86e0bc91e194e276aec412d72d54a3ce">totstrand</a>; a++, vectors+=2) {
<a name="l05389"></a>05389                 <span class="keywordflow">if</span> ((a &amp; 255)==0) strand= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aae27b25a528ddef9b65f6f3c626fa5bc">strandnodes</a>[a&gt;&gt;8].<a class="code" href="../../d1/db5/structStrandTableNode.html#acf9f06a3eeb8b25efe573afa74c927ac">strand</a>;
<a name="l05390"></a>05390                 <span class="keywordflow">else</span> strand++;
<a name="l05391"></a>05391 
<a name="l05392"></a>05392                 index= <a class="code" href="../../d0/db6/renderdatabase_8h.html#aa1a1f05f460a62b6c0dba354c1f5302f">RE_strandren_get_face</a>(obr, strand, 0);
<a name="l05393"></a>05393                 <span class="keywordflow">if</span> (index &amp;&amp; *index &lt; mesh-&gt;totface) {
<a name="l05394"></a>05394                     speed= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a57a0e2bd3b266394e1a3a0438f6f99fd">RE_strandren_get_winspeed</a>(obi, strand, 1);
<a name="l05395"></a>05395 
<a name="l05396"></a>05396                     <span class="comment">/* interpolate speed vectors from strand surface */</span>
<a name="l05397"></a>05397                     face= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[*index];
<a name="l05398"></a>05398 
<a name="l05399"></a>05399                     co1= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[0]];
<a name="l05400"></a>05400                     co2= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[1]];
<a name="l05401"></a>05401                     co3= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[2]];
<a name="l05402"></a>05402                     co4= (face[3])? mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[3]]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05403"></a>05403 
<a name="l05404"></a>05404                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6c56a0f699c1c3585b26b6e8e9d16fd0">interp_weights_face_v3</a>( w,co1, co2, co3, co4, strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l05405"></a>05405 
<a name="l05406"></a>05406                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aa7d7a19d9ab16e31bd3ec9964663765c">zero_v4</a>(speed);
<a name="l05407"></a>05407                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#accba968788f1fdc900674ac433900d29">madd_v4_v4fl</a>(speed, winspeed[face[0]], w[0]);
<a name="l05408"></a>05408                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#accba968788f1fdc900674ac433900d29">madd_v4_v4fl</a>(speed, winspeed[face[1]], w[1]);
<a name="l05409"></a>05409                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#accba968788f1fdc900674ac433900d29">madd_v4_v4fl</a>(speed, winspeed[face[2]], w[2]);
<a name="l05410"></a>05410                     <span class="keywordflow">if</span> (face[3])
<a name="l05411"></a>05411                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#accba968788f1fdc900674ac433900d29">madd_v4_v4fl</a>(speed, winspeed[face[3]], w[3]);
<a name="l05412"></a>05412                 }
<a name="l05413"></a>05413             }
<a name="l05414"></a>05414 
<a name="l05415"></a>05415             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(winspeed);
<a name="l05416"></a>05416         }
<a name="l05417"></a>05417     }
<a name="l05418"></a>05418 }
<a name="l05419"></a>05419 
<a name="l05420"></a><a class="code" href="../../d2/d47/convertblender_8c.html#ad20c21dcd190f7f5fc6a2c417705ff4e">05420</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/d47/convertblender_8c.html#ad20c21dcd190f7f5fc6a2c417705ff4e">load_fluidsimspeedvectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <span class="keywordtype">float</span> *vectors, <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>)
<a name="l05421"></a>05421 {
<a name="l05422"></a>05422     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l05423"></a>05423     <a class="code" href="../../de/de7/structObject.html">Object</a> *fsob= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>;
<a name="l05424"></a>05424     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05425"></a>05425     <span class="keywordtype">float</span> *speed, <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, zco[2], avgvel[4] = {0.0, 0.0, 0.0, 0.0};
<a name="l05426"></a>05426     <span class="keywordtype">float</span> zmulx= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>/2, zmuly= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>/2, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l05427"></a>05427     <span class="keywordtype">float</span> winsq= (float)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>*(<span class="keywordtype">float</span>)re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>, winroot= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(winsq); <span class="comment">/* int&#39;s can wrap on large images */</span>
<a name="l05428"></a>05428     <span class="keywordtype">int</span> a, j;
<a name="l05429"></a>05429     <span class="keywordtype">float</span> hoco[4], ho[4], fsvec[4], camco[4];
<a name="l05430"></a>05430     <span class="keywordtype">float</span> mat[4][4], winmat[4][4];
<a name="l05431"></a>05431     <span class="keywordtype">float</span> imat[4][4];
<a name="l05432"></a>05432     <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(fsob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l05433"></a>05433     <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss;
<a name="l05434"></a>05434     <a class="code" href="../../d1/d81/structFluidVertexVelocity.html">FluidVertexVelocity</a> *velarray = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05435"></a>05435     
<a name="l05436"></a>05436     <span class="comment">/* only one step needed */</span>
<a name="l05437"></a>05437     <span class="keywordflow">if</span> (step) <span class="keywordflow">return</span> 1;
<a name="l05438"></a>05438     
<a name="l05439"></a>05439     <span class="keywordflow">if</span> (fluidmd)
<a name="l05440"></a>05440         fss = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>;
<a name="l05441"></a>05441     <span class="keywordflow">else</span>
<a name="l05442"></a>05442         <span class="keywordflow">return</span> 0;
<a name="l05443"></a>05443     
<a name="l05444"></a>05444     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l05445"></a>05445     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, mat);
<a name="l05446"></a>05446 
<a name="l05447"></a>05447     <span class="comment">/* set first vertex OK */</span>
<a name="l05448"></a>05448     <span class="keywordflow">if</span> (!fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#acae2c1beeddc6e5cf1f0627016d5e526">meshVelocities</a>) <span class="keywordflow">return</span> 0;
<a name="l05449"></a>05449     
<a name="l05450"></a>05450     <span class="keywordflow">if</span> ( obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a> != fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a2dbb0d3ca647596648f76aa02647baae">totvert</a>) {
<a name="l05451"></a>05451         <span class="comment">//fprintf(stderr, &quot;load_fluidsimspeedvectors - modified fluidsim mesh, not using speed vectors (%d,%d)...\n&quot;, obr-&gt;totvert, fsob-&gt;fluidsimSettings-&gt;meshSurface-&gt;totvert); // DEBUG</span>
<a name="l05452"></a>05452         <span class="keywordflow">return</span> 0;
<a name="l05453"></a>05453     }
<a name="l05454"></a>05454     
<a name="l05455"></a>05455     velarray = fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#acae2c1beeddc6e5cf1f0627016d5e526">meshVelocities</a>;
<a name="l05456"></a>05456 
<a name="l05457"></a>05457     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l05458"></a>05458         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l05459"></a>05459     <span class="keywordflow">else</span>
<a name="l05460"></a>05460         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l05461"></a>05461     
<a name="l05462"></a>05462     <span class="comment">/* (bad) HACK calculate average velocity */</span>
<a name="l05463"></a>05463     <span class="comment">/* better solution would be fixing getVelocityAt() in intern/elbeem/intern/solver_util.cpp</span>
<a name="l05464"></a>05464 <span class="comment">     * so that also small drops/little water volumes return a velocity != 0.</span>
<a name="l05465"></a>05465 <span class="comment">     * But I had no luck in fixing that function - DG */</span>
<a name="l05466"></a>05466     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++) {
<a name="l05467"></a>05467         <span class="keywordflow">for</span> (j=0;j&lt;3;j++) avgvel[j] += velarray[a].vel[j];
<a name="l05468"></a>05468         
<a name="l05469"></a>05469     }
<a name="l05470"></a>05470     <span class="keywordflow">for</span> (j=0;j&lt;3;j++) avgvel[j] /= (<span class="keywordtype">float</span>)(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l05471"></a>05471     
<a name="l05472"></a>05472     
<a name="l05473"></a>05473     <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++, vectors+=2) {
<a name="l05474"></a>05474         <span class="keywordflow">if</span> ((a &amp; 255)==0)
<a name="l05475"></a>05475             ver= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae182ad2642ffd40fa7b4457bb5f857fe">vertnodes</a>[a&gt;&gt;8].<a class="code" href="../../d3/d86/structVertTableNode.html#a1e7b72f1c711cb5e6e7938bd839c86aa">vert</a>;
<a name="l05476"></a>05476         <span class="keywordflow">else</span>
<a name="l05477"></a>05477             ver++;
<a name="l05478"></a>05478 
<a name="l05479"></a>05479         <span class="comment">// get fluid velocity</span>
<a name="l05480"></a>05480         fsvec[3] = 0.0f;
<a name="l05481"></a>05481         <span class="comment">//fsvec[0] = fsvec[1] = fsvec[2] = fsvec[3] = 0.0; fsvec[2] = 2.0f; // NT fixed test</span>
<a name="l05482"></a>05482         for (j=0;j&lt;3;j++) fsvec[j] = velarray[a].vel[j];
<a name="l05483"></a>05483         
<a name="l05484"></a>05484         <span class="comment">/* (bad) HACK insert average velocity if none is there (see previous comment) */</span>
<a name="l05485"></a>05485         <span class="keywordflow">if</span> ((fsvec[0] == 0.0f) &amp;&amp; (fsvec[1] == 0.0f) &amp;&amp; (fsvec[2] == 0.0f)) {
<a name="l05486"></a>05486             fsvec[0] = avgvel[0];
<a name="l05487"></a>05487             fsvec[1] = avgvel[1];
<a name="l05488"></a>05488             fsvec[2] = avgvel[2];
<a name="l05489"></a>05489         }
<a name="l05490"></a>05490         
<a name="l05491"></a>05491         <span class="comment">// transform (=rotate) to cam space</span>
<a name="l05492"></a>05492         camco[0] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[0], fsvec);
<a name="l05493"></a>05493         camco[1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[1], fsvec);
<a name="l05494"></a>05494         camco[2] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(imat[2], fsvec);
<a name="l05495"></a>05495 
<a name="l05496"></a>05496         <span class="comment">// get homogenous coordinates</span>
<a name="l05497"></a>05497         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(camco, winmat, hoco);
<a name="l05498"></a>05498         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, ho);
<a name="l05499"></a>05499         
<a name="l05500"></a>05500         <span class="comment">/* now map hocos to screenspace, uses very primitive clip still */</span>
<a name="l05501"></a>05501         <span class="comment">// use ho[3] of original vertex, xy component of vel. direction</span>
<a name="l05502"></a>05502         <span class="keywordflow">if</span> (ho[3]&lt;0.1f) div= 10.0f;
<a name="l05503"></a>05503         <span class="keywordflow">else</span> div= 1.0f/ho[3];
<a name="l05504"></a>05504         zco[0]= zmulx*hoco[0]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l05505"></a>05505         zco[1]= zmuly*hoco[1]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l05506"></a>05506         
<a name="l05507"></a>05507         <span class="comment">// maximize speed as usual</span>
<a name="l05508"></a>05508         <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= zco[0]*zco[0] + zco[1]*zco[1];
<a name="l05509"></a>05509         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a> &gt; winsq) {
<a name="l05510"></a>05510             <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= winroot/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>);
<a name="l05511"></a>05511             zco[0]*= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; zco[1]*= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l05512"></a>05512         }
<a name="l05513"></a>05513         
<a name="l05514"></a>05514         speed= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a473ecdb98013201636c651b0fb7aeed2">RE_vertren_get_winspeed</a>(obi, ver, 1);
<a name="l05515"></a>05515         <span class="comment">// set both to the same value</span>
<a name="l05516"></a>05516         speed[0]= speed[2]= zco[0];
<a name="l05517"></a>05517         speed[1]= speed[3]= zco[1];
<a name="l05518"></a>05518         <span class="comment">//if (a &lt; 20) fprintf(stderr,&quot;speed %d %f,%f | camco %f,%f,%f | hoco %f,%f,%f,%f\n&quot;, a, speed[0], speed[1], camco[0],camco[1], camco[2], hoco[0],hoco[1], hoco[2],hoco[3]); // NT DEBUG</span>
<a name="l05519"></a>05519     }
<a name="l05520"></a>05520 
<a name="l05521"></a>05521     <span class="keywordflow">return</span> 1;
<a name="l05522"></a>05522 }
<a name="l05523"></a>05523 
<a name="l05524"></a>05524 <span class="comment">/* makes copy per object of all vectors */</span>
<a name="l05525"></a>05525 <span class="comment">/* result should be that we can free entire database */</span>
<a name="l05526"></a><a class="code" href="../../d2/d47/convertblender_8c.html#af714340c1fe052bae73b5583d4729002">05526</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#af714340c1fe052bae73b5583d4729002">copy_dbase_object_vectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l05527"></a>05527 {
<a name="l05528"></a>05528     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, *obilb;
<a name="l05529"></a>05529     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l05530"></a>05530     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05531"></a>05531     <span class="keywordtype">float</span> *vec, ho[4], winmat[4][4];
<a name="l05532"></a>05532     <span class="keywordtype">int</span> a, totvector;
<a name="l05533"></a>05533 
<a name="l05534"></a>05534     <span class="keywordflow">for</span> (obi= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l05535"></a>05535         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l05536"></a>05536 
<a name="l05537"></a>05537         obilb= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a>), <span class="stringliteral">&quot;ObInstanceVector&quot;</span>);
<a name="l05538"></a>05538         memcpy(obilb, obi, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a>));
<a name="l05539"></a>05539         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, obilb);
<a name="l05540"></a>05540 
<a name="l05541"></a>05541         obilb-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#add77214cf2a1bf5a242022a4b10fdb65">totvector</a>= totvector= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l05542"></a>05542 
<a name="l05543"></a>05543         <span class="keywordflow">if</span> (totvector &gt; 0) {
<a name="l05544"></a>05544             vec= obilb-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a4349b275d5049851ad2db4ed0b6b70bc">vectors</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(2*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totvector, <span class="stringliteral">&quot;vector array&quot;</span>);
<a name="l05545"></a>05545 
<a name="l05546"></a>05546             <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l05547"></a>05547                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l05548"></a>05548             <span class="keywordflow">else</span>
<a name="l05549"></a>05549                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l05550"></a>05550 
<a name="l05551"></a>05551             <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>; a++, vec+=2) {
<a name="l05552"></a>05552                 <span class="keywordflow">if</span> ((a &amp; 255)==0) ver= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae182ad2642ffd40fa7b4457bb5f857fe">vertnodes</a>[a&gt;&gt;8].<a class="code" href="../../d3/d86/structVertTableNode.html#a1e7b72f1c711cb5e6e7938bd839c86aa">vert</a>;
<a name="l05553"></a>05553                 <span class="keywordflow">else</span> ver++;
<a name="l05554"></a>05554                 
<a name="l05555"></a>05555                 <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, ho);
<a name="l05556"></a>05556                 <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vec, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho);
<a name="l05557"></a>05557             }
<a name="l05558"></a>05558         }
<a name="l05559"></a>05559     }
<a name="l05560"></a>05560 }
<a name="l05561"></a>05561 
<a name="l05562"></a><a class="code" href="../../d2/d47/convertblender_8c.html#aca9937d8ee6526f97a68d15d80b7de78">05562</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d2/d47/convertblender_8c.html#aca9937d8ee6526f97a68d15d80b7de78">free_dbase_object_vectors</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l05563"></a>05563 {
<a name="l05564"></a>05564     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l05565"></a>05565     
<a name="l05566"></a>05566     <span class="keywordflow">for</span> (obi= lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>)
<a name="l05567"></a>05567         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a4349b275d5049851ad2db4ed0b6b70bc">vectors</a>)
<a name="l05568"></a>05568             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a4349b275d5049851ad2db4ed0b6b70bc">vectors</a>);
<a name="l05569"></a>05569     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(lb);
<a name="l05570"></a>05570 }
<a name="l05571"></a>05571 
<a name="l05572"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a113ec870d40c2fa22c99b6427675f92e">05572</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/db6/renderdatabase_8h.html#aa26a413f2d938c2d8056451c00c413f8">RE_Database_FromScene_Vectors</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay)
<a name="l05573"></a>05573 {
<a name="l05574"></a>05574     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, *oldobi;
<a name="l05575"></a>05575     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh;
<a name="l05576"></a>05576     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d7/d35/meshtools_8c.html#ae0806484720dd424e53ea053a3cd1309">table</a>;
<a name="l05577"></a>05577     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> oldtable= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}, newtable= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l05578"></a>05578     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> strandsurface;
<a name="l05579"></a>05579     <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l05580"></a>05580     
<a name="l05581"></a>05581     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Calculating previous frame vectors&quot;</span>;
<a name="l05582"></a>05582     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3ec1fac33b9d44c9c2a26c72e5425019">R_SPEED</a>;
<a name="l05583"></a>05583     
<a name="l05584"></a>05584     <a class="code" href="../../d2/d47/convertblender_8c.html#aa3ce292e45c6efa4f2897833d47e105b">speedvector_project</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);  <span class="comment">/* initializes projection code */</span>
<a name="l05585"></a>05585     
<a name="l05586"></a>05586     <span class="comment">/* creates entire dbase */</span>
<a name="l05587"></a>05587     <a class="code" href="../../d2/d47/convertblender_8c.html#acfcb28b624a0a4b0f00ad1a2643ced51">database_fromscene_vectors</a>(re, sce, lay, -1);
<a name="l05588"></a>05588     
<a name="l05589"></a>05589     <span class="comment">/* copy away vertex info */</span>
<a name="l05590"></a>05590     <a class="code" href="../../d2/d47/convertblender_8c.html#af714340c1fe052bae73b5583d4729002">copy_dbase_object_vectors</a>(re, &amp;oldtable);
<a name="l05591"></a>05591         
<a name="l05592"></a>05592     <span class="comment">/* free dbase and make the future one */</span>
<a name="l05593"></a>05593     strandsurface= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>;
<a name="l05594"></a>05594     memset(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>));
<a name="l05595"></a>05595     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b3a3e3c89e9a1cf1dfe2f410be89067">RE_Database_Free</a>(re);
<a name="l05596"></a>05596     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>= strandsurface;
<a name="l05597"></a>05597     
<a name="l05598"></a>05598     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l05599"></a>05599         <span class="comment">/* creates entire dbase */</span>
<a name="l05600"></a>05600         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Calculating next frame vectors&quot;</span>;
<a name="l05601"></a>05601         
<a name="l05602"></a>05602         <a class="code" href="../../d2/d47/convertblender_8c.html#acfcb28b624a0a4b0f00ad1a2643ced51">database_fromscene_vectors</a>(re, sce, lay, +1);
<a name="l05603"></a>05603     }   
<a name="l05604"></a>05604     <span class="comment">/* copy away vertex info */</span>
<a name="l05605"></a>05605     <a class="code" href="../../d2/d47/convertblender_8c.html#af714340c1fe052bae73b5583d4729002">copy_dbase_object_vectors</a>(re, &amp;newtable);
<a name="l05606"></a>05606     
<a name="l05607"></a>05607     <span class="comment">/* free dbase and make the real one */</span>
<a name="l05608"></a>05608     strandsurface= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>;
<a name="l05609"></a>05609     memset(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>));
<a name="l05610"></a>05610     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0b3a3e3c89e9a1cf1dfe2f410be89067">RE_Database_Free</a>(re);
<a name="l05611"></a>05611     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>= strandsurface;
<a name="l05612"></a>05612     
<a name="l05613"></a>05613     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05614"></a>05614         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aaddef3ed714b6ed160c4dac834c08120">RE_Database_FromScene</a>(re, bmain, sce, lay, 1);
<a name="l05615"></a>05615     
<a name="l05616"></a>05616     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l05617"></a>05617         <span class="keywordtype">int</span> vectorlay= <a class="code" href="../../d2/d47/convertblender_8c.html#adaa20270133de612d22a5223c77fe378">get_vector_renderlayers</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>);
<a name="l05618"></a>05618 
<a name="l05619"></a>05619         <span class="keywordflow">for</span> (step= 0; step&lt;2; step++) {
<a name="l05620"></a>05620             
<a name="l05621"></a>05621             <span class="keywordflow">if</span> (step)
<a name="l05622"></a>05622                 table= &amp;newtable;
<a name="l05623"></a>05623             <span class="keywordflow">else</span>
<a name="l05624"></a>05624                 table= &amp;oldtable;
<a name="l05625"></a>05625             
<a name="l05626"></a>05626             oldobi= table-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l05627"></a>05627             <span class="keywordflow">for</span> (obi= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi &amp;&amp; oldobi; obi= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l05628"></a>05628                 <span class="keywordtype">int</span> ok= 1;
<a name="l05629"></a>05629                 <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd;
<a name="l05630"></a>05630 
<a name="l05631"></a>05631                 <span class="keywordflow">if</span> (!(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; vectorlay))
<a name="l05632"></a>05632                     <span class="keywordflow">continue</span>;
<a name="l05633"></a>05633 
<a name="l05634"></a>05634                 obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#add77214cf2a1bf5a242022a4b10fdb65">totvector</a>= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;
<a name="l05635"></a>05635 
<a name="l05636"></a>05636                 <span class="comment">/* find matching object in old table */</span>
<a name="l05637"></a>05637                 <span class="keywordflow">if</span> (oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>!=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a> || oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a35fcebfc79a21bea88fb434198083e46">par</a>!=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a35fcebfc79a21bea88fb434198083e46">par</a> || oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a290116685e9eeb1fd36ed826247b22e2">index</a>!=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a290116685e9eeb1fd36ed826247b22e2">index</a> || oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a6427c8a18ce573b5b14c2bf981ee1a50">psysindex</a>!=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a6427c8a18ce573b5b14c2bf981ee1a50">psysindex</a>) {
<a name="l05638"></a>05638                     ok= 0;
<a name="l05639"></a>05639                     <span class="keywordflow">for</span> (oldobi= table-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; oldobi; oldobi= oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>)
<a name="l05640"></a>05640                         <span class="keywordflow">if</span> (oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>==obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a> &amp;&amp; oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a35fcebfc79a21bea88fb434198083e46">par</a>==obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a35fcebfc79a21bea88fb434198083e46">par</a> &amp;&amp; oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a290116685e9eeb1fd36ed826247b22e2">index</a>==obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a290116685e9eeb1fd36ed826247b22e2">index</a> &amp;&amp; oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a6427c8a18ce573b5b14c2bf981ee1a50">psysindex</a>==obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a6427c8a18ce573b5b14c2bf981ee1a50">psysindex</a>)
<a name="l05641"></a>05641                             <span class="keywordflow">break</span>;
<a name="l05642"></a>05642                     <span class="keywordflow">if</span> (oldobi==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l05643"></a>05643                         oldobi= table-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l05644"></a>05644                     <span class="keywordflow">else</span>
<a name="l05645"></a>05645                         ok= 1;
<a name="l05646"></a>05646                 }
<a name="l05647"></a>05647                 <span class="keywordflow">if</span> (ok==0) {
<a name="l05648"></a>05648                      printf(<span class="stringliteral">&quot;speed table: missing object %s\n&quot;</span>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2);
<a name="l05649"></a>05649                     <span class="keywordflow">continue</span>;
<a name="l05650"></a>05650                 }
<a name="l05651"></a>05651 
<a name="l05652"></a>05652                 <span class="comment">// NT check for fluidsim special treatment</span>
<a name="l05653"></a>05653                 fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l05654"></a>05654                 <span class="keywordflow">if</span> (fluidmd &amp;&amp; fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a> &amp;&amp; (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>)) {
<a name="l05655"></a>05655                     <span class="comment">// use preloaded per vertex simulation data , only does calculation for step=1</span>
<a name="l05656"></a>05656                     <span class="comment">// NOTE/FIXME - velocities and meshes loaded unnecessarily often during the database_fromscene_vectors calls...</span>
<a name="l05657"></a>05657                     <a class="code" href="../../d2/d47/convertblender_8c.html#ad20c21dcd190f7f5fc6a2c417705ff4e">load_fluidsimspeedvectors</a>(re, obi, oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a4349b275d5049851ad2db4ed0b6b70bc">vectors</a>, step);
<a name="l05658"></a>05658                 }
<a name="l05659"></a>05659                 <span class="keywordflow">else</span> {
<a name="l05660"></a>05660                     <span class="comment">/* check if both have same amounts of vertices */</span>
<a name="l05661"></a>05661                     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#add77214cf2a1bf5a242022a4b10fdb65">totvector</a>==oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#add77214cf2a1bf5a242022a4b10fdb65">totvector</a>)
<a name="l05662"></a>05662                         <a class="code" href="../../d2/d47/convertblender_8c.html#af6cfb025acb1433aa2beb74f81c217ac">calculate_speedvectors</a>(re, obi, oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a4349b275d5049851ad2db4ed0b6b70bc">vectors</a>, step);
<a name="l05663"></a>05663                     <span class="keywordflow">else</span>
<a name="l05664"></a>05664                         printf(<span class="stringliteral">&quot;Warning: object %s has different amount of vertices or strands on other frame\n&quot;</span>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2);
<a name="l05665"></a>05665                 } <span class="comment">// not fluidsim</span>
<a name="l05666"></a>05666 
<a name="l05667"></a>05667                 oldobi= oldobi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>;
<a name="l05668"></a>05668             }
<a name="l05669"></a>05669         }
<a name="l05670"></a>05670     }
<a name="l05671"></a>05671     
<a name="l05672"></a>05672     <a class="code" href="../../d2/d47/convertblender_8c.html#aca9937d8ee6526f97a68d15d80b7de78">free_dbase_object_vectors</a>(&amp;oldtable);
<a name="l05673"></a>05673     <a class="code" href="../../d2/d47/convertblender_8c.html#aca9937d8ee6526f97a68d15d80b7de78">free_dbase_object_vectors</a>(&amp;newtable);
<a name="l05674"></a>05674 
<a name="l05675"></a>05675     <span class="keywordflow">for</span> (mesh=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; mesh; mesh=mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0cd6eb7fc691e941f6513fb7f0139077">next</a>) {
<a name="l05676"></a>05676         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>) {
<a name="l05677"></a>05677             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>);
<a name="l05678"></a>05678             mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05679"></a>05679         }
<a name="l05680"></a>05680         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>) {
<a name="l05681"></a>05681             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>);
<a name="l05682"></a>05682             mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05683"></a>05683         }
<a name="l05684"></a>05684     }
<a name="l05685"></a>05685     
<a name="l05686"></a>05686     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05687"></a>05687     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l05688"></a>05688 }
<a name="l05689"></a>05689 
<a name="l05690"></a>05690 
<a name="l05691"></a>05691 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05692"></a>05692 <span class="comment">/* Baking                                                                    */</span>
<a name="l05693"></a>05693 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05694"></a>05694 
<a name="l05695"></a>05695 <span class="comment">/* setup for shaded view or bake, so only lamps and materials are initialized */</span>
<a name="l05696"></a>05696 <span class="comment">/* type:</span>
<a name="l05697"></a>05697 <span class="comment">   RE_BAKE_LIGHT:  for shaded view, only add lamps</span>
<a name="l05698"></a>05698 <span class="comment">   RE_BAKE_ALL:    for baking, all lamps and objects</span>
<a name="l05699"></a>05699 <span class="comment">   RE_BAKE_NORMALS:for baking, no lamps and only selected objects</span>
<a name="l05700"></a>05700 <span class="comment">   RE_BAKE_AO:     for baking, no lamps, but all objects</span>
<a name="l05701"></a>05701 <span class="comment">   RE_BAKE_TEXTURE:for baking, no lamps, only selected objects</span>
<a name="l05702"></a>05702 <span class="comment">   RE_BAKE_DISPLACEMENT:for baking, no lamps, only selected objects</span>
<a name="l05703"></a>05703 <span class="comment">   RE_BAKE_SHADOW: for baking, only shadows, but all objects</span>
<a name="l05704"></a>05704 <span class="comment">*/</span>
<a name="l05705"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a747a142538232b750c308d8b19b7459b">05705</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a494aaa76640cd85e88dd1aa8dde17130">RE_Database_Baking</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keyword">const</span> <span class="keywordtype">int</span> type, <a class="code" href="../../de/de7/structObject.html">Object</a> *actob)
<a name="l05706"></a>05706 {
<a name="l05707"></a>05707     <a class="code" href="../../de/de7/structObject.html">Object</a> *camera;
<a name="l05708"></a>05708     <span class="keywordtype">float</span> mat[4][4];
<a name="l05709"></a>05709     <span class="keywordtype">float</span> amb[3];
<a name="l05710"></a>05710     <span class="keyword">const</span> <span class="keywordtype">short</span> onlyselected= !<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(type, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a7a0a3911287e4ce77023d2df50b7a365">RE_BAKE_LIGHT</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ab2021bc76fed3646f8c7d0e168d84d7d">RE_BAKE_ALL</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a3732c9545c0d6b236a1238055ccc9771">RE_BAKE_SHADOW</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0e466fa7dc01d3cb8a33917a7dc44e0c">RE_BAKE_AO</a>);
<a name="l05711"></a>05711     <span class="keyword">const</span> <span class="keywordtype">short</span> nolamps= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(type, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a25121784d1440eec23c9901cf8476820">RE_BAKE_NORMALS</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5104488c1156c3fbc69622b7fded32f7">RE_BAKE_TEXTURE</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ada2e4a24643a6fef3c1968967a0fc71b">RE_BAKE_DISPLACEMENT</a>);
<a name="l05712"></a>05712 
<a name="l05713"></a>05713     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>= bmain;
<a name="l05714"></a>05714     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>= scene;
<a name="l05715"></a>05715     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>= lay;
<a name="l05716"></a>05716 
<a name="l05717"></a>05717     <span class="comment">/* renderdata setup and exceptions */</span>
<a name="l05718"></a>05718     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>;
<a name="l05719"></a>05719     
<a name="l05720"></a>05720     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#afa7b5f5c242d59a4427ed30ab27cc513">RE_init_threadcount</a>(re);
<a name="l05721"></a>05721     
<a name="l05722"></a>05722     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#ad644b8447f228800e1fcd1adfaafe076">R_BAKING</a>;
<a name="l05723"></a>05723     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#abf7d7087b9c8b6543fbcf7c10bf98b51">excludeob</a>= actob;
<a name="l05724"></a>05724     <span class="keywordflow">if</span> (actob)
<a name="l05725"></a>05725         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#af41ea27f348b5f1a0cd77706f6bfb66e">R_BAKE_TRACE</a>;
<a name="l05726"></a>05726 
<a name="l05727"></a>05727     <span class="keywordflow">if</span> (type==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a25121784d1440eec23c9901cf8476820">RE_BAKE_NORMALS</a> &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afbbca7a09d8e0264baea2d7ba7e79271">bake_normal_space</a>==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a84fc984ae3235926494ece384069c1dc">R_BAKE_SPACE_TANGENT</a>)
<a name="l05728"></a>05728         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a15936453588e2fe16ea23308b846b267">R_NEED_TANGENT</a>;
<a name="l05729"></a>05729     
<a name="l05730"></a>05730     <span class="keywordflow">if</span> (!actob &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(type, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a7a0a3911287e4ce77023d2df50b7a365">RE_BAKE_LIGHT</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a25121784d1440eec23c9901cf8476820">RE_BAKE_NORMALS</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5104488c1156c3fbc69622b7fded32f7">RE_BAKE_TEXTURE</a>, <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ada2e4a24643a6fef3c1968967a0fc71b">RE_BAKE_DISPLACEMENT</a>)) {
<a name="l05731"></a>05731         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>;
<a name="l05732"></a>05732         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>;
<a name="l05733"></a>05733     }
<a name="l05734"></a>05734     
<a name="l05735"></a>05735     <span class="keywordflow">if</span> (!actob &amp;&amp; (type==<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a3732c9545c0d6b236a1238055ccc9771">RE_BAKE_SHADOW</a>)) {
<a name="l05736"></a>05736         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> |= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>;
<a name="l05737"></a>05737     }
<a name="l05738"></a>05738     
<a name="l05739"></a>05739     <span class="comment">/* setup render stuff */</span>
<a name="l05740"></a>05740     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aded9a47c0b0ac2b4ff044464e1c364f1">memArena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;bake db arena&quot;</span>);
<a name="l05741"></a>05741     
<a name="l05742"></a>05742     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= 0;
<a name="l05743"></a>05743     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05744"></a>05744     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05745"></a>05745 
<a name="l05746"></a>05746     <span class="comment">/* in localview, lamps are using normal layers, objects only local bits */</span>
<a name="l05747"></a>05747     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a> &amp; 0xFF000000)
<a name="l05748"></a>05748         lay &amp;= 0xFF000000;
<a name="l05749"></a>05749     
<a name="l05750"></a>05750     camera= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a079fedad6d703b0a3022a3541c77a1ac">RE_GetCamera</a>(re);
<a name="l05751"></a>05751     
<a name="l05752"></a>05752     <span class="comment">/* if no camera, set unit */</span>
<a name="l05753"></a>05753     <span class="keywordflow">if</span> (camera) {
<a name="l05754"></a>05754         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05755"></a>05755         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05756"></a>05756         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2737263fe27f6cd43262f03df6b2cdfe">RE_SetView</a>(re, mat);
<a name="l05757"></a>05757     }
<a name="l05758"></a>05758     <span class="keywordflow">else</span> {
<a name="l05759"></a>05759         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(mat);
<a name="l05760"></a>05760         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2737263fe27f6cd43262f03df6b2cdfe">RE_SetView</a>(re, mat);
<a name="l05761"></a>05761     }
<a name="l05762"></a>05762     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ace3a2e645f5e2444ade24b8b562dbace">imat</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>);
<a name="l05763"></a>05763 
<a name="l05764"></a>05764     <span class="comment">/* TODO: deep shadow maps + baking + strands */</span>
<a name="l05765"></a>05765     <span class="comment">/* strands use the window matrix and view size, there is to correct</span>
<a name="l05766"></a>05766 <span class="comment">     * window matrix but at least avoids malloc and crash loop [#27807] */</span>
<a name="l05767"></a>05767     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l05768"></a>05768     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a>= 256;
<a name="l05769"></a>05769     <span class="comment">/* done setting dummy values */</span>
<a name="l05770"></a>05770 
<a name="l05771"></a>05771     <a class="code" href="../../d0/db6/renderdatabase_8h.html#a60a634e8ea9b98602b0e207691ab6bb4">init_render_world</a>(re);  <span class="comment">/* do first, because of ambient. also requires re-&gt;osa set correct */</span>
<a name="l05772"></a>05772     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) {
<a name="l05773"></a>05773         <a class="code" href="../../d0/d0e/rendercore_8h.html#a2cd9717bc841d83c6f45aa6861ead413">init_render_qmcsampler</a>(re);
<a name="l05774"></a>05774         
<a name="l05775"></a>05775         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>))
<a name="l05776"></a>05776             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a82cd86b95a27d403b6f0bd2df37aba98">ao_samp_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a77c9804ffd340b77c103022307fc35f8">WO_AOSAMP_CONSTANT</a>)
<a name="l05777"></a>05777                 <a class="code" href="../../d0/d0e/rendercore_8h.html#addbfc82578dc6fdc226e5941647214a5">init_ao_sphere</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>);
<a name="l05778"></a>05778     }
<a name="l05779"></a>05779     
<a name="l05780"></a>05780     <span class="comment">/* still bad... doing all */</span>
<a name="l05781"></a>05781     <a class="code" href="../../df/dba/texture_8h.html#a7e81c2330dc3b0edad1d51f3df5a1365">init_render_textures</a>(re);
<a name="l05782"></a>05782     
<a name="l05783"></a>05783     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(amb, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#afe57a3755ed6c82d7e6462e7bc0c0525">ambr</a>);
<a name="l05784"></a>05784     <a class="code" href="../../d4/d0f/BKE__material_8h.html#a6c52de3316d51adaff7ed83caa8dc3aa">init_render_materials</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a>, amb);
<a name="l05785"></a>05785     
<a name="l05786"></a>05786     <a class="code" href="../../d4/d91/BKE__node_8h.html#a6cacbcbc8d8bb5da1c715db4aaa8abe0">set_node_shader_lamp_loop</a>(<a class="code" href="../../da/d3d/shading_8h.html#a1091bd5b76b59935ebd79d3a42e129d4">shade_material_loop</a>);
<a name="l05787"></a>05787     
<a name="l05788"></a>05788     <span class="comment">/* MAKE RENDER DATA */</span>
<a name="l05789"></a>05789     <a class="code" href="../../d2/d47/convertblender_8c.html#a6f965a2f9ae1b2069787dc4893d5fdb5">database_init_objects</a>(re, lay, nolamps, onlyselected, actob, 0);
<a name="l05790"></a>05790 
<a name="l05791"></a>05791     <a class="code" href="../../d2/d47/convertblender_8c.html#a997e44476011234e8d03d981bbd3a8a3">set_material_lightgroups</a>(re);
<a name="l05792"></a>05792     
<a name="l05793"></a>05793     <span class="comment">/* SHADOW BUFFER */</span>
<a name="l05794"></a>05794     <span class="keywordflow">if</span> (type!=<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a7a0a3911287e4ce77023d2df50b7a365">RE_BAKE_LIGHT</a>)
<a name="l05795"></a>05795         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)
<a name="l05796"></a>05796             <a class="code" href="../../d9/d30/shadbuf_8h.html#abe33e41b98914c843082883abbd8b81a">threaded_makeshadowbufs</a>(re);
<a name="l05797"></a>05797 
<a name="l05798"></a>05798     <span class="comment">/* raytree */</span>
<a name="l05799"></a>05799     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05800"></a>05800         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>)
<a name="l05801"></a>05801             <a class="code" href="../../d0/d0e/rendercore_8h.html#a97241e0a4a6ebc105bf9130189beac3b">makeraytree</a>(re);
<a name="l05802"></a>05802     
<a name="l05803"></a>05803     <span class="comment">/* point density texture */</span>
<a name="l05804"></a>05804     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05805"></a>05805         <a class="code" href="../../d7/def/pointdensity_8h.html#a3a9415aa3876163d3e7b8a5382c2920a">make_pointdensities</a>(re);
<a name="l05806"></a>05806 
<a name="l05807"></a>05807     <span class="comment">/* voxel data texture */</span>
<a name="l05808"></a>05808     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05809"></a>05809         <a class="code" href="../../d5/dd0/voxeldata_8h.html#ae4d37b2352b8593726bac4b3016d9032">make_voxeldata</a>(re);
<a name="l05810"></a>05810 
<a name="l05811"></a>05811     <span class="comment">/* occlusion */</span>
<a name="l05812"></a>05812     <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>)) &amp;&amp; !re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l05813"></a>05813         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a0d14a3fe319ff85a891e8616759c3469">ao_gather_method</a> == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>)
<a name="l05814"></a>05814             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)
<a name="l05815"></a>05815                 <a class="code" href="../../d2/d3a/occlusion_8h.html#acdcc581028d4df27fb1e8888e198f1a6">make_occ_tree</a>(re);
<a name="l05816"></a>05816 }
<a name="l05817"></a>05817 
<a name="l05818"></a>05818 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05819"></a>05819 <span class="comment">/* Sticky texture coords                                                     */</span>
<a name="l05820"></a>05820 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l05821"></a>05821 
<a name="l05822"></a><a class="code" href="../../d2/d47/convertblender_8c.html#a7718fa065d19643a0d3f112b6f989bd1">05822</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#aa2e2e4e29b92fe146033880f6cb05372">RE_make_sticky</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l05823"></a>05823 {
<a name="l05824"></a>05824     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l05825"></a>05825     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l05826"></a>05826     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l05827"></a>05827     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l05828"></a>05828     <a class="code" href="../../da/d0c/structMSticky.html">MSticky</a> *ms;
<a name="l05829"></a>05829     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re;
<a name="l05830"></a>05830     <span class="keywordtype">float</span> ho[4], mat[4][4];
<a name="l05831"></a>05831     <span class="keywordtype">int</span> a;
<a name="l05832"></a>05832     <a class="code" href="../../de/de7/structObject.html">Object</a> *camera= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05833"></a>05833 
<a name="l05834"></a>05834     <span class="keywordflow">if</span> (v3d==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05835"></a>05835         printf(<span class="stringliteral">&quot;Need a 3d view to make sticky\n&quot;</span>);
<a name="l05836"></a>05836         <span class="keywordflow">return</span>;
<a name="l05837"></a>05837     }
<a name="l05838"></a>05838 
<a name="l05839"></a>05839     <span class="keywordflow">if</span> (v3d)                camera= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa073642ea5eccb6ef8aaa7deca4e2a0c">V3D_CAMERA_LOCAL</a>(v3d);
<a name="l05840"></a>05840     <span class="keywordflow">if</span> (camera == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) camera= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>;
<a name="l05841"></a>05841 
<a name="l05842"></a>05842     <span class="keywordflow">if</span> (camera==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l05843"></a>05843         printf(<span class="stringliteral">&quot;Need camera to make sticky\n&quot;</span>);
<a name="l05844"></a>05844         <span class="keywordflow">return</span>;
<a name="l05845"></a>05845     }
<a name="l05846"></a>05846     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>) {
<a name="l05847"></a>05847         printf(<span class="stringliteral">&quot;Unable to make sticky in Edit Mode\n&quot;</span>);
<a name="l05848"></a>05848         <span class="keywordflow">return</span>;
<a name="l05849"></a>05849     }
<a name="l05850"></a>05850     
<a name="l05851"></a>05851     re= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aa539d2c227f40725b93fe2df94a76bd1">RE_NewRender</a>(<span class="stringliteral">&quot;_make sticky_&quot;</span>);
<a name="l05852"></a>05852     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a153b5eeffd3b7a00c6ad23c8dbd92f93">RE_InitState</a>(re, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afac89783028ff848f111de04e0c29fbe">xsch</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aca3c1ebdf50a6c74730e19e24983217d">ysch</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05853"></a>05853     
<a name="l05854"></a>05854     <span class="comment">/* use renderdata and camera to set viewplane */</span>
<a name="l05855"></a>05855     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ac535e8f972cf47aeed2c7f76ef6bb827">RE_SetCamera</a>(re, camera);
<a name="l05856"></a>05856 
<a name="l05857"></a>05857     <span class="comment">/* and set view matrix */</span>
<a name="l05858"></a>05858     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05859"></a>05859     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, camera-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05860"></a>05860     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a2737263fe27f6cd43262f03df6b2cdfe">RE_SetView</a>(re, mat);
<a name="l05861"></a>05861     
<a name="l05862"></a>05862     <span class="keywordflow">for</span> (base= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8e4d7097454ad5b3dfde455bf35b6450">FIRSTBASE</a>; base; base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l05863"></a>05863         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8d25ad9ae79efd1636a91eb64c5d3613">TESTBASELIB</a>(v3d, base)) {
<a name="l05864"></a>05864             <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l05865"></a>05865                 ob= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l05866"></a>05866                 
<a name="l05867"></a>05867                 me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l05868"></a>05868                 mvert= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l05869"></a>05869                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a79dc3a13e37ce76df15ae04453a1f58d">msticky</a>)
<a name="l05870"></a>05870                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a206492daaf4a7bd388312de4d295cca8">CustomData_free_layer_active</a>(&amp;me-&gt;vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a1f53e1636e6961e60b631943d55cedb5">CD_MSTICKY</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l05871"></a>05871                 me-&gt;<a class="code" href="../../da/d29/structMesh.html#a79dc3a13e37ce76df15ae04453a1f58d">msticky</a>= <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a1f53e1636e6961e60b631943d55cedb5">CD_MSTICKY</a>,
<a name="l05872"></a>05872                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l05873"></a>05873                 
<a name="l05874"></a>05874                 <a class="code" href="../../df/dac/BKE__object_8h.html#a8826fda9a63117e29f5340dd9db86998">where_is_object</a>(scene, ob);
<a name="l05875"></a>05875                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l05876"></a>05876                 
<a name="l05877"></a>05877                 ms= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a79dc3a13e37ce76df15ae04453a1f58d">msticky</a>;
<a name="l05878"></a>05878                 <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, ms++, mvert++) {
<a name="l05879"></a>05879                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ho, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l05880"></a>05880                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, ho);
<a name="l05881"></a>05881                     <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>(ho, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, ho);
<a name="l05882"></a>05882                     ms-&gt;co[0]= ho[0]/ho[3];
<a name="l05883"></a>05883                     ms-&gt;co[1]= ho[1]/ho[3];
<a name="l05884"></a>05884                 }
<a name="l05885"></a>05885             }
<a name="l05886"></a>05886         }
<a name="l05887"></a>05887     }
<a name="l05888"></a>05888 }
<a name="l05889"></a>05889 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:12 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
