<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: WTURBULENCE.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">WTURBULENCE.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d2/d40/WTURBULENCE_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="comment">// This file is part of Wavelet Turbulence.</span>
<a name="l00006"></a>00006 <span class="comment">// </span>
<a name="l00007"></a>00007 <span class="comment">// Wavelet Turbulence is free software: you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">// it under the terms of the GNU General Public License as published by</span>
<a name="l00009"></a>00009 <span class="comment">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">// (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment">// </span>
<a name="l00012"></a>00012 <span class="comment">// Wavelet Turbulence is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment">// </span>
<a name="l00017"></a>00017 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment">// along with Wavelet Turbulence.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00019"></a>00019 <span class="comment">// </span>
<a name="l00020"></a>00020 <span class="comment">// Copyright 2008 Theodore Kim and Nils Thuerey</span>
<a name="l00021"></a>00021 <span class="comment">// </span>
<a name="l00022"></a>00022 <span class="comment">// WTURBULENCE handling</span>
<a name="l00024"></a>00024 <span class="comment"></span><span class="comment">// Parallelized turbulence even further. TNT matrix library functions</span>
<a name="l00025"></a>00025 <span class="comment">// rewritten to improve performance.</span>
<a name="l00026"></a>00026 <span class="comment">//      - MiikaH</span>
<a name="l00028"></a>00028 <span class="comment"></span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dfd/WTURBULENCE_8h.html">WTURBULENCE.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d5b/INTERPOLATE_8h.html">INTERPOLATE.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d46/IMAGE_8h.html">IMAGE.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="../../d2/d5c/MERSENNETWISTER_8h.html">MERSENNETWISTER.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html">WAVELET_NOISE.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/da9/FFT__NOISE_8h.html">FFT_NOISE.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d0b/EIGENVALUE__HELPER_8h.html">EIGENVALUE_HELPER.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d6d/LU__HELPER_8h.html">LU_HELPER.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../de/dfd/SPHERE_8h.html">SPHERE.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;zlib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// needed to access static advection functions</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd5/FLUID__3D_8h.html">FLUID_3D.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#include &lt;omp.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#endif // PARALLEL </span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="comment">// 2^ {-5/6}</span>
<a name="l00049"></a><a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6447f52d1fc2c6a217bc44515023bf8a">00049</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6447f52d1fc2c6a217bc44515023bf8a">persistence</a> = 0.56123f;
<a name="l00050"></a>00050 
<a name="l00052"></a>00052 <span class="comment">// constructor</span>
<a name="l00054"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a307838d5716d4489ac80f01c8ba33113">00054</a> <span class="comment"></span><a class="code" href="../../d3/d65/classWTURBULENCE.html#a307838d5716d4489ac80f01c8ba33113">WTURBULENCE::WTURBULENCE</a>(<span class="keywordtype">int</span> xResSm, <span class="keywordtype">int</span> yResSm, <span class="keywordtype">int</span> zResSm, <span class="keywordtype">int</span> amplify, <span class="keywordtype">int</span> noisetype)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <span class="comment">// if noise magnitude is below this threshold, its contribution</span>
<a name="l00057"></a>00057     <span class="comment">// is negilgible, so stop evaluating new octaves</span>
<a name="l00058"></a>00058     <a class="code" href="../../d3/d65/classWTURBULENCE.html#acbdf7bd91b1721e9a25f1af49eecf3e2">_cullingThreshold</a> = 1e-3;
<a name="l00059"></a>00059     
<a name="l00060"></a>00060     <span class="comment">// factor by which to increase the simulation resolution</span>
<a name="l00061"></a>00061     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a1f9d322e92ae382abfd53dbc597d75d0">_amplify</a> = amplify;
<a name="l00062"></a>00062     
<a name="l00063"></a>00063     <span class="comment">// manually adjust the overall amount of turbulence</span>
<a name="l00064"></a>00064     <span class="comment">// DG - RNA-fied _strength = 2.;</span>
<a name="l00065"></a>00065     
<a name="l00066"></a>00066     <span class="comment">// add the corresponding octaves of noise</span>
<a name="l00067"></a>00067     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a91a60dfe7c51d58bba67eeb5b918014c">_octaves</a> = (int)(<a class="code" href="../../d1/d22/stdosl_8h.html#a652ed6fadc80671ca500c85d11bce898">log</a>((<span class="keywordtype">float</span>)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a1f9d322e92ae382abfd53dbc597d75d0">_amplify</a>) / <a class="code" href="../../d1/d22/stdosl_8h.html#a652ed6fadc80671ca500c85d11bce898">log</a>(2.0f) + 0.5); <span class="comment">// XXX DEBUG/ TODO: int casting correct? - dg</span>
<a name="l00068"></a>00068     
<a name="l00069"></a>00069     <span class="comment">// noise resolution</span>
<a name="l00070"></a>00070     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a747c6eb427ffe03b7800decb40af9ebc">_xResBig</a> = _amplify * xResSm;
<a name="l00071"></a>00071     <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac3d700209e095b787ef2d5a15b9850e2">_yResBig</a> = _amplify * yResSm;
<a name="l00072"></a>00072     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a> = _amplify * zResSm;
<a name="l00073"></a>00073     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a> = <a class="code" href="../../db/de1/namespaceBasicVector.html#aba6b6aad6dbf7fd95ad0ff8f88db4892">Vec3Int</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a747c6eb427ffe03b7800decb40af9ebc">_xResBig</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac3d700209e095b787ef2d5a15b9850e2">_yResBig</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>);
<a name="l00074"></a>00074     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6498efbe3f35b63b959eb253fcab7839">_invResBig</a> = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(1./(<span class="keywordtype">float</span>)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[0], 1./(<span class="keywordtype">float</span>)_resBig[1], 1./(<span class="keywordtype">float</span>)_resBig[2]);
<a name="l00075"></a>00075     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5b8bee36f2035d2a7a81ff8acd0ba67a">_slabSizeBig</a> = <a class="code" href="../../d3/d65/classWTURBULENCE.html#a747c6eb427ffe03b7800decb40af9ebc">_xResBig</a>*<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac3d700209e095b787ef2d5a15b9850e2">_yResBig</a>;
<a name="l00076"></a>00076     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a> = <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5b8bee36f2035d2a7a81ff8acd0ba67a">_slabSizeBig</a> * <a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>;
<a name="l00077"></a>00077     
<a name="l00078"></a>00078     <span class="comment">// original / small resolution</span>
<a name="l00079"></a>00079     <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a> = xResSm;
<a name="l00080"></a>00080     <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a> = yResSm;
<a name="l00081"></a>00081     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a> = zResSm;
<a name="l00082"></a>00082     <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a> = <a class="code" href="../../db/de1/namespaceBasicVector.html#aba6b6aad6dbf7fd95ad0ff8f88db4892">Vec3Int</a>(xResSm, yResSm, zResSm);
<a name="l00083"></a>00083     <a class="code" href="../../d3/d65/classWTURBULENCE.html#ab686804b437c61b70ccd4ee95e7e0e73">_invResSm</a> = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(1./(<span class="keywordtype">float</span>)<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[0], 1./(<span class="keywordtype">float</span>)_resSm[1], 1./(<span class="keywordtype">float</span>)_resSm[2] );
<a name="l00084"></a>00084     <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a> = <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>*<a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>;
<a name="l00085"></a>00085     <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a> = <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a> * <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>;
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     <span class="comment">// allocate high resolution density field</span>
<a name="l00088"></a>00088     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a680d2da892e6d523a2491c4e8d5b1325">_totalStepsBig</a> = 0;
<a name="l00089"></a>00089     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>];
<a name="l00090"></a>00090     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>]; 
<a name="l00091"></a>00091     
<a name="l00092"></a>00092     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00093"></a>00093         <a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 
<a name="l00094"></a>00094         <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.;
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="comment">// allocate &amp; init texture coordinates</span>
<a name="l00098"></a>00098     <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>];
<a name="l00099"></a>00099     <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>];
<a name="l00100"></a>00100     <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>];
<a name="l00101"></a>00101     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>];
<a name="l00102"></a>00102     
<a name="l00103"></a>00103     <span class="comment">// map all </span>
<a name="l00104"></a>00104     <span class="keyword">const</span> <span class="keywordtype">float</span> dx = 1./(float)(_resSm[0]);
<a name="l00105"></a>00105     <span class="keyword">const</span> <span class="keywordtype">float</span> dy = 1./(float)(_resSm[1]);
<a name="l00106"></a>00106     <span class="keyword">const</span> <span class="keywordtype">float</span> dz = 1./(float)(_resSm[2]);
<a name="l00107"></a>00107     <span class="keywordtype">int</span> index = 0;
<a name="l00108"></a>00108     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 0; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>; z++) 
<a name="l00109"></a>00109     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>; y++) 
<a name="l00110"></a>00110         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>; x++, index++)
<a name="l00111"></a>00111         {
<a name="l00112"></a>00112         <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>[index] = x*dx;
<a name="l00113"></a>00113         <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>[index] = y*dy;
<a name="l00114"></a>00114         <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>[index] = z*dz;
<a name="l00115"></a>00115         <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>[index] = 0.;
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <span class="comment">// noise tiles</span>
<a name="l00119"></a>00119     <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a> = <span class="keyword">new</span> <span class="keywordtype">float</span>[<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ac1b4ff2b1dfd92decb0fe721ef953528">noiseTileSize</a> * <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ac1b4ff2b1dfd92decb0fe721ef953528">noiseTileSize</a> * <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ac1b4ff2b1dfd92decb0fe721ef953528">noiseTileSize</a>];
<a name="l00120"></a>00120     <span class="comment">/*</span>
<a name="l00121"></a>00121 <span class="comment">    std::string noiseTileFilename = std::string(&quot;noise.wavelets&quot;);</span>
<a name="l00122"></a>00122 <span class="comment">    generateTile_WAVELET(_noiseTile, noiseTileFilename);</span>
<a name="l00123"></a>00123 <span class="comment">    */</span>
<a name="l00124"></a>00124     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a750a995e5ecf02baae0eb53da5f63a3b">setNoise</a>(noisetype);
<a name="l00125"></a>00125     <span class="comment">/*</span>
<a name="l00126"></a>00126 <span class="comment">    std::string noiseTileFilename = std::string(&quot;noise.fft&quot;);</span>
<a name="l00127"></a>00127 <span class="comment">    generatTile_FFT(_noiseTile, noiseTileFilename);</span>
<a name="l00128"></a>00128 <span class="comment">    */</span>
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00132"></a>00132 <span class="comment">// destructor</span>
<a name="l00134"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#aed887efe3da9167861c0baf968e79634">00134</a> <span class="comment"></span><a class="code" href="../../d3/d65/classWTURBULENCE.html#aed887efe3da9167861c0baf968e79634" title="destructor">WTURBULENCE::~WTURBULENCE</a>() {
<a name="l00135"></a>00135   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>;
<a name="l00136"></a>00136   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>;
<a name="l00139"></a>00139   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>;
<a name="l00140"></a>00140   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>;
<a name="l00141"></a>00141   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keyword">delete</span>[] <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00147"></a>00147 <span class="comment">// Change noise type</span>
<a name="l00148"></a>00148 <span class="comment">//</span>
<a name="l00149"></a>00149 <span class="comment">// type (1&lt;&lt;0) = wavelet / 2</span>
<a name="l00150"></a>00150 <span class="comment">// type (1&lt;&lt;1) = FFT / 4</span>
<a name="l00151"></a>00151 <span class="comment">// type (1&lt;&lt;2) = curl / 8</span>
<a name="l00153"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a750a995e5ecf02baae0eb53da5f63a3b">00153</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a750a995e5ecf02baae0eb53da5f63a3b">WTURBULENCE::setNoise</a>(<span class="keywordtype">int</span> type)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <span class="keywordflow">if</span>(type == (1&lt;&lt;1)) <span class="comment">// FFT</span>
<a name="l00156"></a>00156     {
<a name="l00157"></a>00157         <span class="comment">// needs fft</span>
<a name="l00158"></a>00158 <span class="preprocessor">        #ifdef WITH_FFTW3</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>        std::string noiseTileFilename = std::string(<span class="stringliteral">&quot;noise.fft&quot;</span>);
<a name="l00160"></a>00160         generatTile_FFT(<a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>, noiseTileFilename);
<a name="l00161"></a>00161 <span class="preprocessor">        #endif</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>    }
<a name="l00163"></a>00163     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type == (1&lt;&lt;2)) <span class="comment">// curl</span>
<a name="l00164"></a>00164     {
<a name="l00165"></a>00165         <span class="comment">// TODO: not supported yet</span>
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167     <span class="keywordflow">else</span> <span class="comment">// standard - wavelet</span>
<a name="l00168"></a>00168     {
<a name="l00169"></a>00169         std::string noiseTileFilename = std::string(<span class="stringliteral">&quot;noise.wavelets&quot;</span>);
<a name="l00170"></a>00170         <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a4227db97d5d85fe4a6890b93d13f02e2">generateTile_WAVELET</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>, noiseTileFilename);
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="comment">// init direct access functions from blender</span>
<a name="l00175"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a6b0f746018493e7a68670a12d39bb8b6">00175</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6b0f746018493e7a68670a12d39bb8b6">WTURBULENCE::initBlenderRNA</a>(<span class="keywordtype">float</span> *strength)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a30228833063009eb5b5a7e10dfbc65e8">_strength</a> = strength;
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00181"></a>00181 <span class="comment">// Get the smallest valid x derivative</span>
<a name="l00182"></a>00182 <span class="comment">//</span>
<a name="l00183"></a>00183 <span class="comment">// Takes the one-sided finite difference in both directions and</span>
<a name="l00184"></a>00184 <span class="comment">// selects the smaller of the two</span>
<a name="l00186"></a><a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">00186</a> <span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">float</span>* input, <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3Int</a> res)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188   <span class="keyword">const</span> <span class="keywordtype">int</span> index = x + y * res[0] + z * res[0] * res[1];
<a name="l00189"></a>00189   <span class="keyword">const</span> <span class="keywordtype">int</span> maxx = res[0]-2;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191   <span class="comment">// get grid values</span>
<a name="l00192"></a>00192   <span class="keywordtype">float</span> center = input[index];
<a name="l00193"></a>00193   <span class="keywordtype">float</span> <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>  = (x &lt;= 1)    ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index - 1];
<a name="l00194"></a>00194   <span class="keywordtype">float</span> right = (x &gt;= maxx) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index + 1];
<a name="l00195"></a>00195 
<a name="l00196"></a>00196   <span class="keyword">const</span> <span class="keywordtype">float</span> dx = res[0];
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="comment">// get all the derivative estimates</span>
<a name="l00199"></a>00199   <span class="keywordtype">float</span> dLeft   = (x &lt;= 1)     ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (center - left) * dx;
<a name="l00200"></a>00200   <span class="keywordtype">float</span> dRight  = (x &gt;= maxx)  ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (right - center) * dx;
<a name="l00201"></a>00201   <span class="keywordtype">float</span> dCenter = (x &lt;= 1 || x &gt;= maxx) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (right - left) * dx * 0.5f;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="comment">// if it&#39;s on a boundary, only one estimate is valid</span>
<a name="l00204"></a>00204   <span class="keywordflow">if</span> (x &lt;= 1) <span class="keywordflow">return</span> dRight;
<a name="l00205"></a>00205   <span class="keywordflow">if</span> (x &gt;= maxx) <span class="keywordflow">return</span> dLeft;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">// if it&#39;s not on a boundary, get the smallest one</span>
<a name="l00208"></a>00208   <span class="keywordtype">float</span> finalD;
<a name="l00209"></a>00209   finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dCenter) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dRight)) ? dCenter : dRight;
<a name="l00210"></a>00210   finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(finalD)  &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dLeft))  ? finalD  : dLeft;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="keywordflow">return</span> finalD;
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00216"></a>00216 <span class="comment">// get the smallest valid y derivative</span>
<a name="l00217"></a>00217 <span class="comment">//</span>
<a name="l00218"></a>00218 <span class="comment">// Takes the one-sided finite difference in both directions and</span>
<a name="l00219"></a>00219 <span class="comment">// selects the smaller of the two</span>
<a name="l00221"></a><a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">00221</a> <span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">float</span>* input, <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3Int</a> res)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223   <span class="keyword">const</span> <span class="keywordtype">int</span> index = x + y * res[0] + z * res[0] * res[1];
<a name="l00224"></a>00224   <span class="keyword">const</span> <span class="keywordtype">int</span> maxy = res[1]-2;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">// get grid values</span>
<a name="l00227"></a>00227   <span class="keywordtype">float</span> center = input[index];
<a name="l00228"></a>00228   <span class="keywordtype">float</span> down  = (y &lt;= 1) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index - res[0]];
<a name="l00229"></a>00229   <span class="keywordtype">float</span> up = (y &gt;= maxy) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index + res[0]];
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="keyword">const</span> <span class="keywordtype">float</span> dx = res[1]; <span class="comment">// only for square domains</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   <span class="comment">// get all the derivative estimates</span>
<a name="l00234"></a>00234   <span class="keywordtype">float</span> dDown   = (y &lt;= 1)  ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (center - down) * dx;
<a name="l00235"></a>00235   <span class="keywordtype">float</span> dUp  = (y &gt;= maxy)  ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (up - center) * dx;
<a name="l00236"></a>00236   <span class="keywordtype">float</span> dCenter = (y &lt;= 1 || y &gt;= maxy) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (up - down) * dx * 0.5f;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="comment">// if it&#39;s on a boundary, only one estimate is valid</span>
<a name="l00239"></a>00239   <span class="keywordflow">if</span> (y &lt;= 1) <span class="keywordflow">return</span> dUp;
<a name="l00240"></a>00240   <span class="keywordflow">if</span> (y &gt;= maxy) <span class="keywordflow">return</span> dDown;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="comment">// if it&#39;s not on a boundary, get the smallest one</span>
<a name="l00243"></a>00243   <span class="keywordtype">float</span> finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dCenter) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dUp)) ? dCenter : dUp;
<a name="l00244"></a>00244   finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(finalD) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dDown)) ? finalD : dDown;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246   <span class="keywordflow">return</span> finalD;
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00250"></a>00250 <span class="comment">// get the smallest valid z derivative</span>
<a name="l00251"></a>00251 <span class="comment">//</span>
<a name="l00252"></a>00252 <span class="comment">// Takes the one-sided finite difference in both directions and</span>
<a name="l00253"></a>00253 <span class="comment">// selects the smaller of the two</span>
<a name="l00255"></a><a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">00255</a> <span class="comment"></span><span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">float</span>* input, <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3Int</a> res)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257   <span class="keyword">const</span> <span class="keywordtype">int</span> slab = res[0]*res[1];
<a name="l00258"></a>00258   <span class="keyword">const</span> <span class="keywordtype">int</span> index = x + y * res[0] + z * slab;
<a name="l00259"></a>00259   <span class="keyword">const</span> <span class="keywordtype">int</span> maxz = res[2]-2;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   <span class="comment">// get grid values</span>
<a name="l00262"></a>00262   <span class="keywordtype">float</span> center = input[index];
<a name="l00263"></a>00263   <span class="keywordtype">float</span> front  = (z &lt;= 1) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index - slab];
<a name="l00264"></a>00264   <span class="keywordtype">float</span> back = (z &gt;= maxz) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : input[index + slab];
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="keyword">const</span> <span class="keywordtype">float</span> dx = res[2]; <span class="comment">// only for square domains</span>
<a name="l00267"></a>00267 
<a name="l00268"></a>00268   <span class="comment">// get all the derivative estimates</span>
<a name="l00269"></a>00269   <span class="keywordtype">float</span> dfront   = (z &lt;= 1)  ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (center - front) * dx;
<a name="l00270"></a>00270   <span class="keywordtype">float</span> dback  = (z &gt;= maxz)  ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (back - center) * dx;
<a name="l00271"></a>00271   <span class="keywordtype">float</span> dCenter = (z &lt;= 1 || z &gt;= maxz) ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : (back - front) * dx * 0.5f;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <span class="comment">// if it&#39;s on a boundary, only one estimate is valid</span>
<a name="l00274"></a>00274   <span class="keywordflow">if</span> (z &lt;= 1) <span class="keywordflow">return</span> dback;
<a name="l00275"></a>00275   <span class="keywordflow">if</span> (z &gt;= maxz) <span class="keywordflow">return</span> dfront;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="comment">// if it&#39;s not on a boundary, get the smallest one</span>
<a name="l00278"></a>00278   <span class="keywordtype">float</span> finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dCenter) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dback)) ? dCenter : dback;
<a name="l00279"></a>00279   finalD = (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(finalD) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dfront)) ? finalD : dfront;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   <span class="keywordflow">return</span> finalD;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00285"></a>00285 <span class="comment">// handle texture coordinates (advection, reset, eigenvalues), </span>
<a name="l00286"></a>00286 <span class="comment">// Beware -- uses big density maccormack as temporary arrays</span>
<a name="l00288"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#af0de15b431ebd7e3cb586633028d21cb">00288</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#af0de15b431ebd7e3cb586633028d21cb">WTURBULENCE::advectTextureCoordinates</a> (<span class="keywordtype">float</span> dtOrg, <span class="keywordtype">float</span>* xvel, <span class="keywordtype">float</span>* yvel, <span class="keywordtype">float</span>* zvel, <span class="keywordtype">float</span> *tempBig1, <span class="keywordtype">float</span> *tempBig2) {
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <span class="comment">// advection</span>
<a name="l00291"></a>00291   <a class="code" href="../../dd/d46/IMAGE_8h.html#aea6cdcc73e7454e3bf7f8460239d2027">SWAP_POINTERS</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>);
<a name="l00292"></a>00292   <a class="code" href="../../d6/dac/classFLUID__3D.html#ac57adcc22fd49a5a64cc936919578e6b">FLUID_3D::copyBorderX</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00293"></a>00293   <a class="code" href="../../d6/dac/classFLUID__3D.html#a929322f13dd57335ac89e17fb8a89e79">FLUID_3D::copyBorderY</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00294"></a>00294   <a class="code" href="../../d6/dac/classFLUID__3D.html#a6e27eca99e7a03655df1039078f68e49">FLUID_3D::copyBorderZ</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00295"></a>00295   <a class="code" href="../../d6/dac/classFLUID__3D.html#af5d216db7094bc089061a5a9bb594695">FLUID_3D::advectFieldMacCormack1</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00296"></a>00296       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, tempBig1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00297"></a>00297   <a class="code" href="../../d6/dac/classFLUID__3D.html#aa541e4c2f5610b5169c2b782af481dea">FLUID_3D::advectFieldMacCormack2</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00298"></a>00298       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, tempBig1, tempBig2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <a class="code" href="../../dd/d46/IMAGE_8h.html#aea6cdcc73e7454e3bf7f8460239d2027">SWAP_POINTERS</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>);
<a name="l00301"></a>00301   <a class="code" href="../../d6/dac/classFLUID__3D.html#ac57adcc22fd49a5a64cc936919578e6b">FLUID_3D::copyBorderX</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00302"></a>00302   <a class="code" href="../../d6/dac/classFLUID__3D.html#a929322f13dd57335ac89e17fb8a89e79">FLUID_3D::copyBorderY</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00303"></a>00303   <a class="code" href="../../d6/dac/classFLUID__3D.html#a6e27eca99e7a03655df1039078f68e49">FLUID_3D::copyBorderZ</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00304"></a>00304   <a class="code" href="../../d6/dac/classFLUID__3D.html#af5d216db7094bc089061a5a9bb594695">FLUID_3D::advectFieldMacCormack1</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00305"></a>00305       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, tempBig1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00306"></a>00306   <a class="code" href="../../d6/dac/classFLUID__3D.html#aa541e4c2f5610b5169c2b782af481dea">FLUID_3D::advectFieldMacCormack2</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00307"></a>00307       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, tempBig1, tempBig2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309   <a class="code" href="../../dd/d46/IMAGE_8h.html#aea6cdcc73e7454e3bf7f8460239d2027">SWAP_POINTERS</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>);
<a name="l00310"></a>00310   <a class="code" href="../../d6/dac/classFLUID__3D.html#ac57adcc22fd49a5a64cc936919578e6b">FLUID_3D::copyBorderX</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00311"></a>00311   <a class="code" href="../../d6/dac/classFLUID__3D.html#a929322f13dd57335ac89e17fb8a89e79">FLUID_3D::copyBorderY</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00312"></a>00312   <a class="code" href="../../d6/dac/classFLUID__3D.html#a6e27eca99e7a03655df1039078f68e49">FLUID_3D::copyBorderZ</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00313"></a>00313   <a class="code" href="../../d6/dac/classFLUID__3D.html#af5d216db7094bc089061a5a9bb594695">FLUID_3D::advectFieldMacCormack1</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00314"></a>00314       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, tempBig1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00315"></a>00315   <a class="code" href="../../d6/dac/classFLUID__3D.html#aa541e4c2f5610b5169c2b782af481dea">FLUID_3D::advectFieldMacCormack2</a>(dtOrg, xvel, yvel, zvel, 
<a name="l00316"></a>00316       <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, tempBig1, tempBig2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00320"></a>00320 <span class="comment">// Compute the eigenvalues of the advected texture</span>
<a name="l00322"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9f309e650bbedf2b6e46c5703a1398f">00322</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9f309e650bbedf2b6e46c5703a1398f">WTURBULENCE::computeEigenvalues</a>(<span class="keywordtype">float</span> *_eigMin, <span class="keywordtype">float</span> *_eigMax) {
<a name="l00323"></a>00323   <span class="comment">// stats</span>
<a name="l00324"></a>00324   <span class="keywordtype">float</span> maxeig = -1.;
<a name="l00325"></a>00325   <span class="keywordtype">float</span> mineig = 10.;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327   <span class="comment">// texture coordinate eigenvalues</span>
<a name="l00328"></a>00328   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 1; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>-1; z++) {
<a name="l00329"></a>00329     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>-1; y++) 
<a name="l00330"></a>00330       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>-1; x++)
<a name="l00331"></a>00331       {
<a name="l00332"></a>00332         <span class="keyword">const</span> <span class="keywordtype">int</span> index = x+ y *<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[0] + z*<a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="comment">// compute jacobian</span>
<a name="l00335"></a>00335         <span class="keywordtype">float</span> jacobian[3][3] = {
<a name="l00336"></a>00336           { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) } ,
<a name="l00337"></a>00337           { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) } ,
<a name="l00338"></a>00338           { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(x, y, z, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) }
<a name="l00339"></a>00339         };
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="comment">// ONLY compute the eigenvalues after checking that the matrix</span>
<a name="l00342"></a>00342         <span class="comment">// is nonsingular</span>
<a name="l00343"></a>00343         <a class="code" href="../../de/d94/structsLU.html">sLU</a> LU = <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#a87dc0fa58e124d3f533cdb14cc68df51">computeLU</a>(jacobian);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (<a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#a8eb54c27d25ac2103eb45571005f16c1">isNonsingular</a>(LU))
<a name="l00346"></a>00346         {
<a name="l00347"></a>00347           <span class="comment">// get the analytic eigenvalues, quite slow right now...</span>
<a name="l00348"></a>00348           <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> eigenvalues = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(1.);
<a name="l00349"></a>00349           <a class="code" href="../../d1/d05/EIGENVALUE__HELPER_8cpp.html#a3582d3e64171dfc96191bf4c42abfc8c">computeEigenvalues3x3</a>( &amp;eigenvalues[0], jacobian);
<a name="l00350"></a>00350           _eigMax[index] = <a class="code" href="../../dd/d46/IMAGE_8h.html#aa3c04c74e20681b43cbdf41ab39d8ad9">MAX3V</a>(eigenvalues);
<a name="l00351"></a>00351           _eigMin[index] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a89dbd4641586f8d3180f77688f3ed70a">MIN3V</a>(eigenvalues);
<a name="l00352"></a>00352           maxeig = <a class="code" href="../../d4/d22/BOP__CarveInterface_8cpp.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(_eigMax[index],maxeig);
<a name="l00353"></a>00353           mineig = <a class="code" href="../../d4/d22/BOP__CarveInterface_8cpp.html#a74e75242132eaabbc1c512488a135926">MIN</a>(_eigMin[index],mineig);
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355         <span class="keywordflow">else</span>
<a name="l00356"></a>00356         {
<a name="l00357"></a>00357           _eigMax[index] = 10.0f;
<a name="l00358"></a>00358           _eigMin[index] = 0.1;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360       }
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00365"></a>00365 <span class="comment">// advect &amp; reset texture coordinates based on eigenvalues</span>
<a name="l00367"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a2b9d0e275c6c3e40552d9fd2f4b54105">00367</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a2b9d0e275c6c3e40552d9fd2f4b54105">WTURBULENCE::resetTextureCoordinates</a>(<span class="keywordtype">float</span> *_eigMin, <span class="keywordtype">float</span> *_eigMax) 
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369   <span class="comment">// allowed deformation of the textures</span>
<a name="l00370"></a>00370   <span class="keyword">const</span> <span class="keywordtype">float</span> limit = 2.f;
<a name="l00371"></a>00371   <span class="keyword">const</span> <span class="keywordtype">float</span> limitInv = 1./limit;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="comment">// standard reset</span>
<a name="l00374"></a>00374   <span class="keywordtype">int</span> resets = 0;
<a name="l00375"></a>00375   <span class="keyword">const</span> <span class="keywordtype">float</span> dx = 1./(float)(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[0]);
<a name="l00376"></a>00376   <span class="keyword">const</span> <span class="keywordtype">float</span> dy = 1./(float)(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[1]);
<a name="l00377"></a>00377   <span class="keyword">const</span> <span class="keywordtype">float</span> dz = 1./(float)(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 1; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>-1; z++)
<a name="l00380"></a>00380     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>-1; y++)
<a name="l00381"></a>00381       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>-1; x++)
<a name="l00382"></a>00382       {
<a name="l00383"></a>00383         <span class="keyword">const</span> <span class="keywordtype">int</span> index = x+ y *<a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[0] + z*<a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>;
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (_eigMax[index] &gt; limit || _eigMin[index] &lt; limitInv)
<a name="l00385"></a>00385         {
<a name="l00386"></a>00386           <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>[index] = (float)x * dx;
<a name="l00387"></a>00387           <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>[index] = (float)y * dy;
<a name="l00388"></a>00388           <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>[index] = (float)z * dz;
<a name="l00389"></a>00389           resets++;
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391       }
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00395"></a>00395 <span class="comment">// Compute the highest frequency component of the wavelet</span>
<a name="l00396"></a>00396 <span class="comment">// decomposition</span>
<a name="l00398"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#aba878b1635e72e736813eb254903b653">00398</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#aba878b1635e72e736813eb254903b653">WTURBULENCE::decomposeEnergy</a>(<span class="keywordtype">float</span> *_energy, <span class="keywordtype">float</span> *_highFreqEnergy)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400   <span class="comment">// do the decomposition -- the goal here is to have</span>
<a name="l00401"></a>00401   <span class="comment">// the energy with the high frequency component stomped out</span>
<a name="l00402"></a>00402   <span class="comment">// stored in _tcTemp when it is done. _highFreqEnergy is only used</span>
<a name="l00403"></a>00403   <span class="comment">// as an additional temp array</span>
<a name="l00404"></a>00404   
<a name="l00405"></a>00405   <span class="comment">// downsample input</span>
<a name="l00406"></a>00406   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a9e725ad2b0c8f219e2e47f2eacebf96d">downsampleXNeumann</a>(_highFreqEnergy, _energy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00407"></a>00407   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a22c19db6e8034548c0b8a8360c62c980">downsampleYNeumann</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, _highFreqEnergy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00408"></a>00408   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ad0dcd23a6bdaae1dc46c39dcdb180e02">downsampleZNeumann</a>(_highFreqEnergy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410   <span class="comment">// upsample input</span>
<a name="l00411"></a>00411   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a2001a7d499f042847228f8e697a250d4">upsampleZNeumann</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, _highFreqEnergy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00412"></a>00412   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a75962d19cd8c947d1365439b3885f851">upsampleYNeumann</a>(_highFreqEnergy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00413"></a>00413   <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a41dcec015a197181a503feded79ecca1">upsampleXNeumann</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, _highFreqEnergy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   <span class="comment">// subtract the down and upsampled field from the original field -- </span>
<a name="l00416"></a>00416   <span class="comment">// what should be left over is solely the high frequency component</span>
<a name="l00417"></a>00417     <span class="keywordtype">int</span> index = 0;
<a name="l00418"></a>00418   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 0; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>; z++) 
<a name="l00419"></a>00419     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>; y++) {
<a name="l00420"></a>00420       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>; x++, index++) {
<a name="l00421"></a>00421         <span class="comment">// brute force reset of boundaries</span>
<a name="l00422"></a>00422         <span class="keywordflow">if</span>(z &gt;= _zResSm - 1 || x &gt;= _xResSm - 1 || y &gt;= _yResSm - 1 || z &lt;= 0 || y &lt;= 0 || x &lt;= 0) 
<a name="l00423"></a>00423           _highFreqEnergy[index] = 0.; 
<a name="l00424"></a>00424         <span class="keywordflow">else</span> 
<a name="l00425"></a>00425           _highFreqEnergy[index] = _energy[index] - <a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>[index];
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427   }
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00431"></a>00431 <span class="comment">// compute velocity from energies and march into obstacles</span>
<a name="l00432"></a>00432 <span class="comment">// for wavelet decomposition</span>
<a name="l00434"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a99cb3f68eb5c21831b1547e14d113b4c">00434</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a99cb3f68eb5c21831b1547e14d113b4c">WTURBULENCE::computeEnergy</a>(<span class="keywordtype">float</span> *_energy, <span class="keywordtype">float</span>* xvel, <span class="keywordtype">float</span>* yvel, <span class="keywordtype">float</span>* zvel, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *obstacles) 
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436   <span class="comment">// compute everywhere</span>
<a name="l00437"></a>00437   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>; x++) 
<a name="l00438"></a>00438     _energy[x] = 0.5f * (xvel[x] * xvel[x] + yvel[x] * yvel[x] + zvel[x] * zvel[x]);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <a class="code" href="../../d6/dac/classFLUID__3D.html#ac57adcc22fd49a5a64cc936919578e6b">FLUID_3D::copyBorderX</a>(_energy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00441"></a>00441   <a class="code" href="../../d6/dac/classFLUID__3D.html#a929322f13dd57335ac89e17fb8a89e79">FLUID_3D::copyBorderY</a>(_energy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00442"></a>00442   <a class="code" href="../../d6/dac/classFLUID__3D.html#a6e27eca99e7a03655df1039078f68e49">FLUID_3D::copyBorderZ</a>(_energy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[2]);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444   <span class="comment">// pseudo-march the values into the obstacles</span>
<a name="l00445"></a>00445   <span class="comment">// the wavelet upsampler only uses a 3x3 support neighborhood, so</span>
<a name="l00446"></a>00446   <span class="comment">// propagating the values in by 4 should be sufficient</span>
<a name="l00447"></a>00447   <span class="keywordtype">int</span> index;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449   <span class="comment">// iterate</span>
<a name="l00450"></a>00450   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iter = 0; iter &lt; 4; iter++)
<a name="l00451"></a>00451   {
<a name="l00452"></a>00452     index = <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a> + <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a> + 1;
<a name="l00453"></a>00453     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 1; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a> - 1; z++, index += 2 * <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>)
<a name="l00454"></a>00454       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a> - 1; y++, index += 2)
<a name="l00455"></a>00455         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; _xResSm - 1; x++, index++)
<a name="l00456"></a>00456           <span class="keywordflow">if</span> (obstacles[index] &amp;&amp; obstacles[index] != <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00457"></a>00457           {
<a name="l00458"></a>00458             <span class="keywordtype">float</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a> = 0.0f;
<a name="l00459"></a>00459             <span class="keywordtype">int</span> valid = 0;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (!obstacles[index + 1] || obstacles[index + 1] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00462"></a>00462             {
<a name="l00463"></a>00463               sum += _energy[index + 1];
<a name="l00464"></a>00464               valid++;
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466             <span class="keywordflow">if</span> (!obstacles[index - 1] || obstacles[index - 1] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00467"></a>00467             {
<a name="l00468"></a>00468               sum += _energy[index - 1];
<a name="l00469"></a>00469               valid++;
<a name="l00470"></a>00470             }
<a name="l00471"></a>00471             <span class="keywordflow">if</span> (!obstacles[index + _xResSm] || obstacles[index + _xResSm] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00472"></a>00472             {
<a name="l00473"></a>00473               sum += _energy[index + <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>];
<a name="l00474"></a>00474               valid++;
<a name="l00475"></a>00475             }
<a name="l00476"></a>00476             <span class="keywordflow">if</span> (!obstacles[index - _xResSm] || obstacles[index - _xResSm] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00477"></a>00477             {
<a name="l00478"></a>00478               sum += _energy[index - <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>];
<a name="l00479"></a>00479               valid++;
<a name="l00480"></a>00480             }
<a name="l00481"></a>00481             <span class="keywordflow">if</span> (!obstacles[index + <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>] || obstacles[index + <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00482"></a>00482             {
<a name="l00483"></a>00483               sum += _energy[index + <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>];
<a name="l00484"></a>00484               valid++;
<a name="l00485"></a>00485             }
<a name="l00486"></a>00486             <span class="keywordflow">if</span> (!obstacles[index - <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>] || obstacles[index - <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>)
<a name="l00487"></a>00487             {
<a name="l00488"></a>00488               sum += _energy[index - <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>];
<a name="l00489"></a>00489               valid++;
<a name="l00490"></a>00490             }
<a name="l00491"></a>00491             <span class="keywordflow">if</span> (valid &gt; 0)
<a name="l00492"></a>00492             {
<a name="l00493"></a>00493               _energy[index] = sum / (float)valid;
<a name="l00494"></a>00494               obstacles[index] = <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644a8efc9df70bcc6398937b8757b8650e25">MARCHED</a>;
<a name="l00495"></a>00495             }
<a name="l00496"></a>00496           }
<a name="l00497"></a>00497     index = <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a> + _xResSm + 1;
<a name="l00498"></a>00498     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 1; z &lt; _zResSm - 1; z++, index += 2 * <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>)
<a name="l00499"></a>00499       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; _yResSm - 1; y++, index += 2)
<a name="l00500"></a>00500         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; _xResSm - 1; x++, index++)
<a name="l00501"></a>00501           <span class="keywordflow">if</span> (obstacles[index] == <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644a8efc9df70bcc6398937b8757b8650e25">MARCHED</a>)
<a name="l00502"></a>00502             obstacles[index] = <a class="code" href="../../db/d97/OBSTACLE_8h.html#a635ddf654f4aa61672a262c09b92f644ac4f052c838aed2606c4e950240db8eae">RETIRED</a>;
<a name="l00503"></a>00503   }
<a name="l00504"></a>00504   index = <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a> + <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a> + 1;
<a name="l00505"></a>00505   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 1; z &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a> - 1; z++, index += 2 * <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>)
<a name="l00506"></a>00506     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a> - 1; y++, index += 2)
<a name="l00507"></a>00507       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; _xResSm - 1; x++, index++)
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (obstacles[index])
<a name="l00509"></a>00509           obstacles[index] = 1;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00513"></a>00513 <span class="comment">// Evaluate derivatives</span>
<a name="l00515"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a4fb22f1849cda2c35b3fa8352baac992">00515</a> <span class="comment"></span><a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a4fb22f1849cda2c35b3fa8352baac992">WTURBULENCE::WVelocity</a>(<a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> orgPos)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517   <span class="comment">// arbitrarily offset evaluation points</span>
<a name="l00518"></a>00518   <span class="keyword">const</span> <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> p1 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0,0,0);
<a name="l00519"></a>00519   <span class="keyword">const</span> Vec3 p2 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(0,<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0,0);
<a name="l00520"></a>00520   <span class="keyword">const</span> Vec3 p3 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(0,0,<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   <span class="keyword">const</span> <span class="keywordtype">float</span> f1y = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#afda647be17c20e36ea0228b80dca3e32">WNoiseDy</a>(p1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00523"></a>00523   <span class="keyword">const</span> <span class="keywordtype">float</span> f1z = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a1c080fb4b0e3ed628e8482d4e9dee5a7">WNoiseDz</a>(p1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525   <span class="keyword">const</span> <span class="keywordtype">float</span> f2x = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ab4a96fd20833bf3df95fa29c045cbf22">WNoiseDx</a>(p2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00526"></a>00526   <span class="keyword">const</span> <span class="keywordtype">float</span> f2z = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a1c080fb4b0e3ed628e8482d4e9dee5a7">WNoiseDz</a>(p2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="keyword">const</span> <span class="keywordtype">float</span> f3x = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ab4a96fd20833bf3df95fa29c045cbf22">WNoiseDx</a>(p3, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00529"></a>00529   <span class="keyword">const</span> <span class="keywordtype">float</span> f3y = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#afda647be17c20e36ea0228b80dca3e32">WNoiseDy</a>(p3, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   Vec3 ret = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>( 
<a name="l00532"></a>00532       f3y - f2z,
<a name="l00533"></a>00533       f1z - f3x,
<a name="l00534"></a>00534       f2x - f1y ); 
<a name="l00535"></a>00535   <span class="keywordflow">return</span> ret;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00539"></a>00539 <span class="comment">// Evaluate derivatives with Jacobian</span>
<a name="l00541"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a7241bb335add69029d2a42e3f5e78ac6">00541</a> <span class="comment"></span><a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a7241bb335add69029d2a42e3f5e78ac6">WTURBULENCE::WVelocityWithJacobian</a>(<a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> orgPos, <span class="keywordtype">float</span>* xUnwarped, <span class="keywordtype">float</span>* yUnwarped, <span class="keywordtype">float</span>* zUnwarped)
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543   <span class="comment">// arbitrarily offset evaluation points</span>
<a name="l00544"></a>00544   <span class="keyword">const</span> <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> p1 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0,0,0);
<a name="l00545"></a>00545   <span class="keyword">const</span> Vec3 p2 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(0,<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0,0);
<a name="l00546"></a>00546   <span class="keyword">const</span> Vec3 p3 = orgPos + <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(0,0,<a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a0eb0bf6fc0ed4f191fec94f7b6beab55">NOISE_TILE_SIZE</a>/2.0);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   Vec3 <span class="keyword">final</span>;
<a name="l00549"></a>00549   <span class="keyword">final</span>[0] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ab4a96fd20833bf3df95fa29c045cbf22">WNoiseDx</a>(p1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00550"></a>00550   <span class="keyword">final</span>[1] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#afda647be17c20e36ea0228b80dca3e32">WNoiseDy</a>(p1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00551"></a>00551   <span class="keyword">final</span>[2] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a1c080fb4b0e3ed628e8482d4e9dee5a7">WNoiseDz</a>(p1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00552"></a>00552   <span class="comment">// UNUSED const float f1x = xUnwarped[0] * final[0] + xUnwarped[1] * final[1] + xUnwarped[2] * final[2];</span>
<a name="l00553"></a>00553   <span class="keyword">const</span> <span class="keywordtype">float</span> f1y = yUnwarped[0] * <span class="keyword">final</span>[0] + yUnwarped[1] * <span class="keyword">final</span>[1] + yUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00554"></a>00554   <span class="keyword">const</span> <span class="keywordtype">float</span> f1z = zUnwarped[0] * <span class="keyword">final</span>[0] + zUnwarped[1] * <span class="keyword">final</span>[1] + zUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="keyword">final</span>[0] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ab4a96fd20833bf3df95fa29c045cbf22">WNoiseDx</a>(p2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00557"></a>00557   <span class="keyword">final</span>[1] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#afda647be17c20e36ea0228b80dca3e32">WNoiseDy</a>(p2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00558"></a>00558   <span class="keyword">final</span>[2] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a1c080fb4b0e3ed628e8482d4e9dee5a7">WNoiseDz</a>(p2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00559"></a>00559   <span class="keyword">const</span> <span class="keywordtype">float</span> f2x = xUnwarped[0] * <span class="keyword">final</span>[0] + xUnwarped[1] * <span class="keyword">final</span>[1] + xUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00560"></a>00560   <span class="comment">// UNUSED const float f2y = yUnwarped[0] * final[0] + yUnwarped[1] * final[1] + yUnwarped[2] * final[2];</span>
<a name="l00561"></a>00561   <span class="keyword">const</span> <span class="keywordtype">float</span> f2z = zUnwarped[0] * <span class="keyword">final</span>[0] + zUnwarped[1] * <span class="keyword">final</span>[1] + zUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="keyword">final</span>[0] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#ab4a96fd20833bf3df95fa29c045cbf22">WNoiseDx</a>(p3, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00564"></a>00564   <span class="keyword">final</span>[1] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#afda647be17c20e36ea0228b80dca3e32">WNoiseDy</a>(p3, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00565"></a>00565   <span class="keyword">final</span>[2] = <a class="code" href="../../d5/dab/WAVELET__NOISE_8h.html#a1c080fb4b0e3ed628e8482d4e9dee5a7">WNoiseDz</a>(p3, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acf6ef58fb087a7998d69792db0cd7b7e">_noiseTile</a>);
<a name="l00566"></a>00566   <span class="keyword">const</span> <span class="keywordtype">float</span> f3x = xUnwarped[0] * <span class="keyword">final</span>[0] + xUnwarped[1] * <span class="keyword">final</span>[1] + xUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00567"></a>00567   <span class="keyword">const</span> <span class="keywordtype">float</span> f3y = yUnwarped[0] * <span class="keyword">final</span>[0] + yUnwarped[1] * <span class="keyword">final</span>[1] + yUnwarped[2] * <span class="keyword">final</span>[2];
<a name="l00568"></a>00568   <span class="comment">// UNUSED const float f3z = zUnwarped[0] * final[0] + zUnwarped[1] * final[1] + zUnwarped[2] * final[2];</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   Vec3 ret = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>( 
<a name="l00571"></a>00571       f3y - f2z,
<a name="l00572"></a>00572       f1z - f3x,
<a name="l00573"></a>00573       f2x - f1y ); 
<a name="l00574"></a>00574   <span class="keywordflow">return</span> ret;
<a name="l00575"></a>00575 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00579"></a>00579 <span class="comment">// perform an actual noise advection step</span>
<a name="l00581"></a>00581 <span class="comment"></span><span class="comment">/*void WTURBULENCE::stepTurbulenceReadable(float dtOrg, float* xvel, float* yvel, float* zvel, unsigned char *obstacles) </span>
<a name="l00582"></a>00582 <span class="comment">{</span>
<a name="l00583"></a>00583 <span class="comment">    // enlarge timestep to match grid</span>
<a name="l00584"></a>00584 <span class="comment">    const float dt = dtOrg * _amplify;</span>
<a name="l00585"></a>00585 <span class="comment">    const float invAmp = 1.0f / _amplify;</span>
<a name="l00586"></a>00586 <span class="comment">    float *tempBig1 = new float[_totalCellsBig];</span>
<a name="l00587"></a>00587 <span class="comment">    float *tempBig2 = new float[_totalCellsBig];</span>
<a name="l00588"></a>00588 <span class="comment">    float *bigUx = new float[_totalCellsBig];</span>
<a name="l00589"></a>00589 <span class="comment">    float *bigUy = new float[_totalCellsBig];</span>
<a name="l00590"></a>00590 <span class="comment">    float *bigUz = new float[_totalCellsBig]; </span>
<a name="l00591"></a>00591 <span class="comment">    float *_energy = new float[_totalCellsSm];</span>
<a name="l00592"></a>00592 <span class="comment">    float *highFreqEnergy = new float[_totalCellsSm];</span>
<a name="l00593"></a>00593 <span class="comment">    float *eigMin  = new float[_totalCellsSm];</span>
<a name="l00594"></a>00594 <span class="comment">    float *eigMax  = new float[_totalCellsSm];</span>
<a name="l00595"></a>00595 <span class="comment"></span>
<a name="l00596"></a>00596 <span class="comment">    memset(tempBig1, 0, sizeof(float)*_totalCellsBig);</span>
<a name="l00597"></a>00597 <span class="comment">    memset(tempBig2, 0, sizeof(float)*_totalCellsBig);</span>
<a name="l00598"></a>00598 <span class="comment">    memset(highFreqEnergy, 0, sizeof(float)*_totalCellsSm);</span>
<a name="l00599"></a>00599 <span class="comment">    memset(eigMin, 0, sizeof(float)*_totalCellsSm);</span>
<a name="l00600"></a>00600 <span class="comment">    memset(eigMax, 0, sizeof(float)*_totalCellsSm);</span>
<a name="l00601"></a>00601 <span class="comment"></span>
<a name="l00602"></a>00602 <span class="comment">    // prepare textures</span>
<a name="l00603"></a>00603 <span class="comment">    advectTextureCoordinates(dtOrg, xvel,yvel,zvel, tempBig1, tempBig2);</span>
<a name="l00604"></a>00604 <span class="comment"></span>
<a name="l00605"></a>00605 <span class="comment">  // compute eigenvalues of the texture coordinates</span>
<a name="l00606"></a>00606 <span class="comment">  computeEigenvalues(eigMin, eigMax);</span>
<a name="l00607"></a>00607 <span class="comment"></span>
<a name="l00608"></a>00608 <span class="comment">  // do wavelet decomposition of energy</span>
<a name="l00609"></a>00609 <span class="comment">  computeEnergy(_energy, xvel, yvel, zvel, obstacles);</span>
<a name="l00610"></a>00610 <span class="comment">  decomposeEnergy(_energy, highFreqEnergy);</span>
<a name="l00611"></a>00611 <span class="comment"></span>
<a name="l00612"></a>00612 <span class="comment">  // zero out coefficients inside of the obstacle</span>
<a name="l00613"></a>00613 <span class="comment">  for (int x = 0; x &lt; _totalCellsSm; x++)</span>
<a name="l00614"></a>00614 <span class="comment">    if (obstacles[x]) _energy[x] = 0.f;</span>
<a name="l00615"></a>00615 <span class="comment"></span>
<a name="l00616"></a>00616 <span class="comment">  float maxVelocity = 0.;</span>
<a name="l00617"></a>00617 <span class="comment">  for (int z = 1; z &lt; _zResBig - 1; z++) </span>
<a name="l00618"></a>00618 <span class="comment">    for (int y = 1; y &lt; _yResBig - 1; y++) </span>
<a name="l00619"></a>00619 <span class="comment">      for (int x = 1; x &lt; _xResBig - 1; x++)</span>
<a name="l00620"></a>00620 <span class="comment">      {</span>
<a name="l00621"></a>00621 <span class="comment">        // get unit position for both fine and coarse grid</span>
<a name="l00622"></a>00622 <span class="comment">        const Vec3 pos = Vec3(x,y,z);</span>
<a name="l00623"></a>00623 <span class="comment">        const Vec3 posSm = pos * invAmp;</span>
<a name="l00624"></a>00624 <span class="comment">        </span>
<a name="l00625"></a>00625 <span class="comment">        // get grid index for both fine and coarse grid</span>
<a name="l00626"></a>00626 <span class="comment">        const int index = x + y *_xResBig + z *_slabSizeBig;</span>
<a name="l00627"></a>00627 <span class="comment">        const int indexSmall = (int)posSm[0] + (int)posSm[1] * _xResSm + (int)posSm[2] * _slabSizeSm;</span>
<a name="l00628"></a>00628 <span class="comment">        </span>
<a name="l00629"></a>00629 <span class="comment">        // get a linearly interpolated velocity and texcoords</span>
<a name="l00630"></a>00630 <span class="comment">        // from the coarse grid</span>
<a name="l00631"></a>00631 <span class="comment">        Vec3 vel = INTERPOLATE::lerp3dVec( xvel,yvel,zvel, </span>
<a name="l00632"></a>00632 <span class="comment">            posSm[0], posSm[1], posSm[2], _xResSm,_yResSm,_zResSm);</span>
<a name="l00633"></a>00633 <span class="comment">        Vec3 uvw = INTERPOLATE::lerp3dVec( _tcU,_tcV,_tcW, </span>
<a name="l00634"></a>00634 <span class="comment">            posSm[0], posSm[1], posSm[2], _xResSm,_yResSm,_zResSm);</span>
<a name="l00635"></a>00635 <span class="comment"></span>
<a name="l00636"></a>00636 <span class="comment">        // multiply the texture coordinate by _resSm so that turbulence</span>
<a name="l00637"></a>00637 <span class="comment">        // synthesis begins at the first octave that the coarse grid </span>
<a name="l00638"></a>00638 <span class="comment">        // cannot capture</span>
<a name="l00639"></a>00639 <span class="comment">        Vec3 texCoord = Vec3(uvw[0] * _resSm[0], </span>
<a name="l00640"></a>00640 <span class="comment">                             uvw[1] * _resSm[1],</span>
<a name="l00641"></a>00641 <span class="comment">                             uvw[2] * _resSm[2]); </span>
<a name="l00642"></a>00642 <span class="comment"></span>
<a name="l00643"></a>00643 <span class="comment">        // retrieve wavelet energy at highest frequency</span>
<a name="l00644"></a>00644 <span class="comment">        float energy = INTERPOLATE::lerp3d(</span>
<a name="l00645"></a>00645 <span class="comment">            highFreqEnergy, posSm[0],posSm[1],posSm[2], _xResSm, _yResSm, _zResSm);</span>
<a name="l00646"></a>00646 <span class="comment"></span>
<a name="l00647"></a>00647 <span class="comment">        // base amplitude for octave 0</span>
<a name="l00648"></a>00648 <span class="comment">        float coefficient = sqrtf(2.0f * fabs(energy));</span>
<a name="l00649"></a>00649 <span class="comment">        const float amplitude = *_strength * fabs(0.5 * coefficient) * persistence;</span>
<a name="l00650"></a>00650 <span class="comment"></span>
<a name="l00651"></a>00651 <span class="comment">        // add noise to velocity, but only if the turbulence is</span>
<a name="l00652"></a>00652 <span class="comment">        // sufficiently undeformed, and the energy is large enough</span>
<a name="l00653"></a>00653 <span class="comment">        // to make a difference</span>
<a name="l00654"></a>00654 <span class="comment">        const bool addNoise = eigMax[indexSmall] &lt; 2. &amp;&amp; </span>
<a name="l00655"></a>00655 <span class="comment">                              eigMin[indexSmall] &gt; 0.5;</span>
<a name="l00656"></a>00656 <span class="comment">        if (addNoise &amp;&amp; amplitude &gt; _cullingThreshold) {</span>
<a name="l00657"></a>00657 <span class="comment">          // base amplitude for octave 0</span>
<a name="l00658"></a>00658 <span class="comment">          float amplitudeScaled = amplitude;</span>
<a name="l00659"></a>00659 <span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">          for (int octave = 0; octave &lt; _octaves; octave++)</span>
<a name="l00661"></a>00661 <span class="comment">          {</span>
<a name="l00662"></a>00662 <span class="comment">            // multiply the vector noise times the maximum allowed</span>
<a name="l00663"></a>00663 <span class="comment">            // noise amplitude at this octave, and add it to the total</span>
<a name="l00664"></a>00664 <span class="comment">            vel += WVelocity(texCoord) * amplitudeScaled;</span>
<a name="l00665"></a>00665 <span class="comment"></span>
<a name="l00666"></a>00666 <span class="comment">            // scale coefficient for next octave</span>
<a name="l00667"></a>00667 <span class="comment">            amplitudeScaled *= persistence;</span>
<a name="l00668"></a>00668 <span class="comment">            texCoord *= 2.0f;</span>
<a name="l00669"></a>00669 <span class="comment">          }</span>
<a name="l00670"></a>00670 <span class="comment">        }</span>
<a name="l00671"></a>00671 <span class="comment"></span>
<a name="l00672"></a>00672 <span class="comment">        // Store velocity + turbulence in big grid for maccormack step</span>
<a name="l00673"></a>00673 <span class="comment">        //</span>
<a name="l00674"></a>00674 <span class="comment">        // If you wanted to save memory, you would instead perform a </span>
<a name="l00675"></a>00675 <span class="comment">        // semi-Lagrangian backtrace for the current grid cell here. Then</span>
<a name="l00676"></a>00676 <span class="comment">        // you could just throw the velocity away.</span>
<a name="l00677"></a>00677 <span class="comment">        bigUx[index] = vel[0];</span>
<a name="l00678"></a>00678 <span class="comment">        bigUy[index] = vel[1];</span>
<a name="l00679"></a>00679 <span class="comment">        bigUz[index] = vel[2];</span>
<a name="l00680"></a>00680 <span class="comment"></span>
<a name="l00681"></a>00681 <span class="comment">        // compute the velocity magnitude for substepping later</span>
<a name="l00682"></a>00682 <span class="comment">        const float velMag = bigUx[index] * bigUx[index] + </span>
<a name="l00683"></a>00683 <span class="comment">                             bigUy[index] * bigUy[index] + </span>
<a name="l00684"></a>00684 <span class="comment">                             bigUz[index] * bigUz[index];</span>
<a name="l00685"></a>00685 <span class="comment">        if (velMag &gt; maxVelocity) maxVelocity = velMag;</span>
<a name="l00686"></a>00686 <span class="comment"></span>
<a name="l00687"></a>00687 <span class="comment">        // zero out velocity inside obstacles</span>
<a name="l00688"></a>00688 <span class="comment">        float obsCheck = INTERPOLATE::lerp3dToFloat(</span>
<a name="l00689"></a>00689 <span class="comment">            obstacles, posSm[0], posSm[1], posSm[2], _xResSm, _yResSm, _zResSm); </span>
<a name="l00690"></a>00690 <span class="comment">        if (obsCheck &gt; 0.95) </span>
<a name="l00691"></a>00691 <span class="comment">          bigUx[index] = bigUy[index] = bigUz[index] = 0.;</span>
<a name="l00692"></a>00692 <span class="comment">      }</span>
<a name="l00693"></a>00693 <span class="comment"></span>
<a name="l00694"></a>00694 <span class="comment">  // prepare density for an advection</span>
<a name="l00695"></a>00695 <span class="comment">  SWAP_POINTERS(_densityBig, _densityBigOld);</span>
<a name="l00696"></a>00696 <span class="comment"></span>
<a name="l00697"></a>00697 <span class="comment">  // based on the maximum velocity present, see if we need to substep,</span>
<a name="l00698"></a>00698 <span class="comment">  // but cap the maximum number of substeps to 5</span>
<a name="l00699"></a>00699 <span class="comment">  const int maxSubSteps = 5; </span>
<a name="l00700"></a>00700 <span class="comment">  maxVelocity = sqrt(maxVelocity) * dt;</span>
<a name="l00701"></a>00701 <span class="comment">  int totalSubsteps = (int)(maxVelocity / (float)maxSubSteps);</span>
<a name="l00702"></a>00702 <span class="comment">  totalSubsteps = (totalSubsteps &lt; 1) ? 1 : totalSubsteps;</span>
<a name="l00703"></a>00703 <span class="comment">  totalSubsteps = (totalSubsteps &gt; maxSubSteps) ? maxSubSteps : totalSubsteps;</span>
<a name="l00704"></a>00704 <span class="comment">  const float dtSubdiv = dt / (float)totalSubsteps;</span>
<a name="l00705"></a>00705 <span class="comment"></span>
<a name="l00706"></a>00706 <span class="comment">  // set boundaries of big velocity grid</span>
<a name="l00707"></a>00707 <span class="comment">  FLUID_3D::setZeroX(bigUx, _resBig, 0, _resBig[2]); </span>
<a name="l00708"></a>00708 <span class="comment">  FLUID_3D::setZeroY(bigUy, _resBig, 0, _resBig[2]); </span>
<a name="l00709"></a>00709 <span class="comment">  FLUID_3D::setZeroZ(bigUz, _resBig, 0, _resBig[2]);</span>
<a name="l00710"></a>00710 <span class="comment"></span>
<a name="l00711"></a>00711 <span class="comment">  // do the MacCormack advection, with substepping if necessary</span>
<a name="l00712"></a>00712 <span class="comment">  for(int substep = 0; substep &lt; totalSubsteps; substep++)</span>
<a name="l00713"></a>00713 <span class="comment">  {</span>
<a name="l00714"></a>00714 <span class="comment">    FLUID_3D::advectFieldMacCormack(dtSubdiv, bigUx, bigUy, bigUz, </span>
<a name="l00715"></a>00715 <span class="comment">        _densityBigOld, _densityBig, tempBig1, tempBig2, _resBig, NULL);</span>
<a name="l00716"></a>00716 <span class="comment"></span>
<a name="l00717"></a>00717 <span class="comment">    if (substep &lt; totalSubsteps - 1) </span>
<a name="l00718"></a>00718 <span class="comment">      SWAP_POINTERS(_densityBig, _densityBigOld);</span>
<a name="l00719"></a>00719 <span class="comment">  } // substep</span>
<a name="l00720"></a>00720 <span class="comment">  </span>
<a name="l00721"></a>00721 <span class="comment">  // wipe the density borders</span>
<a name="l00722"></a>00722 <span class="comment">  FLUID_3D::setZeroBorder(_densityBig, _resBig, 0, _resBig[2]);</span>
<a name="l00723"></a>00723 <span class="comment">    </span>
<a name="l00724"></a>00724 <span class="comment">  // reset texture coordinates now in preparation for next timestep</span>
<a name="l00725"></a>00725 <span class="comment">  // Shouldn&#39;t do this before generating the noise because then the </span>
<a name="l00726"></a>00726 <span class="comment">  // eigenvalues stored do not reflect the underlying texture coordinates</span>
<a name="l00727"></a>00727 <span class="comment">  resetTextureCoordinates(eigMin, eigMax);</span>
<a name="l00728"></a>00728 <span class="comment">  </span>
<a name="l00729"></a>00729 <span class="comment">  delete[] tempBig1;</span>
<a name="l00730"></a>00730 <span class="comment">  delete[] tempBig2;</span>
<a name="l00731"></a>00731 <span class="comment">  delete[] bigUx;</span>
<a name="l00732"></a>00732 <span class="comment">  delete[] bigUy;</span>
<a name="l00733"></a>00733 <span class="comment">  delete[] bigUz;</span>
<a name="l00734"></a>00734 <span class="comment">  delete[] _energy;</span>
<a name="l00735"></a>00735 <span class="comment">  delete[] highFreqEnergy;</span>
<a name="l00736"></a>00736 <span class="comment"></span>
<a name="l00737"></a>00737 <span class="comment">  delete[] eigMin;</span>
<a name="l00738"></a>00738 <span class="comment">  delete[] eigMax;</span>
<a name="l00739"></a>00739 <span class="comment">  </span>
<a name="l00740"></a>00740 <span class="comment"></span>
<a name="l00741"></a>00741 <span class="comment">  _totalStepsBig++;</span>
<a name="l00742"></a>00742 <span class="comment">}*/</span>
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="comment">//struct</span>
<a name="l00745"></a>00745 
<a name="l00747"></a>00747 <span class="comment">// perform the full turbulence algorithm, including OpenMP </span>
<a name="l00748"></a>00748 <span class="comment">// if available</span>
<a name="l00750"></a><a class="code" href="../../d3/d65/classWTURBULENCE.html#a3476fd37180f80641710f30b47e89ebf">00750</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="../../d3/d65/classWTURBULENCE.html#a3476fd37180f80641710f30b47e89ebf">WTURBULENCE::stepTurbulenceFull</a>(<span class="keywordtype">float</span> dtOrg, <span class="keywordtype">float</span>* xvel, <span class="keywordtype">float</span>* yvel, <span class="keywordtype">float</span>* zvel, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *obstacles)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752     <span class="comment">// enlarge timestep to match grid</span>
<a name="l00753"></a>00753     <span class="keyword">const</span> <span class="keywordtype">float</span> dt = dtOrg * <a class="code" href="../../d3/d65/classWTURBULENCE.html#a1f9d322e92ae382abfd53dbc597d75d0">_amplify</a>;
<a name="l00754"></a>00754     <span class="keyword">const</span> <span class="keywordtype">float</span> invAmp = 1.0f / <a class="code" href="../../d3/d65/classWTURBULENCE.html#a1f9d322e92ae382abfd53dbc597d75d0">_amplify</a>;
<a name="l00755"></a>00755     <span class="keywordtype">float</span> *tempBig1 = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00756"></a>00756     <span class="keywordtype">float</span> *tempBig2 = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00757"></a>00757     <span class="keywordtype">float</span> *bigUx = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00758"></a>00758     <span class="keywordtype">float</span> *bigUy = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00759"></a>00759     <span class="keywordtype">float</span> *bigUz = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a467ad287adfbb8dd6943651a126e7cbf">_totalCellsBig</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)); 
<a name="l00760"></a>00760     <span class="keywordtype">float</span> *_energy = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00761"></a>00761     <span class="keywordtype">float</span> *highFreqEnergy = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00762"></a>00762     <span class="keywordtype">float</span> *eigMin  = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00763"></a>00763     <span class="keywordtype">float</span> *eigMax  = (<span class="keywordtype">float</span> *)calloc(<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     memset(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5e8af996204760c0983dc8b343c1332c">_tcTemp</a>, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*<a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <span class="comment">// prepare textures</span>
<a name="l00769"></a>00769     <a class="code" href="../../d3/d65/classWTURBULENCE.html#af0de15b431ebd7e3cb586633028d21cb">advectTextureCoordinates</a>(dtOrg, xvel,yvel,zvel, tempBig1, tempBig2);
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="comment">// do wavelet decomposition of energy</span>
<a name="l00772"></a>00772     <a class="code" href="../../d3/d65/classWTURBULENCE.html#a99cb3f68eb5c21831b1547e14d113b4c">computeEnergy</a>(_energy, xvel, yvel, zvel, obstacles);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>; x++)
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (obstacles[x]) _energy[x] = 0.f;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <a class="code" href="../../d3/d65/classWTURBULENCE.html#aba878b1635e72e736813eb254903b653">decomposeEnergy</a>(_energy, highFreqEnergy);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <span class="comment">// zero out coefficients inside of the obstacle</span>
<a name="l00780"></a>00780     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#ac884748aa9c664c2f584617f189ae26b">_totalCellsSm</a>; x++)
<a name="l00781"></a>00781         <span class="keywordflow">if</span> (obstacles[x]) highFreqEnergy[x] = 0.f;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3Int</a> ressm(<a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>);
<a name="l00784"></a>00784     <a class="code" href="../../d6/dac/classFLUID__3D.html#a37111182c1483d6e53d80623330bd18a">FLUID_3D::setNeumannX</a>(highFreqEnergy, ressm, 0 , ressm[2]);
<a name="l00785"></a>00785     <a class="code" href="../../d6/dac/classFLUID__3D.html#a8c369fb3a79a4a57bebcce51597095a6">FLUID_3D::setNeumannY</a>(highFreqEnergy, ressm, 0 , ressm[2]);
<a name="l00786"></a>00786     <a class="code" href="../../d6/dac/classFLUID__3D.html#a28b11069020e256e5ea838fb5ed59812">FLUID_3D::setNeumannZ</a>(highFreqEnergy, ressm, 0 , ressm[2]);
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 
<a name="l00789"></a>00789    <span class="keywordtype">int</span> threadval = 1;
<a name="l00790"></a>00790 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>  threadval = omp_get_max_threads();
<a name="l00792"></a>00792 <span class="preprocessor">#endif</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span>
<a name="l00794"></a>00794 
<a name="l00795"></a>00795   <span class="comment">// parallel region setup</span>
<a name="l00796"></a>00796   <span class="comment">// Uses omp_get_max_trheads to get number of required cells.</span>
<a name="l00797"></a>00797   <span class="keywordtype">float</span>* maxVelMagThreads = <span class="keyword">new</span> <span class="keywordtype">float</span>[threadval];
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;threadval; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) maxVelMagThreads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -1.0f;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00802"></a>00802 <span class="preprocessor"></span>
<a name="l00803"></a>00803 <span class="preprocessor">#pragma omp parallel</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span>  { <span class="keywordtype">float</span> maxVelMag1 = 0.;
<a name="l00806"></a>00806 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span>  = omp_get_thread_num(); <span class="comment">/*, num = omp_get_num_threads(); */</span>
<a name="l00808"></a>00808 <span class="preprocessor">#endif</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>
<a name="l00810"></a>00810   <span class="comment">// vector noise main loop</span>
<a name="l00811"></a>00811 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00812"></a>00812 <span class="preprocessor"></span><span class="preprocessor">#pragma omp for schedule(static,1)</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00814"></a>00814 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> zSmall = 0; zSmall &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a032ab53d8d1acc4631228eb580300991">_zResSm</a>; zSmall++)
<a name="l00815"></a>00815   {
<a name="l00816"></a>00816   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ySmall = 0; ySmall &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acc6917ff58abb8c6d7aea54c22d86afb">_yResSm</a>; ySmall++) 
<a name="l00817"></a>00817   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> xSmall = 0; xSmall &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acb0ccd55c088f61ed737c3a26a9b8995">_xResSm</a>; xSmall++)
<a name="l00818"></a>00818   {
<a name="l00819"></a>00819     <span class="keyword">const</span> <span class="keywordtype">int</span> indexSmall = xSmall + ySmall * _xResSm + zSmall * <a class="code" href="../../d3/d65/classWTURBULENCE.html#adf9f5e6e7cf6aa1308e3014f719677b1">_slabSizeSm</a>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="comment">// compute jacobian</span>
<a name="l00822"></a>00822     <span class="keywordtype">float</span> jacobian[3][3] = {
<a name="l00823"></a>00823       { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a3743231e026a08bfd6ed8d312b222f2f">minDx</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) } ,
<a name="l00824"></a>00824       { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a8e76d1c94d7d9c19ff3187d0906f778b">minDy</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) } ,
<a name="l00825"></a>00825       { <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>), <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6ef3ed786cc021d31da53a8154b13882">minDz</a>(xSmall, ySmall, zSmall, <a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>) }
<a name="l00826"></a>00826     };
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="comment">// get LU factorization of texture jacobian and apply </span>
<a name="l00829"></a>00829     <span class="comment">// it to unit vectors</span>
<a name="l00830"></a>00830     <a class="code" href="../../de/d94/structsLU.html">sLU</a> LU = <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#a87dc0fa58e124d3f533cdb14cc68df51">computeLU</a>(jacobian);
<a name="l00831"></a>00831     <span class="keywordtype">float</span> xUnwarped[3], yUnwarped[3], zUnwarped[3];
<a name="l00832"></a>00832     <span class="keywordtype">float</span> xWarped[3], yWarped[3], zWarped[3];
<a name="l00833"></a>00833     <span class="keywordtype">bool</span> nonSingular = <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#a8eb54c27d25ac2103eb45571005f16c1">isNonsingular</a>(LU);
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     xUnwarped[0] = 1.0f; xUnwarped[1] = 0.0f; xUnwarped[2] = 0.0f;
<a name="l00836"></a>00836     yUnwarped[0] = 0.0f; yUnwarped[1] = 1.0f; yUnwarped[2] = 0.0f;
<a name="l00837"></a>00837     zUnwarped[0] = 0.0f; zUnwarped[1] = 0.0f; zUnwarped[2] = 1.0f;
<a name="l00838"></a>00838 
<a name="l00839"></a>00839     xWarped[0] = 1.0f; xWarped[1] = 0.0f; xWarped[2] = 0.0f;
<a name="l00840"></a>00840     yWarped[0] = 0.0f; yWarped[1] = 1.0f; yWarped[2] = 0.0f;
<a name="l00841"></a>00841     zWarped[0] = 0.0f; zWarped[1] = 0.0f; zWarped[2] = 1.0f;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="preprocessor">#if 0</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span>    <span class="comment">// UNUSED</span>
<a name="l00845"></a>00845     <span class="keywordtype">float</span> eigMax = 10.0f;
<a name="l00846"></a>00846     <span class="keywordtype">float</span> eigMin = 0.1f;
<a name="l00847"></a>00847 <span class="preprocessor">#endif</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (nonSingular)
<a name="l00849"></a>00849     {
<a name="l00850"></a>00850       <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#aac10c3da57aefd510514b53fb3a38eca">solveLU3x3</a>(LU, xUnwarped, xWarped);
<a name="l00851"></a>00851       <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#aac10c3da57aefd510514b53fb3a38eca">solveLU3x3</a>(LU, yUnwarped, yWarped);
<a name="l00852"></a>00852       <a class="code" href="../../dd/ded/LU__HELPER_8cpp.html#aac10c3da57aefd510514b53fb3a38eca">solveLU3x3</a>(LU, zUnwarped, zWarped);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854       <span class="comment">// compute the eigenvalues while we have the Jacobian available</span>
<a name="l00855"></a>00855       <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> eigenvalues = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(1.);
<a name="l00856"></a>00856       <a class="code" href="../../d1/d05/EIGENVALUE__HELPER_8cpp.html#a3582d3e64171dfc96191bf4c42abfc8c">computeEigenvalues3x3</a>( &amp;eigenvalues[0], jacobian);
<a name="l00857"></a>00857       eigMax[indexSmall] = <a class="code" href="../../dd/d46/IMAGE_8h.html#aa3c04c74e20681b43cbdf41ab39d8ad9">MAX3V</a>(eigenvalues);
<a name="l00858"></a>00858       eigMin[indexSmall] = <a class="code" href="../../dd/d46/IMAGE_8h.html#a89dbd4641586f8d3180f77688f3ed70a">MIN3V</a>(eigenvalues);
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     
<a name="l00861"></a>00861     <span class="comment">// make sure to skip one on the beginning and end</span>
<a name="l00862"></a>00862     <span class="keywordtype">int</span> xStart = (xSmall == 0) ? 1 : 0;
<a name="l00863"></a>00863     <span class="keywordtype">int</span> xEnd   = (xSmall == _xResSm - 1) ? _amplify - 1 : _amplify;
<a name="l00864"></a>00864     <span class="keywordtype">int</span> yStart = (ySmall == 0) ? 1 : 0;
<a name="l00865"></a>00865     <span class="keywordtype">int</span> yEnd   = (ySmall == _yResSm - 1) ? _amplify - 1 : _amplify;
<a name="l00866"></a>00866     <span class="keywordtype">int</span> zStart = (zSmall == 0) ? 1 : 0;
<a name="l00867"></a>00867     <span class="keywordtype">int</span> zEnd   = (zSmall == _zResSm - 1) ? _amplify - 1 : _amplify;
<a name="l00868"></a>00868       
<a name="l00869"></a>00869     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> zBig = zStart; zBig &lt; zEnd; zBig++) 
<a name="l00870"></a>00870     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> yBig = yStart; yBig &lt; yEnd; yBig++) 
<a name="l00871"></a>00871     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> xBig = xStart; xBig &lt; xEnd; xBig++)
<a name="l00872"></a>00872     {
<a name="l00873"></a>00873       <span class="keyword">const</span> <span class="keywordtype">int</span> x = xSmall * _amplify + xBig;
<a name="l00874"></a>00874       <span class="keyword">const</span> <span class="keywordtype">int</span> y = ySmall * _amplify + yBig;
<a name="l00875"></a>00875       <span class="keyword">const</span> <span class="keywordtype">int</span> z = zSmall * _amplify + zBig;
<a name="l00876"></a>00876       
<a name="l00877"></a>00877       <span class="comment">// get unit position for both fine and coarse grid</span>
<a name="l00878"></a>00878       <span class="keyword">const</span> <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> pos = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(x,y,z);
<a name="l00879"></a>00879       <span class="keyword">const</span> <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> posSm = pos * invAmp;
<a name="l00880"></a>00880       
<a name="l00881"></a>00881       <span class="comment">// get grid index for both fine and coarse grid</span>
<a name="l00882"></a>00882       <span class="keyword">const</span> <span class="keywordtype">int</span> index = x + y *<a class="code" href="../../d3/d65/classWTURBULENCE.html#a747c6eb427ffe03b7800decb40af9ebc">_xResBig</a> + z *<a class="code" href="../../d3/d65/classWTURBULENCE.html#a5b8bee36f2035d2a7a81ff8acd0ba67a">_slabSizeBig</a>;
<a name="l00883"></a>00883       
<a name="l00884"></a>00884       <span class="comment">// get a linearly interpolated velocity and texcoords</span>
<a name="l00885"></a>00885       <span class="comment">// from the coarse grid</span>
<a name="l00886"></a>00886       <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> vel = <a class="code" href="../../d7/d3c/namespaceINTERPOLATE.html#a844156fa6be99306a769111b7898b0c0">INTERPOLATE::lerp3dVec</a>( xvel,yvel,zvel, 
<a name="l00887"></a>00887           posSm[0], posSm[1], posSm[2], _xResSm,_yResSm,_zResSm);
<a name="l00888"></a>00888       <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> uvw = <a class="code" href="../../d7/d3c/namespaceINTERPOLATE.html#a844156fa6be99306a769111b7898b0c0">INTERPOLATE::lerp3dVec</a>( <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad77be6ac846fe2580f3873c8438141b6">_tcU</a>,<a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7caa1a31f6dc8b8944042ae44697bf9">_tcV</a>,<a class="code" href="../../d3/d65/classWTURBULENCE.html#aa7b43c069e9aca9b438d5fbcaacf72bb">_tcW</a>, 
<a name="l00889"></a>00889           posSm[0], posSm[1], posSm[2], _xResSm,_yResSm,_zResSm);
<a name="l00890"></a>00890 
<a name="l00891"></a>00891       <span class="comment">// multiply the texture coordinate by _resSm so that turbulence</span>
<a name="l00892"></a>00892       <span class="comment">// synthesis begins at the first octave that the coarse grid </span>
<a name="l00893"></a>00893       <span class="comment">// cannot capture</span>
<a name="l00894"></a>00894       <a class="code" href="../../db/d09/classBasicVector_1_1Vector3Dim.html">Vec3</a> texCoord = <a class="code" href="../../db/de1/namespaceBasicVector.html#ade4e0c198c555e790fc3cc3da46fe019">Vec3</a>(uvw[0] * <a class="code" href="../../d3/d65/classWTURBULENCE.html#ad9ef9a8911dcb70d4123d92681e83d1f">_resSm</a>[0], 
<a name="l00895"></a>00895                            uvw[1] * _resSm[1],
<a name="l00896"></a>00896                            uvw[2] * _resSm[2]); 
<a name="l00897"></a>00897 
<a name="l00898"></a>00898       <span class="comment">// retrieve wavelet energy at highest frequency</span>
<a name="l00899"></a>00899       <span class="keywordtype">float</span> energy = <a class="code" href="../../d7/d3c/namespaceINTERPOLATE.html#ab64bea7a6b252d03ba6a970ea6911167">INTERPOLATE::lerp3d</a>(
<a name="l00900"></a>00900           highFreqEnergy, posSm[0],posSm[1],posSm[2], _xResSm, _yResSm, _zResSm);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902       <span class="comment">// base amplitude for octave 0</span>
<a name="l00903"></a>00903       <span class="keywordtype">float</span> coefficient = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(2.0f * <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(energy));
<a name="l00904"></a>00904       <span class="keyword">const</span> <span class="keywordtype">float</span> amplitude = *<a class="code" href="../../d3/d65/classWTURBULENCE.html#a30228833063009eb5b5a7e10dfbc65e8">_strength</a> * <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(0.5 * coefficient) * <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6447f52d1fc2c6a217bc44515023bf8a">persistence</a>;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906       <span class="comment">// add noise to velocity, but only if the turbulence is</span>
<a name="l00907"></a>00907       <span class="comment">// sufficiently undeformed, and the energy is large enough</span>
<a name="l00908"></a>00908       <span class="comment">// to make a difference</span>
<a name="l00909"></a>00909       <span class="keyword">const</span> <span class="keywordtype">bool</span> addNoise = eigMax[indexSmall] &lt; 2. &amp;&amp; 
<a name="l00910"></a>00910                             eigMin[indexSmall] &gt; 0.5;
<a name="l00911"></a>00911       <span class="keywordflow">if</span> (addNoise &amp;&amp; amplitude &gt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#acbdf7bd91b1721e9a25f1af49eecf3e2">_cullingThreshold</a>) {
<a name="l00912"></a>00912         <span class="comment">// base amplitude for octave 0</span>
<a name="l00913"></a>00913         <span class="keywordtype">float</span> amplitudeScaled = amplitude;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> octave = 0; octave &lt; <a class="code" href="../../d3/d65/classWTURBULENCE.html#a91a60dfe7c51d58bba67eeb5b918014c">_octaves</a>; octave++)
<a name="l00916"></a>00916         {
<a name="l00917"></a>00917           <span class="comment">// multiply the vector noise times the maximum allowed</span>
<a name="l00918"></a>00918           <span class="comment">// noise amplitude at this octave, and add it to the total</span>
<a name="l00919"></a>00919           vel += <a class="code" href="../../d3/d65/classWTURBULENCE.html#a7241bb335add69029d2a42e3f5e78ac6">WVelocityWithJacobian</a>(texCoord, &amp;xUnwarped[0], &amp;yUnwarped[0], &amp;zUnwarped[0]) * amplitudeScaled;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921           <span class="comment">// scale coefficient for next octave</span>
<a name="l00922"></a>00922           amplitudeScaled *= <a class="code" href="../../d2/d40/WTURBULENCE_8cpp.html#a6447f52d1fc2c6a217bc44515023bf8a">persistence</a>;
<a name="l00923"></a>00923           texCoord *= 2.0f;
<a name="l00924"></a>00924         }
<a name="l00925"></a>00925       }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927       <span class="comment">// Store velocity + turbulence in big grid for maccormack step</span>
<a name="l00928"></a>00928       <span class="comment">//</span>
<a name="l00929"></a>00929       <span class="comment">// If you wanted to save memory, you would instead perform a </span>
<a name="l00930"></a>00930       <span class="comment">// semi-Lagrangian backtrace for the current grid cell here. Then</span>
<a name="l00931"></a>00931       <span class="comment">// you could just throw the velocity away.</span>
<a name="l00932"></a>00932       bigUx[index] = vel[0];
<a name="l00933"></a>00933       bigUy[index] = vel[1];
<a name="l00934"></a>00934       bigUz[index] = vel[2];
<a name="l00935"></a>00935 
<a name="l00936"></a>00936       <span class="comment">// compute the velocity magnitude for substepping later</span>
<a name="l00937"></a>00937       <span class="keyword">const</span> <span class="keywordtype">float</span> velMag = bigUx[index] * bigUx[index] + 
<a name="l00938"></a>00938                            bigUy[index] * bigUy[index] + 
<a name="l00939"></a>00939                            bigUz[index] * bigUz[index];
<a name="l00940"></a>00940       <span class="keywordflow">if</span> (velMag &gt; maxVelMag1) maxVelMag1 = velMag;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942       <span class="comment">// zero out velocity inside obstacles</span>
<a name="l00943"></a>00943       <span class="keywordtype">float</span> obsCheck = <a class="code" href="../../d7/d3c/namespaceINTERPOLATE.html#a82706abcee4dc093ec0f03e49677b701">INTERPOLATE::lerp3dToFloat</a>(
<a name="l00944"></a>00944           obstacles, posSm[0], posSm[1], posSm[2], _xResSm, _yResSm, _zResSm); 
<a name="l00945"></a>00945       <span class="keywordflow">if</span> (obsCheck &gt; 0.95) 
<a name="l00946"></a>00946         bigUx[index] = bigUy[index] = bigUz[index] = 0.;
<a name="l00947"></a>00947     } <span class="comment">// xyz*/</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>    maxVelMagThreads[id] = maxVelMag1;
<a name="l00951"></a>00951 <span class="preprocessor">#else</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span>    maxVelMagThreads[0] = maxVelMag1;
<a name="l00953"></a>00953 <span class="preprocessor">#endif</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>  }
<a name="l00955"></a>00955   }
<a name="l00956"></a>00956   } <span class="comment">// omp</span>
<a name="l00957"></a>00957   
<a name="l00958"></a>00958   <span class="comment">// compute maximum over threads</span>
<a name="l00959"></a>00959   <span class="keywordtype">float</span> maxVelMag = maxVelMagThreads[0];
<a name="l00960"></a>00960 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; threadval; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) 
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (maxVelMag &lt; maxVelMagThreads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) 
<a name="l00963"></a>00963       maxVelMag = maxVelMagThreads[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00964"></a>00964 <span class="preprocessor">#endif</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span>  <span class="keyword">delete</span> [] maxVelMagThreads;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 
<a name="l00968"></a>00968   <span class="comment">// prepare density for an advection</span>
<a name="l00969"></a>00969   <a class="code" href="../../dd/d46/IMAGE_8h.html#aea6cdcc73e7454e3bf7f8460239d2027">SWAP_POINTERS</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971   <span class="comment">// based on the maximum velocity present, see if we need to substep,</span>
<a name="l00972"></a>00972   <span class="comment">// but cap the maximum number of substeps to 5</span>
<a name="l00973"></a>00973   <span class="keyword">const</span> <span class="keywordtype">int</span> maxSubSteps = 25;
<a name="l00974"></a>00974   <span class="keyword">const</span> <span class="keywordtype">int</span> maxVel = 5;
<a name="l00975"></a>00975   maxVelMag = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(maxVelMag) * dt;
<a name="l00976"></a>00976   <span class="keywordtype">int</span> totalSubsteps = (int)(maxVelMag / (<span class="keywordtype">float</span>)maxVel);
<a name="l00977"></a>00977   totalSubsteps = (totalSubsteps &lt; 1) ? 1 : totalSubsteps;
<a name="l00978"></a>00978   <span class="comment">// printf(&quot;totalSubsteps: %d\n&quot;, totalSubsteps);</span>
<a name="l00979"></a>00979   totalSubsteps = (totalSubsteps &gt; maxSubSteps) ? maxSubSteps : totalSubsteps;
<a name="l00980"></a>00980   <span class="keyword">const</span> <span class="keywordtype">float</span> dtSubdiv = dt / (float)totalSubsteps;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982   <span class="comment">// set boundaries of big velocity grid</span>
<a name="l00983"></a>00983   <a class="code" href="../../d6/dac/classFLUID__3D.html#a31391289cee26e878bc6dab1b2fe1692">FLUID_3D::setZeroX</a>(bigUx, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[2]); 
<a name="l00984"></a>00984   <a class="code" href="../../d6/dac/classFLUID__3D.html#ac43cdbac74b5d18d7eb8cb9f5ba7dc04">FLUID_3D::setZeroY</a>(bigUy, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[2]); 
<a name="l00985"></a>00985   <a class="code" href="../../d6/dac/classFLUID__3D.html#a1d94c123afa4e5fb9c4f902a15d35900">FLUID_3D::setZeroZ</a>(bigUz, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[2]);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span>  <span class="keywordtype">int</span> stepParts = threadval*2;  <span class="comment">// Dividing parallelized sections into numOfThreads * 2 sections</span>
<a name="l00989"></a>00989   <span class="keywordtype">float</span> partSize = (float)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>/stepParts;   <span class="comment">// Size of one part;</span>
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <span class="keywordflow">if</span> (partSize &lt; 4) {stepParts = threadval;                 <span class="comment">// If the slice gets too low (might actually slow things down, change it to larger</span>
<a name="l00992"></a>00992                     partSize = (float)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>/stepParts;}
<a name="l00993"></a>00993   <span class="keywordflow">if</span> (partSize &lt; 4) {stepParts = (int)(ceil((<span class="keywordtype">float</span>)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>/4.0f)); <span class="comment">// If it&#39;s still too low (only possible on future systems with +24 cores), change it to 4</span>
<a name="l00994"></a>00994                     partSize = (float)<a class="code" href="../../d3/d65/classWTURBULENCE.html#a9145ad8bab11ea29aa7960be60ce55a8">_zResBig</a>/stepParts;}
<a name="l00995"></a>00995 <span class="preprocessor">#else</span>
<a name="l00996"></a>00996 <span class="preprocessor"></span>  <span class="keywordtype">int</span> zBegin=0;
<a name="l00997"></a>00997   <span class="keywordtype">int</span> zEnd=<a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[2];
<a name="l00998"></a>00998 <span class="preprocessor">#endif</span>
<a name="l00999"></a>00999 <span class="preprocessor"></span>
<a name="l01000"></a>01000   <span class="comment">// do the MacCormack advection, with substepping if necessary</span>
<a name="l01001"></a>01001   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> substep = 0; substep &lt; totalSubsteps; substep++)
<a name="l01002"></a>01002   {
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span><span class="preprocessor">    #pragma omp parallel</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span>    {
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="preprocessor">    #pragma omp for schedule(static,1)</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;stepParts; i++)
<a name="l01010"></a>01010     {
<a name="l01011"></a>01011         <span class="keywordtype">int</span> zBegin = (int)((<span class="keywordtype">float</span>)i*partSize + 0.5f);
<a name="l01012"></a>01012         <span class="keywordtype">int</span> zEnd = (int)((<span class="keywordtype">float</span>)(i+1)*partSize + 0.5f);
<a name="l01013"></a>01013 <span class="preprocessor">#endif</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>        <a class="code" href="../../d6/dac/classFLUID__3D.html#af5d216db7094bc089061a5a9bb594695">FLUID_3D::advectFieldMacCormack1</a>(dtSubdiv, bigUx, bigUy, bigUz, 
<a name="l01015"></a>01015             <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>, tempBig1, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, zBegin, zEnd);
<a name="l01016"></a>01016 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l01017"></a>01017 <span class="preprocessor"></span>    }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019 <span class="preprocessor">    #pragma omp barrier</span>
<a name="l01020"></a>01020 <span class="preprocessor"></span>
<a name="l01021"></a>01021 <span class="preprocessor">    #pragma omp for schedule(static,1)</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;stepParts; i++)
<a name="l01023"></a>01023     {
<a name="l01024"></a>01024         <span class="keywordtype">int</span> zBegin = (int)((<span class="keywordtype">float</span>)i*partSize + 0.5f);
<a name="l01025"></a>01025         <span class="keywordtype">int</span> zEnd = (int)((<span class="keywordtype">float</span>)(i+1)*partSize + 0.5f);
<a name="l01026"></a>01026 <span class="preprocessor">#endif</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span>        <a class="code" href="../../d6/dac/classFLUID__3D.html#aa541e4c2f5610b5169c2b782af481dea">FLUID_3D::advectFieldMacCormack2</a>(dtSubdiv, bigUx, bigUy, bigUz, 
<a name="l01028"></a>01028             <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>, tempBig1, tempBig2, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, zBegin, zEnd);
<a name="l01029"></a>01029 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>    }
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 <span class="preprocessor">#endif</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span>
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (substep &lt; totalSubsteps - 1) 
<a name="l01035"></a>01035       <a class="code" href="../../dd/d46/IMAGE_8h.html#aea6cdcc73e7454e3bf7f8460239d2027">SWAP_POINTERS</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a6fb773c2ff5fa43585c04216627da059">_densityBigOld</a>);
<a name="l01036"></a>01036   } <span class="comment">// substep</span>
<a name="l01037"></a>01037 
<a name="l01038"></a>01038   free(tempBig1);
<a name="l01039"></a>01039   free(tempBig2);
<a name="l01040"></a>01040   free(bigUx);
<a name="l01041"></a>01041   free(bigUy);
<a name="l01042"></a>01042   free(bigUz);
<a name="l01043"></a>01043   free(_energy);
<a name="l01044"></a>01044   free(highFreqEnergy);
<a name="l01045"></a>01045   
<a name="l01046"></a>01046   <span class="comment">// wipe the density borders</span>
<a name="l01047"></a>01047   <a class="code" href="../../d6/dac/classFLUID__3D.html#af95297a228dec253a8d5e352850fbc23">FLUID_3D::setZeroBorder</a>(<a class="code" href="../../d3/d65/classWTURBULENCE.html#a8eb2b71530ef2fce53ebf1f6a0b31279">_densityBig</a>, <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>, 0 , <a class="code" href="../../d3/d65/classWTURBULENCE.html#a45ec247ee04abeefff6f9620d12af457">_resBig</a>[2]);
<a name="l01048"></a>01048     
<a name="l01049"></a>01049   <span class="comment">// reset texture coordinates now in preparation for next timestep</span>
<a name="l01050"></a>01050   <span class="comment">// Shouldn&#39;t do this before generating the noise because then the </span>
<a name="l01051"></a>01051   <span class="comment">// eigenvalues stored do not reflect the underlying texture coordinates</span>
<a name="l01052"></a>01052   <a class="code" href="../../d3/d65/classWTURBULENCE.html#a2b9d0e275c6c3e40552d9fd2f4b54105">resetTextureCoordinates</a>(eigMin, eigMax);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054   free(eigMin);
<a name="l01055"></a>01055   free(eigMax);
<a name="l01056"></a>01056   
<a name="l01057"></a>01057   <span class="comment">// output files</span>
<a name="l01058"></a>01058   <span class="comment">// string prefix = string(&quot;./amplified.preview/density_bigxy_&quot;);</span>
<a name="l01059"></a>01059   <span class="comment">// FLUID_3D::writeImageSliceXY(_densityBig, _resBig, _resBig[2]/2, prefix, _totalStepsBig, 1.0f);</span>
<a name="l01060"></a>01060   <span class="comment">//string df3prefix = string(&quot;./df3/density_big_&quot;);</span>
<a name="l01061"></a>01061   <span class="comment">//IMAGE::dumpDF3(_totalStepsBig, df3prefix, _densityBig, _resBig[0],_resBig[1],_resBig[2]);</span>
<a name="l01062"></a>01062   <span class="comment">// string pbrtPrefix = string(&quot;./pbrt/density_big_&quot;);</span>
<a name="l01063"></a>01063   <span class="comment">// IMAGE::dumpPBRT(_totalStepsBig, pbrtPrefix, _densityBig, _resBig[0],_resBig[1],_resBig[2]);</span>
<a name="l01064"></a>01064   
<a name="l01065"></a>01065   <a class="code" href="../../d3/d65/classWTURBULENCE.html#a680d2da892e6d523a2491c4e8d5b1325">_totalStepsBig</a>++;
<a name="l01066"></a>01066 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:55:05 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
