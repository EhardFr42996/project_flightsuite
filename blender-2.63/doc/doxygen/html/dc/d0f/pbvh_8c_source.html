<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: pbvh.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">pbvh.c</div>  </div>
</div>
<div class="contents">
<a href="../../dc/d0f/pbvh_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd3/BLI__bitmap_8h.html">BLI_bitmap.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d13/BLI__pbvh_8h.html" title="A BVH for high poly meshes.">BLI_pbvh.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span> <span class="comment">/* for mesh_calc_normals */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span> <span class="comment">/* for mesh_calc_normals */</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dca/GPU__buffers_8h.html">GPU_buffers.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#af7834f240e5339fcb9a7019dce0d976b">00045</a> <span class="preprocessor">#define LEAF_LIMIT 10000</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="comment">//#define PERFCNTRS</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="comment">/* Axis-aligned bounding box */</span>
<a name="l00050"></a><a class="code" href="../../d7/d1f/structBB.html">00050</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00051"></a><a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">00051</a>     <span class="keywordtype">float</span> bmin[3], bmax[3];
<a name="l00052"></a>00052 } <a class="code" href="../../d7/d1f/structBB.html">BB</a>;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">/* Axis-aligned bounding box with centroid */</span>
<a name="l00055"></a><a class="code" href="../../d6/d33/structBBC.html">00055</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00056"></a><a class="code" href="../../d6/d33/structBBC.html#a882484bbc22f49f51ce7c158bfa9a600">00056</a>     <span class="keywordtype">float</span> bmin[3], bmax[3], bcentroid[3];
<a name="l00057"></a>00057 } <a class="code" href="../../d6/d33/structBBC.html">BBC</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="../../d2/dae/structPBVHNode.html">00059</a> <span class="keyword">struct </span><a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> {
<a name="l00060"></a>00060     <span class="comment">/* Opaque handle for drawing code */</span>
<a name="l00061"></a><a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">00061</a>     <a class="code" href="../../d3/d52/structGPU__Buffers.html">GPU_Buffers</a> *<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="comment">/* Voxel bounds */</span>
<a name="l00064"></a><a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">00064</a>     <a class="code" href="../../d7/d1f/structBB.html">BB</a> <a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>;
<a name="l00065"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">00065</a>     <a class="code" href="../../d7/d1f/structBB.html">BB</a> <a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067     <span class="comment">/* For internal nodes, the offset of the children in the PBVH</span>
<a name="l00068"></a>00068 <span class="comment">     * &#39;nodes&#39; array. */</span>
<a name="l00069"></a><a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">00069</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">/* Pointer into the PBVH prim_indices array and the number of</span>
<a name="l00072"></a>00072 <span class="comment">     * primitives used by this leaf node.</span>
<a name="l00073"></a>00073 <span class="comment">     *</span>
<a name="l00074"></a>00074 <span class="comment">     * Used for leaf nodes in both mesh- and multires-based PBVHs.</span>
<a name="l00075"></a>00075 <span class="comment">     */</span>
<a name="l00076"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">00076</a>     <span class="keywordtype">int</span> *<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>;
<a name="l00077"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">00077</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="comment">/* Array of indices into the mesh&#39;s MVert array. Contains the</span>
<a name="l00080"></a>00080 <span class="comment">     * indices of all vertices used by faces that are within this</span>
<a name="l00081"></a>00081 <span class="comment">     * node&#39;s bounding box.</span>
<a name="l00082"></a>00082 <span class="comment">     *</span>
<a name="l00083"></a>00083 <span class="comment">     * Note that a vertex might be used by a multiple faces, and</span>
<a name="l00084"></a>00084 <span class="comment">     * these faces might be in different leaf nodes. Such a vertex</span>
<a name="l00085"></a>00085 <span class="comment">     * will appear in the vert_indices array of each of those leaf</span>
<a name="l00086"></a>00086 <span class="comment">     * nodes.</span>
<a name="l00087"></a>00087 <span class="comment">     *</span>
<a name="l00088"></a>00088 <span class="comment">     * In order to support cases where you want access to multiple</span>
<a name="l00089"></a>00089 <span class="comment">     * nodes&#39; vertices without duplication, the vert_indices array</span>
<a name="l00090"></a>00090 <span class="comment">     * is ordered such that the first part of the array, up to</span>
<a name="l00091"></a>00091 <span class="comment">     * index &#39;uniq_verts&#39;, contains &quot;unique&quot; vertex indices. These</span>
<a name="l00092"></a>00092 <span class="comment">     * vertices might not be truly unique to this node, but if</span>
<a name="l00093"></a>00093 <span class="comment">     * they appear in another node&#39;s vert_indices array, they will</span>
<a name="l00094"></a>00094 <span class="comment">     * be above that node&#39;s &#39;uniq_verts&#39; value.</span>
<a name="l00095"></a>00095 <span class="comment">     *</span>
<a name="l00096"></a>00096 <span class="comment">     * Used for leaf nodes in a mesh-based PBVH (not multires.)</span>
<a name="l00097"></a>00097 <span class="comment">     */</span>
<a name="l00098"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">00098</a>     <span class="keywordtype">int</span> *<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>;
<a name="l00099"></a><a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">00099</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a>, <a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a>;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     <span class="comment">/* An array mapping face corners into the vert_indices</span>
<a name="l00102"></a>00102 <span class="comment">     * array. The array is sized to match &#39;totprim&#39;, and each of</span>
<a name="l00103"></a>00103 <span class="comment">     * the face&#39;s corners gets an index into the vert_indices</span>
<a name="l00104"></a>00104 <span class="comment">     * array, in the same order as the corners in the original</span>
<a name="l00105"></a>00105 <span class="comment">     * MFace. The fourth value should not be used if the original</span>
<a name="l00106"></a>00106 <span class="comment">     * face is a triangle.</span>
<a name="l00107"></a>00107 <span class="comment">     *</span>
<a name="l00108"></a>00108 <span class="comment">     * Used for leaf nodes in a mesh-based PBVH (not multires.)</span>
<a name="l00109"></a>00109 <span class="comment">     */</span>
<a name="l00110"></a><a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">00110</a>     int (*<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>)[4];
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="comment">/* Indicates whether this node is a leaf or not; also used for</span>
<a name="l00113"></a>00113 <span class="comment">     * marking various updates that need to be applied. */</span>
<a name="l00114"></a><a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">00114</a>     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eb">PBVHNodeFlags</a> <a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> : 8;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="comment">/* Used for raycasting: how close bb is to the ray point. */</span>
<a name="l00117"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">00117</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">tmin</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">00119</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>;
<a name="l00120"></a><a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">00120</a>     <a class="code" href="../../d2/d16/structPBVHProxyNode.html">PBVHProxyNode</a>* <a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>;
<a name="l00121"></a>00121 };
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="../../d3/dd0/structPBVH.html">00123</a> <span class="keyword">struct </span><a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> {
<a name="l00124"></a><a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">00124</a>     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222">PBVHType</a> <a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">00126</a>     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>;
<a name="l00127"></a><a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">00127</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a>, <a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a>;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">00129</a>     <span class="keywordtype">int</span> *<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>;
<a name="l00130"></a><a class="code" href="../../d3/dd0/structPBVH.html#a7fc29a8474a80a56c780ff3a0f5ca907">00130</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#a7fc29a8474a80a56c780ff3a0f5ca907">totprim</a>;
<a name="l00131"></a><a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">00131</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">totvert</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../d3/dd0/structPBVH.html#aa8a038c857d9158153995b9e66277e85">00133</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#aa8a038c857d9158153995b9e66277e85">leaf_limit</a>;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">/* Mesh data */</span>
<a name="l00136"></a><a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">00136</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>;
<a name="l00137"></a><a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">00137</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">/* Grid Data */</span>
<a name="l00140"></a><a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">00140</a>     <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>;
<a name="l00141"></a><a class="code" href="../../d3/dd0/structPBVH.html#ab96bc933cd88f3110409bc6b77792c20">00141</a>     <a class="code" href="../../d9/d82/structDMGridAdjacency.html">DMGridAdjacency</a> *<a class="code" href="../../d3/dd0/structPBVH.html#ab96bc933cd88f3110409bc6b77792c20">gridadj</a>;
<a name="l00142"></a><a class="code" href="../../d3/dd0/structPBVH.html#aa7468000625e79365e8515bd08a2cd62">00142</a>     <span class="keywordtype">void</span> **<a class="code" href="../../d3/dd0/structPBVH.html#aa7468000625e79365e8515bd08a2cd62">gridfaces</a>;
<a name="l00143"></a><a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">00143</a>     <span class="keyword">const</span> <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>;
<a name="l00144"></a><a class="code" href="../../d3/dd0/structPBVH.html#aa4cc8af4c7aadf168c751c192002d5e0">00144</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#aa4cc8af4c7aadf168c751c192002d5e0">totgrid</a>;
<a name="l00145"></a><a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">00145</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>;
<a name="l00146"></a><a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">00146</a>     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="comment">/* Only used during BVH build and update,</span>
<a name="l00149"></a>00149 <span class="comment">     * don&#39;t need to remain valid after */</span>
<a name="l00150"></a><a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">00150</a>     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> <a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">vert_bitmap</a>;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="preprocessor">#ifdef PERFCNTRS</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>    <span class="keywordtype">int</span> perf_modified;
<a name="l00154"></a>00154 <span class="preprocessor">#endif</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156     <span class="comment">/* flag are verts/faces deformed */</span>
<a name="l00157"></a><a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">00157</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">deformed</a>;
<a name="l00158"></a>00158 };
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae3dd922bc6baa183be239892d565fd95">00160</a> <span class="preprocessor">#define STACK_FIXED_DEPTH   100</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>
<a name="l00162"></a><a class="code" href="../../d6/de8/structPBVHStack.html">00162</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a> {
<a name="l00163"></a><a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">00163</a>     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">node</a>;
<a name="l00164"></a><a class="code" href="../../d6/de8/structPBVHStack.html#a763d6f0a1a35c095ea73357faaff5001">00164</a>     <span class="keywordtype">int</span> <a class="code" href="../../d6/de8/structPBVHStack.html#a763d6f0a1a35c095ea73357faaff5001">revisiting</a>;
<a name="l00165"></a>00165 } <a class="code" href="../../dc/d0f/pbvh_8c.html#a025c4b60f9275c31e07e22bbeb886124">PBVHStack</a>;
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="../../da/d98/structPBVHIter.html">00167</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> {
<a name="l00168"></a><a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">00168</a>     <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>;
<a name="l00169"></a><a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">00169</a>     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aabc55254f1a9d27ea9d649dae782412a">BLI_pbvh_SearchCallback</a> <a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a>;
<a name="l00170"></a><a class="code" href="../../da/d98/structPBVHIter.html#a14f278c0f54d07226afe7c49fcdb5ea5">00170</a>     <span class="keywordtype">void</span> *<a class="code" href="../../da/d98/structPBVHIter.html#a14f278c0f54d07226afe7c49fcdb5ea5">search_data</a>;
<a name="l00171"></a>00171 
<a name="l00172"></a><a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">00172</a>     <a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a> *<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>;
<a name="l00173"></a><a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">00173</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>;
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="../../da/d98/structPBVHIter.html#a06f722e28e6084282b078250fa6d1077">00175</a>     <a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a> <a class="code" href="../../da/d98/structPBVHIter.html#a06f722e28e6084282b078250fa6d1077">stackfixed</a>[<a class="code" href="../../dc/d0f/pbvh_8c.html#ae3dd922bc6baa183be239892d565fd95">STACK_FIXED_DEPTH</a>];
<a name="l00176"></a><a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">00176</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a>;
<a name="l00177"></a>00177 } <a class="code" href="../../dc/d0f/pbvh_8c.html#a65749f3c4660852549c40f66c478c5b6">PBVHIter</a>;
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">00179</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(<a class="code" href="../../d7/d1f/structBB.html">BB</a> *bb)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181     bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[0] = bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[1] = bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[2] = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00182"></a>00182     bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[0] = bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[1] = bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[2] = -<a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/* Expand the bounding box to include a new coordinate */</span>
<a name="l00186"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">00186</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>(<a class="code" href="../../d7/d1f/structBB.html">BB</a> *bb, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00189"></a>00189     <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00190"></a>00190         bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[i], co[i]);
<a name="l00191"></a>00191         bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[i], co[i]);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">/* Expand the bounding box to include another bounding box */</span>
<a name="l00196"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">00196</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">BB_expand_with_bb</a>(<a class="code" href="../../d7/d1f/structBB.html">BB</a> *bb, <a class="code" href="../../d7/d1f/structBB.html">BB</a> *bb2)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00199"></a>00199     <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00200"></a>00200         bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[i], bb2-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[i]);
<a name="l00201"></a>00201         bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[i], bb2-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[i]);
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">/* Return 0, 1, or 2 to indicate the widest axis of the bounding box */</span>
<a name="l00206"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a37d20f2cbcc08f7f800001ac96391173">00206</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a37d20f2cbcc08f7f800001ac96391173">BB_widest_axis</a>(<a class="code" href="../../d7/d1f/structBB.html">BB</a> *bb)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208     <span class="keywordtype">float</span> dim[3];
<a name="l00209"></a>00209     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00212"></a>00212         dim[i] = bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[i] - bb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[i];
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (dim[0] &gt; dim[1]) {
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (dim[0] &gt; dim[2])
<a name="l00216"></a>00216             <span class="keywordflow">return</span> 0;
<a name="l00217"></a>00217         <span class="keywordflow">else</span>
<a name="l00218"></a>00218             <span class="keywordflow">return</span> 2;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     <span class="keywordflow">else</span> {
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (dim[1] &gt; dim[2])
<a name="l00222"></a>00222             <span class="keywordflow">return</span> 1;
<a name="l00223"></a>00223         <span class="keywordflow">else</span>
<a name="l00224"></a>00224             <span class="keywordflow">return</span> 2;
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a99bf37eda5bbdfb6769c5c3d93f387e4">00228</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a99bf37eda5bbdfb6769c5c3d93f387e4">BBC_update_centroid</a>(<a class="code" href="../../d6/d33/structBBC.html">BBC</a> *bbc)
<a name="l00229"></a>00229 {
<a name="l00230"></a>00230     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00231"></a>00231     <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00232"></a>00232         bbc-&gt;<a class="code" href="../../d6/d33/structBBC.html#afa22619bf3eda7e5546d078d469b190a">bcentroid</a>[i] = (bbc-&gt;<a class="code" href="../../d6/d33/structBBC.html#a882484bbc22f49f51ce7c158bfa9a600">bmin</a>[i] + bbc-&gt;<a class="code" href="../../d6/d33/structBBC.html#a434dc5f4882ff4595209f9a2aefc7755">bmax</a>[i]) * 0.5f;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="comment">/* Not recursive */</span>
<a name="l00236"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a6533895235e31118bf3eefbd481ddef3">00236</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a6533895235e31118bf3eefbd481ddef3">update_node_vb</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <a class="code" href="../../d7/d1f/structBB.html">BB</a> vb;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(&amp;vb);
<a name="l00241"></a>00241     
<a name="l00242"></a>00242     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00243"></a>00243         <a class="code" href="../../d4/d18/structPBVHVertexIter.html">PBVHVertexIter</a> vd;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ab00130472d6dbcf07fa2f4529dd3da77">BLI_pbvh_vertex_iter_begin</a>(bvh, node, vd, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1e5915687b643feaddfd747aab14b5f9">PBVH_ITER_ALL</a>) {
<a name="l00246"></a>00246             <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>(&amp;vb, vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a450bced6bb74ccd088a0540fdb53fcd6">co</a>);
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a5b3a073eb77860b640a960d786ab2755">BLI_pbvh_vertex_iter_end</a>;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     <span class="keywordflow">else</span> {
<a name="l00251"></a>00251         <a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">BB_expand_with_bb</a>(&amp;vb,
<a name="l00252"></a>00252                   &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>].<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>);
<a name="l00253"></a>00253         <a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">BB_expand_with_bb</a>(&amp;vb,
<a name="l00254"></a>00254                   &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a> + 1].<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>);
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>= vb;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 <span class="comment">//void BLI_pbvh_node_BB_reset(PBVHNode* node)</span>
<a name="l00261"></a>00261 <span class="comment">//{</span>
<a name="l00262"></a>00262 <span class="comment">//  BB_reset(&amp;node-&gt;vb);</span>
<a name="l00263"></a>00263 <span class="comment">//}</span>
<a name="l00264"></a>00264 <span class="comment">//</span>
<a name="l00265"></a>00265 <span class="comment">//void BLI_pbvh_node_BB_expand(PBVHNode* node, float co[3])</span>
<a name="l00266"></a>00266 <span class="comment">//{</span>
<a name="l00267"></a>00267 <span class="comment">//  BB_expand(&amp;node-&gt;vb, co);</span>
<a name="l00268"></a>00268 <span class="comment">//}</span>
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a407f07cce3a07fc681411902686f3da1">00270</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a407f07cce3a07fc681411902686f3da1">face_materials_match</a>(<span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f1, <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f2)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <span class="keywordflow">return</span> ((f1-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>) == (f2-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>) &amp;&amp;
<a name="l00273"></a>00273             (f1-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> == f2-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a>));
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a700be435cd85532337dc9d8e983a629c">00276</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a700be435cd85532337dc9d8e983a629c">grid_materials_match</a>(<span class="keyword">const</span> <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *f1, <span class="keyword">const</span> <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *f2)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278     <span class="keywordflow">return</span> ((f1-&gt;<a class="code" href="../../da/d1d/structDMFlagMat.html#a2a420c60aa30d84c70b21349d186c727">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>) == (f2-&gt;<a class="code" href="../../da/d1d/structDMFlagMat.html#a2a420c60aa30d84c70b21349d186c727">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>) &amp;&amp;
<a name="l00279"></a>00279             (f1-&gt;<a class="code" href="../../da/d1d/structDMFlagMat.html#a65a4c37ed760de6ae2f7f097811a267f">mat_nr</a> == f2-&gt;<a class="code" href="../../da/d1d/structDMFlagMat.html#a65a4c37ed760de6ae2f7f097811a267f">mat_nr</a>));
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">/* Adapted from BLI_kdopbvh.c */</span>
<a name="l00283"></a>00283 <span class="comment">/* Returns the index of the first element on the right of the partition */</span>
<a name="l00284"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a1829b0f3335f6612358c2dce8b0b0832">00284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a1829b0f3335f6612358c2dce8b0b0832">partition_indices</a>(<span class="keywordtype">int</span> *prim_indices, <span class="keywordtype">int</span> lo, <span class="keywordtype">int</span> hi, <span class="keywordtype">int</span> axis,
<a name="l00285"></a>00285                  <span class="keywordtype">float</span> mid, <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc)
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=lo, j=hi;
<a name="l00288"></a>00288     <span class="keywordflow">for</span> (;;) {
<a name="l00289"></a>00289         <span class="keywordflow">for</span> (; prim_bbc[prim_indices[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]].<a class="code" href="../../d6/d33/structBBC.html#afa22619bf3eda7e5546d078d469b190a">bcentroid</a>[axis] &lt; mid; i++);
<a name="l00290"></a>00290         <span class="keywordflow">for</span> (; mid &lt; prim_bbc[prim_indices[j]].<a class="code" href="../../d6/d33/structBBC.html#afa22619bf3eda7e5546d078d469b190a">bcentroid</a>[axis]; j--);
<a name="l00291"></a>00291         
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (!(i &lt; j))
<a name="l00293"></a>00293             <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00294"></a>00294         
<a name="l00295"></a>00295         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">int</span>, prim_indices[i], prim_indices[j]);
<a name="l00296"></a>00296         i++;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">/* Returns the index of the first element on the right of the partition */</span>
<a name="l00301"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a9afa1885f306eda3f53a96d25448d8c9">00301</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a9afa1885f306eda3f53a96d25448d8c9">partition_indices_material</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> lo, <span class="keywordtype">int</span> hi)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303     <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *faces = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>;
<a name="l00304"></a>00304     <span class="keyword">const</span> <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *flagmats = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>;
<a name="l00305"></a>00305     <span class="keyword">const</span> <span class="keywordtype">int</span> *<a class="code" href="../../d2/d6c/mball_8c.html#a47e7cc913f2b356de088363a1d87db4a">indices</a> = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>;
<a name="l00306"></a>00306     <span class="keyword">const</span> <span class="keywordtype">void</span> *first;
<a name="l00307"></a>00307     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=lo, j=hi;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>)
<a name="l00310"></a>00310         first = &amp;faces[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[lo]];
<a name="l00311"></a>00311     <span class="keywordflow">else</span>
<a name="l00312"></a>00312         first = &amp;flagmats[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[lo]];
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="keywordflow">for</span> (;;) {
<a name="l00315"></a>00315         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>) {
<a name="l00316"></a>00316             <span class="keywordflow">for</span> (; <a class="code" href="../../dc/d0f/pbvh_8c.html#a407f07cce3a07fc681411902686f3da1">face_materials_match</a>(first, &amp;faces[indices[i]]); i++);
<a name="l00317"></a>00317             <span class="keywordflow">for</span> (; !<a class="code" href="../../dc/d0f/pbvh_8c.html#a407f07cce3a07fc681411902686f3da1">face_materials_match</a>(first, &amp;faces[indices[j]]); j--);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <span class="keywordflow">else</span> {
<a name="l00320"></a>00320             <span class="keywordflow">for</span> (; <a class="code" href="../../dc/d0f/pbvh_8c.html#a700be435cd85532337dc9d8e983a629c">grid_materials_match</a>(first, &amp;flagmats[indices[i]]); i++);
<a name="l00321"></a>00321             <span class="keywordflow">for</span> (; !<a class="code" href="../../dc/d0f/pbvh_8c.html#a700be435cd85532337dc9d8e983a629c">grid_materials_match</a>(first, &amp;flagmats[indices[j]]); j--);
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         
<a name="l00324"></a>00324         <span class="keywordflow">if</span> (!(i &lt; j))
<a name="l00325"></a>00325             <span class="keywordflow">return</span> i;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">int</span>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[i], bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[j]);
<a name="l00328"></a>00328         i++;
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae1d962f19c754d00fda00a25a5146fc1">00332</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ae1d962f19c754d00fda00a25a5146fc1">grow_nodes</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> totnode)
<a name="l00333"></a>00333 {
<a name="l00334"></a>00334     <span class="keywordflow">if</span> (totnode &gt; bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a>) {
<a name="l00335"></a>00335         <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *prev = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>;
<a name="l00336"></a>00336         bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a> *= 1.33;
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a> &lt; totnode)
<a name="l00338"></a>00338             bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a> = totnode;
<a name="l00339"></a>00339         bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>) * bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a>,
<a name="l00340"></a>00340                      <span class="stringliteral">&quot;bvh nodes&quot;</span>);
<a name="l00341"></a>00341         memcpy(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>, prev, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>));
<a name="l00342"></a>00342         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(prev);
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a> = totnode;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 <span class="comment">/* Add a vertex to the map, with a positive value for unique vertices and</span>
<a name="l00349"></a>00349 <span class="comment"> * a negative value for additional vertices */</span>
<a name="l00350"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a98f4423a9850d89c8093a18558c5cb11">00350</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a98f4423a9850d89c8093a18558c5cb11">map_insert_vert</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../df/da0/structGHash.html">GHash</a> *map,
<a name="l00351"></a>00351                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *face_verts,
<a name="l00352"></a>00352                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *uniq_verts, <span class="keywordtype">int</span> <a class="code" href="../../db/d7c/structvertex.html">vertex</a>)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <span class="keywordtype">void</span> *value, *key = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(vertex);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aaf17fe206dcb6b7b222b670b2a9570c1">BLI_ghash_haskey</a>(map, key)) {
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (<a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a74951d7a6b7401568d603bf3a55d5d8d">BLI_BITMAP_GET</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">vert_bitmap</a>, vertex)) {
<a name="l00358"></a>00358             value = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(~(*face_verts));
<a name="l00359"></a>00359             ++(*face_verts);
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         <span class="keywordflow">else</span> {
<a name="l00362"></a>00362             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a27cfe01984456f412abfb142d8ae5a1c">BLI_BITMAP_SET</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">vert_bitmap</a>, vertex);
<a name="l00363"></a>00363             value = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(*uniq_verts);
<a name="l00364"></a>00364             ++(*uniq_verts);
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366         
<a name="l00367"></a>00367         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(map, key, value);
<a name="l00368"></a>00368         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(value);
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370     <span class="keywordflow">else</span>
<a name="l00371"></a>00371         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(map, key));
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="comment">/* Find vertices used by the faces in this node and update the draw buffers */</span>
<a name="l00375"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ab1a01812f28b592d75fd1ba36aee8600">00375</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ab1a01812f28b592d75fd1ba36aee8600">build_mesh_leaf_node</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *iter;
<a name="l00378"></a>00378     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *map;
<a name="l00379"></a>00379     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, totface;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     map = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a740dc6d654384d5ad7097ffb19d3427c">BLI_ghashutil_inthash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aafcc0f47fca1c35fee3ec515dfa43f15">BLI_ghashutil_intcmp</a>, <span class="stringliteral">&quot;build_mesh_leaf_node gh&quot;</span>);
<a name="l00382"></a>00382     
<a name="l00383"></a>00383     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a> = 0;
<a name="l00384"></a>00384     totface= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 4*totface,
<a name="l00387"></a>00387                           <span class="stringliteral">&quot;bvh node face vert indices&quot;</span>);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00390"></a>00390         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00391"></a>00391         <span class="keywordtype">int</span> sides = f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="keywordflow">for</span> (j = 0; j &lt; sides; ++j) {
<a name="l00394"></a>00394             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][j]= 
<a name="l00395"></a>00395                 <a class="code" href="../../dc/d0f/pbvh_8c.html#a98f4423a9850d89c8093a18558c5cb11">map_insert_vert</a>(bvh, map, &amp;node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a>,
<a name="l00396"></a>00396                         &amp;node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a>, (&amp;f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[j]);
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) *
<a name="l00401"></a>00401                      (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a>),
<a name="l00402"></a>00402                      <span class="stringliteral">&quot;bvh node vert indices&quot;</span>);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* Build the vertex list, unique verts first */</span>
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (iter = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(map), i = 0;
<a name="l00406"></a>00406         !<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(iter);
<a name="l00407"></a>00407         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(iter), ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00408"></a>00408         <span class="keywordtype">void</span> *value = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a65c048ac3140f6c2598d94e4276a41f3">BLI_ghashIterator_getValue</a>(iter);
<a name="l00409"></a>00409         <span class="keywordtype">int</span> ndx = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(value);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (ndx &lt; 0)
<a name="l00412"></a>00412             ndx = -ndx + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> - 1;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>[ndx] =
<a name="l00415"></a>00415             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>(iter));
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(iter);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00421"></a>00421         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00422"></a>00422         <span class="keywordtype">int</span> sides = f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3;
<a name="l00423"></a>00423         
<a name="l00424"></a>00424         <span class="keywordflow">for</span> (j = 0; j &lt; sides; ++j) {
<a name="l00425"></a>00425             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>[i][j] &lt; 0)
<a name="l00426"></a>00426                 node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][j]=
<a name="l00427"></a>00427                     -node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][j] +
<a name="l00428"></a>00428                     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> - 1;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background) {
<a name="l00433"></a>00433         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a> =
<a name="l00434"></a>00434             <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a73c3ccfc7c48b2369aec6cff5b741b7b">GPU_build_mesh_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>,
<a name="l00435"></a>00435                     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>,
<a name="l00436"></a>00436                     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>,
<a name="l00437"></a>00437                     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>);
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(map, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a0d38d937285deae8dd89ac6fe92e8cca">00445</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a0d38d937285deae8dd89ac6fe92e8cca">build_grids_leaf_node</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background) {
<a name="l00448"></a>00448         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a> =
<a name="l00449"></a>00449             <a class="code" href="../../d8/dca/GPU__buffers_8h.html#ac3358bca5ba9da67f01dbdb77bd92ab7">GPU_build_grid_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>,
<a name="l00450"></a>00450                 node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>;
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a11d7395c05611b2fed03e5a0d1c160ac">00455</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a11d7395c05611b2fed03e5a0d1c160ac">update_vb</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc,
<a name="l00456"></a>00456                       <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> count)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00459"></a>00459     
<a name="l00460"></a>00460     <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(&amp;node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>);
<a name="l00461"></a>00461     <span class="keywordflow">for</span> (i = offset + count - 1; i &gt;= offset; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00462"></a>00462         <a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">BB_expand_with_bb</a>(&amp;node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>, (<a class="code" href="../../d7/d1f/structBB.html">BB</a>*)(&amp;prim_bbc[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[i]]));
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a> = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>;
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#aa5dd0dee89c5730fa670d862fd3b3dd1">00467</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#aa5dd0dee89c5730fa670d862fd3b3dd1">build_leaf</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> node_index, <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc,
<a name="l00468"></a>00468                        <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> count)
<a name="l00469"></a>00469 {
<a name="l00470"></a>00470     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a> = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a> + offset;
<a name="l00473"></a>00473     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a> = count;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <span class="comment">/* Still need vb for searches */</span>
<a name="l00476"></a>00476     <a class="code" href="../../dc/d0f/pbvh_8c.html#a11d7395c05611b2fed03e5a0d1c160ac">update_vb</a>(bvh, &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index], prim_bbc, offset, count);
<a name="l00477"></a>00477         
<a name="l00478"></a>00478     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>)
<a name="l00479"></a>00479         <a class="code" href="../../dc/d0f/pbvh_8c.html#ab1a01812f28b592d75fd1ba36aee8600">build_mesh_leaf_node</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> + node_index);
<a name="l00480"></a>00480     <span class="keywordflow">else</span>
<a name="l00481"></a>00481         <a class="code" href="../../dc/d0f/pbvh_8c.html#a0d38d937285deae8dd89ac6fe92e8cca">build_grids_leaf_node</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> + node_index);
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="comment">/* Return zero if all primitives in the node can be drawn with the</span>
<a name="l00485"></a>00485 <span class="comment"> * same material (including flat/smooth shading), non-zerootherwise */</span>
<a name="l00486"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ac650f0f9fbf307685b5b39cff7c49939">00486</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ac650f0f9fbf307685b5b39cff7c49939">leaf_needs_material_split</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> count)
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, prim;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (count &lt;= 1)
<a name="l00491"></a>00491         <span class="keywordflow">return</span> 0;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>) {
<a name="l00494"></a>00494         <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *first = &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[offset]];
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         <span class="keywordflow">for</span> (i = offset + count - 1; i &gt; offset; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00497"></a>00497             prim = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00498"></a>00498             <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d0f/pbvh_8c.html#a407f07cce3a07fc681411902686f3da1">face_materials_match</a>(first, &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>[prim]))
<a name="l00499"></a>00499                 <span class="keywordflow">return</span> 1;
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     <span class="keywordflow">else</span> {
<a name="l00503"></a>00503         <span class="keyword">const</span> <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *first = &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[offset]];
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="keywordflow">for</span> (i = offset + count - 1; i &gt; offset; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00506"></a>00506             prim = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00507"></a>00507             <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d0f/pbvh_8c.html#a700be435cd85532337dc9d8e983a629c">grid_materials_match</a>(first, &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>[prim]))
<a name="l00508"></a>00508                 <span class="keywordflow">return</span> 1;
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="keywordflow">return</span> 0;
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="comment">/* Recursively build a node in the tree</span>
<a name="l00517"></a>00517 <span class="comment"> *</span>
<a name="l00518"></a>00518 <span class="comment"> * vb is the voxel box around all of the primitives contained in</span>
<a name="l00519"></a>00519 <span class="comment"> * this node.</span>
<a name="l00520"></a>00520 <span class="comment"> *</span>
<a name="l00521"></a>00521 <span class="comment"> * cb is the bounding box around all the centroids of the primitives</span>
<a name="l00522"></a>00522 <span class="comment"> * contained in this node</span>
<a name="l00523"></a>00523 <span class="comment"> *</span>
<a name="l00524"></a>00524 <span class="comment"> * offset and start indicate a range in the array of primitive indices</span>
<a name="l00525"></a>00525 <span class="comment"> */</span>
<a name="l00526"></a>00526 
<a name="l00527"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ac0e58740a121150cbdefab5004c554e6">00527</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ac0e58740a121150cbdefab5004c554e6">build_sub</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> node_index, <a class="code" href="../../d7/d1f/structBB.html">BB</a> *cb, <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc,
<a name="l00528"></a>00528                       <span class="keywordtype">int</span> offset, <span class="keywordtype">int</span> count)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, axis, end, below_leaf_limit;
<a name="l00531"></a>00531     <a class="code" href="../../d7/d1f/structBB.html">BB</a> cb_backing;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="comment">/* Decide whether this is a leaf or not */</span>
<a name="l00534"></a>00534     below_leaf_limit = count &lt;= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa8a038c857d9158153995b9e66277e85">leaf_limit</a>;
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (below_leaf_limit) {
<a name="l00536"></a>00536         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d0f/pbvh_8c.html#ac650f0f9fbf307685b5b39cff7c49939">leaf_needs_material_split</a>(bvh, offset, count)) {
<a name="l00537"></a>00537             <a class="code" href="../../dc/d0f/pbvh_8c.html#aa5dd0dee89c5730fa670d862fd3b3dd1">build_leaf</a>(bvh, node_index, prim_bbc, offset, count);
<a name="l00538"></a>00538             <span class="keywordflow">return</span>;
<a name="l00539"></a>00539         }
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="comment">/* Add two child nodes */</span>
<a name="l00543"></a>00543     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a> = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a>;
<a name="l00544"></a>00544     <a class="code" href="../../dc/d0f/pbvh_8c.html#ae1d962f19c754d00fda00a25a5146fc1">grow_nodes</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a> + 2);
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="comment">/* Update parent node bounding box */</span>
<a name="l00547"></a>00547     <a class="code" href="../../dc/d0f/pbvh_8c.html#a11d7395c05611b2fed03e5a0d1c160ac">update_vb</a>(bvh, &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index], prim_bbc, offset, count);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (!below_leaf_limit) {
<a name="l00550"></a>00550         <span class="comment">/* Find axis with widest range of primitive centroids */</span>
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (!cb) {
<a name="l00552"></a>00552             cb = &amp;cb_backing;
<a name="l00553"></a>00553             <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(cb);
<a name="l00554"></a>00554             <span class="keywordflow">for</span> (i = offset + count - 1; i &gt;= offset; --<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00555"></a>00555                 <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>(cb, prim_bbc[bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[i]].<a class="code" href="../../d6/d33/structBBC.html#afa22619bf3eda7e5546d078d469b190a">bcentroid</a>);
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557         axis = <a class="code" href="../../dc/d0f/pbvh_8c.html#a37d20f2cbcc08f7f800001ac96391173">BB_widest_axis</a>(cb);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <span class="comment">/* Partition primitives along that axis */</span>
<a name="l00560"></a>00560         end = <a class="code" href="../../dc/d0f/pbvh_8c.html#a1829b0f3335f6612358c2dce8b0b0832">partition_indices</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>,
<a name="l00561"></a>00561                                 offset, offset + count - 1,
<a name="l00562"></a>00562                                 axis,
<a name="l00563"></a>00563                                 (cb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>[axis] + cb-&gt;<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>[axis]) * 0.5f,
<a name="l00564"></a>00564                                 prim_bbc);
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     <span class="keywordflow">else</span> {
<a name="l00567"></a>00567         <span class="comment">/* Partition primitives by material */</span>
<a name="l00568"></a>00568         end = <a class="code" href="../../dc/d0f/pbvh_8c.html#a9afa1885f306eda3f53a96d25448d8c9">partition_indices_material</a>(bvh, offset, offset + count - 1);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="comment">/* Build children */</span>
<a name="l00572"></a>00572     <a class="code" href="../../dc/d0f/pbvh_8c.html#ac0e58740a121150cbdefab5004c554e6">build_sub</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00573"></a>00573               prim_bbc, offset, end - offset);
<a name="l00574"></a>00574     <a class="code" href="../../dc/d0f/pbvh_8c.html#ac0e58740a121150cbdefab5004c554e6">build_sub</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[node_index].<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a> + 1, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00575"></a>00575               prim_bbc, end, offset + count - end);
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#abfdea05e04b116165683b6567a8aa7ed">00578</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#abfdea05e04b116165683b6567a8aa7ed">pbvh_build</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d7/d1f/structBB.html">BB</a> *cb, <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc, <span class="keywordtype">int</span> totprim)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (totprim != bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a7fc29a8474a80a56c780ff3a0f5ca907">totprim</a>) {
<a name="l00583"></a>00583         bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a7fc29a8474a80a56c780ff3a0f5ca907">totprim</a> = totprim;
<a name="l00584"></a>00584         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>);
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>);
<a name="l00586"></a>00586         bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * totprim,
<a name="l00587"></a>00587                         <span class="stringliteral">&quot;bvh prim indices&quot;</span>);
<a name="l00588"></a>00588         <span class="keywordflow">for</span> (i = 0; i &lt; totprim; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00589"></a>00589             bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>[i] = i;
<a name="l00590"></a>00590         bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a> = 0;
<a name="l00591"></a>00591         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a> &lt; 100) {
<a name="l00592"></a>00592             bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a> = 100;
<a name="l00593"></a>00593             bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>) *
<a name="l00594"></a>00594                          bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa157e769477d69fad74ca88eebea9d5c">node_mem_count</a>,
<a name="l00595"></a>00595                          <span class="stringliteral">&quot;bvh initial nodes&quot;</span>);
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a> = 1;
<a name="l00600"></a>00600     <a class="code" href="../../dc/d0f/pbvh_8c.html#ac0e58740a121150cbdefab5004c554e6">build_sub</a>(bvh, 0, cb, prim_bbc, 0, totprim);
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 <span class="comment">/* Do a full rebuild with on Mesh data structure */</span>
<a name="l00604"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae4aada45e4ca9a7bfa9e79c01113a2d6">00604</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a97786829a00f386833b750c23983bede">BLI_pbvh_build_mesh</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *faces, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts, <span class="keywordtype">int</span> totface, <span class="keywordtype">int</span> totvert)
<a name="l00605"></a>00605 {
<a name="l00606"></a>00606     <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00607"></a>00607     <a class="code" href="../../d7/d1f/structBB.html">BB</a> cb;
<a name="l00608"></a>00608     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a> = <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>;
<a name="l00611"></a>00611     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a> = faces;
<a name="l00612"></a>00612     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a> = verts;
<a name="l00613"></a>00613     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">vert_bitmap</a> = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ab5a4c9770bba8ca87005a5c84fa33dfa">BLI_BITMAP_NEW</a>(totvert, <span class="stringliteral">&quot;bvh-&gt;vert_bitmap&quot;</span>);
<a name="l00614"></a>00614     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">totvert</a> = totvert;
<a name="l00615"></a>00615     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa8a038c857d9158153995b9e66277e85">leaf_limit</a> = <a class="code" href="../../dc/d0f/pbvh_8c.html#af7834f240e5339fcb9a7019dce0d976b">LEAF_LIMIT</a>;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(&amp;cb);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="comment">/* For each face, store the AABB and the AABB centroid */</span>
<a name="l00620"></a>00620     prim_bbc = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d33/structBBC.html">BBC</a>) * totface, <span class="stringliteral">&quot;prim_bbc&quot;</span>);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00623"></a>00623         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = faces + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00624"></a>00624         <span class="keyword">const</span> <span class="keywordtype">int</span> sides = f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3;
<a name="l00625"></a>00625         <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *bbc = prim_bbc + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>((<a class="code" href="../../d7/d1f/structBB.html">BB</a>*)bbc);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <span class="keywordflow">for</span> (j = 0; j &lt; sides; ++j)
<a name="l00630"></a>00630             <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>((<a class="code" href="../../d7/d1f/structBB.html">BB</a>*)bbc, verts[(&amp;f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[j]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <a class="code" href="../../dc/d0f/pbvh_8c.html#a99bf37eda5bbdfb6769c5c3d93f387e4">BBC_update_centroid</a>(bbc);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>(&amp;cb, bbc-&gt;bcentroid);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (totface)
<a name="l00638"></a>00638         <a class="code" href="../../dc/d0f/pbvh_8c.html#abfdea05e04b116165683b6567a8aa7ed">pbvh_build</a>(bvh, &amp;cb, prim_bbc, totface);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(prim_bbc);
<a name="l00641"></a>00641     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a71f2c99bc589134eae2dae0efe4ce109">vert_bitmap</a>);
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="comment">/* Do a full rebuild with on Grids data structure */</span>
<a name="l00645"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a74a8dbc7d8e43b0a8f0e7f3d956fb7fd">00645</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a309d3e1ca3e4215704bc207cb3ab19c5">BLI_pbvh_build_grids</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **grids, <a class="code" href="../../d9/d82/structDMGridAdjacency.html">DMGridAdjacency</a> *gridadj,
<a name="l00646"></a>00646     <span class="keywordtype">int</span> totgrid, <span class="keywordtype">int</span> gridsize, <span class="keywordtype">void</span> **gridfaces, <a class="code" href="../../da/d1d/structDMFlagMat.html">DMFlagMat</a> *flagmats, <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *grid_hidden)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648     <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *prim_bbc = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00649"></a>00649     <a class="code" href="../../d7/d1f/structBB.html">BB</a> cb;
<a name="l00650"></a>00650     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a> = <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>;
<a name="l00653"></a>00653     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>= grids;
<a name="l00654"></a>00654     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab96bc933cd88f3110409bc6b77792c20">gridadj</a>= gridadj;
<a name="l00655"></a>00655     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa7468000625e79365e8515bd08a2cd62">gridfaces</a>= gridfaces;
<a name="l00656"></a>00656     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>= flagmats;
<a name="l00657"></a>00657     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa4cc8af4c7aadf168c751c192002d5e0">totgrid</a>= totgrid;
<a name="l00658"></a>00658     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>= gridsize;
<a name="l00659"></a>00659     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>= grid_hidden;
<a name="l00660"></a>00660     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa8a038c857d9158153995b9e66277e85">leaf_limit</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(<a class="code" href="../../dc/d0f/pbvh_8c.html#af7834f240e5339fcb9a7019dce0d976b">LEAF_LIMIT</a>/((gridsize-1)*(gridsize-1)), 1);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(&amp;cb);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="comment">/* For each grid, store the AABB and the AABB centroid */</span>
<a name="l00665"></a>00665     prim_bbc = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d33/structBBC.html">BBC</a>) * totgrid, <span class="stringliteral">&quot;prim_bbc&quot;</span>);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     <span class="keywordflow">for</span> (i = 0; i &lt; totgrid; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00668"></a>00668         <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *grid= grids[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00669"></a>00669         <a class="code" href="../../d6/d33/structBBC.html">BBC</a> *bbc = prim_bbc + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>((<a class="code" href="../../d7/d1f/structBB.html">BB</a>*)bbc);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keywordflow">for</span> (j = 0; j &lt; gridsize*gridsize; ++j)
<a name="l00674"></a>00674             <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>((<a class="code" href="../../d7/d1f/structBB.html">BB</a>*)bbc, grid[j].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <a class="code" href="../../dc/d0f/pbvh_8c.html#a99bf37eda5bbdfb6769c5c3d93f387e4">BBC_update_centroid</a>(bbc);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         <a class="code" href="../../dc/d0f/pbvh_8c.html#ac8c9160003cd2631797f9e4a35497360">BB_expand</a>(&amp;cb, bbc-&gt;bcentroid);
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (totgrid)
<a name="l00682"></a>00682         <a class="code" href="../../dc/d0f/pbvh_8c.html#abfdea05e04b116165683b6567a8aa7ed">pbvh_build</a>(bvh, &amp;cb, prim_bbc, totgrid);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(prim_bbc);
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ac02a4c80bcef2679da6cd22e0fbd7796">00687</a> <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ac02a4c80bcef2679da6cd22e0fbd7796">BLI_pbvh_new</a>(<span class="keywordtype">void</span>)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689     <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a>), <span class="stringliteral">&quot;pbvh&quot;</span>);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">return</span> bvh;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a926a1b3c8250b12fd2a8915615e73146">00694</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a926a1b3c8250b12fd2a8915615e73146">BLI_pbvh_free</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l00697"></a>00697     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="keywordflow">for</span> (i = 0; i &lt; bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00700"></a>00700         node= &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00703"></a>00703             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>)
<a name="l00704"></a>00704                 <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a8f4c15f16c06906aedc61465e16a592d">GPU_free_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>);
<a name="l00705"></a>00705             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>)
<a name="l00706"></a>00706                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>);
<a name="l00707"></a>00707             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>)
<a name="l00708"></a>00708                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>);
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">deformed</a>) {
<a name="l00713"></a>00713         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>) {
<a name="l00714"></a>00714             <span class="comment">/* if pbvh was deformed, new memory was allocated for verts/faces -- free it */</span>
<a name="l00715"></a>00715 
<a name="l00716"></a>00716             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>);
<a name="l00717"></a>00717             <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>)
<a name="l00718"></a>00718                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>);
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>)
<a name="l00723"></a>00723         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>)
<a name="l00726"></a>00726         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a12e1f76d31fdee45dc51ad8d247e094d">prim_indices</a>);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bvh);
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">00731</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(<a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> *iter, <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aabc55254f1a9d27ea9d649dae782412a">BLI_pbvh_SearchCallback</a> scb, <span class="keywordtype">void</span> *search_data)
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>= bvh;
<a name="l00734"></a>00734     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a>= scb;
<a name="l00735"></a>00735     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a14f278c0f54d07226afe7c49fcdb5ea5">search_data</a>= search_data;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>= iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a06f722e28e6084282b078250fa6d1077">stackfixed</a>;
<a name="l00738"></a>00738     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a>= <a class="code" href="../../dc/d0f/pbvh_8c.html#ae3dd922bc6baa183be239892d565fd95">STACK_FIXED_DEPTH</a>;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[0].<a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">node</a>= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>;
<a name="l00741"></a>00741     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[0].<a class="code" href="../../d6/de8/structPBVHStack.html#a763d6f0a1a35c095ea73357faaff5001">revisiting</a>= 0;
<a name="l00742"></a>00742     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>= 1;
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">00745</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(<a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> *iter)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747     <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a> &gt; <a class="code" href="../../dc/d0f/pbvh_8c.html#ae3dd922bc6baa183be239892d565fd95">STACK_FIXED_DEPTH</a>)
<a name="l00748"></a>00748         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>);
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">00751</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(<a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> *iter, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> revisiting)
<a name="l00752"></a>00752 {
<a name="l00753"></a>00753     <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a> == iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a>) {
<a name="l00754"></a>00754         <a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a> *newstack;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a> *= 2;
<a name="l00757"></a>00757         newstack= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a>)*iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a>, <span class="stringliteral">&quot;PBVHStack&quot;</span>);
<a name="l00758"></a>00758         memcpy(newstack, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/de8/structPBVHStack.html">PBVHStack</a>)*iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760         <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#af9e834f58a4f465faadfdacd3034a04a">stackspace</a> &gt; <a class="code" href="../../dc/d0f/pbvh_8c.html#ae3dd922bc6baa183be239892d565fd95">STACK_FIXED_DEPTH</a>)
<a name="l00761"></a>00761             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>);
<a name="l00762"></a>00762         iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>= newstack;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>].<a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">node</a>= node;
<a name="l00766"></a>00766     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>].<a class="code" href="../../d6/de8/structPBVHStack.html#a763d6f0a1a35c095ea73357faaff5001">revisiting</a>= revisiting;
<a name="l00767"></a>00767     iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>++;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">00770</a> <span class="keyword">static</span> <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">pbvh_iter_next</a>(<a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> *iter)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l00773"></a>00773     <span class="keywordtype">int</span> revisiting;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="comment">/* purpose here is to traverse tree, visiting child nodes before their</span>
<a name="l00776"></a>00776 <span class="comment">     * parents, this order is necessary for e.g. computing bounding boxes */</span>
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keywordflow">while</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>) {
<a name="l00779"></a>00779         <span class="comment">/* pop node */</span>
<a name="l00780"></a>00780         iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>--;
<a name="l00781"></a>00781         node= iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>].<a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">node</a>;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <span class="comment">/* on a mesh with no faces this can happen</span>
<a name="l00784"></a>00784 <span class="comment">         * can remove this check if we know meshes have at least 1 face */</span>
<a name="l00785"></a>00785         <span class="keywordflow">if</span> (node==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00786"></a>00786             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         revisiting= iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>].<a class="code" href="../../d6/de8/structPBVHStack.html#a763d6f0a1a35c095ea73357faaff5001">revisiting</a>;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         <span class="comment">/* revisiting node already checked */</span>
<a name="l00791"></a>00791         <span class="keywordflow">if</span> (revisiting)
<a name="l00792"></a>00792             <span class="keywordflow">return</span> node;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a> &amp;&amp; !iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a>(node, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a14f278c0f54d07226afe7c49fcdb5ea5">search_data</a>))
<a name="l00795"></a>00795             <span class="keywordflow">continue</span>; <span class="comment">/* don&#39;t traverse, outside of search zone */</span>
<a name="l00796"></a>00796 
<a name="l00797"></a>00797         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00798"></a>00798             <span class="comment">/* immediately hit leaf node */</span>
<a name="l00799"></a>00799             <span class="keywordflow">return</span> node;
<a name="l00800"></a>00800         }
<a name="l00801"></a>00801         <span class="keywordflow">else</span> {
<a name="l00802"></a>00802             <span class="comment">/* come back later when children are done */</span>
<a name="l00803"></a>00803             <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(iter, node, 1);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805             <span class="comment">/* push two child nodes on the stack */</span>
<a name="l00806"></a>00806             <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(iter, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>+node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>+1, 0);
<a name="l00807"></a>00807             <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(iter, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>+node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>, 0);
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae5413dcf59a22720d0da2fef0f5ea1d9">00814</a> <span class="keyword">static</span> <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../dc/d0f/pbvh_8c.html#ae5413dcf59a22720d0da2fef0f5ea1d9">pbvh_iter_next_occluded</a>(<a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> *iter)
<a name="l00815"></a>00815 {
<a name="l00816"></a>00816     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="keywordflow">while</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>) {
<a name="l00819"></a>00819         <span class="comment">/* pop node */</span>
<a name="l00820"></a>00820         iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>--;
<a name="l00821"></a>00821         node= iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#accb033a27396aed06daaf5a1b10e7a56">stack</a>[iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#aef30622c770feb1c0ae82457d76b99c1">stacksize</a>].<a class="code" href="../../d6/de8/structPBVHStack.html#a9f114ac1b9e341e6bc921091e107328b">node</a>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <span class="comment">/* on a mesh with no faces this can happen</span>
<a name="l00824"></a>00824 <span class="comment">         * can remove this check if we know meshes have at least 1 face */</span>
<a name="l00825"></a>00825         <span class="keywordflow">if</span> (node==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827         <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a> &amp;&amp; !iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a3677db60bb710acb50ebe0a8e1504dd7">scb</a>(node, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a14f278c0f54d07226afe7c49fcdb5ea5">search_data</a>)) <span class="keywordflow">continue</span>; <span class="comment">/* don&#39;t traverse, outside of search zone */</span>
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00830"></a>00830             <span class="comment">/* immediately hit leaf node */</span>
<a name="l00831"></a>00831             <span class="keywordflow">return</span> node;
<a name="l00832"></a>00832         }
<a name="l00833"></a>00833         <span class="keywordflow">else</span> {
<a name="l00834"></a>00834             <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(iter, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>+node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>+1, 0);
<a name="l00835"></a>00835             <a class="code" href="../../dc/d0f/pbvh_8c.html#a28d010f0ef2251d048e078ec93d88ec3">pbvh_stack_push</a>(iter, iter-&gt;<a class="code" href="../../da/d98/structPBVHIter.html#a38af45c8cce6ee0d526182a779d71dbe">bvh</a>-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>+node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>, 0);
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837     }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a1aba2d549a9de566242a722d8e77f738">00842</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aee76af834981b5477c0575b177dddc99">BLI_pbvh_search_gather</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh,
<a name="l00843"></a>00843     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aabc55254f1a9d27ea9d649dae782412a">BLI_pbvh_SearchCallback</a> scb, <span class="keywordtype">void</span> *search_data,
<a name="l00844"></a>00844     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> ***r_array, <span class="keywordtype">int</span> *r_tot)
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846     <a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> iter;
<a name="l00847"></a>00847     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **<a class="code" href="../../d2/d41/classarray.html">array</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, **newarray, *node;
<a name="l00848"></a>00848     <span class="keywordtype">int</span> tot= 0, space= 0;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(&amp;iter, bvh, scb, search_data);
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">while</span> ((node=<a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">pbvh_iter_next</a>(&amp;iter))) {
<a name="l00853"></a>00853         <span class="keywordflow">if</span> (node-&gt;flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00854"></a>00854             <span class="keywordflow">if</span> (tot == space) {
<a name="l00855"></a>00855                 <span class="comment">/* resize array if needed */</span>
<a name="l00856"></a>00856                 space= (tot == 0)? 32: space*2;
<a name="l00857"></a>00857                 newarray= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>)*space, <span class="stringliteral">&quot;PBVHNodeSearch&quot;</span>);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859                 <span class="keywordflow">if</span> (array) {
<a name="l00860"></a>00860                     memcpy(newarray, array, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>)*tot);
<a name="l00861"></a>00861                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array);
<a name="l00862"></a>00862                 }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864                 array= newarray;
<a name="l00865"></a>00865             }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867             array[tot]= node;
<a name="l00868"></a>00868             tot++;
<a name="l00869"></a>00869         }
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(&amp;iter);
<a name="l00873"></a>00873 
<a name="l00874"></a>00874     <span class="keywordflow">if</span> (tot == 0 &amp;&amp; array) {
<a name="l00875"></a>00875         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array);
<a name="l00876"></a>00876         array= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00877"></a>00877     }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     *r_array= array;
<a name="l00880"></a>00880     *r_tot= tot;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a8494aff65bc27eed5646ccea4f161be8">00883</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a8494aff65bc27eed5646ccea4f161be8">BLI_pbvh_search_callback</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh,
<a name="l00884"></a>00884     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aabc55254f1a9d27ea9d649dae782412a">BLI_pbvh_SearchCallback</a> scb, <span class="keywordtype">void</span> *search_data,
<a name="l00885"></a>00885     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a183a6b2410522dbb40bbfc1f58d37577">BLI_pbvh_HitCallback</a> hcb, <span class="keywordtype">void</span> *hit_data)
<a name="l00886"></a>00886 {
<a name="l00887"></a>00887     <a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> iter;
<a name="l00888"></a>00888     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890     <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(&amp;iter, bvh, scb, search_data);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="keywordflow">while</span> ((node=<a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">pbvh_iter_next</a>(&amp;iter)))
<a name="l00893"></a>00893         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>)
<a name="l00894"></a>00894             hcb(node, hit_data);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(&amp;iter);
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 
<a name="l00899"></a><a class="code" href="../../df/def/structnode__tree.html">00899</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/def/structnode__tree.html">node_tree</a> {
<a name="l00900"></a><a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">00900</a>     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>* <a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">data</a>;
<a name="l00901"></a>00901 
<a name="l00902"></a><a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">00902</a>     <span class="keyword">struct </span><a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* <a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>;
<a name="l00903"></a><a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">00903</a>     <span class="keyword">struct </span><a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* <a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>;
<a name="l00904"></a>00904 } <a class="code" href="../../dc/d0f/pbvh_8c.html#a5b333e2added530ae19814934e45dcbd">node_tree</a>;
<a name="l00905"></a>00905 
<a name="l00906"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a13cff6f0434a555c5c00d1f8087c606d">00906</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a13cff6f0434a555c5c00d1f8087c606d">node_tree_insert</a>(<a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* tree, <a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* new_node)
<a name="l00907"></a>00907 {
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (new_node-&gt;<a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">data</a>-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">tmin</a> &lt; tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">data</a>-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">tmin</a>) {
<a name="l00909"></a>00909         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>) {
<a name="l00910"></a>00910             <a class="code" href="../../dc/d0f/pbvh_8c.html#a13cff6f0434a555c5c00d1f8087c606d">node_tree_insert</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>, new_node);
<a name="l00911"></a>00911         }
<a name="l00912"></a>00912         <span class="keywordflow">else</span> {
<a name="l00913"></a>00913             tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a> = new_node;
<a name="l00914"></a>00914         }
<a name="l00915"></a>00915     }
<a name="l00916"></a>00916     <span class="keywordflow">else</span> {
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>) {
<a name="l00918"></a>00918             <a class="code" href="../../dc/d0f/pbvh_8c.html#a13cff6f0434a555c5c00d1f8087c606d">node_tree_insert</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>, new_node);
<a name="l00919"></a>00919         }
<a name="l00920"></a>00920         <span class="keywordflow">else</span> {
<a name="l00921"></a>00921             tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a> = new_node;
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00926"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ac76170196a93324a14b7f7fc92f2af9f">00926</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ac76170196a93324a14b7f7fc92f2af9f">traverse_tree</a>(<a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* tree, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ab96ea8de128a2126619e571fbfa97cdb">BLI_pbvh_HitOccludedCallback</a> hcb, <span class="keywordtype">void</span>* hit_data, <span class="keywordtype">float</span>* tmin)
<a name="l00927"></a>00927 {
<a name="l00928"></a>00928     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>) <a class="code" href="../../dc/d0f/pbvh_8c.html#ac76170196a93324a14b7f7fc92f2af9f">traverse_tree</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>, hcb, hit_data, tmin);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     hcb(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">data</a>, hit_data, tmin);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>) <a class="code" href="../../dc/d0f/pbvh_8c.html#ac76170196a93324a14b7f7fc92f2af9f">traverse_tree</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>, hcb, hit_data, tmin);
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#af517f8d26cece6af8120609fb27a858a">00935</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#af517f8d26cece6af8120609fb27a858a">free_tree</a>(<a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* tree)
<a name="l00936"></a>00936 {
<a name="l00937"></a>00937     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>) {
<a name="l00938"></a>00938         <a class="code" href="../../dc/d0f/pbvh_8c.html#af517f8d26cece6af8120609fb27a858a">free_tree</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>);
<a name="l00939"></a>00939         tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a> = 0;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>) {
<a name="l00943"></a>00943         <a class="code" href="../../dc/d0f/pbvh_8c.html#af517f8d26cece6af8120609fb27a858a">free_tree</a>(tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a>);
<a name="l00944"></a>00944         tree-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a> = 0;
<a name="l00945"></a>00945     }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     free(tree);
<a name="l00948"></a>00948 }
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#af5eecb731037cfd40434073912006e9d">00950</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af5eecb731037cfd40434073912006e9d">BLI_pbvh_node_get_tmin</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>* node)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952     <span class="keywordflow">return</span> node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">tmin</a>;
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a85ddd557039d9738bc7b609a28e1a06f">00955</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a85ddd557039d9738bc7b609a28e1a06f">BLI_pbvh_search_callback_occluded</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh,
<a name="l00956"></a>00956     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aabc55254f1a9d27ea9d649dae782412a">BLI_pbvh_SearchCallback</a> scb, <span class="keywordtype">void</span> *search_data,
<a name="l00957"></a>00957     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ab96ea8de128a2126619e571fbfa97cdb">BLI_pbvh_HitOccludedCallback</a> hcb, <span class="keywordtype">void</span> *hit_data)
<a name="l00958"></a>00958 {
<a name="l00959"></a>00959     <a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> iter;
<a name="l00960"></a>00960     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l00961"></a>00961     <a class="code" href="../../df/def/structnode__tree.html">node_tree</a> *tree = 0;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(&amp;iter, bvh, scb, search_data);
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <span class="keywordflow">while</span> ((node=<a class="code" href="../../dc/d0f/pbvh_8c.html#ae5413dcf59a22720d0da2fef0f5ea1d9">pbvh_iter_next_occluded</a>(&amp;iter))) {
<a name="l00966"></a>00966         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l00967"></a>00967             <a class="code" href="../../df/def/structnode__tree.html">node_tree</a>* new_node = malloc(<span class="keyword">sizeof</span>(<a class="code" href="../../df/def/structnode__tree.html">node_tree</a>));
<a name="l00968"></a>00968 
<a name="l00969"></a>00969             new_node-&gt;<a class="code" href="../../df/def/structnode__tree.html#a416d9f698adde41043f428da00bfd26e">data</a> = node;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971             new_node-&gt;<a class="code" href="../../df/def/structnode__tree.html#a24fb7528c0dac861fdbccd44a47772cb">left</a>  = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00972"></a>00972             new_node-&gt;<a class="code" href="../../df/def/structnode__tree.html#aaa1c5d1e8f6902af66ac2b67509bc098">right</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974             <span class="keywordflow">if</span> (tree) {
<a name="l00975"></a>00975                 <a class="code" href="../../dc/d0f/pbvh_8c.html#a13cff6f0434a555c5c00d1f8087c606d">node_tree_insert</a>(tree, new_node);
<a name="l00976"></a>00976             }
<a name="l00977"></a>00977             <span class="keywordflow">else</span> {
<a name="l00978"></a>00978                 tree = new_node;
<a name="l00979"></a>00979             }
<a name="l00980"></a>00980         }
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(&amp;iter);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <span class="keywordflow">if</span> (tree) {
<a name="l00986"></a>00986         <span class="keywordtype">float</span> tmin = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00987"></a>00987         <a class="code" href="../../dc/d0f/pbvh_8c.html#ac76170196a93324a14b7f7fc92f2af9f">traverse_tree</a>(tree, hcb, hit_data, &amp;tmin);
<a name="l00988"></a>00988         <a class="code" href="../../dc/d0f/pbvh_8c.html#af517f8d26cece6af8120609fb27a858a">free_tree</a>(tree);
<a name="l00989"></a>00989     }
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a7dfd1e72fcd0c7e1966016adf04715a6">00992</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a7dfd1e72fcd0c7e1966016adf04715a6">update_search_cb</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">void</span> *data_v)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <span class="keywordtype">int</span> flag= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(data_v);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>)
<a name="l00997"></a>00997         <span class="keywordflow">return</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; flag);
<a name="l00998"></a>00998     
<a name="l00999"></a>00999     <span class="keywordflow">return</span> 1;
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a8bc757bcc56f3eb8a2d69f2766257cf4">01002</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a8bc757bcc56f3eb8a2d69f2766257cf4">pbvh_update_normals</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>,
<a name="l01003"></a>01003     <span class="keywordtype">int</span> totnode, <span class="keywordtype">float</span> (*face_nors)[3])
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     float (*vnor)[3];
<a name="l01006"></a>01006     <span class="keywordtype">int</span> n;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a> != <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>)
<a name="l01009"></a>01009         <span class="keywordflow">return</span>;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     <span class="comment">/* could be per node to save some memory, but also means</span>
<a name="l01012"></a>01012 <span class="comment">     * we have to store for each vertex which node it is in */</span>
<a name="l01013"></a>01013     vnor= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">totvert</a>, <span class="stringliteral">&quot;bvh temp vnors&quot;</span>);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="comment">/* subtle assumptions:</span>
<a name="l01016"></a>01016 <span class="comment">     * - We know that for all edited vertices, the nodes with faces</span>
<a name="l01017"></a>01017 <span class="comment">     *   adjacent to these vertices have been marked with PBVH_UpdateNormals.</span>
<a name="l01018"></a>01018 <span class="comment">     *   This is true because if the vertex is inside the brush radius, the</span>
<a name="l01019"></a>01019 <span class="comment">     *   bounding box of it&#39;s adjacent faces will be as well.</span>
<a name="l01020"></a>01020 <span class="comment">     * - However this is only true for the vertices that have actually been</span>
<a name="l01021"></a>01021 <span class="comment">     *   edited, not for all vertices in the nodes marked for update, so we</span>
<a name="l01022"></a>01022 <span class="comment">     *   can only update vertices marked with ME_VERT_PBVH_UPDATE.</span>
<a name="l01023"></a>01023 <span class="comment">     */</span>
<a name="l01024"></a>01024 
<a name="l01025"></a>01025 <span class="preprocessor">    #pragma omp parallel for private(n) schedule(static)</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (n = 0; n &lt; totnode; n++) {
<a name="l01027"></a>01027         <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node= nodes[n];
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="keywordflow">if</span> ((node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>)) {
<a name="l01030"></a>01030             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, totface, *faces;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032             faces= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>;
<a name="l01033"></a>01033             totface= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035             <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01036"></a>01036                 <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a> + faces[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01037"></a>01037                 <span class="keywordtype">float</span> fn[3];
<a name="l01038"></a>01038                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *fv = &amp;f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l01039"></a>01039                 <span class="keywordtype">int</span> sides= (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)? 4: 3;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                 <span class="keywordflow">if</span> (f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01042"></a>01042                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>(fn, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,
<a name="l01043"></a>01043                                    bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01044"></a>01044                 <span class="keywordflow">else</span>
<a name="l01045"></a>01045                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(fn, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,
<a name="l01046"></a>01046                                   bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01047"></a>01047 
<a name="l01048"></a>01048                 <span class="keywordflow">for</span> (j = 0; j &lt; sides; ++j) {
<a name="l01049"></a>01049                     <span class="keywordtype">int</span> v= fv[j];
<a name="l01050"></a>01050 
<a name="l01051"></a>01051                     <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[v].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>) {
<a name="l01052"></a>01052                         <span class="comment">/* this seems like it could be very slow but profile</span>
<a name="l01053"></a>01053 <span class="comment">                         * does not show this, so just leave it for now? */</span>
<a name="l01054"></a>01054 <span class="preprocessor">                        #pragma omp atomic</span>
<a name="l01055"></a>01055 <span class="preprocessor"></span>                        vnor[v][0] += fn[0];
<a name="l01056"></a>01056 <span class="preprocessor">                        #pragma omp atomic</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>                        vnor[v][1] += fn[1];
<a name="l01058"></a>01058 <span class="preprocessor">                        #pragma omp atomic</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span>                        vnor[v][2] += fn[2];
<a name="l01060"></a>01060                     }
<a name="l01061"></a>01061                 }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063                 <span class="keywordflow">if</span> (face_nors)
<a name="l01064"></a>01064                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face_nors[faces[i]], fn);
<a name="l01065"></a>01065             }
<a name="l01066"></a>01066         }
<a name="l01067"></a>01067     }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 <span class="preprocessor">    #pragma omp parallel for private(n) schedule(static)</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (n = 0; n &lt; totnode; n++) {
<a name="l01071"></a>01071         <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node= nodes[n];
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>) {
<a name="l01074"></a>01074             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, *verts, totvert;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076             verts= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>;
<a name="l01077"></a>01077             totvert= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a>;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079             <span class="keywordflow">for</span> (i = 0; i &lt; totvert; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01080"></a>01080                 <span class="keyword">const</span> <span class="keywordtype">int</span> v = verts[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01081"></a>01081                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= &amp;bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>[v];
<a name="l01082"></a>01082 
<a name="l01083"></a>01083                 <span class="keywordflow">if</span> (mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>) {
<a name="l01084"></a>01084                     <span class="keywordtype">float</span> no[3];
<a name="l01085"></a>01085 
<a name="l01086"></a>01086                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(no, vnor[v]);
<a name="l01087"></a>01087                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(no);
<a name="l01088"></a>01088                     
<a name="l01089"></a>01089                     mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[0] = (short)(no[0]*32767.0f);
<a name="l01090"></a>01090                     mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[1] = (short)(no[1]*32767.0f);
<a name="l01091"></a>01091                     mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#aac14cce64a2131bbdee5ea8fc1d64909">no</a>[2] = (short)(no[2]*32767.0f);
<a name="l01092"></a>01092                     
<a name="l01093"></a>01093                     mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp;= ~<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>;
<a name="l01094"></a>01094                 }
<a name="l01095"></a>01095             }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>;
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vnor);
<a name="l01102"></a>01102 }
<a name="l01103"></a>01103 
<a name="l01104"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a1017f2f12106541268802d283d7a4ff2">01104</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a1017f2f12106541268802d283d7a4ff2">pbvh_update_BB_redraw</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **nodes,
<a name="l01105"></a>01105     <span class="keywordtype">int</span> totnode, <span class="keywordtype">int</span> flag)
<a name="l01106"></a>01106 {
<a name="l01107"></a>01107     <span class="keywordtype">int</span> n;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109     <span class="comment">/* update BB, redraw flag */</span>
<a name="l01110"></a>01110 <span class="preprocessor">    #pragma omp parallel for private(n) schedule(static)</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (n = 0; n &lt; totnode; n++) {
<a name="l01112"></a>01112         <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node= nodes[n];
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>) &amp;&amp; (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; PBVH_UpdateBB))
<a name="l01115"></a>01115             <span class="comment">/* don&#39;t clear flag yet, leave it for flushing later */</span>
<a name="l01116"></a>01116             <a class="code" href="../../dc/d0f/pbvh_8c.html#a6533895235e31118bf3eefbd481ddef3">update_node_vb</a>(bvh, node);
<a name="l01117"></a>01117 
<a name="l01118"></a>01118         <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>) &amp;&amp; (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; PBVH_UpdateOriginalBB))
<a name="l01119"></a>01119             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a>= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>) &amp;&amp; (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; PBVH_UpdateRedraw))
<a name="l01122"></a>01122             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~PBVH_UpdateRedraw;
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 }
<a name="l01125"></a>01125 
<a name="l01126"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#afb69cd5829a5f9d787cf676f3a61f311">01126</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#afb69cd5829a5f9d787cf676f3a61f311">pbvh_update_draw_buffers</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **nodes, <span class="keywordtype">int</span> totnode)
<a name="l01127"></a>01127 {
<a name="l01128"></a>01128     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l01129"></a>01129     <span class="keywordtype">int</span> n;
<a name="l01130"></a>01130 
<a name="l01131"></a>01131     <span class="comment">/* can&#39;t be done in parallel with OpenGL */</span>
<a name="l01132"></a>01132     <span class="keywordflow">for</span> (n = 0; n &lt; totnode; n++) {
<a name="l01133"></a>01133         node= nodes[n];
<a name="l01134"></a>01134 
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba2172b37581c3f6aba34feecbc8e0644c">PBVH_RebuildDrawBuffers</a>) {
<a name="l01136"></a>01136             <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a8f4c15f16c06906aedc61465e16a592d">GPU_free_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>);
<a name="l01137"></a>01137             <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>) {
<a name="l01138"></a>01138                 node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a> =
<a name="l01139"></a>01139                     <a class="code" href="../../d8/dca/GPU__buffers_8h.html#ac3358bca5ba9da67f01dbdb77bd92ab7">GPU_build_grid_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>,
<a name="l01140"></a>01140                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>);
<a name="l01141"></a>01141             }
<a name="l01142"></a>01142             <span class="keywordflow">else</span> {
<a name="l01143"></a>01143                 node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a> =
<a name="l01144"></a>01144                     <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a73c3ccfc7c48b2369aec6cff5b741b7b">GPU_build_mesh_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>,
<a name="l01145"></a>01145                            bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>,
<a name="l01146"></a>01146                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>,
<a name="l01147"></a>01147                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>);
<a name="l01148"></a>01148             }
<a name="l01149"></a>01149  
<a name="l01150"></a>01150             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba2172b37581c3f6aba34feecbc8e0644c">PBVH_RebuildDrawBuffers</a>;
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>) {
<a name="l01154"></a>01154             <span class="keywordflow">switch</span>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>) {
<a name="l01155"></a>01155             <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>:
<a name="l01156"></a>01156                 <a class="code" href="../../d8/dca/GPU__buffers_8h.html#ad412fbaf65d316178e8495dd6e82a461">GPU_update_grid_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>,
<a name="l01157"></a>01157                            bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>,
<a name="l01158"></a>01158                            bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a1ae02df4ce8fdc714ad887f2c3f282e1">grid_flag_mats</a>,
<a name="l01159"></a>01159                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>,
<a name="l01160"></a>01160                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>,
<a name="l01161"></a>01161                            bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>);
<a name="l01162"></a>01162                 <span class="keywordflow">break</span>;
<a name="l01163"></a>01163             <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>:
<a name="l01164"></a>01164                 <a class="code" href="../../d8/dca/GPU__buffers_8h.html#ad06d35922a8b671448faa0e660763d52">GPU_update_mesh_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>,
<a name="l01165"></a>01165                            bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>,
<a name="l01166"></a>01166                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>,
<a name="l01167"></a>01167                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> +
<a name="l01168"></a>01168                            node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a>);
<a name="l01169"></a>01169                 <span class="keywordflow">break</span>;
<a name="l01170"></a>01170             }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>;
<a name="l01173"></a>01173         }
<a name="l01174"></a>01174     }
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a86315c25b97f157b859f14007891f0fe">01177</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a86315c25b97f157b859f14007891f0fe">pbvh_flush_bb</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> flag)
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179     <span class="keywordtype">int</span> <a class="code" href="../../d7/d49/node__composite__tree_8c.html#a8568effaf95c1efd2e0482ed79dfac4f">update</a>= 0;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="comment">/* difficult to multithread well, we just do single threaded recursive */</span>
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>) {
<a name="l01183"></a>01183         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>) {
<a name="l01184"></a>01184             update |= (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>);
<a name="l01185"></a>01185             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~PBVH_UpdateBB;
<a name="l01186"></a>01186         }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>) {
<a name="l01189"></a>01189             update |= (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>);
<a name="l01190"></a>01190             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~PBVH_UpdateOriginalBB;
<a name="l01191"></a>01191         }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193         <span class="keywordflow">return</span> <a class="code" href="../../d7/d49/node__composite__tree_8c.html#a8568effaf95c1efd2e0482ed79dfac4f">update</a>;
<a name="l01194"></a>01194     }
<a name="l01195"></a>01195     <span class="keywordflow">else</span> {
<a name="l01196"></a>01196         update |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a86315c25b97f157b859f14007891f0fe">pbvh_flush_bb</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a>, flag);
<a name="l01197"></a>01197         update |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a86315c25b97f157b859f14007891f0fe">pbvh_flush_bb</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#abc5d3ae65f81d445f18e8fbb6ec3da05">children_offset</a> + 1, flag);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199         <span class="keywordflow">if</span> (update &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>)
<a name="l01200"></a>01200             <a class="code" href="../../dc/d0f/pbvh_8c.html#a6533895235e31118bf3eefbd481ddef3">update_node_vb</a>(bvh, node);
<a name="l01201"></a>01201         <span class="keywordflow">if</span> (update &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>)
<a name="l01202"></a>01202             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a>= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>;
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205     <span class="keywordflow">return</span> <a class="code" href="../../d7/d49/node__composite__tree_8c.html#a8568effaf95c1efd2e0482ed79dfac4f">update</a>;
<a name="l01206"></a>01206 }
<a name="l01207"></a>01207 
<a name="l01208"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ad376b383b403ab0e1d20d60b426eb4aa">01208</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a97135c648369b00b64bc04e7468a86f9">BLI_pbvh_update</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> flag, <span class="keywordtype">float</span> (*face_nors)[3])
<a name="l01209"></a>01209 {
<a name="l01210"></a>01210     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>;
<a name="l01211"></a>01211     <span class="keywordtype">int</span> totnode;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="keywordflow">if</span> (!bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>)
<a name="l01214"></a>01214         <span class="keywordflow">return</span>;
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aee76af834981b5477c0575b177dddc99">BLI_pbvh_search_gather</a>(bvh, <a class="code" href="../../dc/d0f/pbvh_8c.html#a7dfd1e72fcd0c7e1966016adf04715a6">update_search_cb</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(flag),
<a name="l01217"></a>01217         &amp;nodes, &amp;totnode);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>)
<a name="l01220"></a>01220         <a class="code" href="../../dc/d0f/pbvh_8c.html#a8bc757bcc56f3eb8a2d69f2766257cf4">pbvh_update_normals</a>(bvh, nodes, totnode, face_nors);
<a name="l01221"></a>01221 
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (flag &amp; (<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>))
<a name="l01223"></a>01223         <a class="code" href="../../dc/d0f/pbvh_8c.html#a1017f2f12106541268802d283d7a4ff2">pbvh_update_BB_redraw</a>(bvh, nodes, totnode, flag);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225     <span class="keywordflow">if</span> (flag &amp; (<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>))
<a name="l01226"></a>01226         <a class="code" href="../../dc/d0f/pbvh_8c.html#a86315c25b97f157b859f14007891f0fe">pbvh_flush_bb</a>(bvh, bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>, flag);
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="keywordflow">if</span> (nodes) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nodes);
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a07a4ddca8c5e52ffad4a081c1de19b1e">01231</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a07a4ddca8c5e52ffad4a081c1de19b1e">BLI_pbvh_redraw_BB</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">float</span> bb_min[3], <span class="keywordtype">float</span> bb_max[3])
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233     <a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> iter;
<a name="l01234"></a>01234     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l01235"></a>01235     <a class="code" href="../../d7/d1f/structBB.html">BB</a> bb;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <a class="code" href="../../dc/d0f/pbvh_8c.html#a2b6f6e68333c65fe22534a2e6b7d4dc4">BB_reset</a>(&amp;bb);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(&amp;iter, bvh, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241     <span class="keywordflow">while</span> ((node=<a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">pbvh_iter_next</a>(&amp;iter)))
<a name="l01242"></a>01242         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>)
<a name="l01243"></a>01243             <a class="code" href="../../dc/d0f/pbvh_8c.html#ace108ced0a7f1b2ccb3c88fdaa00cb29">BB_expand_with_bb</a>(&amp;bb, &amp;node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>);
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(&amp;iter);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_min, bb.<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>);
<a name="l01248"></a>01248     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_max, bb.<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>);
<a name="l01249"></a>01249 }
<a name="l01250"></a>01250 
<a name="l01251"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a9151a524bd860e19655e9140cff3511a">01251</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a9151a524bd860e19655e9140cff3511a">BLI_pbvh_get_grid_updates</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">int</span> <a class="code" href="../../d1/d79/btDbvtBroadphase_8cpp.html#a19b1dda96df6332570b535a0683d8076">clear</a>, <span class="keywordtype">void</span> ***gridfaces, <span class="keywordtype">int</span> *totface)
<a name="l01252"></a>01252 {
<a name="l01253"></a>01253     <a class="code" href="../../da/d98/structPBVHIter.html">PBVHIter</a> iter;
<a name="l01254"></a>01254     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node;
<a name="l01255"></a>01255     <a class="code" href="../../d2/d31/structGHashIterator.html">GHashIterator</a> *hiter;
<a name="l01256"></a>01256     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *map;
<a name="l01257"></a>01257     <span class="keywordtype">void</span> *face, **faces;
<a name="l01258"></a>01258     <span class="keywordtype">unsigned</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01259"></a>01259     <span class="keywordtype">int</span> tot;
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     map = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;pbvh_get_grid_updates gh&quot;</span>);
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     <a class="code" href="../../dc/d0f/pbvh_8c.html#aaf7e96b427446178b49377b27d241513">pbvh_iter_begin</a>(&amp;iter, bvh, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     <span class="keywordflow">while</span> ((node=<a class="code" href="../../dc/d0f/pbvh_8c.html#a2ada131443e5f9d27da140b698cf1730">pbvh_iter_next</a>(&amp;iter))) {
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>) {
<a name="l01267"></a>01267             <span class="keywordflow">for</span> (i = 0; i &lt; node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01268"></a>01268                 face= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa7468000625e79365e8515bd08a2cd62">gridfaces</a>[node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]];
<a name="l01269"></a>01269                 <span class="keywordflow">if</span> (!<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(map, face))
<a name="l01270"></a>01270                     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(map, face, face);
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273             <span class="keywordflow">if</span> (clear)
<a name="l01274"></a>01274                 node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>;
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <a class="code" href="../../dc/d0f/pbvh_8c.html#a0abadd1e3afa9845f22c3ca52a3645f3">pbvh_iter_end</a>(&amp;iter);
<a name="l01279"></a>01279     
<a name="l01280"></a>01280     tot= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2f636817c33fecf8de5e18f30fba0879">BLI_ghash_size</a>(map);
<a name="l01281"></a>01281     <span class="keywordflow">if</span> (tot == 0) {
<a name="l01282"></a>01282         *totface= 0;
<a name="l01283"></a>01283         *gridfaces= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01284"></a>01284         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(map, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01285"></a>01285         <span class="keywordflow">return</span>;
<a name="l01286"></a>01286     }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     faces= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)*tot, <span class="stringliteral">&quot;PBVH Grid Faces&quot;</span>);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <span class="keywordflow">for</span> (hiter = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aab164acbea58512dc40c74238f48e0c0">BLI_ghashIterator_new</a>(map), i = 0;
<a name="l01291"></a>01291         !<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a0eff6b7b74d72e06f7c125da5a46a5f1">BLI_ghashIterator_isDone</a>(hiter);
<a name="l01292"></a>01292         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2d3ebd2fe8ee454695c6387215e3e88a">BLI_ghashIterator_step</a>(hiter), ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01293"></a>01293         faces[i]= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a61c902d18de9cdd3785ef33e598d360f">BLI_ghashIterator_getKey</a>(hiter);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a3cc839e5e4e00419c6774832687e39c1">BLI_ghashIterator_free</a>(hiter);
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(map, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01298"></a>01298 
<a name="l01299"></a>01299     *totface= tot;
<a name="l01300"></a>01300     *gridfaces= faces;
<a name="l01301"></a>01301 }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 <span class="comment">/***************************** PBVH Access ***********************************/</span>
<a name="l01304"></a>01304 
<a name="l01305"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a27253330f181837e60fd9b75dd79f5ab">01305</a> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222">PBVHType</a> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a27253330f181837e60fd9b75dd79f5ab">BLI_pbvh_type</a>(<span class="keyword">const</span> <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh)
<a name="l01306"></a>01306 {
<a name="l01307"></a>01307     <span class="keywordflow">return</span> bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>;
<a name="l01308"></a>01308 }
<a name="l01309"></a>01309 
<a name="l01310"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#afced1366476704aa65a631bebfab6964">01310</a> <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4c413767d18c4c373bb5c17b068a473f">BLI_pbvh_grid_hidden</a>(<span class="keyword">const</span> <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh)
<a name="l01311"></a>01311 {
<a name="l01312"></a>01312     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a> == <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>);
<a name="l01313"></a>01313     <span class="keywordflow">return</span> bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>;
<a name="l01314"></a>01314 }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316 <span class="comment">/***************************** Node Access ***********************************/</span>
<a name="l01317"></a>01317 
<a name="l01318"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a695a0e333f03d1ba08b869a2302a977f">01318</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a695a0e333f03d1ba08b869a2302a977f">BLI_pbvh_node_mark_update</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node)
<a name="l01319"></a>01319 {
<a name="l01320"></a>01320     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a1acd780e00f79e15cdd1ad10a39f92d4">01323</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1acd780e00f79e15cdd1ad10a39f92d4">BLI_pbvh_node_mark_rebuild_draw</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node)
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba2172b37581c3f6aba34feecbc8e0644c">PBVH_RebuildDrawBuffers</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>;
<a name="l01326"></a>01326 }
<a name="l01327"></a>01327 
<a name="l01328"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#af9ca94c397460761dc568a1b43ad2ef6">01328</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af9ca94c397460761dc568a1b43ad2ef6">BLI_pbvh_node_fully_hidden_set</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> fully_hidden)
<a name="l01329"></a>01329 {
<a name="l01330"></a>01330     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebaba88764ba8e5a7f2fce0ce925606da32">PBVH_Leaf</a>);
<a name="l01331"></a>01331     
<a name="l01332"></a>01332     <span class="keywordflow">if</span> (fully_hidden)
<a name="l01333"></a>01333         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> |= <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba9c48225fdfe063a95b627c737deed8f6">PBVH_FullyHidden</a>;
<a name="l01334"></a>01334     <span class="keywordflow">else</span>
<a name="l01335"></a>01335         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp;= ~<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba9c48225fdfe063a95b627c737deed8f6">PBVH_FullyHidden</a>;
<a name="l01336"></a>01336 }
<a name="l01337"></a>01337 
<a name="l01338"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a7b8bb2b05d7576d059873053e0942687">01338</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ad78889c6986e72570348cc7463c574af">BLI_pbvh_node_get_verts</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> **vert_indices, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> **verts)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340     <span class="keywordflow">if</span> (vert_indices) *vert_indices= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a3c5f3d749dd2a054ed1adea8b3880338">vert_indices</a>;
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (verts) *verts= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>;
<a name="l01342"></a>01342 }
<a name="l01343"></a>01343 
<a name="l01344"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a4bfd1ef41ea772bd811beeaa7e649dfe">01344</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4bfd1ef41ea772bd811beeaa7e649dfe">BLI_pbvh_node_num_verts</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> *uniquevert, <span class="keywordtype">int</span> *totvert)
<a name="l01345"></a>01345 {
<a name="l01346"></a>01346     <span class="keywordtype">int</span> tot;
<a name="l01347"></a>01347     
<a name="l01348"></a>01348     <span class="keywordflow">switch</span>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>) {
<a name="l01349"></a>01349     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>:
<a name="l01350"></a>01350         tot= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>*bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>*bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>;
<a name="l01351"></a>01351         <span class="keywordflow">if</span> (totvert) *totvert= tot;
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (uniquevert) *uniquevert= tot;
<a name="l01353"></a>01353         <span class="keywordflow">break</span>;
<a name="l01354"></a>01354     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>:
<a name="l01355"></a>01355         <span class="keywordflow">if</span> (totvert) *totvert= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a> + node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a57b8320232914fb7429b11e0302fdec7">face_verts</a>;
<a name="l01356"></a>01356         <span class="keywordflow">if</span> (uniquevert) *uniquevert= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a>;
<a name="l01357"></a>01357         <span class="keywordflow">break</span>;
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359 }
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#abfc2a13af5772501bf371f5c7061cbf6">01361</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae2bfd81c94c6139d50c125f417801956">BLI_pbvh_node_get_grids</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">int</span> **grid_indices, <span class="keywordtype">int</span> *totgrid, <span class="keywordtype">int</span> *maxgrid, <span class="keywordtype">int</span> *gridsize, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> ***griddata, <a class="code" href="../../d9/d82/structDMGridAdjacency.html">DMGridAdjacency</a> **gridadj)
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363     <span class="keywordflow">switch</span>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>) {
<a name="l01364"></a>01364     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>:
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (grid_indices) *grid_indices= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>;
<a name="l01366"></a>01366         <span class="keywordflow">if</span> (totgrid) *totgrid= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l01367"></a>01367         <span class="keywordflow">if</span> (maxgrid) *maxgrid= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa4cc8af4c7aadf168c751c192002d5e0">totgrid</a>;
<a name="l01368"></a>01368         <span class="keywordflow">if</span> (gridsize) *gridsize= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>;
<a name="l01369"></a>01369         <span class="keywordflow">if</span> (griddata) *griddata= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>;
<a name="l01370"></a>01370         <span class="keywordflow">if</span> (gridadj) *gridadj= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab96bc933cd88f3110409bc6b77792c20">gridadj</a>;
<a name="l01371"></a>01371         <span class="keywordflow">break</span>;
<a name="l01372"></a>01372     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>:
<a name="l01373"></a>01373         <span class="keywordflow">if</span> (grid_indices) *grid_indices= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01374"></a>01374         <span class="keywordflow">if</span> (totgrid) *totgrid= 0;
<a name="l01375"></a>01375         <span class="keywordflow">if</span> (maxgrid) *maxgrid= 0;
<a name="l01376"></a>01376         <span class="keywordflow">if</span> (gridsize) *gridsize= 0;
<a name="l01377"></a>01377         <span class="keywordflow">if</span> (griddata) *griddata= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01378"></a>01378         <span class="keywordflow">if</span> (gridadj) *gridadj= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01379"></a>01379         <span class="keywordflow">break</span>;
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381 }
<a name="l01382"></a>01382 
<a name="l01383"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae198d6e0d2a9da4fdaaebf2383c1141c">01383</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae198d6e0d2a9da4fdaaebf2383c1141c">BLI_pbvh_node_get_BB</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">float</span> bb_min[3], <span class="keywordtype">float</span> bb_max[3])
<a name="l01384"></a>01384 {
<a name="l01385"></a>01385     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_min, node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>.<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>);
<a name="l01386"></a>01386     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_max, node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad587234dcc4007a6a63bd89f736d5e16">vb</a>.<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>);
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01389"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a844d7d0fda66c20b5cfab6c6bdc22fe7">01389</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a844d7d0fda66c20b5cfab6c6bdc22fe7">BLI_pbvh_node_get_original_BB</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">float</span> bb_min[3], <span class="keywordtype">float</span> bb_max[3])
<a name="l01390"></a>01390 {
<a name="l01391"></a>01391     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_min, node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a>.<a class="code" href="../../d7/d1f/structBB.html#a7a878695840b1d6dab3d898cbd30516a">bmin</a>);
<a name="l01392"></a>01392     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bb_max, node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a7818f6a1aea1ab5b5cf49b10d48453c1">orig_vb</a>.<a class="code" href="../../d7/d1f/structBB.html#a33d9c0581dc559ced5c45e4e32652f0e">bmax</a>);
<a name="l01393"></a>01393 }
<a name="l01394"></a>01394 
<a name="l01395"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#adaae673f79b788961608f78406c533c1">01395</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#adaae673f79b788961608f78406c533c1">BLI_pbvh_node_get_proxies</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>* node, <a class="code" href="../../d2/d16/structPBVHProxyNode.html">PBVHProxyNode</a>** proxies, <span class="keywordtype">int</span>* proxy_count)
<a name="l01396"></a>01396 {
<a name="l01397"></a>01397     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a> &gt; 0) {
<a name="l01398"></a>01398         <span class="keywordflow">if</span> (proxies) *proxies = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>;
<a name="l01399"></a>01399         <span class="keywordflow">if</span> (proxy_count) *proxy_count = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>;
<a name="l01400"></a>01400     }
<a name="l01401"></a>01401     <span class="keywordflow">else</span> {
<a name="l01402"></a>01402         <span class="keywordflow">if</span> (proxies) *proxies = 0;
<a name="l01403"></a>01403         <span class="keywordflow">if</span> (proxy_count) *proxy_count = 0;
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405 }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407 <span class="comment">/********************************* Raycast ***********************************/</span>
<a name="l01408"></a>01408 
<a name="l01409"></a><a class="code" href="../../dd/d97/structRaycastData.html">01409</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l01410"></a>01410     <span class="comment">/* Ray */</span>
<a name="l01411"></a><a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">01411</a>     <span class="keywordtype">float</span> start[3];
<a name="l01412"></a><a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">01412</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d13/namespaceTNT.html#a051812668d41cc65f9b8f0518e47b466">sign</a>[3];
<a name="l01413"></a><a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">01413</a>     <span class="keywordtype">float</span> inv_dir[3];
<a name="l01414"></a><a class="code" href="../../dd/d97/structRaycastData.html#a1e7bf35f219f021856c116ad7042e4f6">01414</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d97/structRaycastData.html#a1e7bf35f219f021856c116ad7042e4f6">original</a>;
<a name="l01415"></a>01415 } <a class="code" href="../../dd/d97/structRaycastData.html">RaycastData</a>;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417 <span class="comment">/* Adapted from here: http://www.gamedev.net/community/forums/topic.asp?topic_id=459973 */</span>
<a name="l01418"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a4c71eb06d8b57a29885b1fdf371199a1">01418</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a4c71eb06d8b57a29885b1fdf371199a1">ray_aabb_intersect</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">void</span> *data_v)
<a name="l01419"></a>01419 {
<a name="l01420"></a>01420     <a class="code" href="../../dd/d97/structRaycastData.html">RaycastData</a> *ray = data_v;
<a name="l01421"></a>01421     <span class="keywordtype">float</span> bbox[2][3];
<a name="l01422"></a>01422     <span class="keywordtype">float</span> tmin, tmax, tymin, tymax, tzmin, tzmax;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a1e7bf35f219f021856c116ad7042e4f6">original</a>)
<a name="l01425"></a>01425         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a844d7d0fda66c20b5cfab6c6bdc22fe7">BLI_pbvh_node_get_original_BB</a>(node, bbox[0], bbox[1]);
<a name="l01426"></a>01426     <span class="keywordflow">else</span>
<a name="l01427"></a>01427         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae198d6e0d2a9da4fdaaebf2383c1141c">BLI_pbvh_node_get_BB</a>(node, bbox[0], bbox[1]);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429     tmin = (bbox[ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[0]][0] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[0]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[0];
<a name="l01430"></a>01430     tmax = (bbox[1-ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[0]][0] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[0]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[0];
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     tymin = (bbox[ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[1]][1] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[1]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[1];
<a name="l01433"></a>01433     tymax = (bbox[1-ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[1]][1] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[1]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[1];
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     <span class="keywordflow">if</span> ((tmin &gt; tymax) || (tymin &gt; tmax))
<a name="l01436"></a>01436         <span class="keywordflow">return</span> 0;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     <span class="keywordflow">if</span> (tymin &gt; tmin)
<a name="l01439"></a>01439         tmin = tymin;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441     <span class="keywordflow">if</span> (tymax &lt; tmax)
<a name="l01442"></a>01442         tmax = tymax;
<a name="l01443"></a>01443 
<a name="l01444"></a>01444     tzmin = (bbox[ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[2]][2] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[2]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[2];
<a name="l01445"></a>01445     tzmax = (bbox[1-ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[2]][2] - ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>[2]) * ray-&gt;<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[2];
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     <span class="keywordflow">if</span> ((tmin &gt; tzmax) || (tzmin &gt; tmax))
<a name="l01448"></a>01448         <span class="keywordflow">return</span> 0;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     <span class="keywordflow">if</span> (tzmin &gt; tmin)
<a name="l01451"></a>01451         tmin = tzmin;
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="comment">// XXX jwilkins: tmax does not need to be updated since we don&#39;t use it</span>
<a name="l01454"></a>01454     <span class="comment">// keeping this here for future reference</span>
<a name="l01455"></a>01455     <span class="comment">//if (tzmax &lt; tmax) tmax = tzmax; </span>
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a513bdf2da1cf58a3dafc1d433fc2f116">tmin</a> = tmin;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="keywordflow">return</span> 1;
<a name="l01460"></a>01460 }
<a name="l01461"></a>01461 
<a name="l01462"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#aed4acf9f0e3320fccbaa56d109948929">01462</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aed4acf9f0e3320fccbaa56d109948929">BLI_pbvh_raycast</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ab96ea8de128a2126619e571fbfa97cdb">BLI_pbvh_HitOccludedCallback</a> cb, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>,
<a name="l01463"></a>01463               <span class="keywordtype">float</span> ray_start[3], <span class="keywordtype">float</span> ray_normal[3], <span class="keywordtype">int</span> original)
<a name="l01464"></a>01464 {
<a name="l01465"></a>01465     <a class="code" href="../../dd/d97/structRaycastData.html">RaycastData</a> rcd;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a246bc3bfaac1a5c05491ed11751450df">start</a>, ray_start);
<a name="l01468"></a>01468     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[0] = 1.0f / ray_normal[0];
<a name="l01469"></a>01469     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[1] = 1.0f / ray_normal[1];
<a name="l01470"></a>01470     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[2] = 1.0f / ray_normal[2];
<a name="l01471"></a>01471     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[0] = rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[0] &lt; 0;
<a name="l01472"></a>01472     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[1] = rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[1] &lt; 0;
<a name="l01473"></a>01473     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#ac6e28190773f19146656f6014307626f">sign</a>[2] = rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a5b46edeb2447c99e7a6826cad754de37">inv_dir</a>[2] &lt; 0;
<a name="l01474"></a>01474     rcd.<a class="code" href="../../dd/d97/structRaycastData.html#a1e7bf35f219f021856c116ad7042e4f6">original</a> = original;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     <a class="code" href="../../dc/d0f/pbvh_8c.html#a85ddd557039d9738bc7b609a28e1a06f">BLI_pbvh_search_callback_occluded</a>(bvh, <a class="code" href="../../dc/d0f/pbvh_8c.html#a4c71eb06d8b57a29885b1fdf371199a1">ray_aabb_intersect</a>, &amp;rcd, cb, data);
<a name="l01477"></a>01477 }
<a name="l01478"></a>01478 
<a name="l01479"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">01479</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">ray_face_intersection</a>(<span class="keywordtype">float</span> ray_start[3], <span class="keywordtype">float</span> ray_normal[3],
<a name="l01480"></a>01480                  <span class="keywordtype">float</span> *t0, <span class="keywordtype">float</span> *t1, <span class="keywordtype">float</span> *t2, <span class="keywordtype">float</span> *t3,
<a name="l01481"></a>01481                  <span class="keywordtype">float</span> *fdist)
<a name="l01482"></a>01482 {
<a name="l01483"></a>01483     <span class="keywordtype">float</span> dist;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ab4fddf2266650b5bde24ef1570e61cab">isect_ray_tri_epsilon_v3</a>(ray_start, ray_normal, t0, t1, t2, &amp;dist, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.1f) &amp;&amp; dist &lt; *fdist) ||
<a name="l01486"></a>01486        (t3 &amp;&amp; <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ab4fddf2266650b5bde24ef1570e61cab">isect_ray_tri_epsilon_v3</a>(ray_start, ray_normal, t0, t2, t3, &amp;dist, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.1f) &amp;&amp; dist &lt; *fdist))
<a name="l01487"></a>01487     {
<a name="l01488"></a>01488         *fdist = dist;
<a name="l01489"></a>01489         <span class="keywordflow">return</span> 1;
<a name="l01490"></a>01490     }
<a name="l01491"></a>01491     <span class="keywordflow">else</span> {
<a name="l01492"></a>01492         <span class="keywordflow">return</span> 0;
<a name="l01493"></a>01493     }
<a name="l01494"></a>01494 }
<a name="l01495"></a>01495 
<a name="l01496"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae6f7b4c2f8d67fb2daf1630ffecbcdb5">01496</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae6f7b4c2f8d67fb2daf1630ffecbcdb5">BLI_pbvh_node_raycast</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">float</span> (*origco)[3],
<a name="l01497"></a>01497     <span class="keywordtype">float</span> ray_start[3], <span class="keywordtype">float</span> ray_normal[3], <span class="keywordtype">float</span> *dist)
<a name="l01498"></a>01498 {
<a name="l01499"></a>01499     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *vert;
<a name="l01500"></a>01500     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> gh;
<a name="l01501"></a>01501     <span class="keywordtype">int</span> *faces, totface, gridsize, totgrid;
<a name="l01502"></a>01502     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, x, y, hit= 0;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba9c48225fdfe063a95b627c737deed8f6">PBVH_FullyHidden</a>)
<a name="l01505"></a>01505         <span class="keywordflow">return</span> 0;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     <span class="keywordflow">switch</span>(bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a05419fedc6d51d9559179dd83d3340d3">type</a>) {
<a name="l01508"></a>01508     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a5f869f57cd8217cfed344283c081a92d">PBVH_FACES</a>:
<a name="l01509"></a>01509         vert = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>;
<a name="l01510"></a>01510         faces= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>;
<a name="l01511"></a>01511         totface= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         <span class="keywordflow">for</span> (i = 0; i &lt; totface; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01514"></a>01514             <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *f = bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a> + faces[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01515"></a>01515             <span class="keywordtype">int</span> *face_verts = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad179aeb41b25b1c87c365b39fe8a0347">face_vert_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01516"></a>01516 
<a name="l01517"></a>01517             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/BKE__paint_8h.html#ab5ca3e527d7cd670e880369d28bd96e7">paint_is_face_hidden</a>(f, vert))
<a name="l01518"></a>01518                 <span class="keywordflow">continue</span>;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520             <span class="keywordflow">if</span> (origco) {
<a name="l01521"></a>01521                 <span class="comment">/* intersect with backuped original coordinates */</span>
<a name="l01522"></a>01522                 hit |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">ray_face_intersection</a>(ray_start, ray_normal,
<a name="l01523"></a>01523                              origco[face_verts[0]],
<a name="l01524"></a>01524                              origco[face_verts[1]],
<a name="l01525"></a>01525                              origco[face_verts[2]],
<a name="l01526"></a>01526                              f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>? origco[face_verts[3]]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l01527"></a>01527                              dist);
<a name="l01528"></a>01528             }
<a name="l01529"></a>01529             <span class="keywordflow">else</span> {
<a name="l01530"></a>01530                 <span class="comment">/* intersect with current coordinates */</span>
<a name="l01531"></a>01531                 hit |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">ray_face_intersection</a>(ray_start, ray_normal,
<a name="l01532"></a>01532                              vert[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,
<a name="l01533"></a>01533                              vert[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,
<a name="l01534"></a>01534                              vert[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>,
<a name="l01535"></a>01535                              f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? vert[f-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l01536"></a>01536                              dist);
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538         }
<a name="l01539"></a>01539         <span class="keywordflow">break</span>;
<a name="l01540"></a>01540     <span class="keywordflow">case</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa46d6b19996f85360f02c6dfac5c8222a2113bccd891bc1cb00500fa6a6f9964c">PBVH_GRIDS</a>:
<a name="l01541"></a>01541         totgrid= node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>;
<a name="l01542"></a>01542         gridsize= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>;
<a name="l01543"></a>01543 
<a name="l01544"></a>01544         <span class="keywordflow">for</span> (i = 0; i &lt; totgrid; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l01545"></a>01545             <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> *grid= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>[node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]];
<a name="l01546"></a>01546             <span class="keywordflow">if</span> (!grid)
<a name="l01547"></a>01547                 <span class="keywordflow">continue</span>;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549             gh= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>[node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a5270b8182d06ae303ee01e08bb8c2cc8">prim_indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]];
<a name="l01550"></a>01550 
<a name="l01551"></a>01551             <span class="keywordflow">for</span> (y = 0; y &lt; gridsize-1; ++y) {
<a name="l01552"></a>01552                 <span class="keywordflow">for</span> (x = 0; x &lt; gridsize-1; ++x) {
<a name="l01553"></a>01553                     <span class="comment">/* check if grid face is hidden */</span>
<a name="l01554"></a>01554                     <span class="keywordflow">if</span> (gh) {
<a name="l01555"></a>01555                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/BKE__paint_8h.html#a90692ba154e29bcac7d51843b5c3cd8d">paint_is_grid_face_hidden</a>(gh, gridsize, x, y))
<a name="l01556"></a>01556                             <span class="keywordflow">continue</span>;
<a name="l01557"></a>01557                     }
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                     <span class="keywordflow">if</span> (origco) {
<a name="l01560"></a>01560                         hit |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">ray_face_intersection</a>(ray_start, ray_normal,
<a name="l01561"></a>01561                                      origco[y*gridsize + x],
<a name="l01562"></a>01562                                      origco[y*gridsize + x+1],
<a name="l01563"></a>01563                                      origco[(y+1)*gridsize + x+1],
<a name="l01564"></a>01564                                      origco[(y+1)*gridsize + x],
<a name="l01565"></a>01565                                      dist);
<a name="l01566"></a>01566                     }
<a name="l01567"></a>01567                     <span class="keywordflow">else</span> {
<a name="l01568"></a>01568                         hit |= <a class="code" href="../../dc/d0f/pbvh_8c.html#a662474a3991c953023e0318eb629d89f">ray_face_intersection</a>(ray_start, ray_normal,
<a name="l01569"></a>01569                                      grid[y*gridsize + x].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>,
<a name="l01570"></a>01570                                      grid[y*gridsize + x+1].co,
<a name="l01571"></a>01571                                      grid[(y+1)*gridsize + x+1].co,
<a name="l01572"></a>01572                                      grid[(y+1)*gridsize + x].co,
<a name="l01573"></a>01573                                      dist);
<a name="l01574"></a>01574                     }
<a name="l01575"></a>01575                 }
<a name="l01576"></a>01576             }
<a name="l01577"></a>01577 
<a name="l01578"></a>01578             <span class="keywordflow">if</span> (origco)
<a name="l01579"></a>01579                 origco += gridsize*gridsize;
<a name="l01580"></a>01580         }
<a name="l01581"></a>01581         <span class="keywordflow">break</span>;
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583 
<a name="l01584"></a>01584     <span class="keywordflow">return</span> hit;
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="comment">//#include &lt;GL/glew.h&gt;</span>
<a name="l01588"></a>01588 
<a name="l01589"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a8356242b7ef88c25b8c37c4cfab875dd">01589</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae20d5b1273574c66df8f5125e27e05ee">BLI_pbvh_node_draw</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">void</span> *setMaterial)
<a name="l01590"></a>01590 {
<a name="l01591"></a>01591 <span class="preprocessor">#if 0</span>
<a name="l01592"></a>01592 <span class="preprocessor"></span>    <span class="comment">/* XXX: Just some quick code to show leaf nodes in different colors */</span>
<a name="l01593"></a>01593     <span class="keywordtype">float</span> col[3]; <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="keywordflow">if</span> (0) { <span class="comment">//is_partial) {</span>
<a name="l01596"></a>01596         col[0] = (rand() / (float)RAND_MAX); col[1] = col[2] = 0.6;
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598     <span class="keywordflow">else</span> {
<a name="l01599"></a>01599         srand((<span class="keywordtype">long</span> <span class="keywordtype">long</span>)node);
<a name="l01600"></a>01600         <span class="keywordflow">for</span> (i = 0; i &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01601"></a>01601             col[i] = (rand() / (<span class="keywordtype">float</span>)RAND_MAX) * 0.3 + 0.7;
<a name="l01602"></a>01602     }
<a name="l01603"></a>01603     glMaterialfv(GL_FRONT_AND_BACK, GL_DIFFUSE, col);
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     glColor3f(1, 0, 0);
<a name="l01606"></a>01606 <span class="preprocessor">#endif</span>
<a name="l01607"></a>01607 <span class="preprocessor"></span>
<a name="l01608"></a>01608     <span class="keywordflow">if</span> (!(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ae4126754834614024bf94494aa6fd20d">flag</a> &amp; <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba9c48225fdfe063a95b627c737deed8f6">PBVH_FullyHidden</a>))
<a name="l01609"></a>01609         <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a14370a33f3a8507cc4e219ce935d9d79">GPU_draw_buffers</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ad8ba2b8e50191aa3a4ce5bc15a10bab4">draw_buffers</a>, setMaterial);
<a name="l01610"></a>01610 }
<a name="l01611"></a>01611 
<a name="l01612"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13c">01612</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
<a name="l01613"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caa41fd25b4151496ea4a11764379ad1d1">01613</a>     <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caa41fd25b4151496ea4a11764379ad1d1">ISECT_INSIDE</a>,
<a name="l01614"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caf3401da29db7b1d5a30a9f7b60e51b52">01614</a>     <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caf3401da29db7b1d5a30a9f7b60e51b52">ISECT_OUTSIDE</a>,
<a name="l01615"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13ca709d66e589471a0c87d6ce9c5dfca25e">01615</a>     <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13ca709d66e589471a0c87d6ce9c5dfca25e">ISECT_INTERSECT</a>
<a name="l01616"></a>01616 } <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13c">PlaneAABBIsect</a>;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618 <span class="comment">/* Adapted from:</span>
<a name="l01619"></a>01619 <span class="comment"> * http://www.gamedev.net/community/forums/topic.asp?topic_id=512123</span>
<a name="l01620"></a>01620 <span class="comment"> * Returns true if the AABB is at least partially within the frustum</span>
<a name="l01621"></a>01621 <span class="comment"> * (ok, not a real frustum), false otherwise.</span>
<a name="l01622"></a>01622 <span class="comment"> */</span>
<a name="l01623"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ad0a46bea9e3164c82f9a199d780d31de">01623</a> <span class="keyword">static</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13c">PlaneAABBIsect</a> <a class="code" href="../../dc/d0f/pbvh_8c.html#ad0a46bea9e3164c82f9a199d780d31de">test_planes_aabb</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> bb_min[3],
<a name="l01624"></a>01624                                        <span class="keyword">const</span> <span class="keywordtype">float</span> bb_max[3],
<a name="l01625"></a>01625                                        <span class="keyword">const</span> <span class="keywordtype">float</span> (*planes)[4])
<a name="l01626"></a>01626 {
<a name="l01627"></a>01627     <span class="keywordtype">float</span> vmin[3], vmax[3];
<a name="l01628"></a>01628     <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13c">PlaneAABBIsect</a> ret = <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caa41fd25b4151496ea4a11764379ad1d1">ISECT_INSIDE</a>;
<a name="l01629"></a>01629     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, axis;
<a name="l01630"></a>01630     
<a name="l01631"></a>01631     <span class="keywordflow">for</span> (i = 0; i &lt; 4; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) { 
<a name="l01632"></a>01632         <span class="keywordflow">for</span> (axis = 0; axis &lt; 3; ++axis) {
<a name="l01633"></a>01633             <span class="keywordflow">if</span> (planes[i][axis] &gt; 0) { 
<a name="l01634"></a>01634                 vmin[axis] = bb_min[axis];
<a name="l01635"></a>01635                 vmax[axis] = bb_max[axis];
<a name="l01636"></a>01636             }
<a name="l01637"></a>01637             <span class="keywordflow">else</span> {
<a name="l01638"></a>01638                 vmin[axis] = bb_max[axis];
<a name="l01639"></a>01639                 vmax[axis] = bb_min[axis];
<a name="l01640"></a>01640             }
<a name="l01641"></a>01641         }
<a name="l01642"></a>01642         
<a name="l01643"></a>01643         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(planes[i], vmin) + planes[i][3] &gt; 0)
<a name="l01644"></a>01644             <span class="keywordflow">return</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caf3401da29db7b1d5a30a9f7b60e51b52">ISECT_OUTSIDE</a>;
<a name="l01645"></a>01645         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(planes[i], vmax) + planes[i][3] &gt;= 0)
<a name="l01646"></a>01646             ret = <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13ca709d66e589471a0c87d6ce9c5dfca25e">ISECT_INTERSECT</a>;
<a name="l01647"></a>01647     } 
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     <span class="keywordflow">return</span> ret;
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01652"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#afb86667b566736e049e3252a5eb13083">01652</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#afb86667b566736e049e3252a5eb13083">BLI_pbvh_node_planes_contain_AABB</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l01653"></a>01653 {
<a name="l01654"></a>01654     <span class="keywordtype">float</span> bb_min[3], bb_max[3];
<a name="l01655"></a>01655     
<a name="l01656"></a>01656     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae198d6e0d2a9da4fdaaebf2383c1141c">BLI_pbvh_node_get_BB</a>(node, bb_min, bb_max);
<a name="l01657"></a>01657     <span class="keywordflow">return</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ad0a46bea9e3164c82f9a199d780d31de">test_planes_aabb</a>(bb_min, bb_max, data) != <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caf3401da29db7b1d5a30a9f7b60e51b52">ISECT_OUTSIDE</a>;
<a name="l01658"></a>01658 }
<a name="l01659"></a>01659 
<a name="l01660"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a69da500d977a6e2de09e3d3afb9e2670">01660</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a69da500d977a6e2de09e3d3afb9e2670">BLI_pbvh_node_planes_exclude_AABB</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662     <span class="keywordtype">float</span> bb_min[3], bb_max[3];
<a name="l01663"></a>01663     
<a name="l01664"></a>01664     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae198d6e0d2a9da4fdaaebf2383c1141c">BLI_pbvh_node_get_BB</a>(node, bb_min, bb_max);
<a name="l01665"></a>01665     <span class="keywordflow">return</span> <a class="code" href="../../dc/d0f/pbvh_8c.html#ad0a46bea9e3164c82f9a199d780d31de">test_planes_aabb</a>(bb_min, bb_max, data) != <a class="code" href="../../dc/d0f/pbvh_8c.html#a40c87e23a1f9c643a354864ffd9cb13caa41fd25b4151496ea4a11764379ad1d1">ISECT_INSIDE</a>;
<a name="l01666"></a>01666 }
<a name="l01667"></a>01667 
<a name="l01668"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a8688abe27aa416988dfe7bc0b0cb2bb2">01668</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aa3ad1c0eecb032b1f8829583957d683c">BLI_pbvh_draw</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <span class="keywordtype">float</span> (*planes)[4], <span class="keywordtype">float</span> (*face_nors)[3],
<a name="l01669"></a>01669                    <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8e2f823f024740efe648726f57f4a336">DMSetMaterial</a> setMaterial)
<a name="l01670"></a>01670 {
<a name="l01671"></a>01671     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>;
<a name="l01672"></a>01672     <span class="keywordtype">int</span> totnode;
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#aee76af834981b5477c0575b177dddc99">BLI_pbvh_search_gather</a>(bvh, <a class="code" href="../../dc/d0f/pbvh_8c.html#a7dfd1e72fcd0c7e1966016adf04715a6">update_search_cb</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba7ea7cad8afc7a7f9c8f5ae86cbfd3262">PBVH_UpdateNormals</a>|<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10eba1147a4e4c83f0334c990ac71322bfcbd">PBVH_UpdateDrawBuffers</a>),
<a name="l01675"></a>01675         &amp;nodes, &amp;totnode);
<a name="l01676"></a>01676 
<a name="l01677"></a>01677     <a class="code" href="../../dc/d0f/pbvh_8c.html#a8bc757bcc56f3eb8a2d69f2766257cf4">pbvh_update_normals</a>(bvh, nodes, totnode, face_nors);
<a name="l01678"></a>01678     <a class="code" href="../../dc/d0f/pbvh_8c.html#afb69cd5829a5f9d787cf676f3a61f311">pbvh_update_draw_buffers</a>(bvh, nodes, totnode);
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     <span class="keywordflow">if</span> (nodes) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nodes);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <span class="keywordflow">if</span> (planes) {
<a name="l01683"></a>01683         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a8494aff65bc27eed5646ccea4f161be8">BLI_pbvh_search_callback</a>(bvh, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#afb86667b566736e049e3252a5eb13083">BLI_pbvh_node_planes_contain_AABB</a>,
<a name="l01684"></a>01684                 planes, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae20d5b1273574c66df8f5125e27e05ee">BLI_pbvh_node_draw</a>, setMaterial);
<a name="l01685"></a>01685     }
<a name="l01686"></a>01686     <span class="keywordflow">else</span> {
<a name="l01687"></a>01687         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a8494aff65bc27eed5646ccea4f161be8">BLI_pbvh_search_callback</a>(bvh, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae20d5b1273574c66df8f5125e27e05ee">BLI_pbvh_node_draw</a>, setMaterial);
<a name="l01688"></a>01688     }
<a name="l01689"></a>01689 }
<a name="l01690"></a>01690 
<a name="l01691"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a37e08a63a215ee7f8718f340b00719f4">01691</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a0936768f7aeb6bba183fed7ee3960387">BLI_pbvh_grids_update</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **grids, <a class="code" href="../../d9/d82/structDMGridAdjacency.html">DMGridAdjacency</a> *gridadj, <span class="keywordtype">void</span> **gridfaces)
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>= grids;
<a name="l01694"></a>01694     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab96bc933cd88f3110409bc6b77792c20">gridadj</a>= gridadj;
<a name="l01695"></a>01695     bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#aa7468000625e79365e8515bd08a2cd62">gridfaces</a>= gridfaces;
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a03e6c8f8fa8afe631ccb8d9918e3063d">01698</a> float (*<a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a861aba956c4c192c943e0f8c03c73180">BLI_pbvh_get_vertCos</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *pbvh))[3]
<a name="l01699"></a>01699 {
<a name="l01700"></a>01700     <span class="keywordtype">int</span> a;
<a name="l01701"></a>01701     float (*vertCos)[3]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="keywordflow">if</span> (pbvh-&gt;verts) {
<a name="l01704"></a>01704         <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l01705"></a>01705         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= pbvh-&gt;verts;
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         vertCos= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(3*pbvh-&gt;totvert*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;BLI_pbvh_get_vertCoords&quot;</span>);
<a name="l01708"></a>01708         co= (<span class="keywordtype">float</span>*)vertCos;
<a name="l01709"></a>01709 
<a name="l01710"></a>01710         <span class="keywordflow">for</span> (a= 0; a&lt;pbvh-&gt;totvert; a++, mvert++, co+= 3) {
<a name="l01711"></a>01711             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co, mvert-&gt;co);
<a name="l01712"></a>01712         }
<a name="l01713"></a>01713     }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715     <span class="keywordflow">return</span> vertCos;
<a name="l01716"></a>01716 }
<a name="l01717"></a>01717 
<a name="l01718"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#aef324c592c0a140805e0e6f36bbd2868">01718</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a5f006f0be006dd9c9e462f8caf40e37d">BLI_pbvh_apply_vertCos</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *pbvh, <span class="keywordtype">float</span> (*vertCos)[3])
<a name="l01719"></a>01719 {
<a name="l01720"></a>01720     <span class="keywordtype">int</span> a;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     <span class="keywordflow">if</span> (!pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">deformed</a>) {
<a name="l01723"></a>01723         <span class="keywordflow">if</span> (pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>) {
<a name="l01724"></a>01724             <span class="comment">/* if pbvh is not already deformed, verts/faces points to the */</span>
<a name="l01725"></a>01725             <span class="comment">/* original data and applying new coords to this arrays would lead to */</span>
<a name="l01726"></a>01726             <span class="comment">/* unneeded deformation -- duplicate verts/faces to avoid this */</span>
<a name="l01727"></a>01727 
<a name="l01728"></a>01728             pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>);
<a name="l01729"></a>01729             pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>);
<a name="l01730"></a>01730 
<a name="l01731"></a>01731             pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">deformed</a>= 1;
<a name="l01732"></a>01732         }
<a name="l01733"></a>01733     }
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     <span class="keywordflow">if</span> (pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>) {
<a name="l01736"></a>01736         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert= pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>;
<a name="l01737"></a>01737         <span class="comment">/* copy new verts coords */</span>
<a name="l01738"></a>01738         <span class="keywordflow">for</span> (a= 0; a &lt; pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">totvert</a>; ++a, ++mvert) {
<a name="l01739"></a>01739             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, vertCos[a]);
<a name="l01740"></a>01740             mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>;
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         <span class="comment">/* coordinates are new -- normals should also be updated */</span>
<a name="l01744"></a>01744         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a19b001a7d763c08b54cc47eaa8234f27">mesh_calc_normals_tessface</a>(pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ab9494048e89f1630b37c95334e21c6c0">verts</a>, pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a0c96aaf42f256a1fab87209b133ee5ee">totvert</a>, pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a4e00033f98e0fd018f34553392b19fee">faces</a>, pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a7fc29a8474a80a56c780ff3a0f5ca907">totprim</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01745"></a>01745 
<a name="l01746"></a>01746         <span class="keywordflow">for</span> (a= 0; a &lt; pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a>; ++a)
<a name="l01747"></a>01747             <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a695a0e333f03d1ba08b869a2302a977f">BLI_pbvh_node_mark_update</a>(&amp;pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a>[a]);
<a name="l01748"></a>01748 
<a name="l01749"></a>01749         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a97135c648369b00b64bc04e7468a86f9">BLI_pbvh_update</a>(pbvh, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01750"></a>01750         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a97135c648369b00b64bc04e7468a86f9">BLI_pbvh_update</a>(pbvh, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752     }
<a name="l01753"></a>01753 }
<a name="l01754"></a>01754 
<a name="l01755"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a98b134a6ddf7cb08631105d9fc9053e4">01755</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae073926d19d39aab816a6a9a8b6bbbf1">BLI_pbvh_isDeformed</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *pbvh)
<a name="l01756"></a>01756 {
<a name="l01757"></a>01757     <span class="keywordflow">return</span> pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#a6f11c3717e52af478b449de6a4508874">deformed</a>;
<a name="l01758"></a>01758 }
<a name="l01759"></a>01759 <span class="comment">/* Proxies */</span>
<a name="l01760"></a>01760 
<a name="l01761"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a1a28c72049ed9220f18dbc5a23fbf1d7">01761</a> <a class="code" href="../../d2/d16/structPBVHProxyNode.html">PBVHProxyNode</a>* <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1a28c72049ed9220f18dbc5a23fbf1d7">BLI_pbvh_node_add_proxy</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a>* bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>* node)
<a name="l01762"></a>01762 {
<a name="l01763"></a>01763     <span class="keywordtype">int</span> index, totverts;
<a name="l01764"></a>01764 
<a name="l01765"></a>01765 <span class="preprocessor">    #pragma omp critical</span>
<a name="l01766"></a>01766 <span class="preprocessor"></span>    {
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         index = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>++;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>)
<a name="l01773"></a>01773             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>, node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d16/structPBVHProxyNode.html">PBVHProxyNode</a>));
<a name="l01774"></a>01774         <span class="keywordflow">else</span>
<a name="l01775"></a>01775             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d16/structPBVHProxyNode.html">PBVHProxyNode</a>), <span class="stringliteral">&quot;PBVHNodeProxy&quot;</span>);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777         <span class="keywordflow">if</span> (bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae07164480c73677521b73d3534d3cd6d">grids</a>)
<a name="l01778"></a>01778             totverts = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a34faeeca98167a92c34077fad0005322">totprim</a>*bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>*bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#af73fdb8b0363a34148f1d4e982fecaca">gridsize</a>;
<a name="l01779"></a>01779         <span class="keywordflow">else</span>
<a name="l01780"></a>01780             totverts = node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#ab69b9a563f915a0ce0bceead01d5b627">uniq_verts</a>;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>[index].<a class="code" href="../../d2/d16/structPBVHProxyNode.html#a17812e6c8ba511740f7ae872a3369801">co</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>[3])*totverts, <span class="stringliteral">&quot;PBVHNodeProxy.co&quot;</span>);
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785     <span class="keywordflow">return</span> node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a> + index;
<a name="l01786"></a>01786 }
<a name="l01787"></a>01787 
<a name="l01788"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ae56b2735ab99bc2f5aaf8bb27db2fa24">01788</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae56b2735ab99bc2f5aaf8bb27db2fa24">BLI_pbvh_node_free_proxies</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>* node)
<a name="l01789"></a>01789 {
<a name="l01790"></a>01790 <span class="preprocessor">    #pragma omp critical</span>
<a name="l01791"></a>01791 <span class="preprocessor"></span>    {
<a name="l01792"></a>01792         <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01793"></a>01793 
<a name="l01794"></a>01794         <span class="keywordflow">for</span> (p= 0; p &lt; node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>; p++) {
<a name="l01795"></a>01795             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>[p].<a class="code" href="../../d2/d16/structPBVHProxyNode.html#a17812e6c8ba511740f7ae872a3369801">co</a>);
<a name="l01796"></a>01796             node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>].<a class="code" href="../../d2/d16/structPBVHProxyNode.html#a17812e6c8ba511740f7ae872a3369801">co</a>= 0;
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a>);
<a name="l01800"></a>01800         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a9d17aa963868858391c57b27fa376685">proxies</a> = 0;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802         node-&gt;<a class="code" href="../../d2/dae/structPBVHNode.html#a20f669164c50afe5dfb2c85021b3c25e">proxy_count</a>= 0;
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804 }
<a name="l01805"></a>01805 
<a name="l01806"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#ab25df184f85b1cac4f8fd97b338bf015">01806</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a0441a4235ca416333cc99305e2a0c329">BLI_pbvh_gather_proxies</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a>* pbvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>*** r_array,  <span class="keywordtype">int</span>* r_tot)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> **<a class="code" href="../../d2/d41/classarray.html">array</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, **newarray, *node;
<a name="l01809"></a>01809     <span class="keywordtype">int</span> tot= 0, space= 0;
<a name="l01810"></a>01810     <span class="keywordtype">int</span> n;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812     <span class="keywordflow">for</span> (n= 0; n &lt; pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#adc698686fbe495937552b9b3a494a03e">totnode</a>; n++) {
<a name="l01813"></a>01813         node = pbvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ae92365f5e31cd72dbfcd9978a0906520">nodes</a> + n;
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="keywordflow">if</span> (node-&gt;proxy_count &gt; 0) {
<a name="l01816"></a>01816             <span class="keywordflow">if</span> (tot == space) {
<a name="l01817"></a>01817                 <span class="comment">/* resize array if needed */</span>
<a name="l01818"></a>01818                 space= (tot == 0)? 32: space*2;
<a name="l01819"></a>01819                 newarray= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>)*space, <span class="stringliteral">&quot;BLI_pbvh_gather_proxies&quot;</span>);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821                 <span class="keywordflow">if</span> (array) {
<a name="l01822"></a>01822                     memcpy(newarray, array, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a>)*tot);
<a name="l01823"></a>01823                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array);
<a name="l01824"></a>01824                 }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826                 array= newarray;
<a name="l01827"></a>01827             }
<a name="l01828"></a>01828 
<a name="l01829"></a>01829             array[tot]= node;
<a name="l01830"></a>01830             tot++;
<a name="l01831"></a>01831         }
<a name="l01832"></a>01832     }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     <span class="keywordflow">if</span> (tot == 0 &amp;&amp; array) {
<a name="l01835"></a>01835         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array);
<a name="l01836"></a>01836         array= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01837"></a>01837     }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     *r_array= array;
<a name="l01840"></a>01840     *r_tot= tot;
<a name="l01841"></a>01841 }
<a name="l01842"></a>01842 
<a name="l01843"></a><a class="code" href="../../dc/d0f/pbvh_8c.html#a0a389416743369658385cc068e83526e">01843</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a0a389416743369658385cc068e83526e">pbvh_vertex_iter_init</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *bvh, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *node,
<a name="l01844"></a>01844                            <a class="code" href="../../d4/d18/structPBVHVertexIter.html">PBVHVertexIter</a> *vi, <span class="keywordtype">int</span> mode)
<a name="l01845"></a>01845 {
<a name="l01846"></a>01846     <span class="keyword">struct </span><a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **grids;
<a name="l01847"></a>01847     <span class="keyword">struct </span><a class="code" href="../../d8/de5/structMVert.html">MVert</a> *verts;
<a name="l01848"></a>01848     <span class="keywordtype">int</span> *grid_indices, *vert_indices;
<a name="l01849"></a>01849     <span class="keywordtype">int</span> totgrid, gridsize, uniq_verts, totvert;
<a name="l01850"></a>01850     
<a name="l01851"></a>01851     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a363386696bd993c614bd050d4e83c0b9">grid</a>= 0;
<a name="l01852"></a>01852     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a0f32d8cac83260de20e6742e0ad84393">no</a>= 0;
<a name="l01853"></a>01853     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a69f251f26b918fdd9211384ed33d6530">fno</a>= 0;
<a name="l01854"></a>01854     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a019483aa0e3be320e269780c111d93fa">mvert</a>= 0;
<a name="l01855"></a>01855     
<a name="l01856"></a>01856     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae2bfd81c94c6139d50c125f417801956">BLI_pbvh_node_get_grids</a>(bvh, node, &amp;grid_indices, &amp;totgrid, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;gridsize, &amp;grids, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01857"></a>01857     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4bfd1ef41ea772bd811beeaa7e649dfe">BLI_pbvh_node_num_verts</a>(bvh, node, &amp;uniq_verts, &amp;totvert);
<a name="l01858"></a>01858     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ad78889c6986e72570348cc7463c574af">BLI_pbvh_node_get_verts</a>(bvh, node, &amp;vert_indices, &amp;verts);
<a name="l01859"></a>01859     
<a name="l01860"></a>01860     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a3edec98a046c6fce4ff821009a2da2f0">grids</a>= grids;
<a name="l01861"></a>01861     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a04a6072842fdb4ed7a29c565f8d1da99">grid_indices</a>= grid_indices;
<a name="l01862"></a>01862     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#afe7bc54c3bb09855aa591b2334768375">totgrid</a>= (grids)? totgrid: 1;
<a name="l01863"></a>01863     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a3a735c6dac1e66d49327668ffb70b445">gridsize</a>= gridsize;
<a name="l01864"></a>01864     
<a name="l01865"></a>01865     <span class="keywordflow">if</span> (mode == <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1e5915687b643feaddfd747aab14b5f9">PBVH_ITER_ALL</a>)
<a name="l01866"></a>01866         vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#af91892e91bde6804e68aa2a492b62f88">totvert</a> = totvert;
<a name="l01867"></a>01867     <span class="keywordflow">else</span>
<a name="l01868"></a>01868         vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#af91892e91bde6804e68aa2a492b62f88">totvert</a>= uniq_verts;
<a name="l01869"></a>01869     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a25ea9b71a33d6f2254fe07ac93e81129">vert_indices</a>= vert_indices;
<a name="l01870"></a>01870     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#af40f340c883b0770ef1443ef27305ca3">mverts</a>= verts;
<a name="l01871"></a>01871 
<a name="l01872"></a>01872     vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a4fce59fd5a8d8bf383b0f924abaef9f8">gh</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01873"></a>01873     <span class="keywordflow">if</span> (vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a3edec98a046c6fce4ff821009a2da2f0">grids</a> &amp;&amp; mode == <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a970d59379a016e90f8dabf0d269fc469">PBVH_ITER_UNIQUE</a>)
<a name="l01874"></a>01874         vi-&gt;<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a843c746cf5a150e75d69fffeb2aec570">grid_hidden</a>= bvh-&gt;<a class="code" href="../../d3/dd0/structPBVH.html#ada3bd8c8a44be588d66d0db76571b43a">grid_hidden</a>;
<a name="l01875"></a>01875 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:44 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
