<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: zbuf.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">zbuf.c</div>  </div>
</div>
<div class="contents">
<a href="../../dc/da5/zbuf_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributors: Hos, RPW</span>
<a name="l00022"></a>00022 <span class="comment"> *               2004-2006 Blender Foundation, full recode</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00033"></a>00033 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00034"></a>00034 <span class="comment">/* Common includes                                                           */</span>
<a name="l00035"></a>00035 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d49/BLI__jitter_8h.html">BLI_jitter.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/de4/RE__render__ext_8h.html">RE_render_ext.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="comment">/* local includes */</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d5d/gammaCorrectionTables_8h.html">gammaCorrectionTables.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db3/pixelblending_8h.html">pixelblending.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dff/render__result_8h.html">render_result.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d59/sss_8h.html">sss.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dda/strand_8h.html">strand.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/* own includes */</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00080"></a>00080 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00081"></a>00081 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00082"></a>00082 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00083"></a>00083 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">/* ****************** Spans ******************************* */</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">/* each zbuffer has coordinates transformed to local rect coordinates, so we can simply clip */</span>
<a name="l00089"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a3fd997c6856f8454c5f5ed9df7de1fda">00089</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>, <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a009950f9a9e7f4fa4709c80fa7e82089">clipcrop</a>)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     memset(zspan, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a>));
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l00094"></a>00094     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>= <a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>;
<a name="l00095"></a>00095     
<a name="l00096"></a>00096     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(recty*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;zspan&quot;</span>);
<a name="l00097"></a>00097     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(recty*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;zspan&quot;</span>);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#afafe7f41d97637e44c3de459d275f3e4">clipcrop</a>= <a class="code" href="../../d6/d7a/structRender.html#a009950f9a9e7f4fa4709c80fa7e82089">clipcrop</a>;
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="../../dc/da5/zbuf_8c.html#abce04b41e016c4a0cbb5534c9f947853">00102</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan)
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (zspan) {
<a name="l00105"></a>00105         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>);
<a name="l00106"></a>00106         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>);
<a name="l00107"></a>00107         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00108"></a>00108     }
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/* reset range for clipping */</span>
<a name="l00112"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">00112</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan)
<a name="l00113"></a>00113 {
<a name="l00114"></a>00114     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>+1;
<a name="l00115"></a>00115     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>= -1;
<a name="l00116"></a>00116     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af3e86b38cf3480d3271662fe017b812a">minp1</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">00119</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2)
<a name="l00120"></a>00120 {
<a name="l00121"></a>00121     <span class="keywordtype">float</span> *minv, *maxv, *span;
<a name="l00122"></a>00122     <span class="keywordtype">float</span> xx1, dx0, xs0;
<a name="l00123"></a>00123     <span class="keywordtype">int</span> y, my0, my2;
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (v1[1]&lt;v2[1]) {
<a name="l00126"></a>00126         minv= v1; maxv= v2;
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128     <span class="keywordflow">else</span> {
<a name="l00129"></a>00129         minv= v2; maxv= v1;
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131     
<a name="l00132"></a>00132     my0= ceil(minv[1]);
<a name="l00133"></a>00133     my2= floor(maxv[1]);
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (my2&lt;0 || my0&gt;= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>) <span class="keywordflow">return</span>;
<a name="l00136"></a>00136     
<a name="l00137"></a>00137     <span class="comment">/* clip top */</span>
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (my2&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>-1;
<a name="l00139"></a>00139     <span class="comment">/* clip bottom */</span>
<a name="l00140"></a>00140     <span class="keywordflow">if</span> (my0&lt;0) my0= 0;
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (my0&gt;my2) <span class="keywordflow">return</span>;
<a name="l00143"></a>00143     <span class="comment">/* if (my0&gt;my2) should still fill in, that way we get spans that skip nicely */</span>
<a name="l00144"></a>00144     
<a name="l00145"></a>00145     xx1= maxv[1]-minv[1];
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (xx1&gt;FLT_EPSILON) {
<a name="l00147"></a>00147         dx0= (minv[0]-maxv[0])/xx1;
<a name="l00148"></a>00148         xs0= dx0*(minv[1]-my2) + minv[0];
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150     <span class="keywordflow">else</span> {
<a name="l00151"></a>00151         dx0= 0.0f;
<a name="l00152"></a>00152         xs0= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(minv[0],maxv[0]);
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154     
<a name="l00155"></a>00155     <span class="comment">/* empty span */</span>
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00157"></a>00157         span= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     <span class="keywordflow">else</span> {  <span class="comment">/* does it complete left span? */</span>
<a name="l00160"></a>00160         <span class="keywordflow">if</span> ( maxv == zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af3e86b38cf3480d3271662fe017b812a">minp1</a> || minv==zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a>) {
<a name="l00161"></a>00161             span= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>;
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163         <span class="keywordflow">else</span> {
<a name="l00164"></a>00164             span= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>;
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (span==zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>) {
<a name="l00169"></a>00169 <span class="comment">//      printf(&quot;left span my0 %d my2 %d\n&quot;, my0, my2);</span>
<a name="l00170"></a>00170         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af3e86b38cf3480d3271662fe017b812a">minp1</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af3e86b38cf3480d3271662fe017b812a">minp1</a>[1] &gt; minv[1] ) {
<a name="l00171"></a>00171             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af3e86b38cf3480d3271662fe017b812a">minp1</a>= minv;
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a>[1] &lt; maxv[1] ) {
<a name="l00174"></a>00174             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26858c6cd8351e33b108e6ec7561de7c">maxp1</a>= maxv;
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (my0&lt;zspan-&gt;miny1) zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>= my0;
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (my2&gt;zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>) zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>= my2;
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     <span class="keywordflow">else</span> {
<a name="l00180"></a>00180 <span class="comment">//      printf(&quot;right span my0 %d my2 %d\n&quot;, my0, my2);</span>
<a name="l00181"></a>00181         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>[1] &gt; minv[1] ) {
<a name="l00182"></a>00182             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>= minv;
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>[1] &lt; maxv[1] ) {
<a name="l00185"></a>00185             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>= maxv;
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (my0&lt;zspan-&gt;miny2) zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>= my0;
<a name="l00188"></a>00188         <span class="keywordflow">if</span> (my2&gt;zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>= my2;
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, xs0+= dx0) {
<a name="l00192"></a>00192         <span class="comment">/* xs0 is the xcoord! */</span>
<a name="l00193"></a>00193         span[y]= xs0;
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="comment">/*-----------------------------------------------------------*/</span> 
<a name="l00198"></a>00198 <span class="comment">/* Functions                                                 */</span>
<a name="l00199"></a>00199 <span class="comment">/*-----------------------------------------------------------*/</span> 
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="../../dc/da5/zbuf_8c.html#adc6a5b7b40d76b310298b7a5c6baffd7">00201</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(<span class="keywordtype">int</span> *rect, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> val)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203     <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, *drect;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     len= x*y;
<a name="l00206"></a>00206     drect= rect;
<a name="l00207"></a>00207     <span class="keywordflow">while</span> (len&gt;0) {
<a name="l00208"></a>00208         len--;
<a name="l00209"></a>00209         *drect= val;
<a name="l00210"></a>00210         drect++;
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* based on Liang&amp;Barsky, for clipping of pyramidical volume */</span>
<a name="l00215"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">00215</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> b, <span class="keywordtype">float</span> c, <span class="keywordtype">float</span> d, <span class="keywordtype">float</span> *u1, <span class="keywordtype">float</span> *u2)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= a + b, q= c + d, <a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>;
<a name="l00218"></a>00218     
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (p&lt;0.0f) {
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (q&lt;p) <span class="keywordflow">return</span> 0;
<a name="l00221"></a>00221         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q&lt;0.0f) {
<a name="l00222"></a>00222             r= q/<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00223"></a>00223             <span class="keywordflow">if</span> (r&gt;*u2) <span class="keywordflow">return</span> 0;
<a name="l00224"></a>00224             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&gt;*u1) *u1=<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>;
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     <span class="keywordflow">else</span> {
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (p&gt;0.0f) {
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (q&lt;0.0f) <span class="keywordflow">return</span> 0;
<a name="l00230"></a>00230             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q&lt;p) {
<a name="l00231"></a>00231                 r= q/<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00232"></a>00232                 <span class="keywordflow">if</span> (r&lt;*u1) <span class="keywordflow">return</span> 0;
<a name="l00233"></a>00233                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&lt;*u2) *u2=<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>;
<a name="l00234"></a>00234             }
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q&lt;0.0f) <span class="keywordflow">return</span> 0;
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     <span class="keywordflow">return</span> 1;
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a><a class="code" href="../../dc/da5/zbuf_8c.html#abe2a29c6d596a300657682d9c1f470c0">00241</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v[4])
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243     <span class="keywordtype">float</span> abs4; <span class="comment">/* WATCH IT: this function should do the same as cliptestf, otherwise troubles in zbufclip()*/</span>
<a name="l00244"></a>00244     <span class="keywordtype">short</span> c=0;
<a name="l00245"></a>00245     
<a name="l00246"></a>00246     <span class="comment">/* if we set clip flags, the clipping should be at least larger than epsilon. </span>
<a name="l00247"></a>00247 <span class="comment">     * prevents issues with vertices lying exact on borders */</span>
<a name="l00248"></a>00248     abs4= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(v[3]) + FLT_EPSILON;
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <span class="keywordflow">if</span> ( v[0] &lt; -abs4) c+=1;
<a name="l00251"></a>00251     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( v[0] &gt; abs4) c+=2;
<a name="l00252"></a>00252     
<a name="l00253"></a>00253     <span class="keywordflow">if</span> ( v[1] &gt; abs4) c+=4;
<a name="l00254"></a>00254     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( v[1] &lt; -abs4) c+=8;
<a name="l00255"></a>00255     
<a name="l00256"></a>00256     <span class="keywordflow">if</span> (v[2] &lt; -abs4) c+=16;            <span class="comment">/* this used to be &quot; if (v[2]&lt;0) &quot;, see clippz() */</span>
<a name="l00257"></a>00257     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v[2]&gt; abs4) c+= 32;
<a name="l00258"></a>00258     
<a name="l00259"></a>00259     <span class="keywordflow">return</span> c;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">/* *************  ACCUMULATION ZBUF ************ */</span>
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a695953c7b9fd403ea79c4d2cced48d40">00267</a> <span class="keyword">static</span> <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *<a class="code" href="../../dc/da5/zbuf_8c.html#a695953c7b9fd403ea79c4d2cced48d40">addpsmainA</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <a class="code" href="../../da/ddf/structAPixstrMain.html">APixstrMain</a> *psm;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     psm= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/ddf/structAPixstrMain.html">APixstrMain</a>), <span class="stringliteral">&quot;addpsmainA&quot;</span>);
<a name="l00272"></a>00272     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, psm);
<a name="l00273"></a>00273     psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(4096*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a>),<span class="stringliteral">&quot;pixstr&quot;</span>);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">return</span> psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ad80676a91a7028b061f2f08ae8e517e2">00278</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a7f3263aa851e14a4695cc307d8433696">freepsA</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <a class="code" href="../../da/ddf/structAPixstrMain.html">APixstrMain</a> *psm, *psmnext;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">for</span> (psm= lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psm; psm= psmnext) {
<a name="l00283"></a>00283         psmnext= psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#ada67dbb4fd2726beea13e753f2fb0956">next</a>;
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>)
<a name="l00285"></a>00285             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>);
<a name="l00286"></a>00286         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psm);
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a36f9e6cb0074118202fcae4edd06096a">00290</a> <span class="keyword">static</span> <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *<a class="code" href="../../dc/da5/zbuf_8c.html#a36f9e6cb0074118202fcae4edd06096a">addpsA</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292     <span class="comment">/* make new PS */</span>
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a3dbe36f81d0f931b3ff4a6cd890bcf1f">apsmcounter</a>==0) {
<a name="l00294"></a>00294         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#abd546f3b9ccfb83ce1d94ada47b32011">curpstr</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a695953c7b9fd403ea79c4d2cced48d40">addpsmainA</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aa8c2f165a3d6f750a37a1740028b8e0a">apsmbase</a>);
<a name="l00295"></a>00295         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a3dbe36f81d0f931b3ff4a6cd890bcf1f">apsmcounter</a>= 4095;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     <span class="keywordflow">else</span> {
<a name="l00298"></a>00298         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#abd546f3b9ccfb83ce1d94ada47b32011">curpstr</a>++;
<a name="l00299"></a>00299         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a3dbe36f81d0f931b3ff4a6cd890bcf1f">apsmcounter</a>--;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301     <span class="keywordflow">return</span> zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#abd546f3b9ccfb83ce1d94ada47b32011">curpstr</a>;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a6148960dddb01f7e7308badfab4a842f">00304</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a6148960dddb01f7e7308badfab4a842f">zbuffillAc4</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *ap, *apofs, *apn;
<a name="l00307"></a>00307     <span class="keywordtype">double</span> zxd, zyd, zy0, zverg;
<a name="l00308"></a>00308     <span class="keywordtype">float</span> x0,y0,z0;
<a name="l00309"></a>00309     <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xx1;
<a name="l00310"></a>00310     <span class="keywordtype">float</span> *span1, *span2;
<a name="l00311"></a>00311     <span class="keywordtype">int</span> *rz, *rm, x, y;
<a name="l00312"></a>00312     <span class="keywordtype">int</span> sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, *rectzofs, *rectmaskofs, my0, my2, mask;
<a name="l00313"></a>00313     
<a name="l00314"></a>00314     <span class="comment">/* init */</span>
<a name="l00315"></a>00315     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l00316"></a>00316     
<a name="l00317"></a>00317     <span class="comment">/* set spans */</span>
<a name="l00318"></a>00318     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l00319"></a>00319     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (v4) {
<a name="l00321"></a>00321         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l00322"></a>00322         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     <span class="keywordflow">else</span>
<a name="l00325"></a>00325         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327     <span class="comment">/* clipped */</span>
<a name="l00328"></a>00328     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l00332"></a>00332     
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l00334"></a>00334     
<a name="l00335"></a>00335     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l00336"></a>00336     x1= v1[0]- v2[0];
<a name="l00337"></a>00337     x2= v2[0]- v3[0];
<a name="l00338"></a>00338     y1= v1[1]- v2[1];
<a name="l00339"></a>00339     y2= v2[1]- v3[1];
<a name="l00340"></a>00340     z1= v1[2]- v2[2];
<a name="l00341"></a>00341     z2= v2[2]- v3[2];
<a name="l00342"></a>00342     x0= y1*z2-z1*y2;
<a name="l00343"></a>00343     y0= z1*x2-x1*z2;
<a name="l00344"></a>00344     z0= x1*y2-y1*x2;
<a name="l00345"></a>00345     
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l00347"></a>00347     
<a name="l00348"></a>00348     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l00349"></a>00349     
<a name="l00350"></a>00350     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l00351"></a>00351     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l00352"></a>00352     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l00353"></a>00353     
<a name="l00354"></a>00354     <span class="comment">/* start-offset in rect */</span>
<a name="l00355"></a>00355     rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00356"></a>00356     rectzofs= (<span class="keywordtype">int</span> *)(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>+rectx*(my2));
<a name="l00357"></a>00357     rectmaskofs= (<span class="keywordtype">int</span> *)(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>+rectx*(my2));
<a name="l00358"></a>00358     apofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a35f5eab87b3cd7f543676bd8fcc0b4e5">apixbuf</a>+ rectx*(my2));
<a name="l00359"></a>00359     mask= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab29829dc7f2c1089dd7afb9fc415d551">mask</a>;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="comment">/* correct span */</span>
<a name="l00362"></a>00362     sn1= (my0 + my2)/2;
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l00364"></a>00364         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l00365"></a>00365         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     <span class="keywordflow">else</span> {
<a name="l00368"></a>00368         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l00369"></a>00369         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371     
<a name="l00372"></a>00372     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l00373"></a>00373         
<a name="l00374"></a>00374         sn1= floor(*span1);
<a name="l00375"></a>00375         sn2= floor(*span2);
<a name="l00376"></a>00376         sn1++; 
<a name="l00377"></a>00377         
<a name="l00378"></a>00378         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l00380"></a>00380         
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (sn2&gt;=sn1) {
<a name="l00382"></a>00382             <span class="keywordtype">int</span> intzverg;
<a name="l00383"></a>00383             
<a name="l00384"></a>00384             zverg= (double)sn1*zxd + zy0;
<a name="l00385"></a>00385             rz= rectzofs+sn1;
<a name="l00386"></a>00386             rm= rectmaskofs+sn1;
<a name="l00387"></a>00387             ap= apofs+sn1;
<a name="l00388"></a>00388             x= sn2-sn1;
<a name="l00389"></a>00389             
<a name="l00390"></a>00390             zverg-= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a86c4afff79f9108f15bba2296ffccd61">polygon_offset</a>;
<a name="l00391"></a>00391             
<a name="l00392"></a>00392             <span class="keywordflow">while</span> (x&gt;=0) {
<a name="l00393"></a>00393                 intzverg= (int)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(zverg, INT_MIN, INT_MAX);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                 <span class="keywordflow">if</span> ( intzverg &lt; *rz) {
<a name="l00396"></a>00396                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || intzverg &gt; *rm) {
<a name="l00397"></a>00397                         
<a name="l00398"></a>00398                         apn= ap;
<a name="l00399"></a>00399                         <span class="keywordflow">while</span> (apn) {
<a name="l00400"></a>00400                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[0]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[0]= intzverg; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]= mask; <span class="keywordflow">break</span>; }
<a name="l00401"></a>00401                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[0]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]|= mask; <span class="keywordflow">break</span>; }
<a name="l00402"></a>00402                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[1]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[1]= intzverg; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]= mask; <span class="keywordflow">break</span>; }
<a name="l00403"></a>00403                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[1]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]|= mask; <span class="keywordflow">break</span>; }
<a name="l00404"></a>00404                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[2]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[2]= intzverg; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]= mask; <span class="keywordflow">break</span>; }
<a name="l00405"></a>00405                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[2]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]|= mask; <span class="keywordflow">break</span>; }
<a name="l00406"></a>00406                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[3]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[3]= intzverg; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]= mask; <span class="keywordflow">break</span>; }
<a name="l00407"></a>00407                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[3]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]|= mask; <span class="keywordflow">break</span>; }
<a name="l00408"></a>00408                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a36f9e6cb0074118202fcae4edd06096a">addpsA</a>(zspan);
<a name="l00409"></a>00409                             apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>;
<a name="l00410"></a>00410                         }               
<a name="l00411"></a>00411                     }
<a name="l00412"></a>00412                 }
<a name="l00413"></a>00413                 zverg+= zxd;
<a name="l00414"></a>00414                 rz++; 
<a name="l00415"></a>00415                 rm++;
<a name="l00416"></a>00416                 ap++; 
<a name="l00417"></a>00417                 x--;
<a name="l00418"></a>00418             }
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420         
<a name="l00421"></a>00421         zy0-=zyd;
<a name="l00422"></a>00422         rectzofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l00423"></a>00423         rectmaskofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l00424"></a>00424         apofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1058a005d983d1b45528990b5e96b4f1">00430</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a1058a005d983d1b45528990b5e96b4f1">zbuflineAc</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *vec1, <span class="keywordtype">float</span> *vec2)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *ap, *apn;
<a name="l00433"></a>00433     <span class="keywordtype">int</span> *rectz, *rectmask;
<a name="l00434"></a>00434     <span class="keywordtype">int</span> start, end, x, y, oldx, oldy, ofs;
<a name="l00435"></a>00435     <span class="keywordtype">int</span> dz, vergz, mask, maxtest=0;
<a name="l00436"></a>00436     <span class="keywordtype">float</span> dx, dy;
<a name="l00437"></a>00437     <span class="keywordtype">float</span> v1[3], v2[3];
<a name="l00438"></a>00438     
<a name="l00439"></a>00439     dx= vec2[0]-vec1[0];
<a name="l00440"></a>00440     dy= vec2[1]-vec1[1];
<a name="l00441"></a>00441     
<a name="l00442"></a>00442     mask= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab29829dc7f2c1089dd7afb9fc415d551">mask</a>;
<a name="l00443"></a>00443     
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dx) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dy)) {
<a name="l00445"></a>00445 
<a name="l00446"></a>00446         <span class="comment">/* all lines from left to right */</span>
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (vec1[0]&lt;vec2[0]) {
<a name="l00448"></a>00448             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00449"></a>00449             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         <span class="keywordflow">else</span> {
<a name="l00452"></a>00452             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00453"></a>00453             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00454"></a>00454             dx= -dx; dy= -dy;
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457         start= floor(v1[0]);
<a name="l00458"></a>00458         end= start+floor(dx);
<a name="l00459"></a>00459         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>-1;
<a name="l00460"></a>00460         
<a name="l00461"></a>00461         oldy= floor(v1[1]);
<a name="l00462"></a>00462         dy/= dx;
<a name="l00463"></a>00463         
<a name="l00464"></a>00464         vergz= v1[2];
<a name="l00465"></a>00465         vergz-= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a86c4afff79f9108f15bba2296ffccd61">polygon_offset</a>;
<a name="l00466"></a>00466         dz= (v2[2]-v1[2])/dx;
<a name="l00467"></a>00467         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00468"></a>00468         
<a name="l00469"></a>00469         rectz= (<span class="keywordtype">int</span> *)(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>+zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>*(oldy) +start);
<a name="l00470"></a>00470         rectmask= (<span class="keywordtype">int</span> *)(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>+zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>*(oldy) +start);
<a name="l00471"></a>00471         ap= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a35f5eab87b3cd7f543676bd8fcc0b4e5">apixbuf</a>+ zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>*(oldy) +start);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (dy&lt;0) ofs= -zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00474"></a>00474         <span class="keywordflow">else</span> ofs= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00475"></a>00475         
<a name="l00476"></a>00476         <span class="keywordflow">for</span> (x= start; x&lt;=end; x++, rectz++, rectmask++, ap++) {
<a name="l00477"></a>00477             
<a name="l00478"></a>00478             y= floor(v1[1]);
<a name="l00479"></a>00479             <span class="keywordflow">if</span> (y!=oldy) {
<a name="l00480"></a>00480                 oldy= y;
<a name="l00481"></a>00481                 rectz+= ofs;
<a name="l00482"></a>00482                 rectmask+= ofs;
<a name="l00483"></a>00483                 ap+= ofs;
<a name="l00484"></a>00484             }
<a name="l00485"></a>00485             
<a name="l00486"></a>00486             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; y&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>) {
<a name="l00487"></a>00487                 <span class="keywordflow">if</span> (vergz&lt;*rectz) {
<a name="l00488"></a>00488                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || vergz&gt;*rectmask) {
<a name="l00489"></a>00489                     
<a name="l00490"></a>00490                         apn= ap;
<a name="l00491"></a>00491                         <span class="keywordflow">while</span> (apn) {   <span class="comment">/* loop unrolled */</span>
<a name="l00492"></a>00492                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[0]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[0]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]= mask; <span class="keywordflow">break</span>; }
<a name="l00493"></a>00493                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[0]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]|= mask; <span class="keywordflow">break</span>; }
<a name="l00494"></a>00494                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[1]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[1]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]= mask; <span class="keywordflow">break</span>; }
<a name="l00495"></a>00495                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[1]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]|= mask; <span class="keywordflow">break</span>; }
<a name="l00496"></a>00496                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[2]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[2]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]= mask; <span class="keywordflow">break</span>; }
<a name="l00497"></a>00497                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[2]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]|= mask; <span class="keywordflow">break</span>; }
<a name="l00498"></a>00498                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[3]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[3]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]= mask; <span class="keywordflow">break</span>; }
<a name="l00499"></a>00499                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==zvlnr &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[3]==obi) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]|= mask; <span class="keywordflow">break</span>; }
<a name="l00500"></a>00500                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>==0) apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a36f9e6cb0074118202fcae4edd06096a">addpsA</a>(zspan);
<a name="l00501"></a>00501                             apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>;
<a name="l00502"></a>00502                         }               
<a name="l00503"></a>00503                     }
<a name="l00504"></a>00504                 }
<a name="l00505"></a>00505             }
<a name="l00506"></a>00506             
<a name="l00507"></a>00507             v1[1]+= dy;
<a name="l00508"></a>00508             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00509"></a>00509             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512     <span class="keywordflow">else</span> {
<a name="l00513"></a>00513     
<a name="l00514"></a>00514         <span class="comment">/* all lines from top to bottom */</span>
<a name="l00515"></a>00515         <span class="keywordflow">if</span> (vec1[1]&lt;vec2[1]) {
<a name="l00516"></a>00516             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00517"></a>00517             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         <span class="keywordflow">else</span> {
<a name="l00520"></a>00520             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00521"></a>00521             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00522"></a>00522             dx= -dx; dy= -dy;
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         start= floor(v1[1]);
<a name="l00526"></a>00526         end= start+floor(dy);
<a name="l00527"></a>00527         
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (start&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a> || end&lt;0) <span class="keywordflow">return</span>;
<a name="l00529"></a>00529         
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>-1;
<a name="l00531"></a>00531         
<a name="l00532"></a>00532         oldx= floor(v1[0]);
<a name="l00533"></a>00533         dx/= dy;
<a name="l00534"></a>00534         
<a name="l00535"></a>00535         vergz= v1[2];
<a name="l00536"></a>00536         vergz-= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a86c4afff79f9108f15bba2296ffccd61">polygon_offset</a>;
<a name="l00537"></a>00537         dz= (v2[2]-v1[2])/dy;
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         rectz= (<span class="keywordtype">int</span> *)( zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>+ (start)*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx );
<a name="l00541"></a>00541         rectmask= (<span class="keywordtype">int</span> *)( zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>+ (start)*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx );
<a name="l00542"></a>00542         ap= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a35f5eab87b3cd7f543676bd8fcc0b4e5">apixbuf</a>+ zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>*(start) +oldx);
<a name="l00543"></a>00543                 
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (dx&lt;0) ofs= -1;
<a name="l00545"></a>00545         <span class="keywordflow">else</span> ofs= 1;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">for</span> (y= start; y&lt;=end; y++, rectz+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, rectmask+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, ap+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) {
<a name="l00548"></a>00548             
<a name="l00549"></a>00549             x= floor(v1[0]);
<a name="l00550"></a>00550             <span class="keywordflow">if</span> (x!=oldx) {
<a name="l00551"></a>00551                 oldx= x;
<a name="l00552"></a>00552                 rectz+= ofs;
<a name="l00553"></a>00553                 rectmask+= ofs;
<a name="l00554"></a>00554                 ap+= ofs;
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556             
<a name="l00557"></a>00557             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; x&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>) {
<a name="l00558"></a>00558                 <span class="keywordflow">if</span> (vergz&lt;*rectz) {
<a name="l00559"></a>00559                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || vergz&gt;*rectmask) {
<a name="l00560"></a>00560                         
<a name="l00561"></a>00561                         apn= ap;
<a name="l00562"></a>00562                         <span class="keywordflow">while</span> (apn) {   <span class="comment">/* loop unrolled */</span>
<a name="l00563"></a>00563                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[0]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[0]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]= mask; <span class="keywordflow">break</span>; }
<a name="l00564"></a>00564                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==zvlnr) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[0]|= mask; <span class="keywordflow">break</span>; }
<a name="l00565"></a>00565                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[1]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[1]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]= mask; <span class="keywordflow">break</span>; }
<a name="l00566"></a>00566                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[1]==zvlnr) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[1]|= mask; <span class="keywordflow">break</span>; }
<a name="l00567"></a>00567                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[2]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[2]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]= mask; <span class="keywordflow">break</span>; }
<a name="l00568"></a>00568                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[2]==zvlnr) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[2]|= mask; <span class="keywordflow">break</span>; }
<a name="l00569"></a>00569                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==0) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[3]= obi; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]= zvlnr; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[3]= vergz; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]= mask; <span class="keywordflow">break</span>; }
<a name="l00570"></a>00570                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[3]==zvlnr) {apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[3]|= mask; <span class="keywordflow">break</span>; }
<a name="l00571"></a>00571                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>==0) apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a36f9e6cb0074118202fcae4edd06096a">addpsA</a>(zspan);
<a name="l00572"></a>00572                             apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>;
<a name="l00573"></a>00573                         }   
<a name="l00574"></a>00574                     }
<a name="l00575"></a>00575                 }
<a name="l00576"></a>00576             }
<a name="l00577"></a>00577             
<a name="l00578"></a>00578             v1[0]+= dx;
<a name="l00579"></a>00579             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00580"></a>00580             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 <span class="comment">/* *************  NORMAL ZBUFFER ************ */</span>
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a111f00929f4ba3d51b407ea61f3a2bd0">00587</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a111f00929f4ba3d51b407ea61f3a2bd0">zbufline</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *vec1, <span class="keywordtype">float</span> *vec2)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589     <span class="keywordtype">int</span> *rectz, *rectp, *recto, *rectmask;
<a name="l00590"></a>00590     <span class="keywordtype">int</span> start, end, x, y, oldx, oldy, ofs;
<a name="l00591"></a>00591     <span class="keywordtype">int</span> dz, vergz, maxtest= 0;
<a name="l00592"></a>00592     <span class="keywordtype">float</span> dx, dy;
<a name="l00593"></a>00593     <span class="keywordtype">float</span> v1[3], v2[3];
<a name="l00594"></a>00594     
<a name="l00595"></a>00595     dx= vec2[0]-vec1[0];
<a name="l00596"></a>00596     dy= vec2[1]-vec1[1];
<a name="l00597"></a>00597     
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dx) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dy)) {
<a name="l00599"></a>00599 
<a name="l00600"></a>00600         <span class="comment">/* all lines from left to right */</span>
<a name="l00601"></a>00601         <span class="keywordflow">if</span> (vec1[0]&lt;vec2[0]) {
<a name="l00602"></a>00602             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00603"></a>00603             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00604"></a>00604         }
<a name="l00605"></a>00605         <span class="keywordflow">else</span> {
<a name="l00606"></a>00606             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00607"></a>00607             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00608"></a>00608             dx= -dx; dy= -dy;
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611         start= floor(v1[0]);
<a name="l00612"></a>00612         end= start+floor(dx);
<a name="l00613"></a>00613         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>-1;
<a name="l00614"></a>00614         
<a name="l00615"></a>00615         oldy= floor(v1[1]);
<a name="l00616"></a>00616         dy/= dx;
<a name="l00617"></a>00617         
<a name="l00618"></a>00618         vergz= floor(v1[2]);
<a name="l00619"></a>00619         dz= floor((v2[2]-v1[2])/dx);
<a name="l00620"></a>00620         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00621"></a>00621         
<a name="l00622"></a>00622         rectz= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00623"></a>00623         rectp= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00624"></a>00624         recto= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00625"></a>00625         rectmask= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00626"></a>00626         
<a name="l00627"></a>00627         <span class="keywordflow">if</span> (dy&lt;0) ofs= -zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00628"></a>00628         <span class="keywordflow">else</span> ofs= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00629"></a>00629         
<a name="l00630"></a>00630         <span class="keywordflow">for</span> (x= start; x&lt;=end; x++, rectz++, rectp++, recto++, rectmask++) {
<a name="l00631"></a>00631             
<a name="l00632"></a>00632             y= floor(v1[1]);
<a name="l00633"></a>00633             <span class="keywordflow">if</span> (y!=oldy) {
<a name="l00634"></a>00634                 oldy= y;
<a name="l00635"></a>00635                 rectz+= ofs;
<a name="l00636"></a>00636                 rectp+= ofs;
<a name="l00637"></a>00637                 recto+= ofs;
<a name="l00638"></a>00638                 rectmask+= ofs;
<a name="l00639"></a>00639             }
<a name="l00640"></a>00640             
<a name="l00641"></a>00641             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; y&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>) {
<a name="l00642"></a>00642                 <span class="keywordflow">if</span> (vergz&lt;*rectz) {
<a name="l00643"></a>00643                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || vergz&gt;*rectmask) {
<a name="l00644"></a>00644                         *recto= obi;
<a name="l00645"></a>00645                         *rectz= vergz;
<a name="l00646"></a>00646                         *rectp= zvlnr;
<a name="l00647"></a>00647                     }
<a name="l00648"></a>00648                 }
<a name="l00649"></a>00649             }
<a name="l00650"></a>00650             
<a name="l00651"></a>00651             v1[1]+= dy;
<a name="l00652"></a>00652             
<a name="l00653"></a>00653             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00654"></a>00654             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657     <span class="keywordflow">else</span> {
<a name="l00658"></a>00658         <span class="comment">/* all lines from top to bottom */</span>
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (vec1[1]&lt;vec2[1]) {
<a name="l00660"></a>00660             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00661"></a>00661             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663         <span class="keywordflow">else</span> {
<a name="l00664"></a>00664             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00665"></a>00665             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00666"></a>00666             dx= -dx; dy= -dy;
<a name="l00667"></a>00667         }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         start= floor(v1[1]);
<a name="l00670"></a>00670         end= start+floor(dy);
<a name="l00671"></a>00671         
<a name="l00672"></a>00672         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>-1;
<a name="l00673"></a>00673         
<a name="l00674"></a>00674         oldx= floor(v1[0]);
<a name="l00675"></a>00675         dx/= dy;
<a name="l00676"></a>00676         
<a name="l00677"></a>00677         vergz= floor(v1[2]);
<a name="l00678"></a>00678         dz= floor((v2[2]-v1[2])/dy);
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00680"></a>00680         
<a name="l00681"></a>00681         rectz= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00682"></a>00682         rectp= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00683"></a>00683         recto= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00684"></a>00684         rectmask= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00685"></a>00685         
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (dx&lt;0) ofs= -1;
<a name="l00687"></a>00687         <span class="keywordflow">else</span> ofs= 1;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         <span class="keywordflow">for</span> (y= start; y&lt;=end; y++, rectz+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, rectp+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, recto+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, rectmask+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) {
<a name="l00690"></a>00690             
<a name="l00691"></a>00691             x= floor(v1[0]);
<a name="l00692"></a>00692             <span class="keywordflow">if</span> (x!=oldx) {
<a name="l00693"></a>00693                 oldx= x;
<a name="l00694"></a>00694                 rectz+= ofs;
<a name="l00695"></a>00695                 rectp+= ofs;
<a name="l00696"></a>00696                 recto+= ofs;
<a name="l00697"></a>00697                 rectmask+= ofs;
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699             
<a name="l00700"></a>00700             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; x&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>) {
<a name="l00701"></a>00701                 <span class="keywordflow">if</span> (vergz&lt;*rectz) {
<a name="l00702"></a>00702                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || vergz&gt;*rectmask) {
<a name="l00703"></a>00703                         *rectz= vergz;
<a name="l00704"></a>00704                         *rectp= zvlnr;
<a name="l00705"></a>00705                         *recto= obi;
<a name="l00706"></a>00706                     }
<a name="l00707"></a>00707                 }
<a name="l00708"></a>00708             }
<a name="l00709"></a>00709             
<a name="l00710"></a>00710             v1[0]+= dx;
<a name="l00711"></a>00711             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00712"></a>00712             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00713"></a>00713         }
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a0047be87acf9227da5e4fa0d03793cd9">00717</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a0047be87acf9227da5e4fa0d03793cd9">zbufline_onlyZ</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(obi), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(zvlnr), <span class="keywordtype">float</span> *vec1, <span class="keywordtype">float</span> *vec2)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719     <span class="keywordtype">int</span> *rectz, *rectz1= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00720"></a>00720     <span class="keywordtype">int</span> start, end, x, y, oldx, oldy, ofs;
<a name="l00721"></a>00721     <span class="keywordtype">int</span> dz, vergz, maxtest= 0;
<a name="l00722"></a>00722     <span class="keywordtype">float</span> dx, dy;
<a name="l00723"></a>00723     <span class="keywordtype">float</span> v1[3], v2[3];
<a name="l00724"></a>00724     
<a name="l00725"></a>00725     dx= vec2[0]-vec1[0];
<a name="l00726"></a>00726     dy= vec2[1]-vec1[1];
<a name="l00727"></a>00727     
<a name="l00728"></a>00728     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dx) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dy)) {
<a name="l00729"></a>00729         
<a name="l00730"></a>00730         <span class="comment">/* all lines from left to right */</span>
<a name="l00731"></a>00731         <span class="keywordflow">if</span> (vec1[0]&lt;vec2[0]) {
<a name="l00732"></a>00732             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00733"></a>00733             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00734"></a>00734         }
<a name="l00735"></a>00735         <span class="keywordflow">else</span> {
<a name="l00736"></a>00736             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00737"></a>00737             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00738"></a>00738             dx= -dx; dy= -dy;
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740         
<a name="l00741"></a>00741         start= floor(v1[0]);
<a name="l00742"></a>00742         end= start+floor(dx);
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>-1;
<a name="l00744"></a>00744         
<a name="l00745"></a>00745         oldy= floor(v1[1]);
<a name="l00746"></a>00746         dy/= dx;
<a name="l00747"></a>00747         
<a name="l00748"></a>00748         vergz= floor(v1[2]);
<a name="l00749"></a>00749         dz= floor((v2[2]-v1[2])/dx);
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00751"></a>00751         
<a name="l00752"></a>00752         rectz= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>)
<a name="l00754"></a>00754             rectz1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a> + oldy*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ start;
<a name="l00755"></a>00755         
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (dy&lt;0) ofs= -zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00757"></a>00757         <span class="keywordflow">else</span> ofs= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00758"></a>00758         
<a name="l00759"></a>00759         <span class="keywordflow">for</span> (x= start; x&lt;=end; x++, rectz++) {
<a name="l00760"></a>00760             
<a name="l00761"></a>00761             y= floor(v1[1]);
<a name="l00762"></a>00762             <span class="keywordflow">if</span> (y!=oldy) {
<a name="l00763"></a>00763                 oldy= y;
<a name="l00764"></a>00764                 rectz+= ofs;
<a name="l00765"></a>00765                 <span class="keywordflow">if</span> (rectz1) rectz1+= ofs;
<a name="l00766"></a>00766             }
<a name="l00767"></a>00767             
<a name="l00768"></a>00768             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; y&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>) {
<a name="l00769"></a>00769                 <span class="keywordflow">if</span> (vergz &lt; *rectz) {
<a name="l00770"></a>00770                     <span class="keywordflow">if</span> (rectz1) *rectz1= *rectz;
<a name="l00771"></a>00771                     *rectz= vergz;
<a name="l00772"></a>00772                 }
<a name="l00773"></a>00773                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rectz1 &amp;&amp; vergz &lt; *rectz1)
<a name="l00774"></a>00774                     *rectz1= vergz;
<a name="l00775"></a>00775             }
<a name="l00776"></a>00776             
<a name="l00777"></a>00777             v1[1]+= dy;
<a name="l00778"></a>00778             
<a name="l00779"></a>00779             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00780"></a>00780             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00781"></a>00781             
<a name="l00782"></a>00782             <span class="keywordflow">if</span> (rectz1) rectz1++;
<a name="l00783"></a>00783         }
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785     <span class="keywordflow">else</span> {
<a name="l00786"></a>00786         <span class="comment">/* all lines from top to bottom */</span>
<a name="l00787"></a>00787         <span class="keywordflow">if</span> (vec1[1]&lt;vec2[1]) {
<a name="l00788"></a>00788             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec1);
<a name="l00789"></a>00789             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec2);
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791         <span class="keywordflow">else</span> {
<a name="l00792"></a>00792             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vec1);
<a name="l00793"></a>00793             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vec2);
<a name="l00794"></a>00794             dx= -dx; dy= -dy;
<a name="l00795"></a>00795         }
<a name="l00796"></a>00796         
<a name="l00797"></a>00797         start= floor(v1[1]);
<a name="l00798"></a>00798         end= start+floor(dy);
<a name="l00799"></a>00799         
<a name="l00800"></a>00800         <span class="keywordflow">if</span> (end&gt;=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>) end= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab7930292e9ad2d1c9351b993461f86fa">recty</a>-1;
<a name="l00801"></a>00801         
<a name="l00802"></a>00802         oldx= floor(v1[0]);
<a name="l00803"></a>00803         dx/= dy;
<a name="l00804"></a>00804         
<a name="l00805"></a>00805         vergz= floor(v1[2]);
<a name="l00806"></a>00806         dz= floor((v2[2]-v1[2])/dy);
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (vergz&gt;0x50000000 &amp;&amp; dz&gt;0) maxtest= 1;       <span class="comment">// prevent overflow</span>
<a name="l00808"></a>00808         
<a name="l00809"></a>00809         rectz= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>)
<a name="l00811"></a>00811             rectz1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a> + start*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>+ oldx;
<a name="l00812"></a>00812         
<a name="l00813"></a>00813         <span class="keywordflow">if</span> (dx&lt;0) ofs= -1;
<a name="l00814"></a>00814         <span class="keywordflow">else</span> ofs= 1;
<a name="l00815"></a>00815         
<a name="l00816"></a>00816         <span class="keywordflow">for</span> (y= start; y&lt;=end; y++, rectz+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>) {
<a name="l00817"></a>00817             
<a name="l00818"></a>00818             x= floor(v1[0]);
<a name="l00819"></a>00819             <span class="keywordflow">if</span> (x!=oldx) {
<a name="l00820"></a>00820                 oldx= x;
<a name="l00821"></a>00821                 rectz+= ofs;
<a name="l00822"></a>00822                 <span class="keywordflow">if</span> (rectz1) rectz1+= ofs;
<a name="l00823"></a>00823             }
<a name="l00824"></a>00824             
<a name="l00825"></a>00825             <span class="keywordflow">if</span> (x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; x&lt;zspan-&gt;<a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>) {
<a name="l00826"></a>00826                 <span class="keywordflow">if</span> (vergz &lt; *rectz) {
<a name="l00827"></a>00827                     <span class="keywordflow">if</span> (rectz1) *rectz1= *rectz;
<a name="l00828"></a>00828                     *rectz= vergz;
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rectz1 &amp;&amp; vergz &lt; *rectz1)
<a name="l00831"></a>00831                     *rectz1= vergz;
<a name="l00832"></a>00832             }
<a name="l00833"></a>00833             
<a name="l00834"></a>00834             v1[0]+= dx;
<a name="l00835"></a>00835             <span class="keywordflow">if</span> (maxtest &amp;&amp; (vergz &gt; 0x7FFFFFF0 - dz)) vergz= 0x7FFFFFF0;
<a name="l00836"></a>00836             <span class="keywordflow">else</span> vergz+= dz;
<a name="l00837"></a>00837             
<a name="l00838"></a>00838             <span class="keywordflow">if</span> (rectz1)
<a name="l00839"></a>00839                 rectz1+=zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 
<a name="l00845"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">00845</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(<span class="keywordtype">float</span> v1[4], <span class="keywordtype">float</span> v2[4])   <span class="comment">/* return 0: do not draw */</span>
<a name="l00846"></a>00846 {
<a name="l00847"></a>00847     <span class="keywordtype">float</span> dz,dw, u1=0.0, u2=1.0;
<a name="l00848"></a>00848     <span class="keywordtype">float</span> dx, dy, v13;
<a name="l00849"></a>00849     
<a name="l00850"></a>00850     dz= v2[2]-v1[2];
<a name="l00851"></a>00851     dw= v2[3]-v1[3];
<a name="l00852"></a>00852     
<a name="l00853"></a>00853     <span class="comment">/* this 1.01 is for clipping x and y just a tinsy larger. that way it is</span>
<a name="l00854"></a>00854 <span class="comment">     * filled in with zbufwire correctly when rendering in parts. otherwise</span>
<a name="l00855"></a>00855 <span class="comment">     * you see line endings at edges... */</span>
<a name="l00856"></a>00856     
<a name="l00857"></a>00857     <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(-dz, -dw, v1[3], v1[2], &amp;u1,&amp;u2)) {
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(dz, -dw, v1[3], -v1[2], &amp;u1,&amp;u2)) {
<a name="l00859"></a>00859             
<a name="l00860"></a>00860             dx= v2[0]-v1[0];
<a name="l00861"></a>00861             dz= 1.01f*(v2[3]-v1[3]);
<a name="l00862"></a>00862             v13= 1.01f*v1[3];
<a name="l00863"></a>00863             
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(-dx, -dz, v1[0], v13, &amp;u1,&amp;u2)) {
<a name="l00865"></a>00865                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(dx, -dz, v13, -v1[0], &amp;u1,&amp;u2)) {
<a name="l00866"></a>00866                     
<a name="l00867"></a>00867                     dy= v2[1]-v1[1];
<a name="l00868"></a>00868                     
<a name="l00869"></a>00869                     <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(-dy, -dz, v1[1], v13, &amp;u1,&amp;u2)) {
<a name="l00870"></a>00870                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(dy, -dz, v13, -v1[1], &amp;u1,&amp;u2)) {
<a name="l00871"></a>00871                             
<a name="l00872"></a>00872                             <span class="keywordflow">if</span> (u2&lt;1.0f) {
<a name="l00873"></a>00873                                 v2[0]= v1[0]+u2*dx;
<a name="l00874"></a>00874                                 v2[1]= v1[1]+u2*dy;
<a name="l00875"></a>00875                                 v2[2]= v1[2]+u2*dz;
<a name="l00876"></a>00876                                 v2[3]= v1[3]+u2*dw;
<a name="l00877"></a>00877                             }
<a name="l00878"></a>00878                             <span class="keywordflow">if</span> (u1&gt;0.0f) {
<a name="l00879"></a>00879                                 v1[0]= v1[0]+u1*dx;
<a name="l00880"></a>00880                                 v1[1]= v1[1]+u1*dy;
<a name="l00881"></a>00881                                 v1[2]= v1[2]+u1*dz;
<a name="l00882"></a>00882                                 v1[3]= v1[3]+u1*dw;
<a name="l00883"></a>00883                             }
<a name="l00884"></a>00884                             <span class="keywordflow">return</span> 1;
<a name="l00885"></a>00885                         }
<a name="l00886"></a>00886                     }
<a name="l00887"></a>00887                 }
<a name="l00888"></a>00888             }
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891     
<a name="l00892"></a>00892     <span class="keywordflow">return</span> 0;
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a2c49c317ed0ca55d0a8e67b9e77fc760">00895</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">float</span> zco[3], <span class="keyword">const</span> <span class="keywordtype">float</span> hoco[4])
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00898"></a>00898     
<a name="l00899"></a>00899     div= 1.0f/hoco[3];
<a name="l00900"></a>00900     zco[0]= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>*(1.0f+hoco[0]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>) + zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>;
<a name="l00901"></a>00901     zco[1]= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>*(1.0f+hoco[1]*div) + zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>;
<a name="l00902"></a>00902     zco[2]= 0x7FFFFFFF *(hoco[2]*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a3a174acdf2ce667cda66d6028e103db2">00905</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">int</span> ec, <span class="keywordtype">float</span> *ho1, <span class="keywordtype">float</span> *ho2, <span class="keywordtype">float</span> *ho3, <span class="keywordtype">float</span> *ho4, <span class="keywordtype">int</span> c1, <span class="keywordtype">int</span> c2, <span class="keywordtype">int</span> c3, <span class="keywordtype">int</span> c4)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907     <span class="keywordtype">float</span> vez[20];
<a name="l00908"></a>00908     <span class="keywordtype">int</span> and, or;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="comment">/* edgecode: 1= draw */</span>
<a name="l00911"></a>00911     <span class="keywordflow">if</span> (ec==0) <span class="keywordflow">return</span>;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="keywordflow">if</span> (ho4) {
<a name="l00914"></a>00914         and= (c1 &amp; c2 &amp; c3 &amp; c4);
<a name="l00915"></a>00915         or= (c1 | c2 | c3 | c4);
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="keywordflow">else</span> {
<a name="l00918"></a>00918         and= (c1 &amp; c2 &amp; c3);
<a name="l00919"></a>00919         or= (c1 | c2 | c3);
<a name="l00920"></a>00920     }
<a name="l00921"></a>00921     
<a name="l00922"></a>00922     <span class="keywordflow">if</span> (or) {   <span class="comment">/* not in the middle */</span>
<a name="l00923"></a>00923         <span class="keywordflow">if</span> (and) {  <span class="comment">/* out completely */</span>
<a name="l00924"></a>00924             <span class="keywordflow">return</span>;
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926         <span class="keywordflow">else</span> {  <span class="comment">/* clipping */</span>
<a name="l00927"></a>00927 
<a name="l00928"></a>00928             <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>) {
<a name="l00929"></a>00929                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez, ho1);
<a name="l00930"></a>00930                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez+4, ho2);
<a name="l00931"></a>00931                 <span class="keywordflow">if</span> ( <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(vez, vez+4)) {
<a name="l00932"></a>00932                     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, vez);
<a name="l00933"></a>00933                     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, vez+4);
<a name="l00934"></a>00934                     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00935"></a>00935                 }
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937             <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>) {
<a name="l00938"></a>00938                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez, ho2);
<a name="l00939"></a>00939                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez+4, ho3);
<a name="l00940"></a>00940                 <span class="keywordflow">if</span> ( <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(vez, vez+4)) {
<a name="l00941"></a>00941                     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, vez);
<a name="l00942"></a>00942                     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, vez+4);
<a name="l00943"></a>00943                     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00944"></a>00944                 }
<a name="l00945"></a>00945             }
<a name="l00946"></a>00946             <span class="keywordflow">if</span> (ho4) {
<a name="l00947"></a>00947                 <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#ab3e2f26d87fb0176c50cf219942ba4dc">ME_V3V4</a>) {
<a name="l00948"></a>00948                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez, ho3);
<a name="l00949"></a>00949                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez+4, ho4);
<a name="l00950"></a>00950                     <span class="keywordflow">if</span> ( <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(vez, vez+4)) {
<a name="l00951"></a>00951                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, vez);
<a name="l00952"></a>00952                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, vez+4);
<a name="l00953"></a>00953                         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00954"></a>00954                     }
<a name="l00955"></a>00955                 }
<a name="l00956"></a>00956                 <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a4970f6686c7e83ca2d3b699bf44b3374">ME_V4V1</a>) {
<a name="l00957"></a>00957                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez, ho4);
<a name="l00958"></a>00958                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez+4, ho1);
<a name="l00959"></a>00959                     <span class="keywordflow">if</span> ( <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(vez, vez+4)) {
<a name="l00960"></a>00960                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, vez);
<a name="l00961"></a>00961                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, vez+4);
<a name="l00962"></a>00962                         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00963"></a>00963                     }
<a name="l00964"></a>00964                 }
<a name="l00965"></a>00965             }
<a name="l00966"></a>00966             <span class="keywordflow">else</span> {
<a name="l00967"></a>00967                 <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0ddfbc83d6d34b5cad84f40e0dcff92f">ME_V3V1</a>) {
<a name="l00968"></a>00968                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez, ho3);
<a name="l00969"></a>00969                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(vez+4, ho1);
<a name="l00970"></a>00970                     <span class="keywordflow">if</span> ( <a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(vez, vez+4)) {
<a name="l00971"></a>00971                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, vez);
<a name="l00972"></a>00972                         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, vez+4);
<a name="l00973"></a>00973                         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00974"></a>00974                     }
<a name="l00975"></a>00975                 }
<a name="l00976"></a>00976             }
<a name="l00977"></a>00977             
<a name="l00978"></a>00978             <span class="keywordflow">return</span>;
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, ho1);
<a name="l00983"></a>00983     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, ho2);
<a name="l00984"></a>00984     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+8, ho3);
<a name="l00985"></a>00985     <span class="keywordflow">if</span> (ho4) {
<a name="l00986"></a>00986         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+12, ho4);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#ab3e2f26d87fb0176c50cf219942ba4dc">ME_V3V4</a>)  zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez+8, vez+12);
<a name="l00989"></a>00989         <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a4970f6686c7e83ca2d3b699bf44b3374">ME_V4V1</a>)  zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez+12, vez);
<a name="l00990"></a>00990     }
<a name="l00991"></a>00991     <span class="keywordflow">else</span> {
<a name="l00992"></a>00992         <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0ddfbc83d6d34b5cad84f40e0dcff92f">ME_V3V1</a>)  zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez+8, vez);
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6525a23607da30e610c4efd11451fa7a">ME_V1V2</a>)  zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez, vez+4);
<a name="l00996"></a>00996     <span class="keywordflow">if</span> (ec &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a639325093e56f9b672e1d30d88caa4ac">ME_V2V3</a>)  zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, vez+4, vez+8);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 
<a name="l01000"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a2e9997cab6ffa75e4c4992a8647cd9cc">01000</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a34b656e98ebe13a6250b11cc2f3da4b0">zbufsinglewire</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keyword">const</span> <span class="keywordtype">float</span> ho1[4], <span class="keyword">const</span> <span class="keywordtype">float</span> ho2[4])
<a name="l01001"></a>01001 {
<a name="l01002"></a>01002     <span class="keywordtype">float</span> f1[4], f2[4];
<a name="l01003"></a>01003     <span class="keywordtype">int</span> c1, c2;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005     c1= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho1);
<a name="l01006"></a>01006     c2= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho2);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (c1 | c2) {  <span class="comment">/* not in the middle */</span>
<a name="l01009"></a>01009         <span class="keywordflow">if</span> (!(c1 &amp; c2)) {   <span class="comment">/* not out completely */</span>
<a name="l01010"></a>01010             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(f1, ho1);
<a name="l01011"></a>01011             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(f2, ho2);
<a name="l01012"></a>01012 
<a name="l01013"></a>01013             <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a68f8652927b67c37aa2c99406e453db9">clipline</a>(f1, f2)) {
<a name="l01014"></a>01014                 <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, f1, f1);
<a name="l01015"></a>01015                 <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, f2, f2);
<a name="l01016"></a>01016                 zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, f1, f2);
<a name="l01017"></a>01017             }
<a name="l01018"></a>01018         }
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020     <span class="keywordflow">else</span> {
<a name="l01021"></a>01021         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, f1, ho1);
<a name="l01022"></a>01022         <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, f2, ho2);
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>(zspan, obi, zvlnr, f1, f2);
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01040"></a>01040 <span class="comment">/* WATCH IT: zbuffillGLinv4 and zbuffillGL4 are identical except for a 2 lines,</span>
<a name="l01041"></a>01041 <span class="comment"> * commented below */</span>
<a name="l01042"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1010a528900d52393ac8a971fcbc9ac4">01042</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a1010a528900d52393ac8a971fcbc9ac4">zbuffillGLinv4</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4) 
<a name="l01043"></a>01043 {
<a name="l01044"></a>01044     <span class="keywordtype">double</span> zxd, zyd, zy0, zverg;
<a name="l01045"></a>01045     <span class="keywordtype">float</span> x0,y0,z0;
<a name="l01046"></a>01046     <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xx1;
<a name="l01047"></a>01047     <span class="keywordtype">float</span> *span1, *span2;
<a name="l01048"></a>01048     <span class="keywordtype">int</span> *rectoofs, *ro;
<a name="l01049"></a>01049     <span class="keywordtype">int</span> *rectpofs, *rp;
<a name="l01050"></a>01050     <span class="keywordtype">int</span> *rectmaskofs, *rm;
<a name="l01051"></a>01051     <span class="keywordtype">int</span> *rz, x, y;
<a name="l01052"></a>01052     <span class="keywordtype">int</span> sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, *rectzofs, my0, my2;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="comment">/* init */</span>
<a name="l01055"></a>01055     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <span class="comment">/* set spans */</span>
<a name="l01058"></a>01058     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l01059"></a>01059     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l01060"></a>01060     <span class="keywordflow">if</span> (v4) {
<a name="l01061"></a>01061         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l01062"></a>01062         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064     <span class="keywordflow">else</span>
<a name="l01065"></a>01065         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     <span class="comment">/* clipped */</span>
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l01071"></a>01071     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 
<a name="l01077"></a>01077     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l01078"></a>01078     x1= v1[0]- v2[0];
<a name="l01079"></a>01079     x2= v2[0]- v3[0];
<a name="l01080"></a>01080     y1= v1[1]- v2[1];
<a name="l01081"></a>01081     y2= v2[1]- v3[1];
<a name="l01082"></a>01082     z1= v1[2]- v2[2];
<a name="l01083"></a>01083     z2= v2[2]- v3[2];
<a name="l01084"></a>01084     x0= y1*z2-z1*y2;
<a name="l01085"></a>01085     y0= z1*x2-x1*z2;
<a name="l01086"></a>01086     z0= x1*y2-y1*x2;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01093"></a>01093     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01094"></a>01094     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="comment">/* start-offset in rect */</span>
<a name="l01097"></a>01097     rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l01098"></a>01098     rectzofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>+rectx*my2);
<a name="l01099"></a>01099     rectpofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>+rectx*my2);
<a name="l01100"></a>01100     rectoofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>+rectx*my2);
<a name="l01101"></a>01101     rectmaskofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>+rectx*my2);
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment">/* correct span */</span>
<a name="l01104"></a>01104     sn1= (my0 + my2)/2;
<a name="l01105"></a>01105     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l01106"></a>01106         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01107"></a>01107         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109     <span class="keywordflow">else</span> {
<a name="l01110"></a>01110         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01111"></a>01111         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l01115"></a>01115 
<a name="l01116"></a>01116         sn1= floor(*span1);
<a name="l01117"></a>01117         sn2= floor(*span2);
<a name="l01118"></a>01118         sn1++;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l01121"></a>01121         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (sn2&gt;=sn1) {
<a name="l01124"></a>01124             <span class="keywordtype">int</span> intzverg;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126             zverg= (double)sn1*zxd + zy0;
<a name="l01127"></a>01127             rz= rectzofs+sn1;
<a name="l01128"></a>01128             rp= rectpofs+sn1;
<a name="l01129"></a>01129             ro= rectoofs+sn1;
<a name="l01130"></a>01130             rm= rectmaskofs+sn1;
<a name="l01131"></a>01131             x= sn2-sn1;
<a name="l01132"></a>01132 
<a name="l01133"></a>01133             <span class="keywordflow">while</span> (x&gt;=0) {
<a name="l01134"></a>01134                 intzverg= (int)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(zverg, INT_MIN, INT_MAX);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136                 <span class="keywordflow">if</span> ( intzverg &gt; *rz || *rz==0x7FFFFFFF) { <span class="comment">/* UNIQUE LINE: see comment above */</span>
<a name="l01137"></a>01137                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || intzverg &gt; *rm) {
<a name="l01138"></a>01138                         *ro= obi; <span class="comment">/* UNIQUE LINE: see comment above (order differs) */</span>
<a name="l01139"></a>01139                         *rz= intzverg;
<a name="l01140"></a>01140                         *rp= zvlnr;
<a name="l01141"></a>01141                     }
<a name="l01142"></a>01142                 }
<a name="l01143"></a>01143                 zverg+= zxd;
<a name="l01144"></a>01144                 rz++;
<a name="l01145"></a>01145                 rp++;
<a name="l01146"></a>01146                 ro++;
<a name="l01147"></a>01147                 rm++;
<a name="l01148"></a>01148                 x--;
<a name="l01149"></a>01149             }
<a name="l01150"></a>01150         }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152         zy0-=zyd;
<a name="l01153"></a>01153         rectzofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01154"></a>01154         rectpofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01155"></a>01155         rectoofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01156"></a>01156         rectmaskofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 <span class="comment">/* uses spanbuffers */</span>
<a name="l01161"></a>01161 
<a name="l01162"></a>01162 <span class="comment">/* WATCH IT: zbuffillGLinv4 and zbuffillGL4 are identical except for a 2 lines,</span>
<a name="l01163"></a>01163 <span class="comment"> * commented below */</span>
<a name="l01164"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a079762cfb1176e8507933905fcb30d2c">01164</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a079762cfb1176e8507933905fcb30d2c">zbuffillGL4</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166     <span class="keywordtype">double</span> zxd, zyd, zy0, zverg;
<a name="l01167"></a>01167     <span class="keywordtype">float</span> x0,y0,z0;
<a name="l01168"></a>01168     <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xx1;
<a name="l01169"></a>01169     <span class="keywordtype">float</span> *span1, *span2;
<a name="l01170"></a>01170     <span class="keywordtype">int</span> *rectoofs, *ro;
<a name="l01171"></a>01171     <span class="keywordtype">int</span> *rectpofs, *rp;
<a name="l01172"></a>01172     <span class="keywordtype">int</span> *rectmaskofs, *rm;
<a name="l01173"></a>01173     <span class="keywordtype">int</span> *rz, x, y;
<a name="l01174"></a>01174     <span class="keywordtype">int</span> sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, *rectzofs, my0, my2;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176     <span class="comment">/* init */</span>
<a name="l01177"></a>01177     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179     <span class="comment">/* set spans */</span>
<a name="l01180"></a>01180     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l01181"></a>01181     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (v4) {
<a name="l01183"></a>01183         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l01184"></a>01184         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l01185"></a>01185     }
<a name="l01186"></a>01186     <span class="keywordflow">else</span>
<a name="l01187"></a>01187         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="comment">/* clipped */</span>
<a name="l01190"></a>01190     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l01193"></a>01193     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l01196"></a>01196     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l01200"></a>01200     x1= v1[0]- v2[0];
<a name="l01201"></a>01201     x2= v2[0]- v3[0];
<a name="l01202"></a>01202     y1= v1[1]- v2[1];
<a name="l01203"></a>01203     y2= v2[1]- v3[1];
<a name="l01204"></a>01204     z1= v1[2]- v2[2];
<a name="l01205"></a>01205     z2= v2[2]- v3[2];
<a name="l01206"></a>01206     x0= y1*z2-z1*y2;
<a name="l01207"></a>01207     y0= z1*x2-x1*z2;
<a name="l01208"></a>01208     z0= x1*y2-y1*x2;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01215"></a>01215     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01216"></a>01216     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="comment">/* start-offset in rect */</span>
<a name="l01219"></a>01219     rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l01220"></a>01220     rectzofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>+rectx*my2);
<a name="l01221"></a>01221     rectpofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>+rectx*my2);
<a name="l01222"></a>01222     rectoofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>+rectx*my2);
<a name="l01223"></a>01223     rectmaskofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>+rectx*my2);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225     <span class="comment">/* correct span */</span>
<a name="l01226"></a>01226     sn1= (my0 + my2)/2;
<a name="l01227"></a>01227     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l01228"></a>01228         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01229"></a>01229         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231     <span class="keywordflow">else</span> {
<a name="l01232"></a>01232         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01233"></a>01233         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01234"></a>01234     }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         sn1= floor(*span1);
<a name="l01239"></a>01239         sn2= floor(*span2);
<a name="l01240"></a>01240         sn1++;
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l01243"></a>01243         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l01244"></a>01244 
<a name="l01245"></a>01245         <span class="keywordflow">if</span> (sn2&gt;=sn1) {
<a name="l01246"></a>01246             <span class="keywordtype">int</span> intzverg;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248             zverg= (double)sn1*zxd + zy0;
<a name="l01249"></a>01249             rz= rectzofs+sn1;
<a name="l01250"></a>01250             rp= rectpofs+sn1;
<a name="l01251"></a>01251             ro= rectoofs+sn1;
<a name="l01252"></a>01252             rm= rectmaskofs+sn1;
<a name="l01253"></a>01253             x= sn2-sn1;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255             <span class="keywordflow">while</span> (x&gt;=0) {
<a name="l01256"></a>01256                 intzverg= (int)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(zverg, INT_MIN, INT_MAX);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258                 <span class="keywordflow">if</span> (intzverg &lt; *rz) { <span class="comment">/* ONLY UNIQUE LINE: see comment above */</span>
<a name="l01259"></a>01259                     <span class="keywordflow">if</span> (!zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a> || intzverg &gt; *rm) {
<a name="l01260"></a>01260                         *rz= intzverg;
<a name="l01261"></a>01261                         *rp= zvlnr;
<a name="l01262"></a>01262                         *ro= obi; <span class="comment">/* UNIQUE LINE: see comment above (order differs) */</span>
<a name="l01263"></a>01263                     }
<a name="l01264"></a>01264                 }
<a name="l01265"></a>01265                 zverg+= zxd;
<a name="l01266"></a>01266                 rz++;
<a name="l01267"></a>01267                 rp++;
<a name="l01268"></a>01268                 ro++;
<a name="l01269"></a>01269                 rm++;
<a name="l01270"></a>01270                 x--;
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272         }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274         zy0-=zyd;
<a name="l01275"></a>01275         rectzofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01276"></a>01276         rectpofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01277"></a>01277         rectoofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01278"></a>01278         rectmaskofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280 }
<a name="l01281"></a>01281 
<a name="l01293"></a>01293 <span class="comment">/* now: filling two Z values, the closest and 2nd closest */</span>
<a name="l01294"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ad494dc9ff0167ddaa3184cffc3cf849e">01294</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ad494dc9ff0167ddaa3184cffc3cf849e">zbuffillGL_onlyZ</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(obi), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(zvlnr), <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l01295"></a>01295 {
<a name="l01296"></a>01296     <span class="keywordtype">double</span> zxd, zyd, zy0, zverg;
<a name="l01297"></a>01297     <span class="keywordtype">float</span> x0,y0,z0;
<a name="l01298"></a>01298     <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xx1;
<a name="l01299"></a>01299     <span class="keywordtype">float</span> *span1, *span2;
<a name="l01300"></a>01300     <span class="keywordtype">int</span> *rz, *rz1, x, y;
<a name="l01301"></a>01301     <span class="keywordtype">int</span> sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, *rectzofs, *rectzofs1= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, my0, my2;
<a name="l01302"></a>01302     
<a name="l01303"></a>01303     <span class="comment">/* init */</span>
<a name="l01304"></a>01304     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l01305"></a>01305     
<a name="l01306"></a>01306     <span class="comment">/* set spans */</span>
<a name="l01307"></a>01307     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l01308"></a>01308     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l01309"></a>01309     <span class="keywordflow">if</span> (v4) {
<a name="l01310"></a>01310         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l01311"></a>01311         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l01312"></a>01312     }
<a name="l01313"></a>01313     <span class="keywordflow">else</span> 
<a name="l01314"></a>01314         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l01315"></a>01315     
<a name="l01316"></a>01316     <span class="comment">/* clipped */</span>
<a name="l01317"></a>01317     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01318"></a>01318     
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l01320"></a>01320     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l01321"></a>01321     
<a name="l01322"></a>01322     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l01323"></a>01323     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l01324"></a>01324     
<a name="l01325"></a>01325     
<a name="l01326"></a>01326     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l01327"></a>01327     x1= v1[0]- v2[0];
<a name="l01328"></a>01328     x2= v2[0]- v3[0];
<a name="l01329"></a>01329     y1= v1[1]- v2[1];
<a name="l01330"></a>01330     y2= v2[1]- v3[1];
<a name="l01331"></a>01331     z1= v1[2]- v2[2];
<a name="l01332"></a>01332     z2= v2[2]- v3[2];
<a name="l01333"></a>01333     x0= y1*z2-z1*y2;
<a name="l01334"></a>01334     y0= z1*x2-x1*z2;
<a name="l01335"></a>01335     z0= x1*y2-y1*x2;
<a name="l01336"></a>01336     
<a name="l01337"></a>01337     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l01338"></a>01338     
<a name="l01339"></a>01339     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l01340"></a>01340     
<a name="l01341"></a>01341     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01342"></a>01342     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01343"></a>01343     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l01344"></a>01344     
<a name="l01345"></a>01345     <span class="comment">/* start-offset in rect */</span>
<a name="l01346"></a>01346     rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l01347"></a>01347     rectzofs= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>+rectx*my2);
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>)
<a name="l01349"></a>01349         rectzofs1= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>+rectx*my2);
<a name="l01350"></a>01350     
<a name="l01351"></a>01351     <span class="comment">/* correct span */</span>
<a name="l01352"></a>01352     sn1= (my0 + my2)/2;
<a name="l01353"></a>01353     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l01354"></a>01354         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01355"></a>01355         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01356"></a>01356     }
<a name="l01357"></a>01357     <span class="keywordflow">else</span> {
<a name="l01358"></a>01358         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01359"></a>01359         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     
<a name="l01362"></a>01362     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l01363"></a>01363         
<a name="l01364"></a>01364         sn1= floor(*span1);
<a name="l01365"></a>01365         sn2= floor(*span2);
<a name="l01366"></a>01366         sn1++; 
<a name="l01367"></a>01367         
<a name="l01368"></a>01368         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l01369"></a>01369         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l01370"></a>01370         
<a name="l01371"></a>01371         <span class="keywordflow">if</span> (sn2&gt;=sn1) {
<a name="l01372"></a>01372             zverg= (double)sn1*zxd + zy0;
<a name="l01373"></a>01373             rz= rectzofs+sn1;
<a name="l01374"></a>01374             rz1= rectzofs1+sn1;
<a name="l01375"></a>01375             x= sn2-sn1;
<a name="l01376"></a>01376             
<a name="l01377"></a>01377             <span class="keywordflow">while</span> (x&gt;=0) {
<a name="l01378"></a>01378                 <span class="keywordtype">int</span> zvergi= (int)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(zverg, INT_MIN, INT_MAX);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380                 <span class="comment">/* option: maintain two depth values, closest and 2nd closest */</span>
<a name="l01381"></a>01381                 <span class="keywordflow">if</span> (zvergi &lt; *rz) {
<a name="l01382"></a>01382                     <span class="keywordflow">if</span> (rectzofs1) *rz1= *rz;
<a name="l01383"></a>01383                     *rz= zvergi;
<a name="l01384"></a>01384                 }
<a name="l01385"></a>01385                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rectzofs1 &amp;&amp; zvergi &lt; *rz1)
<a name="l01386"></a>01386                     *rz1= zvergi;
<a name="l01387"></a>01387 
<a name="l01388"></a>01388                 zverg+= zxd;
<a name="l01389"></a>01389                 
<a name="l01390"></a>01390                 rz++; 
<a name="l01391"></a>01391                 rz1++;
<a name="l01392"></a>01392                 x--;
<a name="l01393"></a>01393             }
<a name="l01394"></a>01394         }
<a name="l01395"></a>01395         
<a name="l01396"></a>01396         zy0-=zyd;
<a name="l01397"></a>01397         rectzofs-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01398"></a>01398         <span class="keywordflow">if</span> (rectzofs1) rectzofs1-= <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>;
<a name="l01399"></a>01399     }
<a name="l01400"></a>01400 }
<a name="l01401"></a>01401 
<a name="l01402"></a>01402 <span class="comment">/* 2d scanconvert for tria, calls func for each x,y coordinate and gives UV barycentrics */</span>
<a name="l01403"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a3d23e1e42d175fd98e6617e0635aafe6">01403</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a3d23e1e42d175fd98e6617e0635aafe6">zspan_scanconvert_strand</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">void</span> *handle, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">void</span> (*func)(<span class="keywordtype">void</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>) )
<a name="l01404"></a>01404 {
<a name="l01405"></a>01405     <span class="keywordtype">float</span> x0, y0, x1, y1, x2, y2, z0, z1, z2, z;
<a name="l01406"></a>01406     <span class="keywordtype">float</span> u, v, uxd, uyd, vxd, vyd, uy0, vy0, zxd, zyd, zy0, xx1;
<a name="l01407"></a>01407     <span class="keywordtype">float</span> *span1, *span2;
<a name="l01408"></a>01408     <span class="keywordtype">int</span> x, y, sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, my0, my2;
<a name="l01409"></a>01409     
<a name="l01410"></a>01410     <span class="comment">/* init */</span>
<a name="l01411"></a>01411     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l01412"></a>01412     
<a name="l01413"></a>01413     <span class="comment">/* set spans */</span>
<a name="l01414"></a>01414     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l01415"></a>01415     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l01416"></a>01416     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l01417"></a>01417     
<a name="l01418"></a>01418     <span class="comment">/* clipped */</span>
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01420"></a>01420     
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l01423"></a>01423     
<a name="l01424"></a>01424     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l01425"></a>01425     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l01426"></a>01426     
<a name="l01427"></a>01427     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l01428"></a>01428     x1= v1[0]- v2[0];
<a name="l01429"></a>01429     x2= v2[0]- v3[0];
<a name="l01430"></a>01430     y1= v1[1]- v2[1];
<a name="l01431"></a>01431     y2= v2[1]- v3[1];
<a name="l01432"></a>01432     z1= v1[2]- v2[2];
<a name="l01433"></a>01433     z2= v2[2]- v3[2];
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     x0= y1*z2-z1*y2;
<a name="l01436"></a>01436     y0= z1*x2-x1*z2;
<a name="l01437"></a>01437     z0= x1*y2-y1*x2;
<a name="l01438"></a>01438     
<a name="l01439"></a>01439     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l01442"></a>01442     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01443"></a>01443     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01444"></a>01444     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l01445"></a>01445     
<a name="l01446"></a>01446     z1= 1.0f; <span class="comment">// (u1 - u2)</span>
<a name="l01447"></a>01447     z2= 0.0f; <span class="comment">// (u2 - u3)</span>
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     x0= y1*z2-z1*y2;
<a name="l01450"></a>01450     y0= z1*x2-x1*z2;
<a name="l01451"></a>01451     
<a name="l01452"></a>01452     xx1= (x0*v1[0] + y0*v1[1])/z0 + 1.0f;   
<a name="l01453"></a>01453     uxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01454"></a>01454     uyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01455"></a>01455     uy0= ((double)my2)*uyd + (double)xx1;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     z1= -1.0f; <span class="comment">// (v1 - v2)</span>
<a name="l01458"></a>01458     z2= 1.0f;  <span class="comment">// (v2 - v3)</span>
<a name="l01459"></a>01459     
<a name="l01460"></a>01460     x0= y1*z2-z1*y2;
<a name="l01461"></a>01461     y0= z1*x2-x1*z2;
<a name="l01462"></a>01462     
<a name="l01463"></a>01463     xx1= (x0*v1[0] + y0*v1[1])/z0;
<a name="l01464"></a>01464     vxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01465"></a>01465     vyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01466"></a>01466     vy0= ((double)my2)*vyd + (double)xx1;
<a name="l01467"></a>01467     
<a name="l01468"></a>01468     <span class="comment">/* correct span */</span>
<a name="l01469"></a>01469     sn1= (my0 + my2)/2;
<a name="l01470"></a>01470     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l01471"></a>01471         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01472"></a>01472         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01473"></a>01473     }
<a name="l01474"></a>01474     <span class="keywordflow">else</span> {
<a name="l01475"></a>01475         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01476"></a>01476         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01477"></a>01477     }
<a name="l01478"></a>01478     
<a name="l01479"></a>01479     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l01480"></a>01480         
<a name="l01481"></a>01481         sn1= floor(*span1);
<a name="l01482"></a>01482         sn2= floor(*span2);
<a name="l01483"></a>01483         sn1++; 
<a name="l01484"></a>01484         
<a name="l01485"></a>01485         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l01486"></a>01486         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l01487"></a>01487         
<a name="l01488"></a>01488         u= (double)sn1*uxd + uy0;
<a name="l01489"></a>01489         v= (double)sn1*vxd + vy0;
<a name="l01490"></a>01490         z= (double)sn1*zxd + zy0;
<a name="l01491"></a>01491         
<a name="l01492"></a>01492         <span class="keywordflow">for</span> (x= sn1; x&lt;=sn2; x++, u+=uxd, v+=vxd, z+=zxd)
<a name="l01493"></a>01493             func(handle, x, y, u, v, z);
<a name="l01494"></a>01494         
<a name="l01495"></a>01495         uy0 -= uyd;
<a name="l01496"></a>01496         vy0 -= vyd;
<a name="l01497"></a>01497         zy0 -= zyd;
<a name="l01498"></a>01498     }
<a name="l01499"></a>01499 }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501 <span class="comment">/* scanconvert for strand triangles, calls func for each x,y coordinate and gives UV barycentrics and z */</span>
<a name="l01502"></a>01502 
<a name="l01503"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a40ff38ec87d8656cc10a0c13a19b8bc1">01503</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a3d29c2295a2fea795b2a5924f5bd885b">zspan_scanconvert</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">void</span> *handle, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">void</span> (*func)(<span class="keywordtype">void</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>) )
<a name="l01504"></a>01504 {
<a name="l01505"></a>01505     <span class="keywordtype">float</span> x0, y0, x1, y1, x2, y2, z0, z1, z2;
<a name="l01506"></a>01506     <span class="keywordtype">float</span> u, v, uxd, uyd, vxd, vyd, uy0, vy0, xx1;
<a name="l01507"></a>01507     <span class="keywordtype">float</span> *span1, *span2;
<a name="l01508"></a>01508     <span class="keywordtype">int</span> x, y, sn1, sn2, <a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, my0, my2;
<a name="l01509"></a>01509     
<a name="l01510"></a>01510     <span class="comment">/* init */</span>
<a name="l01511"></a>01511     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l01512"></a>01512     
<a name="l01513"></a>01513     <span class="comment">/* set spans */</span>
<a name="l01514"></a>01514     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l01515"></a>01515     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l01516"></a>01516     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l01517"></a>01517     
<a name="l01518"></a>01518     <span class="comment">/* clipped */</span>
<a name="l01519"></a>01519     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01520"></a>01520     
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l01522"></a>01522     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l01523"></a>01523     
<a name="l01524"></a>01524     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l01525"></a>01525     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l01526"></a>01526     
<a name="l01527"></a>01527     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l01528"></a>01528     x1= v1[0]- v2[0];
<a name="l01529"></a>01529     x2= v2[0]- v3[0];
<a name="l01530"></a>01530     y1= v1[1]- v2[1];
<a name="l01531"></a>01531     y2= v2[1]- v3[1];
<a name="l01532"></a>01532     
<a name="l01533"></a>01533     z1= 1.0f; <span class="comment">// (u1 - u2)</span>
<a name="l01534"></a>01534     z2= 0.0f; <span class="comment">// (u2 - u3)</span>
<a name="l01535"></a>01535     
<a name="l01536"></a>01536     x0= y1*z2-z1*y2;
<a name="l01537"></a>01537     y0= z1*x2-x1*z2;
<a name="l01538"></a>01538     z0= x1*y2-y1*x2;
<a name="l01539"></a>01539     
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l01541"></a>01541     
<a name="l01542"></a>01542     xx1= (x0*v1[0] + y0*v1[1])/z0 + 1.0f;   
<a name="l01543"></a>01543     uxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01544"></a>01544     uyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01545"></a>01545     uy0= ((double)my2)*uyd + (double)xx1;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     z1= -1.0f; <span class="comment">// (v1 - v2)</span>
<a name="l01548"></a>01548     z2= 1.0f;  <span class="comment">// (v2 - v3)</span>
<a name="l01549"></a>01549     
<a name="l01550"></a>01550     x0= y1*z2-z1*y2;
<a name="l01551"></a>01551     y0= z1*x2-x1*z2;
<a name="l01552"></a>01552     
<a name="l01553"></a>01553     xx1= (x0*v1[0] + y0*v1[1])/z0;
<a name="l01554"></a>01554     vxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l01555"></a>01555     vyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l01556"></a>01556     vy0= ((double)my2)*vyd + (double)xx1;
<a name="l01557"></a>01557     
<a name="l01558"></a>01558     <span class="comment">/* correct span */</span>
<a name="l01559"></a>01559     sn1= (my0 + my2)/2;
<a name="l01560"></a>01560     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l01561"></a>01561         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01562"></a>01562         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564     <span class="keywordflow">else</span> {
<a name="l01565"></a>01565         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l01566"></a>01566         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568     
<a name="l01569"></a>01569     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l01570"></a>01570         
<a name="l01571"></a>01571         sn1= floor(*span1);
<a name="l01572"></a>01572         sn2= floor(*span2);
<a name="l01573"></a>01573         sn1++; 
<a name="l01574"></a>01574         
<a name="l01575"></a>01575         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l01576"></a>01576         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l01577"></a>01577         
<a name="l01578"></a>01578         u= (double)sn1*uxd + uy0;
<a name="l01579"></a>01579         v= (double)sn1*vxd + vy0;
<a name="l01580"></a>01580         
<a name="l01581"></a>01581         <span class="keywordflow">for</span> (x= sn1; x&lt;=sn2; x++, u+=uxd, v+=vxd)
<a name="l01582"></a>01582             func(handle, x, y, u, v);
<a name="l01583"></a>01583         
<a name="l01584"></a>01584         uy0 -= uyd;
<a name="l01585"></a>01585         vy0 -= vyd;
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587 }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 
<a name="l01590"></a>01590 
<a name="l01604"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a858652357dfef40f9d34cce37f4ec10a">01604</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a858652357dfef40f9d34cce37f4ec10a">clippyra</a>(<span class="keywordtype">float</span> *labda, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">int</span> *b2, <span class="keywordtype">int</span> *b3, <span class="keywordtype">int</span> a, <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a009950f9a9e7f4fa4709c80fa7e82089">clipcrop</a>)
<a name="l01605"></a>01605 {
<a name="l01606"></a>01606     <span class="keywordtype">float</span> da,dw,u1=0.0,u2=1.0;
<a name="l01607"></a>01607     <span class="keywordtype">float</span> v13;
<a name="l01608"></a>01608     
<a name="l01609"></a>01609     labda[0]= -1.0;
<a name="l01610"></a>01610     labda[1]= -1.0;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     da= v2[a]-v1[a];
<a name="l01613"></a>01613     <span class="comment">/* prob; we clip slightly larger, osa renders add 2 pixels on edges, should become variable? */</span>
<a name="l01614"></a>01614     <span class="comment">/* or better; increase r.winx/y size, but thats quite a complex one. do it later */</span>
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (a==2) {
<a name="l01616"></a>01616         dw= (v2[3]-v1[3]);
<a name="l01617"></a>01617         v13= v1[3];
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619     <span class="keywordflow">else</span> {
<a name="l01620"></a>01620         dw= clipcrop*(v2[3]-v1[3]);
<a name="l01621"></a>01621         v13= clipcrop*v1[3];
<a name="l01622"></a>01622     }   
<a name="l01623"></a>01623     <span class="comment">/* according the original article by Liang&amp;Barsky, for clipping of</span>
<a name="l01624"></a>01624 <span class="comment">     * homogenous coordinates with viewplane, the value of &quot;0&quot; is used instead of &quot;-w&quot; .</span>
<a name="l01625"></a>01625 <span class="comment">     * This differs from the other clipping cases (like left or top) and I considered</span>
<a name="l01626"></a>01626 <span class="comment">     * it to be not so &#39;homogenic&#39;. But later it has proven to be an error,</span>
<a name="l01627"></a>01627 <span class="comment">     * who would have thought that of L&amp;B!</span>
<a name="l01628"></a>01628 <span class="comment">     */</span>
<a name="l01629"></a>01629 
<a name="l01630"></a>01630     <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(-da, -dw, v13, v1[a], &amp;u1,&amp;u2)) {
<a name="l01631"></a>01631         <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#a4560fc55f3cce1160aeda7522b74b097">cliptestf</a>(da, -dw, v13, -v1[a], &amp;u1,&amp;u2)) {
<a name="l01632"></a>01632             *b3=1;
<a name="l01633"></a>01633             <span class="keywordflow">if</span> (u2&lt;1.0f) {
<a name="l01634"></a>01634                 labda[1]= u2;
<a name="l01635"></a>01635                 *b2=1;
<a name="l01636"></a>01636             }
<a name="l01637"></a>01637             <span class="keywordflow">else</span> labda[1]=1.0;  <span class="comment">/* u2 */</span>
<a name="l01638"></a>01638             <span class="keywordflow">if</span> (u1&gt;0.0f) {
<a name="l01639"></a>01639                 labda[0] = u1;
<a name="l01640"></a>01640                 *b2 = 1;
<a name="l01641"></a>01641             }
<a name="l01642"></a>01642             <span class="keywordflow">else</span> {
<a name="l01643"></a>01643                 labda[0] = 0.0;
<a name="l01644"></a>01644             }
<a name="l01645"></a>01645         }
<a name="l01646"></a>01646     }
<a name="l01647"></a>01647 }
<a name="l01648"></a>01648 
<a name="l01664"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a880ac569e80b191a72e4145c3987f1b2">01664</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a880ac569e80b191a72e4145c3987f1b2">makevertpyra</a>(<span class="keywordtype">float</span> *vez, <span class="keywordtype">float</span> *labda, <span class="keywordtype">float</span> **trias, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">int</span> *b1, <span class="keywordtype">int</span> *clve)
<a name="l01665"></a>01665 {
<a name="l01666"></a>01666     <span class="keywordtype">float</span> l1, l2, *adr;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     l1= labda[0];
<a name="l01669"></a>01669     l2= labda[1];
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     <span class="keywordflow">if</span> (l1!= -1.0f) {
<a name="l01672"></a>01672         <span class="keywordflow">if</span> (l1!= 0.0f) {
<a name="l01673"></a>01673             adr= vez+4*(*clve);
<a name="l01674"></a>01674             trias[*b1]=adr;
<a name="l01675"></a>01675             (*clve)++;
<a name="l01676"></a>01676             adr[0]= v1[0]+l1*(v2[0]-v1[0]);
<a name="l01677"></a>01677             adr[1]= v1[1]+l1*(v2[1]-v1[1]);
<a name="l01678"></a>01678             adr[2]= v1[2]+l1*(v2[2]-v1[2]);
<a name="l01679"></a>01679             adr[3]= v1[3]+l1*(v2[3]-v1[3]);
<a name="l01680"></a>01680         } 
<a name="l01681"></a>01681         <span class="keywordflow">else</span> trias[*b1]= v1;
<a name="l01682"></a>01682         
<a name="l01683"></a>01683         (*b1)++;
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685     <span class="keywordflow">if</span> (l2!= -1.0f) {
<a name="l01686"></a>01686         <span class="keywordflow">if</span> (l2!= 1.0f) {
<a name="l01687"></a>01687             adr= vez+4*(*clve);
<a name="l01688"></a>01688             trias[*b1]=adr;
<a name="l01689"></a>01689             (*clve)++;
<a name="l01690"></a>01690             adr[0]= v1[0]+l2*(v2[0]-v1[0]);
<a name="l01691"></a>01691             adr[1]= v1[1]+l2*(v2[1]-v1[1]);
<a name="l01692"></a>01692             adr[2]= v1[2]+l2*(v2[2]-v1[2]);
<a name="l01693"></a>01693             adr[3]= v1[3]+l2*(v2[3]-v1[3]);
<a name="l01694"></a>01694             (*b1)++;
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696     }
<a name="l01697"></a>01697 }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01700"></a>01700 
<a name="l01701"></a><a class="code" href="../../dc/da5/zbuf_8c.html#abf3d79427f1e7f2d64555e030d10a400">01701</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[][4], <span class="keywordtype">float</span> adr[4])
<a name="l01702"></a>01702 {
<a name="l01703"></a>01703     <span class="comment">/* calcs homogenic coord of vertex v1 */</span>
<a name="l01704"></a>01704     <span class="keywordtype">float</span> x,y,z;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     x= v1[0]; 
<a name="l01707"></a>01707     y= v1[1]; 
<a name="l01708"></a>01708     z= v1[2];
<a name="l01709"></a>01709     adr[0]= x*winmat[0][0]              +   z*winmat[2][0] + winmat[3][0];
<a name="l01710"></a>01710     adr[1]=               y*winmat[1][1]    +   z*winmat[2][1] + winmat[3][1];
<a name="l01711"></a>01711     adr[2]=                                     z*winmat[2][2] + winmat[3][2];
<a name="l01712"></a>01712     adr[3]=                                     z*winmat[2][3] + winmat[3][3];
<a name="l01713"></a>01713 
<a name="l01714"></a>01714     <span class="comment">//printf(&quot;hoco %f %f %f %f\n&quot;, adr[0], adr[1], adr[2], adr[3]);</span>
<a name="l01715"></a>01715 }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01718"></a>01718 
<a name="l01719"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ad93b4beaa7403eec42729787b46e3e35">01719</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>[][4], <span class="keywordtype">float</span> adr[4])
<a name="l01720"></a>01720 {
<a name="l01721"></a>01721     <span class="comment">/* calcs homogenic coord of vertex v1 */</span>
<a name="l01722"></a>01722     <span class="keywordtype">float</span> x,y,z;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     x= v1[0]; 
<a name="l01725"></a>01725     y= v1[1]; 
<a name="l01726"></a>01726     z= v1[2];
<a name="l01727"></a>01727     adr[0]= x*winmat[0][0]+ y*winmat[1][0]+ z*winmat[2][0]+ winmat[3][0];
<a name="l01728"></a>01728     adr[1]= x*winmat[0][1]+ y*winmat[1][1]+ z*winmat[2][1]+ winmat[3][1];
<a name="l01729"></a>01729     adr[2]= x*winmat[0][2]+ y*winmat[1][2]+ z*winmat[2][2]+ winmat[3][2];
<a name="l01730"></a>01730     adr[3]= x*winmat[0][3]+ y*winmat[1][3]+ z*winmat[2][3]+ winmat[3][3];
<a name="l01731"></a>01731 }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01734"></a>01734 
<a name="l01735"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">01735</a> <span class="preprocessor">#define ZBUF_PROJECT_CACHE_SIZE 256</span>
<a name="l01736"></a>01736 <span class="preprocessor"></span>
<a name="l01737"></a><a class="code" href="../../db/dc1/structZbufProjectCache.html">01737</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> {
<a name="l01738"></a><a class="code" href="../../db/dc1/structZbufProjectCache.html#ac14c169cf0d608f2bc9757359ecc1c7c">01738</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/dc1/structZbufProjectCache.html#ac14c169cf0d608f2bc9757359ecc1c7c">index</a>, <a class="code" href="../../db/dc1/structZbufProjectCache.html#afdaac8bb7312f1576d07306d94cf1f13">clip</a>;
<a name="l01739"></a><a class="code" href="../../db/dc1/structZbufProjectCache.html#acdd48dc07bb4fe83a83d34e6b7e0e00e">01739</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/dc1/structZbufProjectCache.html#acdd48dc07bb4fe83a83d34e6b7e0e00e">ho</a>[4];
<a name="l01740"></a>01740 } <a class="code" href="../../dc/da5/zbuf_8c.html#a368bf8b33fcb8262f53466c0f888e930">ZbufProjectCache</a>;
<a name="l01741"></a>01741 
<a name="l01742"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">01742</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(<a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> *cache, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746     <span class="keywordflow">if</span> (size &gt; <a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>)
<a name="l01747"></a>01747         size= <a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749     memset(cache, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a>)*size);
<a name="l01750"></a>01750     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; i++)
<a name="l01751"></a>01751         cache[i].index= -1;
<a name="l01752"></a>01752 }
<a name="l01753"></a>01753 
<a name="l01754"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">01754</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(<a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> *cache, <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *ho)
<a name="l01755"></a>01755 {
<a name="l01756"></a>01756     <span class="keywordtype">int</span> cindex= index &amp; 255;
<a name="l01757"></a>01757 
<a name="l01758"></a>01758     <span class="keywordflow">if</span> (cache[cindex].index == index) {
<a name="l01759"></a>01759         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(ho, cache[cindex].ho);
<a name="l01760"></a>01760         <span class="keywordflow">return</span> cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#afdaac8bb7312f1576d07306d94cf1f13">clip</a>;
<a name="l01761"></a>01761     }
<a name="l01762"></a>01762     <span class="keywordflow">else</span> {
<a name="l01763"></a>01763         <span class="keywordtype">int</span> clipflag;
<a name="l01764"></a>01764         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(co, winmat, ho);
<a name="l01765"></a>01765         clipflag= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(cache[cindex].ho, ho);
<a name="l01768"></a>01768         cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#afdaac8bb7312f1576d07306d94cf1f13">clip</a>= clipflag;
<a name="l01769"></a>01769         cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#ac14c169cf0d608f2bc9757359ecc1c7c">index</a>= index;
<a name="l01770"></a>01770 
<a name="l01771"></a>01771         <span class="keywordflow">return</span> clipflag;
<a name="l01772"></a>01772     }
<a name="l01773"></a>01773 }
<a name="l01774"></a>01774 
<a name="l01775"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ab56f4bac77457cff9ef4a6e8c61ac06e">01775</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ab56f4bac77457cff9ef4a6e8c61ac06e">zbuffer_part_bounds</a>(<span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <span class="keywordtype">float</span> *<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>)
<a name="l01776"></a>01776 {
<a name="l01777"></a>01777     bounds[0]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - winx-1)/(<span class="keywordtype">float</span>)winx;
<a name="l01778"></a>01778     bounds[1]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - winx+1)/(<span class="keywordtype">float</span>)winx;
<a name="l01779"></a>01779     bounds[2]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - winy-1)/(<span class="keywordtype">float</span>)winy;
<a name="l01780"></a>01780     bounds[3]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - winy+1)/(<span class="keywordtype">float</span>)winy;
<a name="l01781"></a>01781 }
<a name="l01782"></a>01782 
<a name="l01783"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">01783</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(<a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> *cache, <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">float</span> *<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *ho)
<a name="l01784"></a>01784 {
<a name="l01785"></a>01785     <span class="keywordtype">float</span> vec[3];
<a name="l01786"></a>01786     <span class="keywordtype">int</span> cindex= index &amp; 255;
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     <span class="keywordflow">if</span> (cache[cindex].index == index) {
<a name="l01789"></a>01789         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(ho, cache[cindex].ho);
<a name="l01790"></a>01790         <span class="keywordflow">return</span> cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#afdaac8bb7312f1576d07306d94cf1f13">clip</a>;
<a name="l01791"></a>01791     }
<a name="l01792"></a>01792     <span class="keywordflow">else</span> {
<a name="l01793"></a>01793         <span class="keywordtype">float</span> wco;
<a name="l01794"></a>01794         <span class="keywordtype">int</span> clipflag= 0;
<a name="l01795"></a>01795         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, co);
<a name="l01796"></a>01796         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(co, winmat, ho);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798         wco= ho[3];
<a name="l01799"></a>01799         <span class="keywordflow">if</span> (ho[0] &lt; bounds[0]*wco) clipflag |= 1;
<a name="l01800"></a>01800         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ho[0] &gt; bounds[1]*wco) clipflag |= 2;
<a name="l01801"></a>01801         <span class="keywordflow">if</span> (ho[1] &gt; bounds[3]*wco) clipflag |= 4;
<a name="l01802"></a>01802         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ho[1] &lt; bounds[2]*wco) clipflag |= 8;
<a name="l01803"></a>01803 
<a name="l01804"></a>01804         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(cache[cindex].ho, ho);
<a name="l01805"></a>01805         cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#afdaac8bb7312f1576d07306d94cf1f13">clip</a>= clipflag;
<a name="l01806"></a>01806         cache[cindex].<a class="code" href="../../db/dc1/structZbufProjectCache.html#ac14c169cf0d608f2bc9757359ecc1c7c">index</a>= index;
<a name="l01807"></a>01807 
<a name="l01808"></a>01808         <span class="keywordflow">return</span> clipflag;
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810 }
<a name="l01811"></a>01811 
<a name="l01812"></a><a class="code" href="../../dc/da5/zbuf_8c.html#aa6695de789b10ec51642f2c5e5942f7d">01812</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#aa6695de789b10ec51642f2c5e5942f7d">zbuf_render_project</a>(<span class="keywordtype">float</span> winmat[][4], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> ho[4])
<a name="l01813"></a>01813 {
<a name="l01814"></a>01814     <span class="keywordtype">float</span> vec[3];
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, co);
<a name="l01817"></a>01817     <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(vec, winmat, ho);
<a name="l01818"></a>01818 }
<a name="l01819"></a>01819 
<a name="l01820"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a2b4f0907bbdcc8f79a1cec54d5b2b492">01820</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a2b4f0907bbdcc8f79a1cec54d5b2b492">zbuf_make_winmat</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> winmat[][4])
<a name="l01821"></a>01821 {
<a name="l01822"></a>01822     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a734c49fbcb5788988d667052995f4fa0">R_PANORAMA</a>) {
<a name="l01823"></a>01823         <span class="keywordtype">float</span> panomat[4][4]= <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l01824"></a>01824 
<a name="l01825"></a>01825         panomat[0][0]= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a76e4811c0479930c0703903c84f88474">panoco</a>;
<a name="l01826"></a>01826         panomat[0][2]= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae992347c274df0c72d975b2c92c2e3a7">panosi</a>;
<a name="l01827"></a>01827         panomat[2][0]= -re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae992347c274df0c72d975b2c92c2e3a7">panosi</a>;
<a name="l01828"></a>01828         panomat[2][2]= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a76e4811c0479930c0703903c84f88474">panoco</a>;
<a name="l01829"></a>01829 
<a name="l01830"></a>01830         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>, panomat);
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832     <span class="keywordflow">else</span>
<a name="l01833"></a>01833         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 <span class="comment">/* do zbuffering and clip, f1 f2 f3 are hocos, c1 c2 c3 are clipping flags */</span>
<a name="l01837"></a>01837 
<a name="l01838"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a35cb3e5e8777ea9ff82a775ab7b1626c">01838</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *f1, <span class="keywordtype">float</span> *f2, <span class="keywordtype">float</span> *f3, <span class="keywordtype">int</span> c1, <span class="keywordtype">int</span> c2, <span class="keywordtype">int</span> c3)
<a name="l01839"></a>01839 {
<a name="l01840"></a>01840     <span class="keywordtype">float</span> *vlzp[32][3], labda[3][2];
<a name="l01841"></a>01841     <span class="keywordtype">float</span> vez[400], *trias[40];
<a name="l01842"></a>01842     
<a name="l01843"></a>01843     <span class="keywordflow">if</span> (c1 | c2 | c3) { <span class="comment">/* not in middle */</span>
<a name="l01844"></a>01844         <span class="keywordflow">if</span> (c1 &amp; c2 &amp; c3) { <span class="comment">/* completely out */</span>
<a name="l01845"></a>01845             <span class="keywordflow">return</span>;
<a name="l01846"></a>01846         }
<a name="l01847"></a>01847         <span class="keywordflow">else</span> {  <span class="comment">/* clipping */</span>
<a name="l01848"></a>01848             <span class="keywordtype">int</span> arg, v, b, clipflag[3], b1, b2, b3, c4, clve=3, clvlo, clvl=1;
<a name="l01849"></a>01849 
<a name="l01850"></a>01850             vez[0]= f1[0]; vez[1]= f1[1]; vez[2]= f1[2]; vez[3]= f1[3];
<a name="l01851"></a>01851             vez[4]= f2[0]; vez[5]= f2[1]; vez[6]= f2[2]; vez[7]= f2[3];
<a name="l01852"></a>01852             vez[8]= f3[0]; vez[9]= f3[1]; vez[10]= f3[2];vez[11]= f3[3];
<a name="l01853"></a>01853 
<a name="l01854"></a>01854             vlzp[0][0]= vez;
<a name="l01855"></a>01855             vlzp[0][1]= vez+4;
<a name="l01856"></a>01856             vlzp[0][2]= vez+8;
<a name="l01857"></a>01857 
<a name="l01858"></a>01858             clipflag[0]= ( (c1 &amp; 48) | (c2 &amp; 48) | (c3 &amp; 48) );
<a name="l01859"></a>01859             <span class="keywordflow">if</span> (clipflag[0]==0) {   <span class="comment">/* othwerwise it needs to be calculated again, after the first (z) clip */</span>
<a name="l01860"></a>01860                 clipflag[1]= ( (c1 &amp; 3) | (c2 &amp; 3) | (c3 &amp; 3) );
<a name="l01861"></a>01861                 clipflag[2]= ( (c1 &amp; 12) | (c2 &amp; 12) | (c3 &amp; 12) );
<a name="l01862"></a>01862             }
<a name="l01863"></a>01863             <span class="keywordflow">else</span> clipflag[1]=clipflag[2]= 0;
<a name="l01864"></a>01864             
<a name="l01865"></a>01865             <span class="keywordflow">for</span> (b=0;b&lt;3;b++) {
<a name="l01866"></a>01866                 
<a name="l01867"></a>01867                 <span class="keywordflow">if</span> (clipflag[b]) {
<a name="l01868"></a>01868                 
<a name="l01869"></a>01869                     clvlo= clvl;
<a name="l01870"></a>01870                     
<a name="l01871"></a>01871                     <span class="keywordflow">for</span> (v=0; v&lt;clvlo; v++) {
<a name="l01872"></a>01872                     
<a name="l01873"></a>01873                         <span class="keywordflow">if</span> (vlzp[v][0]!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { <span class="comment">/* face is still there */</span>
<a name="l01874"></a>01874                             b2= b3 =0;  <span class="comment">/* clip flags */</span>
<a name="l01875"></a>01875 
<a name="l01876"></a>01876                             <span class="keywordflow">if</span> (b==0) arg= 2;
<a name="l01877"></a>01877                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (b==1) arg= 0;
<a name="l01878"></a>01878                             <span class="keywordflow">else</span> arg= 1;
<a name="l01879"></a>01879                             
<a name="l01880"></a>01880                             <a class="code" href="../../dc/da5/zbuf_8c.html#a858652357dfef40f9d34cce37f4ec10a">clippyra</a>(labda[0], vlzp[v][0],vlzp[v][1], &amp;b2,&amp;b3, arg, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#afafe7f41d97637e44c3de459d275f3e4">clipcrop</a>);
<a name="l01881"></a>01881                             <a class="code" href="../../dc/da5/zbuf_8c.html#a858652357dfef40f9d34cce37f4ec10a">clippyra</a>(labda[1], vlzp[v][1],vlzp[v][2], &amp;b2,&amp;b3, arg, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#afafe7f41d97637e44c3de459d275f3e4">clipcrop</a>);
<a name="l01882"></a>01882                             <a class="code" href="../../dc/da5/zbuf_8c.html#a858652357dfef40f9d34cce37f4ec10a">clippyra</a>(labda[2], vlzp[v][2],vlzp[v][0], &amp;b2,&amp;b3, arg, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#afafe7f41d97637e44c3de459d275f3e4">clipcrop</a>);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884                             <span class="keywordflow">if</span> (b2==0 &amp;&amp; b3==1) {
<a name="l01885"></a>01885                                 <span class="comment">/* completely &#39;in&#39;, but we copy because of last for () loop in this section */</span>;
<a name="l01886"></a>01886                                 vlzp[clvl][0]= vlzp[v][0];
<a name="l01887"></a>01887                                 vlzp[clvl][1]= vlzp[v][1];
<a name="l01888"></a>01888                                 vlzp[clvl][2]= vlzp[v][2];
<a name="l01889"></a>01889                                 vlzp[v][0]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01890"></a>01890                                 clvl++;
<a name="l01891"></a>01891                             }
<a name="l01892"></a>01892                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (b3==0) {
<a name="l01893"></a>01893                                 vlzp[v][0]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01894"></a>01894                                 <span class="comment">/* completely &#39;out&#39; */</span>;
<a name="l01895"></a>01895                             }
<a name="l01896"></a>01896                             <span class="keywordflow">else</span> {
<a name="l01897"></a>01897                                 b1=0;
<a name="l01898"></a>01898                                 <a class="code" href="../../dc/da5/zbuf_8c.html#a880ac569e80b191a72e4145c3987f1b2">makevertpyra</a>(vez, labda[0], trias, vlzp[v][0],vlzp[v][1], &amp;b1,&amp;clve);
<a name="l01899"></a>01899                                 <a class="code" href="../../dc/da5/zbuf_8c.html#a880ac569e80b191a72e4145c3987f1b2">makevertpyra</a>(vez, labda[1], trias, vlzp[v][1],vlzp[v][2], &amp;b1,&amp;clve);
<a name="l01900"></a>01900                                 <a class="code" href="../../dc/da5/zbuf_8c.html#a880ac569e80b191a72e4145c3987f1b2">makevertpyra</a>(vez, labda[2], trias, vlzp[v][2],vlzp[v][0], &amp;b1,&amp;clve);
<a name="l01901"></a>01901 
<a name="l01902"></a>01902                                 <span class="comment">/* after front clip done: now set clip flags */</span>
<a name="l01903"></a>01903                                 <span class="keywordflow">if</span> (b==0) {
<a name="l01904"></a>01904                                     clipflag[1]= clipflag[2]= 0;
<a name="l01905"></a>01905                                     f1= vez;
<a name="l01906"></a>01906                                     <span class="keywordflow">for</span> (b3=0; b3&lt;clve; b3++) {
<a name="l01907"></a>01907                                         c4= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(f1);
<a name="l01908"></a>01908                                         clipflag[1] |= (c4 &amp; 3);
<a name="l01909"></a>01909                                         clipflag[2] |= (c4 &amp; 12);
<a name="l01910"></a>01910                                         f1+= 4;
<a name="l01911"></a>01911                                     }
<a name="l01912"></a>01912                                 }
<a name="l01913"></a>01913                                 
<a name="l01914"></a>01914                                 vlzp[v][0]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01915"></a>01915                                 <span class="keywordflow">if</span> (b1&gt;2) {
<a name="l01916"></a>01916                                     <span class="keywordflow">for</span> (b3=3; b3&lt;=b1; b3++) {
<a name="l01917"></a>01917                                         vlzp[clvl][0]= trias[0];
<a name="l01918"></a>01918                                         vlzp[clvl][1]= trias[b3-2];
<a name="l01919"></a>01919                                         vlzp[clvl][2]= trias[b3-1];
<a name="l01920"></a>01920                                         clvl++;
<a name="l01921"></a>01921                                     }
<a name="l01922"></a>01922                                 }
<a name="l01923"></a>01923                             }
<a name="l01924"></a>01924                         }
<a name="l01925"></a>01925                     }
<a name="l01926"></a>01926                 }
<a name="l01927"></a>01927             }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929             <span class="comment">/* warning, this should never happen! */</span>
<a name="l01930"></a>01930             <span class="keywordflow">if</span> (clve&gt;38 || clvl&gt;31) printf(<span class="stringliteral">&quot;clip overflow: clve clvl %d %d\n&quot;</span>,clve,clvl);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932             <span class="comment">/* perspective division */</span>
<a name="l01933"></a>01933             f1=vez;
<a name="l01934"></a>01934             <span class="keywordflow">for</span> (c1=0;c1&lt;clve;c1++) {
<a name="l01935"></a>01935                 <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, f1, f1);
<a name="l01936"></a>01936                 f1+=4;
<a name="l01937"></a>01937             }
<a name="l01938"></a>01938             <span class="keywordflow">for</span> (b=1;b&lt;clvl;b++) {
<a name="l01939"></a>01939                 <span class="keywordflow">if</span> (vlzp[b][0]) {
<a name="l01940"></a>01940                     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>(zspan, obi, zvlnr, vlzp[b][0],vlzp[b][1],vlzp[b][2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01941"></a>01941                 }
<a name="l01942"></a>01942             }
<a name="l01943"></a>01943             <span class="keywordflow">return</span>;
<a name="l01944"></a>01944         }
<a name="l01945"></a>01945     }
<a name="l01946"></a>01946 
<a name="l01947"></a>01947     <span class="comment">/* perspective division: HCS to ZCS */</span>
<a name="l01948"></a>01948     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, f1);
<a name="l01949"></a>01949     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, f2);
<a name="l01950"></a>01950     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+8, f3);
<a name="l01951"></a>01951     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>(zspan, obi, zvlnr, vez,vez+4,vez+8, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a6b51440b242b33e332241ee464a9bce0">01954</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *f1, <span class="keywordtype">float</span> *f2, <span class="keywordtype">float</span> *f3, <span class="keywordtype">float</span> *f4, <span class="keywordtype">int</span> c1, <span class="keywordtype">int</span> c2, <span class="keywordtype">int</span> c3, <span class="keywordtype">int</span> c4)
<a name="l01955"></a>01955 {
<a name="l01956"></a>01956     <span class="keywordtype">float</span> vez[16];
<a name="l01957"></a>01957     
<a name="l01958"></a>01958     <span class="keywordflow">if</span> (c1 | c2 | c3 | c4) {    <span class="comment">/* not in middle */</span>
<a name="l01959"></a>01959         <span class="keywordflow">if</span> (c1 &amp; c2 &amp; c3 &amp; c4) {    <span class="comment">/* completely out */</span>
<a name="l01960"></a>01960             <span class="keywordflow">return</span>;
<a name="l01961"></a>01961         }
<a name="l01962"></a>01962         <span class="keywordflow">else</span> {  <span class="comment">/* clipping */</span>
<a name="l01963"></a>01963             <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, obi, zvlnr, f1, f2, f3, c1, c2, c3);
<a name="l01964"></a>01964             <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, obi, zvlnr, f1, f3, f4, c1, c3, c4);
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966         <span class="keywordflow">return</span>;
<a name="l01967"></a>01967     }
<a name="l01968"></a>01968 
<a name="l01969"></a>01969     <span class="comment">/* perspective division: HCS to ZCS */</span>
<a name="l01970"></a>01970     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez, f1);
<a name="l01971"></a>01971     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+4, f2);
<a name="l01972"></a>01972     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+8, f3);
<a name="l01973"></a>01973     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, vez+12, f4);
<a name="l01974"></a>01974 
<a name="l01975"></a>01975     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>(zspan, obi, zvlnr, vez, vez+4, vez+8, vez+12);
<a name="l01976"></a>01976 }
<a name="l01977"></a>01977 
<a name="l01978"></a>01978 <span class="comment">/* ************** ZMASK ******************************** */</span>
<a name="l01979"></a>01979 
<a name="l01980"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">01980</a> <span class="preprocessor">#define EXTEND_PIXEL(a) if (temprectp[a]) {z+= rectz[a]; tot++;}</span>
<a name="l01981"></a>01981 <span class="preprocessor"></span>
<a name="l01982"></a>01982 <span class="comment">/* changes the zbuffer to be ready for z-masking: applies an extend-filter, and then clears */</span>
<a name="l01983"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ac49c236cdbdfdc049570b7dba4c3fb75">01983</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ac49c236cdbdfdc049570b7dba4c3fb75">zmask_rect</a>(<span class="keywordtype">int</span> *rectz, <span class="keywordtype">int</span> *rectp, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> neg)
<a name="l01984"></a>01984 {
<a name="l01985"></a>01985     <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>=0, x, y;
<a name="l01986"></a>01986     <span class="keywordtype">int</span> *temprectp;
<a name="l01987"></a>01987     <span class="keywordtype">int</span> row1, row2, row3, *curp, *curz;
<a name="l01988"></a>01988     
<a name="l01989"></a>01989     temprectp= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(rectp);
<a name="l01990"></a>01990     
<a name="l01991"></a>01991     <span class="comment">/* extend: if pixel is not filled in, we check surrounding pixels and average z value  */</span>
<a name="l01992"></a>01992     
<a name="l01993"></a>01993     <span class="keywordflow">for</span> (y=1; y&lt;=ys; y++) {
<a name="l01994"></a>01994         <span class="comment">/* setup row indices */</span>
<a name="l01995"></a>01995         row1= (y-2)*xs;
<a name="l01996"></a>01996         row2= row1 + xs;
<a name="l01997"></a>01997         row3= row2 + xs;
<a name="l01998"></a>01998         <span class="keywordflow">if</span> (y==1)
<a name="l01999"></a>01999             row1= row2;
<a name="l02000"></a>02000         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y==ys)
<a name="l02001"></a>02001             row3= row2;
<a name="l02002"></a>02002         
<a name="l02003"></a>02003         curp= rectp + (y-1)*xs;
<a name="l02004"></a>02004         curz= rectz + (y-1)*xs;
<a name="l02005"></a>02005         
<a name="l02006"></a>02006         <span class="keywordflow">for</span> (x=0; x&lt;xs; x++, curp++, curz++) {
<a name="l02007"></a>02007             <span class="keywordflow">if</span> (curp[0]==0) {
<a name="l02008"></a>02008                 <span class="keywordtype">int</span> tot= 0;
<a name="l02009"></a>02009                 <span class="keywordtype">float</span> z= 0.0f;
<a name="l02010"></a>02010                 
<a name="l02011"></a>02011                 <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row1);
<a name="l02012"></a>02012                 <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row2);
<a name="l02013"></a>02013                 <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row3);
<a name="l02014"></a>02014                 <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row1 + 1);
<a name="l02015"></a>02015                 <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row3 + 1);
<a name="l02016"></a>02016                 <span class="keywordflow">if</span> (x!=xs-1) {
<a name="l02017"></a>02017                     <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row1 + 2);
<a name="l02018"></a>02018                     <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row2 + 2);
<a name="l02019"></a>02019                     <a class="code" href="../../dc/da5/zbuf_8c.html#a1fb00c635d39e54b024635f00b1c12d1">EXTEND_PIXEL</a>(row3 + 2);
<a name="l02020"></a>02020                 }                   
<a name="l02021"></a>02021                 <span class="keywordflow">if</span> (tot) {
<a name="l02022"></a>02022                     len++;
<a name="l02023"></a>02023                     curz[0]= (int)(z/(<span class="keywordtype">float</span>)tot);
<a name="l02024"></a>02024                     curp[0]= -1;    <span class="comment">/* env */</span>
<a name="l02025"></a>02025                 }
<a name="l02026"></a>02026             }
<a name="l02027"></a>02027             
<a name="l02028"></a>02028             <span class="keywordflow">if</span> (x!=0) {
<a name="l02029"></a>02029                 row1++; row2++; row3++;
<a name="l02030"></a>02030             }
<a name="l02031"></a>02031         }
<a name="l02032"></a>02032     }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(temprectp);
<a name="l02035"></a>02035     
<a name="l02036"></a>02036     <span class="keywordflow">if</span> (neg); <span class="comment">/* z values for negative are already correct */</span>
<a name="l02037"></a>02037     <span class="keywordflow">else</span> {
<a name="l02038"></a>02038         <span class="comment">/* clear not filled z values */</span>
<a name="l02039"></a>02039         <span class="keywordflow">for</span> (len= xs*ys -1; len&gt;=0; len--) {
<a name="l02040"></a>02040             <span class="keywordflow">if</span> (rectp[len]==0) {
<a name="l02041"></a>02041                 rectz[<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>] = -0x7FFFFFFF;
<a name="l02042"></a>02042                 rectp[<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>]= -1; <span class="comment">/* env code */</span>
<a name="l02043"></a>02043             }   
<a name="l02044"></a>02044         }
<a name="l02045"></a>02045     }
<a name="l02046"></a>02046 }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048 
<a name="l02049"></a>02049 
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 <span class="comment">/* ***************** ZBUFFER MAIN ROUTINES **************** */</span>
<a name="l02052"></a>02052 
<a name="l02053"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ab4b489453963ababe1f08a708007b65e">02053</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a81de86b73197d641bbdd0f4211175047">zbuffer_solid</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">void</span>(*fillfunc)(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a>*, <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a>*, <span class="keywordtype">int</span>, <span class="keywordtype">void</span>*), <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l02054"></a>02054 {
<a name="l02055"></a>02055     <a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> cache[<a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>];
<a name="l02056"></a>02056     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspans[16], *zspan; <span class="comment">/* 16 = RE_MAX_OSA */</span>
<a name="l02057"></a>02057     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02058"></a>02058     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, *v2, *v3, *v4;
<a name="l02059"></a>02059     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma=0;
<a name="l02060"></a>02060     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l02061"></a>02061     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l02062"></a>02062     <span class="keywordtype">float</span> obwinmat[4][4], winmat[4][4], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[4];
<a name="l02063"></a>02063     <span class="keywordtype">float</span> ho1[4], ho2[4], ho3[4], ho4[4]={0};
<a name="l02064"></a>02064     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#af48debce77d5f85918186aaf70e31bed">lay</a>, lay_zmask= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a4b809adbccefbb66353898d1b4031cf3">lay_zmask</a>;
<a name="l02065"></a>02065     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, v, zvlnr, zsample, samples, c1, c2, c3, c4=0;
<a name="l02066"></a>02066     <span class="keywordtype">short</span> nofill=0, env=0, wire=0, zmaskpass=0;
<a name="l02067"></a>02067     <span class="keywordtype">short</span> all_z= (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cc7e5046106799b4c31023b59554571">SCE_LAY_ALL_Z</a>) &amp;&amp; !(rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab7e455e151d17f410776952c810eec74">SCE_LAY_ZMASK</a>);
<a name="l02068"></a>02068     <span class="keywordtype">short</span> neg_zmask= (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab7e455e151d17f410776952c810eec74">SCE_LAY_ZMASK</a>) &amp;&amp; (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a388e66aea5b299c2d6011ce74e8ae866">SCE_LAY_NEG_ZMASK</a>);
<a name="l02069"></a>02069 
<a name="l02070"></a>02070     <a class="code" href="../../df/d9d/zbuf_8h.html#a2b4f0907bbdcc8f79a1cec54d5b2b492">zbuf_make_winmat</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, winmat);
<a name="l02071"></a>02071     
<a name="l02072"></a>02072     samples= (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa? <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa: 1);
<a name="l02073"></a>02073     samples= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(4, samples-pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a99b88a3bf9a4d3ea17d6c1edbbaa73e6">sample</a>);
<a name="l02074"></a>02074 
<a name="l02075"></a>02075     <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02076"></a>02076         zspan= &amp;zspans[zsample];
<a name="l02077"></a>02077 
<a name="l02078"></a>02078         <a class="code" href="../../dc/da5/zbuf_8c.html#ab56f4bac77457cff9ef4a6e8c61ac06e">zbuffer_part_bounds</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy, pa, bounds);
<a name="l02079"></a>02079         <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(zspan, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.clipcrop);
<a name="l02080"></a>02080         
<a name="l02081"></a>02081         <span class="comment">/* needed for transform from hoco to zbuffer co */</span>
<a name="l02082"></a>02082         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>= ((float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx)/2.0f;
<a name="l02083"></a>02083         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>= ((float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy)/2.0f;
<a name="l02084"></a>02084         
<a name="l02085"></a>02085         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l02086"></a>02086             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a99b88a3bf9a4d3ea17d6c1edbbaa73e6">sample</a>+zsample][0];
<a name="l02087"></a>02087             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a99b88a3bf9a4d3ea17d6c1edbbaa73e6">sample</a>+zsample][1];
<a name="l02088"></a>02088         }
<a name="l02089"></a>02089         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.i.curblur) {
<a name="l02090"></a>02090             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.mblur_jit[<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.i.curblur-1][0];
<a name="l02091"></a>02091             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.mblur_jit[<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.i.curblur-1][1];
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093         <span class="keywordflow">else</span> {
<a name="l02094"></a>02094             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l02095"></a>02095             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l02096"></a>02096         }
<a name="l02097"></a>02097         <span class="comment">/* to center the sample position */</span>
<a name="l02098"></a>02098         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a> -= 0.5f;
<a name="l02099"></a>02099         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a> -= 0.5f;
<a name="l02100"></a>02100         
<a name="l02101"></a>02101         <span class="comment">/* the buffers */</span>
<a name="l02102"></a>02102         <span class="keywordflow">if</span> (zsample == samples-1) {
<a name="l02103"></a>02103             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a19296bd81488c2b963562b2aa11ded26">rectp</a>;
<a name="l02104"></a>02104             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a52f4f2e4cceaff5e79ad83bc44587151">recto</a>;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106             <span class="keywordflow">if</span> (neg_zmask)
<a name="l02107"></a>02107                 zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1a79af7085fe5dcf1ea389f52666153a">rectmask</a>;
<a name="l02108"></a>02108             <span class="keywordflow">else</span>
<a name="l02109"></a>02109                 zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>;
<a name="l02110"></a>02110         }
<a name="l02111"></a>02111         <span class="keywordflow">else</span> {
<a name="l02112"></a>02112             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;recto&quot;</span>);
<a name="l02113"></a>02113             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;rectp&quot;</span>);
<a name="l02114"></a>02114             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;rectz&quot;</span>);
<a name="l02115"></a>02115         }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0x7FFFFFFF);
<a name="l02118"></a>02118         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0);
<a name="l02119"></a>02119         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0);
<a name="l02120"></a>02120     }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <span class="comment">/* in case zmask we fill Z for objects in lay_zmask first, then clear Z, and then do normal zbuffering */</span>
<a name="l02123"></a>02123     <span class="keywordflow">if</span> (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab7e455e151d17f410776952c810eec74">SCE_LAY_ZMASK</a>)
<a name="l02124"></a>02124         zmaskpass= 1;
<a name="l02125"></a>02125     
<a name="l02126"></a>02126     <span class="keywordflow">for</span> (; zmaskpass &gt;=0; zmaskpass--) {
<a name="l02127"></a>02127         ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129         <span class="comment">/* filling methods */</span>
<a name="l02130"></a>02130         <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02131"></a>02131             zspan= &amp;zspans[zsample];
<a name="l02132"></a>02132 
<a name="l02133"></a>02133             <span class="keywordflow">if</span> (zmaskpass &amp;&amp; neg_zmask)
<a name="l02134"></a>02134                 zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a1010a528900d52393ac8a971fcbc9ac4">zbuffillGLinv4</a>;
<a name="l02135"></a>02135             <span class="keywordflow">else</span>
<a name="l02136"></a>02136                 zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a079762cfb1176e8507933905fcb30d2c">zbuffillGL4</a>;
<a name="l02137"></a>02137             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a111f00929f4ba3d51b407ea61f3a2bd0">zbufline</a>;
<a name="l02138"></a>02138         }
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         <span class="comment">/* regular zbuffering loop, does all sample buffers */</span>
<a name="l02141"></a>02141         <span class="keywordflow">for</span> (i=0, obi=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.instancetable.first; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l02142"></a>02142             obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144             <span class="comment">/* continue happens in 2 different ways... zmaskpass only does lay_zmask stuff */</span>
<a name="l02145"></a>02145             <span class="keywordflow">if</span> (zmaskpass) {
<a name="l02146"></a>02146                 <span class="keywordflow">if</span> ((obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay_zmask)==0)
<a name="l02147"></a>02147                     <span class="keywordflow">continue</span>;
<a name="l02148"></a>02148             }
<a name="l02149"></a>02149             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!all_z &amp;&amp; !(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; (lay|lay_zmask)))
<a name="l02150"></a>02150                 <span class="keywordflow">continue</span>;
<a name="l02151"></a>02151             
<a name="l02152"></a>02152             <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l02153"></a>02153                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obwinmat, winmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l02154"></a>02154             <span class="keywordflow">else</span>
<a name="l02155"></a>02155                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obwinmat, winmat);
<a name="l02156"></a>02156 
<a name="l02157"></a>02157             <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>, bounds, obwinmat))
<a name="l02158"></a>02158                 <span class="keywordflow">continue</span>;
<a name="l02159"></a>02159 
<a name="l02160"></a>02160             <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(cache, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l02161"></a>02161 
<a name="l02162"></a>02162             <span class="keywordflow">for</span> (v=0; v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; v++) {
<a name="l02163"></a>02163                 <span class="keywordflow">if</span> ((v &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l02164"></a>02164                 <span class="keywordflow">else</span> vlr++;
<a name="l02165"></a>02165 
<a name="l02166"></a>02166                 <span class="comment">/* the cases: visible for render, only z values, zmask, nothing */</span>
<a name="l02167"></a>02167                 <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay) {
<a name="l02168"></a>02168                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!=ma) {
<a name="l02169"></a>02169                         ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l02170"></a>02170                         nofill= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0b02e3e0afacbc7473b8ed9984a65c01">MA_ONLYCAST</a>) || ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>));
<a name="l02171"></a>02171                         env= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#af030e92d0ce6acc49b989b9a43bbacb4">MA_ENV</a>);
<a name="l02172"></a>02172                         wire= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>);
<a name="l02173"></a>02173                         
<a name="l02174"></a>02174                         <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02175"></a>02175                             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aec35a801002959b1edbaaf402055e224">MA_ZINV</a> || (zmaskpass &amp;&amp; neg_zmask))
<a name="l02176"></a>02176                                 zspans[zsample].zbuffunc= <a class="code" href="../../dc/da5/zbuf_8c.html#a1010a528900d52393ac8a971fcbc9ac4">zbuffillGLinv4</a>;
<a name="l02177"></a>02177                             <span class="keywordflow">else</span>
<a name="l02178"></a>02178                                 zspans[zsample].<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a079762cfb1176e8507933905fcb30d2c">zbuffillGL4</a>;
<a name="l02179"></a>02179                         }
<a name="l02180"></a>02180                     }
<a name="l02181"></a>02181                 }
<a name="l02182"></a>02182                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (all_z || (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay_zmask)) {
<a name="l02183"></a>02183                     env= 1;
<a name="l02184"></a>02184                     nofill= 0;
<a name="l02185"></a>02185                     ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; 
<a name="l02186"></a>02186                 }
<a name="l02187"></a>02187                 <span class="keywordflow">else</span> {
<a name="l02188"></a>02188                     nofill= 1;
<a name="l02189"></a>02189                     ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;   <span class="comment">/* otherwise nofill can hang */</span>
<a name="l02190"></a>02190                 }
<a name="l02191"></a>02191 
<a name="l02192"></a>02192                 <span class="keywordflow">if</span> (!(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>) &amp;&amp; nofill==0) {
<a name="l02193"></a>02193                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> partclip;
<a name="l02194"></a>02194                     
<a name="l02195"></a>02195                     v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l02196"></a>02196                     v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l02197"></a>02197                     v3= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l02198"></a>02198                     v4= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l02199"></a>02199 
<a name="l02200"></a>02200                     c1= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho1);
<a name="l02201"></a>02201                     c2= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho2);
<a name="l02202"></a>02202                     c3= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho3);
<a name="l02203"></a>02203 
<a name="l02204"></a>02204                     <span class="comment">/* partclipping doesn&#39;t need viewplane clipping */</span>
<a name="l02205"></a>02205                     partclip= c1 &amp; c2 &amp; c3;
<a name="l02206"></a>02206                     <span class="keywordflow">if</span> (v4) {
<a name="l02207"></a>02207                         c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho4);
<a name="l02208"></a>02208                         partclip &amp;= c4;
<a name="l02209"></a>02209                     }
<a name="l02210"></a>02210 
<a name="l02211"></a>02211                     <span class="keywordflow">if</span> (partclip==0) {
<a name="l02212"></a>02212                         
<a name="l02213"></a>02213                         <span class="keywordflow">if</span> (env) zvlnr= -1;
<a name="l02214"></a>02214                         <span class="keywordflow">else</span> zvlnr= v+1;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216                         c1= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho1);
<a name="l02217"></a>02217                         c2= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho2);
<a name="l02218"></a>02218                         c3= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho3);
<a name="l02219"></a>02219                         <span class="keywordflow">if</span> (v4)
<a name="l02220"></a>02220                             c4= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho4);
<a name="l02221"></a>02221 
<a name="l02222"></a>02222                         <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02223"></a>02223                             zspan= &amp;zspans[zsample];
<a name="l02224"></a>02224 
<a name="l02225"></a>02225                             <span class="keywordflow">if</span> (wire) {
<a name="l02226"></a>02226                                 <span class="keywordflow">if</span> (v4)
<a name="l02227"></a>02227                                     <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(zspan, i, zvlnr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l02228"></a>02228                                 <span class="keywordflow">else</span>
<a name="l02229"></a>02229                                     <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(zspan, i, zvlnr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, 0, c1, c2, c3, 0);
<a name="l02230"></a>02230                             }
<a name="l02231"></a>02231                             <span class="keywordflow">else</span> {
<a name="l02232"></a>02232                                 <span class="comment">/* strands allow to be filled in as quad */</span>
<a name="l02233"></a>02233                                 <span class="keywordflow">if</span> (v4 &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)) {
<a name="l02234"></a>02234                                     <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(zspan, i, zvlnr, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l02235"></a>02235                                 }
<a name="l02236"></a>02236                                 <span class="keywordflow">else</span> {
<a name="l02237"></a>02237                                     <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, i, zvlnr, ho1, ho2, ho3, c1, c2, c3);
<a name="l02238"></a>02238                                     <span class="keywordflow">if</span> (v4)
<a name="l02239"></a>02239                                         <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, i, (env)? zvlnr: zvlnr+<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>, ho1, ho3, ho4, c1, c3, c4);
<a name="l02240"></a>02240                                 }
<a name="l02241"></a>02241                             }
<a name="l02242"></a>02242                         }
<a name="l02243"></a>02243                     }
<a name="l02244"></a>02244                 }
<a name="l02245"></a>02245             }
<a name="l02246"></a>02246         }
<a name="l02247"></a>02247         
<a name="l02248"></a>02248         <span class="comment">/* clear all z to close value, so it works as mask for next passes (ztra+strand) */</span>
<a name="l02249"></a>02249         <span class="keywordflow">if</span> (zmaskpass) {
<a name="l02250"></a>02250             <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02251"></a>02251                 zspan= &amp;zspans[zsample];
<a name="l02252"></a>02252 
<a name="l02253"></a>02253                 <span class="keywordflow">if</span> (neg_zmask) {
<a name="l02254"></a>02254                     zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>;
<a name="l02255"></a>02255                     <span class="keywordflow">if</span> (zsample == samples-1)
<a name="l02256"></a>02256                         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>;
<a name="l02257"></a>02257                     <span class="keywordflow">else</span>
<a name="l02258"></a>02258                         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;rectz&quot;</span>);
<a name="l02259"></a>02259                     <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0x7FFFFFFF);
<a name="l02260"></a>02260 
<a name="l02261"></a>02261                     <a class="code" href="../../dc/da5/zbuf_8c.html#ac49c236cdbdfdc049570b7dba4c3fb75">zmask_rect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 1);
<a name="l02262"></a>02262                 }
<a name="l02263"></a>02263                 <span class="keywordflow">else</span>
<a name="l02264"></a>02264                     <a class="code" href="../../dc/da5/zbuf_8c.html#ac49c236cdbdfdc049570b7dba4c3fb75">zmask_rect</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0);
<a name="l02265"></a>02265             }
<a name="l02266"></a>02266         }
<a name="l02267"></a>02267     }
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l02270"></a>02270         zspan= &amp;zspans[zsample];
<a name="l02271"></a>02271 
<a name="l02272"></a>02272         <span class="keywordflow">if</span> (fillfunc)
<a name="l02273"></a>02273             fillfunc(pa, zspan, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a99b88a3bf9a4d3ea17d6c1edbbaa73e6">sample</a>+zsample, data);
<a name="l02274"></a>02274 
<a name="l02275"></a>02275         <span class="keywordflow">if</span> (zsample != samples-1) {
<a name="l02276"></a>02276             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>);
<a name="l02277"></a>02277             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>);
<a name="l02278"></a>02278             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a4ece99a3aa1ab09b72a45c6b03d14162">recto</a>);
<a name="l02279"></a>02279             <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>)
<a name="l02280"></a>02280                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>);
<a name="l02281"></a>02281         }
<a name="l02282"></a>02282 
<a name="l02283"></a>02283         <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(zspan);
<a name="l02284"></a>02284     }
<a name="l02285"></a>02285 }
<a name="l02286"></a>02286 
<a name="l02287"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ac8e863ce219220d230304c6ef75f7359">02287</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a42a096cb948243e4668cf3cf97c50453">zbuffer_shadow</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">int</span> *rectz, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">float</span> jitx, <span class="keywordtype">float</span> jity)
<a name="l02288"></a>02288 {
<a name="l02289"></a>02289     <a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> cache[<a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>];
<a name="l02290"></a>02290     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspan;
<a name="l02291"></a>02291     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l02292"></a>02292     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l02293"></a>02293     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02294"></a>02294     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02295"></a>02295     <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> sseg;
<a name="l02296"></a>02296     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02297"></a>02297     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert;
<a name="l02298"></a>02298     <a class="code" href="../../db/d4b/structStrandBound.html">StrandBound</a> *sbound;
<a name="l02299"></a>02299     <span class="keywordtype">float</span> obwinmat[4][4], ho1[4], ho2[4], ho3[4], ho4[4];
<a name="l02300"></a>02300     <span class="keywordtype">int</span> a, b, c, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, c1, c2, c3, c4, ok=1, lay= -1;
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1337605158cc594cf324bdbe8b1818ce">LA_LAYER_SHADOW</a>)) lay= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;
<a name="l02303"></a>02303 
<a name="l02304"></a>02304     <span class="comment">/* 1.0f for clipping in clippyra()... bad stuff actually */</span>
<a name="l02305"></a>02305     <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(&amp;zspan, size, size, 1.0f);
<a name="l02306"></a>02306     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>=  ((float)size)/2.0f;
<a name="l02307"></a>02307     zspan.<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>=  ((float)size)/2.0f;
<a name="l02308"></a>02308     <span class="comment">/* -0.5f to center the sample position */</span>
<a name="l02309"></a>02309     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= jitx - 0.5f;
<a name="l02310"></a>02310     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= jity - 0.5f;
<a name="l02311"></a>02311     
<a name="l02312"></a>02312     <span class="comment">/* the buffers */</span>
<a name="l02313"></a>02313     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= rectz;
<a name="l02314"></a>02314     <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(rectz, size, size, 0x7FFFFFFE);
<a name="l02315"></a>02315     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a04f7a5531fb598ef1de609b9f3dec4e6">LA_SHADBUF_HALFWAY</a>) {
<a name="l02316"></a>02316         zspan.<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(size*size*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;seconday z buffer&quot;</span>);
<a name="l02317"></a>02317         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(zspan.<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>, size, size, 0x7FFFFFFE);
<a name="l02318"></a>02318     }
<a name="l02319"></a>02319     
<a name="l02320"></a>02320     <span class="comment">/* filling methods */</span>
<a name="l02321"></a>02321     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a0047be87acf9227da5e4fa0d03793cd9">zbufline_onlyZ</a>;
<a name="l02322"></a>02322     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#ad494dc9ff0167ddaa3184cffc3cf849e">zbuffillGL_onlyZ</a>;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324     <span class="keywordflow">for</span> (i=0, obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l02325"></a>02325         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02326"></a>02326 
<a name="l02327"></a>02327         <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>==re-&gt;<a class="code" href="../../d6/d7a/structRender.html#abf7d7087b9c8b6543fbcf7c10bf98b51">excludeob</a>)
<a name="l02328"></a>02328             <span class="keywordflow">continue</span>;
<a name="l02329"></a>02329         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay))
<a name="l02330"></a>02330             <span class="keywordflow">continue</span>;
<a name="l02331"></a>02331 
<a name="l02332"></a>02332         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l02333"></a>02333             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obwinmat, winmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l02334"></a>02334         <span class="keywordflow">else</span>
<a name="l02335"></a>02335             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obwinmat, winmat);
<a name="l02336"></a>02336 
<a name="l02337"></a>02337         <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obwinmat))
<a name="l02338"></a>02338             <span class="keywordflow">continue</span>;
<a name="l02339"></a>02339 
<a name="l02340"></a>02340         <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(cache, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l02341"></a>02341 
<a name="l02342"></a>02342         <span class="comment">/* faces */</span>
<a name="l02343"></a>02343         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l02344"></a>02344 
<a name="l02345"></a>02345             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l02346"></a>02346             <span class="keywordflow">else</span> vlr++;
<a name="l02347"></a>02347 
<a name="l02348"></a>02348             <span class="comment">/* note, these conditions are copied in shadowbuf_autoclip() */</span>
<a name="l02349"></a>02349             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!= ma) {
<a name="l02350"></a>02350                 ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l02351"></a>02351                 ok= 1;
<a name="l02352"></a>02352                 <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>)==0) ok= 0;
<a name="l02353"></a>02353             }
<a name="l02354"></a>02354 
<a name="l02355"></a>02355             <span class="keywordflow">if</span> (ok &amp;&amp; (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay) &amp;&amp; !(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>)) {
<a name="l02356"></a>02356                 c1= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho1);
<a name="l02357"></a>02357                 c2= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho2);
<a name="l02358"></a>02358                 c3= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho3);
<a name="l02359"></a>02359 
<a name="l02360"></a>02360                 <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>) || (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)) {
<a name="l02361"></a>02361                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02362"></a>02362                         c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho4);
<a name="l02363"></a>02363                         <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(&amp;zspan, 0, a+1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l02364"></a>02364                     }
<a name="l02365"></a>02365                     <span class="keywordflow">else</span>
<a name="l02366"></a>02366                         <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(&amp;zspan, 0, a+1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, 0, c1, c2, c3, 0);
<a name="l02367"></a>02367                 }
<a name="l02368"></a>02368                 <span class="keywordflow">else</span> {
<a name="l02369"></a>02369                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02370"></a>02370                         c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho4);
<a name="l02371"></a>02371                         <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(&amp;zspan, 0, 0, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l02372"></a>02372                     }
<a name="l02373"></a>02373                     <span class="keywordflow">else</span>
<a name="l02374"></a>02374                         <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(&amp;zspan, 0, 0, ho1, ho2, ho3, c1, c2, c3);
<a name="l02375"></a>02375                 }
<a name="l02376"></a>02376             }
<a name="l02377"></a>02377 
<a name="l02378"></a>02378             <span class="keywordflow">if</span> ((a &amp; 255)==255 &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) 
<a name="l02379"></a>02379                 <span class="keywordflow">break</span>;
<a name="l02380"></a>02380         }
<a name="l02381"></a>02381 
<a name="l02382"></a>02382         <span class="comment">/* strands */</span>
<a name="l02383"></a>02383         <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>) {
<a name="l02384"></a>02384             <span class="comment">/* for each bounding box containing a number of strands */</span>
<a name="l02385"></a>02385             sbound= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>;
<a name="l02386"></a>02386             <span class="keywordflow">for</span> (c=0; c&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>; c++, sbound++) {
<a name="l02387"></a>02387                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#a10cefb70292f40dc1d2ff66530c5e4b4">boundbox</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, obwinmat))
<a name="l02388"></a>02388                     <span class="keywordflow">continue</span>;
<a name="l02389"></a>02389 
<a name="l02390"></a>02390                 <span class="comment">/* for each strand in this bounding box */</span>
<a name="l02391"></a>02391                 <span class="keywordflow">for</span> (a=sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#ab08575b8cb6f47ae376afa33239360f6">start</a>; a&lt;sbound-&gt;end; a++) {
<a name="l02392"></a>02392                     strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, a);
<a name="l02393"></a>02393 
<a name="l02394"></a>02394                     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>= obi;
<a name="l02395"></a>02395                     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>;
<a name="l02396"></a>02396                     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a>= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a23b915de538dd5c68a1d8f8f7dc335c6">adaptcos</a>;
<a name="l02397"></a>02397                     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a> *= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a>;
<a name="l02398"></a>02398                     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>= strand;
<a name="l02399"></a>02399                     svert= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>;
<a name="l02400"></a>02400 
<a name="l02401"></a>02401                     <span class="comment">/* note, these conditions are copied in shadowbuf_autoclip() */</span>
<a name="l02402"></a>02402                     <span class="keywordflow">if</span> (sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>!= ma) {
<a name="l02403"></a>02403                         ma= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>;
<a name="l02404"></a>02404                         ok= 1;
<a name="l02405"></a>02405                         <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>)==0) ok= 0;
<a name="l02406"></a>02406                     }
<a name="l02407"></a>02407 
<a name="l02408"></a>02408                     <span class="keywordflow">if</span> (ok &amp;&amp; (sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a09b2691a6cbbfdf69783798db24db9c3">lay</a> &amp; lay)) {
<a name="l02409"></a>02409                         <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(cache, strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>);
<a name="l02410"></a>02410 
<a name="l02411"></a>02411                         <span class="keywordflow">for</span> (b=0; b&lt;strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>-1; b++, svert++) {
<a name="l02412"></a>02412                             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]= (b &gt; 0)? (svert-1): svert;
<a name="l02413"></a>02413                             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]= svert;
<a name="l02414"></a>02414                             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]= svert+1;
<a name="l02415"></a>02415                             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]= (b &lt; strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>-2)? svert+2: svert+1;
<a name="l02416"></a>02416 
<a name="l02417"></a>02417                             c1= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]-strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>, obwinmat, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, ho1);
<a name="l02418"></a>02418                             c2= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>, obwinmat, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, ho2);
<a name="l02419"></a>02419                             c3= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>, obwinmat, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, ho3);
<a name="l02420"></a>02420                             c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a59d2a9079f3b97f9fded111841e5f5d1">zbuf_shadow_project</a>(cache, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]-strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>, obwinmat, sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, ho4);
<a name="l02421"></a>02421 
<a name="l02422"></a>02422                             <span class="keywordflow">if</span> (!(c1 &amp; c2 &amp; c3 &amp; c4))
<a name="l02423"></a>02423                                 <a class="code" href="../../d3/dda/strand_8h.html#adb02dabf7d4fa72157389a58f1aa906c">render_strand_segment</a>(re, winmat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;zspan, 1, &amp;sseg);
<a name="l02424"></a>02424                         }
<a name="l02425"></a>02425                     }
<a name="l02426"></a>02426 
<a name="l02427"></a>02427                     <span class="keywordflow">if</span> ((a &amp; 255)==255 &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) 
<a name="l02428"></a>02428                         <span class="keywordflow">break</span>;
<a name="l02429"></a>02429                 }
<a name="l02430"></a>02430             }
<a name="l02431"></a>02431         }
<a name="l02432"></a>02432 
<a name="l02433"></a>02433         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) 
<a name="l02434"></a>02434             <span class="keywordflow">break</span>;
<a name="l02435"></a>02435     }
<a name="l02436"></a>02436     
<a name="l02437"></a>02437     <span class="comment">/* merge buffers */</span>
<a name="l02438"></a>02438     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a04f7a5531fb598ef1de609b9f3dec4e6">LA_SHADBUF_HALFWAY</a>) {
<a name="l02439"></a>02439         <span class="keywordflow">for</span> (a=size*size -1; a&gt;=0; a--)
<a name="l02440"></a>02440             rectz[a]= (rectz[a]&gt;&gt;1) + (zspan.<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>[a]&gt;&gt;1);
<a name="l02441"></a>02441         
<a name="l02442"></a>02442         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan.<a class="code" href="../../d2/d95/structZSpan.html#a5aa9fea695102a662cae1e1e19865e0d">rectz1</a>);
<a name="l02443"></a>02443     }
<a name="l02444"></a>02444     
<a name="l02445"></a>02445     <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(&amp;zspan);
<a name="l02446"></a>02446 }
<a name="l02447"></a>02447 
<a name="l02448"></a><a class="code" href="../../dc/da5/zbuf_8c.html#aeb947a34f10a55e433da8eecb0880469">02448</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#aeb947a34f10a55e433da8eecb0880469">zbuffill_sss</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l02449"></a>02449 {
<a name="l02450"></a>02450     <span class="keywordtype">double</span> zxd, zyd, zy0, z;
<a name="l02451"></a>02451     <span class="keywordtype">float</span> x0, y0, x1, y1, x2, y2, z0, z1, z2, xx1, *span1, *span2;
<a name="l02452"></a>02452     <span class="keywordtype">int</span> x, y, sn1, sn2, rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>, my0, my2;
<a name="l02453"></a>02453     <span class="comment">/* init */</span>
<a name="l02454"></a>02454     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l02455"></a>02455     
<a name="l02456"></a>02456     <span class="comment">/* set spans */</span>
<a name="l02457"></a>02457     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l02458"></a>02458     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l02459"></a>02459     <span class="keywordflow">if</span> (v4) {
<a name="l02460"></a>02460         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l02461"></a>02461         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l02462"></a>02462     }
<a name="l02463"></a>02463     <span class="keywordflow">else</span> 
<a name="l02464"></a>02464         <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v1);
<a name="l02465"></a>02465     
<a name="l02466"></a>02466     <span class="comment">/* clipped */</span>
<a name="l02467"></a>02467     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02468"></a>02468     
<a name="l02469"></a>02469     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l02470"></a>02470     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l02471"></a>02471     
<a name="l02472"></a>02472     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l02473"></a>02473     
<a name="l02474"></a>02474     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l02475"></a>02475     x1= v1[0]- v2[0];
<a name="l02476"></a>02476     x2= v2[0]- v3[0];
<a name="l02477"></a>02477     y1= v1[1]- v2[1];
<a name="l02478"></a>02478     y2= v2[1]- v3[1];
<a name="l02479"></a>02479     z1= v1[2]- v2[2];
<a name="l02480"></a>02480     z2= v2[2]- v3[2];
<a name="l02481"></a>02481     
<a name="l02482"></a>02482     x0= y1*z2-z1*y2;
<a name="l02483"></a>02483     y0= z1*x2-x1*z2;
<a name="l02484"></a>02484     z0= x1*y2-y1*x2;
<a name="l02485"></a>02485     
<a name="l02486"></a>02486     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l02487"></a>02487     
<a name="l02488"></a>02488     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l02489"></a>02489     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l02490"></a>02490     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l02491"></a>02491     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l02492"></a>02492     
<a name="l02493"></a>02493     <span class="comment">/* correct span */</span>
<a name="l02494"></a>02494     sn1= (my0 + my2)/2;
<a name="l02495"></a>02495     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l02496"></a>02496         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l02497"></a>02497         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l02498"></a>02498     }
<a name="l02499"></a>02499     <span class="keywordflow">else</span> {
<a name="l02500"></a>02500         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l02501"></a>02501         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l02502"></a>02502     }
<a name="l02503"></a>02503     
<a name="l02504"></a>02504     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l02505"></a>02505         sn1= floor(*span1);
<a name="l02506"></a>02506         sn2= floor(*span2);
<a name="l02507"></a>02507         sn1++; 
<a name="l02508"></a>02508         
<a name="l02509"></a>02509         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l02510"></a>02510         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l02511"></a>02511         
<a name="l02512"></a>02512         z= (double)sn1*zxd + zy0;
<a name="l02513"></a>02513         
<a name="l02514"></a>02514         <span class="keywordflow">for</span> (x= sn1; x&lt;=sn2; x++, z+=zxd)
<a name="l02515"></a>02515             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aab2708385df5769634cdd9219c6f9b00">sss_func</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#af9af3788062b657f2d32538aff0dea3a">sss_handle</a>, obi, zvlnr, x, y, z);
<a name="l02516"></a>02516         
<a name="l02517"></a>02517         zy0 -= zyd;
<a name="l02518"></a>02518     }
<a name="l02519"></a>02519 }
<a name="l02520"></a>02520 
<a name="l02521"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a3c96c9e967da2dfe8e8255fc0e6f39dd">02521</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a3c96c9e967da2dfe8e8255fc0e6f39dd">zbuffer_sss</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keywordtype">void</span> *handle, <span class="keywordtype">void</span> (*func)(<span class="keywordtype">void</span>*, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>))
<a name="l02522"></a>02522 {
<a name="l02523"></a>02523     <a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> cache[<a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>];
<a name="l02524"></a>02524     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspan;
<a name="l02525"></a>02525     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l02526"></a>02526     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l02527"></a>02527     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02528"></a>02528     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, *v2, *v3, *v4;
<a name="l02529"></a>02529     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma=0, *sss_ma= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.sss_mat;
<a name="l02530"></a>02530     <span class="keywordtype">float</span> obwinmat[4][4], winmat[4][4], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[4];
<a name="l02531"></a>02531     <span class="keywordtype">float</span> ho1[4], ho2[4], ho3[4], ho4[4]={0};
<a name="l02532"></a>02532     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, v, zvlnr, c1, c2, c3, c4=0;
<a name="l02533"></a>02533     <span class="keywordtype">short</span> nofill=0, env=0, wire=0;
<a name="l02534"></a>02534     
<a name="l02535"></a>02535     <a class="code" href="../../df/d9d/zbuf_8h.html#a2b4f0907bbdcc8f79a1cec54d5b2b492">zbuf_make_winmat</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, winmat);
<a name="l02536"></a>02536     <a class="code" href="../../dc/da5/zbuf_8c.html#ab56f4bac77457cff9ef4a6e8c61ac06e">zbuffer_part_bounds</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy, pa, bounds);
<a name="l02537"></a>02537     <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(&amp;zspan, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.clipcrop);
<a name="l02538"></a>02538 
<a name="l02539"></a>02539     zspan.<a class="code" href="../../d2/d95/structZSpan.html#af9af3788062b657f2d32538aff0dea3a">sss_handle</a>= handle;
<a name="l02540"></a>02540     zspan.<a class="code" href="../../d2/d95/structZSpan.html#aab2708385df5769634cdd9219c6f9b00">sss_func</a>= func;
<a name="l02541"></a>02541     
<a name="l02542"></a>02542     <span class="comment">/* needed for transform from hoco to zbuffer co */</span>
<a name="l02543"></a>02543     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>=  ((float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx)/2.0f;
<a name="l02544"></a>02544     zspan.<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>=  ((float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy)/2.0f;
<a name="l02545"></a>02545     
<a name="l02546"></a>02546     <span class="comment">/* -0.5f to center the sample position */</span>
<a name="l02547"></a>02547     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - 0.5f;
<a name="l02548"></a>02548     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - 0.5f;
<a name="l02549"></a>02549     
<a name="l02550"></a>02550     <span class="comment">/* filling methods */</span>
<a name="l02551"></a>02551     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#aeb947a34f10a55e433da8eecb0880469">zbuffill_sss</a>;
<a name="l02552"></a>02552 
<a name="l02553"></a>02553     <span class="comment">/* fill front and back zbuffer */</span>
<a name="l02554"></a>02554     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>) {
<a name="l02555"></a>02555         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a52f4f2e4cceaff5e79ad83bc44587151">recto</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0); 
<a name="l02556"></a>02556         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a19296bd81488c2b963562b2aa11ded26">rectp</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0); 
<a name="l02557"></a>02557         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0x7FFFFFFF);
<a name="l02558"></a>02558     }
<a name="l02559"></a>02559     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#aa1cbf3a7abbda6259a81c91cb58ccee4">rectbackz</a>) {
<a name="l02560"></a>02560         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a012b844e1b4685668de69a321b6eef2e">rectbacko</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0); 
<a name="l02561"></a>02561         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1b8f6bb01edfa2fed38536029498171c">rectbackp</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0); 
<a name="l02562"></a>02562         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#aa1cbf3a7abbda6259a81c91cb58ccee4">rectbackz</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, -0x7FFFFFFF);
<a name="l02563"></a>02563     }
<a name="l02564"></a>02564 
<a name="l02565"></a>02565     <span class="keywordflow">for</span> (i=0, obi=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.instancetable.first; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l02566"></a>02566         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02567"></a>02567 
<a name="l02568"></a>02568         <span class="keywordflow">if</span> (!(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay))
<a name="l02569"></a>02569             <span class="keywordflow">continue</span>;
<a name="l02570"></a>02570 
<a name="l02571"></a>02571         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l02572"></a>02572             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obwinmat, winmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l02573"></a>02573         <span class="keywordflow">else</span>
<a name="l02574"></a>02574             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obwinmat, winmat);
<a name="l02575"></a>02575 
<a name="l02576"></a>02576         <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>, bounds, obwinmat))
<a name="l02577"></a>02577             <span class="keywordflow">continue</span>;
<a name="l02578"></a>02578 
<a name="l02579"></a>02579         <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(cache, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l02580"></a>02580 
<a name="l02581"></a>02581         <span class="keywordflow">for</span> (v=0; v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; v++) {
<a name="l02582"></a>02582             <span class="keywordflow">if</span> ((v &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l02583"></a>02583             <span class="keywordflow">else</span> vlr++;
<a name="l02584"></a>02584             
<a name="l02585"></a>02585             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0f/BKE__material_8h.html#a5866d8cdad524a3c0f73977f9c2f86b7">material_in_material</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>, sss_ma)) {
<a name="l02586"></a>02586                 <span class="comment">/* three cases, visible for render, only z values and nothing */</span>
<a name="l02587"></a>02587                 <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay) {
<a name="l02588"></a>02588                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!=ma) {
<a name="l02589"></a>02589                         ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l02590"></a>02590                         nofill= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0b02e3e0afacbc7473b8ed9984a65c01">MA_ONLYCAST</a>;
<a name="l02591"></a>02591                         env= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#af030e92d0ce6acc49b989b9a43bbacb4">MA_ENV</a>);
<a name="l02592"></a>02592                         wire= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>);
<a name="l02593"></a>02593                     }
<a name="l02594"></a>02594                 }
<a name="l02595"></a>02595                 <span class="keywordflow">else</span> {
<a name="l02596"></a>02596                     nofill= 1;
<a name="l02597"></a>02597                     ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;   <span class="comment">/* otherwise nofill can hang */</span>
<a name="l02598"></a>02598                 }
<a name="l02599"></a>02599                 
<a name="l02600"></a>02600                 <span class="keywordflow">if</span> (nofill==0 &amp;&amp; wire==0 &amp;&amp; env==0) {
<a name="l02601"></a>02601                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> partclip;
<a name="l02602"></a>02602                     
<a name="l02603"></a>02603                     v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l02604"></a>02604                     v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l02605"></a>02605                     v3= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l02606"></a>02606                     v4= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l02607"></a>02607 
<a name="l02608"></a>02608                     c1= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho1);
<a name="l02609"></a>02609                     c2= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho2);
<a name="l02610"></a>02610                     c3= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho3);
<a name="l02611"></a>02611 
<a name="l02612"></a>02612                     <span class="comment">/* partclipping doesn&#39;t need viewplane clipping */</span>
<a name="l02613"></a>02613                     partclip= c1 &amp; c2 &amp; c3;
<a name="l02614"></a>02614                     <span class="keywordflow">if</span> (v4) {
<a name="l02615"></a>02615                         c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho4);
<a name="l02616"></a>02616                         partclip &amp;= c4;
<a name="l02617"></a>02617                     }
<a name="l02618"></a>02618 
<a name="l02619"></a>02619                     <span class="keywordflow">if</span> (partclip==0) {
<a name="l02620"></a>02620                         c1= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho1);
<a name="l02621"></a>02621                         c2= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho2);
<a name="l02622"></a>02622                         c3= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho3);
<a name="l02623"></a>02623 
<a name="l02624"></a>02624                         zvlnr= v+1;
<a name="l02625"></a>02625                         <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(&amp;zspan, i, zvlnr, ho1, ho2, ho3, c1, c2, c3);
<a name="l02626"></a>02626                         <span class="keywordflow">if</span> (v4) {
<a name="l02627"></a>02627                             c4= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho4);
<a name="l02628"></a>02628                             <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(&amp;zspan, i, zvlnr+<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>, ho1, ho3, ho4, c1, c3, c4);
<a name="l02629"></a>02629                         }
<a name="l02630"></a>02630                     }
<a name="l02631"></a>02631                 }
<a name="l02632"></a>02632             }
<a name="l02633"></a>02633         }
<a name="l02634"></a>02634     }
<a name="l02635"></a>02635         
<a name="l02636"></a>02636     <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(&amp;zspan);
<a name="l02637"></a>02637 }
<a name="l02638"></a>02638 
<a name="l02639"></a>02639 <span class="comment">/* ******************** VECBLUR ACCUM BUF ************************* */</span>
<a name="l02640"></a>02640 
<a name="l02641"></a><a class="code" href="../../d6/d0d/structDrawBufPixel.html">02641</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> {
<a name="l02642"></a><a class="code" href="../../d6/d0d/structDrawBufPixel.html#af054b217eac6218c8f9fd52e5a64a560">02642</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d6/d0d/structDrawBufPixel.html#af054b217eac6218c8f9fd52e5a64a560">colpoin</a>;
<a name="l02643"></a><a class="code" href="../../d6/d0d/structDrawBufPixel.html#a6bebcad3ee9ae0e742c64c73a5e7da96">02643</a>     <span class="keywordtype">float</span> <a class="code" href="../../d6/d0d/structDrawBufPixel.html#a6bebcad3ee9ae0e742c64c73a5e7da96">alpha</a>;
<a name="l02644"></a>02644 } <a class="code" href="../../dc/da5/zbuf_8c.html#a19861f0f95c6d74017b4db70ea3585e0">DrawBufPixel</a>;
<a name="l02645"></a>02645 
<a name="l02646"></a>02646 
<a name="l02647"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a98125e9684c7a5553620aac9688a5d0e">02647</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a98125e9684c7a5553620aac9688a5d0e">zbuf_fill_in_rgba</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> *col, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l02648"></a>02648 {
<a name="l02649"></a>02649     <a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> *rectpofs, *rp;
<a name="l02650"></a>02650     <span class="keywordtype">double</span> zxd, zyd, zy0, zverg;
<a name="l02651"></a>02651     <span class="keywordtype">float</span> x0,y0,z0;
<a name="l02652"></a>02652     <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xx1;
<a name="l02653"></a>02653     <span class="keywordtype">float</span> *span1, *span2;
<a name="l02654"></a>02654     <span class="keywordtype">float</span> *rectzofs, *rz;
<a name="l02655"></a>02655     <span class="keywordtype">int</span> x, y;
<a name="l02656"></a>02656     <span class="keywordtype">int</span> sn1, sn2, rectx, my0, my2;
<a name="l02657"></a>02657     
<a name="l02658"></a>02658     <span class="comment">/* init */</span>
<a name="l02659"></a>02659     <a class="code" href="../../dc/da5/zbuf_8c.html#a58e709c78d01ba24de432d790db56e0a">zbuf_init_span</a>(zspan);
<a name="l02660"></a>02660     
<a name="l02661"></a>02661     <span class="comment">/* set spans */</span>
<a name="l02662"></a>02662     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v1, v2);
<a name="l02663"></a>02663     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v2, v3);
<a name="l02664"></a>02664     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v3, v4);
<a name="l02665"></a>02665     <a class="code" href="../../dc/da5/zbuf_8c.html#aad7bacc788e29bb35dfc0721cad3f454">zbuf_add_to_span</a>(zspan, v4, v1);
<a name="l02666"></a>02666     
<a name="l02667"></a>02667     <span class="comment">/* clipped */</span>
<a name="l02668"></a>02668     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9d7c0656f0a77ed735430eb6213f0401">minp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2841a3318bdeb927e72d6db169c3e538">maxp2</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02669"></a>02669     
<a name="l02670"></a>02670     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a> &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>) my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab81557ef3c9f6bf1dd15205a849bb880">miny2</a>; <span class="keywordflow">else</span> my0= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a6cd392278a6f46e50eb2519acf1e555b">miny1</a>;
<a name="l02671"></a>02671     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a> &gt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>) my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a670040b8ac303329c68068f5646c781f">maxy2</a>; <span class="keywordflow">else</span> my2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a942740248aeecf4ab50d235ad7e304ea">maxy1</a>;
<a name="l02672"></a>02672     
<a name="l02673"></a>02673     <span class="comment">//  printf(&quot;my %d %d\n&quot;, my0, my2);</span>
<a name="l02674"></a>02674     <span class="keywordflow">if</span> (my2&lt;my0) <span class="keywordflow">return</span>;
<a name="l02675"></a>02675     
<a name="l02676"></a>02676     <span class="comment">/* ZBUF DX DY, in floats still */</span>
<a name="l02677"></a>02677     x1= v1[0]- v2[0];
<a name="l02678"></a>02678     x2= v2[0]- v3[0];
<a name="l02679"></a>02679     y1= v1[1]- v2[1];
<a name="l02680"></a>02680     y2= v2[1]- v3[1];
<a name="l02681"></a>02681     z1= v1[2]- v2[2];
<a name="l02682"></a>02682     z2= v2[2]- v3[2];
<a name="l02683"></a>02683     x0= y1*z2-z1*y2;
<a name="l02684"></a>02684     y0= z1*x2-x1*z2;
<a name="l02685"></a>02685     z0= x1*y2-y1*x2;
<a name="l02686"></a>02686     
<a name="l02687"></a>02687     <span class="keywordflow">if</span> (z0==0.0f) <span class="keywordflow">return</span>;
<a name="l02688"></a>02688     
<a name="l02689"></a>02689     xx1= (x0*v1[0] + y0*v1[1])/z0 + v1[2];
<a name="l02690"></a>02690     
<a name="l02691"></a>02691     zxd= -(double)x0/(<span class="keywordtype">double</span>)z0;
<a name="l02692"></a>02692     zyd= -(double)y0/(<span class="keywordtype">double</span>)z0;
<a name="l02693"></a>02693     zy0= ((double)my2)*zyd + (double)xx1;
<a name="l02694"></a>02694     
<a name="l02695"></a>02695     <span class="comment">/* start-offset in rect */</span>
<a name="l02696"></a>02696     rectx= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#acf31ba649d7039d52e54b5fc1fc089ca">rectx</a>;
<a name="l02697"></a>02697     rectzofs= (<span class="keywordtype">float</span> *)(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a> + rectx*my2);
<a name="l02698"></a>02698     rectpofs= ((<a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> *)zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>) + rectx*my2;
<a name="l02699"></a>02699     
<a name="l02700"></a>02700     <span class="comment">/* correct span */</span>
<a name="l02701"></a>02701     sn1= (my0 + my2)/2;
<a name="l02702"></a>02702     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>[sn1] &lt; zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>[sn1]) {
<a name="l02703"></a>02703         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l02704"></a>02704         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l02705"></a>02705     }
<a name="l02706"></a>02706     <span class="keywordflow">else</span> {
<a name="l02707"></a>02707         span1= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a36f275bf3ee30544daae41a5b848c48e">span2</a>+my2;
<a name="l02708"></a>02708         span2= zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aaf4d4e42f0e24c337f8f7cfd26f0992e">span1</a>+my2;
<a name="l02709"></a>02709     }
<a name="l02710"></a>02710     
<a name="l02711"></a>02711     <span class="keywordflow">for</span> (y=my2; y&gt;=my0; y--, span1--, span2--) {
<a name="l02712"></a>02712         
<a name="l02713"></a>02713         sn1= floor(*span1);
<a name="l02714"></a>02714         sn2= floor(*span2);
<a name="l02715"></a>02715         sn1++; 
<a name="l02716"></a>02716         
<a name="l02717"></a>02717         <span class="keywordflow">if</span> (sn2&gt;=rectx) sn2= rectx-1;
<a name="l02718"></a>02718         <span class="keywordflow">if</span> (sn1&lt;0) sn1= 0;
<a name="l02719"></a>02719         
<a name="l02720"></a>02720         <span class="keywordflow">if</span> (sn2&gt;=sn1) {
<a name="l02721"></a>02721             zverg= (double)sn1*zxd + zy0;
<a name="l02722"></a>02722             rz= rectzofs+sn1;
<a name="l02723"></a>02723             rp= rectpofs+sn1;
<a name="l02724"></a>02724             x= sn2-sn1;
<a name="l02725"></a>02725             
<a name="l02726"></a>02726             <span class="keywordflow">while</span> (x&gt;=0) {
<a name="l02727"></a>02727                 <span class="keywordflow">if</span> ( zverg &lt; *rz) {
<a name="l02728"></a>02728                     *rz= zverg;
<a name="l02729"></a>02729                     *rp= *col;
<a name="l02730"></a>02730                 }
<a name="l02731"></a>02731                 zverg+= zxd;
<a name="l02732"></a>02732                 rz++; 
<a name="l02733"></a>02733                 rp++; 
<a name="l02734"></a>02734                 x--;
<a name="l02735"></a>02735             }
<a name="l02736"></a>02736         }
<a name="l02737"></a>02737         
<a name="l02738"></a>02738         zy0-=zyd;
<a name="l02739"></a>02739         rectzofs-= rectx;
<a name="l02740"></a>02740         rectpofs-= rectx;
<a name="l02741"></a>02741     }
<a name="l02742"></a>02742 }
<a name="l02743"></a>02743 
<a name="l02744"></a>02744 <span class="comment">/* char value==255 is filled in, rest should be zero */</span>
<a name="l02745"></a>02745 <span class="comment">/* returns alpha values, but sets alpha to 1 for zero alpha pixels that have an alpha value as neighbor */</span>
<a name="l02746"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1ade648ae39bd2050185257787e6f09e">02746</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a1ade648ae39bd2050185257787e6f09e">antialias_tagbuf</a>(<span class="keywordtype">int</span> xsize, <span class="keywordtype">int</span> ysize, <span class="keywordtype">char</span> *rectmove)
<a name="l02747"></a>02747 {
<a name="l02748"></a>02748     <span class="keywordtype">char</span> *row1, *row2, *row3;
<a name="l02749"></a>02749     <span class="keywordtype">char</span> prev, <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l02750"></a>02750     <span class="keywordtype">int</span> a, x, y, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l02751"></a>02751     
<a name="l02752"></a>02752     <span class="comment">/* 1: tag pixels to be candidate for AA */</span>
<a name="l02753"></a>02753     <span class="keywordflow">for</span> (y=2; y&lt;ysize; y++) {
<a name="l02754"></a>02754         <span class="comment">/* setup rows */</span>
<a name="l02755"></a>02755         row1= rectmove + (y-2)*xsize;
<a name="l02756"></a>02756         row2= row1 + xsize;
<a name="l02757"></a>02757         row3= row2 + xsize;
<a name="l02758"></a>02758         <span class="keywordflow">for</span> (x=2; x&lt;xsize; x++, row1++, row2++, row3++) {
<a name="l02759"></a>02759             <span class="keywordflow">if</span> (row2[1]) {
<a name="l02760"></a>02760                 <span class="keywordflow">if</span> (row2[0]==0 || row2[2]==0 || row1[1]==0 || row3[1]==0)
<a name="l02761"></a>02761                     row2[1]= 128;
<a name="l02762"></a>02762             }
<a name="l02763"></a>02763         }
<a name="l02764"></a>02764     }
<a name="l02765"></a>02765     
<a name="l02766"></a>02766     <span class="comment">/* 2: evaluate horizontal scanlines and calculate alphas */</span>
<a name="l02767"></a>02767     row1= rectmove;
<a name="l02768"></a>02768     <span class="keywordflow">for</span> (y=0; y&lt;ysize; y++) {
<a name="l02769"></a>02769         row1++;
<a name="l02770"></a>02770         <span class="keywordflow">for</span> (x=1; x&lt;xsize; x++, row1++) {
<a name="l02771"></a>02771             <span class="keywordflow">if</span> (row1[0]==128 &amp;&amp; row1[1]==128) {
<a name="l02772"></a>02772                 <span class="comment">/* find previous color and next color and amount of steps to blend */</span>
<a name="l02773"></a>02773                 prev= row1[-1];
<a name="l02774"></a>02774                 step= 1;
<a name="l02775"></a>02775                 <span class="keywordflow">while</span> (x+step&lt;xsize &amp;&amp; row1[step]==128)
<a name="l02776"></a>02776                     step++;
<a name="l02777"></a>02777                 
<a name="l02778"></a>02778                 <span class="keywordflow">if</span> (x+step!=xsize) {
<a name="l02779"></a>02779                     <span class="comment">/* now we can blend values */</span>
<a name="l02780"></a>02780                     next= row1[<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>];
<a name="l02781"></a>02781 
<a name="l02782"></a>02782                     <span class="comment">/* note, prev value can be next value, but we do this loop to clear 128 then */</span>
<a name="l02783"></a>02783                     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>; a++) {
<a name="l02784"></a>02784                         <span class="keywordtype">int</span> fac, mfac;
<a name="l02785"></a>02785                         
<a name="l02786"></a>02786                         fac= ((a+1)&lt;&lt;8)/(step+1);
<a name="l02787"></a>02787                         mfac= 255-fac;
<a name="l02788"></a>02788                         
<a name="l02789"></a>02789                         row1[a]= (prev*mfac + next*fac)&gt;&gt;8; 
<a name="l02790"></a>02790                     }
<a name="l02791"></a>02791                 }
<a name="l02792"></a>02792             }
<a name="l02793"></a>02793         }
<a name="l02794"></a>02794     }
<a name="l02795"></a>02795     
<a name="l02796"></a>02796     <span class="comment">/* 3: evaluate vertical scanlines and calculate alphas */</span>
<a name="l02797"></a>02797     <span class="comment">/*    use for reading a copy of the original tagged buffer */</span>
<a name="l02798"></a>02798     <span class="keywordflow">for</span> (x=0; x&lt;xsize; x++) {
<a name="l02799"></a>02799         row1= rectmove + x+xsize;
<a name="l02800"></a>02800         
<a name="l02801"></a>02801         <span class="keywordflow">for</span> (y=1; y&lt;ysize; y++, row1+=xsize) {
<a name="l02802"></a>02802             <span class="keywordflow">if</span> (row1[0]==128 &amp;&amp; row1[xsize]==128) {
<a name="l02803"></a>02803                 <span class="comment">/* find previous color and next color and amount of steps to blend */</span>
<a name="l02804"></a>02804                 prev= row1[-xsize];
<a name="l02805"></a>02805                 step= 1;
<a name="l02806"></a>02806                 <span class="keywordflow">while</span> (y+step&lt;ysize &amp;&amp; row1[step*xsize]==128)
<a name="l02807"></a>02807                     step++;
<a name="l02808"></a>02808                 
<a name="l02809"></a>02809                 <span class="keywordflow">if</span> (y+step!=ysize) {
<a name="l02810"></a>02810                     <span class="comment">/* now we can blend values */</span>
<a name="l02811"></a>02811                     next= row1[step*xsize];
<a name="l02812"></a>02812                     <span class="comment">/* note, prev value can be next value, but we do this loop to clear 128 then */</span>
<a name="l02813"></a>02813                     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>; a++) {
<a name="l02814"></a>02814                         <span class="keywordtype">int</span> fac, mfac;
<a name="l02815"></a>02815                         
<a name="l02816"></a>02816                         fac= ((a+1)&lt;&lt;8)/(step+1);
<a name="l02817"></a>02817                         mfac= 255-fac;
<a name="l02818"></a>02818                         
<a name="l02819"></a>02819                         row1[a*xsize]= (prev*mfac + next*fac)&gt;&gt;8; 
<a name="l02820"></a>02820                     }
<a name="l02821"></a>02821                 }
<a name="l02822"></a>02822             }
<a name="l02823"></a>02823         }
<a name="l02824"></a>02824     }
<a name="l02825"></a>02825     
<a name="l02826"></a>02826     <span class="comment">/* last: pixels with 0 we fill in zbuffer, with 1 we skip for mask */</span>
<a name="l02827"></a>02827     <span class="keywordflow">for</span> (y=2; y&lt;ysize; y++) {
<a name="l02828"></a>02828         <span class="comment">/* setup rows */</span>
<a name="l02829"></a>02829         row1= rectmove + (y-2)*xsize;
<a name="l02830"></a>02830         row2= row1 + xsize;
<a name="l02831"></a>02831         row3= row2 + xsize;
<a name="l02832"></a>02832         <span class="keywordflow">for</span> (x=2; x&lt;xsize; x++, row1++, row2++, row3++) {
<a name="l02833"></a>02833             <span class="keywordflow">if</span> (row2[1]==0) {
<a name="l02834"></a>02834                 <span class="keywordflow">if</span> (row2[0]&gt;1 || row2[2]&gt;1 || row1[1]&gt;1 || row3[1]&gt;1)
<a name="l02835"></a>02835                     row2[1]= 1;
<a name="l02836"></a>02836             }
<a name="l02837"></a>02837         }
<a name="l02838"></a>02838     }
<a name="l02839"></a>02839 }
<a name="l02840"></a>02840 
<a name="l02841"></a>02841 <span class="comment">/* in: two vectors, first vector points from origin back in time, 2nd vector points to future */</span>
<a name="l02842"></a>02842 <span class="comment">/* we make this into 3 points, center point is (0,0) */</span>
<a name="l02843"></a>02843 <span class="comment">/* and offset the center point just enough to make curve go through midpoint */</span>
<a name="l02844"></a>02844 
<a name="l02845"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">02845</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">quad_bezier_2d</a>(<span class="keywordtype">float</span> *result, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *ipodata)
<a name="l02846"></a>02846 {
<a name="l02847"></a>02847     <span class="keywordtype">float</span> p1[2], p2[2], p3[2];
<a name="l02848"></a>02848     
<a name="l02849"></a>02849     p3[0]= -v2[0];
<a name="l02850"></a>02850     p3[1]= -v2[1];
<a name="l02851"></a>02851     
<a name="l02852"></a>02852     p1[0]= v1[0];
<a name="l02853"></a>02853     p1[1]= v1[1];
<a name="l02854"></a>02854     
<a name="l02855"></a>02855     <span class="comment">/* official formula 2*p2 - .5*p1 - .5*p3 */</span>
<a name="l02856"></a>02856     p2[0]= -0.5f*p1[0] - 0.5f*p3[0];
<a name="l02857"></a>02857     p2[1]= -0.5f*p1[1] - 0.5f*p3[1];
<a name="l02858"></a>02858     
<a name="l02859"></a>02859     result[0]= ipodata[0]*p1[0] + ipodata[1]*p2[0] + ipodata[2]*p3[0];
<a name="l02860"></a>02860     result[1]= ipodata[0]*p1[1] + ipodata[1]*p2[1] + ipodata[2]*p3[1];
<a name="l02861"></a>02861 }
<a name="l02862"></a>02862 
<a name="l02863"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ad251856471a6f3b41c78ce4f2e464396">02863</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ad251856471a6f3b41c78ce4f2e464396">set_quad_bezier_ipo</a>(<span class="keywordtype">float</span> fac, <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l02864"></a>02864 {
<a name="l02865"></a>02865     <span class="keywordtype">float</span> mfac= (1.0f-fac);
<a name="l02866"></a>02866     
<a name="l02867"></a>02867     data[0]= mfac*mfac;
<a name="l02868"></a>02868     data[1]= 2.0f*mfac*fac;
<a name="l02869"></a>02869     data[2]= fac*fac;
<a name="l02870"></a>02870 }
<a name="l02871"></a>02871 
<a name="l02872"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a70d92718297d718529ad02ba9601f934">02872</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a78bbb09e55ccdf895e1f8c6354b9dcbd">RE_zbuf_accumulate_vecblur</a>(<a class="code" href="../../d4/d1a/structNodeBlurData.html">NodeBlurData</a> *nbd, <span class="keywordtype">int</span> xsize, <span class="keywordtype">int</span> ysize, <span class="keywordtype">float</span> *newrect, <span class="keywordtype">float</span> *imgrect, <span class="keywordtype">float</span> *vecbufrect, <span class="keywordtype">float</span> *zbufrect)
<a name="l02873"></a>02873 {
<a name="l02874"></a>02874     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspan;
<a name="l02875"></a>02875     <a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> *rectdraw, *dr;
<a name="l02876"></a>02876     <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>[256][2];
<a name="l02877"></a>02877     <span class="keywordtype">float</span> v1[3], v2[3], v3[3], v4[3], fx, fy;
<a name="l02878"></a>02878     <span class="keywordtype">float</span> *rectvz, *dvz, *dimg, *dvec1, *dvec2, *dz, *dz1, *dz2, *rectz;
<a name="l02879"></a>02879     <span class="keywordtype">float</span> *minvecbufrect= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *rectweight, *rw, *rectmax, *rm, *ro;
<a name="l02880"></a>02880     <span class="keywordtype">float</span> maxspeedsq= (float)nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#aa15acc2abd000b54c533318f0569503b">maxspeed</a>*nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#aa15acc2abd000b54c533318f0569503b">maxspeed</a>;
<a name="l02881"></a>02881     <span class="keywordtype">int</span> y, x, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, maxspeed=nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#aa15acc2abd000b54c533318f0569503b">maxspeed</a>, samples= nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#a2de30f4e2a2b59f85787cc06cf4d295c">samples</a>;
<a name="l02882"></a>02882     <span class="keywordtype">int</span> tsktsk= 0;
<a name="l02883"></a>02883     <span class="keyword">static</span> <span class="keywordtype">int</span> firsttime= 1;
<a name="l02884"></a>02884     <span class="keywordtype">char</span> *rectmove, *dm;
<a name="l02885"></a>02885     
<a name="l02886"></a>02886     <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(&amp;zspan, xsize, ysize, 1.0f);
<a name="l02887"></a>02887     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>=  ((float)xsize)/2.0f;
<a name="l02888"></a>02888     zspan.<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>=  ((float)ysize)/2.0f;
<a name="l02889"></a>02889     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= 0.0f;
<a name="l02890"></a>02890     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= 0.0f;
<a name="l02891"></a>02891     
<a name="l02892"></a>02892     <span class="comment">/* the buffers */</span>
<a name="l02893"></a>02893     rectz= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*xsize*ysize, <span class="stringliteral">&quot;zbuf accum&quot;</span>);
<a name="l02894"></a>02894     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= (<span class="keywordtype">int</span> *)rectz;
<a name="l02895"></a>02895     
<a name="l02896"></a>02896     rectmove= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(xsize*ysize, <span class="stringliteral">&quot;rectmove&quot;</span>);
<a name="l02897"></a>02897     rectdraw= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a>)*xsize*ysize, <span class="stringliteral">&quot;rect draw&quot;</span>);
<a name="l02898"></a>02898     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ac8680a16a1ecd7b2421ade4ac5bea894">rectp</a>= (<span class="keywordtype">int</span> *)rectdraw;
<a name="l02899"></a>02899 
<a name="l02900"></a>02900     rectweight= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*xsize*ysize, <span class="stringliteral">&quot;rect weight&quot;</span>);
<a name="l02901"></a>02901     rectmax= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*xsize*ysize, <span class="stringliteral">&quot;rect max&quot;</span>);
<a name="l02902"></a>02902     
<a name="l02903"></a>02903     <span class="comment">/* debug... check if PASS_VECTOR_MAX still is in buffers */</span>
<a name="l02904"></a>02904     dvec1= vecbufrect;
<a name="l02905"></a>02905     <span class="keywordflow">for</span> (x= 4*xsize*ysize; x&gt;0; x--, dvec1++) {
<a name="l02906"></a>02906         <span class="keywordflow">if</span> (dvec1[0]==<a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>) {
<a name="l02907"></a>02907             dvec1[0]= 0.0f;
<a name="l02908"></a>02908             tsktsk= 1;
<a name="l02909"></a>02909         }
<a name="l02910"></a>02910     }
<a name="l02911"></a>02911     <span class="keywordflow">if</span> (tsktsk) printf(<span class="stringliteral">&quot;Found uninitialized speed in vector buffer... fixed.\n&quot;</span>);
<a name="l02912"></a>02912     
<a name="l02913"></a>02913     <span class="comment">/* min speed? then copy speedbuffer to recalculate speed vectors */</span>
<a name="l02914"></a>02914     <span class="keywordflow">if</span> (nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#abdbf7a2faae96e9e4b7ab60ce82a550b">minspeed</a>) {
<a name="l02915"></a>02915         <span class="keywordtype">float</span> minspeed= (float)nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#abdbf7a2faae96e9e4b7ab60ce82a550b">minspeed</a>;
<a name="l02916"></a>02916         <span class="keywordtype">float</span> minspeedsq= minspeed*minspeed;
<a name="l02917"></a>02917         
<a name="l02918"></a>02918         minvecbufrect= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*xsize*ysize, <span class="stringliteral">&quot;minspeed buf&quot;</span>);
<a name="l02919"></a>02919         
<a name="l02920"></a>02920         dvec1= vecbufrect;
<a name="l02921"></a>02921         dvec2= minvecbufrect;
<a name="l02922"></a>02922         <span class="keywordflow">for</span> (x= 2*xsize*ysize; x&gt;0; x--, dvec1+=2, dvec2+=2) {
<a name="l02923"></a>02923             <span class="keywordflow">if</span> (dvec1[0]==0.0f &amp;&amp; dvec1[1]==0.0f) {
<a name="l02924"></a>02924                 dvec2[0]= dvec1[0];
<a name="l02925"></a>02925                 dvec2[1]= dvec1[1];
<a name="l02926"></a>02926             }
<a name="l02927"></a>02927             <span class="keywordflow">else</span> {
<a name="l02928"></a>02928                 <span class="keywordtype">float</span> speedsq= dvec1[0]*dvec1[0] + dvec1[1]*dvec1[1];
<a name="l02929"></a>02929                 <span class="keywordflow">if</span> (speedsq &lt;= minspeedsq) {
<a name="l02930"></a>02930                     dvec2[0]= 0.0f;
<a name="l02931"></a>02931                     dvec2[1]= 0.0f;
<a name="l02932"></a>02932                 }
<a name="l02933"></a>02933                 <span class="keywordflow">else</span> {
<a name="l02934"></a>02934                     speedsq= 1.0f - minspeed/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(speedsq);
<a name="l02935"></a>02935                     dvec2[0]= speedsq*dvec1[0];
<a name="l02936"></a>02936                     dvec2[1]= speedsq*dvec1[1];
<a name="l02937"></a>02937                 }
<a name="l02938"></a>02938             }
<a name="l02939"></a>02939         }
<a name="l02940"></a>02940         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span> *, minvecbufrect, vecbufrect);
<a name="l02941"></a>02941     }
<a name="l02942"></a>02942     
<a name="l02943"></a>02943     <span class="comment">/* make vertex buffer with averaged speed and zvalues */</span>
<a name="l02944"></a>02944     rectvz= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(xsize+1)*(ysize+1), <span class="stringliteral">&quot;vertices&quot;</span>);
<a name="l02945"></a>02945     dvz= rectvz;
<a name="l02946"></a>02946     <span class="keywordflow">for</span> (y=0; y&lt;=ysize; y++) {
<a name="l02947"></a>02947         
<a name="l02948"></a>02948         <span class="keywordflow">if</span> (y==0)
<a name="l02949"></a>02949             dvec1= vecbufrect + 4*y*xsize;
<a name="l02950"></a>02950         <span class="keywordflow">else</span>
<a name="l02951"></a>02951             dvec1= vecbufrect + 4*(y-1)*xsize;
<a name="l02952"></a>02952         
<a name="l02953"></a>02953         <span class="keywordflow">if</span> (y==ysize)
<a name="l02954"></a>02954             dvec2= vecbufrect + 4*(y-1)*xsize;
<a name="l02955"></a>02955         <span class="keywordflow">else</span>
<a name="l02956"></a>02956             dvec2= vecbufrect + 4*y*xsize;
<a name="l02957"></a>02957         
<a name="l02958"></a>02958         <span class="keywordflow">for</span> (x=0; x&lt;=xsize; x++) {
<a name="l02959"></a>02959             
<a name="l02960"></a>02960             <span class="comment">/* two vectors, so a step loop */</span>
<a name="l02961"></a>02961             <span class="keywordflow">for</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>=0; <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>&lt;2; <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>++, dvec1+=2, dvec2+=2, dvz+=2) {
<a name="l02962"></a>02962                 <span class="comment">/* average on minimal speed */</span>
<a name="l02963"></a>02963                 <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>= 0;
<a name="l02964"></a>02964                 
<a name="l02965"></a>02965                 <span class="keywordflow">if</span> (x!=0) {
<a name="l02966"></a>02966                     <span class="keywordflow">if</span> (dvec1[-4]!=0.0f || dvec1[-3]!=0.0f) {
<a name="l02967"></a>02967                         dvz[0]= dvec1[-4];
<a name="l02968"></a>02968                         dvz[1]= dvec1[-3];
<a name="l02969"></a>02969                         div++;
<a name="l02970"></a>02970                     }
<a name="l02971"></a>02971                     <span class="keywordflow">if</span> (dvec2[-4]!=0.0f || dvec2[-3]!=0.0f) {
<a name="l02972"></a>02972                         <span class="keywordflow">if</span> (div==0) {
<a name="l02973"></a>02973                             dvz[0]= dvec2[-4];
<a name="l02974"></a>02974                             dvz[1]= dvec2[-3];
<a name="l02975"></a>02975                             div++;
<a name="l02976"></a>02976                         }
<a name="l02977"></a>02977                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec2[-4]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec2[-3]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[1])) ) {
<a name="l02978"></a>02978                             dvz[0]= dvec2[-4];
<a name="l02979"></a>02979                             dvz[1]= dvec2[-3];
<a name="l02980"></a>02980                         }
<a name="l02981"></a>02981                     }
<a name="l02982"></a>02982                 }
<a name="l02983"></a>02983 
<a name="l02984"></a>02984                 <span class="keywordflow">if</span> (x!=xsize) {
<a name="l02985"></a>02985                     <span class="keywordflow">if</span> (dvec1[0]!=0.0f || dvec1[1]!=0.0f) {
<a name="l02986"></a>02986                         <span class="keywordflow">if</span> (div==0) {
<a name="l02987"></a>02987                             dvz[0]= dvec1[0];
<a name="l02988"></a>02988                             dvz[1]= dvec1[1];
<a name="l02989"></a>02989                             div++;
<a name="l02990"></a>02990                         }
<a name="l02991"></a>02991                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec1[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec1[1]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[1])) ) {
<a name="l02992"></a>02992                             dvz[0]= dvec1[0];
<a name="l02993"></a>02993                             dvz[1]= dvec1[1];
<a name="l02994"></a>02994                         }
<a name="l02995"></a>02995                     }
<a name="l02996"></a>02996                     <span class="keywordflow">if</span> (dvec2[0]!=0.0f || dvec2[1]!=0.0f) {
<a name="l02997"></a>02997                         <span class="keywordflow">if</span> (div==0) {
<a name="l02998"></a>02998                             dvz[0]= dvec2[0];
<a name="l02999"></a>02999                             dvz[1]= dvec2[1];
<a name="l03000"></a>03000                         }
<a name="l03001"></a>03001                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec2[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvec2[1]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(dvz[1])) ) {
<a name="l03002"></a>03002                             dvz[0]= dvec2[0];
<a name="l03003"></a>03003                             dvz[1]= dvec2[1];
<a name="l03004"></a>03004                         }
<a name="l03005"></a>03005                     }
<a name="l03006"></a>03006                 }
<a name="l03007"></a>03007                 <span class="keywordflow">if</span> (maxspeed) {
<a name="l03008"></a>03008                     <span class="keywordtype">float</span> speedsq= dvz[0]*dvz[0] + dvz[1]*dvz[1];
<a name="l03009"></a>03009                     <span class="keywordflow">if</span> (speedsq &gt; maxspeedsq) {
<a name="l03010"></a>03010                         speedsq= (float)maxspeed/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(speedsq);
<a name="l03011"></a>03011                         dvz[0]*= speedsq;
<a name="l03012"></a>03012                         dvz[1]*= speedsq;
<a name="l03013"></a>03013                     }
<a name="l03014"></a>03014                 }
<a name="l03015"></a>03015             }
<a name="l03016"></a>03016         }
<a name="l03017"></a>03017     }
<a name="l03018"></a>03018     
<a name="l03019"></a>03019     <span class="comment">/* set border speeds to keep border speeds on border */</span>
<a name="l03020"></a>03020     dz1= rectvz;
<a name="l03021"></a>03021     dz2= rectvz+4*(ysize)*(xsize+1);
<a name="l03022"></a>03022     <span class="keywordflow">for</span> (x=0; x&lt;=xsize; x++, dz1+=4, dz2+=4) {
<a name="l03023"></a>03023         dz1[1]= 0.0f;
<a name="l03024"></a>03024         dz2[1]= 0.0f;
<a name="l03025"></a>03025         dz1[3]= 0.0f;
<a name="l03026"></a>03026         dz2[3]= 0.0f;
<a name="l03027"></a>03027     }
<a name="l03028"></a>03028     dz1= rectvz;
<a name="l03029"></a>03029     dz2= rectvz+4*(xsize);
<a name="l03030"></a>03030     <span class="keywordflow">for</span> (y=0; y&lt;=ysize; y++, dz1+=4*(xsize+1), dz2+=4*(xsize+1)) {
<a name="l03031"></a>03031         dz1[0]= 0.0f;
<a name="l03032"></a>03032         dz2[0]= 0.0f;
<a name="l03033"></a>03033         dz1[2]= 0.0f;
<a name="l03034"></a>03034         dz2[2]= 0.0f;
<a name="l03035"></a>03035     }
<a name="l03036"></a>03036     
<a name="l03037"></a>03037     <span class="comment">/* tag moving pixels, only these faces we draw */</span>
<a name="l03038"></a>03038     dm= rectmove;
<a name="l03039"></a>03039     dvec1= vecbufrect;
<a name="l03040"></a>03040     <span class="keywordflow">for</span> (x=xsize*ysize; x&gt;0; x--, dm++, dvec1+=4) {
<a name="l03041"></a>03041         <span class="keywordflow">if</span> ((dvec1[0]!=0.0f || dvec1[1]!=0.0f || dvec1[2]!=0.0f || dvec1[3]!=0.0f))
<a name="l03042"></a>03042             *dm= 255;
<a name="l03043"></a>03043     }
<a name="l03044"></a>03044     
<a name="l03045"></a>03045     <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a1ade648ae39bd2050185257787e6f09e">antialias_tagbuf</a>(xsize, ysize, rectmove);
<a name="l03046"></a>03046     
<a name="l03047"></a>03047     <span class="comment">/* has to become static, the init-jit calls a random-seed, screwing up texture noise node */</span>
<a name="l03048"></a>03048     <span class="keywordflow">if</span> (firsttime) {
<a name="l03049"></a>03049         firsttime= 0;
<a name="l03050"></a>03050         <a class="code" href="../../d5/d49/BLI__jitter_8h.html#a67dcc4bd0504529117baebe79c486330">BLI_initjit</a>(jit[0], 256);
<a name="l03051"></a>03051     }
<a name="l03052"></a>03052     
<a name="l03053"></a>03053     memset(newrect, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*xsize*ysize*4);
<a name="l03054"></a>03054 
<a name="l03055"></a>03055     <span class="comment">/* accumulate */</span>
<a name="l03056"></a>03056     samples/= 2;
<a name="l03057"></a>03057     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>= 1; <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>&lt;=samples; <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>++) {
<a name="l03058"></a>03058         <span class="keywordtype">float</span> speedfac= 0.5f*nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#a3cb9ee967ae140c3b86da1f043532c15">fac</a>*(float)<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>/(<span class="keywordtype">float</span>)(samples+1);
<a name="l03059"></a>03059         <span class="keywordtype">int</span> side;
<a name="l03060"></a>03060         
<a name="l03061"></a>03061         <span class="keywordflow">for</span> (side=0; side&lt;2; side++) {
<a name="l03062"></a>03062             <span class="keywordtype">float</span> blendfac, ipodata[4];
<a name="l03063"></a>03063             
<a name="l03064"></a>03064             <span class="comment">/* clear zbuf, if we draw future we fill in not moving pixels */</span>
<a name="l03065"></a>03065             <span class="keywordflow">if</span> (0)
<a name="l03066"></a>03066                 <span class="keywordflow">for</span> (x= xsize*ysize-1; x&gt;=0; x--) rectz[x]= 10e16;
<a name="l03067"></a>03067             <span class="keywordflow">else</span> 
<a name="l03068"></a>03068                 <span class="keywordflow">for</span> (x= xsize*ysize-1; x&gt;=0; x--) {
<a name="l03069"></a>03069                     <span class="keywordflow">if</span> (rectmove[x]==0)
<a name="l03070"></a>03070                         rectz[x]= zbufrect[x];
<a name="l03071"></a>03071                     <span class="keywordflow">else</span>
<a name="l03072"></a>03072                         rectz[x]= 10e16;
<a name="l03073"></a>03073                 }
<a name="l03074"></a>03074             
<a name="l03075"></a>03075             <span class="comment">/* clear drawing buffer */</span>
<a name="l03076"></a>03076             <span class="keywordflow">for</span> (x= xsize*ysize-1; x&gt;=0; x--) rectdraw[x].colpoin= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03077"></a>03077             
<a name="l03078"></a>03078             dimg= imgrect;
<a name="l03079"></a>03079             dm= rectmove;
<a name="l03080"></a>03080             dz= zbufrect;
<a name="l03081"></a>03081             dz1= rectvz;
<a name="l03082"></a>03082             dz2= rectvz + 4*(xsize + 1);
<a name="l03083"></a>03083             
<a name="l03084"></a>03084             <span class="keywordflow">if</span> (side) {
<a name="l03085"></a>03085                 <span class="keywordflow">if</span> (nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#ab3dd9555f623298e3e39aacb7d60f8e9">curved</a>==0) {
<a name="l03086"></a>03086                     dz1+= 2;
<a name="l03087"></a>03087                     dz2+= 2;
<a name="l03088"></a>03088                 }
<a name="l03089"></a>03089                 speedfac= -speedfac;
<a name="l03090"></a>03090             }
<a name="l03091"></a>03091             
<a name="l03092"></a>03092             <a class="code" href="../../dc/da5/zbuf_8c.html#ad251856471a6f3b41c78ce4f2e464396">set_quad_bezier_ipo</a>(0.5f + 0.5f*speedfac, ipodata);
<a name="l03093"></a>03093             
<a name="l03094"></a>03094             <span class="keywordflow">for</span> (fy= -0.5f+jit[<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> &amp; 255][0], y=0; y&lt;ysize; y++, fy+=1.0f) {
<a name="l03095"></a>03095                 <span class="keywordflow">for</span> (fx= -0.5f+jit[step &amp; 255][1], x=0; x&lt;xsize; x++, fx+=1.0f, dimg+=4, dz1+=4, dz2+=4, dm++, dz++) {
<a name="l03096"></a>03096                     <span class="keywordflow">if</span> (*dm&gt;1) {
<a name="l03097"></a>03097                         <span class="keywordtype">float</span> jfx = fx + 0.5f;
<a name="l03098"></a>03098                         <span class="keywordtype">float</span> jfy = fy + 0.5f;
<a name="l03099"></a>03099                         <a class="code" href="../../d6/d0d/structDrawBufPixel.html">DrawBufPixel</a> col;
<a name="l03100"></a>03100                         
<a name="l03101"></a>03101                         <span class="comment">/* make vertices */</span>
<a name="l03102"></a>03102                         <span class="keywordflow">if</span> (nbd-&gt;<a class="code" href="../../d4/d1a/structNodeBlurData.html#ab3dd9555f623298e3e39aacb7d60f8e9">curved</a>) {  <span class="comment">/* curved */</span>
<a name="l03103"></a>03103                             <a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">quad_bezier_2d</a>(v1, dz1, dz1+2, ipodata);
<a name="l03104"></a>03104                             v1[0]+= jfx; v1[1]+= jfy; v1[2]= *dz;
<a name="l03105"></a>03105 
<a name="l03106"></a>03106                             <a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">quad_bezier_2d</a>(v2, dz1+4, dz1+4+2, ipodata);
<a name="l03107"></a>03107                             v2[0]+= jfx+1.0f; v2[1]+= jfy; v2[2]= *dz;
<a name="l03108"></a>03108 
<a name="l03109"></a>03109                             <a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">quad_bezier_2d</a>(v3, dz2+4, dz2+4+2, ipodata);
<a name="l03110"></a>03110                             v3[0]+= jfx+1.0f; v3[1]+= jfy+1.0f; v3[2]= *dz;
<a name="l03111"></a>03111                             
<a name="l03112"></a>03112                             <a class="code" href="../../dc/da5/zbuf_8c.html#a1f2acadb57ecd3dc7f12497be3117c63">quad_bezier_2d</a>(v4, dz2, dz2+2, ipodata);
<a name="l03113"></a>03113                             v4[0]+= jfx; v4[1]+= jfy+1.0f; v4[2]= *dz;
<a name="l03114"></a>03114                         }
<a name="l03115"></a>03115                         <span class="keywordflow">else</span> {
<a name="l03116"></a>03116                             v1[0]= speedfac*dz1[0]+jfx;         v1[1]= speedfac*dz1[1]+jfy;         v1[2]= *dz;
<a name="l03117"></a>03117                             v2[0]= speedfac*dz1[4]+jfx+1.0f;        v2[1]= speedfac*dz1[5]+jfy;         v2[2]= *dz;
<a name="l03118"></a>03118                             v3[0]= speedfac*dz2[4]+jfx+1.0f;        v3[1]= speedfac*dz2[5]+jfy+1.0f;        v3[2]= *dz;
<a name="l03119"></a>03119                             v4[0]= speedfac*dz2[0]+jfx;         v4[1]= speedfac*dz2[1]+jfy+1.0f;        v4[2]= *dz;
<a name="l03120"></a>03120                         }
<a name="l03121"></a>03121                         <span class="keywordflow">if</span> (*dm==255) col.<a class="code" href="../../d6/d0d/structDrawBufPixel.html#a6bebcad3ee9ae0e742c64c73a5e7da96">alpha</a>= 1.0f;
<a name="l03122"></a>03122                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*dm&lt;2) col.<a class="code" href="../../d6/d0d/structDrawBufPixel.html#a6bebcad3ee9ae0e742c64c73a5e7da96">alpha</a>= 0.0f;
<a name="l03123"></a>03123                         <span class="keywordflow">else</span> col.<a class="code" href="../../d6/d0d/structDrawBufPixel.html#a6bebcad3ee9ae0e742c64c73a5e7da96">alpha</a>= ((float)*dm)/255.0f;
<a name="l03124"></a>03124                         col.<a class="code" href="../../d6/d0d/structDrawBufPixel.html#af054b217eac6218c8f9fd52e5a64a560">colpoin</a>= dimg;
<a name="l03125"></a>03125 
<a name="l03126"></a>03126                         <a class="code" href="../../dc/da5/zbuf_8c.html#a98125e9684c7a5553620aac9688a5d0e">zbuf_fill_in_rgba</a>(&amp;zspan, &amp;col, v1, v2, v3, v4);
<a name="l03127"></a>03127                     }
<a name="l03128"></a>03128                 }
<a name="l03129"></a>03129                 dz1+=4;
<a name="l03130"></a>03130                 dz2+=4;
<a name="l03131"></a>03131             }
<a name="l03132"></a>03132 
<a name="l03133"></a>03133             <span class="comment">/* blend with a falloff. this fixes the ugly effect you get with</span>
<a name="l03134"></a>03134 <span class="comment">             * a fast moving object. then it looks like a solid object overlayed</span>
<a name="l03135"></a>03135 <span class="comment">             * over a very transparent moving version of itself. in reality, the</span>
<a name="l03136"></a>03136 <span class="comment">             * whole object should become transparent if it is moving fast, be</span>
<a name="l03137"></a>03137 <span class="comment">             * we don&#39;t know what is behind it so we don&#39;t do that. this hack</span>
<a name="l03138"></a>03138 <span class="comment">             * overestimates the contribution of foreground pixels but looks a</span>
<a name="l03139"></a>03139 <span class="comment">             * bit better without a sudden cutoff. */</span>
<a name="l03140"></a>03140             blendfac= ((samples - <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>)/(<span class="keywordtype">float</span>)samples);
<a name="l03141"></a>03141             <span class="comment">/* smoothstep to make it look a bit nicer as well */</span>
<a name="l03142"></a>03142             blendfac= 3.0f*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(blendfac, 2.0f) - 2.0f*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(blendfac, 3.0f);
<a name="l03143"></a>03143 
<a name="l03144"></a>03144             <span class="comment">/* accum */</span>
<a name="l03145"></a>03145             rw= rectweight;
<a name="l03146"></a>03146             rm= rectmax;
<a name="l03147"></a>03147             <span class="keywordflow">for</span> (dr= rectdraw, dz2=newrect, x= xsize*ysize-1; x&gt;=0; x--, dr++, dz2+=4, rw++, rm++) {
<a name="l03148"></a>03148                 <span class="keywordflow">if</span> (dr-&gt;colpoin) {
<a name="l03149"></a>03149                     <span class="keywordtype">float</span> bfac= dr-&gt;alpha*blendfac;
<a name="l03150"></a>03150                     
<a name="l03151"></a>03151                     dz2[0] += bfac*dr-&gt;colpoin[0];
<a name="l03152"></a>03152                     dz2[1] += bfac*dr-&gt;colpoin[1];
<a name="l03153"></a>03153                     dz2[2] += bfac*dr-&gt;colpoin[2];
<a name="l03154"></a>03154                     dz2[3] += bfac*dr-&gt;colpoin[3];
<a name="l03155"></a>03155 
<a name="l03156"></a>03156                     *rw += bfac;
<a name="l03157"></a>03157                     *rm= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(*rm, bfac);
<a name="l03158"></a>03158                 }
<a name="l03159"></a>03159             }
<a name="l03160"></a>03160         }
<a name="l03161"></a>03161     }
<a name="l03162"></a>03162     
<a name="l03163"></a>03163     <span class="comment">/* blend between original images and accumulated image */</span>
<a name="l03164"></a>03164     rw= rectweight;
<a name="l03165"></a>03165     rm= rectmax;
<a name="l03166"></a>03166     ro= imgrect;
<a name="l03167"></a>03167     dm= rectmove;
<a name="l03168"></a>03168     <span class="keywordflow">for</span> (dz2=newrect, x= xsize*ysize-1; x&gt;=0; x--, dz2+=4, ro+=4, rw++, rm++, dm++) {
<a name="l03169"></a>03169         <span class="keywordtype">float</span> mfac = *rm;
<a name="l03170"></a>03170         <span class="keywordtype">float</span> fac = (*rw == 0.0f)? 0.0f: mfac/(*rw);
<a name="l03171"></a>03171         <span class="keywordtype">float</span> nfac = 1.0f - mfac;
<a name="l03172"></a>03172 
<a name="l03173"></a>03173         dz2[0]= fac*dz2[0] + nfac*ro[0];
<a name="l03174"></a>03174         dz2[1]= fac*dz2[1] + nfac*ro[1];
<a name="l03175"></a>03175         dz2[2]= fac*dz2[2] + nfac*ro[2];
<a name="l03176"></a>03176         dz2[3]= fac*dz2[3] + nfac*ro[3];
<a name="l03177"></a>03177     }
<a name="l03178"></a>03178 
<a name="l03179"></a>03179     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectz);
<a name="l03180"></a>03180     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectmove);
<a name="l03181"></a>03181     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectdraw);
<a name="l03182"></a>03182     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectvz);
<a name="l03183"></a>03183     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectweight);
<a name="l03184"></a>03184     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectmax);
<a name="l03185"></a>03185     <span class="keywordflow">if</span> (minvecbufrect) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vecbufrect);  <span class="comment">/* rects were swapped! */</span>
<a name="l03186"></a>03186     <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(&amp;zspan);
<a name="l03187"></a>03187 }
<a name="l03188"></a>03188 
<a name="l03189"></a>03189 <span class="comment">/* ******************** ABUF ************************* */</span>
<a name="l03190"></a>03190 
<a name="l03195"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a2104ed75d6ec62d0c7dfa4a161b2724a">03195</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a2104ed75d6ec62d0c7dfa4a161b2724a">copyto_abufz</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <span class="keywordtype">int</span> *arectz, <span class="keywordtype">int</span> *rectmask, <span class="keywordtype">int</span> sample)
<a name="l03196"></a>03196 {
<a name="l03197"></a>03197     <a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *ps;
<a name="l03198"></a>03198     <span class="keywordtype">int</span> x, y, *rza, *rma;
<a name="l03199"></a>03199     intptr_t *rd;
<a name="l03200"></a>03200     
<a name="l03201"></a>03201     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa==0) {
<a name="l03202"></a>03202         <span class="keywordflow">if</span> (!pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>)
<a name="l03203"></a>03203             <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(arectz, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0x7FFFFFFE);
<a name="l03204"></a>03204         <span class="keywordflow">else</span>
<a name="l03205"></a>03205             memcpy(arectz, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>);
<a name="l03206"></a>03206 
<a name="l03207"></a>03207         <span class="keywordflow">if</span> (rectmask &amp;&amp; pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1a79af7085fe5dcf1ea389f52666153a">rectmask</a>)
<a name="l03208"></a>03208             memcpy(rectmask, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1a79af7085fe5dcf1ea389f52666153a">rectmask</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>);
<a name="l03209"></a>03209 
<a name="l03210"></a>03210         <span class="keywordflow">return</span>;
<a name="l03211"></a>03211     }
<a name="l03212"></a>03212     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>) {
<a name="l03213"></a>03213         <a class="code" href="../../df/d9d/zbuf_8h.html#adc6a5b7b40d76b310298b7a5c6baffd7">fillrect</a>(arectz, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 0x7FFFFFFE);
<a name="l03214"></a>03214         <span class="keywordflow">return</span>;
<a name="l03215"></a>03215     }
<a name="l03216"></a>03216     
<a name="l03217"></a>03217     rza= arectz;
<a name="l03218"></a>03218     rma= rectmask;
<a name="l03219"></a>03219     rd= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>;
<a name="l03220"></a>03220 
<a name="l03221"></a>03221     sample= (1&lt;&lt;sample);
<a name="l03222"></a>03222     
<a name="l03223"></a>03223     <span class="keywordflow">for</span> (y=0; y&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; y++) {
<a name="l03224"></a>03224         <span class="keywordflow">for</span> (x=0; x&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; x++) {
<a name="l03225"></a>03225             
<a name="l03226"></a>03226             *rza= 0x7FFFFFFF;
<a name="l03227"></a>03227             <span class="keywordflow">if</span> (rectmask) *rma= 0x7FFFFFFF;
<a name="l03228"></a>03228             <span class="keywordflow">if</span> (*rd) {  
<a name="l03229"></a>03229                 <span class="comment">/* when there&#39;s a sky pixstruct, fill in sky-Z, otherwise solid Z */</span>
<a name="l03230"></a>03230                 <span class="keywordflow">for</span> (ps= (<a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *)(*rd); ps; ps= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aeb6499e7a3de74d45a89157937d40aa4">next</a>) {
<a name="l03231"></a>03231                     <span class="keywordflow">if</span> (sample &amp; ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#af0b04e6da97ea4a3181f23d4ab49452e">mask</a>) {
<a name="l03232"></a>03232                         *rza= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a6499b0c851894529dd39cfb0acf90c44">z</a>;
<a name="l03233"></a>03233                         <span class="keywordflow">if</span> (rectmask) *rma= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aaa0b5d475fcfbaee352da5641c3ad7e1">maskz</a>;
<a name="l03234"></a>03234                         <span class="keywordflow">break</span>;
<a name="l03235"></a>03235                     }
<a name="l03236"></a>03236                 }
<a name="l03237"></a>03237             }
<a name="l03238"></a>03238             
<a name="l03239"></a>03239             rd++; rza++, rma++;
<a name="l03240"></a>03240         }
<a name="l03241"></a>03241     }
<a name="l03242"></a>03242 }
<a name="l03243"></a>03243 
<a name="l03244"></a>03244 
<a name="l03245"></a>03245 <span class="comment">/* ------------------------------------------------------------------------ */</span>
<a name="l03246"></a>03246 
<a name="l03251"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a83ab0a992df74c6a5a407c56d1e66376">03251</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a83ab0a992df74c6a5a407c56d1e66376">zbuffer_abuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *APixbuf, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *apsmbase, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keywordtype">int</span> negzmask, <span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <span class="keywordtype">int</span> samples, <span class="keywordtype">float</span> (*<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>)[2], <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(clipcrop), <span class="keywordtype">int</span> shadow)
<a name="l03252"></a>03252 {
<a name="l03253"></a>03253     <a class="code" href="../../db/dc1/structZbufProjectCache.html">ZbufProjectCache</a> cache[<a class="code" href="../../dc/da5/zbuf_8c.html#a7fc955097bb6ee0975e294c8529963ef">ZBUF_PROJECT_CACHE_SIZE</a>];
<a name="l03254"></a>03254     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspans[16], *zspan;   <span class="comment">/* MAX_OSA */</span>
<a name="l03255"></a>03255     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03256"></a>03256     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l03257"></a>03257     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l03258"></a>03258     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03259"></a>03259     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *v1, *v2, *v3, *v4;
<a name="l03260"></a>03260     <span class="keywordtype">float</span> vec[3], hoco[4], <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a0ea807db9b245d41852d0326d715cc0b">mul</a>, zval, fval;
<a name="l03261"></a>03261     <span class="keywordtype">float</span> obwinmat[4][4], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[4], ho1[4], ho2[4], ho3[4], ho4[4]={0};
<a name="l03262"></a>03262     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, v, zvlnr, c1, c2, c3, c4=0, dofill= 0;
<a name="l03263"></a>03263     <span class="keywordtype">int</span> zsample, polygon_offset;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265     <a class="code" href="../../dc/da5/zbuf_8c.html#ab56f4bac77457cff9ef4a6e8c61ac06e">zbuffer_part_bounds</a>(winx, winy, pa, bounds);
<a name="l03266"></a>03266 
<a name="l03267"></a>03267     <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l03268"></a>03268         zspan= &amp;zspans[zsample];
<a name="l03269"></a>03269 
<a name="l03270"></a>03270         <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(zspan, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a009950f9a9e7f4fa4709c80fa7e82089">clipcrop</a>);
<a name="l03271"></a>03271         
<a name="l03272"></a>03272         <span class="comment">/* needed for transform from hoco to zbuffer co */</span>
<a name="l03273"></a>03273         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>=  ((float)winx)/2.0f;
<a name="l03274"></a>03274         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>=  ((float)winy)/2.0f;
<a name="l03275"></a>03275         
<a name="l03276"></a>03276         <span class="comment">/* the buffers */</span>
<a name="l03277"></a>03277         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;Arectz&quot;</span>);
<a name="l03278"></a>03278         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a35f5eab87b3cd7f543676bd8fcc0b4e5">apixbuf</a>= APixbuf;
<a name="l03279"></a>03279         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aa8c2f165a3d6f750a37a1740028b8e0a">apsmbase</a>= apsmbase;
<a name="l03280"></a>03280         
<a name="l03281"></a>03281         <span class="keywordflow">if</span> (negzmask)
<a name="l03282"></a>03282             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;Arectmask&quot;</span>);
<a name="l03283"></a>03283 
<a name="l03284"></a>03284         <span class="comment">/* filling methods */</span>
<a name="l03285"></a>03285         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a6148960dddb01f7e7308badfab4a842f">zbuffillAc4</a>;
<a name="l03286"></a>03286         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a26592b11d9e90fd430b3affe14c26eb0">zbuflinefunc</a>= <a class="code" href="../../dc/da5/zbuf_8c.html#a1058a005d983d1b45528990b5e96b4f1">zbuflineAc</a>;
<a name="l03287"></a>03287 
<a name="l03288"></a>03288         <a class="code" href="../../dc/da5/zbuf_8c.html#a2104ed75d6ec62d0c7dfa4a161b2724a">copyto_abufz</a>(pa, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>, zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>, zsample);  <span class="comment">/* init zbuffer */</span>
<a name="l03289"></a>03289         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ab29829dc7f2c1089dd7afb9fc415d551">mask</a>= 1&lt;&lt;zsample;
<a name="l03290"></a>03290 
<a name="l03291"></a>03291         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>) {
<a name="l03292"></a>03292             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>[zsample][0];
<a name="l03293"></a>03293             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>[zsample][1];
<a name="l03294"></a>03294         }
<a name="l03295"></a>03295         <span class="keywordflow">else</span> {
<a name="l03296"></a>03296             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l03297"></a>03297             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l03298"></a>03298         }
<a name="l03299"></a>03299 
<a name="l03300"></a>03300         <span class="comment">/* to center the sample position */</span>
<a name="l03301"></a>03301         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a> -= 0.5f;
<a name="l03302"></a>03302         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a> -= 0.5f;
<a name="l03303"></a>03303     }
<a name="l03304"></a>03304     
<a name="l03305"></a>03305     <span class="comment">/* we use this to test if nothing was filled in */</span>
<a name="l03306"></a>03306     zvlnr= 0;
<a name="l03307"></a>03307         
<a name="l03308"></a>03308     <span class="keywordflow">for</span> (i=0, obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l03309"></a>03309         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l03310"></a>03310 
<a name="l03311"></a>03311         <span class="keywordflow">if</span> (!(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay))
<a name="l03312"></a>03312             <span class="keywordflow">continue</span>;
<a name="l03313"></a>03313 
<a name="l03314"></a>03314         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l03315"></a>03315             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obwinmat, winmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l03316"></a>03316         <span class="keywordflow">else</span>
<a name="l03317"></a>03317             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obwinmat, winmat);
<a name="l03318"></a>03318 
<a name="l03319"></a>03319         <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>, bounds, obwinmat))
<a name="l03320"></a>03320             <span class="keywordflow">continue</span>;
<a name="l03321"></a>03321 
<a name="l03322"></a>03322         <a class="code" href="../../dc/da5/zbuf_8c.html#a6091e5d45f450ceaf6af0ebfb277a1e1">zbuf_project_cache_clear</a>(cache, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l03323"></a>03323 
<a name="l03324"></a>03324         <span class="keywordflow">for</span> (v=0; v&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; v++) {
<a name="l03325"></a>03325             <span class="keywordflow">if</span> ((v &amp; 255)==0)
<a name="l03326"></a>03326                 vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[v&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l03327"></a>03327             <span class="keywordflow">else</span> vlr++;
<a name="l03328"></a>03328             
<a name="l03329"></a>03329             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!=ma) {
<a name="l03330"></a>03330                 ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l03331"></a>03331                 <span class="keywordflow">if</span> (shadow)
<a name="l03332"></a>03332                     dofill= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>);
<a name="l03333"></a>03333                 <span class="keywordflow">else</span>
<a name="l03334"></a>03334                     dofill= (((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>)) &amp;&amp; !(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0b02e3e0afacbc7473b8ed9984a65c01">MA_ONLYCAST</a>));
<a name="l03335"></a>03335             }
<a name="l03336"></a>03336             
<a name="l03337"></a>03337             <span class="keywordflow">if</span> (dofill) {
<a name="l03338"></a>03338                 <span class="keywordflow">if</span> (!(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>) &amp;&amp; (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay)) {
<a name="l03339"></a>03339                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> partclip;
<a name="l03340"></a>03340                     
<a name="l03341"></a>03341                     v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>;
<a name="l03342"></a>03342                     v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>;
<a name="l03343"></a>03343                     v3= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>;
<a name="l03344"></a>03344                     v4= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>;
<a name="l03345"></a>03345 
<a name="l03346"></a>03346                     c1= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho1);
<a name="l03347"></a>03347                     c2= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v2-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho2);
<a name="l03348"></a>03348                     c3= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v3-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho3);
<a name="l03349"></a>03349 
<a name="l03350"></a>03350                     <span class="comment">/* partclipping doesn&#39;t need viewplane clipping */</span>
<a name="l03351"></a>03351                     partclip= c1 &amp; c2 &amp; c3;
<a name="l03352"></a>03352                     <span class="keywordflow">if</span> (v4) {
<a name="l03353"></a>03353                         c4= <a class="code" href="../../dc/da5/zbuf_8c.html#a1124d13e76b5300b74e39ff720953584">zbuf_part_project</a>(cache, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>, obwinmat, bounds, v4-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, ho4);
<a name="l03354"></a>03354                         partclip &amp;= c4;
<a name="l03355"></a>03355                     }
<a name="l03356"></a>03356 
<a name="l03357"></a>03357                     <span class="keywordflow">if</span> (partclip==0) {
<a name="l03358"></a>03358                         <span class="comment">/* a little advantage for transp rendering (a z offset) */</span>
<a name="l03359"></a>03359                         <span class="keywordflow">if</span> (!shadow &amp;&amp; ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a6b25cd47dfe48cc8708b3694925e0266">zoffs</a> != 0.0f) {
<a name="l03360"></a>03360                             mul= 0x7FFFFFFF;
<a name="l03361"></a>03361                             zval= mul*(1.0f+ho1[2]/ho1[3]);
<a name="l03362"></a>03362 
<a name="l03363"></a>03363                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, v1-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l03364"></a>03364                             <span class="comment">/* z is negative, otherwise its being clipped */</span> 
<a name="l03365"></a>03365                             vec[2]-= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a6b25cd47dfe48cc8708b3694925e0266">zoffs</a>;
<a name="l03366"></a>03366                             <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>(vec, obwinmat, hoco);
<a name="l03367"></a>03367                             fval= mul*(1.0f+hoco[2]/hoco[3]);
<a name="l03368"></a>03368 
<a name="l03369"></a>03369                             polygon_offset= (int) <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(zval - fval );
<a name="l03370"></a>03370                         }
<a name="l03371"></a>03371                         <span class="keywordflow">else</span> polygon_offset= 0;
<a name="l03372"></a>03372                         
<a name="l03373"></a>03373                         zvlnr= v+1;
<a name="l03374"></a>03374 
<a name="l03375"></a>03375                         c1= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho1);
<a name="l03376"></a>03376                         c2= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho2);
<a name="l03377"></a>03377                         c3= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho3);
<a name="l03378"></a>03378                         <span class="keywordflow">if</span> (v4)
<a name="l03379"></a>03379                             c4= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(ho4);
<a name="l03380"></a>03380 
<a name="l03381"></a>03381                         <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l03382"></a>03382                             zspan= &amp;zspans[zsample];
<a name="l03383"></a>03383                             zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a86c4afff79f9108f15bba2296ffccd61">polygon_offset</a>= polygon_offset;
<a name="l03384"></a>03384                 
<a name="l03385"></a>03385                             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>) {
<a name="l03386"></a>03386                                 <span class="keywordflow">if</span> (v4)
<a name="l03387"></a>03387                                     <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(zspan, i, zvlnr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l03388"></a>03388                                 <span class="keywordflow">else</span>
<a name="l03389"></a>03389                                     <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(zspan, i, zvlnr, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, ho1, ho2, ho3, 0, c1, c2, c3, 0);
<a name="l03390"></a>03390                             }
<a name="l03391"></a>03391                             <span class="keywordflow">else</span> {
<a name="l03392"></a>03392                                 <span class="keywordflow">if</span> (v4 &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)) {
<a name="l03393"></a>03393                                     <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(zspan, i, zvlnr, ho1, ho2, ho3, ho4, c1, c2, c3, c4);
<a name="l03394"></a>03394                                 }
<a name="l03395"></a>03395                                 <span class="keywordflow">else</span> {
<a name="l03396"></a>03396                                     <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, i, zvlnr, ho1, ho2, ho3, c1, c2, c3);
<a name="l03397"></a>03397                                     <span class="keywordflow">if</span> (v4)
<a name="l03398"></a>03398                                         <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(zspan, i, zvlnr+<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>, ho1, ho3, ho4, c1, c3, c4);
<a name="l03399"></a>03399                                 }
<a name="l03400"></a>03400                             }
<a name="l03401"></a>03401                         }
<a name="l03402"></a>03402                     }
<a name="l03403"></a>03403                     <span class="keywordflow">if</span> ((v &amp; 255)==255) 
<a name="l03404"></a>03404                         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) 
<a name="l03405"></a>03405                             <span class="keywordflow">break</span>; 
<a name="l03406"></a>03406                 }
<a name="l03407"></a>03407             }
<a name="l03408"></a>03408         }
<a name="l03409"></a>03409 
<a name="l03410"></a>03410         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <span class="keywordflow">break</span>;
<a name="l03411"></a>03411     }
<a name="l03412"></a>03412     
<a name="l03413"></a>03413     <span class="keywordflow">for</span> (zsample=0; zsample&lt;samples; zsample++) {
<a name="l03414"></a>03414         zspan= &amp;zspans[zsample];
<a name="l03415"></a>03415         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a5a69f8718476bc8d495cb751821c90a3">arectz</a>);
<a name="l03416"></a>03416         <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>)
<a name="l03417"></a>03417             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a51f3181fa63ca0408a8b938feb037374">rectmask</a>);
<a name="l03418"></a>03418         <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(zspan);
<a name="l03419"></a>03419     }
<a name="l03420"></a>03420     
<a name="l03421"></a>03421     <span class="keywordflow">return</span> zvlnr;
<a name="l03422"></a>03422 }
<a name="l03423"></a>03423 
<a name="l03424"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a43d1eb9d14c209970e3cf6ee07bc6269">03424</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a43d1eb9d14c209970e3cf6ee07bc6269">zbuffer_abuf_render</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *APixbuf, <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *APixbufstrand, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *apsmbase, <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *sscache)
<a name="l03425"></a>03425 {
<a name="l03426"></a>03426     <span class="keywordtype">float</span> winmat[4][4], (*jit)[2];
<a name="l03427"></a>03427     <span class="keywordtype">int</span> samples, negzmask, doztra= 0;
<a name="l03428"></a>03428 
<a name="l03429"></a>03429     samples= (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)? <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa: 1;
<a name="l03430"></a>03430     negzmask= ((rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab7e455e151d17f410776952c810eec74">SCE_LAY_ZMASK</a>) &amp;&amp; (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a388e66aea5b299c2d6011ce74e8ae866">SCE_LAY_NEG_ZMASK</a>));
<a name="l03431"></a>03431 
<a name="l03432"></a>03432     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l03433"></a>03433         jit= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit;
<a name="l03434"></a>03434     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.i.curblur)
<a name="l03435"></a>03435         jit= &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.mblur_jit[<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.i.curblur-1];
<a name="l03436"></a>03436     <span class="keywordflow">else</span>
<a name="l03437"></a>03437         jit= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03438"></a>03438     
<a name="l03439"></a>03439     <a class="code" href="../../df/d9d/zbuf_8h.html#a2b4f0907bbdcc8f79a1cec54d5b2b492">zbuf_make_winmat</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, winmat);
<a name="l03440"></a>03440 
<a name="l03441"></a>03441     <span class="keywordflow">if</span> (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a662a780aa9a22c47503a90620659b7c6">SCE_LAY_ZTRA</a>)
<a name="l03442"></a>03442         doztra+= <a class="code" href="../../dc/da5/zbuf_8c.html#a83ab0a992df74c6a5a407c56d1e66376">zbuffer_abuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, pa, APixbuf, apsmbase, rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#af48debce77d5f85918186aaf70e31bed">lay</a>, negzmask, winmat, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy, samples, jit, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.clipcrop, 0);
<a name="l03443"></a>03443     <span class="keywordflow">if</span> ((rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad18e9b298060a29177ebabb3a479e89">SCE_LAY_STRAND</a>) &amp;&amp; APixbufstrand)
<a name="l03444"></a>03444         doztra+= <a class="code" href="../../df/d9d/zbuf_8h.html#a047cf24106811b6e6be9a132c64827ce">zbuffer_strands_abuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, pa, APixbufstrand, apsmbase, rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#af48debce77d5f85918186aaf70e31bed">lay</a>, negzmask, winmat, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy, samples, jit, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.clipcrop, 0, sscache);
<a name="l03445"></a>03445 
<a name="l03446"></a>03446     <span class="keywordflow">return</span> doztra;
<a name="l03447"></a>03447 }
<a name="l03448"></a>03448 
<a name="l03449"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a5a967cb219ae5218c9c92dd5eca9f53d">03449</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d9d/zbuf_8h.html#ac9b62ae9cd0a1822f72017bf52a668d5">zbuffer_abuf_shadow</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *APixbuf, <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *APixbufstrand, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *apsmbase, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">int</span> samples, <span class="keywordtype">float</span> (*<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>)[2])
<a name="l03450"></a>03450 {
<a name="l03451"></a>03451     <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> pa;
<a name="l03452"></a>03452     <span class="keywordtype">int</span> lay= -1;
<a name="l03453"></a>03453 
<a name="l03454"></a>03454     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) lay= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;
<a name="l03455"></a>03455 
<a name="l03456"></a>03456     memset(&amp;pa, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a>));
<a name="l03457"></a>03457     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l03458"></a>03458     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l03459"></a>03459     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = 0;
<a name="l03460"></a>03460     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = 0;
<a name="l03461"></a>03461     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l03462"></a>03462     pa.<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l03463"></a>03463 
<a name="l03464"></a>03464     <a class="code" href="../../dc/da5/zbuf_8c.html#a83ab0a992df74c6a5a407c56d1e66376">zbuffer_abuf</a>(re, &amp;pa, APixbuf, apsmbase, lay, 0, winmat, size, size, samples, <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>, 1.0f, 1);
<a name="l03465"></a>03465     <span class="keywordflow">if</span> (APixbufstrand)
<a name="l03466"></a>03466         <a class="code" href="../../df/d9d/zbuf_8h.html#a047cf24106811b6e6be9a132c64827ce">zbuffer_strands_abuf</a>(re, &amp;pa, APixbufstrand, apsmbase, lay, 0, winmat, size, size, samples, <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>, 1.0f, 1, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03467"></a>03467 }
<a name="l03468"></a>03468 
<a name="l03469"></a>03469 <span class="comment">/* different rules for speed in transparent pass...  */</span>
<a name="l03470"></a>03470 <span class="comment">/* speed pointer NULL = sky, we clear */</span>
<a name="l03471"></a>03471 <span class="comment">/* else if either alpha is full or no solid was filled in: copy speed */</span>
<a name="l03472"></a>03472 <span class="comment">/* else fill in minimum speed */</span>
<a name="l03473"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">03473</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">add_transp_speed</a>(<a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">int</span> offset, <span class="keywordtype">float</span> *speed, <span class="keywordtype">float</span> alpha, intptr_t *rdrect)
<a name="l03474"></a>03474 {
<a name="l03475"></a>03475     <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass;
<a name="l03476"></a>03476     
<a name="l03477"></a>03477     <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>) {
<a name="l03478"></a>03478         <span class="keywordflow">if</span> (rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a>==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>) {
<a name="l03479"></a>03479             <span class="keywordtype">float</span> *fp= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a> + 4*offset;
<a name="l03480"></a>03480             
<a name="l03481"></a>03481             <span class="keywordflow">if</span> (speed==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03482"></a>03482                 <span class="comment">/* clear */</span>
<a name="l03483"></a>03483                 <span class="keywordflow">if</span> (fp[0]==<a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>) fp[0]= 0.0f;
<a name="l03484"></a>03484                 <span class="keywordflow">if</span> (fp[1]==<a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>) fp[1]= 0.0f;
<a name="l03485"></a>03485                 <span class="keywordflow">if</span> (fp[2]==<a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>) fp[2]= 0.0f;
<a name="l03486"></a>03486                 <span class="keywordflow">if</span> (fp[3]==<a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>) fp[3]= 0.0f;
<a name="l03487"></a>03487             }
<a name="l03488"></a>03488             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rdrect==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || rdrect[offset]==0 || alpha&gt;0.95f) {
<a name="l03489"></a>03489                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(fp, speed);
<a name="l03490"></a>03490             }
<a name="l03491"></a>03491             <span class="keywordflow">else</span> {
<a name="l03492"></a>03492                 <span class="comment">/* add minimum speed in pixel */</span>
<a name="l03493"></a>03493                 <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[1]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[1])) ) {
<a name="l03494"></a>03494                     fp[0]= speed[0];
<a name="l03495"></a>03495                     fp[1]= speed[1];
<a name="l03496"></a>03496                 }
<a name="l03497"></a>03497                 <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[2]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[3]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[2]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[3])) ) {
<a name="l03498"></a>03498                     fp[2]= speed[2];
<a name="l03499"></a>03499                     fp[3]= speed[3];
<a name="l03500"></a>03500                 }
<a name="l03501"></a>03501             }
<a name="l03502"></a>03502             <span class="keywordflow">break</span>;
<a name="l03503"></a>03503         }
<a name="l03504"></a>03504     }
<a name="l03505"></a>03505 }
<a name="l03506"></a>03506 
<a name="l03507"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a440e503599953cc5e351a0d74454da4d">03507</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a440e503599953cc5e351a0d74454da4d">add_transp_obindex</a>(<a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">int</span> offset, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03508"></a>03508 {
<a name="l03509"></a>03509     <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass;
<a name="l03510"></a>03510     
<a name="l03511"></a>03511     <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>) {
<a name="l03512"></a>03512         <span class="keywordflow">if</span> (rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9135312fc6b18fd54613c576c80a4f53">SCE_PASS_INDEXOB</a>||rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a73753b42780aaf1e360cbc70b23d7dea">SCE_PASS_INDEXMA</a>) {
<a name="l03513"></a>03513             <span class="keywordtype">float</span> *fp= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a> + offset;
<a name="l03514"></a>03514             *fp= (float)ob-&gt;<a class="code" href="../../de/de7/structObject.html#a82d960f06759ba165265b23c7e13908b">index</a>;
<a name="l03515"></a>03515             <span class="keywordflow">break</span>;
<a name="l03516"></a>03516         }
<a name="l03517"></a>03517     }
<a name="l03518"></a>03518 }
<a name="l03519"></a>03519 
<a name="l03520"></a>03520 <span class="comment">/* ONLY OSA! merge all shaderesult samples to one */</span>
<a name="l03521"></a>03521 <span class="comment">/* target should have been cleared */</span>
<a name="l03522"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a6df0795ad03b7b197e515e0222098bb1">03522</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a6df0795ad03b7b197e515e0222098bb1">merge_transp_passes</a>(<a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l03523"></a>03523 {
<a name="l03524"></a>03524     <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass;
<a name="l03525"></a>03525     <span class="keywordtype">float</span> weight= 1.0f/((float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa);
<a name="l03526"></a>03526     <span class="keywordtype">int</span> delta= <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a57b5a76305619276582a5574281cb971">ShadeResult</a>)/4;
<a name="l03527"></a>03527     
<a name="l03528"></a>03528     <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>) {
<a name="l03529"></a>03529         <span class="keywordtype">float</span> *col= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03530"></a>03530         <span class="keywordtype">int</span> pixsize= 3;
<a name="l03531"></a>03531         
<a name="l03532"></a>03532         <span class="keywordflow">switch</span>(rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a>) {
<a name="l03533"></a>03533             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>:
<a name="l03534"></a>03534                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>;
<a name="l03535"></a>03535                 pixsize= 4;
<a name="l03536"></a>03536                 <span class="keywordflow">break</span>;
<a name="l03537"></a>03537             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36483eb50364ade6b32ad7f845be7cf">SCE_PASS_EMIT</a>:
<a name="l03538"></a>03538                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>;
<a name="l03539"></a>03539                 <span class="keywordflow">break</span>;
<a name="l03540"></a>03540             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>:
<a name="l03541"></a>03541                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>;
<a name="l03542"></a>03542                 <span class="keywordflow">break</span>;
<a name="l03543"></a>03543             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>:
<a name="l03544"></a>03544                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>;
<a name="l03545"></a>03545                 <span class="keywordflow">break</span>;
<a name="l03546"></a>03546             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>:
<a name="l03547"></a>03547                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>;
<a name="l03548"></a>03548                 <span class="keywordflow">break</span>;
<a name="l03549"></a>03549             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>:
<a name="l03550"></a>03550                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>;
<a name="l03551"></a>03551                 <span class="keywordflow">break</span>;
<a name="l03552"></a>03552             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>:
<a name="l03553"></a>03553                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>;
<a name="l03554"></a>03554                 <span class="keywordflow">break</span>;
<a name="l03555"></a>03555             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>:
<a name="l03556"></a>03556                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>;
<a name="l03557"></a>03557                 <span class="keywordflow">break</span>;
<a name="l03558"></a>03558             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>:
<a name="l03559"></a>03559                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>;
<a name="l03560"></a>03560                 <span class="keywordflow">break</span>;
<a name="l03561"></a>03561             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>:
<a name="l03562"></a>03562                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>;
<a name="l03563"></a>03563                 <span class="keywordflow">break</span>;
<a name="l03564"></a>03564             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a53ae1d458dab251ffdcc0ccd5312f603">SCE_PASS_NORMAL</a>:
<a name="l03565"></a>03565                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>;
<a name="l03566"></a>03566                 <span class="keywordflow">break</span>;
<a name="l03567"></a>03567             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5261e0edfcf5ddc55c459ac175ae55c6">SCE_PASS_MIST</a>:
<a name="l03568"></a>03568                 col= &amp;shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>;
<a name="l03569"></a>03569                 pixsize= 1;
<a name="l03570"></a>03570                 <span class="keywordflow">break</span>;
<a name="l03571"></a>03571             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>:
<a name="l03572"></a>03572                 col= &amp;shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>;
<a name="l03573"></a>03573                 pixsize= 1;
<a name="l03574"></a>03574                 <span class="keywordflow">break</span>;
<a name="l03575"></a>03575             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>:
<a name="l03576"></a>03576                 
<a name="l03577"></a>03577                 {
<a name="l03578"></a>03578                     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr_t= shr+1;
<a name="l03579"></a>03579                     <span class="keywordtype">float</span> *fp= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>;   <span class="comment">/* was initialized */</span>
<a name="l03580"></a>03580                     <span class="keywordtype">int</span> samp;
<a name="l03581"></a>03581                     
<a name="l03582"></a>03582                     <span class="comment">/* add minimum speed in pixel */</span>
<a name="l03583"></a>03583                     <span class="keywordflow">for</span> (samp= 1; samp&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; samp++, shr_t++) {
<a name="l03584"></a>03584                         
<a name="l03585"></a>03585                         <span class="keywordflow">if</span> (shr_t-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3] &gt; 0.0f) {
<a name="l03586"></a>03586                             <span class="keywordtype">float</span> *speed= shr_t-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>;
<a name="l03587"></a>03587                             
<a name="l03588"></a>03588                             <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[1]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[0]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[1])) ) {
<a name="l03589"></a>03589                                 fp[0]= speed[0];
<a name="l03590"></a>03590                                 fp[1]= speed[1];
<a name="l03591"></a>03591                             }
<a name="l03592"></a>03592                             <span class="keywordflow">if</span> ( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[2]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(speed[3]))&lt; (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[2]) + <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(fp[3])) ) {
<a name="l03593"></a>03593                                 fp[2]= speed[2];
<a name="l03594"></a>03594                                 fp[3]= speed[3];
<a name="l03595"></a>03595                             }
<a name="l03596"></a>03596                         }
<a name="l03597"></a>03597                     }
<a name="l03598"></a>03598                 }
<a name="l03599"></a>03599                 <span class="keywordflow">break</span>;
<a name="l03600"></a>03600         }
<a name="l03601"></a>03601         <span class="keywordflow">if</span> (col) {
<a name="l03602"></a>03602             <span class="keywordtype">float</span> *fp= col+delta;
<a name="l03603"></a>03603             <span class="keywordtype">int</span> samp;
<a name="l03604"></a>03604             
<a name="l03605"></a>03605             <span class="keywordflow">for</span> (samp= 1; samp&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; samp++, fp+=delta) {
<a name="l03606"></a>03606                 col[0]+= fp[0];
<a name="l03607"></a>03607                 <span class="keywordflow">if</span> (pixsize&gt;1) {
<a name="l03608"></a>03608                     col[1]+= fp[1];
<a name="l03609"></a>03609                     col[2]+= fp[2];
<a name="l03610"></a>03610                     <span class="keywordflow">if</span> (pixsize==4) col[3]+= fp[3];
<a name="l03611"></a>03611                 }
<a name="l03612"></a>03612             }
<a name="l03613"></a>03613             col[0]*= weight;
<a name="l03614"></a>03614             <span class="keywordflow">if</span> (pixsize&gt;1) {
<a name="l03615"></a>03615                 col[1]*= weight;
<a name="l03616"></a>03616                 col[2]*= weight;
<a name="l03617"></a>03617                 <span class="keywordflow">if</span> (pixsize==4) col[3]*= weight;
<a name="l03618"></a>03618             }
<a name="l03619"></a>03619         }
<a name="l03620"></a>03620     }
<a name="l03621"></a>03621                 
<a name="l03622"></a>03622 }
<a name="l03623"></a>03623 
<a name="l03624"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ae49c1c5a22b0db80fdae6b79349e1a10">03624</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ae49c1c5a22b0db80fdae6b79349e1a10">add_transp_passes</a>(<a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">int</span> offset, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">float</span> alpha)
<a name="l03625"></a>03625 {
<a name="l03626"></a>03626     <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass;
<a name="l03627"></a>03627     
<a name="l03628"></a>03628     <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>) {
<a name="l03629"></a>03629         <span class="keywordtype">float</span> *fp, *col= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03630"></a>03630         <span class="keywordtype">int</span> pixsize= 3;
<a name="l03631"></a>03631         
<a name="l03632"></a>03632         <span class="keywordflow">switch</span>(rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a>) {
<a name="l03633"></a>03633             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>:
<a name="l03634"></a>03634                 fp= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a> + offset;
<a name="l03635"></a>03635                 <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a> &lt; *fp)
<a name="l03636"></a>03636                     *fp= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>;
<a name="l03637"></a>03637                 <span class="keywordflow">break</span>;
<a name="l03638"></a>03638             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>:
<a name="l03639"></a>03639                 fp= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a> + 4*offset;
<a name="l03640"></a>03640                 <a class="code" href="../../d2/db3/pixelblending_8h.html#a6e23ebb88a8731ac72aa7cc3ad55844f">addAlphaOverFloat</a>(fp, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>);
<a name="l03641"></a>03641                 <span class="keywordflow">break</span>;
<a name="l03642"></a>03642             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36483eb50364ade6b32ad7f845be7cf">SCE_PASS_EMIT</a>:
<a name="l03643"></a>03643                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>;
<a name="l03644"></a>03644                 <span class="keywordflow">break</span>;
<a name="l03645"></a>03645             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>:
<a name="l03646"></a>03646                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>;
<a name="l03647"></a>03647                 <span class="keywordflow">break</span>;
<a name="l03648"></a>03648             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>:
<a name="l03649"></a>03649                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>;
<a name="l03650"></a>03650                 <span class="keywordflow">break</span>;
<a name="l03651"></a>03651             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>:
<a name="l03652"></a>03652                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>;
<a name="l03653"></a>03653                 <span class="keywordflow">break</span>;
<a name="l03654"></a>03654             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>:
<a name="l03655"></a>03655                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>;
<a name="l03656"></a>03656                 <span class="keywordflow">break</span>;
<a name="l03657"></a>03657             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>:
<a name="l03658"></a>03658                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>;
<a name="l03659"></a>03659                 <span class="keywordflow">break</span>;
<a name="l03660"></a>03660             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>:
<a name="l03661"></a>03661                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>;
<a name="l03662"></a>03662                 <span class="keywordflow">break</span>;
<a name="l03663"></a>03663             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>:
<a name="l03664"></a>03664                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>;
<a name="l03665"></a>03665                 <span class="keywordflow">break</span>;
<a name="l03666"></a>03666             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>:
<a name="l03667"></a>03667                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>;
<a name="l03668"></a>03668                 <span class="keywordflow">break</span>;
<a name="l03669"></a>03669             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a53ae1d458dab251ffdcc0ccd5312f603">SCE_PASS_NORMAL</a>:
<a name="l03670"></a>03670                 col= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>;
<a name="l03671"></a>03671                 <span class="keywordflow">break</span>;
<a name="l03672"></a>03672             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5261e0edfcf5ddc55c459ac175ae55c6">SCE_PASS_MIST</a>:
<a name="l03673"></a>03673                 col= &amp;shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>;
<a name="l03674"></a>03674                 pixsize= 1;
<a name="l03675"></a>03675                 <span class="keywordflow">break</span>;
<a name="l03676"></a>03676         }
<a name="l03677"></a>03677         <span class="keywordflow">if</span> (col) {
<a name="l03678"></a>03678 
<a name="l03679"></a>03679             fp= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a> + pixsize*offset;
<a name="l03680"></a>03680             fp[0]= col[0] + (1.0f-alpha)*fp[0];
<a name="l03681"></a>03681             <span class="keywordflow">if</span> (pixsize==3) {
<a name="l03682"></a>03682                 fp[1]= col[1] + (1.0f-alpha)*fp[1];
<a name="l03683"></a>03683                 fp[2]= col[2] + (1.0f-alpha)*fp[2];
<a name="l03684"></a>03684             }
<a name="l03685"></a>03685         }
<a name="l03686"></a>03686     }
<a name="l03687"></a>03687 }
<a name="l03688"></a>03688 
<a name="l03689"></a><a class="code" href="../../da/de3/structZTranspRow.html">03689</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> {
<a name="l03690"></a><a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">03690</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>;
<a name="l03691"></a><a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">03691</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a>;
<a name="l03692"></a><a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">03692</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">p</a>;
<a name="l03693"></a><a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">03693</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>;
<a name="l03694"></a><a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">03694</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a>;
<a name="l03695"></a><a class="code" href="../../da/de3/structZTranspRow.html#a49f1916df79bcfdc401ea2f331e93abb">03695</a>     <span class="keywordtype">float</span> <a class="code" href="../../da/de3/structZTranspRow.html#af57cde079a408960d41b56880758b4e2">u</a>, <a class="code" href="../../da/de3/structZTranspRow.html#a49f1916df79bcfdc401ea2f331e93abb">v</a>;
<a name="l03696"></a>03696 } <a class="code" href="../../dc/da5/zbuf_8c.html#acec193d4bb3df2c6747efc466a19dac3">ZTranspRow</a>;
<a name="l03697"></a>03697 
<a name="l03698"></a><a class="code" href="../../dc/da5/zbuf_8c.html#affdea9eb75ed9b6a123e67bc4f3ecdd6">03698</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#affdea9eb75ed9b6a123e67bc4f3ecdd6">vergzvlak</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a1, <span class="keyword">const</span> <span class="keywordtype">void</span> *a2)
<a name="l03699"></a>03699 {
<a name="l03700"></a>03700     <span class="keyword">const</span> <a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> *r1 = a1, *r2 = a2;
<a name="l03701"></a>03701 
<a name="l03702"></a>03702     <span class="keywordflow">if</span> (r1-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a> &lt; r2-&gt;z) <span class="keywordflow">return</span> 1;
<a name="l03703"></a>03703     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r1-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a> &gt; r2-&gt;z) <span class="keywordflow">return</span> -1;
<a name="l03704"></a>03704     <span class="keywordflow">return</span> 0;
<a name="l03705"></a>03705 }
<a name="l03706"></a>03706 
<a name="l03707"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a7c1bab1d25f388204844414a95b1d49f">03707</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a7c1bab1d25f388204844414a95b1d49f">shade_strand_samples</a>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(x), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(y), <a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> *row, <span class="keywordtype">int</span> addpassflag)
<a name="l03708"></a>03708 {
<a name="l03709"></a>03709     <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> sseg;
<a name="l03710"></a>03710     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert;
<a name="l03711"></a>03711     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l03712"></a>03712     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l03713"></a>03713 
<a name="l03714"></a>03714     obi= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance + row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>;
<a name="l03715"></a>03715     obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>= obi;
<a name="l03718"></a>03718     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">p</a>-1);
<a name="l03719"></a>03719     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>;
<a name="l03720"></a>03720 
<a name="l03721"></a>03721     svert= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a> + row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a>;
<a name="l03722"></a>03722     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]= (row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a> &gt; 0)? (svert-1): svert;
<a name="l03723"></a>03723     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]= svert;
<a name="l03724"></a>03724     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]= svert+1;
<a name="l03725"></a>03725     sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]= (row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a> &lt; sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>-2)? svert+2: svert+1;
<a name="l03726"></a>03726 
<a name="l03727"></a>03727     ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>= 1;
<a name="l03728"></a>03728     <a class="code" href="../../d3/dda/strand_8h.html#aa263a8d20265c4f33035d243f399ebc0">strand_shade_segment</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, cache, &amp;sseg, ssamp, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a49f1916df79bcfdc401ea2f331e93abb">v</a>, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#af57cde079a408960d41b56880758b4e2">u</a>, addpassflag);
<a name="l03729"></a>03729     ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>[0].<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>;
<a name="l03730"></a>03730 }
<a name="l03731"></a>03731 
<a name="l03732"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a5af3c537a7b54705b2ea7e23eb17e143">03732</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a5af3c537a7b54705b2ea7e23eb17e143">unref_strand_samples</a>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> *row, <span class="keywordtype">int</span> totface)
<a name="l03733"></a>03733 {
<a name="l03734"></a>03734     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert;
<a name="l03735"></a>03735     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l03736"></a>03736     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l03737"></a>03737     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand;
<a name="l03738"></a>03738 
<a name="l03739"></a>03739     <span class="comment">/* remove references to samples that are not being rendered, but we still</span>
<a name="l03740"></a>03740 <span class="comment">     * need to remove them so that the reference count of strand vertex shade</span>
<a name="l03741"></a>03741 <span class="comment">     * samples correctly drops to zero */</span>
<a name="l03742"></a>03742     <span class="keywordflow">while</span> (totface &gt; 0) {
<a name="l03743"></a>03743         totface--;
<a name="l03744"></a>03744 
<a name="l03745"></a>03745         <span class="keywordflow">if</span> (row[totface].segment != -1) {
<a name="l03746"></a>03746             obi= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance + row[totface].<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>;
<a name="l03747"></a>03747             obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l03748"></a>03748             strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, row[totface].<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>-1);
<a name="l03749"></a>03749             svert= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a> + row[totface].<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a>;
<a name="l03750"></a>03750 
<a name="l03751"></a>03751             <a class="code" href="../../d3/dda/strand_8h.html#a20be76a9f588a7eb125240d8fed56955">strand_shade_unref</a>(cache, svert);
<a name="l03752"></a>03752             <a class="code" href="../../d3/dda/strand_8h.html#a20be76a9f588a7eb125240d8fed56955">strand_shade_unref</a>(cache, svert+1);
<a name="l03753"></a>03753         }
<a name="l03754"></a>03754     }
<a name="l03755"></a>03755 }
<a name="l03756"></a>03756 
<a name="l03757"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a5fec6572b90c6d8325241857dda8e17d">03757</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a5fec6572b90c6d8325241857dda8e17d">shade_tra_samples_fill</a>(<a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> facenr, <span class="keywordtype">int</span> curmask)
<a name="l03758"></a>03758 {
<a name="l03759"></a>03759     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l03760"></a>03760     <span class="keywordtype">float</span> xs, ys;
<a name="l03761"></a>03761     
<a name="l03762"></a>03762     ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>= 0;
<a name="l03763"></a>03763 
<a name="l03764"></a>03764     <a class="code" href="../../da/d3d/shading_8h.html#a286ff207f66630561308adf45b46db0b">shade_input_set_triangle</a>(shi, obi, facenr, 1);
<a name="l03765"></a>03765         
<a name="l03766"></a>03766     <span class="comment">/* officially should always be true... we have no sky info */</span>
<a name="l03767"></a>03767     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>) {
<a name="l03768"></a>03768         
<a name="l03769"></a>03769         <span class="comment">/* full osa is only set for OSA renders */</span>
<a name="l03770"></a>03770         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#af99e9bbaa81b1dd1c3b8c010da102bbd">R_FULL_OSA</a>) {
<a name="l03771"></a>03771             <span class="keywordtype">short</span> shi_inc= 0, samp;
<a name="l03772"></a>03772             
<a name="l03773"></a>03773             <span class="keywordflow">for</span> (samp=0; samp&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; samp++) {
<a name="l03774"></a>03774                 <span class="keywordflow">if</span> (curmask &amp; (1&lt;&lt;samp)) {
<a name="l03775"></a>03775                     xs= (float)x + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[samp][0] + 0.5f;   <span class="comment">/* zbuffer has this inverse corrected, ensures xs,ys are inside pixel */</span>
<a name="l03776"></a>03776                     ys= (<span class="keywordtype">float</span>)y + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[samp][1] + 0.5f;
<a name="l03777"></a>03777                     
<a name="l03778"></a>03778                     <span class="keywordflow">if</span> (shi_inc) {
<a name="l03779"></a>03779                         <a class="code" href="../../da/d3d/shading_8h.html#a371358a5f1e325fa8786ca70c7899a5a">shade_input_copy_triangle</a>(shi+1, shi);
<a name="l03780"></a>03780                         shi++;
<a name="l03781"></a>03781                     }
<a name="l03782"></a>03782                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= (1&lt;&lt;samp);
<a name="l03783"></a>03783                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.shadowsamplenr[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>]++;
<a name="l03784"></a>03784                     <a class="code" href="../../da/d3d/shading_8h.html#a82a7fd3540f22bf92e1685ce629b9cd0">shade_input_set_viewco</a>(shi, x, y, xs, ys, (<span class="keywordtype">float</span>)z);
<a name="l03785"></a>03785                     <a class="code" href="../../da/d3d/shading_8h.html#a94fac42e4a0fa5b4fdceea8674923069">shade_input_set_uv</a>(shi);
<a name="l03786"></a>03786                     <span class="keywordflow">if</span> (shi_inc==0)
<a name="l03787"></a>03787                         <a class="code" href="../../da/d3d/shading_8h.html#a2e7d2d748fbf7f08e521ee0d65c0c692">shade_input_set_normals</a>(shi);
<a name="l03788"></a>03788                     <span class="keywordflow">else</span> <span class="comment">/* XXX shi-&gt;flippednor messes up otherwise */</span>
<a name="l03789"></a>03789                         <a class="code" href="../../da/d3d/shading_8h.html#a6e49d0b65da7013383a599b5dd53d5c9">shade_input_set_vertex_normals</a>(shi);
<a name="l03790"></a>03790                     
<a name="l03791"></a>03791                     shi_inc= 1;
<a name="l03792"></a>03792                 }
<a name="l03793"></a>03793             }
<a name="l03794"></a>03794         }
<a name="l03795"></a>03795         <span class="keywordflow">else</span> {
<a name="l03796"></a>03796             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l03797"></a>03797                 <span class="keywordtype">short</span> b= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.samples-&gt;centmask[curmask];
<a name="l03798"></a>03798                 xs= (float)x + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.samples-&gt;centLut[b &amp; 15] + 0.5f;
<a name="l03799"></a>03799                 ys= (<span class="keywordtype">float</span>)y + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.samples-&gt;centLut[b&gt;&gt;4] + 0.5f;
<a name="l03800"></a>03800             }
<a name="l03801"></a>03801             <span class="keywordflow">else</span> {
<a name="l03802"></a>03802                 xs= (float)x + 0.5f;
<a name="l03803"></a>03803                 ys= (float)y + 0.5f;
<a name="l03804"></a>03804             }
<a name="l03805"></a>03805             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= curmask;
<a name="l03806"></a>03806             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.shadowsamplenr[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>]++;
<a name="l03807"></a>03807             <a class="code" href="../../da/d3d/shading_8h.html#a82a7fd3540f22bf92e1685ce629b9cd0">shade_input_set_viewco</a>(shi, x, y, xs, ys, (<span class="keywordtype">float</span>)z);
<a name="l03808"></a>03808             <a class="code" href="../../da/d3d/shading_8h.html#a94fac42e4a0fa5b4fdceea8674923069">shade_input_set_uv</a>(shi);
<a name="l03809"></a>03809             <a class="code" href="../../da/d3d/shading_8h.html#a2e7d2d748fbf7f08e521ee0d65c0c692">shade_input_set_normals</a>(shi);
<a name="l03810"></a>03810         }
<a name="l03811"></a>03811         
<a name="l03812"></a>03812         <span class="comment">/* total sample amount, shi-&gt;sample is static set in initialize */</span>
<a name="l03813"></a>03813         ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad5fc0888d8af90fd5b20ea267d7a437a">sample</a>+1;
<a name="l03814"></a>03814     }
<a name="l03815"></a>03815 }
<a name="l03816"></a>03816 
<a name="l03817"></a><a class="code" href="../../dc/da5/zbuf_8c.html#ae27deb58e465a4281c4dfca029b0e4e6">03817</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#ae27deb58e465a4281c4dfca029b0e4e6">shade_tra_samples</a>(<a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> *row, <span class="keywordtype">int</span> addpassflag)
<a name="l03818"></a>03818 {
<a name="l03819"></a>03819     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a> != -1) {
<a name="l03820"></a>03820         <a class="code" href="../../dc/da5/zbuf_8c.html#a7c1bab1d25f388204844414a95b1d49f">shade_strand_samples</a>(cache, ssamp, x, y, row, addpassflag);
<a name="l03821"></a>03821         <span class="keywordflow">return</span> 1;
<a name="l03822"></a>03822     }
<a name="l03823"></a>03823 
<a name="l03824"></a>03824     <a class="code" href="../../dc/da5/zbuf_8c.html#a5fec6572b90c6d8325241857dda8e17d">shade_tra_samples_fill</a>(ssamp, x, y, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a>, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">p</a>, row-&gt;<a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>);
<a name="l03825"></a>03825     
<a name="l03826"></a>03826     <span class="keywordflow">if</span> (ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>) {
<a name="l03827"></a>03827         <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l03828"></a>03828         <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>;
<a name="l03829"></a>03829         <span class="keywordtype">int</span> samp;
<a name="l03830"></a>03830         
<a name="l03831"></a>03831         <span class="comment">/* if AO? */</span>
<a name="l03832"></a>03832         <a class="code" href="../../da/d3d/shading_8h.html#a8168f206084778f328a12710aa9713cd">shade_samples_do_AO</a>(ssamp);
<a name="l03833"></a>03833         
<a name="l03834"></a>03834         <span class="comment">/* if shade (all shadepinputs have same passflag) */</span>
<a name="l03835"></a>03835         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a> &amp; ~(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9135312fc6b18fd54613c576c80a4f53">SCE_PASS_INDEXOB</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a73753b42780aaf1e360cbc70b23d7dea">SCE_PASS_INDEXMA</a>)) {
<a name="l03836"></a>03836             <span class="keywordflow">for</span> (samp=0; samp&lt;ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>; samp++, shi++, shr++) {
<a name="l03837"></a>03837                 <a class="code" href="../../da/d3d/shading_8h.html#af478c72371d2e749f171cf985baa9dcb">shade_input_set_shade_texco</a>(shi);
<a name="l03838"></a>03838                 <a class="code" href="../../da/d3d/shading_8h.html#ac56b51980287cbeac2c57ef5a9f2877b">shade_input_do_shade</a>(shi, shr);
<a name="l03839"></a>03839                 
<a name="l03840"></a>03840                 <span class="comment">/* include lamphalos for ztra, since halo layer was added already */</span>
<a name="l03841"></a>03841                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#a27f1abe07680d03bf8521c9359d04841">R_LAMPHALO</a>)
<a name="l03842"></a>03842                     <span class="keywordflow">if</span> (shi-&gt;layflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a64b24285d50b2e2e211a482ab221204d">SCE_LAY_HALO</a>)
<a name="l03843"></a>03843                         <a class="code" href="../../d0/d0e/rendercore_8h.html#aa7c1b51d185daf95ec184d43789000db">renderspothalo</a>(shi, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3]);
<a name="l03844"></a>03844             }
<a name="l03845"></a>03845         }
<a name="l03846"></a>03846         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>) {
<a name="l03847"></a>03847             <span class="keywordflow">for</span> (samp=0; samp&lt;ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>; samp++, shi++, shr++)
<a name="l03848"></a>03848                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>= -shi-&gt;co[2];
<a name="l03849"></a>03849         }
<a name="l03850"></a>03850 
<a name="l03851"></a>03851         <span class="keywordflow">return</span> 1;
<a name="l03852"></a>03852     }
<a name="l03853"></a>03853     <span class="keywordflow">return</span> 0;
<a name="l03854"></a>03854 }
<a name="l03855"></a>03855 
<a name="l03856"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">03856</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(<span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> fac)
<a name="l03857"></a>03857 {
<a name="l03858"></a>03858     v1[0]= v1[0]+fac*v2[0];
<a name="l03859"></a>03859     v1[1]= v1[1]+fac*v2[1];
<a name="l03860"></a>03860     v1[2]= v1[2]+fac*v2[2];
<a name="l03861"></a>03861 }
<a name="l03862"></a>03862 
<a name="l03863"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a501137975dad884b444400648475898a">03863</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a501137975dad884b444400648475898a">addtosamp_shr</a>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *samp_shr, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <span class="keywordtype">int</span> addpassflag)
<a name="l03864"></a>03864 {
<a name="l03865"></a>03865     <span class="keywordtype">int</span> a, sample, osa = (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa? <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa: 1), retval = osa;
<a name="l03866"></a>03866     
<a name="l03867"></a>03867     <span class="keywordflow">for</span> (a=0; a &lt; osa; a++, samp_shr++) {
<a name="l03868"></a>03868         <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l03869"></a>03869         <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>;
<a name="l03870"></a>03870         
<a name="l03871"></a>03871         <span class="keywordflow">for</span> (sample=0; sample&lt;ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>; sample++, shi++, shr++) {
<a name="l03872"></a>03872         
<a name="l03873"></a>03873             <span class="keywordflow">if</span> (shi-&gt;mask &amp; (1&lt;&lt;a)) {
<a name="l03874"></a>03874                 <span class="keywordtype">float</span> fac= (1.0f - samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3])*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3];
<a name="l03875"></a>03875                 
<a name="l03876"></a>03876                 <a class="code" href="../../d2/db3/pixelblending_8h.html#a4b3c9a32b2648db1781c7dad109233e5">addAlphaUnderFloat</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l03877"></a>03877                 
<a name="l03878"></a>03878                 samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>);
<a name="l03879"></a>03879 
<a name="l03880"></a>03880                 <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>) {
<a name="l03881"></a>03881                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>);
<a name="l03882"></a>03882                 }
<a name="l03883"></a>03883                 <span class="comment">/* optim... */</span>
<a name="l03884"></a>03884                 <span class="keywordflow">if</span> (addpassflag &amp; ~(SCE_PASS_VECTOR)) {
<a name="l03885"></a>03885                     
<a name="l03886"></a>03886                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>)
<a name="l03887"></a>03887                         <a class="code" href="../../d2/db3/pixelblending_8h.html#a4b3c9a32b2648db1781c7dad109233e5">addAlphaUnderFloat</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>);
<a name="l03888"></a>03888                     
<a name="l03889"></a>03889                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a53ae1d458dab251ffdcc0ccd5312f603">SCE_PASS_NORMAL</a>)
<a name="l03890"></a>03890                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>, fac);
<a name="l03891"></a>03891 
<a name="l03892"></a>03892                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36483eb50364ade6b32ad7f845be7cf">SCE_PASS_EMIT</a>)
<a name="l03893"></a>03893                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>, fac);
<a name="l03894"></a>03894 
<a name="l03895"></a>03895                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>)
<a name="l03896"></a>03896                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, fac);
<a name="l03897"></a>03897                     
<a name="l03898"></a>03898                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)
<a name="l03899"></a>03899                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, fac);
<a name="l03900"></a>03900 
<a name="l03901"></a>03901                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)
<a name="l03902"></a>03902                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, fac);
<a name="l03903"></a>03903 
<a name="l03904"></a>03904                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>)
<a name="l03905"></a>03905                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>, fac);
<a name="l03906"></a>03906 
<a name="l03907"></a>03907                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>)
<a name="l03908"></a>03908                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>, fac);
<a name="l03909"></a>03909 
<a name="l03910"></a>03910                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>)
<a name="l03911"></a>03911                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>, fac);
<a name="l03912"></a>03912 
<a name="l03913"></a>03913                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>)
<a name="l03914"></a>03914                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>, fac);
<a name="l03915"></a>03915                     
<a name="l03916"></a>03916                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>)
<a name="l03917"></a>03917                         <a class="code" href="../../dc/da5/zbuf_8c.html#a8ffff62e11891637f20304a47e724bd9">addvecmul</a>(samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>, fac);
<a name="l03918"></a>03918                     
<a name="l03919"></a>03919                     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5261e0edfcf5ddc55c459ac175ae55c6">SCE_PASS_MIST</a>)
<a name="l03920"></a>03920                         samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>= samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>+fac*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>;
<a name="l03921"></a>03921 
<a name="l03922"></a>03922                 }
<a name="l03923"></a>03923             }
<a name="l03924"></a>03924         }
<a name="l03925"></a>03925         
<a name="l03926"></a>03926         <span class="keywordflow">if</span> (samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3]&gt;0.999f) retval--;
<a name="l03927"></a>03927     }
<a name="l03928"></a>03928     <span class="keywordflow">return</span> retval;
<a name="l03929"></a>03929 }
<a name="l03930"></a>03930 
<a name="l03931"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a2a49bfcfa1d30d7431fd76f51cedabc9">03931</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/da5/zbuf_8c.html#a2a49bfcfa1d30d7431fd76f51cedabc9">reset_sky_speedvectors</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">float</span> *rectf)
<a name="l03932"></a>03932 {
<a name="l03933"></a>03933     <span class="comment">/* speed vector exception... if solid render was done, sky pixels are set to zero already */</span>
<a name="l03934"></a>03934     <span class="comment">/* for all pixels with alpha zero, we re-initialize speed again then */</span>
<a name="l03935"></a>03935     <span class="keywordtype">float</span> *fp, *col;
<a name="l03936"></a>03936     <span class="keywordtype">int</span> a;
<a name="l03937"></a>03937     
<a name="l03938"></a>03938     fp= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5c3f3616eb81725c14b3291f0fb72b47">RE_RenderLayerGetPass</a>(rl, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>);
<a name="l03939"></a>03939     <span class="keywordflow">if</span> (fp==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l03940"></a>03940     col= rectf+3;
<a name="l03941"></a>03941     
<a name="l03942"></a>03942     <span class="keywordflow">for</span> (a= 4*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a> -4; a&gt;=0; a-=4) {
<a name="l03943"></a>03943         <span class="keywordflow">if</span> (col[a]==0.0f) {
<a name="l03944"></a>03944             fp[a]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l03945"></a>03945             fp[a+1]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l03946"></a>03946             fp[a+2]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l03947"></a>03947             fp[a+3]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l03948"></a>03948         }
<a name="l03949"></a>03949     }
<a name="l03950"></a>03950 }
<a name="l03951"></a>03951 
<a name="l03952"></a><a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">03952</a> <span class="preprocessor">#define MAX_ZROW    2000</span>
<a name="l03953"></a>03953 <span class="preprocessor"></span>
<a name="l03954"></a>03954 <span class="comment">/* main render call to do the z-transparent layer */</span>
<a name="l03955"></a>03955 <span class="comment">/* returns a mask, only if a) transp rendered and b) solid was rendered */</span>
<a name="l03956"></a><a class="code" href="../../dc/da5/zbuf_8c.html#a40d4a15b0bb01d5757b852c43f2a6b07">03956</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="../../df/d9d/zbuf_8h.html#a8f962cb01093e95d857ae672c8bcc772">zbuffer_transp_shade</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl, <span class="keywordtype">float</span> *pass, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(psmlist))
<a name="l03957"></a>03957 {
<a name="l03958"></a>03958     <a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> *rr= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#ad07794646e047c876c9298d819cd7a1a">result</a>;
<a name="l03959"></a>03959     <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> ssamp;
<a name="l03960"></a>03960     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *APixbuf;      <span class="comment">/* Zbuffer: linked list of face samples */</span>
<a name="l03961"></a>03961     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *APixbufstrand = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03962"></a>03962     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *ap, *aprect, *apn;
<a name="l03963"></a>03963     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *apstrand, *aprectstrand, *apnstrand;
<a name="l03964"></a>03964     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> apsmbase={<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l03965"></a>03965     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> samp_shr[16];       <span class="comment">/* MAX_OSA */</span>
<a name="l03966"></a>03966     <a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a> zrow[<a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>];
<a name="l03967"></a>03967     <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *sscache= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03968"></a>03968     <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rlpp[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>];
<a name="l03969"></a>03969     <span class="keywordtype">float</span> sampalpha, alpha, *passrect= pass;
<a name="l03970"></a>03970     intptr_t *rdrect;
<a name="l03971"></a>03971     <span class="keywordtype">int</span> x, y, crop=0, a, b, totface, totfullsample, totsample, doztra;
<a name="l03972"></a>03972     <span class="keywordtype">int</span> addpassflag, <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= 0, od, osa = (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa? <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa: 1);
<a name="l03973"></a>03973     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *ztramask= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, filled;
<a name="l03974"></a>03974 
<a name="l03975"></a>03975     <span class="comment">/* looks nicer for calling code */</span>
<a name="l03976"></a>03976     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.test_break(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.tbh))
<a name="l03977"></a>03977         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03978"></a>03978     
<a name="l03979"></a>03979     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa&gt;16) { <span class="comment">/* MAX_OSA */</span>
<a name="l03980"></a>03980         printf(<span class="stringliteral">&quot;zbuffer_transp_shade: osa too large\n&quot;</span>);
<a name="l03981"></a>03981         <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 1;
<a name="l03982"></a>03982         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03983"></a>03983     }
<a name="l03984"></a>03984     
<a name="l03985"></a>03985     APixbuf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a>), <span class="stringliteral">&quot;APixbuf&quot;</span>);
<a name="l03986"></a>03986     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.totstrand &amp;&amp; (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad18e9b298060a29177ebabb3a479e89">SCE_LAY_STRAND</a>)) {
<a name="l03987"></a>03987         APixbufstrand= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a>), <span class="stringliteral">&quot;APixbufstrand&quot;</span>);
<a name="l03988"></a>03988         sscache= <a class="code" href="../../d3/dda/strand_8h.html#a8ce046953f4528a78705f0e1ce0581b2">strand_shade_cache_create</a>();
<a name="l03989"></a>03989     }
<a name="l03990"></a>03990 
<a name="l03991"></a>03991     <span class="comment">/* general shader info, passes */</span>
<a name="l03992"></a>03992     <a class="code" href="../../da/d3d/shading_8h.html#ade499bbdda7ec9d3f4b1af9a43d0c7c7">shade_sample_initialize</a>(&amp;ssamp, pa, rl);
<a name="l03993"></a>03993     addpassflag= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a77744f76c53d07bd3c76732d7e54b6ff">passflag</a> &amp; ~(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>);
<a name="l03994"></a>03994     
<a name="l03995"></a>03995     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l03996"></a>03996         sampalpha= 1.0f/(float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa;
<a name="l03997"></a>03997     <span class="keywordflow">else</span>
<a name="l03998"></a>03998         sampalpha= 1.0f;
<a name="l03999"></a>03999     
<a name="l04000"></a>04000     <span class="comment">/* fill the Apixbuf */</span>
<a name="l04001"></a>04001     doztra= <a class="code" href="../../dc/da5/zbuf_8c.html#a43d1eb9d14c209970e3cf6ee07bc6269">zbuffer_abuf_render</a>(pa, APixbuf, APixbufstrand, &amp;apsmbase, rl, sscache);
<a name="l04002"></a>04002 
<a name="l04003"></a>04003     <span class="keywordflow">if</span> (doztra == 0) {
<a name="l04004"></a>04004         <span class="comment">/* nothing filled in */</span>
<a name="l04005"></a>04005         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(APixbuf);
<a name="l04006"></a>04006         <span class="keywordflow">if</span> (APixbufstrand)
<a name="l04007"></a>04007             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(APixbufstrand);
<a name="l04008"></a>04008         <span class="keywordflow">if</span> (sscache)
<a name="l04009"></a>04009             <a class="code" href="../../d3/dda/strand_8h.html#a5f4a543fd3019888ed126e1158214ef8">strand_shade_cache_free</a>(sscache);
<a name="l04010"></a>04010         <a class="code" href="../../df/d9d/zbuf_8h.html#a7f3263aa851e14a4695cc307d8433696">freepsA</a>(&amp;apsmbase);
<a name="l04011"></a>04011         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04012"></a>04012     }
<a name="l04013"></a>04013 
<a name="l04014"></a>04014     aprect= APixbuf;
<a name="l04015"></a>04015     aprectstrand= APixbufstrand;
<a name="l04016"></a>04016     rdrect= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>;
<a name="l04017"></a>04017 
<a name="l04018"></a>04018     <span class="comment">/* needed for correct zbuf/index pass */</span>
<a name="l04019"></a>04019     totfullsample= <a class="code" href="../../d0/d0e/rendercore_8h.html#a281a530c644cdf4b610a0297ca8b9237">get_sample_layers</a>(pa, rl, rlpp);
<a name="l04020"></a>04020     
<a name="l04021"></a>04021     <span class="comment">/* irregular shadowb buffer creation */</span>
<a name="l04022"></a>04022     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)
<a name="l04023"></a>04023         <a class="code" href="../../d9/d30/shadbuf_8h.html#a87e76d77f5694b37ac9ec7fc1963affd">ISB_create</a>(pa, APixbuf);
<a name="l04024"></a>04024 
<a name="l04025"></a>04025     <span class="comment">/* masks, to have correct alpha combine */</span>
<a name="l04026"></a>04026     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa &amp;&amp; (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8b2084ff044d774e42508387794ae956">SCE_LAY_SOLID</a>) &amp;&amp; pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afc7f27637cea5db13f25333f6aa4e280">fullresult</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04027"></a>04027         ztramask= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), <span class="stringliteral">&quot;ztramask&quot;</span>);
<a name="l04028"></a>04028 
<a name="l04029"></a>04029     <span class="comment">/* zero alpha pixels get speed vector max again */</span>
<a name="l04030"></a>04030     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>)
<a name="l04031"></a>04031         <span class="keywordflow">if</span> (rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ac2082ff670ddfc9447d75079c036c23d">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8b2084ff044d774e42508387794ae956">SCE_LAY_SOLID</a>)
<a name="l04032"></a>04032             <a class="code" href="../../dc/da5/zbuf_8c.html#a2a49bfcfa1d30d7431fd76f51cedabc9">reset_sky_speedvectors</a>(pa, rl, rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a36f0fda03377ba315588d7f7c85d01bf">acolrect</a>?rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a36f0fda03377ba315588d7f7c85d01bf">acolrect</a>:rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ae9845cbf757bcf086f09c543d535bdda">rectf</a>);    <span class="comment">/* if acolrect is set we use it */</span>
<a name="l04033"></a>04033 
<a name="l04034"></a>04034     <span class="comment">/* filtered render, for now we assume only 1 filter size */</span>
<a name="l04035"></a>04035     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#add9bd0a76b4956933a3151970366a0e7">crop</a>) {
<a name="l04036"></a>04036         crop= 1;
<a name="l04037"></a>04037         offs= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a> + 1;
<a name="l04038"></a>04038         passrect+= 4*<a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>;
<a name="l04039"></a>04039         aprect+= <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>;
<a name="l04040"></a>04040         aprectstrand+= <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>;
<a name="l04041"></a>04041     }
<a name="l04042"></a>04042     
<a name="l04043"></a>04043     <span class="comment">/* init scanline updates */</span>
<a name="l04044"></a>04044     rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a733b0b9c3db5bf0e410816b605c77572">renrect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = 0;
<a name="l04045"></a>04045     rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a733b0b9c3db5bf0e410816b605c77572">renrect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#add9bd0a76b4956933a3151970366a0e7">crop</a>;
<a name="l04046"></a>04046     rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a5ed0528ec228df1b0546bc48c48d1977">renlay</a>= rl;
<a name="l04047"></a>04047                 
<a name="l04048"></a>04048     <span class="comment">/* render the tile */</span>
<a name="l04049"></a>04049     <span class="keywordflow">for</span> (y=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>+crop; y&lt;pa-&gt;disprect.ymax-crop; y++, rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a733b0b9c3db5bf0e410816b605c77572">renrect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>++) {
<a name="l04050"></a>04050         pass= passrect;
<a name="l04051"></a>04051         ap= aprect;
<a name="l04052"></a>04052         apstrand= aprectstrand;
<a name="l04053"></a>04053         od= <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>;
<a name="l04054"></a>04054         
<a name="l04055"></a>04055         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.test_break(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.tbh))
<a name="l04056"></a>04056             <span class="keywordflow">break</span>;
<a name="l04057"></a>04057         
<a name="l04058"></a>04058         <span class="keywordflow">for</span> (x=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>+crop; x&lt;pa-&gt;disprect.xmax-crop; x++, ap++, apstrand++, pass+=4, od++) {
<a name="l04059"></a>04059             
<a name="l04060"></a>04060             <span class="keywordflow">if</span> (ap-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]==0 &amp;&amp; (!APixbufstrand || apstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[0]==0)) {
<a name="l04061"></a>04061                 <span class="keywordflow">if</span> (addpassflag &amp; SCE_PASS_VECTOR) 
<a name="l04062"></a>04062                     <a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">add_transp_speed</a>(rl, od, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.0f, rdrect);
<a name="l04063"></a>04063             }
<a name="l04064"></a>04064             <span class="keywordflow">else</span> {
<a name="l04065"></a>04065                 <span class="comment">/* sort in z */</span>
<a name="l04066"></a>04066                 totface= 0;
<a name="l04067"></a>04067                 apn= ap;
<a name="l04068"></a>04068                 <span class="keywordflow">while</span> (apn) {
<a name="l04069"></a>04069                     <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l04070"></a>04070                         <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a]) {
<a name="l04071"></a>04071                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a];
<a name="l04072"></a>04072                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[a];
<a name="l04073"></a>04073                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">p</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a];
<a name="l04074"></a>04074                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[a];
<a name="l04075"></a>04075                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a>= -1;
<a name="l04076"></a>04076                             totface++;
<a name="l04077"></a>04077                             <span class="keywordflow">if</span> (totface&gt;=<a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>) totface= <a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>-1;
<a name="l04078"></a>04078                         }
<a name="l04079"></a>04079                         <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l04080"></a>04080                     }
<a name="l04081"></a>04081                     apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>;
<a name="l04082"></a>04082                 }
<a name="l04083"></a>04083 
<a name="l04084"></a>04084                 apnstrand= (APixbufstrand)? apstrand: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04085"></a>04085                 <span class="keywordflow">while</span> (apnstrand) {
<a name="l04086"></a>04086                     <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l04087"></a>04087                         <span class="keywordflow">if</span> (apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[a]) {
<a name="l04088"></a>04088                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a4f1ac6e74901eb3c0b288e0711861893">obi</a>[a];
<a name="l04089"></a>04089                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a9daf2166f365100152e016ffdfa5715c">z</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a44600065ce92f1fdc276dcc2e1dd2d02">z</a>[a];
<a name="l04090"></a>04090                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a3d84c1042b79152625ac68a7b36e9d68">p</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[a];
<a name="l04091"></a>04091                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#ad364f0d58dd4f232b6a2830735a4e4fd">mask</a>[a];
<a name="l04092"></a>04092                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#ac35f0adb1086f2a0a4c6f3b122747fb8">segment</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a34bb1cd82801470b901f59aeaaf5a14f">seg</a>[a];
<a name="l04093"></a>04093 
<a name="l04094"></a>04094                             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l04095"></a>04095                                 totsample= 0;
<a name="l04096"></a>04096                                 <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; b++)
<a name="l04097"></a>04097                                     <span class="keywordflow">if</span> (zrow[totface].mask &amp; (1&lt;&lt;b))
<a name="l04098"></a>04098                                         totsample++;
<a name="l04099"></a>04099                             }
<a name="l04100"></a>04100                             <span class="keywordflow">else</span>
<a name="l04101"></a>04101                                 totsample= 1;
<a name="l04102"></a>04102 
<a name="l04103"></a>04103                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#af57cde079a408960d41b56880758b4e2">u</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#af4280fef7938d3a9934e6d983c1811d5">u</a>[a]/totsample;
<a name="l04104"></a>04104                             zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a49f1916df79bcfdc401ea2f331e93abb">v</a>= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#ac88ef9a8bd17242c1e5b26484e419257">v</a>[a]/totsample;
<a name="l04105"></a>04105                             totface++;
<a name="l04106"></a>04106                             <span class="keywordflow">if</span> (totface&gt;=<a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>) totface= <a class="code" href="../../dc/da5/zbuf_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>-1;
<a name="l04107"></a>04107                         }
<a name="l04108"></a>04108                     }
<a name="l04109"></a>04109                     apnstrand= apnstrand-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#af9afccdaf6b0344c73a6b7ac83e4b239">next</a>;
<a name="l04110"></a>04110                 }
<a name="l04111"></a>04111 
<a name="l04112"></a>04112                 <span class="keywordflow">if</span> (totface==2) {
<a name="l04113"></a>04113                     <span class="keywordflow">if</span> (zrow[0].z &lt; zrow[1].z) {
<a name="l04114"></a>04114                         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a>, zrow[0], zrow[1]);
<a name="l04115"></a>04115                     }
<a name="l04116"></a>04116                     
<a name="l04117"></a>04117                 }
<a name="l04118"></a>04118                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (totface&gt;2) {
<a name="l04119"></a>04119                     qsort(zrow, totface, <span class="keyword">sizeof</span>(<a class="code" href="../../da/de3/structZTranspRow.html">ZTranspRow</a>), <a class="code" href="../../dc/da5/zbuf_8c.html#affdea9eb75ed9b6a123e67bc4f3ecdd6">vergzvlak</a>);
<a name="l04120"></a>04120                 }
<a name="l04121"></a>04121                 
<a name="l04122"></a>04122                 <span class="comment">/* front face does index pass for transparent, no AA or filters, but yes FSA */</span>
<a name="l04123"></a>04123                 <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9135312fc6b18fd54613c576c80a4f53">SCE_PASS_INDEXOB</a>) {
<a name="l04124"></a>04124                     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance[zrow[totface-1].<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>].obr;
<a name="l04125"></a>04125                     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) {
<a name="l04126"></a>04126                         <span class="keywordflow">for</span> (a= 0; a&lt;totfullsample; a++)
<a name="l04127"></a>04127                             <a class="code" href="../../dc/da5/zbuf_8c.html#a440e503599953cc5e351a0d74454da4d">add_transp_obindex</a>(rlpp[a], od, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>);
<a name="l04128"></a>04128                     }
<a name="l04129"></a>04129                 }
<a name="l04130"></a>04130                 <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a73753b42780aaf1e360cbc70b23d7dea">SCE_PASS_INDEXMA</a>) {
<a name="l04131"></a>04131                     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance[zrow[totface-1].<a class="code" href="../../da/de3/structZTranspRow.html#aba2a4b06c0002a263b85924639868e6e">obi</a>].obr;
<a name="l04132"></a>04132                     <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) {
<a name="l04133"></a>04133                         <span class="keywordflow">for</span> (a= 0; a&lt;totfullsample; a++)
<a name="l04134"></a>04134                             <a class="code" href="../../dc/da5/zbuf_8c.html#a440e503599953cc5e351a0d74454da4d">add_transp_obindex</a>(rlpp[a], od, obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>);
<a name="l04135"></a>04135                     }
<a name="l04136"></a>04136                 }
<a name="l04137"></a>04137 
<a name="l04138"></a>04138                 <span class="comment">/* for each mask-sample we alpha-under colors. then in end it&#39;s added using filter */</span>
<a name="l04139"></a>04139                 memset(samp_shr, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>)*osa);
<a name="l04140"></a>04140                 <span class="keywordflow">for</span> (a=0; a&lt;osa; a++) {
<a name="l04141"></a>04141                     samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>= 10e10f;
<a name="l04142"></a>04142                     <span class="keywordflow">if</span> (addpassflag &amp; SCE_PASS_VECTOR) {
<a name="l04143"></a>04143                         samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>[0]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l04144"></a>04144                         samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>[1]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l04145"></a>04145                         samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>[2]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l04146"></a>04146                         samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>[3]= <a class="code" href="../../d0/dff/render__result_8h.html#a7180e74527fe624eb4b22a0a6144b4e3">PASS_VECTOR_MAX</a>;
<a name="l04147"></a>04147                     }
<a name="l04148"></a>04148                 }
<a name="l04149"></a>04149 
<a name="l04150"></a>04150                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa==0) {
<a name="l04151"></a>04151                     <span class="keywordflow">while</span> (totface&gt;0) {
<a name="l04152"></a>04152                         totface--;
<a name="l04153"></a>04153                         
<a name="l04154"></a>04154                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#ae27deb58e465a4281c4dfca029b0e4e6">shade_tra_samples</a>(&amp;ssamp, sscache, x, y, &amp;zrow[totface], addpassflag)) {
<a name="l04155"></a>04155                             filled= <a class="code" href="../../dc/da5/zbuf_8c.html#a501137975dad884b444400648475898a">addtosamp_shr</a>(samp_shr, &amp;ssamp, addpassflag);
<a name="l04156"></a>04156                             <a class="code" href="../../d2/db3/pixelblending_8h.html#a4b3c9a32b2648db1781c7dad109233e5">addAlphaUnderFloat</a>(pass, ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>[0].<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l04157"></a>04157                             
<a name="l04158"></a>04158                             <span class="keywordflow">if</span> (filled == 0) {
<a name="l04159"></a>04159                                 <span class="keywordflow">if</span> (sscache)
<a name="l04160"></a>04160                                     <a class="code" href="../../dc/da5/zbuf_8c.html#a5af3c537a7b54705b2ea7e23eb17e143">unref_strand_samples</a>(sscache, zrow, totface);
<a name="l04161"></a>04161                                 <span class="keywordflow">break</span>;
<a name="l04162"></a>04162                             }
<a name="l04163"></a>04163                         }
<a name="l04164"></a>04164                     }
<a name="l04165"></a>04165 
<a name="l04166"></a>04166                     alpha= samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3];
<a name="l04167"></a>04167                     <span class="keywordflow">if</span> (alpha!=0.0f) {
<a name="l04168"></a>04168                         <a class="code" href="../../dc/da5/zbuf_8c.html#ae49c1c5a22b0db80fdae6b79349e1a10">add_transp_passes</a>(rl, od, samp_shr, alpha);
<a name="l04169"></a>04169                         <span class="keywordflow">if</span> (addpassflag &amp; SCE_PASS_VECTOR)
<a name="l04170"></a>04170                             <a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">add_transp_speed</a>(rl, od, samp_shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>, alpha, rdrect);
<a name="l04171"></a>04171                     }
<a name="l04172"></a>04172                 }
<a name="l04173"></a>04173                 <span class="keywordflow">else</span> {
<a name="l04174"></a>04174                     <span class="keywordtype">short</span> *sp= (<span class="keywordtype">short</span> *)(ztramask+od);
<a name="l04175"></a>04175                     
<a name="l04176"></a>04176                     <span class="keywordflow">while</span> (totface&gt;0) {
<a name="l04177"></a>04177                         totface--;
<a name="l04178"></a>04178                         
<a name="l04179"></a>04179                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/da5/zbuf_8c.html#ae27deb58e465a4281c4dfca029b0e4e6">shade_tra_samples</a>(&amp;ssamp, sscache, x, y, &amp;zrow[totface], addpassflag)) {
<a name="l04180"></a>04180                             filled= <a class="code" href="../../dc/da5/zbuf_8c.html#a501137975dad884b444400648475898a">addtosamp_shr</a>(samp_shr, &amp;ssamp, addpassflag);
<a name="l04181"></a>04181                             
<a name="l04182"></a>04182                             <span class="keywordflow">if</span> (ztramask)
<a name="l04183"></a>04183                                 *sp |= zrow[totface].<a class="code" href="../../da/de3/structZTranspRow.html#a716f3bcb64a0013a2e556bf70cb7325e">mask</a>;
<a name="l04184"></a>04184                             <span class="keywordflow">if</span> (filled==0) {
<a name="l04185"></a>04185                                 <span class="keywordflow">if</span> (sscache)
<a name="l04186"></a>04186                                     <a class="code" href="../../dc/da5/zbuf_8c.html#a5af3c537a7b54705b2ea7e23eb17e143">unref_strand_samples</a>(sscache, zrow, totface);
<a name="l04187"></a>04187                                 <span class="keywordflow">break</span>;
<a name="l04188"></a>04188                             }
<a name="l04189"></a>04189                         }
<a name="l04190"></a>04190                     }
<a name="l04191"></a>04191                     
<a name="l04192"></a>04192                     <span class="comment">/* multisample buffers or filtered mask filling? */</span>
<a name="l04193"></a>04193                     <span class="keywordflow">if</span> (pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afc7f27637cea5db13f25333f6aa4e280">fullresult</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l04194"></a>04194                         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; a++) {
<a name="l04195"></a>04195                             alpha= samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3];
<a name="l04196"></a>04196                             <span class="keywordflow">if</span> (alpha!=0.0f) {
<a name="l04197"></a>04197                                 <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl= ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a7fcbdf9ea4bb41b2bd868730da5fbe8a">rlpp</a>[a];
<a name="l04198"></a>04198                                 
<a name="l04199"></a>04199                                 <a class="code" href="../../d2/db3/pixelblending_8h.html#a6e23ebb88a8731ac72aa7cc3ad55844f">addAlphaOverFloat</a>(rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ae9845cbf757bcf086f09c543d535bdda">rectf</a> + 4*od, samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l04200"></a>04200                 
<a name="l04201"></a>04201                                 <a class="code" href="../../dc/da5/zbuf_8c.html#ae49c1c5a22b0db80fdae6b79349e1a10">add_transp_passes</a>(rl, od, &amp;samp_shr[a], alpha);
<a name="l04202"></a>04202                                 <span class="keywordflow">if</span> (addpassflag &amp; SCE_PASS_VECTOR)
<a name="l04203"></a>04203                                     <a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">add_transp_speed</a>(rl, od, samp_shr[a].winspeed, alpha, rdrect);
<a name="l04204"></a>04204                             }
<a name="l04205"></a>04205                         }
<a name="l04206"></a>04206                     }
<a name="l04207"></a>04207                     <span class="keywordflow">else</span> {
<a name="l04208"></a>04208                         alpha= 0.0f;
<a name="l04209"></a>04209 
<a name="l04210"></a>04210                         <span class="comment">/* note; cannot use pass[3] for alpha due to filtermask */</span>
<a name="l04211"></a>04211                         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; a++) {
<a name="l04212"></a>04212                             <a class="code" href="../../d2/db3/pixelblending_8h.html#a0f1061b9dac81d0a3cf051790088cbfa">add_filt_fmask</a>(1&lt;&lt;a, samp_shr[a].combined, pass, rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a>);
<a name="l04213"></a>04213                             alpha+= samp_shr[a].<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3];
<a name="l04214"></a>04214                         }
<a name="l04215"></a>04215                         
<a name="l04216"></a>04216                         <span class="keywordflow">if</span> (addpassflag) {
<a name="l04217"></a>04217                             alpha*= sampalpha;
<a name="l04218"></a>04218                             
<a name="l04219"></a>04219                             <span class="comment">/* merge all in one, and then add */</span>
<a name="l04220"></a>04220                             <a class="code" href="../../dc/da5/zbuf_8c.html#a6df0795ad03b7b197e515e0222098bb1">merge_transp_passes</a>(rl, samp_shr);
<a name="l04221"></a>04221                             <a class="code" href="../../dc/da5/zbuf_8c.html#ae49c1c5a22b0db80fdae6b79349e1a10">add_transp_passes</a>(rl, od, samp_shr, alpha);
<a name="l04222"></a>04222 
<a name="l04223"></a>04223                             <span class="keywordflow">if</span> (addpassflag &amp; SCE_PASS_VECTOR)
<a name="l04224"></a>04224                                 <a class="code" href="../../dc/da5/zbuf_8c.html#a9f1561c0d676eb4fb3fd795cb08ad02d">add_transp_speed</a>(rl, od, samp_shr[0].winspeed, alpha, rdrect);
<a name="l04225"></a>04225                         }
<a name="l04226"></a>04226                     }
<a name="l04227"></a>04227                 }
<a name="l04228"></a>04228             }
<a name="l04229"></a>04229         }
<a name="l04230"></a>04230         
<a name="l04231"></a>04231         aprect+= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l04232"></a>04232         aprectstrand+= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l04233"></a>04233         passrect+= 4*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l04234"></a>04234         offs+= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l04235"></a>04235     }
<a name="l04236"></a>04236 
<a name="l04237"></a>04237     <span class="comment">/* disable scanline updating */</span>
<a name="l04238"></a>04238     rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a5ed0528ec228df1b0546bc48c48d1977">renlay</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04239"></a>04239 
<a name="l04240"></a>04240     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(APixbuf);
<a name="l04241"></a>04241     <span class="keywordflow">if</span> (APixbufstrand)
<a name="l04242"></a>04242         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(APixbufstrand);
<a name="l04243"></a>04243     <span class="keywordflow">if</span> (sscache)
<a name="l04244"></a>04244         <a class="code" href="../../d3/dda/strand_8h.html#a5f4a543fd3019888ed126e1158214ef8">strand_shade_cache_free</a>(sscache);
<a name="l04245"></a>04245     <a class="code" href="../../df/d9d/zbuf_8h.html#a7f3263aa851e14a4695cc307d8433696">freepsA</a>(&amp;apsmbase); 
<a name="l04246"></a>04246 
<a name="l04247"></a>04247     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)
<a name="l04248"></a>04248         <a class="code" href="../../d9/d30/shadbuf_8h.html#acb1f35c7f3e79ad0390f8e26ea35a495">ISB_free</a>(pa);
<a name="l04249"></a>04249 
<a name="l04250"></a>04250     <span class="keywordflow">return</span> ztramask;
<a name="l04251"></a>04251 }
<a name="l04252"></a>04252 
<a name="l04253"></a>04253 
<a name="l04254"></a>04254 <span class="comment">/* end of zbuf.c */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:55:05 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
