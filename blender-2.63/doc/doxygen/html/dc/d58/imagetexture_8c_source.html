<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: imagetexture.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">imagetexture.c</div>  </div>
</div>
<div class="contents">
<a href="../../dc/d58/imagetexture_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00007"></a>00007 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00009"></a>00009 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00018"></a>00018 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00021"></a>00021 <span class="comment"> * All rights reserved.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributors: 2004/2005/2006 Blender Foundation, full recode</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL/BL DUAL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#ifndef WIN32 </span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#else</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;io.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d94/DNA__image__types_8h.html">DNA_image_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/de4/RE__render__ext_8h.html">RE_render_ext.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00073"></a>00073 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00074"></a>00074 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00075"></a>00075 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00076"></a>00076 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> minx, <span class="keywordtype">float</span> miny, <span class="keywordtype">float</span> maxx, <span class="keywordtype">float</span> maxy, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keyword">const</span> <span class="keywordtype">short</span> imaprepeat, <span class="keyword">const</span> <span class="keywordtype">short</span> imapextend);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">/* *********** IMAGEWRAPPING ****************** */</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/* x and y have to be checked for image size */</span>
<a name="l00084"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">00084</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(<span class="keywordtype">float</span> *col, <span class="keyword">struct</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086     <span class="keywordtype">int</span> ofs = y * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> + x;
<a name="l00087"></a>00087     
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>==4) {
<a name="l00090"></a>00090             <span class="keywordtype">float</span> *fp= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + 4*ofs;
<a name="l00091"></a>00091             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(col, fp);
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>==3) {
<a name="l00094"></a>00094             <span class="keywordtype">float</span> *fp= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + 3*ofs;
<a name="l00095"></a>00095             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col, fp);
<a name="l00096"></a>00096             col[3]= 1.0f;
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098         <span class="keywordflow">else</span> {
<a name="l00099"></a>00099             <span class="keywordtype">float</span> *fp= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + ofs;
<a name="l00100"></a>00100             col[0]= col[1]= col[2]= col[3]= *fp;
<a name="l00101"></a>00101         }
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     <span class="keywordflow">else</span> {
<a name="l00104"></a>00104         <span class="keywordtype">char</span> *rect = (<span class="keywordtype">char</span> *)( ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>+ ofs);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106         col[0] = ((float)rect[0])*(1.0f/255.0f);
<a name="l00107"></a>00107         col[1] = ((float)rect[1])*(1.0f/255.0f);
<a name="l00108"></a>00108         col[2] = ((float)rect[2])*(1.0f/255.0f);
<a name="l00109"></a>00109         col[3] = ((float)rect[3])*(1.0f/255.0f);
<a name="l00110"></a>00110     }   
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a53a0437f74d86357d589e89943a4359c">00113</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dba/texture_8h.html#a7762aab857b2d37f53a4504f8e529d83">imagewrap</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">float</span> texvec[3], <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115     <span class="keywordtype">float</span> fx, fy, val1, val2, val3;
<a name="l00116"></a>00116     <span class="keywordtype">int</span> x, y, retval;
<a name="l00117"></a>00117     <span class="keywordtype">int</span> xi, yi; <span class="comment">/* original values */</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 0.0f;
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     <span class="comment">/* we need to set retval OK, otherwise texture code generates normals itself... */</span>
<a name="l00122"></a>00122     retval= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>?3:1;
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     <span class="comment">/* quick tests */</span>
<a name="l00125"></a>00125     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00126"></a>00126         <span class="keywordflow">return</span> retval;
<a name="l00127"></a>00127     <span class="keywordflow">if</span> (ima) {
<a name="l00128"></a>00128         
<a name="l00129"></a>00129         <span class="comment">/* hack for icon render */</span>
<a name="l00130"></a>00130         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08b663d172b49232b7ca4476b77ace8e">R_NO_IMAGE_LOAD</a>))
<a name="l00131"></a>00131             <span class="keywordflow">return</span> retval;
<a name="l00132"></a>00132         
<a name="l00133"></a>00133         ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a>|= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ab59b18637a0194b0f6e0b89a1ffdb474">IMA_USED_FOR_RENDER</a>;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l00138"></a>00138         <span class="keywordflow">return</span> retval;
<a name="l00139"></a>00139     
<a name="l00140"></a>00140     <span class="comment">/* setup mapping */</span>
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a559a12d8daec1eb2923dca665c30e11c">TEX_IMAROT</a>) {
<a name="l00142"></a>00142         fy= texvec[0];
<a name="l00143"></a>00143         fx= texvec[1];
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145     <span class="keywordflow">else</span> {
<a name="l00146"></a>00146         fx= texvec[0];
<a name="l00147"></a>00147         fy= texvec[1];
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l00151"></a>00151         <span class="keywordtype">int</span> xs, ys;
<a name="l00152"></a>00152         
<a name="l00153"></a>00153         xs= (int)floor(fx);
<a name="l00154"></a>00154         ys= (int)floor(fy);
<a name="l00155"></a>00155         fx-= xs;
<a name="l00156"></a>00156         fy-= ys;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         <span class="keywordflow">if</span> ( (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>)==0) {
<a name="l00159"></a>00159             <span class="keywordflow">if</span> ((xs+ys) &amp; 1);<span class="keywordflow">else</span> <span class="keywordflow">return</span> retval;
<a name="l00160"></a>00160         }
<a name="l00161"></a>00161         <span class="keywordflow">if</span> ( (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>)==0) {
<a name="l00162"></a>00162             <span class="keywordflow">if</span> ((xs+ys) &amp; 1) <span class="keywordflow">return</span> retval;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164         <span class="comment">/* scale around center, (0.5, 0.5) */</span>
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>&lt;1.0f) {
<a name="l00166"></a>00166             fx= (fx-0.5f)/(1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>) +0.5f;
<a name="l00167"></a>00167             fy= (fy-0.5f)/(1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>) +0.5f;
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     x= xi= (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00172"></a>00172     y= yi= (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aef4ffe4660dd9c67dd2eb0d0fa9b3a49">TEX_CLIPCUBE</a>) {
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (x&lt;0 || y&lt;0 || x&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> || y&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> || texvec[2]&lt;-1.0f || texvec[2]&gt;1.0f) {
<a name="l00176"></a>00176             <span class="keywordflow">return</span> retval;
<a name="l00177"></a>00177         }
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae216dc5ade0b0babd139ea7ef16f6e19">TEX_CLIP</a> || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l00180"></a>00180         <span class="keywordflow">if</span> (x&lt;0 || y&lt;0 || x&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> || y&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) {
<a name="l00181"></a>00181             <span class="keywordflow">return</span> retval;
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     <span class="keywordflow">else</span> {
<a name="l00185"></a>00185         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>) {
<a name="l00186"></a>00186             <span class="keywordflow">if</span> (x&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) x = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>-1;
<a name="l00187"></a>00187             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x&lt;0) x= 0;
<a name="l00188"></a>00188         }
<a name="l00189"></a>00189         <span class="keywordflow">else</span> {
<a name="l00190"></a>00190             x= x % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00191"></a>00191             <span class="keywordflow">if</span> (x&lt;0) x+= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>) {
<a name="l00194"></a>00194             <span class="keywordflow">if</span> (y&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) y = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>-1;
<a name="l00195"></a>00195             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y&lt;0) y= 0;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         <span class="keywordflow">else</span> {
<a name="l00198"></a>00198             y= y % ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00199"></a>00199             <span class="keywordflow">if</span> (y&lt;0) y+= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202     
<a name="l00203"></a>00203     <span class="comment">/* warning, no return before setting back! */</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) ) {
<a name="l00205"></a>00205         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>+= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="comment">/* keep this before interpolation [#29761] */</span>
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a444168081b0f593651c005217b3bebc8">TEX_USEALPHA</a>) {
<a name="l00210"></a>00210         <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>) == 0) {
<a name="l00211"></a>00211             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00212"></a>00212         } 
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">/* interpolate */</span>
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee709515cccf026654a5e18043c9522c">TEX_INTERPOL</a>) {
<a name="l00217"></a>00217         <span class="keywordtype">float</span> filterx, filtery;
<a name="l00218"></a>00218         filterx = (0.5f * tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>) / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00219"></a>00219         filtery = (0.5f * tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>) / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="comment">/* important that this value is wrapped [#27782]</span>
<a name="l00222"></a>00222 <span class="comment">         * this applies the modifications made by the checks above,</span>
<a name="l00223"></a>00223 <span class="comment">         * back to the floating point values */</span>
<a name="l00224"></a>00224         fx -= (float)(xi - x) / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00225"></a>00225         fy -= (<span class="keywordtype">float</span>)(yi - y) / (<span class="keywordtype">float</span>)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx-filterx, fy-filtery, fx+filterx, fy+filtery, texres, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>), (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>));
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     <span class="keywordflow">else</span> { <span class="comment">/* no filtering */</span>
<a name="l00230"></a>00230         <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(&amp;texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ibuf, x, y);
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     
<a name="l00233"></a>00233     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) ) {
<a name="l00234"></a>00234         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>-= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>) {
<a name="l00239"></a>00239             <span class="comment">// qdn: normal from color</span>
<a name="l00240"></a>00240             <span class="comment">// The invert of the red channel is to make</span>
<a name="l00241"></a>00241             <span class="comment">// the normal map compliant with the outside world.</span>
<a name="l00242"></a>00242             <span class="comment">// It needs to be done because in Blender</span>
<a name="l00243"></a>00243             <span class="comment">// the normal used in the renderer points inward. It is generated</span>
<a name="l00244"></a>00244             <span class="comment">// this way in calc_vertexnormals(). Should this ever change</span>
<a name="l00245"></a>00245             <span class="comment">// this negate must be removed.</span>
<a name="l00246"></a>00246             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = -2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> - 0.5f);
<a name="l00247"></a>00247             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> - 0.5f);
<a name="l00248"></a>00248             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> - 0.5f);
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250         <span class="keywordflow">else</span> {
<a name="l00251"></a>00251             <span class="comment">/* bump: take three samples */</span>
<a name="l00252"></a>00252             val1= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254             <span class="keywordflow">if</span> (x&lt;ibuf-&gt;x-1) {
<a name="l00255"></a>00255                 <span class="keywordtype">float</span> col[4];
<a name="l00256"></a>00256                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(col, ibuf, x+1, y);
<a name="l00257"></a>00257                 val2= (col[0]+col[1]+col[2]);
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259             <span class="keywordflow">else</span> val2= val1;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261             <span class="keywordflow">if</span> (y&lt;ibuf-&gt;y-1) {
<a name="l00262"></a>00262                 <span class="keywordtype">float</span> col[4];
<a name="l00263"></a>00263                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(col, ibuf, x, y+1);
<a name="l00264"></a>00264                 val3= (col[0]+col[1]+col[2]);
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266             <span class="keywordflow">else</span> val3= val1;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268             <span class="comment">/* do not mix up x and y here! */</span>
<a name="l00269"></a>00269             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= (val1-val2);
<a name="l00270"></a>00270             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= (val1-val3);
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l00275"></a>00275     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>) {
<a name="l00276"></a>00276         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278     <span class="keywordflow">else</span> texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0;
<a name="l00279"></a>00279     
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9ddd149ad6bb398568d6d8f00f756cf7">TEX_NEGALPHA</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 1.0f-texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">/* de-premul, this is being premulled in shade_input_do_shade() */</span>
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>!=1.0f &amp;&amp; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>&gt;1e-4f) {
<a name="l00284"></a>00284         fx= 1.0f/texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l00285"></a>00285         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*= fx;
<a name="l00286"></a>00286         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*= fx;
<a name="l00287"></a>00287         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*= fx;
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289     
<a name="l00290"></a>00290     <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l00291"></a>00291     
<a name="l00292"></a>00292     <span class="keywordflow">return</span> retval;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#acec37e84a49a6c65469d7ac605bb617c">00295</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#acec37e84a49a6c65469d7ac605bb617c">clipx_rctf_swap</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *<a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>, <span class="keywordtype">short</span> *count, <span class="keywordtype">float</span> x1, <span class="keywordtype">float</span> x2)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297     <a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, *newrct;
<a name="l00298"></a>00298     <span class="keywordtype">short</span> a;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     a= *count;
<a name="l00301"></a>00301     rf= <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l00302"></a>00302     <span class="keywordflow">for</span> (;a&gt;0;a--) {
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>&lt;x1) {
<a name="l00304"></a>00304             <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>&lt;x1) {
<a name="l00305"></a>00305                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>+= (x2-x1);
<a name="l00306"></a>00306                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>+= (x2-x1);
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308             <span class="keywordflow">else</span> {
<a name="l00309"></a>00309                 <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>&gt;x2) rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = x2;
<a name="l00310"></a>00310                 newrct= stack+ *count;
<a name="l00311"></a>00311                 (*count)++;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = x2;
<a name="l00314"></a>00314                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>+(x2-x1);
<a name="l00315"></a>00315                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00316"></a>00316                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l00317"></a>00317                 
<a name="l00318"></a>00318                 <span class="keywordflow">if</span> (newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> ==newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) (*count)--;
<a name="l00319"></a>00319                 
<a name="l00320"></a>00320                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = x1;
<a name="l00321"></a>00321             }
<a name="l00322"></a>00322         }
<a name="l00323"></a>00323         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>&gt;x2) {
<a name="l00324"></a>00324             <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>&gt;x2) {
<a name="l00325"></a>00325                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>-= (x2-x1);
<a name="l00326"></a>00326                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>-= (x2-x1);
<a name="l00327"></a>00327             }
<a name="l00328"></a>00328             <span class="keywordflow">else</span> {
<a name="l00329"></a>00329                 <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>&lt;x1) rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = x1;
<a name="l00330"></a>00330                 newrct= stack+ *count;
<a name="l00331"></a>00331                 (*count)++;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = x1;
<a name="l00334"></a>00334                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>-(x2-x1);
<a name="l00335"></a>00335                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00336"></a>00336                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338                 <span class="keywordflow">if</span> (newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> ==newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) (*count)--;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = x2;
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343         rf++;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#adcf505059bb92e95745dd680db8131d1">00348</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#adcf505059bb92e95745dd680db8131d1">clipy_rctf_swap</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *<a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>, <span class="keywordtype">short</span> *count, <span class="keywordtype">float</span> y1, <span class="keywordtype">float</span> y2)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350     <a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, *newrct;
<a name="l00351"></a>00351     <span class="keywordtype">short</span> a;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     a= *count;
<a name="l00354"></a>00354     rf= <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l00355"></a>00355     <span class="keywordflow">for</span> (;a&gt;0;a--) {
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>&lt;y1) {
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>&lt;y1) {
<a name="l00358"></a>00358                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>+= (y2-y1);
<a name="l00359"></a>00359                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>+= (y2-y1);
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361             <span class="keywordflow">else</span> {
<a name="l00362"></a>00362                 <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>&gt;y2) rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = y2;
<a name="l00363"></a>00363                 newrct= stack+ *count;
<a name="l00364"></a>00364                 (*count)++;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = y2;
<a name="l00367"></a>00367                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>+(y2-y1);
<a name="l00368"></a>00368                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00369"></a>00369                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371                 <span class="keywordflow">if</span> (newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>==newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) (*count)--;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = y1;
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>&gt;y2) {
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>&gt;y2) {
<a name="l00378"></a>00378                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>-= (y2-y1);
<a name="l00379"></a>00379                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>-= (y2-y1);
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381             <span class="keywordflow">else</span> {
<a name="l00382"></a>00382                 <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>&lt;y1) rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = y1;
<a name="l00383"></a>00383                 newrct= stack+ *count;
<a name="l00384"></a>00384                 (*count)++;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = y1;
<a name="l00387"></a>00387                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>-(y2-y1);
<a name="l00388"></a>00388                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00389"></a>00389                 newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                 <span class="keywordflow">if</span> (newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>==newrct-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) (*count)--;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393                 rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = y2;
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396         rf++;
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398 }
<a name="l00399"></a>00399 
<a name="l00400"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a04e11bfb023ab19d3aff0051ee3bb7d4">00400</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a04e11bfb023ab19d3aff0051ee3bb7d4">square_rctf</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <span class="keywordtype">float</span> x, y;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     x= rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>- rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00405"></a>00405     y= rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>- rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00406"></a>00406     <span class="keywordflow">return</span> (x*y);
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a89031a3762de5a845c5454572dce1deb">00409</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a89031a3762de5a845c5454572dce1deb">clipx_rctf</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, <span class="keywordtype">float</span> x1, <span class="keywordtype">float</span> x2)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411     <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     size= rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>&lt;x1) {
<a name="l00416"></a>00416         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = x1;
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>&gt;x2) {
<a name="l00419"></a>00419         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = x2;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> &gt; rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) {
<a name="l00422"></a>00422         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l00423"></a>00423         <span class="keywordflow">return</span> 0.0;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size!=0.0f) {
<a name="l00426"></a>00426         <span class="keywordflow">return</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)/<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="keywordflow">return</span> 1.0;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a329a6d8bc95f0cdebb0d7239c3a7455d">00431</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a329a6d8bc95f0cdebb0d7239c3a7455d">clipy_rctf</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, <span class="keywordtype">float</span> y1, <span class="keywordtype">float</span> y2)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     size= rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>&lt;y1) {
<a name="l00438"></a>00438         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = y1;
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>&gt;y2) {
<a name="l00441"></a>00441         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = y2;
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> &gt; rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) {
<a name="l00445"></a>00445         rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l00446"></a>00446         <span class="keywordflow">return</span> 0.0;
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size!=0.0f) {
<a name="l00449"></a>00449         <span class="keywordflow">return</span> (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)/<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     <span class="keywordflow">return</span> 1.0;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a50aa0218027c2eb041bcd1e2fca0011a">00455</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a50aa0218027c2eb041bcd1e2fca0011a">boxsampleclip</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457     <span class="comment">/* sample box, is clipped already, and minx etc. have been set at ibuf size.</span>
<a name="l00458"></a>00458 <span class="comment">     * Enlarge with antialiased edges of the pixels */</span>
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keywordtype">float</span> muly, mulx, <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, col[4];
<a name="l00461"></a>00461     <span class="keywordtype">int</span> x, y, startx, endx, starty, endy;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     startx= (int)floor(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>);
<a name="l00464"></a>00464     endx= (int)floor(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>);
<a name="l00465"></a>00465     starty= (int)floor(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>);
<a name="l00466"></a>00466     endy= (int)floor(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (startx &lt; 0) startx= 0;
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (starty &lt; 0) starty= 0;
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (endx&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) endx= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>-1;
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (endy&gt;=ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) endy= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>-1;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="keywordflow">if</span> (starty==endy &amp;&amp; startx==endx) {
<a name="l00474"></a>00474         <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(&amp;texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ibuf, startx, starty);
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     <span class="keywordflow">else</span> {
<a name="l00477"></a>00477         div= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00478"></a>00478         <span class="keywordflow">for</span> (y=starty; y&lt;=endy; y++) {
<a name="l00479"></a>00479             
<a name="l00480"></a>00480             muly= 1.0;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482             <span class="keywordflow">if</span> (starty==endy);
<a name="l00483"></a>00483             <span class="keywordflow">else</span> {
<a name="l00484"></a>00484                 <span class="keywordflow">if</span> (y==starty) muly= 1.0f-(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> - y);
<a name="l00485"></a>00485                 <span class="keywordflow">if</span> (y==endy) muly= (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - y);
<a name="l00486"></a>00486             }
<a name="l00487"></a>00487             
<a name="l00488"></a>00488             <span class="keywordflow">if</span> (startx==endx) {
<a name="l00489"></a>00489                 mulx= muly;
<a name="l00490"></a>00490                 
<a name="l00491"></a>00491                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(col, ibuf, startx, y);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+= mulx*col[3];
<a name="l00494"></a>00494                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+= mulx*col[0];
<a name="l00495"></a>00495                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+= mulx*col[1];
<a name="l00496"></a>00496                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+= mulx*col[2];
<a name="l00497"></a>00497                 div+= mulx;
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499             <span class="keywordflow">else</span> {
<a name="l00500"></a>00500                 <span class="keywordflow">for</span> (x=startx; x&lt;=endx; x++) {
<a name="l00501"></a>00501                     mulx= muly;
<a name="l00502"></a>00502                     <span class="keywordflow">if</span> (x==startx) mulx*= 1.0f-(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> - x);
<a name="l00503"></a>00503                     <span class="keywordflow">if</span> (x==endx) mulx*= (rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - x);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                     <a class="code" href="../../dc/d58/imagetexture_8c.html#a70fe1406a33b66059a163cb7548d7930">ibuf_get_color</a>(col, ibuf, x, y);
<a name="l00506"></a>00506                     
<a name="l00507"></a>00507                     <span class="keywordflow">if</span> (mulx==1.0f) {
<a name="l00508"></a>00508                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+= col[3];
<a name="l00509"></a>00509                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+= col[0];
<a name="l00510"></a>00510                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+= col[1];
<a name="l00511"></a>00511                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+= col[2];
<a name="l00512"></a>00512                         div+= 1.0f;
<a name="l00513"></a>00513                     }
<a name="l00514"></a>00514                     <span class="keywordflow">else</span> {
<a name="l00515"></a>00515                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+= mulx*col[3];
<a name="l00516"></a>00516                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+= mulx*col[0];
<a name="l00517"></a>00517                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+= mulx*col[1];
<a name="l00518"></a>00518                         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+= mulx*col[2];
<a name="l00519"></a>00519                         div+= mulx;
<a name="l00520"></a>00520                     }
<a name="l00521"></a>00521                 }
<a name="l00522"></a>00522             }
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="keywordflow">if</span> (div!=0.0f) {
<a name="l00526"></a>00526             div= 1.0f/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00527"></a>00527             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00528"></a>00528             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00529"></a>00529             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00530"></a>00530             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532         <span class="keywordflow">else</span> {
<a name="l00533"></a>00533             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0f;
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">00538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> minx, <span class="keywordtype">float</span> miny, <span class="keywordtype">float</span> maxx, <span class="keywordtype">float</span> maxy, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keyword">const</span> <span class="keywordtype">short</span> imaprepeat, <span class="keyword">const</span> <span class="keywordtype">short</span> imapextend)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <span class="comment">/* Sample box, performs clip. minx etc are in range 0.0 - 1.0 .</span>
<a name="l00541"></a>00541 <span class="comment">     * Enlarge with antialiased edges of pixels.</span>
<a name="l00542"></a>00542 <span class="comment">     * If variable &#39;imaprepeat&#39; has been set, the</span>
<a name="l00543"></a>00543 <span class="comment">     * clipped-away parts are sampled as well.</span>
<a name="l00544"></a>00544 <span class="comment">     */</span>
<a name="l00545"></a>00545     <span class="comment">/* note: actually minx etc isn&#39;t in the proper range... this due to filter size and offset vectors for bump */</span>
<a name="l00546"></a>00546     <span class="comment">/* note: talpha must be initialized */</span>
<a name="l00547"></a>00547     <span class="comment">/* note: even when &#39;imaprepeat&#39; is set, this can only repeate once in any direction.</span>
<a name="l00548"></a>00548 <span class="comment">     * the point which min/max is derived from is assumed to be wrapped */</span>
<a name="l00549"></a>00549     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr;
<a name="l00550"></a>00550     <a class="code" href="../../da/d10/structrctf.html">rctf</a> *rf, <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>[8];
<a name="l00551"></a>00551     <span class="keywordtype">float</span> opp, tot, alphaclip= 1.0;
<a name="l00552"></a>00552     <span class="keywordtype">short</span> count=1;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     rf= <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l00555"></a>00555     rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = minx*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00556"></a>00556     rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = maxx*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00557"></a>00557     rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = miny*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00558"></a>00558     rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = maxy*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     texr.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>;    <span class="comment">/* is read by boxsample_clip */</span>
<a name="l00561"></a>00561     
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (imapextend) {
<a name="l00563"></a>00563         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, 0.0f, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>-1);
<a name="l00564"></a>00564         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>, 0.0f, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>-1);
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imaprepeat)
<a name="l00567"></a>00567         <a class="code" href="../../dc/d58/imagetexture_8c.html#acec37e84a49a6c65469d7ac605bb617c">clipx_rctf_swap</a>(stack, &amp;count, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>));
<a name="l00568"></a>00568     <span class="keywordflow">else</span> {
<a name="l00569"></a>00569         alphaclip= <a class="code" href="../../dc/d58/imagetexture_8c.html#a89031a3762de5a845c5454572dce1deb">clipx_rctf</a>(rf, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <span class="keywordflow">if</span> (alphaclip&lt;=0.0f) {
<a name="l00572"></a>00572             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00573"></a>00573             <span class="keywordflow">return</span>;
<a name="l00574"></a>00574         }
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (imapextend) {
<a name="l00578"></a>00578         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>, 0.0f, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>-1);
<a name="l00579"></a>00579         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(rf-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>, 0.0f, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>-1);
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imaprepeat)
<a name="l00582"></a>00582         <a class="code" href="../../dc/d58/imagetexture_8c.html#adcf505059bb92e95745dd680db8131d1">clipy_rctf_swap</a>(stack, &amp;count, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>));
<a name="l00583"></a>00583     <span class="keywordflow">else</span> {
<a name="l00584"></a>00584         alphaclip*= <a class="code" href="../../dc/d58/imagetexture_8c.html#a329a6d8bc95f0cdebb0d7239c3a7455d">clipy_rctf</a>(rf, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>));
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (alphaclip&lt;=0.0f) {
<a name="l00587"></a>00587             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00588"></a>00588             <span class="keywordflow">return</span>;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (count&gt;1) {
<a name="l00593"></a>00593         tot= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00594"></a>00594         <span class="keywordflow">while</span> (count--) {
<a name="l00595"></a>00595             <a class="code" href="../../dc/d58/imagetexture_8c.html#a50aa0218027c2eb041bcd1e2fca0011a">boxsampleclip</a>(ibuf, rf, &amp;texr);
<a name="l00596"></a>00596             
<a name="l00597"></a>00597             opp= <a class="code" href="../../dc/d58/imagetexture_8c.html#a04e11bfb023ab19d3aff0051ee3bb7d4">square_rctf</a>(rf);
<a name="l00598"></a>00598             tot+= opp;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+= opp*texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l00601"></a>00601             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+= opp*texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l00602"></a>00602             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+= opp*texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l00603"></a>00603             <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+= opp*texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l00604"></a>00604             rf++;
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606         <span class="keywordflow">if</span> (tot!= 0.0f) {
<a name="l00607"></a>00607             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>/= tot;
<a name="l00608"></a>00608             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>/= tot;
<a name="l00609"></a>00609             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>/= tot;
<a name="l00610"></a>00610             <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>/= tot;
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613     <span class="keywordflow">else</span>
<a name="l00614"></a>00614         <a class="code" href="../../dc/d58/imagetexture_8c.html#a50aa0218027c2eb041bcd1e2fca0011a">boxsampleclip</a>(ibuf, rf, texres);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>==0) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 1.0;
<a name="l00617"></a>00617     
<a name="l00618"></a>00618     <span class="keywordflow">if</span> (alphaclip!=1.0f) {
<a name="l00619"></a>00619         <span class="comment">/* premul it all */</span>
<a name="l00620"></a>00620         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*= alphaclip;
<a name="l00621"></a>00621         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*= alphaclip;
<a name="l00622"></a>00622         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*= alphaclip;
<a name="l00623"></a>00623         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= alphaclip;
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625 }   
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 <span class="comment">//-----------------------------------------------------------------------------------------------------------------</span>
<a name="l00628"></a>00628 <span class="comment">// from here, some functions only used for the new filtering</span>
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 <span class="comment">// anisotropic filters, data struct used instead of long line of (possibly unused) func args</span>
<a name="l00631"></a><a class="code" href="../../d8/d70/structafdata__t.html">00631</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a> {
<a name="l00632"></a><a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">00632</a>     <span class="keywordtype">float</span> <a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[2], <a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[2];
<a name="l00633"></a><a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">00633</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a>, <a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a>;
<a name="l00634"></a>00634     <span class="comment">// feline only</span>
<a name="l00635"></a><a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">00635</a>     <span class="keywordtype">float</span> <a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a>, <a class="code" href="../../d8/d70/structafdata__t.html#af45366c67b57caedd66069710a8ae347">minrad</a>, <a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">theta</a>;
<a name="l00636"></a><a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">00636</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a>;
<a name="l00637"></a><a class="code" href="../../d8/d70/structafdata__t.html#a8e9f825b2564beebbfbee3356bd57ce1">00637</a>     <span class="keywordtype">float</span> <a class="code" href="../../d8/d70/structafdata__t.html#ad5837b222440d0e9667ea63dfdd90684">dusc</a>, <a class="code" href="../../d8/d70/structafdata__t.html#a8e9f825b2564beebbfbee3356bd57ce1">dvsc</a>;
<a name="l00638"></a>00638 } <a class="code" href="../../dc/d58/imagetexture_8c.html#a7ae303a2713af5d169906d6bb3e0c83c">afdata_t</a>;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="comment">// this only used here to make it easier to pass extend flags as single int</span>
<a name="l00641"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a19201c73649052d57521ea976f061bb1">00641</a> <span class="keyword">enum</span> {<a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a4962830f29336d47b05363435827460a">TXC_XMIR</a>=1, <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a19201c73649052d57521ea976f061bb1">TXC_YMIR</a>, <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a8ac9c51e12d0d227095a2bad82e9ef8c">TXC_REPT</a>, <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>};
<a name="l00642"></a>00642 
<a name="l00643"></a>00643 <span class="comment">// similar to ibuf_get_color() but clips/wraps coords according to repeat/extend flags</span>
<a name="l00644"></a>00644 <span class="comment">// returns true if out of range in clipmode</span>
<a name="l00645"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">00645</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(<span class="keywordtype">float</span> *col, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> extflag)
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647     <span class="keywordtype">int</span> clip = 0;
<a name="l00648"></a>00648     <span class="keywordflow">switch</span> (extflag) {
<a name="l00649"></a>00649         <span class="keywordflow">case</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a4962830f29336d47b05363435827460a">TXC_XMIR</a>:  <span class="comment">// y rep</span>
<a name="l00650"></a>00650             x %= 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00651"></a>00651             x += x &lt; 0 ? 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> : 0;
<a name="l00652"></a>00652             x = x &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> ? 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> - x - 1 : x;
<a name="l00653"></a>00653             y %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00654"></a>00654             y += y &lt; 0 ? ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> : 0;
<a name="l00655"></a>00655             <span class="keywordflow">break</span>;
<a name="l00656"></a>00656         <span class="keywordflow">case</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a19201c73649052d57521ea976f061bb1">TXC_YMIR</a>:  <span class="comment">// x rep</span>
<a name="l00657"></a>00657             x %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00658"></a>00658             x += x &lt; 0 ? ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> : 0;
<a name="l00659"></a>00659             y %= 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00660"></a>00660             y += y &lt; 0 ? 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> : 0;
<a name="l00661"></a>00661             y = y &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> ? 2*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - y - 1 : y;
<a name="l00662"></a>00662             <span class="keywordflow">break</span>;
<a name="l00663"></a>00663         <span class="keywordflow">case</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>:
<a name="l00664"></a>00664             x = (x &lt; 0) ? 0 : ((x &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) ? (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> - 1) : x);
<a name="l00665"></a>00665             y = (y &lt; 0) ? 0 : ((y &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) ? (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - 1) : y);
<a name="l00666"></a>00666             <span class="keywordflow">break</span>;
<a name="l00667"></a>00667         <span class="keywordflow">case</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a8ac9c51e12d0d227095a2bad82e9ef8c">TXC_REPT</a>:
<a name="l00668"></a>00668             x %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00669"></a>00669             x += (x &lt; 0) ? ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> : 0;
<a name="l00670"></a>00670             y %= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00671"></a>00671             y += (y &lt; 0) ? ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> : 0;
<a name="l00672"></a>00672             <span class="keywordflow">break</span>;
<a name="l00673"></a>00673         <span class="keywordflow">default</span>:    {   <span class="comment">// as extend, if clipped, set alpha to 0.0</span>
<a name="l00674"></a>00674             <span class="keywordflow">if</span> (x &lt; 0) { x = 0;  } <span class="comment">// TXF alpha: clip = 1; }</span>
<a name="l00675"></a>00675             <span class="keywordflow">if</span> (x &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) { x = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> - 1; } <span class="comment">// TXF alpha:  clip = 1; }</span>
<a name="l00676"></a>00676             <span class="keywordflow">if</span> (y &lt; 0) { y = 0; } <span class="comment">// TXF alpha:  clip = 1; }</span>
<a name="l00677"></a>00677             <span class="keywordflow">if</span> (y &gt;= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) { y = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - 1; } <span class="comment">// TXF alpha:  clip = 1; }</span>
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l00682"></a>00682         <span class="keyword">const</span> <span class="keywordtype">float</span>* fp = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> + (x + y*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>)*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>;
<a name="l00683"></a>00683         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> == 1)
<a name="l00684"></a>00684             col[0] = col[1] = col[2] = col[3] = *fp;
<a name="l00685"></a>00685         <span class="keywordflow">else</span> {
<a name="l00686"></a>00686             col[0] = fp[0];
<a name="l00687"></a>00687             col[1] = fp[1];
<a name="l00688"></a>00688             col[2] = fp[2];
<a name="l00689"></a>00689             col[3] = clip ? 0.f : (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> == 4 ? fp[3] : 1.f);
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     <span class="keywordflow">else</span> {
<a name="l00693"></a>00693         <span class="keywordtype">char</span>* rect = (<span class="keywordtype">char</span>*)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> + x + y*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00694"></a>00694         col[0] = rect[0]*(1.f/255.f);
<a name="l00695"></a>00695         col[1] = rect[1]*(1.f/255.f);
<a name="l00696"></a>00696         col[2] = rect[2]*(1.f/255.f);
<a name="l00697"></a>00697         col[3] = clip ? 0.f : rect[3]*(1.f/255.f);
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699     <span class="keywordflow">return</span> clip;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="comment">// as above + bilerp</span>
<a name="l00703"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a2de5ba7226c3acfe49ef42a7c6ae1da0">00703</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a2de5ba7226c3acfe49ef42a7c6ae1da0">ibuf_get_color_clip_bilerp</a>(<span class="keywordtype">float</span> *col, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">int</span> intpol, <span class="keywordtype">int</span> extflag)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705     <span class="keywordflow">if</span> (intpol) {
<a name="l00706"></a>00706         <span class="keywordtype">float</span> c00[4], c01[4], c10[4], c11[4];
<a name="l00707"></a>00707         <span class="keyword">const</span> <span class="keywordtype">float</span> ufl = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(u -= 0.5f), vfl = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(v -= 0.5f);
<a name="l00708"></a>00708         <span class="keyword">const</span> <span class="keywordtype">float</span> uf = u - ufl, vf = v - vfl;
<a name="l00709"></a>00709         <span class="keyword">const</span> <span class="keywordtype">float</span> w00=(1.f-uf)*(1.f-vf), w10=uf*(1.f-vf), w01=(1.f-uf)*vf, w11=uf*vf;
<a name="l00710"></a>00710         <span class="keyword">const</span> <span class="keywordtype">int</span> x1 = (int)ufl, y1 = (<span class="keywordtype">int</span>)vfl, x2 = x1 + 1, y2 = y1 + 1;
<a name="l00711"></a>00711         <span class="keywordtype">int</span> clip = <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(c00, ibuf, x1, y1, extflag);
<a name="l00712"></a>00712         clip |= <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(c10, ibuf, x2, y1, extflag);
<a name="l00713"></a>00713         clip |= <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(c01, ibuf, x1, y2, extflag);
<a name="l00714"></a>00714         clip |= <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(c11, ibuf, x2, y2, extflag);
<a name="l00715"></a>00715         col[0] = w00*c00[0] + w10*c10[0] + w01*c01[0] + w11*c11[0];
<a name="l00716"></a>00716         col[1] = w00*c00[1] + w10*c10[1] + w01*c01[1] + w11*c11[1];
<a name="l00717"></a>00717         col[2] = w00*c00[2] + w10*c10[2] + w01*c01[2] + w11*c11[2];
<a name="l00718"></a>00718         col[3] = clip ? 0.f : w00*c00[3] + w10*c10[3] + w01*c01[3] + w11*c11[3];
<a name="l00719"></a>00719         <span class="keywordflow">return</span> clip;
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">return</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(col, ibuf, (<span class="keywordtype">int</span>)u, (<span class="keywordtype">int</span>)v, extflag);
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#ad8108ea76a976290bdbfe677604ca882">00724</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#ad8108ea76a976290bdbfe677604ca882">area_sample</a>(<a class="code" href="../../db/da2/structTexResult.html">TexResult</a>* texr, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* ibuf, <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a>* AFD)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726     <span class="keywordtype">int</span> xs, ys, clip = 0;
<a name="l00727"></a>00727     <span class="keywordtype">float</span> tc[4], xsd, ysd, cw = 0.f;
<a name="l00728"></a>00728     <span class="keyword">const</span> <span class="keywordtype">float</span> ux = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0], uy = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1];
<a name="l00729"></a>00729     <span class="keyword">const</span> <span class="keywordtype">float</span> vx = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0], vy = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1];
<a name="l00730"></a>00730     <span class="keywordtype">int</span> xsam = (int)(0.5f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(ux*ux + uy*uy) + 0.5f);
<a name="l00731"></a>00731     <span class="keywordtype">int</span> ysam = (int)(0.5f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(vx*vx + vy*vy) + 0.5f);
<a name="l00732"></a>00732     <span class="keyword">const</span> <span class="keywordtype">int</span> minsam = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a> ? 2 : 4;
<a name="l00733"></a>00733     xsam = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(xsam, minsam, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*2);
<a name="l00734"></a>00734     ysam = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a49a86f7d81f477961529de3add6d68ab">CLAMPIS</a>(ysam, minsam, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*2);
<a name="l00735"></a>00735     xsd = 1.f / xsam;
<a name="l00736"></a>00736     ysd = 1.f / ysam;
<a name="l00737"></a>00737     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 0.f;
<a name="l00738"></a>00738     <span class="keywordflow">for</span> (ys=0; ys&lt;ysam; ++ys) {
<a name="l00739"></a>00739         <span class="keywordflow">for</span> (xs=0; xs&lt;xsam; ++xs) {
<a name="l00740"></a>00740             <span class="keyword">const</span> <span class="keywordtype">float</span> su = (xs + ((ys &amp; 1) + 0.5f)*0.5f)*xsd - 0.5f;
<a name="l00741"></a>00741             <span class="keyword">const</span> <span class="keywordtype">float</span> sv = (ys + ((xs &amp; 1) + 0.5f)*0.5f)*ysd - 0.5f;
<a name="l00742"></a>00742             <span class="keyword">const</span> <span class="keywordtype">float</span> pu = fx + su*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0] + sv*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0];
<a name="l00743"></a>00743             <span class="keyword">const</span> <span class="keywordtype">float</span> pv = fy + su*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1] + sv*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1];
<a name="l00744"></a>00744             <span class="keyword">const</span> <span class="keywordtype">int</span> out = <a class="code" href="../../dc/d58/imagetexture_8c.html#a2de5ba7226c3acfe49ef42a7c6ae1da0">ibuf_get_color_clip_bilerp</a>(tc, ibuf, pu*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, pv*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a>, AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a>);
<a name="l00745"></a>00745             clip |= out;
<a name="l00746"></a>00746             cw += out ? 0.f : 1.f;
<a name="l00747"></a>00747             texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += tc[0];
<a name="l00748"></a>00748             texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += tc[1];
<a name="l00749"></a>00749             texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += tc[2];
<a name="l00750"></a>00750             texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> += texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? tc[3] : 0.f;
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753     xsd *= ysd;
<a name="l00754"></a>00754     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= xsd;
<a name="l00755"></a>00755     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= xsd;
<a name="l00756"></a>00756     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= xsd;
<a name="l00757"></a>00757     <span class="comment">// clipping can be ignored if alpha used, texr-&gt;ta already includes filtered edge</span>
<a name="l00758"></a>00758     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*xsd : (clip ? cw*xsd : 1.f);
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="comment">// table of (exp(ar) - exp(a)) / (1 - exp(a)) for r in range [0, 1] and a = -2</span>
<a name="l00762"></a>00762 <span class="comment">// used instead of actual gaussian, otherwise at high texture magnifications circular artifacts are visible</span>
<a name="l00763"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#aa49e9feb3f976008cca214d3bb920ed0">00763</a> <span class="preprocessor">#define EWA_MAXIDX 255</span>
<a name="l00764"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a528179dae955fd288a960e632422a6d7">00764</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a528179dae955fd288a960e632422a6d7">EWA_WTS</a>[<a class="code" href="../../dc/d58/imagetexture_8c.html#aa49e9feb3f976008cca214d3bb920ed0">EWA_MAXIDX</a> + 1] =
<a name="l00765"></a>00765 { 1.f, 0.990965f, 0.982f, 0.973105f, 0.96428f, 0.955524f, 0.946836f, 0.938216f, 0.929664f,
<a name="l00766"></a>00766  0.921178f, 0.912759f, 0.904405f, 0.896117f, 0.887893f, 0.879734f, 0.871638f, 0.863605f,
<a name="l00767"></a>00767  0.855636f, 0.847728f, 0.839883f, 0.832098f, 0.824375f, 0.816712f, 0.809108f, 0.801564f,
<a name="l00768"></a>00768  0.794079f, 0.786653f, 0.779284f, 0.771974f, 0.76472f, 0.757523f, 0.750382f, 0.743297f,
<a name="l00769"></a>00769  0.736267f, 0.729292f, 0.722372f, 0.715505f, 0.708693f, 0.701933f, 0.695227f, 0.688572f,
<a name="l00770"></a>00770  0.68197f, 0.67542f, 0.66892f, 0.662471f, 0.656073f, 0.649725f, 0.643426f, 0.637176f,
<a name="l00771"></a>00771  0.630976f, 0.624824f, 0.618719f, 0.612663f, 0.606654f, 0.600691f, 0.594776f, 0.588906f,
<a name="l00772"></a>00772  0.583083f, 0.577305f, 0.571572f, 0.565883f, 0.56024f, 0.55464f, 0.549084f, 0.543572f,
<a name="l00773"></a>00773  0.538102f, 0.532676f, 0.527291f, 0.521949f, 0.516649f, 0.511389f, 0.506171f, 0.500994f,
<a name="l00774"></a>00774  0.495857f, 0.490761f, 0.485704f, 0.480687f, 0.475709f, 0.470769f, 0.465869f, 0.461006f,
<a name="l00775"></a>00775  0.456182f, 0.451395f, 0.446646f, 0.441934f, 0.437258f, 0.432619f, 0.428017f, 0.42345f,
<a name="l00776"></a>00776  0.418919f, 0.414424f, 0.409963f, 0.405538f, 0.401147f, 0.39679f, 0.392467f, 0.388178f,
<a name="l00777"></a>00777  0.383923f, 0.379701f, 0.375511f, 0.371355f, 0.367231f, 0.363139f, 0.359079f, 0.355051f,
<a name="l00778"></a>00778  0.351055f, 0.347089f, 0.343155f, 0.339251f, 0.335378f, 0.331535f, 0.327722f, 0.323939f,
<a name="l00779"></a>00779  0.320186f, 0.316461f, 0.312766f, 0.3091f, 0.305462f, 0.301853f, 0.298272f, 0.294719f,
<a name="l00780"></a>00780  0.291194f, 0.287696f, 0.284226f, 0.280782f, 0.277366f, 0.273976f, 0.270613f, 0.267276f,
<a name="l00781"></a>00781  0.263965f, 0.26068f, 0.257421f, 0.254187f, 0.250979f, 0.247795f, 0.244636f, 0.241502f,
<a name="l00782"></a>00782  0.238393f, 0.235308f, 0.232246f, 0.229209f, 0.226196f, 0.223206f, 0.220239f, 0.217296f,
<a name="l00783"></a>00783  0.214375f, 0.211478f, 0.208603f, 0.20575f, 0.20292f, 0.200112f, 0.197326f, 0.194562f,
<a name="l00784"></a>00784  0.191819f, 0.189097f, 0.186397f, 0.183718f, 0.18106f, 0.178423f, 0.175806f, 0.17321f,
<a name="l00785"></a>00785  0.170634f, 0.168078f, 0.165542f, 0.163026f, 0.16053f, 0.158053f, 0.155595f, 0.153157f,
<a name="l00786"></a>00786  0.150738f, 0.148337f, 0.145955f, 0.143592f, 0.141248f, 0.138921f, 0.136613f, 0.134323f,
<a name="l00787"></a>00787  0.132051f, 0.129797f, 0.12756f, 0.125341f, 0.123139f, 0.120954f, 0.118786f, 0.116635f,
<a name="l00788"></a>00788  0.114501f, 0.112384f, 0.110283f, 0.108199f, 0.106131f, 0.104079f, 0.102043f, 0.100023f,
<a name="l00789"></a>00789  0.0980186f, 0.09603f, 0.094057f, 0.0920994f, 0.0901571f, 0.08823f, 0.0863179f, 0.0844208f,
<a name="l00790"></a>00790  0.0825384f, 0.0806708f, 0.0788178f, 0.0769792f, 0.0751551f, 0.0733451f, 0.0715493f, 0.0697676f,
<a name="l00791"></a>00791  0.0679997f, 0.0662457f, 0.0645054f, 0.0627786f, 0.0610654f, 0.0593655f, 0.0576789f, 0.0560055f,
<a name="l00792"></a>00792  0.0543452f, 0.0526979f, 0.0510634f, 0.0494416f, 0.0478326f, 0.0462361f, 0.0446521f, 0.0430805f,
<a name="l00793"></a>00793  0.0415211f, 0.039974f, 0.0384389f, 0.0369158f, 0.0354046f, 0.0339052f, 0.0324175f, 0.0309415f,
<a name="l00794"></a>00794  0.029477f, 0.0280239f, 0.0265822f, 0.0251517f, 0.0237324f, 0.0223242f, 0.020927f, 0.0195408f,
<a name="l00795"></a>00795  0.0181653f, 0.0168006f, 0.0154466f, 0.0141031f, 0.0127701f, 0.0114476f, 0.0101354f, 0.00883339f,
<a name="l00796"></a>00796  0.00754159f, 0.00625989f, 0.00498819f, 0.00372644f, 0.00247454f, 0.00123242f, 0.f
<a name="l00797"></a>00797 };
<a name="l00798"></a>00798 
<a name="l00799"></a>00799 <span class="comment">// test if a float value is &#39;nan&#39;</span>
<a name="l00800"></a>00800 <span class="comment">// there is a C99 function for this: isnan(), but blender seems to use C90 (according to gcc warns),</span>
<a name="l00801"></a>00801 <span class="comment">// and may not be supported by other compilers either</span>
<a name="l00802"></a>00802 <span class="preprocessor">#ifndef ISNAN</span>
<a name="l00803"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#abdca9ff18fc20268c729ae8bd141f4c5">00803</a> <span class="preprocessor"></span><span class="preprocessor">#define ISNAN(x) ((x) != (x))</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span><span class="comment">//static int ISNAN(float x) { return (x != x); }</span>
<a name="l00806"></a>00806 
<a name="l00807"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#ab57ac1e3f38cfaae2d2d32172ca1e0c1">00807</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#ab57ac1e3f38cfaae2d2d32172ca1e0c1">radangle2imp</a>(<span class="keywordtype">float</span> a2, <span class="keywordtype">float</span> b2, <span class="keywordtype">float</span> th, <span class="keywordtype">float</span>* A, <span class="keywordtype">float</span>* <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a>, <span class="keywordtype">float</span>* <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">float</span>* <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a>)
<a name="l00808"></a>00808 {
<a name="l00809"></a>00809     <span class="keywordtype">float</span> ct2 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(th);
<a name="l00810"></a>00810     <span class="keyword">const</span> <span class="keywordtype">float</span> st2 = 1.f - ct2*ct2;    <span class="comment">// &lt;- sin(th)^2</span>
<a name="l00811"></a>00811     ct2 *= ct2;
<a name="l00812"></a>00812     *A = a2*st2 + b2*ct2;
<a name="l00813"></a>00813     *B = (b2 - a2)*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(2.f*th);
<a name="l00814"></a>00814     *C = a2*ct2 + b2*st2;
<a name="l00815"></a>00815     *F = a2*b2;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <span class="comment">// all tests here are done to make sure possible overflows are hopefully minimized</span>
<a name="l00819"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#ac4d4c7de956085cd7e83bd14468d29d4">00819</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#ac4d4c7de956085cd7e83bd14468d29d4">imp2radangle</a>(<span class="keywordtype">float</span> A, <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a>, <span class="keywordtype">float</span> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a>, <span class="keywordtype">float</span>* a, <span class="keywordtype">float</span>* b, <span class="keywordtype">float</span>* th, <span class="keywordtype">float</span>* ecc)
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (F &lt;= 1e-5f) {   <span class="comment">// use arbitrary major radius, zero minor, infinite eccentricity</span>
<a name="l00822"></a>00822         *a = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(A &gt; C ? A : C);
<a name="l00823"></a>00823         *b = 0.f;
<a name="l00824"></a>00824         *ecc = 1e10f;
<a name="l00825"></a>00825         *th = 0.5f*(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab616618cf09fc0ef5c0ec0d9e5825f58">atan2f</a>(B, A - C) + (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827     <span class="keywordflow">else</span> {
<a name="l00828"></a>00828         <span class="keyword">const</span> <span class="keywordtype">float</span> AmC = A - <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, ApC = A + <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, F2 = F*2.f;
<a name="l00829"></a>00829         <span class="keyword">const</span> <span class="keywordtype">float</span> r = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(AmC*AmC + B*B);
<a name="l00830"></a>00830         <span class="keywordtype">float</span> d = ApC - r;
<a name="l00831"></a>00831         *a = (d &lt;= 0.f) ? <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(A &gt; C ? A : C) : <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(F2 / d);
<a name="l00832"></a>00832         d = ApC + r;
<a name="l00833"></a>00833         <span class="keywordflow">if</span> (d &lt;= 0.f) {
<a name="l00834"></a>00834             *b = 0.f;
<a name="l00835"></a>00835             *ecc = 1e10f;
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837         <span class="keywordflow">else</span> {
<a name="l00838"></a>00838             *b = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(F2 / d);
<a name="l00839"></a>00839             *ecc = *a / *b;
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841         <span class="comment">// incr theta by 0.5*pi (angle of major axis)</span>
<a name="l00842"></a>00842         *th = 0.5f*(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab616618cf09fc0ef5c0ec0d9e5825f58">atan2f</a>(B, AmC) + (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a92263b7b602995e56d07eca88dc26a63">00846</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a92263b7b602995e56d07eca88dc26a63">ewa_eval</a>(<a class="code" href="../../db/da2/structTexResult.html">TexResult</a>* texr, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* ibuf, <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a>* AFD)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848     <span class="comment">// scaling dxt/dyt by full resolution can cause overflow because of huge A/B/C and esp. F values,</span>
<a name="l00849"></a>00849     <span class="comment">// scaling by aspect ratio alone does the opposite, so try something in between instead...</span>
<a name="l00850"></a>00850     <span class="keyword">const</span> <span class="keywordtype">float</span> ff2 = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ff = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(ff2), q = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> / ff;
<a name="l00851"></a>00851     <span class="keyword">const</span> <span class="keywordtype">float</span> Ux = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0]*ff, Vx = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1]*q, Uy = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0]*ff, Vy = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1]*q;
<a name="l00852"></a>00852     <span class="keywordtype">float</span> <a class="code" href="../../de/da0/strsv_8c.html#af5d6242ff783dd9efca51eeec1c234f7">A</a> = Vx*Vx + Vy*Vy;
<a name="l00853"></a>00853     <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a> = -2.f*(Ux*Vx + Uy*Vy);
<a name="l00854"></a>00854     <span class="keywordtype">float</span> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> = Ux*Ux + Uy*Uy;
<a name="l00855"></a>00855     <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a> = A*C - B*B*0.25f;
<a name="l00856"></a>00856     <span class="keywordtype">float</span> a, b, th, ecc, a2, b2, ue, ve, U0, V0, DDQ, <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>, ac1, ac2, BU, d; <span class="comment">// TXF alpha: cw = 0.f;</span>
<a name="l00857"></a>00857     <span class="keywordtype">int</span> u, v, u1, u2, v1, v2; <span class="comment">// TXF alpha: clip = 0;</span>
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <span class="comment">// The so-called &#39;high&#39; quality ewa method simply adds a constant of 1 to both A &amp; C,</span>
<a name="l00860"></a>00860     <span class="comment">// so the ellipse always covers at least some texels. But since the filter is now always larger,</span>
<a name="l00861"></a>00861     <span class="comment">// it also means that everywhere else it&#39;s also more blurry then ideally should be the case.</span>
<a name="l00862"></a>00862     <span class="comment">// So instead here the ellipse radii are modified instead whenever either is too low.</span>
<a name="l00863"></a>00863     <span class="comment">// Use a different radius based on interpolation switch, just enough to anti-alias when interpolation is off,</span>
<a name="l00864"></a>00864     <span class="comment">// and slightly larger to make result a bit smoother than bilinear interpolation when interpolation is on</span>
<a name="l00865"></a>00865     <span class="comment">// (minimum values: const float rmin = intpol ? 1.f : 0.5f;)</span>
<a name="l00866"></a>00866     <span class="keyword">const</span> <span class="keywordtype">float</span> rmin = (AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a> ? 1.5625f : 0.765625f)/ff2;
<a name="l00867"></a>00867     <a class="code" href="../../dc/d58/imagetexture_8c.html#ac4d4c7de956085cd7e83bd14468d29d4">imp2radangle</a>(A, B, C, F, &amp;a, &amp;b, &amp;th, &amp;ecc);
<a name="l00868"></a>00868     <span class="keywordflow">if</span> ((b2 = b*b) &lt; rmin) {
<a name="l00869"></a>00869         <span class="keywordflow">if</span> ((a2 = a*a) &lt; rmin) {
<a name="l00870"></a>00870             B = 0.f;
<a name="l00871"></a>00871             A = C = rmin;
<a name="l00872"></a>00872             F = A*<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         <span class="keywordflow">else</span> {
<a name="l00875"></a>00875             b2 = rmin;
<a name="l00876"></a>00876             <a class="code" href="../../dc/d58/imagetexture_8c.html#ab57ac1e3f38cfaae2d2d32172ca1e0c1">radangle2imp</a>(a2, b2, th, &amp;A, &amp;B, &amp;C, &amp;F);
<a name="l00877"></a>00877         }
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     ue = ff*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(C);
<a name="l00881"></a>00881     ve = ff*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(A);
<a name="l00882"></a>00882     d = (float)(<a class="code" href="../../dc/d58/imagetexture_8c.html#aa49e9feb3f976008cca214d3bb920ed0">EWA_MAXIDX</a> + 1) / (F*ff2);
<a name="l00883"></a>00883     A *= d;
<a name="l00884"></a>00884     B *= d;
<a name="l00885"></a>00885     C *= d;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     U0 = fx*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l00888"></a>00888     V0 = fy*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00889"></a>00889     u1 = (int)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(U0 - ue));
<a name="l00890"></a>00890     u2 = (int)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(U0 + ue));
<a name="l00891"></a>00891     v1 = (int)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(V0 - ve));
<a name="l00892"></a>00892     v2 = (int)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(V0 + ve));
<a name="l00893"></a>00893     U0 -= 0.5f;
<a name="l00894"></a>00894     V0 -= 0.5f;
<a name="l00895"></a>00895     DDQ = 2.f*A;
<a name="l00896"></a>00896     U = u1 - U0;
<a name="l00897"></a>00897     ac1 = A*(2.f*U + 1.f);
<a name="l00898"></a>00898     ac2 = A*U*<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>;
<a name="l00899"></a>00899     BU = B*<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901     d = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 0.f;
<a name="l00902"></a>00902     <span class="keywordflow">for</span> (v=v1; v&lt;=v2; ++v) {
<a name="l00903"></a>00903         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/de5/util__view_8cpp.html#aa3c33408c575ce78e243ea14cc990eaa">V</a> = v - V0;
<a name="l00904"></a>00904         <span class="keywordtype">float</span> DQ = ac1 + B*<a class="code" href="../../d5/de5/util__view_8cpp.html#aa3c33408c575ce78e243ea14cc990eaa">V</a>;
<a name="l00905"></a>00905         <span class="keywordtype">float</span> Q = (C*V + BU)*V + ac2;
<a name="l00906"></a>00906         <span class="keywordflow">for</span> (u=u1; u&lt;=u2; ++u) {
<a name="l00907"></a>00907             <span class="keywordflow">if</span> (Q &lt; (<span class="keywordtype">float</span>)(<a class="code" href="../../dc/d58/imagetexture_8c.html#aa49e9feb3f976008cca214d3bb920ed0">EWA_MAXIDX</a> + 1)) {
<a name="l00908"></a>00908                 <span class="keywordtype">float</span> tc[4];
<a name="l00909"></a>00909                 <span class="keyword">const</span> <span class="keywordtype">float</span> wt = <a class="code" href="../../dc/d58/imagetexture_8c.html#a528179dae955fd288a960e632422a6d7">EWA_WTS</a>[(Q &lt; 0.f) ? 0 : (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)Q];
<a name="l00910"></a>00910                 <span class="comment">/*const int out =*/</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#aa0ef4a6c0ef9bbb5144f4be0d12094d9">ibuf_get_color_clip</a>(tc, ibuf, u, v, AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a>);
<a name="l00911"></a>00911                 <span class="comment">// TXF alpha: clip |= out;</span>
<a name="l00912"></a>00912                 <span class="comment">// TXF alpha: cw += out ? 0.f : wt;</span>
<a name="l00913"></a>00913                 texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += tc[0]*wt;
<a name="l00914"></a>00914                 texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += tc[1]*wt;
<a name="l00915"></a>00915                 texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += tc[2]*wt;
<a name="l00916"></a>00916                 texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> += texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? tc[3]*wt : 0.f;
<a name="l00917"></a>00917                 d += wt;
<a name="l00918"></a>00918             }
<a name="l00919"></a>00919             Q += DQ;
<a name="l00920"></a>00920             DQ += DDQ;
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <span class="comment">// d should hopefully never be zero anymore</span>
<a name="l00925"></a>00925     d = 1.f/d;
<a name="l00926"></a>00926     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= d;
<a name="l00927"></a>00927     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= d;
<a name="l00928"></a>00928     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= d;
<a name="l00929"></a>00929     <span class="comment">// clipping can be ignored if alpha used, texr-&gt;ta already includes filtered edge</span>
<a name="l00930"></a>00930     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*d : 1.f; <span class="comment">// TXF alpha (clip ? cw*d : 1.f);</span>
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#ade7a911a34cb48e79daecbb742cafff4">00933</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#ade7a911a34cb48e79daecbb742cafff4">feline_eval</a>(<a class="code" href="../../db/da2/structTexResult.html">TexResult</a>* texr, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* ibuf, <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a>* AFD)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935     <span class="keyword">const</span> <span class="keywordtype">int</span> maxn = AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> - 1;
<a name="l00936"></a>00936     <span class="keyword">const</span> <span class="keywordtype">float</span> ll = ((AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a> == AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af45366c67b57caedd66069710a8ae347">minrad</a>) ? 2.f*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a> : 2.f*(AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a> - AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#af45366c67b57caedd66069710a8ae347">minrad</a>)) / (maxn ? (<span class="keywordtype">float</span>)maxn : 1.f);
<a name="l00937"></a>00937     <span class="keywordtype">float</span> du = maxn ? <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">theta</a>)*ll : 0.f;
<a name="l00938"></a>00938     <span class="keywordtype">float</span> dv = maxn ? <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">theta</a>)*ll : 0.f;
<a name="l00939"></a>00939     <span class="comment">//const float D = -0.5f*(du*du + dv*dv) / (AFD-&gt;majrad*AFD-&gt;majrad);</span>
<a name="l00940"></a>00940     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a> = (<a class="code" href="../../dc/d58/imagetexture_8c.html#aa49e9feb3f976008cca214d3bb920ed0">EWA_MAXIDX</a> + 1)*0.25f*(du*du + dv*dv) / (AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a>*AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a>);
<a name="l00941"></a>00941     <span class="keywordtype">float</span> d; <span class="comment">// TXF alpha: cw = 0.f;</span>
<a name="l00942"></a>00942     <span class="keywordtype">int</span> n; <span class="comment">// TXF alpha: clip = 0;</span>
<a name="l00943"></a>00943     <span class="comment">// have to use same scaling for du/dv here as for Ux/Vx/Uy/Vy (*after* D calc.)</span>
<a name="l00944"></a>00944     du *= AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#ad5837b222440d0e9667ea63dfdd90684">dusc</a>;
<a name="l00945"></a>00945     dv *= AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a8e9f825b2564beebbfbee3356bd57ce1">dvsc</a>;
<a name="l00946"></a>00946     d = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 0.f;
<a name="l00947"></a>00947     <span class="keywordflow">for</span> (n=-maxn; n&lt;=maxn; n+=2) {
<a name="l00948"></a>00948         <span class="keywordtype">float</span> tc[4];
<a name="l00949"></a>00949         <span class="keyword">const</span> <span class="keywordtype">float</span> hn = n*0.5f;
<a name="l00950"></a>00950         <span class="keyword">const</span> <span class="keywordtype">float</span> u = fx + hn*du, v = fy + hn*dv;
<a name="l00951"></a>00951         <span class="comment">//const float wt = expf(n*n*D);</span>
<a name="l00952"></a>00952         <span class="comment">// can use ewa table here too</span>
<a name="l00953"></a>00953         <span class="keyword">const</span> <span class="keywordtype">float</span> wt = <a class="code" href="../../dc/d58/imagetexture_8c.html#a528179dae955fd288a960e632422a6d7">EWA_WTS</a>[(int)(n*n*D)];
<a name="l00954"></a>00954         <span class="comment">/*const int out =*/</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a2de5ba7226c3acfe49ef42a7c6ae1da0">ibuf_get_color_clip_bilerp</a>(tc, ibuf, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*u, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*v, AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a>, AFD-&gt;<a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a>);
<a name="l00955"></a>00955         <span class="comment">// TXF alpha: clip |= out;</span>
<a name="l00956"></a>00956         <span class="comment">// TXF alpha: cw += out ? 0.f : wt;</span>
<a name="l00957"></a>00957         texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += tc[0]*wt;
<a name="l00958"></a>00958         texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += tc[1]*wt;
<a name="l00959"></a>00959         texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += tc[2]*wt;
<a name="l00960"></a>00960         texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> += texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? tc[3]*wt : 0.f;
<a name="l00961"></a>00961         d += wt;
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     d = 1.f/d;
<a name="l00965"></a>00965     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= d;
<a name="l00966"></a>00966     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= d;
<a name="l00967"></a>00967     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= d;
<a name="l00968"></a>00968     <span class="comment">// clipping can be ignored if alpha used, texr-&gt;ta already includes filtered edge</span>
<a name="l00969"></a>00969     texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> ? texr-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*d : 1.f; <span class="comment">// TXF alpha: (clip ? cw*d : 1.f);</span>
<a name="l00970"></a>00970 }
<a name="l00971"></a>00971 <span class="preprocessor">#undef EWA_MAXIDX</span>
<a name="l00972"></a>00972 <span class="preprocessor"></span>
<a name="l00973"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#af37b7241616a2177efd38f5953bb992c">00973</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#af37b7241616a2177efd38f5953bb992c">alpha_clip_aniso</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> minx, <span class="keywordtype">float</span> miny, <span class="keywordtype">float</span> maxx, <span class="keywordtype">float</span> maxy, <span class="keywordtype">int</span> extflag, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975     <span class="keywordtype">float</span> alphaclip;
<a name="l00976"></a>00976     <a class="code" href="../../da/d10/structrctf.html">rctf</a> rf;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="comment">// TXF apha: we&#39;re doing the same alphaclip here as boxsample, but i&#39;m doubting</span>
<a name="l00979"></a>00979     <span class="comment">// if this is actually correct for the all the filtering algorithms ..</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     <span class="keywordflow">if</span> (!(extflag == <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a8ac9c51e12d0d227095a2bad82e9ef8c">TXC_REPT</a> || extflag == <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>)) {
<a name="l00982"></a>00982         rf.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = minx*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00983"></a>00983         rf.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = maxx*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>);
<a name="l00984"></a>00984         rf.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = miny*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00985"></a>00985         rf.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = maxy*(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987         alphaclip = <a class="code" href="../../dc/d58/imagetexture_8c.html#a89031a3762de5a845c5454572dce1deb">clipx_rctf</a>(&amp;rf, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>));
<a name="l00988"></a>00988         alphaclip*= <a class="code" href="../../dc/d58/imagetexture_8c.html#a329a6d8bc95f0cdebb0d7239c3a7455d">clipy_rctf</a>(&amp;rf, 0.0, (<span class="keywordtype">float</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>));
<a name="l00989"></a>00989         alphaclip= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(alphaclip, 0.0f);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (alphaclip!=1.0f) {
<a name="l00992"></a>00992             <span class="comment">/* premul it all */</span>
<a name="l00993"></a>00993             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*= alphaclip;
<a name="l00994"></a>00994             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*= alphaclip;
<a name="l00995"></a>00995             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*= alphaclip;
<a name="l00996"></a>00996             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= alphaclip;
<a name="l00997"></a>00997         }
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a964b7d4b2016d365bae5e19937a6e471">01001</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a964b7d4b2016d365bae5e19937a6e471">image_mipmap_test</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae80ae7a29d1acb12a94fa45c6eb3003f">TEX_MIPMAP</a>) {
<a name="l01004"></a>01004         <span class="keywordflow">if</span> ((ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) == 0) {
<a name="l01005"></a>01005             
<a name="l01006"></a>01006             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0] &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>)) {
<a name="l01007"></a>01007                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l01008"></a>01008                 <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>) {
<a name="l01009"></a>01009                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a28b4c6392d1dd04e9e31c4993998f825">IMB_remakemipmap</a>(ibuf, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a60ea850d7024ba0e02135cbaacb9dd46">TEX_GAUSS_MIP</a>);
<a name="l01010"></a>01010                     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l01011"></a>01011                 }               
<a name="l01012"></a>01012                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l01013"></a>01013             }
<a name="l01014"></a>01014             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01015"></a>01015                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l01016"></a>01016                 <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l01017"></a>01017                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a8904a6dde2816ac8cb9ecc2467907018">IMB_makemipmap</a>(ibuf, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a60ea850d7024ba0e02135cbaacb9dd46">TEX_GAUSS_MIP</a>);
<a name="l01018"></a>01018                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l01019"></a>01019             }
<a name="l01020"></a>01020         }
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022     
<a name="l01023"></a>01023 }
<a name="l01024"></a>01024 
<a name="l01025"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a9e197143a524e1862c0ef358cf43fdaf">01025</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a9e197143a524e1862c0ef358cf43fdaf">imagewraposa_aniso</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">float</span> texvec[3], <span class="keywordtype">float</span> dxt[3], <span class="keywordtype">float</span> dyt[3], <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l01026"></a>01026 {
<a name="l01027"></a>01027     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr;
<a name="l01028"></a>01028     <span class="keywordtype">float</span> fx, fy, minx, maxx, miny, maxy;
<a name="l01029"></a>01029     <span class="keywordtype">float</span> maxd, val1, val2, val3;
<a name="l01030"></a>01030     <span class="keywordtype">int</span> curmap, retval, intpol, extflag = 0;
<a name="l01031"></a>01031     <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a> AFD;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     void (*filterfunc)(<a class="code" href="../../db/da2/structTexResult.html">TexResult</a>*, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>*, float, float, <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a>*);
<a name="l01034"></a>01034     <span class="keywordflow">switch</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a>) {
<a name="l01035"></a>01035         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a3d9e2e63cb2ae5ccb76428f18629ba79">TXF_EWA</a>:
<a name="l01036"></a>01036             filterfunc = <a class="code" href="../../dc/d58/imagetexture_8c.html#a92263b7b602995e56d07eca88dc26a63">ewa_eval</a>;
<a name="l01037"></a>01037             <span class="keywordflow">break</span>;
<a name="l01038"></a>01038         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9b205a040bba4ed170658835afe52fac">TXF_FELINE</a>:
<a name="l01039"></a>01039             filterfunc = <a class="code" href="../../dc/d58/imagetexture_8c.html#ade7a911a34cb48e79daecbb742cafff4">feline_eval</a>;
<a name="l01040"></a>01040             <span class="keywordflow">break</span>;
<a name="l01041"></a>01041         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a09c6023e648fafb37a6312af20b9b61f">TXF_AREA</a>:
<a name="l01042"></a>01042         <span class="keywordflow">default</span>:
<a name="l01043"></a>01043             filterfunc = <a class="code" href="../../dc/d58/imagetexture_8c.html#ad8108ea76a976290bdbfe677604ca882">area_sample</a>;
<a name="l01044"></a>01044     }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = 0.f;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <span class="comment">// we need to set retval OK, otherwise texture code generates normals itself...</span>
<a name="l01049"></a>01049     retval = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> ? 3 : 1;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="comment">// quick tests</span>
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> retval;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keywordflow">if</span> (ima) {  <span class="comment">// hack for icon render</span>
<a name="l01055"></a>01055         <span class="keywordflow">if</span> ((ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08b663d172b49232b7ca4476b77ace8e">R_NO_IMAGE_LOAD</a>)) <span class="keywordflow">return</span> retval;
<a name="l01056"></a>01056         ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>); 
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="keywordflow">if</span> ((ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || ((ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) <span class="keywordflow">return</span> retval;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="comment">/* mipmap test */</span>
<a name="l01062"></a>01062     <a class="code" href="../../dc/d58/imagetexture_8c.html#a964b7d4b2016d365bae5e19937a6e471">image_mipmap_test</a>(tex, ibuf);
<a name="l01063"></a>01063     
<a name="l01064"></a>01064     <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a444168081b0f593651c005217b3bebc8">TEX_USEALPHA</a>) &amp;&amp; ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>) == 0)) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> = 1;
<a name="l01065"></a>01065     texr.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a559a12d8daec1eb2923dca665c30e11c">TEX_IMAROT</a>) {
<a name="l01068"></a>01068         fy = texvec[0];
<a name="l01069"></a>01069         fx = texvec[1];
<a name="l01070"></a>01070     }
<a name="l01071"></a>01071     <span class="keywordflow">else</span> {
<a name="l01072"></a>01072         fx = texvec[0];
<a name="l01073"></a>01073         fy = texvec[1];
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) {
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#acd8a56be1e1952923551c61511000ec4">R_FIELDS</a>) {          <span class="comment">/* field render */</span>
<a name="l01078"></a>01078             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) {     <span class="comment">/* correction for 2nd field */</span>
<a name="l01079"></a>01079                 <span class="comment">/* fac1= 0.5/( (float)ibuf-&gt;y ); */</span>
<a name="l01080"></a>01080                 <span class="comment">/* fy-= fac1; */</span>
<a name="l01081"></a>01081             }
<a name="l01082"></a>01082             <span class="keywordflow">else</span>    <span class="comment">/* first field */</span>
<a name="l01083"></a>01083                 fy += 0.5f/( (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> );
<a name="l01084"></a>01084         }
<a name="l01085"></a>01085     }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <span class="comment">// pixel coordinates</span>
<a name="l01088"></a>01088     minx = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(dxt[0], dyt[0], dxt[0] + dyt[0]);
<a name="l01089"></a>01089     maxx = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(dxt[0], dyt[0], dxt[0] + dyt[0]);
<a name="l01090"></a>01090     miny = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(dxt[1], dyt[1], dxt[1] + dyt[1]);
<a name="l01091"></a>01091     maxy = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(dxt[1], dyt[1], dxt[1] + dyt[1]);
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     <span class="comment">// tex_sharper has been removed</span>
<a name="l01094"></a>01094     minx = (maxx - minx)*0.5f;
<a name="l01095"></a>01095     miny = (maxy - miny)*0.5f;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af1fdb07331538fe6f19f8a296899af1d">TEX_FILTER_MIN</a>) {
<a name="l01098"></a>01098         <span class="comment">// make sure the filtersize is minimal in pixels (normal, ref map can have miniature pixel dx/dy)</span>
<a name="l01099"></a>01099         <span class="keyword">const</span> <span class="keywordtype">float</span> addval = (0.5f * tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>) / (<span class="keywordtype">float</span>)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (addval &gt; minx) minx = addval;
<a name="l01101"></a>01101         <span class="keywordflow">if</span> (addval &gt; miny) miny = addval;
<a name="l01102"></a>01102     }
<a name="l01103"></a>01103     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a> != 1.f) {
<a name="l01104"></a>01104         minx *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01105"></a>01105         miny *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01106"></a>01106         dxt[0] *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01107"></a>01107         dxt[1] *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01108"></a>01108         dyt[0] *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01109"></a>01109         dyt[1] *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a559a12d8daec1eb2923dca665c30e11c">TEX_IMAROT</a>) {
<a name="l01113"></a>01113         <span class="keywordtype">float</span> t;
<a name="l01114"></a>01114         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, minx, miny);
<a name="l01115"></a>01115         <span class="comment">// must rotate dxt/dyt 90 deg</span>
<a name="l01116"></a>01116         <span class="comment">// yet another blender problem is that swapping X/Y axes (or any tex proj switches) should do something similar,</span>
<a name="l01117"></a>01117         <span class="comment">// but it doesn&#39;t, it only swaps coords, so filter area will be incorrect in those cases.</span>
<a name="l01118"></a>01118         t = dxt[0];
<a name="l01119"></a>01119         dxt[0] = dxt[1];
<a name="l01120"></a>01120         dxt[1] = -t;
<a name="l01121"></a>01121         t = dyt[0];
<a name="l01122"></a>01122         dyt[0] = dyt[1];
<a name="l01123"></a>01123         dyt[1] = -t;
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     <span class="comment">// side faces of unit-cube</span>
<a name="l01127"></a>01127     minx = (minx &gt; 0.25f) ? 0.25f : ((minx &lt; 1e-5f) ? 1e-5f : minx);
<a name="l01128"></a>01128     miny = (miny &gt; 0.25f) ? 0.25f : ((miny &lt; 1e-5f) ? 1e-5f : miny);
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     <span class="comment">// repeat and clip</span>
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>) {
<a name="l01133"></a>01133         <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; (<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>)) == (<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>))
<a name="l01134"></a>01134             extflag = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>;
<a name="l01135"></a>01135         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a>)
<a name="l01136"></a>01136             extflag = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a4962830f29336d47b05363435827460a">TXC_XMIR</a>;
<a name="l01137"></a>01137         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>)
<a name="l01138"></a>01138             extflag = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a19201c73649052d57521ea976f061bb1">TXC_YMIR</a>;
<a name="l01139"></a>01139         <span class="keywordflow">else</span>
<a name="l01140"></a>01140             extflag = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210a8ac9c51e12d0d227095a2bad82e9ef8c">TXC_REPT</a>;
<a name="l01141"></a>01141     }
<a name="l01142"></a>01142     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>)
<a name="l01143"></a>01143         extflag = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l01146"></a>01146         <span class="keywordtype">int</span> xs = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx), ys = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy);
<a name="l01147"></a>01147         <span class="comment">// both checkers available, no boundary exceptions, checkerdist will eat aliasing</span>
<a name="l01148"></a>01148         <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>)) {
<a name="l01149"></a>01149             fx -= xs;
<a name="l01150"></a>01150             fy -= ys;
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152         <span class="keywordflow">else</span> {
<a name="l01153"></a>01153             <span class="keywordtype">int</span> xs1 = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx - minx);
<a name="l01154"></a>01154             <span class="keywordtype">int</span> ys1 = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy - miny);
<a name="l01155"></a>01155             <span class="keywordtype">int</span> xs2 = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx + minx);
<a name="l01156"></a>01156             <span class="keywordtype">int</span> ys2 = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy + miny);
<a name="l01157"></a>01157             <span class="keywordflow">if</span> ((xs1 != xs2) || (ys1 != ys2)) {
<a name="l01158"></a>01158                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>) {
<a name="l01159"></a>01159                     fx -= ((xs1 + ys) &amp; 1) ? xs2 : xs1;
<a name="l01160"></a>01160                     fy -= ((ys1 + xs) &amp; 1) ? ys2 : ys1;
<a name="l01161"></a>01161                 }
<a name="l01162"></a>01162                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>) {
<a name="l01163"></a>01163                     fx -= ((xs1 + ys) &amp; 1) ? xs1 : xs2;
<a name="l01164"></a>01164                     fy -= ((ys1 + xs) &amp; 1) ? ys1 : ys2;
<a name="l01165"></a>01165                 }
<a name="l01166"></a>01166             }
<a name="l01167"></a>01167             <span class="keywordflow">else</span> {
<a name="l01168"></a>01168                 <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>) == 0 &amp;&amp; ((xs + ys) &amp; 1) == 0) <span class="keywordflow">return</span> retval;
<a name="l01169"></a>01169                 <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>) == 0 &amp;&amp; (xs + ys) &amp; 1) <span class="keywordflow">return</span> retval;
<a name="l01170"></a>01170                 fx -= xs;
<a name="l01171"></a>01171                 fy -= ys;
<a name="l01172"></a>01172             }
<a name="l01173"></a>01173         }
<a name="l01174"></a>01174         <span class="comment">// scale around center, (0.5, 0.5)</span>
<a name="l01175"></a>01175         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a> &lt; 1.f) {
<a name="l01176"></a>01176             <span class="keyword">const</span> <span class="keywordtype">float</span> omcd = 1.f / (1.f - tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>);
<a name="l01177"></a>01177             fx = (fx - 0.5f)*omcd + 0.5f;
<a name="l01178"></a>01178             fy = (fy - 0.5f)*omcd + 0.5f;
<a name="l01179"></a>01179             minx *= omcd;
<a name="l01180"></a>01180             miny *= omcd;
<a name="l01181"></a>01181         }
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aef4ffe4660dd9c67dd2eb0d0fa9b3a49">TEX_CLIPCUBE</a>) {
<a name="l01185"></a>01185         <span class="keywordflow">if</span> ((fx + minx) &lt; 0.f || (fy + miny) &lt; 0.f || (fx - minx) &gt; 1.f || (fy - miny) &gt; 1.f || texvec[2] &lt; -1.f || texvec[2] &gt; 1.f) <span class="keywordflow">return</span> retval;
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae216dc5ade0b0babd139ea7ef16f6e19">TEX_CLIP</a> || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l01188"></a>01188         <span class="keywordflow">if</span> ((fx + minx) &lt; 0.f || (fy + miny) &lt; 0.f || (fx - minx) &gt; 1.f || (fy - miny) &gt; 1.f) <span class="keywordflow">return</span> retval;
<a name="l01189"></a>01189     }
<a name="l01190"></a>01190     <span class="keywordflow">else</span> {
<a name="l01191"></a>01191         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>) {
<a name="l01192"></a>01192             fx = (fx &gt; 1.f) ? 1.f : ((fx &lt; 0.f) ? 0.f : fx);
<a name="l01193"></a>01193             fy = (fy &gt; 1.f) ? 1.f : ((fy &lt; 0.f) ? 0.f : fy);
<a name="l01194"></a>01194         }
<a name="l01195"></a>01195         <span class="keywordflow">else</span> {
<a name="l01196"></a>01196             fx -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx);
<a name="l01197"></a>01197             fy -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy);
<a name="l01198"></a>01198         }
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     intpol = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee709515cccf026654a5e18043c9522c">TEX_INTERPOL</a>;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203     <span class="comment">// warning no return!</span>
<a name="l01204"></a>01204     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>))
<a name="l01205"></a>01205         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> += ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     <span class="comment">// struct common data</span>
<a name="l01208"></a>01208     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>, dxt);
<a name="l01209"></a>01209     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>, dyt);
<a name="l01210"></a>01210     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a> = intpol;
<a name="l01211"></a>01211     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a> = extflag;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="comment">// brecht: added stupid clamping here, large dx/dy can give very large</span>
<a name="l01214"></a>01214     <span class="comment">// filter sizes which take ages to render, it may be better to do this</span>
<a name="l01215"></a>01215     <span class="comment">// more intelligently later in the code .. probably it&#39;s not noticeable</span>
<a name="l01216"></a>01216     <span class="keywordflow">if</span> (AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0]*AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0] + AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1]*AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1] &gt; 2.0f*2.0f)
<a name="l01217"></a>01217         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>, 2.0f/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>));
<a name="l01218"></a>01218     <span class="keywordflow">if</span> (AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0]*AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0] + AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1]*AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1] &gt; 2.0f*2.0f)
<a name="l01219"></a>01219         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5c6d272cb16304939dbe77dacc77b3b0">mul_v2_fl</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>, 2.0f/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>));
<a name="l01220"></a>01220 
<a name="l01221"></a>01221     <span class="comment">// choice:</span>
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae80ae7a29d1acb12a94fa45c6eb3003f">TEX_MIPMAP</a>) {
<a name="l01223"></a>01223         ImBuf *previbuf, *curibuf;
<a name="l01224"></a>01224         <span class="keywordtype">float</span> levf;
<a name="l01225"></a>01225         <span class="keywordtype">int</span> maxlev;
<a name="l01226"></a>01226         ImBuf* mipmaps[<a class="code" href="../../dd/d38/iff_8h.html#a059e2f48c2c825fb5eb88f60ef23a723">IB_MIPMAP_LEVELS</a> + 1];
<a name="l01227"></a>01227 
<a name="l01228"></a>01228         <span class="comment">// modify ellipse minor axis if too eccentric, use for area sampling as well</span>
<a name="l01229"></a>01229         <span class="comment">// scaling dxt/dyt as done in pbrt is not the same</span>
<a name="l01230"></a>01230         <span class="comment">// (as in ewa_eval(), scale by sqrt(ibuf-&gt;x) to maximize precision)</span>
<a name="l01231"></a>01231         <span class="keyword">const</span> <span class="keywordtype">float</span> ff = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>), q = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>/ff;
<a name="l01232"></a>01232         <span class="keyword">const</span> <span class="keywordtype">float</span> Ux = dxt[0]*ff, Vx = dxt[1]*q, Uy = dyt[0]*ff, Vy = dyt[1]*q;
<a name="l01233"></a>01233         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../de/da0/strsv_8c.html#af5d6242ff783dd9efca51eeec1c234f7">A</a> = Vx*Vx + Vy*Vy;
<a name="l01234"></a>01234         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a> = -2.f*(Ux*Vx + Uy*Vy);
<a name="l01235"></a>01235         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> = Ux*Ux + Uy*Uy;
<a name="l01236"></a>01236         <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a> = A*C - B*B*0.25f;
<a name="l01237"></a>01237         <span class="keywordtype">float</span> a, b, th, ecc;
<a name="l01238"></a>01238         <a class="code" href="../../dc/d58/imagetexture_8c.html#ac4d4c7de956085cd7e83bd14468d29d4">imp2radangle</a>(A, B, C, F, &amp;a, &amp;b, &amp;th, &amp;ecc);
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9b205a040bba4ed170658835afe52fac">TXF_FELINE</a>) {
<a name="l01240"></a>01240             <span class="keywordtype">float</span> fProbes;
<a name="l01241"></a>01241             a *= ff;
<a name="l01242"></a>01242             b *= ff;
<a name="l01243"></a>01243             a = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(a, 1.f);
<a name="l01244"></a>01244             b = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(b, 1.f);
<a name="l01245"></a>01245             fProbes = 2.f*(a / b) - 1.f;
<a name="l01246"></a>01246             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fProbes + 0.5f);
<a name="l01247"></a>01247             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a901fc545220eddc1947d1a28a9ee2d6d">afmax</a>);
<a name="l01248"></a>01248             <span class="keywordflow">if</span> (AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> &lt; fProbes)
<a name="l01249"></a>01249                 b = 2.f*a / (float)(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> + 1);
<a name="l01250"></a>01250             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a> = a/ff;
<a name="l01251"></a>01251             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af45366c67b57caedd66069710a8ae347">minrad</a> = b/ff;
<a name="l01252"></a>01252             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">theta</a> = th;
<a name="l01253"></a>01253             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#ad5837b222440d0e9667ea63dfdd90684">dusc</a> = 1.f/ff;
<a name="l01254"></a>01254             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a8e9f825b2564beebbfbee3356bd57ce1">dvsc</a> = ff / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01255"></a>01255         }
<a name="l01256"></a>01256         <span class="keywordflow">else</span> {  <span class="comment">// EWA &amp; area</span>
<a name="l01257"></a>01257             <span class="keywordflow">if</span> (ecc &gt; (<span class="keywordtype">float</span>)tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a901fc545220eddc1947d1a28a9ee2d6d">afmax</a>) b = a / (<span class="keywordtype">float</span>)tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a901fc545220eddc1947d1a28a9ee2d6d">afmax</a>;
<a name="l01258"></a>01258             b *= ff;
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260         maxd = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(b, 1e-8f);
<a name="l01261"></a>01261         levf = ((float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac5c747ee5bcbe892875672a0b9d8171c">M_LOG2E</a>)*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a85962e624e1b5fdeacb6d0cb257ae715">logf</a>(maxd);
<a name="l01262"></a>01262 
<a name="l01263"></a>01263         curmap = 0;
<a name="l01264"></a>01264         maxlev = 1;
<a name="l01265"></a>01265         mipmaps[0] = ibuf;
<a name="l01266"></a>01266         <span class="keywordflow">while</span> (curmap &lt; <a class="code" href="../../dd/d38/iff_8h.html#a059e2f48c2c825fb5eb88f60ef23a723">IB_MIPMAP_LEVELS</a>) {
<a name="l01267"></a>01267             mipmaps[curmap + 1] = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[curmap];
<a name="l01268"></a>01268             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[curmap]) maxlev++;
<a name="l01269"></a>01269             curmap++;
<a name="l01270"></a>01270         }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272         <span class="comment">// mipmap level</span>
<a name="l01273"></a>01273         <span class="keywordflow">if</span> (levf &lt; 0.f) {   <span class="comment">// original image only</span>
<a name="l01274"></a>01274             previbuf = curibuf = mipmaps[0];
<a name="l01275"></a>01275             levf = 0.f;
<a name="l01276"></a>01276         }
<a name="l01277"></a>01277         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (levf &gt;= maxlev - 1) {
<a name="l01278"></a>01278             previbuf = curibuf = mipmaps[maxlev - 1];
<a name="l01279"></a>01279             levf = 0.f;
<a name="l01280"></a>01280             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9b205a040bba4ed170658835afe52fac">TXF_FELINE</a>) AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> = 1;
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282         <span class="keywordflow">else</span> {
<a name="l01283"></a>01283             <span class="keyword">const</span> <span class="keywordtype">int</span> lev = <a class="code" href="../../dc/d58/imagetexture_8c.html#abdca9ff18fc20268c729ae8bd141f4c5">ISNAN</a>(levf) ? 0 : (int)levf;
<a name="l01284"></a>01284             curibuf = mipmaps[lev];
<a name="l01285"></a>01285             previbuf = mipmaps[lev + 1];
<a name="l01286"></a>01286             levf -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(levf);
<a name="l01287"></a>01287         }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289         <span class="comment">// filter functions take care of interpolation themselves, no need to modify dxt/dyt here</span>
<a name="l01290"></a>01290 
<a name="l01291"></a>01291         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>) == 0)) {
<a name="l01292"></a>01292             <span class="comment">// color &amp; normal</span>
<a name="l01293"></a>01293             filterfunc(texres, curibuf, fx, fy, &amp;AFD);
<a name="l01294"></a>01294             val1 = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01295"></a>01295             filterfunc(&amp;texr, curibuf, fx + dxt[0], fy + dxt[1], &amp;AFD);
<a name="l01296"></a>01296             val2 = texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01297"></a>01297             filterfunc(&amp;texr, curibuf, fx + dyt[0], fy + dyt[1], &amp;AFD);
<a name="l01298"></a>01298             val3 = texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01299"></a>01299             <span class="comment">// don&#39;t switch x or y!</span>
<a name="l01300"></a>01300             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = val1 - val2;
<a name="l01301"></a>01301             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = val1 - val3;
<a name="l01302"></a>01302             <span class="keywordflow">if</span> (previbuf != curibuf) {  <span class="comment">// interpolate</span>
<a name="l01303"></a>01303                 filterfunc(&amp;texr, previbuf, fx, fy, &amp;AFD);
<a name="l01304"></a>01304                 <span class="comment">// rgb</span>
<a name="l01305"></a>01305                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>);
<a name="l01306"></a>01306                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>);
<a name="l01307"></a>01307                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01308"></a>01308                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>);
<a name="l01309"></a>01309                 <span class="comment">// normal</span>
<a name="l01310"></a>01310                 val1 += levf*((texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) - val1);
<a name="l01311"></a>01311                 filterfunc(&amp;texr, previbuf, fx + dxt[0], fy + dxt[1], &amp;AFD);
<a name="l01312"></a>01312                 val2 += levf*((texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) - val2);
<a name="l01313"></a>01313                 filterfunc(&amp;texr, previbuf, fx + dyt[0], fy + dyt[1], &amp;AFD);
<a name="l01314"></a>01314                 val3 += levf*((texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) - val3);
<a name="l01315"></a>01315                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = val1 - val2;   <span class="comment">// vals have been interpolated above!</span>
<a name="l01316"></a>01316                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = val1 - val3;
<a name="l01317"></a>01317             }
<a name="l01318"></a>01318         }
<a name="l01319"></a>01319         <span class="keywordflow">else</span> {  <span class="comment">// color</span>
<a name="l01320"></a>01320             filterfunc(texres, curibuf, fx, fy, &amp;AFD);
<a name="l01321"></a>01321             <span class="keywordflow">if</span> (previbuf != curibuf) {  <span class="comment">// interpolate</span>
<a name="l01322"></a>01322                 filterfunc(&amp;texr, previbuf, fx, fy, &amp;AFD);
<a name="l01323"></a>01323                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>);
<a name="l01324"></a>01324                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>);
<a name="l01325"></a>01325                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01326"></a>01326                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> += levf*(texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>);
<a name="l01327"></a>01327             }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329             <a class="code" href="../../dc/d58/imagetexture_8c.html#af37b7241616a2177efd38f5953bb992c">alpha_clip_aniso</a>(ibuf, fx-minx, fy-miny, fx+minx, fy+miny, extflag, texres);
<a name="l01330"></a>01330         }
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332     <span class="keywordflow">else</span> {  <span class="comment">// no mipmap</span>
<a name="l01333"></a>01333         <span class="comment">// filter functions take care of interpolation themselves, no need to modify dxt/dyt here</span>
<a name="l01334"></a>01334         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9b205a040bba4ed170658835afe52fac">TXF_FELINE</a>) {
<a name="l01335"></a>01335             <span class="keyword">const</span> <span class="keywordtype">float</span> ff = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>), q = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>/ff;
<a name="l01336"></a>01336             <span class="keyword">const</span> <span class="keywordtype">float</span> Ux = dxt[0]*ff, Vx = dxt[1]*q, Uy = dyt[0]*ff, Vy = dyt[1]*q;
<a name="l01337"></a>01337             <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../de/da0/strsv_8c.html#af5d6242ff783dd9efca51eeec1c234f7">A</a> = Vx*Vx + Vy*Vy;
<a name="l01338"></a>01338             <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a> = -2.f*(Ux*Vx + Uy*Vy);
<a name="l01339"></a>01339             <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> = Ux*Ux + Uy*Uy;
<a name="l01340"></a>01340             <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a> = A*C - B*B*0.25f;
<a name="l01341"></a>01341             <span class="keywordtype">float</span> a, b, th, ecc, fProbes;
<a name="l01342"></a>01342             <a class="code" href="../../dc/d58/imagetexture_8c.html#ac4d4c7de956085cd7e83bd14468d29d4">imp2radangle</a>(A, B, C, F, &amp;a, &amp;b, &amp;th, &amp;ecc);
<a name="l01343"></a>01343             a *= ff;
<a name="l01344"></a>01344             b *= ff;
<a name="l01345"></a>01345             a = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(a, 1.f);
<a name="l01346"></a>01346             b = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(b, 1.f);
<a name="l01347"></a>01347             fProbes = 2.f*(a / b) - 1.f;
<a name="l01348"></a>01348             <span class="comment">// no limit to number of Probes here</span>
<a name="l01349"></a>01349             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fProbes + 0.5f);
<a name="l01350"></a>01350             <span class="keywordflow">if</span> (AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> &lt; fProbes) b = 2.f*a / (float)(AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a98a06ab1cd587bc3304daf94edd71f6e">iProbes</a> + 1);
<a name="l01351"></a>01351             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#aefa49fd27311a25c48f1642857a94cff">majrad</a> = a/ff;
<a name="l01352"></a>01352             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af45366c67b57caedd66069710a8ae347">minrad</a> = b/ff;
<a name="l01353"></a>01353             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#ac934513e5fd7c12c11851ec6ad863d99">theta</a> = th;
<a name="l01354"></a>01354             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#ad5837b222440d0e9667ea63dfdd90684">dusc</a> = 1.f/ff;
<a name="l01355"></a>01355             AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a8e9f825b2564beebbfbee3356bd57ce1">dvsc</a> = ff / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>) == 0)) {
<a name="l01358"></a>01358             <span class="comment">// color &amp; normal</span>
<a name="l01359"></a>01359             filterfunc(texres, ibuf, fx, fy, &amp;AFD);
<a name="l01360"></a>01360             val1 = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01361"></a>01361             filterfunc(&amp;texr, ibuf, fx + dxt[0], fy + dxt[1], &amp;AFD);
<a name="l01362"></a>01362             val2 = texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01363"></a>01363             filterfunc(&amp;texr, ibuf, fx + dyt[0], fy + dyt[1], &amp;AFD);
<a name="l01364"></a>01364             val3 = texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01365"></a>01365             <span class="comment">// don&#39;t switch x or y!</span>
<a name="l01366"></a>01366             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = val1 - val2;
<a name="l01367"></a>01367             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = val1 - val3;
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369         <span class="keywordflow">else</span> {
<a name="l01370"></a>01370             filterfunc(texres, ibuf, fx, fy, &amp;AFD);
<a name="l01371"></a>01371             <a class="code" href="../../dc/d58/imagetexture_8c.html#af37b7241616a2177efd38f5953bb992c">alpha_clip_aniso</a>(ibuf, fx-minx, fy-miny, fx+minx, fy+miny, extflag, texres);
<a name="l01372"></a>01372         }
<a name="l01373"></a>01373     }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>)
<a name="l01376"></a>01376         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> * <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01377"></a>01377     <span class="keywordflow">else</span>
<a name="l01378"></a>01378         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01379"></a>01379     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9ddd149ad6bb398568d6d8f00f756cf7">TEX_NEGALPHA</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 1.f - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01380"></a>01380     
<a name="l01381"></a>01381     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>))
<a name="l01382"></a>01382         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> -= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>)) {    <span class="comment">// normal from color</span>
<a name="l01385"></a>01385         <span class="comment">// The invert of the red channel is to make</span>
<a name="l01386"></a>01386         <span class="comment">// the normal map compliant with the outside world.</span>
<a name="l01387"></a>01387         <span class="comment">// It needs to be done because in Blender</span>
<a name="l01388"></a>01388         <span class="comment">// the normal used in the renderer points inward. It is generated</span>
<a name="l01389"></a>01389         <span class="comment">// this way in calc_vertexnormals(). Should this ever change</span>
<a name="l01390"></a>01390         <span class="comment">// this negate must be removed.</span>
<a name="l01391"></a>01391         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = -2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> - 0.5f);
<a name="l01392"></a>01392         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> - 0.5f);
<a name="l01393"></a>01393         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> - 0.5f);
<a name="l01394"></a>01394     }
<a name="l01395"></a>01395     
<a name="l01396"></a>01396     <span class="comment">// de-premul, this is being premulled in shade_input_do_shade()</span>
<a name="l01397"></a>01397     <span class="comment">// TXF: this currently does not (yet?) work properly, destroys edge AA in clip/checker mode, so for now commented out</span>
<a name="l01398"></a>01398     <span class="comment">// also disabled in imagewraposa() to be able to compare results with blender&#39;s default texture filtering</span>
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     <span class="comment">// brecht: tried to fix this, see &quot;TXF alpha&quot; comments</span>
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> != 1.f &amp;&amp; (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> &gt; 1e-4f)) {
<a name="l01403"></a>01403         fx = 1.f/texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01404"></a>01404         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= fx;
<a name="l01405"></a>01405         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= fx;
<a name="l01406"></a>01406         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= fx;
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l01410"></a>01410     
<a name="l01411"></a>01411     <span class="keywordflow">return</span> retval;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 
<a name="l01415"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a2fd4454188fe8e47bd3944d2ef367338">01415</a> <span class="keywordtype">int</span> <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">float</span> texvec[3], <span class="keyword">const</span> <span class="keywordtype">float</span> DXT[3], <span class="keyword">const</span> <span class="keywordtype">float</span> DYT[3], <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l01416"></a>01416 {
<a name="l01417"></a>01417     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr;
<a name="l01418"></a>01418     <span class="keywordtype">float</span> fx, fy, minx, maxx, miny, maxy, dx, dy, dxt[3], dyt[3];
<a name="l01419"></a>01419     <span class="keywordtype">float</span> maxd, pixsize, val1, val2, val3;
<a name="l01420"></a>01420     <span class="keywordtype">int</span> curmap, retval, imaprepeat, imapextend;
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="comment">// TXF: since dxt/dyt might be modified here and since they might be needed after imagewraposa() call,</span>
<a name="l01423"></a>01423     <span class="comment">// make a local copy here so that original vecs remain untouched</span>
<a name="l01424"></a>01424     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dxt, DXT);
<a name="l01425"></a>01425     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dyt, DYT);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     <span class="comment">// anisotropic filtering</span>
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> != <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a95c4c1619f7b35365a1352603de03ab5">TXF_BOX</a>)
<a name="l01429"></a>01429         <span class="keywordflow">return</span> <a class="code" href="../../dc/d58/imagetexture_8c.html#a9e197143a524e1862c0ef358cf43fdaf">imagewraposa_aniso</a>(tex, ima, ibuf, texvec, dxt, dyt, texres);
<a name="l01430"></a>01430 
<a name="l01431"></a>01431     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 0.0f;
<a name="l01432"></a>01432     
<a name="l01433"></a>01433     <span class="comment">/* we need to set retval OK, otherwise texture code generates normals itself... */</span>
<a name="l01434"></a>01434     retval= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>?3:1;
<a name="l01435"></a>01435     
<a name="l01436"></a>01436     <span class="comment">/* quick tests */</span>
<a name="l01437"></a>01437     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01438"></a>01438         <span class="keywordflow">return</span> retval;
<a name="l01439"></a>01439     <span class="keywordflow">if</span> (ima) {
<a name="l01440"></a>01440 
<a name="l01441"></a>01441         <span class="comment">/* hack for icon render */</span>
<a name="l01442"></a>01442         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08b663d172b49232b7ca4476b77ace8e">R_NO_IMAGE_LOAD</a>))
<a name="l01443"></a>01443             <span class="keywordflow">return</span> retval;
<a name="l01444"></a>01444         
<a name="l01445"></a>01445         ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>); 
<a name="l01446"></a>01446 
<a name="l01447"></a>01447         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a>|= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ab59b18637a0194b0f6e0b89a1ffdb474">IMA_USED_FOR_RENDER</a>;
<a name="l01448"></a>01448     }
<a name="l01449"></a>01449     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l01450"></a>01450         <span class="keywordflow">return</span> retval;
<a name="l01451"></a>01451     
<a name="l01452"></a>01452     <span class="comment">/* mipmap test */</span>
<a name="l01453"></a>01453     <a class="code" href="../../dc/d58/imagetexture_8c.html#a964b7d4b2016d365bae5e19937a6e471">image_mipmap_test</a>(tex, ibuf);
<a name="l01454"></a>01454 
<a name="l01455"></a>01455     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a444168081b0f593651c005217b3bebc8">TEX_USEALPHA</a>) {
<a name="l01456"></a>01456         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>);
<a name="l01457"></a>01457         <span class="keywordflow">else</span> texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= 1;
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459     
<a name="l01460"></a>01460     texr.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>;
<a name="l01461"></a>01461     
<a name="l01462"></a>01462     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a559a12d8daec1eb2923dca665c30e11c">TEX_IMAROT</a>) {
<a name="l01463"></a>01463         fy= texvec[0];
<a name="l01464"></a>01464         fx= texvec[1];
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466     <span class="keywordflow">else</span> {
<a name="l01467"></a>01467         fx= texvec[0];
<a name="l01468"></a>01468         fy= texvec[1];
<a name="l01469"></a>01469     }
<a name="l01470"></a>01470     
<a name="l01471"></a>01471     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) {
<a name="l01472"></a>01472         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#acd8a56be1e1952923551c61511000ec4">R_FIELDS</a>) {          <span class="comment">/* field render */</span>
<a name="l01473"></a>01473             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) {     <span class="comment">/* correction for 2nd field */</span>
<a name="l01474"></a>01474                 <span class="comment">/* fac1= 0.5/( (float)ibuf-&gt;y ); */</span>
<a name="l01475"></a>01475                 <span class="comment">/* fy-= fac1; */</span>
<a name="l01476"></a>01476             }
<a name="l01477"></a>01477             <span class="keywordflow">else</span> {              <span class="comment">/* first field */</span>
<a name="l01478"></a>01478                 fy+= 0.5f/( (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> );
<a name="l01479"></a>01479             }
<a name="l01480"></a>01480         }
<a name="l01481"></a>01481     }
<a name="l01482"></a>01482     
<a name="l01483"></a>01483     <span class="comment">/* pixel coordinates */</span>
<a name="l01484"></a>01484 
<a name="l01485"></a>01485     minx= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(dxt[0],dyt[0],dxt[0]+dyt[0] );
<a name="l01486"></a>01486     maxx= <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(dxt[0],dyt[0],dxt[0]+dyt[0] );
<a name="l01487"></a>01487     miny= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(dxt[1],dyt[1],dxt[1]+dyt[1] );
<a name="l01488"></a>01488     maxy= <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(dxt[1],dyt[1],dxt[1]+dyt[1] );
<a name="l01489"></a>01489 
<a name="l01490"></a>01490     <span class="comment">/* tex_sharper has been removed */</span>
<a name="l01491"></a>01491     minx= (maxx-minx)/2.0f;
<a name="l01492"></a>01492     miny= (maxy-miny)/2.0f;
<a name="l01493"></a>01493     
<a name="l01494"></a>01494     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af1fdb07331538fe6f19f8a296899af1d">TEX_FILTER_MIN</a>) {
<a name="l01495"></a>01495         <span class="comment">/* make sure the filtersize is minimal in pixels (normal, ref map can have miniature pixel dx/dy) */</span>
<a name="l01496"></a>01496         <span class="keywordtype">float</span> addval= (0.5f * tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>) / (<span class="keywordtype">float</span>) <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01497"></a>01497 
<a name="l01498"></a>01498         <span class="keywordflow">if</span> (addval &gt; minx)
<a name="l01499"></a>01499             minx= addval;
<a name="l01500"></a>01500         <span class="keywordflow">if</span> (addval &gt; miny)
<a name="l01501"></a>01501             miny= addval;
<a name="l01502"></a>01502     }
<a name="l01503"></a>01503     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>!=1.0f) {
<a name="l01504"></a>01504         minx*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01505"></a>01505         miny*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01506"></a>01506         
<a name="l01507"></a>01507         dxt[0]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01508"></a>01508         dxt[1]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01509"></a>01509         dyt[0]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01510"></a>01510         dyt[1]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#af4bade26865aad8551d7f436cf0f6555">filtersize</a>;
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a559a12d8daec1eb2923dca665c30e11c">TEX_IMAROT</a>) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, minx, miny);
<a name="l01514"></a>01514     
<a name="l01515"></a>01515     <span class="keywordflow">if</span> (minx&gt;0.25f) minx= 0.25f;
<a name="l01516"></a>01516     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (minx&lt;0.00001f) minx= 0.00001f; <span class="comment">/* side faces of unit-cube */</span>
<a name="l01517"></a>01517     <span class="keywordflow">if</span> (miny&gt;0.25f) miny= 0.25f;
<a name="l01518"></a>01518     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (miny&lt;0.00001f) miny= 0.00001f;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     
<a name="l01521"></a>01521     <span class="comment">/* repeat and clip */</span>
<a name="l01522"></a>01522     imaprepeat= (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>);
<a name="l01523"></a>01523     imapextend= (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>) {
<a name="l01526"></a>01526         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; (<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a>|<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>)) {
<a name="l01527"></a>01527             imaprepeat= 0;
<a name="l01528"></a>01528             imapextend= 1;
<a name="l01529"></a>01529         }
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l01533"></a>01533         <span class="keywordtype">int</span> xs, ys, xs1, ys1, xs2, ys2, boundary;
<a name="l01534"></a>01534         
<a name="l01535"></a>01535         xs= (int)floor(fx);
<a name="l01536"></a>01536         ys= (int)floor(fy);
<a name="l01537"></a>01537         
<a name="l01538"></a>01538         <span class="comment">// both checkers available, no boundary exceptions, checkerdist will eat aliasing</span>
<a name="l01539"></a>01539         <span class="keywordflow">if</span> ( (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>) ) {
<a name="l01540"></a>01540             fx-= xs;
<a name="l01541"></a>01541             fy-= ys;
<a name="l01542"></a>01542         }
<a name="l01543"></a>01543         <span class="keywordflow">else</span> {
<a name="l01544"></a>01544             
<a name="l01545"></a>01545             xs1= (int)floor(fx-minx);
<a name="l01546"></a>01546             ys1= (int)floor(fy-miny);
<a name="l01547"></a>01547             xs2= (int)floor(fx+minx);
<a name="l01548"></a>01548             ys2= (int)floor(fy+miny);
<a name="l01549"></a>01549             boundary= (xs1!=xs2) || (ys1!=ys2);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551             <span class="keywordflow">if</span> (boundary==0) {
<a name="l01552"></a>01552                 <span class="keywordflow">if</span> ( (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>)==0) {
<a name="l01553"></a>01553                     <span class="keywordflow">if</span> ((xs+ys) &amp; 1);
<a name="l01554"></a>01554                     <span class="keywordflow">else</span> <span class="keywordflow">return</span> retval;
<a name="l01555"></a>01555                 }
<a name="l01556"></a>01556                 <span class="keywordflow">if</span> ( (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>)==0) {
<a name="l01557"></a>01557                     <span class="keywordflow">if</span> ((xs+ys) &amp; 1) <span class="keywordflow">return</span> retval;
<a name="l01558"></a>01558                 }
<a name="l01559"></a>01559                 fx-= xs;
<a name="l01560"></a>01560                 fy-= ys;
<a name="l01561"></a>01561             }
<a name="l01562"></a>01562             <span class="keywordflow">else</span> {
<a name="l01563"></a>01563                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab20d965b17d9413802f33b1c5f1803b1">TEX_CHECKER_ODD</a>) {
<a name="l01564"></a>01564                     <span class="keywordflow">if</span> ((xs1+ys) &amp; 1) fx-= xs2;
<a name="l01565"></a>01565                     <span class="keywordflow">else</span> fx-= xs1;
<a name="l01566"></a>01566                     
<a name="l01567"></a>01567                     <span class="keywordflow">if</span> ((ys1+xs) &amp; 1) fy-= ys2;
<a name="l01568"></a>01568                     <span class="keywordflow">else</span> fy-= ys1;
<a name="l01569"></a>01569                 }
<a name="l01570"></a>01570                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0b3134d323e259a4e18cf4ae5cb991f7">TEX_CHECKER_EVEN</a>) {
<a name="l01571"></a>01571                     <span class="keywordflow">if</span> ((xs1+ys) &amp; 1) fx-= xs1;
<a name="l01572"></a>01572                     <span class="keywordflow">else</span> fx-= xs2;
<a name="l01573"></a>01573                     
<a name="l01574"></a>01574                     <span class="keywordflow">if</span> ((ys1+xs) &amp; 1) fy-= ys1;
<a name="l01575"></a>01575                     <span class="keywordflow">else</span> fy-= ys2;
<a name="l01576"></a>01576                 }
<a name="l01577"></a>01577             }
<a name="l01578"></a>01578         }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580         <span class="comment">/* scale around center, (0.5, 0.5) */</span>
<a name="l01581"></a>01581         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>&lt;1.0f) {
<a name="l01582"></a>01582             fx= (fx-0.5f)/(1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>) +0.5f;
<a name="l01583"></a>01583             fy= (fy-0.5f)/(1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>) +0.5f;
<a name="l01584"></a>01584             minx/= (1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>);
<a name="l01585"></a>01585             miny/= (1.0f-tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a36bcb84219597f34960e9fedee76ff86">checkerdist</a>);
<a name="l01586"></a>01586         }
<a name="l01587"></a>01587     }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aef4ffe4660dd9c67dd2eb0d0fa9b3a49">TEX_CLIPCUBE</a>) {
<a name="l01590"></a>01590         <span class="keywordflow">if</span> (fx+minx&lt;0.0f || fy+miny&lt;0.0f || fx-minx&gt;1.0f || fy-miny&gt;1.0f || texvec[2]&lt;-1.0f || texvec[2]&gt;1.0f) {
<a name="l01591"></a>01591             <span class="keywordflow">return</span> retval;
<a name="l01592"></a>01592         }
<a name="l01593"></a>01593     }
<a name="l01594"></a>01594     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae216dc5ade0b0babd139ea7ef16f6e19">TEX_CLIP</a> || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a58df8ea2713e4d4e44f0eff17b496b4a">TEX_CHECKER</a>) {
<a name="l01595"></a>01595         <span class="keywordflow">if</span> (fx+minx&lt;0.0f || fy+miny&lt;0.0f || fx-minx&gt;1.0f || fy-miny&gt;1.0f) {
<a name="l01596"></a>01596             <span class="keywordflow">return</span> retval;
<a name="l01597"></a>01597         }
<a name="l01598"></a>01598     }
<a name="l01599"></a>01599     <span class="keywordflow">else</span> {
<a name="l01600"></a>01600         <span class="keywordflow">if</span> (imapextend) {
<a name="l01601"></a>01601             <span class="keywordflow">if</span> (fx&gt;1.0f) fx = 1.0f;
<a name="l01602"></a>01602             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fx&lt;0.0f) fx= 0.0f;
<a name="l01603"></a>01603         }
<a name="l01604"></a>01604         <span class="keywordflow">else</span> {
<a name="l01605"></a>01605             <span class="keywordflow">if</span> (fx&gt;1.0f) fx -= (int)(fx);
<a name="l01606"></a>01606             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fx&lt;0.0f) fx+= 1-(int)(fx);
<a name="l01607"></a>01607         }
<a name="l01608"></a>01608         
<a name="l01609"></a>01609         <span class="keywordflow">if</span> (imapextend) {
<a name="l01610"></a>01610             <span class="keywordflow">if</span> (fy&gt;1.0f) fy = 1.0f;
<a name="l01611"></a>01611             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fy&lt;0.0f) fy= 0.0f;
<a name="l01612"></a>01612         }
<a name="l01613"></a>01613         <span class="keywordflow">else</span> {
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (fy&gt;1.0f) fy -= (int)(fy);
<a name="l01615"></a>01615             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fy&lt;0.0f) fy+= 1-(int)(fy);
<a name="l01616"></a>01616         }
<a name="l01617"></a>01617     }
<a name="l01618"></a>01618 
<a name="l01619"></a>01619     <span class="comment">/* warning no return! */</span>
<a name="l01620"></a>01620     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) ) {
<a name="l01621"></a>01621         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>+= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     <span class="comment">/* choice:  */</span>
<a name="l01625"></a>01625     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae80ae7a29d1acb12a94fa45c6eb3003f">TEX_MIPMAP</a>) {
<a name="l01626"></a>01626         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *previbuf, *curibuf;
<a name="l01627"></a>01627         <span class="keywordtype">float</span> bumpscale;
<a name="l01628"></a>01628         
<a name="l01629"></a>01629         dx= minx;
<a name="l01630"></a>01630         dy= miny;
<a name="l01631"></a>01631         maxd= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(dx, dy);
<a name="l01632"></a>01632         <span class="keywordflow">if</span> (maxd&gt;0.5f) maxd= 0.5f;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634         pixsize = 1.0f/ (float) <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01635"></a>01635         
<a name="l01636"></a>01636         bumpscale= pixsize/maxd;
<a name="l01637"></a>01637         <span class="keywordflow">if</span> (bumpscale&gt;1.0f) bumpscale= 1.0f;
<a name="l01638"></a>01638         <span class="keywordflow">else</span> bumpscale*=bumpscale;
<a name="l01639"></a>01639         
<a name="l01640"></a>01640         curmap= 0;
<a name="l01641"></a>01641         previbuf= curibuf= ibuf;
<a name="l01642"></a>01642         <span class="keywordflow">while</span> (curmap&lt;IB_MIPMAP_LEVELS &amp;&amp; ibuf-&gt;mipmap[curmap]) {
<a name="l01643"></a>01643             <span class="keywordflow">if</span> (maxd &lt; pixsize) <span class="keywordflow">break</span>;
<a name="l01644"></a>01644             previbuf= curibuf;
<a name="l01645"></a>01645             curibuf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[curmap];
<a name="l01646"></a>01646             pixsize= 1.0f / (float)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(curibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, curibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01647"></a>01647             curmap++;
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649 
<a name="l01650"></a>01650         <span class="keywordflow">if</span> (previbuf!=curibuf || (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee709515cccf026654a5e18043c9522c">TEX_INTERPOL</a>)) {
<a name="l01651"></a>01651             <span class="comment">/* sample at least 1 pixel */</span>
<a name="l01652"></a>01652             <span class="keywordflow">if</span> (minx &lt; 0.5f / ibuf-&gt;x) minx = 0.5f / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01653"></a>01653             <span class="keywordflow">if</span> (miny &lt; 0.5f / ibuf-&gt;y) miny = 0.5f / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655         
<a name="l01656"></a>01656         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>)==0) {
<a name="l01657"></a>01657             <span class="comment">/* a bit extra filter */</span>
<a name="l01658"></a>01658             <span class="comment">//minx*= 1.35f;</span>
<a name="l01659"></a>01659             <span class="comment">//miny*= 1.35f;</span>
<a name="l01660"></a>01660             
<a name="l01661"></a>01661             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(curibuf, fx-minx, fy-miny, fx+minx, fy+miny, texres, imaprepeat, imapextend);
<a name="l01662"></a>01662             val1= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01663"></a>01663             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(curibuf, fx-minx+dxt[0], fy-miny+dxt[1], fx+minx+dxt[0], fy+miny+dxt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01664"></a>01664             val2= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01665"></a>01665             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(curibuf, fx-minx+dyt[0], fy-miny+dyt[1], fx+minx+dyt[0], fy+miny+dyt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01666"></a>01666             val3= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668             <span class="comment">/* don&#39;t switch x or y! */</span>
<a name="l01669"></a>01669             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= (val1-val2);
<a name="l01670"></a>01670             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= (val1-val3);
<a name="l01671"></a>01671             
<a name="l01672"></a>01672             <span class="keywordflow">if</span> (previbuf!=curibuf) {  <span class="comment">/* interpolate */</span>
<a name="l01673"></a>01673                 
<a name="l01674"></a>01674                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(previbuf, fx-minx, fy-miny, fx+minx, fy+miny, &amp;texr, imaprepeat, imapextend);
<a name="l01675"></a>01675                 
<a name="l01676"></a>01676                 <span class="comment">/* calc rgb */</span>
<a name="l01677"></a>01677                 dx= 2.0f*(pixsize-maxd)/pixsize;
<a name="l01678"></a>01678                 <span class="keywordflow">if</span> (dx&gt;=1.0f) {
<a name="l01679"></a>01679                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01680"></a>01680                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01681"></a>01681                 }
<a name="l01682"></a>01682                 <span class="keywordflow">else</span> {
<a name="l01683"></a>01683                     dy= 1.0f-dx;
<a name="l01684"></a>01684                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01685"></a>01685                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l01686"></a>01686                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01687"></a>01687                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01688"></a>01688                 }
<a name="l01689"></a>01689                 
<a name="l01690"></a>01690                 val1= dy*val1+ dx*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01691"></a>01691                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(previbuf, fx-minx+dxt[0], fy-miny+dxt[1], fx+minx+dxt[0], fy+miny+dxt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01692"></a>01692                 val2= dy*val2+ dx*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01693"></a>01693                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(previbuf, fx-minx+dyt[0], fy-miny+dyt[1], fx+minx+dyt[0], fy+miny+dyt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01694"></a>01694                 val3= dy*val3+ dx*(texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01695"></a>01695                 
<a name="l01696"></a>01696                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= (val1-val2);    <span class="comment">/* vals have been interpolated above! */</span>
<a name="l01697"></a>01697                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= (val1-val3);
<a name="l01698"></a>01698                 
<a name="l01699"></a>01699                 <span class="keywordflow">if</span> (dx&lt;1.0f) {
<a name="l01700"></a>01700                     dy= 1.0f-dx;
<a name="l01701"></a>01701                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01702"></a>01702                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l01703"></a>01703                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01704"></a>01704                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= dy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+ dx*texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01705"></a>01705                 }
<a name="l01706"></a>01706             }
<a name="l01707"></a>01707             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]*= bumpscale;
<a name="l01708"></a>01708             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]*= bumpscale;
<a name="l01709"></a>01709         }
<a name="l01710"></a>01710         <span class="keywordflow">else</span> {
<a name="l01711"></a>01711             maxx= fx+minx;
<a name="l01712"></a>01712             minx= fx-minx;
<a name="l01713"></a>01713             maxy= fy+miny;
<a name="l01714"></a>01714             miny= fy-miny;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(curibuf, minx, miny, maxx, maxy, texres, imaprepeat, imapextend);
<a name="l01717"></a>01717 
<a name="l01718"></a>01718             <span class="keywordflow">if</span> (previbuf!=curibuf) {  <span class="comment">/* interpolate */</span>
<a name="l01719"></a>01719                 <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(previbuf, minx, miny, maxx, maxy, &amp;texr, imaprepeat, imapextend);
<a name="l01720"></a>01720                 
<a name="l01721"></a>01721                 fx= 2.0f*(pixsize-maxd)/pixsize;
<a name="l01722"></a>01722                 
<a name="l01723"></a>01723                 <span class="keywordflow">if</span> (fx&gt;=1.0f) {
<a name="l01724"></a>01724                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01725"></a>01725                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01726"></a>01726                 }
<a name="l01727"></a>01727                 <span class="keywordflow">else</span> {
<a name="l01728"></a>01728                     fy= 1.0f-fx;
<a name="l01729"></a>01729                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= fy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>+ fx*texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01730"></a>01730                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= fy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+ fx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l01731"></a>01731                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= fy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+ fx*texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01732"></a>01732                     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= fy*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+ fx*texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01733"></a>01733                 }
<a name="l01734"></a>01734             }
<a name="l01735"></a>01735         }
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737     <span class="keywordflow">else</span> {
<a name="l01738"></a>01738         <span class="keyword">const</span> <span class="keywordtype">int</span> intpol = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee709515cccf026654a5e18043c9522c">TEX_INTERPOL</a>;
<a name="l01739"></a>01739         <span class="keywordflow">if</span> (intpol) {
<a name="l01740"></a>01740             <span class="comment">/* sample 1 pixel minimum */</span>
<a name="l01741"></a>01741             <span class="keywordflow">if</span> (minx &lt; 0.5f / ibuf-&gt;x) minx = 0.5f / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01742"></a>01742             <span class="keywordflow">if</span> (miny &lt; 0.5f / ibuf-&gt;y) miny = 0.5f / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01743"></a>01743         }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>)==0) {
<a name="l01746"></a>01746             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx-minx, fy-miny, fx+minx, fy+miny, texres, imaprepeat, imapextend);
<a name="l01747"></a>01747             val1= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01748"></a>01748             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx-minx+dxt[0], fy-miny+dxt[1], fx+minx+dxt[0], fy+miny+dxt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01749"></a>01749             val2= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01750"></a>01750             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx-minx+dyt[0], fy-miny+dyt[1], fx+minx+dyt[0], fy+miny+dyt[1], &amp;texr, imaprepeat, imapextend);
<a name="l01751"></a>01751             val3= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753             <span class="comment">/* don&#39;t switch x or y! */</span>
<a name="l01754"></a>01754             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= (val1-val2);
<a name="l01755"></a>01755             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= (val1-val3);
<a name="l01756"></a>01756         }
<a name="l01757"></a>01757         <span class="keywordflow">else</span>
<a name="l01758"></a>01758             <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx-minx, fy-miny, fx+minx, fy+miny, texres, imaprepeat, imapextend);
<a name="l01759"></a>01759     }
<a name="l01760"></a>01760     
<a name="l01761"></a>01761     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7145956ea80499f8e2eae6be19f608dd">TEX_CALCALPHA</a>) {
<a name="l01762"></a>01762         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*<a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764     <span class="keywordflow">else</span> texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9ddd149ad6bb398568d6d8f00f756cf7">TEX_NEGALPHA</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 1.0f-texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01767"></a>01767     
<a name="l01768"></a>01768     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) ) {
<a name="l01769"></a>01769         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>-= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>)) {
<a name="l01773"></a>01773         <span class="comment">// qdn: normal from color</span>
<a name="l01774"></a>01774         <span class="comment">// The invert of the red channel is to make</span>
<a name="l01775"></a>01775         <span class="comment">// the normal map compliant with the outside world.</span>
<a name="l01776"></a>01776         <span class="comment">// It needs to be done because in Blender</span>
<a name="l01777"></a>01777         <span class="comment">// the normal used in the renderer points inward. It is generated</span>
<a name="l01778"></a>01778         <span class="comment">// this way in calc_vertexnormals(). Should this ever change</span>
<a name="l01779"></a>01779         <span class="comment">// this negate must be removed.</span>
<a name="l01780"></a>01780         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = -2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> - 0.5f);
<a name="l01781"></a>01781         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> - 0.5f);
<a name="l01782"></a>01782         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = 2.f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> - 0.5f);
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784     
<a name="l01785"></a>01785     <span class="comment">/* de-premul, this is being premulled in shade_input_do_shade() */</span>
<a name="l01786"></a>01786     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>!=1.0f &amp;&amp; texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>&gt;1e-4f) {
<a name="l01787"></a>01787         fx= 1.0f/texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01788"></a>01788         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*= fx;
<a name="l01789"></a>01789         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*= fx;
<a name="l01790"></a>01790         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*= fx;
<a name="l01791"></a>01791     }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793     <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l01794"></a>01794     
<a name="l01795"></a>01795     <span class="keywordflow">return</span> retval;
<a name="l01796"></a>01796 }
<a name="l01797"></a>01797 
<a name="l01798"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#a5b2ebfee3e47771ed0ff58e9300f7df2">01798</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#a7bf9fc817bf87173073e61b2cd25faac">image_sample</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <span class="keywordtype">float</span> dx, <span class="keywordtype">float</span> dy, <span class="keywordtype">float</span> *result)
<a name="l01799"></a>01799 {
<a name="l01800"></a>01800     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres;
<a name="l01801"></a>01801     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01802"></a>01802     
<a name="l01803"></a>01803     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01804"></a>01804         result[0]= result[1]= result[2]= result[3]= 0.0f;
<a name="l01805"></a>01805         <span class="keywordflow">return</span>;
<a name="l01806"></a>01806     }
<a name="l01807"></a>01807     
<a name="l01808"></a>01808     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) )
<a name="l01809"></a>01809         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>+= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     texres.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= 1; <span class="comment">/* boxsample expects to be initialized */</span>
<a name="l01812"></a>01812     <a class="code" href="../../dc/d58/imagetexture_8c.html#a53019a8930c5ab058165074d2ab34c73">boxsample</a>(ibuf, fx, fy, fx+dx, fy+dy, &amp;texres, 0, 1);
<a name="l01813"></a>01813     result[0]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01814"></a>01814     result[1]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l01815"></a>01815     result[2]= texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01816"></a>01816     result[3]= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01817"></a>01817     
<a name="l01818"></a>01818     <span class="keywordflow">if</span> ( (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.flag &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>) &amp;&amp; (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) )
<a name="l01819"></a>01819         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>-= (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a>|= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ab59b18637a0194b0f6e0b89a1ffdb474">IMA_USED_FOR_RENDER</a>;
<a name="l01822"></a>01822 }
<a name="l01823"></a>01823 
<a name="l01824"></a><a class="code" href="../../dc/d58/imagetexture_8c.html#ae299655ff316de97fb85fbcc839b3107">01824</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a9a91199a86fb78cba3f16c8efeda9a5a">ibuf_sample</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <span class="keywordtype">float</span> dx, <span class="keywordtype">float</span> dy, <span class="keywordtype">float</span> *result)
<a name="l01825"></a>01825 {
<a name="l01826"></a>01826     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres;
<a name="l01827"></a>01827     <a class="code" href="../../d8/d70/structafdata__t.html">afdata_t</a> AFD;
<a name="l01828"></a>01828     
<a name="l01829"></a>01829     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01830"></a>01830         <span class="keywordflow">return</span>;
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832     
<a name="l01833"></a>01833     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[0] = dx; AFD.<a class="code" href="../../d8/d70/structafdata__t.html#af0407ca81114ed6afcef88160cd40c5b">dxt</a>[1] = dx;
<a name="l01834"></a>01834     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[0] = dy; AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a9311a39eb328e4b9da1c2347fc3931ac">dyt</a>[1] = dy;
<a name="l01835"></a>01835     <span class="comment">//copy_v2_v2(AFD.dxt, dx);</span>
<a name="l01836"></a>01836     <span class="comment">//copy_v2_v2(AFD.dyt, dy);</span>
<a name="l01837"></a>01837     
<a name="l01838"></a>01838     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#a2dafe042fe7b63369dfb8676374e4951">intpol</a> = 1;
<a name="l01839"></a>01839     AFD.<a class="code" href="../../d8/d70/structafdata__t.html#aa0754d42056419cabbe561886a2ef176">extflag</a> = <a class="code" href="../../dc/d58/imagetexture_8c.html#abc1a2abf1bf92c4036064143db1c8210adafc7a09eb6cb5fe4ca28a2fae43fb5f">TXC_EXTD</a>;
<a name="l01840"></a>01840     
<a name="l01841"></a>01841     memset(&amp;texres, 0, <span class="keyword">sizeof</span>(texres));
<a name="l01842"></a>01842     <a class="code" href="../../dc/d58/imagetexture_8c.html#a92263b7b602995e56d07eca88dc26a63">ewa_eval</a>(&amp;texres, ibuf, fx, fy, &amp;AFD);
<a name="l01843"></a>01843     
<a name="l01844"></a>01844     
<a name="l01845"></a>01845     result[0]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l01846"></a>01846     result[1]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l01847"></a>01847     result[2]= texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l01848"></a>01848     result[3]= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l01849"></a>01849 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:24 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
