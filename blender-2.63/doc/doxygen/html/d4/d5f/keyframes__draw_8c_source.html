<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: keyframes_draw.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">keyframes_draw.c</div>  </div>
</div>
<div class="contents">
<a href="../../d4/d5f/keyframes__draw_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2009 Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Joshua Leung (full recode)</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="comment">/* System includes ----------------------------------------------------- */</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d11/BLI__dlrbTree_8h.html">BLI_dlrbTree.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d40/DNA__meta__types_8h.html">DNA_meta_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html">DNA_particle_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../da/de4/DNA__speaker__types_8h.html">DNA_speaker_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3b/DNA__world__types_8h.html">DNA_world_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html">DNA_gpencil_types.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>     <span class="comment">// XXX remove me!</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d6f/ED__anim__api_8h.html">ED_anim_api.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html">ED_keyframes_draw.h</a>&quot;</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/* *************************** Keyframe Processing *************************** */</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">/* ActKeyColumns (Keyframe Columns) ------------------------------------------ */</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* Comparator callback used for ActKeyColumns and cframe float-value pointer */</span>
<a name="l00082"></a>00082 <span class="comment">/* NOTE: this is exported to other modules that use the ActKeyColumns for finding keyframes */</span>
<a name="l00083"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a8c8eb077f4beaf1835776f05ca3a307f">00083</a> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a8c8eb077f4beaf1835776f05ca3a307f">compare_ak_cfraPtr</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)node;
<a name="l00086"></a>00086     <span class="keywordtype">float</span> *cframe= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00087"></a>00087     
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (*cframe &lt; ak-&gt;cfra)
<a name="l00089"></a>00089         <span class="keywordflow">return</span> -1;
<a name="l00090"></a>00090     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*cframe &gt; ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>)
<a name="l00091"></a>00091         <span class="keywordflow">return</span> 1;
<a name="l00092"></a>00092     <span class="keywordflow">else</span>
<a name="l00093"></a>00093         <span class="keywordflow">return</span> 0;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">/* --------------- */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">/* Comparator callback used for ActKeyColumns and BezTriple */</span>
<a name="l00099"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aabd1159dc96790ad36a6657f69d817eb">00099</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aabd1159dc96790ad36a6657f69d817eb">compare_ak_bezt</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)node;
<a name="l00102"></a>00102     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00103"></a>00103     
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &lt; ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>)
<a name="l00105"></a>00105         <span class="keywordflow">return</span> -1;
<a name="l00106"></a>00106     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt; ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>)
<a name="l00107"></a>00107         <span class="keywordflow">return</span> 1;
<a name="l00108"></a>00108     <span class="keywordflow">else</span>
<a name="l00109"></a>00109         <span class="keywordflow">return</span> 0;
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="comment">/* New node callback used for building ActKeyColumns from BezTriples */</span>
<a name="l00113"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aa5a6d712fab1e2b3967d245b273788a7">00113</a> <span class="keyword">static</span> <a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aa5a6d712fab1e2b3967d245b273788a7">nalloc_ak_bezt</a> (<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a>), <span class="stringliteral">&quot;ActKeyColumn&quot;</span>);
<a name="l00116"></a>00116     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <span class="comment">/* store settings based on state of BezTriple */</span>
<a name="l00119"></a>00119     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00120"></a>00120     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae0e362d9d2085f24862a18e71db6419c">sel</a>= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(bezt) ? <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a> : 0;
<a name="l00121"></a>00121     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a0acccfd340916ffe26af2400a22e2f61">key_type</a>= <a class="code" href="../../df/d6f/ED__anim__api_8h.html#ad3cf875682066b37d752bb1b50e6c288">BEZKEYTYPE</a>(bezt); 
<a name="l00122"></a>00122     
<a name="l00123"></a>00123     <span class="comment">/* set &#39;modified&#39;, since this is used to identify long keyframes */</span>
<a name="l00124"></a>00124     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a> = 1;
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     <span class="keywordflow">return</span> (<a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *)ak;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/* Node updater callback used for building ActKeyColumns from BezTriples */</span>
<a name="l00130"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9db9fc6a3c9ab9885defaf4b6cde4b77">00130</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9db9fc6a3c9ab9885defaf4b6cde4b77">nupdate_ak_bezt</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)node;
<a name="l00133"></a>00133     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     <span class="comment">/* set selection status and &#39;touched&#39; status */</span>
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(bezt)) ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae0e362d9d2085f24862a18e71db6419c">sel</a> = <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l00137"></a>00137     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a> += 1;
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     <span class="comment">/* for keyframe type, &#39;proper&#39; keyframes have priority over breakdowns (and other types for now) */</span>
<a name="l00140"></a>00140     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../df/d6f/ED__anim__api_8h.html#ad3cf875682066b37d752bb1b50e6c288">BEZKEYTYPE</a>(bezt) == <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335cad5591000922bff58bafed40c0ab9a6e5">BEZT_KEYTYPE_KEYFRAME</a>)
<a name="l00141"></a>00141         ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a0acccfd340916ffe26af2400a22e2f61">key_type</a>= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335cad5591000922bff58bafed40c0ab9a6e5">BEZT_KEYTYPE_KEYFRAME</a>;
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment">/* ......... */</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">/* Comparator callback used for ActKeyColumns and GPencil frame */</span>
<a name="l00147"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a63d8cf461829893e7587fc98a8094dde">00147</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a63d8cf461829893e7587fc98a8094dde">compare_ak_gpframe</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)node;
<a name="l00150"></a>00150     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf= (<a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *)data;
<a name="l00151"></a>00151     
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#afec3bb15ee1286d1d6e299b682b0c069">framenum</a> &lt; ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>)
<a name="l00153"></a>00153         <span class="keywordflow">return</span> -1;
<a name="l00154"></a>00154     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#afec3bb15ee1286d1d6e299b682b0c069">framenum</a> &gt; ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>)
<a name="l00155"></a>00155         <span class="keywordflow">return</span> 1;
<a name="l00156"></a>00156     <span class="keywordflow">else</span>
<a name="l00157"></a>00157         <span class="keywordflow">return</span> 0;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="comment">/* New node callback used for building ActKeyColumns from GPencil frames */</span>
<a name="l00161"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a518156067a7a105ed93c08b967de453b">00161</a> <span class="keyword">static</span> <a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a518156067a7a105ed93c08b967de453b">nalloc_ak_gpframe</a> (<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a>), <span class="stringliteral">&quot;ActKeyColumnGPF&quot;</span>);
<a name="l00164"></a>00164     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf= (<a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *)data;
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     <span class="comment">/* store settings based on state of BezTriple */</span>
<a name="l00167"></a>00167     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>= gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#afec3bb15ee1286d1d6e299b682b0c069">framenum</a>;
<a name="l00168"></a>00168     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae0e362d9d2085f24862a18e71db6419c">sel</a>= (gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#ab649348d35f3a7e3b0c4942ccfee5c1f">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a3695c80f17948e3917a7e1446f4600ff">GP_FRAME_SELECT</a>) ? <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a> : 0;
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     <span class="comment">/* set &#39;modified&#39;, since this is used to identify long keyframes */</span>
<a name="l00171"></a>00171     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a> = 1;
<a name="l00172"></a>00172     
<a name="l00173"></a>00173     <span class="keywordflow">return</span> (<a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *)ak;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">/* Node updater callback used for building ActKeyColumns from GPencil frames */</span>
<a name="l00177"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a6a5cba34196f7ddb590332408be8dfd1">00177</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a6a5cba34196f7ddb590332408be8dfd1">nupdate_ak_gpframe</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)node;
<a name="l00180"></a>00180     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf= (<a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *)data;
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <span class="comment">/* set selection status and &#39;touched&#39; status */</span>
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#ab649348d35f3a7e3b0c4942ccfee5c1f">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a3695c80f17948e3917a7e1446f4600ff">GP_FRAME_SELECT</a>) ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae0e362d9d2085f24862a18e71db6419c">sel</a> = <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l00184"></a>00184     ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a> += 1;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">/* --------------- */</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">/* Add the given BezTriple to the given &#39;list&#39; of Keyframes */</span>
<a name="l00190"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a136e8141709a92802ff5ba4b3c07b55b">00190</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a136e8141709a92802ff5ba4b3c07b55b">add_bezt_to_keycolumns_list</a>(<a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, keys, bezt))
<a name="l00193"></a>00193         <span class="keywordflow">return</span>;
<a name="l00194"></a>00194     <span class="keywordflow">else</span>
<a name="l00195"></a>00195         <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a5dcc1fe38a7b2a3bfefee1eadd8d84bb">BLI_dlrbTree_add</a>(keys, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aabd1159dc96790ad36a6657f69d817eb">compare_ak_bezt</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aa5a6d712fab1e2b3967d245b273788a7">nalloc_ak_bezt</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9db9fc6a3c9ab9885defaf4b6cde4b77">nupdate_ak_bezt</a>, bezt);
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="comment">/* Add the given GPencil Frame to the given &#39;list&#39; of Keyframes */</span>
<a name="l00199"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a34bf87e7f253d89266b0c1bb29450862">00199</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a34bf87e7f253d89266b0c1bb29450862">add_gpframe_to_keycolumns_list</a>(<a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, keys, gpf))
<a name="l00202"></a>00202         <span class="keywordflow">return</span>;
<a name="l00203"></a>00203     <span class="keywordflow">else</span>
<a name="l00204"></a>00204         <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a5dcc1fe38a7b2a3bfefee1eadd8d84bb">BLI_dlrbTree_add</a>(keys, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a63d8cf461829893e7587fc98a8094dde">compare_ak_gpframe</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a518156067a7a105ed93c08b967de453b">nalloc_ak_gpframe</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a6a5cba34196f7ddb590332408be8dfd1">nupdate_ak_gpframe</a>, gpf);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">/* ActBeztColumns (Helpers for Long Keyframes) ------------------------------ */</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">/* maximum size of default buffer for BezTriple columns */</span>
<a name="l00210"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9c7fecca7bc5f48de8598fea6bb05d3c">00210</a> <span class="preprocessor">#define MAX_ABK_BUFSIZE     4</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>
<a name="l00212"></a>00212 <span class="comment">/* BezTriple Container Node */</span>
<a name="l00213"></a>00213 <span class="comment">// NOTE: only used internally while building Long Keyframes for now, but may be useful externally?</span>
<a name="l00214"></a><a class="code" href="../../d5/db2/structActBeztColumn.html">00214</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> {
<a name="l00215"></a>00215     <span class="comment">/* Tree Node interface ---------------- */</span>
<a name="l00216"></a>00216         <span class="comment">/* ListBase linkage */</span>
<a name="l00217"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#acb52a8a103376aec5881e01830eabee3">00217</a>     <span class="keyword">struct </span><a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#a520c1b01a9275ea7c36b3f4f7ee8d087">next</a>, *<a class="code" href="../../d5/db2/structActBeztColumn.html#acb52a8a103376aec5881e01830eabee3">prev</a>;
<a name="l00218"></a>00218     
<a name="l00219"></a>00219         <span class="comment">/* sorting-tree linkage */</span>
<a name="l00220"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#ab9e939c6d19220b31777444e795ecead">00220</a>     <span class="keyword">struct </span><a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#a6cc790d58dd59eae82f606f53ea49e1e">left</a>, *<a class="code" href="../../d5/db2/structActBeztColumn.html#ab9e939c6d19220b31777444e795ecead">right</a>; <span class="comment">/* &#39;children&#39; of this node, less than and greater than it (respectively) */</span>
<a name="l00221"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#a4c0604d754d0aeb61ae093e3b78c952a">00221</a>     <span class="keyword">struct </span><a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#a4c0604d754d0aeb61ae093e3b78c952a">parent</a>;       <span class="comment">/* parent of this node in the tree */</span>
<a name="l00222"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#aa70d69ec05b015c75af3578beb2330b3">00222</a>     <span class="keywordtype">char</span> <a class="code" href="../../d5/db2/structActBeztColumn.html#aa70d69ec05b015c75af3578beb2330b3">tree_col</a>;                      <span class="comment">/* DLRB_BLACK or DLRB_RED */</span>
<a name="l00223"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#a5e00b6d13c2b9ed93a326d4b17f8756f">00223</a>     <span class="keywordtype">char</span> <a class="code" href="../../d5/db2/structActBeztColumn.html#a5e00b6d13c2b9ed93a326d4b17f8756f">pad</a>;
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     <span class="comment">/* BezTriple Store -------------------- */</span>
<a name="l00226"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">00226</a>     <span class="keywordtype">short</span> <a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">numBezts</a>;                     <span class="comment">/* number of BezTriples on this frame */</span>
<a name="l00227"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#a261295b0afb8d92a9511838ec089d194">00227</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/db2/structActBeztColumn.html#a261295b0afb8d92a9511838ec089d194">cfra</a>;                         <span class="comment">/* frame that the BezTriples occur on */</span>
<a name="l00228"></a>00228     
<a name="l00229"></a><a class="code" href="../../d5/db2/structActBeztColumn.html#abbef721563a71adeff41ed0642dff01e">00229</a>     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#abbef721563a71adeff41ed0642dff01e">bezts</a>[<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9c7fecca7bc5f48de8598fea6bb05d3c">MAX_ABK_BUFSIZE</a>];  <span class="comment">/* buffer of pointers to BezTriples on the same frame */</span>
<a name="l00230"></a>00230     <span class="comment">//BezTriple **bezts_extra;          /* secondary buffer of pointers if need be */</span>
<a name="l00231"></a>00231 } <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9f98cb9ccbebf3d6622270269baf8ccb">ActBeztColumn</a>;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">/* --------------- */</span>
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="comment">/* Comparator callback used for ActBeztColumns and BezTriple */</span>
<a name="l00236"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac46ad1d973ecaf95757d11e545b587e2">00236</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac46ad1d973ecaf95757d11e545b587e2">compare_abk_bezt</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *abk= (<a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *)node;
<a name="l00239"></a>00239     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00240"></a>00240     
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &lt; abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a261295b0afb8d92a9511838ec089d194">cfra</a>)
<a name="l00242"></a>00242         <span class="keywordflow">return</span> -1;
<a name="l00243"></a>00243     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt; abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a261295b0afb8d92a9511838ec089d194">cfra</a>)
<a name="l00244"></a>00244         <span class="keywordflow">return</span> 1;
<a name="l00245"></a>00245     <span class="keywordflow">else</span>
<a name="l00246"></a>00246         <span class="keywordflow">return</span> 0;
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="comment">/* New node callback used for building ActBeztColumns from BezTriples */</span>
<a name="l00250"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a629c91e09f549f34ed79dc7f8a34c995">00250</a> <span class="keyword">static</span> <a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a629c91e09f549f34ed79dc7f8a34c995">nalloc_abk_bezt</a> (<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *abk= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a>), <span class="stringliteral">&quot;ActKeyColumn&quot;</span>);
<a name="l00253"></a>00253     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00254"></a>00254     
<a name="l00255"></a>00255     <span class="comment">/* store the BeztTriple in the buffer, and keep track of its frame number */</span>
<a name="l00256"></a>00256     abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a261295b0afb8d92a9511838ec089d194">cfra</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00257"></a>00257     abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#abbef721563a71adeff41ed0642dff01e">bezts</a>[abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">numBezts</a>++]= bezt;
<a name="l00258"></a>00258     
<a name="l00259"></a>00259     <span class="keywordflow">return</span> (<a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *)abk;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">/* Node updater callback used for building ActBeztColumns from BezTriples */</span>
<a name="l00263"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a67f221e6a4eb96863bd5434e29d7ce3b">00263</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a67f221e6a4eb96863bd5434e29d7ce3b">nupdate_abk_bezt</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265     <a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *abk= (<a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *)node;
<a name="l00266"></a>00266     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt= (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *)data;
<a name="l00267"></a>00267     
<a name="l00268"></a>00268     <span class="comment">/* just add the BezTriple to the buffer if there&#39;s space, or allocate a new one */</span>
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">numBezts</a> &gt;= <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9c7fecca7bc5f48de8598fea6bb05d3c">MAX_ABK_BUFSIZE</a>) {
<a name="l00270"></a>00270         <span class="comment">// TODO: need to allocate new array to cater...</span>
<a name="l00271"></a>00271         <span class="comment">//bezts_extra= MEM_callocN(...);</span>
<a name="l00272"></a>00272         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00273"></a>00273             printf(<span class="stringliteral">&quot;FIXME: nupdate_abk_bezt() missing case for too many overlapping BezTriples\n&quot;</span>);
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     <span class="keywordflow">else</span> {
<a name="l00276"></a>00276         <span class="comment">/* just store an extra one */</span>
<a name="l00277"></a>00277         abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#abbef721563a71adeff41ed0642dff01e">bezts</a>[abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">numBezts</a>++]= bezt;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">/* --------------- */</span>
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 <span class="comment">/* Return the BezTriple in the given ActBeztColumn that matches the requested value */</span>
<a name="l00284"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a4b7fc2ec1a9eaae81a026ef6b83ac3d7">00284</a> <span class="keyword">static</span> <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a4b7fc2ec1a9eaae81a026ef6b83ac3d7">abk_get_bezt_with_value</a> (<a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *abk, <span class="keywordtype">float</span> value)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00287"></a>00287     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     <span class="comment">/* sanity checks */</span>
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (abk == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00291"></a>00291         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     <span class="comment">/* look over each BezTriple in this container */</span>
<a name="l00294"></a>00294     <span class="keywordflow">for</span> (i = 0; i &lt; abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#a95db9fab0a52e7d53ceab9b532917a22">numBezts</a>; i++) {       
<a name="l00295"></a>00295         <span class="comment">/* only do exact match for now... */</span>
<a name="l00296"></a>00296         <span class="keywordflow">if</span> (<span class="comment">/*i &gt;= MAX_ABK_BUFSIZE*/</span>0) {
<a name="l00297"></a>00297             <span class="comment">// TODO: this case needs special handling</span>
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299         <span class="keywordflow">else</span> {
<a name="l00300"></a>00300             <span class="comment">/* just use the default buffer */</span>
<a name="l00301"></a>00301             bezt= abk-&gt;<a class="code" href="../../d5/db2/structActBeztColumn.html#abbef721563a71adeff41ed0642dff01e">bezts</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00302"></a>00302             
<a name="l00303"></a>00303             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] == value)
<a name="l00304"></a>00304                 <span class="keywordflow">return</span> bezt;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     
<a name="l00308"></a>00308     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="comment">/* ActKeyBlocks (Long Keyframes) ------------------------------------------ */</span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="comment">/* Comparator callback used for ActKeyBlock and cframe float-value pointer */</span>
<a name="l00314"></a>00314 <span class="comment">/* NOTE: this is exported to other modules that use the ActKeyBlocks for finding long-keyframes */</span>
<a name="l00315"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#aa7e834ffee9a385f522fb3322fbafacb">00315</a> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aa7e834ffee9a385f522fb3322fbafacb">compare_ab_cfraPtr</a> (<span class="keywordtype">void</span> *node, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab= (<a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *)node;
<a name="l00318"></a>00318     <span class="keywordtype">float</span> *cframe= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00319"></a>00319     
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (*cframe &lt; ab-&gt;start)
<a name="l00321"></a>00321         <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*cframe &gt; ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a>)
<a name="l00323"></a>00323         <span class="keywordflow">return</span> 1;
<a name="l00324"></a>00324     <span class="keywordflow">else</span>
<a name="l00325"></a>00325         <span class="keywordflow">return</span> 0;
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">/* --------------- */</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">/* Create a ActKeyColumn for a pair of BezTriples */</span>
<a name="l00331"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a478d3fef3bc30b1b2c2d21501c17abe4">00331</a> <span class="keyword">static</span> <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a478d3fef3bc30b1b2c2d21501c17abe4">bezts_to_new_actkeyblock</a>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#acb52a8a103376aec5881e01830eabee3">prev</a>, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *beztn)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a>), <span class="stringliteral">&quot;ActKeyBlock&quot;</span>);
<a name="l00334"></a>00334     
<a name="l00335"></a>00335     ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a>= prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00336"></a>00336     ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a13a12577d6f6a70b54f8913254204f61">end</a>= beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00337"></a>00337     ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a47f9715fbd4519befdc0f9dde729539d">val</a>= beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#aa7f5e9d9534d142d2eb7b4cc3a8352e1">sel</a>= (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(prev) || <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(beztn)) ? <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a> : 0;
<a name="l00340"></a>00340     ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a23c55f9ca90ede6fbf2870ad87b7ebc8">modified</a> = 1;
<a name="l00341"></a>00341     
<a name="l00342"></a>00342     <span class="keywordflow">return</span> ab;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a1eeef078439a4122e1e3fd013f957823">00345</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a1eeef078439a4122e1e3fd013f957823">add_bezt_to_keyblocks_list</a>(<a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *beztTree, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *beztn)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *new_ab= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00348"></a>00348     <a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *abk;
<a name="l00349"></a>00349     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d5/db2/structActBeztColumn.html#acb52a8a103376aec5881e01830eabee3">prev</a>;
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     <span class="comment">/* get the BezTriple immediately before the given one which has the same value */</span>
<a name="l00352"></a>00352         <span class="comment">/* the keyframes immediately before the ones containing the specified keyframe */</span>
<a name="l00353"></a>00353     abk= (<a class="code" href="../../d5/db2/structActBeztColumn.html">ActBeztColumn</a> *)<a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#afff10808c3fc68c746cff8553b087f19">BLI_dlrbTree_search_prev</a>(beztTree, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac46ad1d973ecaf95757d11e545b587e2">compare_abk_bezt</a>, beztn);
<a name="l00354"></a>00354         <span class="comment">/* if applicable, the BezTriple with the same value */</span>
<a name="l00355"></a>00355     prev= (abk) ? <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a4b7fc2ec1a9eaae81a026ef6b83ac3d7">abk_get_bezt_with_value</a>(abk, beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1]) : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00356"></a>00356     
<a name="l00357"></a>00357     <span class="comment">/* check if block needed - same value(s)?</span>
<a name="l00358"></a>00358 <span class="comment">     *  -&gt; firstly, handles must have same central value as each other</span>
<a name="l00359"></a>00359 <span class="comment">     *  -&gt; secondly, handles which control that section of the curve must be constant</span>
<a name="l00360"></a>00360 <span class="comment">     */</span>
<a name="l00361"></a>00361     <span class="keywordflow">if</span> ((!prev) || (!beztn)) <span class="keywordflow">return</span>;
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1], prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1])==0) <span class="keywordflow">return</span>;
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1], beztn-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1])==0) <span class="keywordflow">return</span>;
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1], prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1])==0) <span class="keywordflow">return</span>;
<a name="l00365"></a>00365     
<a name="l00366"></a>00366     
<a name="l00367"></a>00367     <span class="comment">/* if there are no blocks already, just add as root */</span>
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (blocks-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ac6e167ec21709b3b24aa0d47f74fdf3f">root</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00369"></a>00369         <span class="comment">/* just add this as the root, then call the tree-balancing functions to validate */</span>
<a name="l00370"></a>00370         new_ab= <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a478d3fef3bc30b1b2c2d21501c17abe4">bezts_to_new_actkeyblock</a>(prev, beztn);
<a name="l00371"></a>00371         blocks-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ac6e167ec21709b3b24aa0d47f74fdf3f">root</a>= (<a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *)new_ab;
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373     <span class="keywordflow">else</span> {
<a name="l00374"></a>00374         <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab, *abn=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00375"></a>00375         
<a name="l00376"></a>00376         <span class="comment">/* try to find a keyblock that starts on the previous beztriple, and add a new one if none start there</span>
<a name="l00377"></a>00377 <span class="comment">         * Note: we can&#39;t search from end to try to optimize this as it causes errors there&#39;s</span>
<a name="l00378"></a>00378 <span class="comment">         *      an A ___ B |---| B situation</span>
<a name="l00379"></a>00379 <span class="comment">         */</span>
<a name="l00380"></a>00380         <span class="comment">// FIXME: here there is a bug where we are trying to get the summary for the following channels</span>
<a name="l00381"></a>00381         <span class="comment">//      A|--------------|A ______________ B|--------------|B</span>
<a name="l00382"></a>00382         <span class="comment">//      A|------------------------------------------------|A</span>
<a name="l00383"></a>00383         <span class="comment">//      A|----|A|---|A|-----------------------------------|A</span>
<a name="l00384"></a>00384         <span class="keywordflow">for</span> (ab= blocks-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ac6e167ec21709b3b24aa0d47f74fdf3f">root</a>; ab; ab= abn) {
<a name="l00385"></a>00385             <span class="comment">/* check if this is a match, or whether we go left or right */</span>
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a> == prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) {
<a name="l00387"></a>00387                 <span class="comment">/* set selection status and &#39;touched&#39; status */</span>
<a name="l00388"></a>00388                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(beztn)) ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#aa7f5e9d9534d142d2eb7b4cc3a8352e1">sel</a> = <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l00389"></a>00389                 ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a23c55f9ca90ede6fbf2870ad87b7ebc8">modified</a> += 1;
<a name="l00390"></a>00390                 
<a name="l00391"></a>00391                 <span class="comment">/* done... no need to insert */</span>
<a name="l00392"></a>00392                 <span class="keywordflow">return</span>;
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394             <span class="keywordflow">else</span> {
<a name="l00395"></a>00395                 <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> **abnp= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; 
<a name="l00396"></a>00396                 
<a name="l00397"></a>00397                 <span class="comment">/* check if go left or right, but if not available, add new node */</span>
<a name="l00398"></a>00398                 <span class="keywordflow">if</span> (ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a> &lt; prev-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) 
<a name="l00399"></a>00399                     abnp= &amp;ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a67cd136a741fa64fad38f44583ac68ac">right</a>;
<a name="l00400"></a>00400                 <span class="keywordflow">else</span>
<a name="l00401"></a>00401                     abnp= &amp;ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a9cdb68cf1dd980fd8731c424cc98f4d2">left</a>;
<a name="l00402"></a>00402                     
<a name="l00403"></a>00403                 <span class="comment">/* if this does not exist, add a new node, otherwise continue... */</span>
<a name="l00404"></a>00404                 <span class="keywordflow">if</span> (*abnp == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00405"></a>00405                     <span class="comment">/* add a new node representing this, and attach it to the relevant place */</span>
<a name="l00406"></a>00406                     new_ab= <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a478d3fef3bc30b1b2c2d21501c17abe4">bezts_to_new_actkeyblock</a>(prev, beztn);
<a name="l00407"></a>00407                     new_ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a805947702d966741de07784c3961d1e5">parent</a>= ab;
<a name="l00408"></a>00408                     *abnp= new_ab;
<a name="l00409"></a>00409                     <span class="keywordflow">break</span>;
<a name="l00410"></a>00410                 }
<a name="l00411"></a>00411                 <span class="keywordflow">else</span>
<a name="l00412"></a>00412                     abn= *abnp;
<a name="l00413"></a>00413             }
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415     }
<a name="l00416"></a>00416     
<a name="l00417"></a>00417     <span class="comment">/* now, balance the tree taking into account this newly added node */</span>
<a name="l00418"></a>00418     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#ab7c6392d5ac06c519e15d5d65b255c13">BLI_dlrbTree_insert</a>(blocks, (<a class="code" href="../../da/db6/structDLRBT__Node.html">DLRBT_Node</a> *)new_ab);
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="comment">/* --------- */</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="comment">/* Handle the &#39;touched&#39; status of ActKeyColumn tree nodes */</span>
<a name="l00424"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aea1f249da6da2f36f101e49a5d2b3166">00424</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aea1f249da6da2f36f101e49a5d2b3166">set_touched_actkeycolumn</a> (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <span class="comment">/* sanity check */</span>
<a name="l00427"></a>00427     <span class="keywordflow">if</span> (ak == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00428"></a>00428         <span class="keywordflow">return</span>;
<a name="l00429"></a>00429         
<a name="l00430"></a>00430     <span class="comment">/* deal with self first */</span>
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a>) {
<a name="l00432"></a>00432         ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae9b092ba91502456f7b163b8878d3e3b">modified</a>= 0;
<a name="l00433"></a>00433         ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ad42a3cd43800de1225cbe8e43e89fb48">totcurve</a>++;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435     
<a name="l00436"></a>00436     <span class="comment">/* children */</span>
<a name="l00437"></a>00437     <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aea1f249da6da2f36f101e49a5d2b3166">set_touched_actkeycolumn</a>(ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a5b61d6f0aa7d4661cb947242375cf7b6">left</a>);
<a name="l00438"></a>00438     <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aea1f249da6da2f36f101e49a5d2b3166">set_touched_actkeycolumn</a>(ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a63326d0167f1a121d9e39691f042fed7">right</a>);
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="comment">/* Handle the &#39;touched&#39; status of ActKeyBlock tree nodes */</span>
<a name="l00442"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#abcd12f4a6a7830135b525ea84dba5359">00442</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#abcd12f4a6a7830135b525ea84dba5359">set_touched_actkeyblock</a> (<a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444     <span class="comment">/* sanity check */</span>
<a name="l00445"></a>00445     <span class="keywordflow">if</span> (ab == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00446"></a>00446         <span class="keywordflow">return</span>;
<a name="l00447"></a>00447         
<a name="l00448"></a>00448     <span class="comment">/* deal with self first */</span>
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a23c55f9ca90ede6fbf2870ad87b7ebc8">modified</a>) {
<a name="l00450"></a>00450         ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a23c55f9ca90ede6fbf2870ad87b7ebc8">modified</a>= 0;
<a name="l00451"></a>00451         ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a8a9576474b95d4194cc95e3cb505cb47">totcurve</a>++;
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453     
<a name="l00454"></a>00454     <span class="comment">/* children */</span>
<a name="l00455"></a>00455     <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#abcd12f4a6a7830135b525ea84dba5359">set_touched_actkeyblock</a>(ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a9cdb68cf1dd980fd8731c424cc98f4d2">left</a>);
<a name="l00456"></a>00456     <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#abcd12f4a6a7830135b525ea84dba5359">set_touched_actkeyblock</a>(ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a67cd136a741fa64fad38f44583ac68ac">right</a>);
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">/* --------- */</span>
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="comment">/* Checks if ActKeyBlock should exist... */</span>
<a name="l00462"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a4a38a3b6aeba25ffb7601fa62441427e">00462</a> <span class="keywordtype">short</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac841bb30199e008827d630982f220ce1">actkeyblock_is_valid</a> (<a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak;
<a name="l00465"></a>00465     <span class="keywordtype">short</span> startCurves, endCurves, totCurves;
<a name="l00466"></a>00466     
<a name="l00467"></a>00467     <span class="comment">/* check that block is valid */</span>
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (ab == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00469"></a>00469         <span class="keywordflow">return</span> 0;
<a name="l00470"></a>00470     
<a name="l00471"></a>00471     <span class="comment">/* find out how many curves occur at each keyframe */</span>
<a name="l00472"></a>00472     ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)<a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#ae03440d04a6c42f07849f3a17059ef65">BLI_dlrbTree_search_exact</a>(keys, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a8c8eb077f4beaf1835776f05ca3a307f">compare_ak_cfraPtr</a>, &amp;ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a>);
<a name="l00473"></a>00473     startCurves = (ak)? ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ad42a3cd43800de1225cbe8e43e89fb48">totcurve</a>: 0;
<a name="l00474"></a>00474     
<a name="l00475"></a>00475     ak= (<a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *)<a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#ae03440d04a6c42f07849f3a17059ef65">BLI_dlrbTree_search_exact</a>(keys, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a8c8eb077f4beaf1835776f05ca3a307f">compare_ak_cfraPtr</a>, &amp;ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a13a12577d6f6a70b54f8913254204f61">end</a>);
<a name="l00476"></a>00476     endCurves = (ak)? ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ad42a3cd43800de1225cbe8e43e89fb48">totcurve</a>: 0;
<a name="l00477"></a>00477     
<a name="l00478"></a>00478     <span class="comment">/* only draw keyblock if it appears in at all of the keyframes at lowest end */</span>
<a name="l00479"></a>00479     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!startCurves &amp;&amp; !endCurves) 
<a name="l00480"></a>00480         <span class="keywordflow">return</span> 0;
<a name="l00481"></a>00481     
<a name="l00482"></a>00482     totCurves = (startCurves&gt;endCurves)? endCurves: startCurves;
<a name="l00483"></a>00483     <span class="keywordflow">return</span> (ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a8a9576474b95d4194cc95e3cb505cb47">totcurve</a> &gt;= totCurves);
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="comment">/* *************************** Keyframe Drawing *************************** */</span>
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="comment">/* coordinates for diamond shape */</span>
<a name="l00489"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">00489</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[4][2] = {
<a name="l00490"></a>00490     {0.0f, 1.0f},   <span class="comment">/* top vert */</span>
<a name="l00491"></a>00491     {1.0f, 0.0f},   <span class="comment">/* mid-right */</span>
<a name="l00492"></a>00492     {0.0f, -1.0f},  <span class="comment">/* bottom vert */</span>
<a name="l00493"></a>00493     {-1.0f, 0.0f}   <span class="comment">/* mid-left */</span>
<a name="l00494"></a>00494 }; 
<a name="l00495"></a>00495 
<a name="l00496"></a>00496 <span class="comment">/* draw a simple diamond shape with OpenGL */</span>
<a name="l00497"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a4840d085a0ba22c1d9449ae644cc6bf5">00497</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a4840d085a0ba22c1d9449ae644cc6bf5">draw_keyframe_shape</a> (<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> xscale, <span class="keywordtype">float</span> hsize, <span class="keywordtype">short</span> sel, <span class="keywordtype">short</span> key_type, <span class="keywordtype">short</span> mode, <span class="keywordtype">float</span> alpha)
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     <span class="keyword">static</span> GLuint displist1=0;
<a name="l00500"></a>00500     <span class="keyword">static</span> GLuint displist2=0;
<a name="l00501"></a>00501     
<a name="l00502"></a>00502     <span class="comment">/* initialize 2 display lists for diamond shape - one empty, one filled */</span>
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (displist1 == 0) {
<a name="l00504"></a>00504         displist1= glGenLists(1);
<a name="l00505"></a>00505             glNewList(displist1, GL_COMPILE);
<a name="l00506"></a>00506             
<a name="l00507"></a>00507             glBegin(GL_LINE_LOOP);
<a name="l00508"></a>00508                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[0]);
<a name="l00509"></a>00509                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[1]);
<a name="l00510"></a>00510                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[2]);
<a name="l00511"></a>00511                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[3]);
<a name="l00512"></a>00512             glEnd();
<a name="l00513"></a>00513         glEndList();
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (displist2 == 0) {
<a name="l00516"></a>00516         displist2= glGenLists(1);
<a name="l00517"></a>00517             glNewList(displist2, GL_COMPILE);
<a name="l00518"></a>00518             
<a name="l00519"></a>00519             glBegin(GL_QUADS);
<a name="l00520"></a>00520                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[0]);
<a name="l00521"></a>00521                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[1]);
<a name="l00522"></a>00522                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[2]);
<a name="l00523"></a>00523                 glVertex2fv(<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a822787f590b76c131655211ed43a8c72">_unit_diamond_shape</a>[3]);
<a name="l00524"></a>00524             glEnd();
<a name="l00525"></a>00525         glEndList();
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527     
<a name="l00528"></a>00528     <span class="comment">/* tweak size of keyframe shape according to type of keyframe </span>
<a name="l00529"></a>00529 <span class="comment">     *  - &#39;proper&#39; keyframes have key_type=0, so get drawn at full size</span>
<a name="l00530"></a>00530 <span class="comment">     */</span>
<a name="l00531"></a>00531     hsize -= 0.5f*key_type;
<a name="l00532"></a>00532     
<a name="l00533"></a>00533     <span class="comment">/* adjust view transform before starting */</span>
<a name="l00534"></a>00534     glTranslatef(x, y, 0.0f);
<a name="l00535"></a>00535     glScalef(1.0f/xscale*hsize, hsize, 1.0f);
<a name="l00536"></a>00536     
<a name="l00537"></a>00537     <span class="comment">/* anti-aliased lines for more consistent appearance */</span>
<a name="l00538"></a>00538     glEnable(GL_LINE_SMOOTH);
<a name="l00539"></a>00539     
<a name="l00540"></a>00540     <span class="comment">/* draw! */</span>
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(mode, <a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a69ccc7d3cc5673f54cbd893456ca2aaaa4912417af945294c9ee89d99d297ae8a">KEYFRAME_SHAPE_INSIDE</a>, <a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a69ccc7d3cc5673f54cbd893456ca2aaaa81ad0caf51cf506fb4c3d2daa86e7137">KEYFRAME_SHAPE_BOTH</a>)) {
<a name="l00542"></a>00542         <span class="comment">/* interior - hardcoded colors (for selected and unselected only) */</span>
<a name="l00543"></a>00543         <span class="keywordflow">switch</span> (key_type) {
<a name="l00544"></a>00544             <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335ca5edf24362a6bb0dc2337ff1f06a43051">BEZT_KEYTYPE_BREAKDOWN</a>: <span class="comment">/* bluish frames for now */</span>
<a name="l00545"></a>00545             {
<a name="l00546"></a>00546                 <span class="keywordflow">if</span> (sel) glColor4f(0.33f, 0.75f, 0.93f, alpha);
<a name="l00547"></a>00547                 <span class="keywordflow">else</span> glColor4f(0.70f, 0.86f, 0.91f, alpha);
<a name="l00548"></a>00548             }
<a name="l00549"></a>00549                 <span class="keywordflow">break</span>;
<a name="l00550"></a>00550                 
<a name="l00551"></a>00551             <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335ca0dd6a0c6434a7a7e72a4450439d6b180">BEZT_KEYTYPE_EXTREME</a>: <span class="comment">/* redish frames for now */</span>
<a name="l00552"></a>00552             {
<a name="l00553"></a>00553                 <span class="keywordflow">if</span> (sel) glColor4f(0.95f, 0.5f, 0.5f, alpha);
<a name="l00554"></a>00554                 <span class="keywordflow">else</span> glColor4f(0.91f, 0.70f, 0.80f, alpha);
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556                 <span class="keywordflow">break</span>;
<a name="l00557"></a>00557                 
<a name="l00558"></a>00558             <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335ca2dd0cca26344251717f8b0b3a847366a">BEZT_KEYTYPE_JITTER</a>: <span class="comment">/* greenish frames for now? */</span>
<a name="l00559"></a>00559             {
<a name="l00560"></a>00560                 <span class="keywordflow">if</span> (sel) glColor4f(0.38f, 0.75f, 0.26f, alpha);
<a name="l00561"></a>00561                 <span class="keywordflow">else</span> glColor4f(0.58f, 0.90f, 0.46f, alpha);
<a name="l00562"></a>00562             }
<a name="l00563"></a>00563                 <span class="keywordflow">break</span>;
<a name="l00564"></a>00564                 
<a name="l00565"></a>00565             <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#afd027912409530cf459cfbd97083335cad5591000922bff58bafed40c0ab9a6e5">BEZT_KEYTYPE_KEYFRAME</a>: <span class="comment">/* traditional yellowish frames for now */</span>
<a name="l00566"></a>00566             <span class="keywordflow">default</span>:
<a name="l00567"></a>00567             {
<a name="l00568"></a>00568                 <span class="keywordflow">if</span> (sel) <a class="code" href="../../de/d96/UI__resources_8h.html#a720062ccecc315c2c0588bfab9ad5cfb">UI_ThemeColorShadeAlpha</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531af7a279761545d46fb164bd88cb89266d">TH_STRIP_SELECT</a>, 50, -255*(1.0f-alpha));
<a name="l00569"></a>00569                 <span class="keywordflow">else</span> glColor4f(0.91f, 0.91f, 0.91f, alpha);
<a name="l00570"></a>00570             }
<a name="l00571"></a>00571                 <span class="keywordflow">break</span>;
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573         
<a name="l00574"></a>00574         glCallList(displist2);
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(mode, <a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a69ccc7d3cc5673f54cbd893456ca2aaaa8bb5fd47d7dcc0af5fd7d560e19f1393">KEYFRAME_SHAPE_FRAME</a>, <a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a69ccc7d3cc5673f54cbd893456ca2aaaa81ad0caf51cf506fb4c3d2daa86e7137">KEYFRAME_SHAPE_BOTH</a>)) {
<a name="l00578"></a>00578         <span class="comment">/* exterior - black frame */</span>
<a name="l00579"></a>00579         glColor4f(0.0f, 0.0f, 0.0f, alpha);
<a name="l00580"></a>00580         
<a name="l00581"></a>00581         glCallList(displist1);
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     
<a name="l00584"></a>00584     glDisable(GL_LINE_SMOOTH);
<a name="l00585"></a>00585     
<a name="l00586"></a>00586     <span class="comment">/* restore view transform */</span>
<a name="l00587"></a>00587     glScalef(xscale/hsize, 1.0f/hsize, 1.0);
<a name="l00588"></a>00588     glTranslatef(-x, -y, 0.0f);
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">00591</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks, <span class="keywordtype">float</span> ypos, <span class="keywordtype">short</span> channelLocked)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593     <a class="code" href="../../dc/d1c/structActKeyColumn.html">ActKeyColumn</a> *ak;
<a name="l00594"></a>00594     <a class="code" href="../../dd/d60/structActKeyBlock.html">ActKeyBlock</a> *ab;
<a name="l00595"></a>00595     <span class="keywordtype">float</span> xscale;
<a name="l00596"></a>00596     
<a name="l00597"></a>00597     glEnable(GL_BLEND);
<a name="l00598"></a>00598     
<a name="l00599"></a>00599     <span class="comment">/* get View2D scaling factor */</span>
<a name="l00600"></a>00600     <a class="code" href="../../d5/d63/UI__view2d_8h.html#adf67fa69e0c6db6c298cdb0c948a2a36">UI_view2d_getscale</a>(v2d, &amp;xscale, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00601"></a>00601     
<a name="l00602"></a>00602     <span class="comment">/* draw keyblocks */</span>
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (blocks) {
<a name="l00604"></a>00604         <span class="keywordflow">for</span> (ab= blocks-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ad5b603841846316a39ef09df8ace252d">first</a>; ab; ab= ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a6a804c62fa3ab0833c69029b087ca2ec">next</a>) {
<a name="l00605"></a>00605             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac841bb30199e008827d630982f220ce1">actkeyblock_is_valid</a>(ab, keys)) {
<a name="l00606"></a>00606                 <span class="comment">/* draw block */</span>
<a name="l00607"></a>00607                 <span class="keywordflow">if</span> (ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#aa7f5e9d9534d142d2eb7b4cc3a8352e1">sel</a>)
<a name="l00608"></a>00608                     <a class="code" href="../../de/d96/UI__resources_8h.html#ab3928c18aa7a95c23ed48412beb3a5d1">UI_ThemeColor4</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531af7a279761545d46fb164bd88cb89266d">TH_STRIP_SELECT</a>);
<a name="l00609"></a>00609                 <span class="keywordflow">else</span>
<a name="l00610"></a>00610                     <a class="code" href="../../de/d96/UI__resources_8h.html#ab3928c18aa7a95c23ed48412beb3a5d1">UI_ThemeColor4</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a9ab9a6db73d4d911f6b433317b67fed3">TH_STRIP</a>);
<a name="l00611"></a>00611                 
<a name="l00612"></a>00612                 glRectf(ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a50d8879575d76939150de2c61258b16e">start</a>, ypos-5, ab-&gt;<a class="code" href="../../dd/d60/structActKeyBlock.html#a13a12577d6f6a70b54f8913254204f61">end</a>, ypos+5);
<a name="l00613"></a>00613             }
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616     
<a name="l00617"></a>00617     <span class="comment">/* draw keys */</span>
<a name="l00618"></a>00618     <span class="keywordflow">if</span> (keys) {
<a name="l00619"></a>00619         <span class="comment">/* locked channels are less strongly shown, as feedback for locked channels in DopeSheet */</span>
<a name="l00620"></a>00620         <span class="comment">// TODO: allow this opacity factor to be themed?</span>
<a name="l00621"></a>00621         <span class="keywordtype">float</span> kalpha = (channelLocked)? 0.35f : 1.0f;
<a name="l00622"></a>00622         
<a name="l00623"></a>00623         <span class="keywordflow">for</span> (ak= keys-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ad5b603841846316a39ef09df8ace252d">first</a>; ak; ak= ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#abf93bb2e0a342a169a1dc97b39668bba">next</a>) {
<a name="l00624"></a>00624             <span class="comment">/* optimization: if keyframe doesn&#39;t appear within 5 units (screenspace) in visible area, don&#39;t draw </span>
<a name="l00625"></a>00625 <span class="comment">             *  - this might give some improvements, since we current have to flip between view/region matrices</span>
<a name="l00626"></a>00626 <span class="comment">             */</span>
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae90dc0e8266ddba45883b81be3931812">IN_RANGE_INCL</a>(ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>, v2d-&gt;<a class="code" href="../../d7/de3/structView2D.html#a3e5cff50450e7702e8a33b40dd056cbb">cur</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) == 0)
<a name="l00628"></a>00628                 <span class="keywordflow">continue</span>;
<a name="l00629"></a>00629             
<a name="l00630"></a>00630             <span class="comment">/* draw using OpenGL - uglier but faster */</span>
<a name="l00631"></a>00631             <span class="comment">// NOTE1: a previous version of this didn&#39;t work nice for some intel cards</span>
<a name="l00632"></a>00632             <span class="comment">// NOTE2: if we wanted to go back to icons, these are  icon = (ak-&gt;sel &amp; SELECT) ? ICON_SPACE2 : ICON_SPACE3;</span>
<a name="l00633"></a>00633             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a4840d085a0ba22c1d9449ae644cc6bf5">draw_keyframe_shape</a>(ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a9f7f4be8fe9ff797a55d90d0db3661e0">cfra</a>, ypos, xscale, 5.0f, (ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#ae0e362d9d2085f24862a18e71db6419c">sel</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>), ak-&gt;<a class="code" href="../../dc/d1c/structActKeyColumn.html#a0acccfd340916ffe26af2400a22e2f61">key_type</a>, <a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a69ccc7d3cc5673f54cbd893456ca2aaaa81ad0caf51cf506fb4c3d2daa86e7137">KEYFRAME_SHAPE_BOTH</a>, kalpha);
<a name="l00634"></a>00634         }   
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     
<a name="l00637"></a>00637     glDisable(GL_BLEND);
<a name="l00638"></a>00638 }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="comment">/* *************************** Channel Drawing Funcs *************************** */</span>
<a name="l00641"></a>00641 
<a name="l00642"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#aec9346fc22b034d0794e8e043aeb9f66">00642</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a3dbaf1ca13172af72694d902a57ab99f">draw_summary_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../d6/dca/structbAnimContext.html">bAnimContext</a> *ac, <span class="keywordtype">float</span> ypos)
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00645"></a>00645     
<a name="l00646"></a>00646     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00647"></a>00647     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00648"></a>00648     
<a name="l00649"></a>00649         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a183637bdb403eb6c23e45533cec953a8">summary_to_keylist</a>(ac, &amp;keys, &amp;blocks);
<a name="l00650"></a>00650     
<a name="l00651"></a>00651     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00652"></a>00652     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00653"></a>00653     
<a name="l00654"></a>00654         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, 0);
<a name="l00655"></a>00655     
<a name="l00656"></a>00656     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00657"></a>00657     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a2097ae9dd1b3d80a26e0002c449f18a2">00660</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ae50003fd619566f9c832f633a2617008">draw_scene_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *ads, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce, <span class="keywordtype">float</span> ypos)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00663"></a>00663     
<a name="l00664"></a>00664     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00665"></a>00665     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00666"></a>00666     
<a name="l00667"></a>00667         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a509a1ed892203dd7b0b72823d7b98437">scene_to_keylist</a>(ads, sce, &amp;keys, &amp;blocks);
<a name="l00668"></a>00668     
<a name="l00669"></a>00669     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00670"></a>00670     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00671"></a>00671     
<a name="l00672"></a>00672         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, 0);
<a name="l00673"></a>00673     
<a name="l00674"></a>00674     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00675"></a>00675     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a2e0891d85565ccd7dc907a1bacbcb99f">00678</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a5fb96bd222959747858282eb8ae0a9d7">draw_object_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *ads, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> ypos)
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00681"></a>00681     
<a name="l00682"></a>00682     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00683"></a>00683     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00684"></a>00684     
<a name="l00685"></a>00685         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a2d5365a1339cbef0ec6cbe39a14ab37c">ob_to_keylist</a>(ads, ob, &amp;keys, &amp;blocks);
<a name="l00686"></a>00686     
<a name="l00687"></a>00687     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00688"></a>00688     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00689"></a>00689     
<a name="l00690"></a>00690         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, 0);
<a name="l00691"></a>00691     
<a name="l00692"></a>00692     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00693"></a>00693     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a9bac25f72e641913b626d38a4fab7eda">00696</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a0888a1d2bcd557d55f952f45d97e55dc">draw_fcurve_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> ypos)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00699"></a>00699     
<a name="l00700"></a>00700     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00701"></a>00701     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00702"></a>00702     
<a name="l00703"></a>00703         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(adt, fcu, &amp;keys, &amp;blocks);
<a name="l00704"></a>00704     
<a name="l00705"></a>00705     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00706"></a>00706     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00707"></a>00707     
<a name="l00708"></a>00708         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab581d30efbbb3a1a1f6f979d26d1cd25">FCURVE_PROTECTED</a>));
<a name="l00709"></a>00709     
<a name="l00710"></a>00710     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00711"></a>00711     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#ade91741edd85d1f233af54a5b27051cb">00714</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ad6a381f65cfb53c7c0de862b48175310">draw_agroup_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d9/dcf/structbActionGroup.html">bActionGroup</a> *agrp, <span class="keywordtype">float</span> ypos)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00717"></a>00717     
<a name="l00718"></a>00718     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00719"></a>00719     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00720"></a>00720     
<a name="l00721"></a>00721         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a05affdc6921e466d6505d4ca0774ac32">agroup_to_keylist</a>(adt, agrp, &amp;keys, &amp;blocks);
<a name="l00722"></a>00722     
<a name="l00723"></a>00723     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00724"></a>00724     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00725"></a>00725     
<a name="l00726"></a>00726         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, (agrp-&gt;<a class="code" href="../../d9/dcf/structbActionGroup.html#a5a04faf9cd6c23df183545e5842caf80">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a23623a6a10ec8ae24a77f37cf2093d1eac54dd221d44baca2d2ea17ee2c671f57">AGRP_PROTECTED</a>));
<a name="l00727"></a>00727     
<a name="l00728"></a>00728     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00729"></a>00729     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#af18ba301d9a402e01c3aa8672974699f">00732</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#acee5de8c99de5363cd361ef3b502366f">draw_action_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <span class="keywordtype">float</span> ypos)
<a name="l00733"></a>00733 {
<a name="l00734"></a>00734     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys, blocks;
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00737"></a>00737     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;blocks);
<a name="l00738"></a>00738     
<a name="l00739"></a>00739         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a11e7d5582c4d4707bbb155dfc0fa5ea3">action_to_keylist</a>(adt, act, &amp;keys, &amp;blocks);
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00742"></a>00742     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;blocks);
<a name="l00743"></a>00743     
<a name="l00744"></a>00744         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, &amp;blocks, ypos, 0);
<a name="l00745"></a>00745     
<a name="l00746"></a>00746     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00747"></a>00747     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;blocks);
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#ae5c7288a93e63a5ad150a7ef9bfff8d8">00750</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a3e4415ecb5c44591788727bd173b46d3">draw_gpl_channel</a>(<a class="code" href="../../d7/de3/structView2D.html">View2D</a> *v2d, <a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *ads, <a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *gpl, <span class="keywordtype">float</span> ypos)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> keys;
<a name="l00753"></a>00753     
<a name="l00754"></a>00754     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a252f6abeef3b6e861da84630cbdbb02b">BLI_dlrbTree_init</a>(&amp;keys);
<a name="l00755"></a>00755     
<a name="l00756"></a>00756         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#afca8aae3dd8799ffc57e04b2fd1495e4">gpl_to_keylist</a>(ads, gpl, &amp;keys);
<a name="l00757"></a>00757     
<a name="l00758"></a>00758     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(&amp;keys);
<a name="l00759"></a>00759     
<a name="l00760"></a>00760         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a677d0b1971146a1fe4dc6b18d90e0cc8">draw_keylist</a>(v2d, &amp;keys, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ypos, (gpl-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#aed047c52577f6e0e3560c80bb65e1359">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a1bb3a52d41441645b284a37edf6114de">GP_LAYER_LOCKED</a>));
<a name="l00761"></a>00761     
<a name="l00762"></a>00762     <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(&amp;keys);
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765 <span class="comment">/* *************************** Keyframe List Conversions *************************** */</span>
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#af1d56edcb71dde9c99fd361297e15b7e">00767</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a183637bdb403eb6c23e45533cec953a8">summary_to_keylist</a>(<a class="code" href="../../d6/dca/structbAnimContext.html">bAnimContext</a> *ac, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769     <span class="keywordflow">if</span> (ac) {
<a name="l00770"></a>00770         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> anim_data = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00771"></a>00771         <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> *ale;
<a name="l00772"></a>00772         <span class="keywordtype">int</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>;
<a name="l00773"></a>00773         
<a name="l00774"></a>00774         <span class="comment">/* get F-Curves to take keyframes from */</span>
<a name="l00775"></a>00775         filter= <a class="code" href="../../df/d6f/ED__anim__api_8h.html#aeb469b1e009f7669ddacedd695291045a584f2145e984f8afb13e6cdeb4c0ac31">ANIMFILTER_DATA_VISIBLE</a>; <span class="comment">// curves only</span>
<a name="l00776"></a>00776         <a class="code" href="../../dc/d01/anim__filter_8c.html#a13681020f63c886ca5bfc9a2ff39620b">ANIM_animdata_filter</a>(ac, &amp;anim_data, filter, ac-&gt;<a class="code" href="../../d6/dca/structbAnimContext.html#a6746afe77831350347f788f226a9320a">data</a>, ac-&gt;<a class="code" href="../../d6/dca/structbAnimContext.html#a5a52c7e6c531f78a79d7d8b92a887700">datatype</a>);
<a name="l00777"></a>00777         
<a name="l00778"></a>00778         <span class="comment">/* loop through each F-Curve, grabbing the keyframes */</span>
<a name="l00779"></a>00779         <span class="keywordflow">for</span> (ale= anim_data.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ale; ale= ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a5ccf2b36d14379524140d1c18942a2ef">next</a>)
<a name="l00780"></a>00780             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a>, ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a954a70adedee38f0fe952eda8c704fff">data</a>, keys, blocks);
<a name="l00781"></a>00781         
<a name="l00782"></a>00782         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;anim_data);
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#aac76a51b74044895cf2a5b5bfa9cb2ee">00786</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a509a1ed892203dd7b0b72823d7b98437">scene_to_keylist</a>(<a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *ads, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788     <a class="code" href="../../d6/dca/structbAnimContext.html">bAnimContext</a> ac = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00789"></a>00789     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> anim_data = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00790"></a>00790     <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> *ale;
<a name="l00791"></a>00791     <span class="keywordtype">int</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>;
<a name="l00792"></a>00792     
<a name="l00793"></a>00793     <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> dummychan = {0};
<a name="l00794"></a>00794     
<a name="l00795"></a>00795     <span class="keywordflow">if</span> (sce == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00796"></a>00796         <span class="keywordflow">return</span>;
<a name="l00797"></a>00797     
<a name="l00798"></a>00798     <span class="comment">/* create a dummy wrapper data to work with */</span>
<a name="l00799"></a>00799     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#a5441225f529822c4d371c0de8bf8151f">type</a> = <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a1f9698bef8587ea2fa6522d0299e70b7a6beea10df4db5286f40a857d7d837f17">ANIMTYPE_SCENE</a>;
<a name="l00800"></a>00800     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#a954a70adedee38f0fe952eda8c704fff">data</a> = sce;
<a name="l00801"></a>00801     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#ad2686a20c9c11e9889e3f4d9a60b8b8c">id</a> = &amp;sce-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>;
<a name="l00802"></a>00802     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a> = sce-&gt;<a class="code" href="../../d9/d27/structScene.html#abdea91c45720e729d4fd49b37fee664e">adt</a>;
<a name="l00803"></a>00803     
<a name="l00804"></a>00804     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a58e9368e226140c365269be25d531a8c">ads</a> = ads;
<a name="l00805"></a>00805     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a6746afe77831350347f788f226a9320a">data</a> = &amp;dummychan;
<a name="l00806"></a>00806     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a5a52c7e6c531f78a79d7d8b92a887700">datatype</a> = <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a7a050140c42c915acc0ce08d5028df86af8ca1fd6d55bcbb90f6061abb699334f">ANIMCONT_CHANNEL</a>;
<a name="l00807"></a>00807     
<a name="l00808"></a>00808     <span class="comment">/* get F-Curves to take keyframes from */</span>
<a name="l00809"></a>00809     filter= <a class="code" href="../../df/d6f/ED__anim__api_8h.html#aeb469b1e009f7669ddacedd695291045a584f2145e984f8afb13e6cdeb4c0ac31">ANIMFILTER_DATA_VISIBLE</a>; <span class="comment">// curves only</span>
<a name="l00810"></a>00810     <a class="code" href="../../dc/d01/anim__filter_8c.html#a13681020f63c886ca5bfc9a2ff39620b">ANIM_animdata_filter</a>(&amp;ac, &amp;anim_data, filter, ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a6746afe77831350347f788f226a9320a">data</a>, ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a5a52c7e6c531f78a79d7d8b92a887700">datatype</a>);
<a name="l00811"></a>00811     
<a name="l00812"></a>00812     <span class="comment">/* loop through each F-Curve, grabbing the keyframes */</span>
<a name="l00813"></a>00813     <span class="keywordflow">for</span> (ale= anim_data.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ale; ale= ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a5ccf2b36d14379524140d1c18942a2ef">next</a>)
<a name="l00814"></a>00814         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a>, ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a954a70adedee38f0fe952eda8c704fff">data</a>, keys, blocks);
<a name="l00815"></a>00815     
<a name="l00816"></a>00816     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;anim_data);
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a210c27ef4307a93d4ca9f5ec0bc7a75d">00819</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a2d5365a1339cbef0ec6cbe39a14ab37c">ob_to_keylist</a>(<a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *ads, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00820"></a>00820 {   
<a name="l00821"></a>00821     <a class="code" href="../../d6/dca/structbAnimContext.html">bAnimContext</a> ac = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00822"></a>00822     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> anim_data = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00823"></a>00823     <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> *ale;
<a name="l00824"></a>00824     <span class="keywordtype">int</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>;
<a name="l00825"></a>00825     
<a name="l00826"></a>00826     <a class="code" href="../../d6/dfc/structbAnimListElem.html">bAnimListElem</a> dummychan = {0};
<a name="l00827"></a>00827     <a class="code" href="../../d3/da9/structBase.html">Base</a> dummybase = {0};
<a name="l00828"></a>00828     
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00830"></a>00830         <span class="keywordflow">return</span>;
<a name="l00831"></a>00831     
<a name="l00832"></a>00832     <span class="comment">/* create a dummy wrapper data to work with */</span>
<a name="l00833"></a>00833     dummybase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> = ob;
<a name="l00834"></a>00834     
<a name="l00835"></a>00835     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#a5441225f529822c4d371c0de8bf8151f">type</a> = <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a1f9698bef8587ea2fa6522d0299e70b7ae2343c6cd206c77f666c41a9fdd2d9b5">ANIMTYPE_OBJECT</a>;
<a name="l00836"></a>00836     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#a954a70adedee38f0fe952eda8c704fff">data</a> = &amp;dummybase;
<a name="l00837"></a>00837     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#ad2686a20c9c11e9889e3f4d9a60b8b8c">id</a> = &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>;
<a name="l00838"></a>00838     dummychan.<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a> = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>;
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a58e9368e226140c365269be25d531a8c">ads</a> = ads;
<a name="l00841"></a>00841     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a6746afe77831350347f788f226a9320a">data</a> = &amp;dummychan;
<a name="l00842"></a>00842     ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a5a52c7e6c531f78a79d7d8b92a887700">datatype</a> = <a class="code" href="../../df/d6f/ED__anim__api_8h.html#a7a050140c42c915acc0ce08d5028df86af8ca1fd6d55bcbb90f6061abb699334f">ANIMCONT_CHANNEL</a>;
<a name="l00843"></a>00843     
<a name="l00844"></a>00844     <span class="comment">/* get F-Curves to take keyframes from */</span>
<a name="l00845"></a>00845     filter= <a class="code" href="../../df/d6f/ED__anim__api_8h.html#aeb469b1e009f7669ddacedd695291045a584f2145e984f8afb13e6cdeb4c0ac31">ANIMFILTER_DATA_VISIBLE</a>; <span class="comment">// curves only</span>
<a name="l00846"></a>00846     <a class="code" href="../../dc/d01/anim__filter_8c.html#a13681020f63c886ca5bfc9a2ff39620b">ANIM_animdata_filter</a>(&amp;ac, &amp;anim_data, filter, ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a6746afe77831350347f788f226a9320a">data</a>, ac.<a class="code" href="../../d6/dca/structbAnimContext.html#a5a52c7e6c531f78a79d7d8b92a887700">datatype</a>);
<a name="l00847"></a>00847     
<a name="l00848"></a>00848     <span class="comment">/* loop through each F-Curve, grabbing the keyframes */</span>
<a name="l00849"></a>00849     <span class="keywordflow">for</span> (ale= anim_data.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ale; ale= ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a5ccf2b36d14379524140d1c18942a2ef">next</a>)
<a name="l00850"></a>00850         <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#ab7b41d9d9780a114a3ef17efbda67444">adt</a>, ale-&gt;<a class="code" href="../../d6/dfc/structbAnimListElem.html#a954a70adedee38f0fe952eda8c704fff">data</a>, keys, blocks);
<a name="l00851"></a>00851     
<a name="l00852"></a>00852     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;anim_data);
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 
<a name="l00855"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a9b429ce0b1dc18268d3b185e68c2224d">00855</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857     <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *beztTree = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00858"></a>00858     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00859"></a>00859     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> v;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (fcu &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00862"></a>00862         <span class="comment">/* apply NLA-mapping (if applicable) */</span>
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (adt)    
<a name="l00864"></a>00864             <a class="code" href="../../d5/d34/anim__draw_8c.html#af3391f209e37113f866e6bc3d15bcf97">ANIM_nla_mapping_apply_fcurve</a>(adt, fcu, 0, 0);
<a name="l00865"></a>00865         
<a name="l00866"></a>00866         <span class="comment">/* if getting long keyframes too, grab the BezTriples in a BST for </span>
<a name="l00867"></a>00867 <span class="comment">         * accelerated searching...</span>
<a name="l00868"></a>00868 <span class="comment">         */</span>
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (blocks) {
<a name="l00870"></a>00870             <span class="comment">/* init new tree */</span>
<a name="l00871"></a>00871             beztTree= <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a25bde1e87fb922c93263631755d97693">BLI_dlrbTree_new</a>();
<a name="l00872"></a>00872             
<a name="l00873"></a>00873             <span class="comment">/* populate tree with the BezTriples */</span>
<a name="l00874"></a>00874             <span class="keywordflow">for</span> (v=0, bezt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>; v &lt; fcu-&gt;totvert; v++, bezt++)
<a name="l00875"></a>00875                 <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a5dcc1fe38a7b2a3bfefee1eadd8d84bb">BLI_dlrbTree_add</a>(beztTree, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#ac46ad1d973ecaf95757d11e545b587e2">compare_abk_bezt</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a629c91e09f549f34ed79dc7f8a34c995">nalloc_abk_bezt</a>, <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a67f221e6a4eb96863bd5434e29d7ce3b">nupdate_abk_bezt</a>, bezt);
<a name="l00876"></a>00876             
<a name="l00877"></a>00877             <span class="comment">/* make sure that it is suitable for linked-list searching too */</span>
<a name="l00878"></a>00878             <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#a90a980516f029c7f9ddb3d854cc37bb7">BLI_dlrbTree_linkedlist_sync</a>(beztTree);
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880         
<a name="l00881"></a>00881         <span class="comment">/* loop through beztriples, making ActKeysColumns and ActKeyBlocks */</span>
<a name="l00882"></a>00882         <span class="keywordflow">for</span> (v=0, bezt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>; v &lt; fcu-&gt;totvert; v++, bezt++) {
<a name="l00883"></a>00883             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a136e8141709a92802ff5ba4b3c07b55b">add_bezt_to_keycolumns_list</a>(keys, bezt);
<a name="l00884"></a>00884             <span class="keywordflow">if</span> (blocks) <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a1eeef078439a4122e1e3fd013f957823">add_bezt_to_keyblocks_list</a>(blocks, beztTree, bezt);
<a name="l00885"></a>00885         }
<a name="l00886"></a>00886         
<a name="l00887"></a>00887         <span class="comment">/* update the number of curves that elements have appeared in  */</span>
<a name="l00888"></a>00888         <span class="keywordflow">if</span> (keys)
<a name="l00889"></a>00889             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#aea1f249da6da2f36f101e49a5d2b3166">set_touched_actkeycolumn</a>(keys-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ac6e167ec21709b3b24aa0d47f74fdf3f">root</a>);
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (blocks)
<a name="l00891"></a>00891             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#abcd12f4a6a7830135b525ea84dba5359">set_touched_actkeyblock</a>(blocks-&gt;<a class="code" href="../../d1/d5d/structDLRBT__Tree.html#ac6e167ec21709b3b24aa0d47f74fdf3f">root</a>);
<a name="l00892"></a>00892             
<a name="l00893"></a>00893         <span class="comment">/* free temp data for building long keyframes */</span>
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (blocks &amp;&amp; beztTree) {
<a name="l00895"></a>00895             <a class="code" href="../../de/d11/BLI__dlrbTree_8h.html#af6bec977f19ccbbea32e1aec6ed00341">BLI_dlrbTree_free</a>(beztTree);
<a name="l00896"></a>00896             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(beztTree);
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898         
<a name="l00899"></a>00899         <span class="comment">/* unapply NLA-mapping if applicable */</span>
<a name="l00900"></a>00900         <span class="keywordflow">if</span> (adt)
<a name="l00901"></a>00901             <a class="code" href="../../d5/d34/anim__draw_8c.html#af3391f209e37113f866e6bc3d15bcf97">ANIM_nla_mapping_apply_fcurve</a>(adt, fcu, 1, 0);
<a name="l00902"></a>00902     }
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#af8880a1c39407aefe6e1fb42d11bde2f">00905</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a05affdc6921e466d6505d4ca0774ac32">agroup_to_keylist</a>(<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d9/dcf/structbActionGroup.html">bActionGroup</a> *agrp, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="keywordflow">if</span> (agrp) {
<a name="l00910"></a>00910         <span class="comment">/* loop through F-Curves */</span>
<a name="l00911"></a>00911         <span class="keywordflow">for</span> (fcu= agrp-&gt;<a class="code" href="../../d9/dcf/structbActionGroup.html#ad0e1909ae82afb9b3ece50be1e3d9915">channels</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>==agrp; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00912"></a>00912             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(adt, fcu, keys, blocks);
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914     }
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="../../d2/df9/ED__keyframes__draw_8h.html#a77c68113ebf747d7e60403d1f0225508">00917</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a11e7d5582c4d4707bbb155dfc0fa5ea3">action_to_keylist</a>(<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *blocks)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="keywordflow">if</span> (act) {
<a name="l00922"></a>00922         <span class="comment">/* loop through F-Curves */</span>
<a name="l00923"></a>00923         <span class="keywordflow">for</span> (fcu= act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00924"></a>00924             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a9d18e6fc983df5018e97acd591c7ff33">fcurve_to_keylist</a>(adt, fcu, keys, blocks);
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="../../d4/d5f/keyframes__draw_8c.html#afca8aae3dd8799ffc57e04b2fd1495e4">00930</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#afca8aae3dd8799ffc57e04b2fd1495e4">gpl_to_keylist</a>(<a class="code" href="../../df/de9/structbDopeSheet.html">bDopeSheet</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ads), <a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *gpl, <a class="code" href="../../d1/d5d/structDLRBT__Tree.html">DLRBT_Tree</a> *keys)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf;
<a name="l00933"></a>00933     
<a name="l00934"></a>00934     <span class="keywordflow">if</span> (gpl &amp;&amp; keys) {
<a name="l00935"></a>00935         <span class="comment">/* although the frames should already be in an ordered list, they are not suitable for displaying yet */</span>
<a name="l00936"></a>00936         <span class="keywordflow">for</span> (gpf= gpl-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#ab6b8d0f88de061c89b2e6c982cf315d8">frames</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; gpf; gpf= gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#a4d6f43b91302df84606cc035b683243c">next</a>)
<a name="l00937"></a>00937             <a class="code" href="../../d4/d5f/keyframes__draw_8c.html#a34bf87e7f253d89266b0c1bb29450862">add_gpframe_to_keycolumns_list</a>(keys, gpf);
<a name="l00938"></a>00938     }
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:27 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
